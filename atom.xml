<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN">
  <id>https://freesql.net/</id>
  <title>FreeSql 官方文档</title>
  <subtitle>FreeSql Documents</subtitle>
  <updated>2022-09-08T16:11:27.907Z</updated>
  <generator>vuepress-plugin-feed2</generator>
  <link rel="self" href="https://freesql.net/atom.xml"/>
  <link rel="alternate" href="https://freesql.net/"/>
  <entry>
    <title type="html">聚合根（实验室）</title>
    <id>https://freesql.net/guide/aggregateroot.html</id>
    <link href="https://freesql.net/guide/aggregateroot.html"/>
    <updated>2022-09-06T09:20:21.000Z</updated>
    <content type="html"><![CDATA[<h1 id="聚合根-实验室" tabindex="-1"> 聚合根（实验室）</h1>
<p>FreeSql.Repository 定义了 IBaseRepository&lt;T&gt; 仓储接口，实现了单表的通用仓储对象，支持了级联保存、级联删除功能，（但是）使用时需要人工自己判断何时开启、何时使用。</p>
<p>本文看上去像 EF，实则有区别，主要区别在级联边界的规则设定，例如我们允许 OneToMany 从下层向上递归级联，但是仅限查询，不能增删改。研究目的希望从机制上杜绝痛点，让操作变得更可控。</p>
<p><strong>AggregateRootRepository 是 IBaseRepository&lt;T&gt; 一种新的尝试实现</strong>，它将自动处理 OneToOne/OneToMany 导航属性，以及 ManyToMany(中间表) 的级联添加、级联更新、级联删除、级联查询（查询时自动 Include/IncludeMany 它们）。</p>
<div><pre><code><span><span>var</span></span> repository <span>=</span> fsql<span>.</span><span><span>GetAggregateRootRepository</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><blockquote>
<p>dotnet add package FreeSql.Extensions.AggregateRoot</p>
</blockquote>
<p>意见征集、讨论区：<a href="https://github.com/dotnetcore/FreeSql/discussions/1235" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/discussions/1235</a></p>
<h2 id="设定边界" tabindex="-1"> 设定边界</h2>
<p>将一个主要的实体类认定为聚合根，设定好安全的管辖范围（边界），CRUD 时会把边界之内的所有内容看作一个整体。</p>
<p><code>增删改</code> 边界之外的导航属性，递归时会忽略：</p>
<ul>
<li>ManyToOne</li>
<li>ManyToMany(外部表)</li>
<li>PgArrayToMany</li>
</ul>
<p><code>增删改</code> 边界之内的导航属性，递归时会级联操作：</p>
<ul>
<li>OneToOne</li>
<li>OneToMany</li>
<li>ManyToMany(中间表)</li>
</ul>
<p>示例1：在聚合根内递归所有 OneToOne/OneToMany 导航属性</p>
<ul>
<li>OneToOne: Order &lt;-&gt; OrderExt</li>
<li>OneToMany: Order &lt;== OrderDetail</li>
<li>OneToOne: OrderDetail &lt;-&gt; OrderDetailExt</li>
<li>聚合根 Order 的管辖范围：Extdata、Details、Details[?].Extdata</li>
</ul>
<div><pre><code><span>class</span> <span>Order</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Field2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>OrderExt</span> Extdata <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>OrderDetail<span>.</span>OrderId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>OrderDetail<span>></span></span> Details <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>OrderExt</span>
<span>{</span>
    <span>[</span><span><span>Key</span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> OrderId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Field3 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>Order</span> Order <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>OrderDetail</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> OrderId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Field4 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>OrderDetailExt</span> Extdata <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>OrderDetailExt</span>
<span>{</span>
    <span>[</span><span><span>Key</span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> OrderDetailId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Field5 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>OrderDetail</span> OrderDetail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>示例2：在聚合根内递归所有 ManyToMany 导航属性对应的中间表</p>
<ul>
<li>ManyToMany: Order &lt;=&gt; Tag</li>
<li>聚合根 Order 会根据 Tags 生成 OrderTag 中间表数据，进行管理</li>
<li>聚合根 Order 不会管理 Tag 实体类，以及 Tag 向下延申的导航属性（外部表不属于管辖范围）</li>
</ul>
<div><pre><code><span>class</span> <span>Order</span>
<span>{</span>
    <span>// ..</span>
    <span>[</span><span><span>Navigate</span><span><span>(</span>ManyToMany <span>=</span> <span>typeof</span><span>(</span><span>OrderTag</span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>OrderTag</span>
<span>{</span>
    <span>[</span><span><span>Key</span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> OrderId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Key</span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> TagId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>OrderId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>Order</span> Order <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>TagId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>Tag</span> Tag <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>Tag</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span>ManyToMany <span>=</span> <span>typeof</span><span>(</span><span>OrderTag</span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>Order<span>></span></span> Orders <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="插入数据" tabindex="-1"> 插入数据</h2>
<p>根据上面设定的边界，插入时会自动 <code>级联插入</code> 边界以内的内容。</p>
<div><pre><code><span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span>
<span>{</span>
    Field2 <span>=</span> <span>"field2"</span><span>,</span>
    Extdata <span>=</span> <span>new</span> <span>OrderExt</span> <span>{</span> Field3 <span>=</span> <span>"field3"</span> <span>}</span><span>,</span>
    Details <span>=</span> <span>new</span> <span>List<span>&lt;</span>OrderDetail<span>></span></span>
    <span>{</span>
        <span>new</span> <span>OrderDetail</span> <span>{</span> Field4 <span>=</span> <span>"field4_01"</span><span>,</span> Extdata <span>=</span> <span>new</span> <span>OrderDetailExt</span> <span>{</span> Field5 <span>=</span> <span>"field5_01"</span> <span>}</span> <span>}</span><span>,</span>
        <span>new</span> <span>OrderDetail</span> <span>{</span> Field4 <span>=</span> <span>"field4_02"</span><span>,</span> Extdata <span>=</span> <span>new</span> <span>OrderDetailExt</span> <span>{</span> Field5 <span>=</span> <span>"field5_02"</span> <span>}</span> <span>}</span><span>,</span>
        <span>new</span> <span>OrderDetail</span> <span>{</span> Field4 <span>=</span> <span>"field4_03"</span><span>,</span> Extdata <span>=</span> <span>new</span> <span>OrderDetailExt</span> <span>{</span> Field5 <span>=</span> <span>"field5_03"</span> <span>}</span> <span>}</span><span>,</span>
    <span>}</span><span>,</span>
    Tags <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> <span>new</span> <span>[</span><span>]</span> <span>{</span> <span>1</span><span>,</span><span>2</span><span>,</span><span>3</span> <span>}</span><span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>}</span><span>;</span>
repository<span>.</span><span>Insert</span><span>(</span>order<span>)</span><span>;</span> <span>//级联插入</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>插入 Order 表记录；</li>
<li>插入 OrderExt 表记录；</li>
<li>插入 OrderDetail 表记录；</li>
<li>插入 OrderDetailExt 表记录；</li>
<li>插入 OrderTag 表记录；（不会插入 Tag 表记录）</li>
</ul>
<blockquote>
<p>注意：即使 order.Tags 在数据库不存在，也不会插入 Tag 表记录</p>
</blockquote>
<h2 id="查询数据" tabindex="-1"> 查询数据</h2>
<p>根据上面设定的边界，查询时会自动 <code>Include/IncludeMany</code> 边界以内的内容。</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> repository<span>.</span>Select
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>&lt;</span> <span>10</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>效果等同于：</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Extdata<span>)</span>
    <span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Details<span>,</span> 
        then <span>=></span> then<span>.</span><span>Include</span><span>(</span>b <span>=></span> b<span>.</span>Extdata<span>)</span><span>)</span>
    <span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Tags<span>)</span> 
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>&lt;</span> <span>10</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>扩展查询边界：</p>
<blockquote>
<p>提示：[AggregateRootBoundary(&quot;name&quot;, Break = true)] 设置边界范围，请往后面看。。</p>
</blockquote>
<div><pre><code><span>class</span> <span>OrderRepository</span> <span>:</span> <span><span>AggregateRootRepository<span>&lt;</span>Order<span>></span></span></span>
<span>{</span>
    <span>public</span> <span>OrderRepository</span><span>(</span><span>IFreeSql</span> fsql<span>,</span> <span>UnitOfWorkManager</span> uowManager<span>)</span> <span>:</span> <span>base</span><span>(</span>uowManager<span>?.</span>Orm <span>??</span> fsql<span>)</span>
    <span>{</span>
        Console<span>.</span><span>WriteLine</span><span>(</span>AggregateRootUtils<span>.</span><span>GetAutoIncludeQueryStaicCode</span><span>(</span><span>null</span><span>,</span> fsql<span>,</span> <span>typeof</span><span>(</span><span>Order</span><span>)</span><span>)</span><span>)</span><span>;</span>
        <span>//控制台输出一块 Include/IncludeMany 字符串，内容与下方 SelectDiy 代码块相同</span>
    <span>}</span>

    <span>public</span> <span>override</span> <span>ISelect<span>&lt;</span>IFreeSql<span>></span></span> Select <span>=></span> <span>this</span><span>.</span>SelectDiy
        <span>//.TrackToList(this.SelectAggregateRootTracking) 状态跟踪</span>
        <span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Extdata<span>)</span>
        <span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Details<span>,</span> 
            then <span>=></span> then<span>.</span><span>Include</span><span>(</span>b <span>=></span> b<span>.</span>Extdata<span>)</span><span>)</span>
        <span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Tags<span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>重写 Select 可以把边界以外的数据一起查询出来（例如 ManyToOne 导航属性），但是 <code>添加/修改/删除</code> 仍然采用默认边界规则</p>
<p>手工使用 SelectDiy Include/IncludeMany 包含内容，如果小于默认边界规则，则建议不要开启 <code>状态跟踪</code> （保存数据可能造成不一致），反之则应该开启。（详细请往后看 <code>更新数据</code>）</p>
<h2 id="删除数据" tabindex="-1"> 删除数据</h2>
<p>根据上面设定的边界，删除时会自动 <code>级联删除</code> 边界以内的内容。</p>
<div><pre><code>repository<span>.</span><span>Delete</span><span>(</span>order<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><ul>
<li>删除 OrderExt 表对应的记录；</li>
<li>删除 OrderDetailExt 表对应的记录；</li>
<li>删除 OrderDetail 表对应的记录；</li>
<li>删除 OrderTag 表对应的记录；（不会删除 Tag 表记录）</li>
<li>删除 Order 表对应的记录；</li>
</ul>
<p>删除数据是在内存递归 order 实例进行的，因此需要使用 repository 提前查询，内容庞大时有性能缺陷。</p>
<p>如果使用了数据库外键的级联删除功能，则只需删除 Order 表对应的记录，并且不需要提前查询。</p>
<h2 id="更新数据" tabindex="-1"> 更新数据</h2>
<p>根据上面设定的边界，更新时会自动 <code>级联保存</code> 边界以内的内容。</p>
<p>repository.Attach 存储更新前的数据快照（查询会自动快照），称为副本，repository.Update 的时候和副本进行级联对比保存。</p>
<div><pre><code><span><span>var</span></span> order <span>=</span> repository<span>.</span>Select<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span> <span>//此时已自动 Attach</span>
order<span>.</span>Tags<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Tag</span> <span>{</span> Id <span>=</span> <span>4</span> <span>}</span><span>)</span><span>;</span>
order<span>.</span>Details<span>.</span><span>RemoveAt</span><span>(</span><span>1</span><span>)</span><span>;</span>
order<span>.</span>Details<span>[</span><span>0</span><span>]</span><span>.</span>Extdata<span>.</span>Field5 <span>=</span> <span>"field5_01_01"</span><span>;</span>
order<span>.</span>Field2 <span>=</span> <span>"field2_02"</span><span>;</span>
repository<span>.</span><span>Update</span><span>(</span>order<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>添加 OrderTag 表记录；（不会管理 Tag 表记录）</li>
<li>删除 OrderDetail 表记录；</li>
<li>删除 OrderDetailExt 表记录；</li>
<li>更新 OrderDetailExt 表记录；</li>
<li>更新 Order 表记录；</li>
</ul>
<p><code>完整保存</code> 先查询再更新，机制容易理解，数据一致性也更有保障。但是如果聚合根下内容较庞大，将会造成性能问题。</p>
<p>例如 Order 下面的评论数据大约有 1000 条，每天还不断有新的记录，每次 Load 内存再保存代价就太大了。</p>
<p>利用对比保存的特点，可以变向实现 <code>追加记录</code>：</p>
<div><pre><code><span>class</span> <span>Order</span>
<span>{</span>
    <span>// ..</span>
    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>OrderComment<span>.</span>OrderId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>OrderComment<span>></span></span> Comments <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>OrderComment</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> OrderId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Field6 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> order <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
    <span>.</span><span>First</span><span>(</span><span>)</span><span>;</span> <span>//单表数据</span>
repository<span>.</span><span>Attach</span><span>(</span>order<span>)</span><span>;</span> <span>//快照时 Comments 是 NULL/EMPTY</span>
order<span>.</span>Comments <span>=</span> <span>new</span> <span>List<span>&lt;</span>OrderComment<span>></span></span><span>(</span><span>)</span><span>;</span>
order<span>.</span>Comments<span>.</span><span>Add</span><span>(</span><span>new</span> <span>OrderComment</span> <span>{</span> Field6 <span>=</span> <span>"field6_01"</span> <span>}</span><span>)</span><span>;</span>
order<span>.</span>Comments<span>.</span><span>Add</span><span>(</span><span>new</span> <span>OrderComment</span> <span>{</span> Field6 <span>=</span> <span>"field6_02"</span> <span>}</span><span>)</span><span>;</span>
repository<span>.</span><span>Update</span><span>(</span>order<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>使用 fsql 只查询了单表数据；</li>
<li>order 本身没发生变化，所以不更新 Order 表记录；</li>
<li>添加 OrderComment 表记录2条；</li>
</ul>
<blockquote>
<p>我为什么不直接对 OrderComment 进行单表操作啊？？？</p>
</blockquote>
<blockquote>
<p>答案你们回答！！！</p>
</blockquote>
<p><code>对比保存</code> 规则说明：</p>
<table>
<thead>
<tr>
<th>导航属性</th>
<th>副本</th>
<th>最新</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>OneToOne</td>
<td>NULL</td>
<td>Object</td>
<td><code>添加</code> 最新 记录</td>
</tr>
<tr>
<td>OneToOne</td>
<td>Object</td>
<td>NULL</td>
<td><code>删除</code> 副本 记录</td>
</tr>
<tr>
<td>OneToOne</td>
<td>Object</td>
<td>Object</td>
<td>内容发生变化则 <code>更新</code> 最新 记录，否则 <code>忽略</code></td>
</tr>
<tr>
<td>OneToMany</td>
<td>NULL/Empty</td>
<td>List</td>
<td><code>添加</code> 最新 List 记录</td>
</tr>
<tr>
<td>OneToMany</td>
<td>List</td>
<td>NULL</td>
<td><code>忽略</code></td>
</tr>
<tr>
<td>OneToMany</td>
<td>List</td>
<td>Empty</td>
<td><code>删除</code> 副本 List 记录</td>
</tr>
<tr>
<td>OneToMany</td>
<td>List</td>
<td>List</td>
<td><code>对比保存</code> 计算出 <code>添加</code>、<code>更新</code>、<code>删除</code> 三种行为</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ManyToMany 只会操作 <code>中间表</code>（外部表不属于管辖范围），对比保存的机制与 OneToMany 一致</p>
</blockquote>
<h2 id="插入或更新数据" tabindex="-1"> 插入或更新数据</h2>
<p>InsertOrUpdate 执行逻辑依托聚合根对象的 <code>主键</code> 和 <code>状态管理</code>，状态管理存储的是副本。</p>
<p>1、如果主键是 <code>自增</code>：</p>
<ul>
<li>无值，则 <code>插入数据</code>；</li>
<li>有值，则判断 状态管理;
<ul>
<li>存在，则与副本对比 <code>更新数据</code>；</li>
<li>不存在，则查询 数据库；（内容庞大时有性能问题）
<ul>
<li>存在，则与查询的内容对比 <code>更新数据</code>；</li>
<li>不存在，则 <code>插入数据</code>；</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>2、如果主键不是 自增：</p>
<ul>
<li>无值，则 <code>抛出异常</code>；</li>
<li>有值，逻辑同上；</li>
</ul>
<h2 id="扩展边界" tabindex="-1"> 扩展边界</h2>
<div><pre><code><span>class</span> <span>Order</span>
<span>{</span>
    <span>// ..</span>
    <span>[</span><span><span>AggregateRootBoundary</span><span><span>(</span><span>"solution_1"</span><span>,</span> Break <span>=</span> <span>false</span><span>,</span> BreakThen <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>[</span><span><span>AggregateRootBoundary</span><span><span>(</span><span>"solution_2"</span><span>,</span> Break <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>OrderDetail<span>.</span>OrderId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>OrderDetail<span>></span></span> Details <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

repository<span>.</span><span>ChangeBoundary</span><span>(</span><span>"solution_1"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>Break 递归时，终止当前导航属性</li>
<li>BreakThen 递归时，终止下探</li>
</ul>
<p>AggregateRootBoundary 可以设置边界之内的导航属性，缩小边界范围。</p>
<p>也可以设置非边界之内的导航属性 ManyToOne/ManyToMany/PgArrayToMany，仅查询有效，<code>增删改</code> 时依然会忽略它们。</p>
<h2 id="总结" tabindex="-1"> 总结</h2>
<p>1、<strong>理解边界</strong>，理解本文提出的边界规则。</p>
<ul>
<li>ManyToOne 导航属性，是 <code>边界之外</code>；</li>
<li>ManyToMany 导航属性，<code>中间表</code>（OrderTag） 是边界之内，<code>外部表</code>（Tag） 是 <code>边界之外</code>；</li>
<li>OneToOne 导航属性，是边界之内；</li>
<li>OneToMany 导航属性，是边界之内；</li>
</ul>
<p>AggregateRootRepository 只对边界之内的数据进行递归 CRUD 操作，把聚合根看成一个整体。</p>
<p>特殊情况可以继承后重写 Select 属性扩大、或缩小查询内容：</p>
<ul>
<li>Insert/Delete/Update <code>扩大</code> 后的查询内容，不会对 <code>扩大</code> 后的数据进行增删改；</li>
<li>Update <code>缩小</code> 后的查询内容，由于导航属性值为 NULL，不会删除未查询的内容；</li>
</ul>
<p>2、<strong>善用事务</strong>，使用事务解决一致操作问题。</p>
]]></content>
    <published>2022-09-04T08:40:48.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeSql+CAP事务</title>
    <id>https://freesql.net/extra/freesql-cap.html</id>
    <link href="https://freesql.net/extra/freesql-cap.html"/>
    <updated>2022-08-31T14:37:49.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freesql-cap事务" tabindex="-1"> FreeSql+CAP事务</h1>
<h2 id="背景描述" tabindex="-1"> 背景描述</h2>
<p>在CAP中，事务对象需要交给CAP进行提交从而在事务实现提交后对缓存消息到 Broker 的 Flush 动作，而目前的Orm大部分都有自己的事务管理对象进行事务的提交。CAP官方直接原生支持使用 <a href="http://ADO.NET" target="_blank" rel="noopener noreferrer">ADO.NET</a> 和 EntityFrameworkCore 进行事务集成，而对于第三方ORM本文提供了一种扩展用以集成的示例。</p>
<p>接入有二种方式</p>
<ul>
<li>安装<code>FreeSql</code>包</li>
</ul>
<div><pre><code>dotnet <span>add</span> package FreeSql
dotnet <span>add</span> package FreeSql.DbContext
dotnet <span>add</span> package FreeSql.Provider.MySqlConnector
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><ul>
<li>安装<code>CAP</code>相关包</li>
</ul>
<div><pre><code>dotnet <span>add</span> package Savorboard.CAP.InMemoryMessageQueue
dotnet <span>add</span> package DotNetCore.CAP.MySql
dotnet <span>add</span> package DotNetCore.CAP.Dashboard
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h2 id="服务" tabindex="-1"> 服务</h2>
<ul>
<li>appsetttings.json</li>
</ul>
<div><pre><code><span>{</span>
  <span>"ConnectionStrings"</span><span>:</span> <span>{</span>
    <span>"MySql"</span><span>:</span> <span>"Data Source=localhost;Port=3306;User ID=root;Password=root;Initial Catalog=lincms;Charset=utf8mb4;SslMode=none;Max pool size=1;Connection LifeTime=20"</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>配置相关服务</li>
</ul>
<div><pre><code> <span>IConfigurationSection</span> mysqlSelection <span>=</span> configuration<span>.</span><span>GetSection</span><span>(</span><span><span>$"ConnectionStrings:MySql"</span></span><span>)</span><span>;</span>
    <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
                <span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>MySql<span>,</span>mysqlSelection<span>.</span>Value<span>)</span>
                <span>.</span><span>UseNameConvert</span><span>(</span>NameConvertType<span>.</span>PascalCaseToUnderscoreWithLower<span>)</span>
                <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
                <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> <span>{</span> Trace<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText <span>+</span> <span>";"</span><span>)</span><span>;</span> <span>}</span><span>)</span>
                <span>.</span><span>Build</span><span>(</span><span>)</span>
    services<span>.</span><span>AddSingleton</span><span>(</span>fsql<span>)</span><span>;</span>
    services<span>.</span><span>AddFreeRepository</span><span>(</span><span>)</span><span>;</span>
    services<span>.</span><span><span>AddScoped</span><span><span>&lt;</span>UnitOfWorkManager<span>></span></span></span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>CAP相关服务
<a href="https://cap.dotnetcore.xyz/user-guide/zh/storage/mysql/" target="_blank" rel="noopener noreferrer">https://cap.dotnetcore.xyz/user-guide/zh/storage/mysql/</a></li>
</ul>
<p>至少你要配置一个消息队列和一个事件存储（UseMySql）</p>
<div><pre><code>  services<span>.</span><span>AddCap</span><span>(</span>x <span>=></span>
    <span>{</span>   
        x<span>.</span><span>UseInMemoryMessageQueue</span><span>(</span><span>)</span><span>;</span>
        x<span>.</span><span>UseMySql</span><span>(</span>opt<span>=></span><span>{</span>
            <span>//MySqlOptions</span>
            opt<span>.</span>ConnectionString <span>=</span> mysqlSelection<span>.</span>Value
        <span>}</span><span>)</span><span>;</span>
        <span>// x.UseXXX ...</span>
         x<span>.</span><span>UseDashboard</span><span>(</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>默认情况下，你可以访问 <a href="http://localhost:xxx/cap" target="_blank" rel="noopener noreferrer">http://localhost:xxx/cap</a> 这个地址打开Dashboard。</p>
<h2 id="方式一" tabindex="-1"> 方式一</h2>
<div><pre><code>    <span>public</span> <span>static</span> <span>class</span> <span>CapUnitOfWorkExtensions</span>
    <span>{</span>
        <span>public</span> <span>static</span> <span><span>void</span></span> <span>Flush</span><span>(</span><span>this</span> <span>ICapTransaction</span> capTransaction<span>)</span>
        <span>{</span>
            capTransaction<span>?.</span><span>GetType</span><span>(</span><span>)</span><span>.</span><span>GetMethod</span><span>(</span><span>"Flush"</span><span>,</span> BindingFlags<span>.</span>Instance <span>|</span> BindingFlags<span>.</span>NonPublic<span>)</span><span>?.</span><span>Invoke</span><span>(</span>capTransaction<span>,</span> <span>null</span><span>)</span><span>;</span>
        <span>}</span>
        <span>public</span> <span>static</span> <span>ICapTransaction</span> <span>BeginTransaction</span><span>(</span><span>this</span> <span>IUnitOfWork</span> unitOfWork<span>,</span> <span>ICapPublisher</span> publisher<span>,</span> <span><span>bool</span></span> autoCommit <span>=</span> <span>false</span><span>)</span>
        <span>{</span>
            <span>//看了源码，换了新的写法，换不同的数据库，就需要手动修改这段代码了（MySqlCapTransaction）</span>
            <span>//publisher.Transaction.Value = (ICapTransaction)publisher.ServiceProvider.GetService(typeof(ICapTransaction));新版本只能得到null</span>
            publisher<span>.</span>Transaction<span>.</span>Value <span>=</span> ActivatorUtilities<span>.</span><span><span>CreateInstance</span><span><span>&lt;</span>MySqlCapTransaction<span>></span></span></span><span>(</span>publisher<span>.</span>ServiceProvider<span>)</span><span>;</span>
            <span>return</span> publisher<span>.</span>Transaction<span>.</span>Value<span>.</span><span>Begin</span><span>(</span>unitOfWork<span>.</span><span>GetOrBeginTransaction</span><span>(</span><span>)</span><span>,</span> autoCommit<span>)</span><span>;</span>
        <span>}</span>

        <span>public</span> <span>static</span> <span><span>void</span></span> <span>Commit</span><span>(</span><span>this</span> <span>ICapTransaction</span> capTransaction<span>,</span> <span>IUnitOfWork</span> unitOfWork<span>)</span>
        <span>{</span>
            unitOfWork<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
            capTransaction<span>.</span><span>Flush</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>
 <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>使用方式</li>
</ul>
<div><pre><code><span>public</span> <span>class</span> <span>BookController</span> <span>:</span> <span><span>Controller</span></span>
<span>{</span>
    <span>[</span><span><span>HttpGet</span><span><span>(</span><span>"~/freesql/unitofwork"</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>DateTime</span> <span>FreeSqlUnitOfWorkManagerTransaction</span><span>(</span><span>[</span><span><span>FromServices</span></span><span>]</span> <span>IBaseRepository<span>&lt;</span>Book<span>></span></span> repo<span>,</span>
    <span>[</span><span><span>FromServices</span></span><span>]</span> <span>UnitOfWorkManager</span> unitOfWorkManager<span>,</span>
    <span>[</span><span><span>FromServices</span></span><span>]</span> <span>ICapPublisher</span> capBus
    <span>)</span>
    <span>{</span>
        <span>DateTime</span> now <span>=</span> DateTime<span>.</span>Now<span>;</span>
        <span>using</span> <span>(</span><span>IUnitOfWork</span> uow <span>=</span> unitOfWorkManager<span>.</span><span>Begin</span><span>(</span><span>)</span><span>)</span>
        <span>{</span>
            <span>ICapTransaction</span> trans <span>=</span> uow<span>.</span><span>BeginTransaction</span><span>(</span>capBus<span>,</span> <span>false</span><span>)</span><span>;</span>

            repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Book</span><span>(</span><span>)</span>
            <span>{</span>
                Author <span>=</span> <span>"叶老板"</span><span>,</span>
                Title <span>=</span> <span>"FreeSql源码解析与实战"</span><span>,</span>
                Summary <span>=</span> <span>"带你了解FreeSql源码细节，掌握FreeSql的实战操作，扩展FreeSql的功能，提升你的开发效率。"</span>
            <span>}</span><span>)</span><span>;</span>

            capBus<span>.</span><span>Publish</span><span>(</span><span>"freesql.time"</span><span>,</span> now<span>)</span><span>;</span>
            trans<span>.</span><span>Commit</span><span>(</span>uow<span>)</span><span>;</span>
        <span>}</span>
        <span>return</span> now<span>;</span>
    <span>}</span>
    <span>[</span><span><span>NonAction</span></span><span>]</span>
    <span>[</span><span><span>CapSubscribe</span><span><span>(</span><span>"freesql.time"</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>void</span></span> <span>GetTime</span><span>(</span><span>DateTime</span> time<span>)</span>
    <span>{</span>
        Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"time:</span><span><span>{</span><span>time</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"book"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>Book</span> 
<span>{</span>
   <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>long</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> 
   
    <span>[</span><span><span>Column</span><span><span>(</span>StringLength <span>=</span> <span>30</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Author <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> 

    <span>[</span><span><span>Column</span><span><span>(</span>StringLength <span>=</span> <span>1000</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Summary <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> 

    <span>[</span><span><span>Column</span><span><span>(</span>StringLength <span>=</span> <span>50</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> 

<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="方式二" tabindex="-1"> 方式二</h2>
<div><pre><code><span>public</span> <span>class</span> <span>FreeSqlRepositoryPatternTransaction</span> <span>:</span> <span><span>CapTransactionBase</span></span>
<span>{</span>
    <span>public</span> <span>FreeSqlRepositoryPatternTransaction</span><span>(</span><span>IDispatcher</span> dispatcher<span>,</span> <span>IUnitOfWork</span> uow<span>)</span> <span>:</span> <span>base</span><span>(</span>dispatcher<span>)</span>
    <span>{</span>
        Uow <span>=</span> uow<span>;</span>
    <span>}</span>

    <span>public</span> <span>IUnitOfWork</span> Uow <span>{</span> <span>get</span><span>;</span> <span>}</span>

    <span>public</span> <span>override</span> <span><span>object</span><span>?</span></span> DbTransaction <span>=></span> Uow<span>.</span><span>GetOrBeginTransaction</span><span>(</span><span>)</span><span>;</span>

    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Commit</span><span>(</span><span>)</span>
    <span>{</span>
        Uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
        <span>Flush</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>override</span> <span>Task</span> <span>CommitAsync</span><span>(</span><span>CancellationToken</span> cancellationToken <span>=</span> <span>default</span><span>)</span>
    <span>{</span>
        <span>throw</span> <span>new</span> <span>NotImplementedException</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Rollback</span><span>(</span><span>)</span>
    <span>{</span>
        Uow<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>override</span> <span>Task</span> <span>RollbackAsync</span><span>(</span><span>CancellationToken</span> cancellationToken <span>=</span> <span>default</span><span>)</span>
    <span>{</span>
        <span>throw</span> <span>new</span> <span>NotImplementedException</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Dispose</span><span>(</span><span>)</span>
    <span>{</span>
        Uow<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>public</span> <span>static</span> <span>class</span> <span>Extensions</span>
<span>{</span>
      <span>// 注意：你可以酌情修改此扩展以支持你的使用习惯，参考下方讨论内容</span>
      <span>public</span> <span>static</span> <span>ICapTransaction</span> <span>BeginTransaction</span><span>(</span><span>this</span> <span>IUnitOfWork</span> unitOfWork<span>,</span> <span>ICapPublisher</span> publisher<span>,</span> <span><span>bool</span></span> autoCommit <span>=</span> <span>false</span><span>)</span>
      <span>{</span>
            <span><span>var</span></span> dispatcher <span>=</span> publisher<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IDispatcher<span>></span></span></span><span>(</span><span>)</span><span>;</span>
            <span><span>var</span></span> transaction <span>=</span> <span>new</span> <span>FreeSqlRepositoryPatternTransaction</span><span>(</span>dispatcher<span>,</span> unitOfWork<span>)</span>
            <span>{</span>
                AutoCommit <span>=</span> autoCommit
            <span>}</span><span>;</span>
            <span>return</span> publisher<span>.</span>Transaction<span>.</span>Value <span>=</span> transaction<span>;</span>
      <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>使用方式：</p>
<div><pre><code><span>[</span><span><span>HttpGet</span><span><span>(</span><span>"~/freesql/Withtransaction"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>DateTime</span> <span>WithTransaction</span><span>(</span><span>[</span><span><span>FromServices</span></span><span>]</span> <span>IBaseRepository<span>&lt;</span>Book<span>></span></span> repo<span>,</span>
<span>[</span><span><span>FromServices</span></span><span>]</span> <span>UnitOfWorkManager</span> unitOfWorkManager<span>,</span>
<span>[</span><span><span>FromServices</span></span><span>]</span> <span>ICapPublisher</span> capBus
<span>)</span>
<span>{</span>
    <span>DateTime</span> now <span>=</span> DateTime<span>.</span>Now<span>;</span>
    <span>using</span> <span>(</span><span>IUnitOfWork</span> uow <span>=</span> unitOfWorkManager<span>.</span><span>Begin</span><span>(</span><span>)</span><span>)</span>
    <span>{</span>
        <span>ICapTransaction</span> trans <span>=</span> uow<span>.</span><span>BeginTransaction</span><span>(</span>capBus<span>,</span> <span>false</span><span>)</span><span>;</span>

        repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Book</span><span>(</span><span>)</span>
        <span>{</span>
            Author <span>=</span> <span>"叶老板"</span><span>,</span>
            Title <span>=</span> <span>"FreeSql源码解析与实战"</span><span>,</span>
            Summary <span>=</span> <span>"带你了解FreeSql源码细节，掌握FreeSql的实战操作，扩展FreeSql的功能，提升你的开发效率。"</span>
        <span>}</span><span>)</span><span>;</span>

        capBus<span>.</span><span>Publish</span><span>(</span><span>"freesql.time"</span><span>,</span> now<span>)</span><span>;</span>
        trans<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>return</span> now<span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>二者区别在于后者，<code>trans.Commit()</code>不需要传递``IUnitOfWork`参数</p>
<h2 id="原文参考" tabindex="-1"> 原文参考</h2>
<ul>
<li><a href="https://www.cnblogs.com/igeekfan/p/cap_freesql_flush.html" target="_blank" rel="noopener noreferrer">FreeSql 接入 CAP 的实践</a></li>
<li><a href="https://github.com/dotnetcore/FreeSql/discussions/1202" target="_blank" rel="noopener noreferrer">如何使 FreeSql 和 CAP 进行集成</a></li>
</ul>
]]></content>
    <published>2022-08-31T14:37:49.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeSql.AdminLTE</title>
    <id>https://freesql.net/guide/freesqladminlte.html</id>
    <link href="https://freesql.net/guide/freesqladminlte.html"/>
    <updated>2022-08-30T23:01:53.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freesql-adminlte" tabindex="-1"> FreeSql.AdminLTE</h1>
<p>它是 FreeSql 衍生出来的 .NETCore MVC 中间件扩展包 FreeSql.AdminLTE.Preview.dll，基于 AdminLTE 前端框架动态产生实体的增删查改界面。</p>
<blockquote>
<p>dotnet add packages FreeSql.AdminLTE.Preview</p>
</blockquote>
<p>输入：实体1、实体2、实体3</p>
<p>输出：后台管理的功能</p>
<div><pre><code>app<span>.</span><span>UseFreeAdminLtePreview</span><span>(</span><span>"/"</span><span>,</span>
    <span>typeof</span><span>(</span><span>Config</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>Role</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>Menu</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>User</span><span>)</span><span>,</span>

    <span>typeof</span><span>(</span><span>Department</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>Employee</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>Position</span><span>)</span><span>,</span>

    <span>typeof</span><span>(</span><span>AppLog</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>LoginLog</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>OprationLog</span><span>)</span><span>,</span>

    <span>typeof</span><span>(</span><span>FreeScheduler<span>.</span>TaskInfo</span><span>)</span><span>,</span>
    <span>typeof</span><span>(</span><span>FreeScheduler<span>.</span>TaskLog</span><span>)</span>
<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>只需要传入实体，就可以生产 curd 的管理功能，是不是有些骚啊~~~</p>
<p><img src="https://user-images.githubusercontent.com/16286519/187557633-351e3fbe-ae87-461f-9e45-f1c31c6a2b92.png" alt="image" loading="lazy"></p>
<p><img src="https://user-images.githubusercontent.com/16286519/187557677-5333484e-92d3-42a4-8543-6baf89814540.png" alt="image" loading="lazy"></p>
<p>对于通用后台管理系统的生成，除了单纯的对单表 crud 操作外，我还喜欢利用导航属性的操作，比如：</p>
<p>1、Song、Tag 多对多场景，添加/更新 Song 时可以把 Tag 一起保存；</p>
<p>2、列表页，希望外键、多对多出现在过滤筛选条件；</p>
<p>3、列表页，希望枚举出现在过滤筛选条件；</p>
<p>4、删除时，级联删除所有相关数据；</p>
<p>等等诸如此类的繁琐操作，之所以说繁琐，是因为这些工作技术不难，属于严重的重复劳动。</p>
<h2 id="机制设定" tabindex="-1"> 机制设定</h2>
<p>1、添加、修改数据</p>
<p>中件间产生的界面包括添加、修改数据的功能，普通实体的根据属性的类型与 Html5 UI 一一映射；</p>
<p>比较特殊的映射规则：</p>
<table>
<thead>
<tr>
<th>c# 类型</th>
<th>Html5</th>
</tr>
</thead>
<tbody>
<tr>
<td>布尔</td>
<td>复选框</td>
</tr>
<tr>
<td>枚举</td>
<td>下拉选择</td>
</tr>
<tr>
<td>日期</td>
<td>日期控件</td>
</tr>
<tr>
<td>ManyToOne 导航属性</td>
<td>下拉选择</td>
</tr>
<tr>
<td>ManyToMany 导航属性</td>
<td>多选器</td>
</tr>
</tbody>
</table>
<p>等等。。。</p>
<p>什么情况会产生【上传文件】控件？
有兴趣的可以了解源码，目前没有开放在外部配置。</p>
<hr>
<p>2、列表查询、过滤筛选</p>
<p>中件间为每个实体提供了分页列表查询，每页为20条数据；</p>
<p>除此外，还提供了过滤条件的支持，规则是根据导航属性（ManyToOne、ManyToMany）。比如【岗位】，内含有【部门 Department】、【员工 Employee】、【角色 Role】，则【岗位】列表页会出现按【分类】筛选的UI，详见上面的 demo 示意图，或者下载 demo 运行；</p>
<hr>
<p>3、删除数据</p>
<p>中件间为每个实体提供了批量删除的功能；</p>
<p>并且支持了复杂导航属性关系的级联删除功能，而这个功能不依赖数据库外键；</p>
<h2 id="下载-demo" tabindex="-1"> 下载 Demo</h2>
<p>我们一直习惯用 sqlite 做测试库，测试完毕直接删除目录，不留垃圾数据，所以下面的 demo 不需要修改任何地方，运行时自动建库、建表；</p>
<p>运行环境：.net6.0</p>
<p><a href="https://files.cnblogs.com/files/FreeSql/freesql.adminlte.preview.zip" target="_blank" rel="noopener noreferrer">https://files.cnblogs.com/files/FreeSql/freesql.adminlte.preview.zip</a></p>
<p>第一步：</p>
<blockquote>
<p>dotnet restore</p>
</blockquote>
<p>第二步：</p>
<blockquote>
<p>dotnet run</p>
</blockquote>
]]></content>
    <published>2022-08-30T23:01:53.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeIM</title>
    <id>https://freesql.net/guide/freeim.html</id>
    <link href="https://freesql.net/guide/freeim.html"/>
    <updated>2022-08-30T05:55:03.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freeim" tabindex="-1"> FreeIM</h1>
<p>FreeIM 使用 websocket 协议实现简易、高性能（单机支持5万+连接）、集群即时通讯组件，支持点对点通讯、群聊通讯、上线下线事件消息等众多实用性功能。</p>
<p>使用场景：好友聊天、群聊天、直播间、实时评论区、游戏。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeIM" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeIM</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16632727.html" target="_blank" rel="noopener noreferrer">《C#.NET im 聊天通讯架构设计 -- FreeIM 支持集群、职责分明、高性能》</a></p>
<blockquote>
<p>dotnet add package FreeIM</p>
</blockquote>
<h2 id="imserver-服务端" tabindex="-1"> ImServer 服务端</h2>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>)</span>
<span>{</span>
    app<span>.</span><span>UseFreeImServer</span><span>(</span><span>new</span> <span>ImServerOptions</span>
    <span>{</span>
        Redis <span>=</span> <span>new</span> <span>FreeRedis<span>.</span>RedisClient</span><span>(</span><span>"127.0.0.1:6379,poolsize=5"</span><span>)</span><span>,</span>
        Servers <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span> <span>"127.0.0.1:6001"</span> <span>}</span><span>,</span> <span>//集群配置</span>
        Server <span>=</span> <span>"127.0.0.1:6001"</span>
    <span>}</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>一套永远不需要迭代更新的 <code>ImServer</code> 服务端，支持 .NET6.0、.NETCore2.1+、NETStandard2.0</p>
</blockquote>
<h2 id="webapi-业务端" tabindex="-1"> WebApi 业务端</h2>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>)</span>
<span>{</span>
    <span>//...</span>

    ImHelper<span>.</span><span>Initialization</span><span>(</span><span>new</span> <span>ImClientOptions</span>
    <span>{</span>
        Redis <span>=</span> <span>new</span> <span>FreeRedis<span>.</span>RedisClient</span><span>(</span><span>"127.0.0.1:6379,poolsize=5"</span><span>)</span><span>,</span>
        Servers <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span> <span>"127.0.0.1:6001"</span> <span>}</span>
    <span>}</span><span>)</span><span>;</span>

    ImHelper<span>.</span><span>EventBus</span><span>(</span>
        t <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>t<span>.</span>clientId <span>+</span> <span>"上线了"</span><span>)</span><span>,</span> 
        t <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>t<span>.</span>clientId <span>+</span> <span>"下线了"</span><span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>ImHelper方法</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>PrevConnectServer</td>
<td>(clientId, string)</td>
<td>在终端准备连接 websocket 前调用</td>
</tr>
<tr>
<td>SendMessage</td>
<td>(发送者, 接收者, 消息内容, 是否回执)</td>
<td>发送消息</td>
</tr>
<tr>
<td>GetClientListByOnline</td>
<td>-</td>
<td>返回所有在线clientId</td>
</tr>
<tr>
<td>HasOnline</td>
<td>clientId</td>
<td>判断客户端是否在线</td>
</tr>
<tr>
<td>EventBus</td>
<td>(上线委托, 离线委托)</td>
<td>socket上线与下线事件</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>频道</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>JoinChan</td>
<td>(clientId, 频道名)</td>
<td>加入</td>
</tr>
<tr>
<td>LeaveChan</td>
<td>(clientId, 频道名)</td>
<td>离开</td>
</tr>
<tr>
<td>GetChanClientList</td>
<td>(频道名)</td>
<td>获取频道所有clientId</td>
</tr>
<tr>
<td>GetChanList</td>
<td>-</td>
<td>获取所有频道和在线人数</td>
</tr>
<tr>
<td>GetChanListByClientId</td>
<td>(clientId)</td>
<td>获取用户参与的所有频道</td>
</tr>
<tr>
<td>GetChanOnline</td>
<td>(频道名)</td>
<td>获取频道的在线人数</td>
</tr>
<tr>
<td>SendChanMessage</td>
<td>(clientId, 频道名, 消息内容)</td>
<td>发送消息，所有在线的用户将收到消息</td>
</tr>
</tbody>
</table>
<ul>
<li>clientId 应该与用户id相同，或者关联；</li>
<li>频道适用临时的群聊需求，如聊天室、讨论区；</li>
</ul>
<blockquote>
<p>ImHelper 支持 .NetFramework 4.5+、.NetStandard 2.0</p>
</blockquote>
<h2 id="html5-终端" tabindex="-1"> Html5 终端</h2>
<p>终端连接 websocket 前，应该先请求 <code>WebApi</code> 获得授权过的地址(ImHelper.PrevConnectServer)，伪代码：</p>
<div><pre><code><span>ajax</span><span>(</span><span>'/prev-connect-imserver'</span><span>,</span> <span>function</span><span>(</span><span>data</span><span>)</span> <span>{</span>
    <span>var</span> url <span>=</span> data<span>;</span> <span>//此时的值：ws://127.0.0.1:6001/ws?token=xxxxx</span>
    <span>var</span> sock <span>=</span> <span>new</span> <span>WebSocket</span><span>(</span>url<span>)</span><span>;</span>
    sock<span>.</span><span>onmessage</span> <span>=</span> <span>function</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
        <span>//...</span>
    <span>}</span><span>;</span>
<span>}</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-08-30T05:43:50.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeScheduler</title>
    <id>https://freesql.net/guide/freescheduler.html</id>
    <link href="https://freesql.net/guide/freescheduler.html"/>
    <updated>2022-08-30T06:16:22.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freescheduler" tabindex="-1"> FreeScheduler</h1>
<p>FreeScheduler 是利用 IdleBus 实现的轻量化定时任务调度，支持临时的延时任务和重复循环任务(可持久化)，可按秒，每天/每周/每月固定时间，自定义间隔执行，支持 .NET Core 2.1+、.NET Framework 4.0+ 运行环境。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeScheduler" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeScheduler</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16623030.html" target="_blank" rel="noopener noreferrer">《.NET 定时任务 -- FreeScheduler 支持 cron、持久化、可变定时设置》</a></p>
<h2 id="快速开始" tabindex="-1"> 快速开始</h2>
<blockquote>
<p>dotnet add package FreeScheduler</p>
</blockquote>
<blockquote>
<p>Install-Package FreeScheduler</p>
</blockquote>
<div><pre><code>static Lazy&lt;Scheduler&gt; _schedulerLazy = new Lazy(() =&gt; new Scheduler(new MyTaskHandler()));
static Scheduler scheduler =&gt; _schedulerLazy.Value;
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h2 id="临时任务-不可持久化" tabindex="-1"> 临时任务(不可持久化)</h2>
<div><pre><code>void Callback()
{
    Console.WriteLine(&quot;时间到了&quot;);
    scheduler.AddTempTask(TimeSpan.FromSeconds(10), Callback); //下一次定时
}

scheduler.AddTempTask(TimeSpan.FromSeconds(10), Callback);
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>Method</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>string AddTempTask(TimeSpan, Action)</td>
<td>创建临时的延时任务，返回 id</td>
</tr>
<tr>
<td>bool RemoveTempTask(string id)</td>
<td>删除任务(临时任务)</td>
</tr>
<tr>
<td>bool ExistsTempTask(string id)</td>
<td>判断任务是否存在(临时任务)</td>
</tr>
<tr>
<td>int QuantityTempTask</td>
<td>任务数量(临时任务)</td>
</tr>
</tbody>
</table>
<h2 id="普通任务" tabindex="-1"> 普通任务</h2>
<div><pre><code>class MyTaskHandler : FreeScheduler.TaskHandlers.TestHandler
{
    public override void OnExecuting(Scheduler scheduler, TaskInfo task)
    {
        //todo..
    }
}
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="持久化任务" tabindex="-1"> 持久化任务</h2>
<div><pre><code>// 使用 FreeSql 持久化任务
class MyTaskHandler : FreeScheduler.TaskHandlers.FreeSqlHandler
{
    public MyTaskHandler(IFreeSql fsql) : base(fsql) { }

    public override void OnExecuting(Scheduler scheduler, TaskInfo task)
    {
        Console.WriteLine($&quot;[{DateTime.Now.ToString(&quot;HH:mm:ss.fff&quot;)}] {task.Topic} 被执行&quot;);

        //强制使任务完成
        //task.Status = TaskStatus.Completed;
    }
}
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>Redis 持久化请安装：</p>
<blockquote>
<p>dotnet add package FreeScheduler.TaskHandlers.FreeRedis</p>
</blockquote>
<blockquote>
<p>Install-Package FreeScheduler.TaskHandlers.FreeRedis</p>
</blockquote>
<h2 id="管理任务" tabindex="-1"> 管理任务</h2>
<div><pre><code>// 使用 FreeSql 或者 SQL 查询 TaskInfo、TaskLog 两个表进行分页显示
fsql.Select&lt;TaskInfo&gt;().Count(out var total).Page(pageNumber, 30).ToList();
fsql.Select&lt;TaskLog&gt;().Count(out var total).Page(pageNumber, 30).ToList();

//暂停任务
scheduler.PauseTask(id);
//恢复暂停的任务
scheduler.ResumeTask(id);
//删除任务
scheduler.RemoveTask(id);
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="api-循环任务-可持久化" tabindex="-1"> API (循环任务/可持久化)</h2>
<div><pre><code>//每5秒触发，执行N次
var id = scheduler.AddTask(&quot;topic1&quot;, &quot;body1&quot;, round: -1, 5);

//每次 不同的间隔秒数触发，执行6次
var id = scheduler.AddTask(&quot;topic1&quot;, &quot;body1&quot;, new [] { 5, 5, 10, 10, 60, 60 });

//每天 20:00:00 触发，指定utc时间，执行N次
var id = scheduler.AddTaskRunOnDay(&quot;topic1&quot;, &quot;body1&quot;, round: -1, &quot;20:00:00&quot;);

//每周一 20:00:00 触发，指定utc时间，执行1次
var id = scheduler.AddTaskRunOnWeek(&quot;topic1&quot;, &quot;body1&quot;, round: 1, &quot;1:20:00:00&quot;);

//每月1日 20:00:00 触发，指定utc时间，执行12次
var id = scheduler.AddTaskRunOnMonth(&quot;topic1&quot;, &quot;body1&quot;, round: 12, &quot;1:20:00:00&quot;);

//自定义间隔
var id = scheduler.AddTaskCustom(&quot;topic1&quot;, &quot;body1&quot;, &quot;0/1 * * * * ? &quot;);
class MyCustomTaskHandler : FreeScheduler.ITaskIntervalCustomHandler
{
    public TimeSpan? NextDelay(TaskInfo task)
    {
        //利用 cron 功能库解析 task.IntervalArgument 得到下一次执行时间
        //与当前时间相减，得到 TimeSpan，若返回 null 则任务完成
        return TimeSpan.FromSeconds(5);
    }
}
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>Method</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>void ctor(ITaskHandler)</td>
<td>指定任务调度器（单例）</td>
</tr>
<tr>
<td>string AddTask(string topic, string body, int round, int seconds)</td>
<td>创建循环定时任务，返回 id</td>
</tr>
<tr>
<td>string AddTask(string topic, string body, int[] seconds)</td>
<td>创建每轮间隔不同的定时任务，返回 id</td>
</tr>
<tr>
<td>string AddTaskRunOnDay(..)</td>
<td>创建每日循环任务，指定utc时间，返回 id</td>
</tr>
<tr>
<td>string AddTaskRunOnWeek(..)</td>
<td>创建每周循环任务，指定utc时间，返回 id</td>
</tr>
<tr>
<td>string AddTaskRunOnMonth(..)</td>
<td>创建每月循环任务，指定utc时间，返回 id</td>
</tr>
<tr>
<td>string AddTaskCustom(string topic, string body, string expression)</td>
<td>创建自定义任务，返回 id</td>
</tr>
<tr>
<td>bool RemoveTask(string id)</td>
<td>删除任务</td>
</tr>
<tr>
<td>bool ExistsTask(string id)</td>
<td>判断任务是否存在</td>
</tr>
<tr>
<td>bool ResumeTask(string id)</td>
<td>恢复已暂停的任务</td>
</tr>
<tr>
<td>bool PauseTask(string id)</td>
<td>暂停正在运行的任务</td>
</tr>
<tr>
<td>TaskInfo[] FindTask(lambda)</td>
<td>查询正在运行中的任务</td>
</tr>
<tr>
<td>int QuantityTask</td>
<td>任务数量</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2022-08-30T05:41:38.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeRedis</title>
    <id>https://freesql.net/guide/freeredis.html</id>
    <link href="https://freesql.net/guide/freeredis.html"/>
    <updated>2022-08-30T06:15:27.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freeredis" tabindex="-1"> FreeRedis</h1>
<p><code>CSRedisCore</code> 是 .NETFramework 4.0 及以上 访问 redis-server 的客户端组件，也是 FreeSql 作者早年发布的 nuget 版本。</p>
<p>后来重构了更简易的 <code>FreeRedis</code>，目前推荐大家使用 <code>FreeRedis</code>。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeRedis" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeRedis</a></p>
<ul>
<li>🌈 所有方法名与 redis-cli 保持一致</li>
<li>🌌 支持 Redis 集群（服务端要求 3.2 及以上版本）</li>
<li>⛳ 支持 Redis 哨兵模式</li>
<li>🎣 支持主从分离（Master-Slave）</li>
<li>📡 支持发布订阅（Pub-Sub）</li>
<li>📃 支持 Redis Lua 脚本</li>
<li>💻 支持管道（Pipeline）</li>
<li>📰 支持事务</li>
<li>🌴 支持 GEO 命令（服务端要求 3.2 及以上版本）</li>
<li>🌲 支持 STREAM 类型命令（服务端要求 5.0 及以上版本）</li>
<li>⚡ 支持本地缓存（Client-side-cahing，服务端要求 6.0 及以上版本）</li>
<li>🌳 支持 Redis 6 的 RESP3 协议</li>
</ul>
<h2 id="🚀-快速入门" tabindex="-1"> 🚀 快速入门</h2>
<div><pre><code><span>public</span> <span>static</span> <span>RedisClient</span> cli <span>=</span> <span>new</span> <span>RedisClient</span><span>(</span><span>"127.0.0.1:6379,password=123,defaultDatabase=13"</span><span>)</span><span>;</span>
<span>//cli.Serialize = obj => JsonConvert.SerializeObject(obj);</span>
<span>//cli.Deserialize = (json, type) => JsonConvert.DeserializeObject(json, type);</span>
cli<span>.</span>Notice <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>e<span>.</span>Log<span>)</span><span>;</span> <span>//打印命令日志</span>

cli<span>.</span><span>Set</span><span>(</span><span>"key1"</span><span>,</span> <span>"value1"</span><span>)</span><span>;</span>
cli<span>.</span><span>MSet</span><span>(</span><span>"key1"</span><span>,</span> <span>"value1"</span><span>,</span> <span>"key2"</span><span>,</span> <span>"value2"</span><span>)</span><span>;</span>

<span><span>string</span></span> value1 <span>=</span> cli<span>.</span><span>Get</span><span>(</span><span>"key1"</span><span>)</span><span>;</span>
<span><span>string</span><span>[</span><span>]</span></span> vals <span>=</span> cli<span>.</span><span>MGet</span><span>(</span><span>"key1"</span><span>,</span> <span>"key2"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>支持 STRING、HASH、LIST、SET、ZSET、BITMAP、HyperLogLog、GEO、Stream 以及布隆过滤器等。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:right">默认值</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">protocol</td>
<td style="text-align:right">RESP2</td>
<td style="text-align:left">若使用 RESP3 协议，你需要 Redis 6.0 环境</td>
</tr>
<tr>
<td style="text-align:left">user</td>
<td style="text-align:right">&lt;empty&gt;</td>
<td style="text-align:left">Redis 服务端用户名，要求 Redis 6.0 环境</td>
</tr>
<tr>
<td style="text-align:left">password</td>
<td style="text-align:right">&lt;empty&gt;</td>
<td style="text-align:left">Redis 服务端密码</td>
</tr>
<tr>
<td style="text-align:left">defaultDatabase</td>
<td style="text-align:right">0</td>
<td style="text-align:left">Redis 服务端数据库</td>
</tr>
<tr>
<td style="text-align:left">max poolsize</td>
<td style="text-align:right">100</td>
<td style="text-align:left">连接池最大连接数</td>
</tr>
<tr>
<td style="text-align:left">min poolsize</td>
<td style="text-align:right">5</td>
<td style="text-align:left">连接池最小连接数</td>
</tr>
<tr>
<td style="text-align:left">idleTimeout</td>
<td style="text-align:right">20000</td>
<td style="text-align:left">连接池中元素的空闲时间（单位为毫秒 ms），适用于连接到远程服务器</td>
</tr>
<tr>
<td style="text-align:left">connectTimeout</td>
<td style="text-align:right">10000</td>
<td style="text-align:left">连接超时，单位为毫秒（ms）</td>
</tr>
<tr>
<td style="text-align:left">receiveTimeout</td>
<td style="text-align:right">10000</td>
<td style="text-align:left">接收超时，单位为毫秒（ms）</td>
</tr>
<tr>
<td style="text-align:left">sendTimeout</td>
<td style="text-align:right">10000</td>
<td style="text-align:left">发送超时，单位为毫秒（ms）</td>
</tr>
<tr>
<td style="text-align:left">encoding</td>
<td style="text-align:right">utf-8</td>
<td style="text-align:left">字符串字符集</td>
</tr>
<tr>
<td style="text-align:left">retry</td>
<td style="text-align:right">0</td>
<td style="text-align:left">协议发生错误时，重试执行的次数</td>
</tr>
<tr>
<td style="text-align:left">ssl</td>
<td style="text-align:right">false</td>
<td style="text-align:left">启用加密传输</td>
</tr>
<tr>
<td style="text-align:left">name</td>
<td style="text-align:right">&lt;empty&gt;</td>
<td style="text-align:left">连接名，使用 CLIENT LIST 命令查看</td>
</tr>
<tr>
<td style="text-align:left">prefix</td>
<td style="text-align:right">&lt;empty&gt;</td>
<td style="text-align:left"><code>key</code> 前辍，所有方法都会附带此前辍，cli.Set(prefix + &quot;key&quot;, 111);</td>
</tr>
</tbody>
</table>
<blockquote>
<p>IPv6: [fe80::b164:55b3:4b4f:7ce6%15]:6379</p>
</blockquote>
<h2 id="🎣-master-slave-读写分离" tabindex="-1"> 🎣 Master-Slave (读写分离)</h2>
<div><pre><code><span>public</span> <span>static</span> <span>RedisClient</span> cli <span>=</span> <span>new</span> <span>RedisClient</span><span>(</span>
    <span>"127.0.0.1:6379,password=123,defaultDatabase=13"</span><span>,</span>
    <span>"127.0.0.1:6380,password=123,defaultDatabase=13"</span><span>,</span>
    <span>"127.0.0.1:6381,password=123,defaultDatabase=13"</span>
    <span>)</span><span>;</span>

<span><span>var</span></span> <span>value</span> <span>=</span> cli<span>.</span><span>Get</span><span>(</span><span>"key1"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>写入时连接 127.0.0.1:6379，读取时随机连接 6380 6381</p>
</blockquote>
<h2 id="⛳-redis-sentinel-哨兵高可用" tabindex="-1"> ⛳ Redis Sentinel (哨兵高可用)</h2>
<div><pre><code><span>public</span> <span>static</span> <span>RedisClient</span> cli <span>=</span> <span>new</span> <span>RedisClient</span><span>(</span>
    <span>"mymaster,password=123"</span><span>,</span> 
    <span>new</span> <span>[</span><span>]</span> <span>{</span> <span>"192.169.1.10:26379"</span><span>,</span> <span>"192.169.1.11:26379"</span><span>,</span> <span>"192.169.1.12:26379"</span> <span>}</span><span>,</span>
    <span>true</span> <span>//是否读写分离</span>
    <span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="🌌-redis-cluster-集群" tabindex="-1"> 🌌 Redis Cluster (集群)</h2>
<p>假如你有一个 Redis Cluster 集群，其中有三个主节点(7001-7003)、三个从节点(7004-7006)，则连接此集群的代码：</p>
<div><pre><code><span>public</span> <span>static</span> <span>RedisClient</span> cli <span>=</span> <span>new</span> <span>RedisClient</span><span>(</span>
    <span>new</span> <span>ConnectionStringBuilder<span>[</span><span>]</span></span> <span>{</span> <span>"192.168.0.2:7001"</span><span>,</span> <span>"192.168.0.2:7002"</span><span>,</span> <span>"192.168.0.2:7003"</span> <span>}</span>
    <span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h2 id="⚡-client-side-cahing-本地缓存" tabindex="-1"> ⚡ Client-side-cahing (本地缓存)</h2>
<blockquote>
<p>服务端要求 6.0 及以上版本</p>
</blockquote>
<div><pre><code>cli<span>.</span><span>UseClientSideCaching</span><span>(</span><span>new</span> <span>ClientSideCachingOptions</span>
<span>{</span>
    <span>//本地缓存的容量</span>
    Capacity <span>=</span> <span>3</span><span>,</span>
    <span>//过滤哪些键能被本地缓存</span>
    KeyFilter <span>=</span> key <span>=></span> key<span>.</span><span>StartsWith</span><span>(</span><span>"Interceptor"</span><span>)</span><span>,</span>
    <span>//检查长期未使用的缓存</span>
    CheckExpired <span>=</span> <span>(</span>key<span>,</span> dt<span>)</span> <span>=></span> DateTime<span>.</span>Now<span>.</span><span>Subtract</span><span>(</span>dt<span>)</span> <span>></span> TimeSpan<span>.</span><span>FromSeconds</span><span>(</span><span>2</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="📡-subscribe-订阅" tabindex="-1"> 📡 Subscribe (订阅)</h2>
<div><pre><code><span>using</span> <span>(</span>cli<span>.</span><span>Subscribe</span><span>(</span><span>"abc"</span><span>,</span> ondata<span>)</span><span>)</span> <span>//wait .Dispose()</span>
<span>{</span>
    Console<span>.</span><span>ReadKey</span><span>(</span><span>)</span><span>;</span>
<span>}</span>

<span><span>void</span></span> <span>ondata</span><span>(</span><span><span>string</span></span> channel<span>,</span> <span><span>string</span></span> data<span>)</span> <span>=></span>
    Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"</span><span><span>{</span><span>channel</span><span>}</span></span><span> -> </span><span><span>{</span><span>data</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="📃-scripting-脚本" tabindex="-1"> 📃 Scripting (脚本)</h2>
<div><pre><code><span><span>var</span></span> r1 <span>=</span> cli<span>.</span><span>Eval</span><span>(</span><span>"return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}"</span><span>,</span> 
    <span>new</span><span>[</span><span>]</span> <span>{</span> <span>"key1"</span><span>,</span> <span>"key2"</span> <span>}</span><span>,</span> <span>"first"</span><span>,</span> <span>"second"</span><span>)</span> <span>as</span> <span><span>object</span><span>[</span><span>]</span></span><span>;</span>

<span><span>var</span></span> r2 <span>=</span> cli<span>.</span><span>Eval</span><span>(</span><span>"return {1,2,{3,'Hello World!'}}"</span><span>)</span> <span>as</span> <span><span>object</span><span>[</span><span>]</span></span><span>;</span>

cli<span>.</span><span>Eval</span><span>(</span><span>"return redis.call('set',KEYS[1],'bar')"</span><span>,</span> 
    <span>new</span><span>[</span><span>]</span> <span>{</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>)</span> <span>}</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="💻-pipeline-管道" tabindex="-1"> 💻 Pipeline (管道)</h2>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> pipe <span>=</span> cli<span>.</span><span>StartPipe</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    pipe<span>.</span><span>IncrBy</span><span>(</span><span>"key1"</span><span>,</span> <span>10</span><span>)</span><span>;</span>
    pipe<span>.</span><span>Set</span><span>(</span><span>"key2"</span><span>,</span> Null<span>)</span><span>;</span>
    pipe<span>.</span><span>Get</span><span>(</span><span>"key1"</span><span>)</span><span>;</span>

    <span><span>object</span><span>[</span><span>]</span></span> ret <span>=</span> pipe<span>.</span><span>EndPipe</span><span>(</span><span>)</span><span>;</span>
    Console<span>.</span><span>WriteLine</span><span>(</span>ret<span>[</span><span>0</span><span>]</span> <span>+</span> <span>", "</span> <span>+</span> ret<span>[</span><span>2</span><span>]</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="📰-transaction-事务" tabindex="-1"> 📰 Transaction (事务)</h2>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> tran <span>=</span> cli<span>.</span><span>Multi</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    tran<span>.</span><span>IncrBy</span><span>(</span><span>"key1"</span><span>,</span> <span>10</span><span>)</span><span>;</span>
    tran<span>.</span><span>Set</span><span>(</span><span>"key2"</span><span>,</span> Null<span>)</span><span>;</span>
    tran<span>.</span><span>Get</span><span>(</span><span>"key1"</span><span>)</span><span>;</span>

    <span><span>object</span><span>[</span><span>]</span></span> ret <span>=</span> tran<span>.</span><span>Exec</span><span>(</span><span>)</span><span>;</span>
    Console<span>.</span><span>WriteLine</span><span>(</span>ret<span>[</span><span>0</span><span>]</span> <span>+</span> <span>", "</span> <span>+</span> ret<span>[</span><span>2</span><span>]</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="📯-getdatabase-切库" tabindex="-1"> 📯 GetDatabase (切库)</h2>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> db <span>=</span> cli<span>.</span><span>GetDatabase</span><span>(</span><span>10</span><span>)</span><span>)</span>
<span>{</span>
    db<span>.</span><span>Set</span><span>(</span><span>"key1"</span><span>,</span> <span>10</span><span>)</span><span>;</span>
    <span><span>var</span></span> val1 <span>=</span> db<span>.</span><span>Get</span><span>(</span><span>"key1"</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="🔍-scan-扫描" tabindex="-1"> 🔍 Scan (扫描)</h2>
<blockquote>
<p>支持集群模式</p>
</blockquote>
<div><pre><code><span>foreach</span> <span>(</span><span><span>var</span></span> keys <span>in</span> cli<span>.</span><span>Scan</span><span>(</span><span>"*"</span><span>,</span> <span>10</span><span>,</span> <span>null</span><span>)</span><span>)</span>
<span>{</span>
    Console<span>.</span><span>WriteLine</span><span>(</span><span>string</span><span>.</span><span>Join</span><span>(</span><span>", "</span><span>,</span> keys<span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-08-30T05:39:40.000Z</published>
  </entry>
  <entry>
    <title type="html">其他作品</title>
    <id>https://freesql.net/guide/otherworks.html</id>
    <link href="https://freesql.net/guide/otherworks.html"/>
    <updated>2022-08-30T05:53:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="其他作品" tabindex="-1"> 其他作品</h1>
<p>FreeSql 作者是一个入行 18年的老批，他目前写的开源项目还有：</p>
<table>
<thead>
<tr>
<th>开源项目</th>
<th>描述</th>
<th>开源地址</th>
<th>开源协议</th>
</tr>
</thead>
<tbody>
<tr>
<td>FreeIM</td>
<td>聊天系统架构</td>
<td><a href="https://github.com/2881099/FreeIM" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeIM</a></td>
<td>MIT</td>
</tr>
<tr>
<td>FreeRedis</td>
<td>Redis SDK</td>
<td><a href="https://github.com/2881099/FreeRedis" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeRedis</a></td>
<td>MIT</td>
</tr>
<tr>
<td>csredis</td>
<td></td>
<td><a href="https://github.com/2881099/csredis" target="_blank" rel="noopener noreferrer">https://github.com/2881099/csredis</a></td>
<td>MIT</td>
</tr>
<tr>
<td>FightLandlord</td>
<td>斗DI主网络版</td>
<td><a href="https://github.com/2881099/FightLandlord" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FightLandlord</a></td>
<td>学习用途</td>
</tr>
<tr>
<td>FreeScheduler</td>
<td>定时任务</td>
<td><a href="https://github.com/2881099/FreeScheduler" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeScheduler</a></td>
<td>MIT</td>
</tr>
<tr>
<td>IdleBus</td>
<td>空闲容器</td>
<td><a href="https://github.com/2881099/IdleBus" target="_blank" rel="noopener noreferrer">https://github.com/2881099/IdleBus</a></td>
<td>MIT</td>
</tr>
<tr>
<td>FreeSql</td>
<td>ORM</td>
<td><a href="https://github.com/dotnetcore/FreeSql" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql</a></td>
<td>MIT</td>
</tr>
<tr>
<td>FreeSql.Cloud</td>
<td>分布式tcc/saga</td>
<td><a href="https://github.com/2881099/FreeSql.Cloud" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.Cloud</a></td>
<td>MIT</td>
</tr>
<tr>
<td>FreeSql.AdminLTE</td>
<td>低代码后台生成</td>
<td><a href="https://github.com/2881099/FreeSql.AdminLTE" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.AdminLTE</a></td>
<td>MIT</td>
</tr>
<tr>
<td>FreeSql.DynamicProxy</td>
<td>动态代理</td>
<td><a href="https://github.com/2881099/FreeSql.DynamicProxy" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.DynamicProxy</a></td>
<td>学习用途</td>
</tr>
</tbody>
</table>
<p>更早的作品可以直接访问 <a href="https://github.com/2881099" target="_blank" rel="noopener noreferrer">https://github.com/2881099</a> 查看。</p>
<h2 id="csredis" tabindex="-1"> csredis</h2>
<p>.NET Core or .NET Framework 4.0+ client for Redis and Redis Sentinel (2.8) and Cluster. Includes both synchronous and asynchronous clients.</p>
<p><code>CSRedisCore</code> 是 .NETFramework 4.0 及以上 访问 redis-server 的客户端组件，也是 FreeSql 作者早年发布的 nuget 版本。</p>
<p>后来重构了更简易的 <code>FreeRedis</code>，目前推荐大家使用 <code>FreeRedis</code>。</p>
<p>开源地址：<a href="https://github.com/2881099/csredis" target="_blank" rel="noopener noreferrer">https://github.com/2881099/csredis</a></p>
<h2 id="freeredis" tabindex="-1"> FreeRedis</h2>
<p>基于 .NET 的 Redis 客户端，支持 .NET Core 2.1+、.NET Framework 4.0+ 以及 Xamarin。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeRedis" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeRedis</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16455983.html" target="_blank" rel="noopener noreferrer">《.NET Redis Client 又多了一个选择，还在被 StackExchange.Redis Timeout 问题困扰吗？》</a></p>
<h2 id="freescheduler" tabindex="-1"> FreeScheduler</h2>
<p>FreeScheduler 是利用 IdleBus 实现的轻量化定时任务调度，支持临时的延时任务和重复循环任务(可持久化)，可按秒，每天/每周/每月固定时间，自定义间隔执行，支持 .NET Core 2.1+、.NET Framework 4.0+ 运行环境。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeScheduler" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeScheduler</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16623030.html" target="_blank" rel="noopener noreferrer">《.NET 定时任务 -- FreeScheduler 支持 cron、持久化、可变定时设置》</a></p>
<h2 id="freeim" tabindex="-1"> FreeIM</h2>
<p>FreeIM 使用 websocket 协议实现简易、高性能（单机支持5万+连接）、集群即时通讯组件，支持点对点通讯、群聊通讯、上线下线事件消息等众多实用性功能。</p>
<p>使用场景：好友聊天、群聊天、直播间、实时评论区、游戏。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeIM" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeIM</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16632727.html" target="_blank" rel="noopener noreferrer">《C#.NET im 聊天通讯架构设计 -- FreeIM 支持集群、职责分明、高性能》</a></p>
<h2 id="fightlandlord" tabindex="-1"> FightLandlord</h2>
<p>.NETCore斗地主服务端 + HTML5前端，使用了 FreeIM 网络通讯</p>
<p>开源地址：<a href="https://github.com/2881099/FightLandlord" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FightLandlord</a></p>
<h2 id="idlebus" tabindex="-1"> IdleBus</h2>
<p>IdleBus 空闲对象管理容器，有效组织对象重复利用，自动创建、销毁，解决【实例】过多且长时间占用的问题。</p>
<p>开源地址：<a href="https://github.com/2881099/IdleBus" target="_blank" rel="noopener noreferrer">https://github.com/2881099/IdleBus</a></p>
<h2 id="freesql" tabindex="-1"> FreeSql</h2>
<p>FreeSql 是一款功能强大的对象关系映射（O/RM）组件，支持 .NET Core 2.1+、.NET Framework 4.0+ 以及 Xamarin。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeSql" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql</a></p>
<h2 id="freesql-cloud" tabindex="-1"> FreeSql.Cloud</h2>
<p>为 FreeSql 提供跨数据库访问，分布式事务TCC、SAGA解决方案，支持 .NET Core 2.1+, .NET Framework 4.0+.</p>
<p>开源地址：<a href="https://github.com/2881099/FreeSql.Cloud" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.Cloud</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16556303.html" target="_blank" rel="noopener noreferrer">《FreeSql 将 Saas 租户方案精简到极致[.NET ORM SAAS]》</a>、<a href="https://www.cnblogs.com/FreeSql/p/16594837.html" target="_blank" rel="noopener noreferrer">FreeSql 分布式事务 TCC/Saga 编排重要性</a></p>
<h2 id="freesql-adminlte" tabindex="-1"> FreeSql.AdminLTE</h2>
<p>.NETCore MVC 中间件，基于 AdminLTE 前端框架动态产生指定 FreeSql 实体的增删查改的【预览管理功能】。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeSql.AdminLTE" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.AdminLTE</a></p>
<p>扩展资料：<a href="https://www.cnblogs.com/FreeSql/p/16287701.html" target="_blank" rel="noopener noreferrer">《【低码】asp.net core 实体类可生产 CRUD 后台管理界面》</a></p>
<h2 id="freesql-dynamicproxy" tabindex="-1"> FreeSql.DynamicProxy</h2>
<p>轻量级 AOP 动态代理，支持 .NetCore 或 .NetFramework4.0+ 平台，使用动态编译技术一般用于学习用途。</p>
<p>开源地址：<a href="https://github.com/2881099/FreeSql.DynamicProxy" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.DynamicProxy</a></p>
]]></content>
    <published>2022-08-30T05:35:49.000Z</published>
  </entry>
  <entry>
    <title type="html">联合查询</title>
    <id>https://freesql.net/guide/unionall.html</id>
    <link href="https://freesql.net/guide/unionall.html"/>
    <updated>2022-08-26T10:27:38.000Z</updated>
    <content type="html"><![CDATA[<h1 id="联合查询" tabindex="-1"> 联合查询</h1>
<p>在之前都是推荐使用 ToSql + WithSql 完成联合查询操作，v3.2.666 最增功能直接使用 UnionAll 方法。</p>
<p>GroupBy + WithTempQuery(嵌套查询) + FromQuery + UnionAll 组合使用，会让查询功能更加强大、灵活。</p>
<p>1、单表 UNION ALL</p>
<div><pre><code><span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
    <span>.</span><span>UnionAll</span><span>(</span>
        fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>2</span><span>)</span><span>,</span>
        fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>3</span><span>)</span>
    <span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span> <span>||</span> a<span>.</span>Id <span>==</span> <span>2</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
<span>FROM</span> <span>(</span> <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
    <span>FROM</span> <span>"User"</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>1</span><span>)</span> 
    <span>UNION</span> <span>ALL</span> 
    <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
    <span>FROM</span> <span>"User"</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>2</span><span>)</span> 
    <span>UNION</span> <span>ALL</span> 
    <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
    <span>FROM</span> <span>"User"</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>3</span><span>)</span> <span>)</span> a 
<span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>1</span> <span>OR</span> a<span>.</span><span>"Id"</span> <span>=</span> <span>2</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>2、多表 UNION ALL</p>
<div><pre><code><span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>,</span> Group<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
    <span>.</span><span>WithTempQuery</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span> <span>{</span> user <span>=</span> a<span>,</span> <span>group</span> <span>=</span> b <span>}</span><span>)</span> <span>//匿名类型</span>

    <span>.</span><span>UnionAll</span><span>(</span>
        fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>,</span> Group<span>></span></span></span><span>(</span><span>)</span>
            <span>.</span><span>Where</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>Id <span>==</span> <span>2</span><span>)</span>
            <span>.</span><span>WithTempQuery</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span> <span>{</span> user <span>=</span> a<span>,</span> <span>group</span> <span>=</span> b <span>}</span><span>)</span> <span>//匿名类型</span>
    <span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>user<span>.</span>Id <span>==</span> <span>1</span> <span>||</span> a<span>.</span>user<span>.</span>Id <span>==</span> <span>2</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> <span>*</span> 
<span>FROM</span> <span>(</span> <span>SELECT</span> <span>*</span> 
    <span>FROM</span> <span>(</span> 
        <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span><span>,</span> b<span>.</span><span>"Id"</span><span>,</span> b<span>.</span><span>"GroupName"</span> 
        <span>FROM</span> <span>"User"</span> a 
        <span>INNER</span> <span>JOIN</span> <span>"UserGroup"</span> b <span>ON</span> a<span>.</span><span>"GroupId"</span> <span>=</span> b<span>.</span><span>"Id"</span> 
        <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>1</span><span>)</span> <span>)</span> a 
    <span>UNION</span> <span>ALL</span> 
    <span>SELECT</span> <span>*</span> 
    <span>FROM</span> <span>(</span> 
        <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span><span>,</span> b<span>.</span><span>"Id"</span><span>,</span> b<span>.</span><span>"GroupName"</span> 
        <span>FROM</span> <span>"User"</span> a 
        <span>INNER</span> <span>JOIN</span> <span>"UserGroup"</span> b <span>ON</span> a<span>.</span><span>"GroupId"</span> <span>=</span> b<span>.</span><span>"Id"</span> 
        <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>2</span><span>)</span> <span>)</span> a <span>)</span> a 
<span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>1</span> <span>OR</span> a<span>.</span><span>"Id"</span> <span>=</span> <span>2</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>注意：如上 SQL 会执行报错，因为 User、UserGroup 都存在相同的 Id 字段名称，暂时的解决办法需要指定字段</p>
<div><pre><code>    <span>.</span><span>WithTempQuery</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span> 
    <span>{</span> 
        user <span>=</span> a<span>,</span> 
        <span>group</span> <span>=</span> <span>new</span>
        <span>{</span>
            GroupId <span>=</span> b<span>.</span>Id<span>,</span>
            GroupName <span>=</span> b<span>.</span>GroupName
        <span>}</span> 
    <span>}</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>3、WithParameters 参数化共享</p>
<p>开启参数化查询功能后，使用 WithParameters 共享参数化，避免产生相同的参数名称：</p>
<div><pre><code><span><span>var</span></span> dbpars <span>=</span> <span>new</span> <span>List<span>&lt;</span>DbParameter<span>></span></span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> id1 <span>=</span> <span>1</span><span>;</span>
<span><span>var</span></span> id2 <span>=</span> <span>2</span><span>;</span>
<span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithParameters</span><span>(</span>dbpars<span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> id1<span>)</span>

    <span>.</span><span>UnionAll</span><span>(</span>
        fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span>
            <span>.</span><span>WithParameters</span><span>(</span>dbpars<span>)</span>
            <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> id2<span>)</span>
    <span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span> <span>||</span> a<span>.</span>Id <span>==</span> <span>2</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
<span>FROM</span> <span>(</span> <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
    <span>FROM</span> <span>"User1"</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>@exp_0</span><span>)</span> 
    <span>UNION</span> <span>ALL</span> 
    <span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"GroupId"</span><span>,</span> a<span>.</span><span>"Username"</span> 
    <span>FROM</span> <span>"User1"</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>@exp_1</span><span>)</span> <span>)</span> a 
<span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span>"Id"</span> <span>=</span> <span>1</span> <span>OR</span> a<span>.</span><span>"Id"</span> <span>=</span> <span>2</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-08-26T09:40:43.000Z</published>
  </entry>
  <entry>
    <title type="html">动态操作</title>
    <id>https://freesql.net/guide/dynamic.html</id>
    <link href="https://freesql.net/guide/dynamic.html"/>
    <updated>2022-08-17T03:35:52.000Z</updated>
    <content type="html"><![CDATA[<h1 id="动态操作" tabindex="-1"> 动态操作</h1>
<h2 id="弱类型-crud" tabindex="-1"> 弱类型 CRUD</h2>
<div><pre><code>fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span>
  <span>.</span><span>AppendData</span><span>(</span>data<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>data<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> <span>(</span>a <span>as</span> <span>BaseEntity</span><span>)</span><span>.</span>Id <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

<span>//或者仓储</span>
<span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span><span>;</span>

repo<span>.</span><span>Insert</span><span>(</span><span>..</span><span>)</span><span>;</span>
repo<span>.</span><span>Update</span><span>(</span><span>..</span><span>)</span><span>;</span>
repo<span>.</span><span>Delete</span><span>(</span><span>..</span><span>)</span><span>;</span>
repo<span>.</span><span>InsertOrUpdate</span><span>(</span><span>..</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：动态编译技术 <a href="https://natasha.dotnetcore.xyz/zh-Hans/docs/get_started/string-complie" target="_blank" rel="noopener noreferrer">https://natasha.dotnetcore.xyz/zh-Hans/docs/get_started/string-complie</a></p>
</blockquote>
<h2 id="字典-cud" tabindex="-1"> 字典 CUD</h2>
<div><pre><code><span><span>var</span></span> dic <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"id"</span><span>,</span> <span>1</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"name"</span><span>,</span> <span>"xxxx"</span><span>)</span><span>;</span>

fsql<span>.</span><span>InsertDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>UpdateDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>WherePrimary</span><span>(</span><span>"id"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>DeleteDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>InsertOrUpdateDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>WherePrimary</span><span>(</span><span>"id"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>InsertDict/UpdateDict/DeleteDict/InsertOrUpdateDict 都支持批量操作，对应类型 List&lt;Dictionary&lt;string, object&gt;&gt;</p>
<h2 id="动态条件" tabindex="-1"> 动态条件</h2>
<p>1、ISelect.Where(string sql) 使用原生条件：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>"a.id > 0"</span><span>)</span> <span>//提示：存在SQL注入安全问题</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>2、动态 Lambda 表达式</p>
<ul>
<li><code>And</code>、<code>Or</code>扩展方法 <a href="https://github.com/dotnetcore/FreeSql/blob/master/FreeSql/Extensions/LambadaExpressionExtensions.cs" target="_blank" rel="noopener noreferrer">LambadaExpressionExtensions.cs</a></li>
</ul>
<div><pre><code><span>Expression<span>&lt;</span>Func<span>&lt;</span>Region<span>,</span> <span>bool</span><span>></span><span>></span></span> <span>where</span> <span>=</span> <span>null</span><span>;</span>
<span>where</span> <span>=</span> <span>where</span><span>.</span><span>And</span><span>(</span>b <span>=></span> b<span>.</span>Id <span>></span> <span>10</span><span>)</span><span>;</span>
<span>where</span> <span>=</span> <span>where</span><span>.</span><span>Or</span><span>(</span>b <span>=></span> b<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>where</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//WHERE id > 10 OR id = 1</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>3、ISelect.WhereDynamicFilter 方法实现动态过滤条件（与前端交互），支持的操作符：</p>
<ul>
<li>Contains/StartsWith/EndsWith/NotContains/NotStartsWith/NotEndsWith：包含/不包含，like '%xx%'，或者 like 'xx%'，或者 like '%xx'</li>
<li>Equal/NotEqual：等于/不等于</li>
<li>GreaterThan/GreaterThanOrEqual：大于/大于等于</li>
<li>LessThan/LessThanOrEqual：小于/小于等于</li>
<li>Range：范围查询</li>
<li>DateRange：日期范围，有特殊处理 value[1] + 1</li>
<li>Any/NotAny：是否符合 value 中任何一项（直白的说是 SQL IN）</li>
<li>Custom：自定义解析</li>
</ul>
<div><pre><code><span>DynamicFilterInfo</span> dyfilter <span>=</span> JsonConvert<span>.</span><span><span>DeserializeObject</span><span><span>&lt;</span>DynamicFilterInfo<span>></span></span></span><span>(</span><span>@"
{
    ""Logic"": ""And"",
    ""Filters"":
    [
        { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 1 },
        {
            ""Logic"": ""Or"",
            ""Filters"":
            [
                { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 2 },
                { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 3 }
            ]
        }
    ]
}"</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>WhereDynamicFilter</span><span>(</span>dyfilter<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//WHERE id = 1 AND (id = 2 OR id = 3)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p><a href="https://www.cnblogs.com/FreeSql/p/16485310.html" target="_blank" rel="noopener noreferrer">《高效理解 FreeSql WhereDynamicFilter，深入了解设计初衷》</a></p>
<h2 id="动态排序" tabindex="-1"> 动态排序</h2>
<p>1、ISelect.OrderBy(string sql) 使用原生排序：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span><span>"a.id desc"</span><span>)</span> <span>//提示：存在SQL注入安全问题</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>2、ISelect.OrderByPropertyName 使用属性名排序：</p>
<ul>
<li>支持导航属性，比如 OrderByPropertyName(&quot;Parent.Code&quot;)</li>
<li>支持多表查询，比如 OrderByPropertyName(&quot;b.Code&quot;)</li>
</ul>
<h2 id="动态贪婪加载" tabindex="-1"> 动态贪婪加载</h2>
<p>1、ISelect.IncludeByPropertyName 方法实现动态贪婪加载，对应 Include/IncludeMany：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>IncludeByPropertyName</span><span>(</span><span>"Parent.Parent.Parent"</span><span>)</span>
    <span>.</span><span>IncludeByPropertyName</span><span>(</span><span>"Childs"</span><span>)</span>

    <span>.</span><span>IncludeByPropertyName</span><span>(</span><span>"Childs"</span><span>,</span> then <span>=></span> then
        <span>.</span><span>IncludeByPropertyName</span><span>(</span><span>"Parent.Parent"</span><span>)</span>
        <span>.</span><span>IncludeByPropertyName</span><span>(</span><span>"Parent.Childs"</span><span>)</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>2、List&lt;TDto&gt;.IncludeByPropertyName 扩展方法也实现了 OneToMany 动态贪婪加载：</p>
<blockquote>
<p>非实体类型，也可以级联加载，他们不需要配置导航属性关系。</p>
</blockquote>
<div><pre><code><span><span>var</span></span> dtos <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span><span>ToList</span><span><span>&lt;</span>Dto<span>></span></span></span><span>(</span><span>)</span><span>;</span>

dtos<span>.</span><span>IncludeByPropertyName</span><span>(</span>
    <span>orm</span><span>:</span> fsql<span>,</span> 
    <span>property</span><span>:</span> <span>"Childs"</span><span>,</span> 
    <span>where</span><span>:</span> <span>"ParentId=Id"</span><span>,</span> <span>//临时关系</span>
    take<span>:</span> <span>5</span><span>,</span> 
    <span>select</span><span>:</span> <span>"id,name"</span><span>,</span>
    then <span>=></span> then<span>.</span><span>IncludeByPropertyName</span><span>(</span><span>"Parent"</span><span>)</span>
<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="动态返回数据" tabindex="-1"> 动态返回数据</h2>
<p>1、ISelect.ToList 使用原生SQL返回数据：</p>
<div><pre><code><span>List<span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>)</span><span>></span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span><span>ToList</span><span><span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>)</span><span>></span></span></span><span>(</span><span>"a.id,a.name"</span><span>)</span> <span>//提示：存在SQL注入安全问题</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>2、ISelect.ToDataTableByPropertyName 使用属性名返回数据：</p>
<div><pre><code><span>DataTable</span> dt <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>ToDataTableByPropertyName</span><span>(</span><span>new</span> <span>[</span><span>]</span> <span>{</span>
        <span>"Parent.Code"</span><span>,</span>
        <span>"b.Id"</span>
    <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="动态片段" tabindex="-1"> 动态片段</h2>
<p>FreeSql 提供 Where(sql)、GroupBy(sql)、OrderBy(sql)、ToList(sql) 等直接使用 SQL 片段的 API。</p>
<p><strong>使用这些 API 时请务必注意SQL注入安全问题。</strong></p>
<p>不建议前端直接 POST SQL 到后端使用它们，而应该在后端做一层映射，例如：</p>
<div><pre><code><span><span>var</span></span> whereMapping <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span>
<span>{</span>
    <span>[</span><span>"where1"</span><span>]</span> <span>=</span> <span>"a.id > {0}"</span><span>,</span>
    <span>[</span><span>"where2"</span><span>]</span> <span>=</span> <span>"len(a.name) > {0}"</span>
<span>}</span><span>;</span>
<span><span>var</span></span> orderByMapping <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span>
<span>{</span>
    <span>[</span><span>"order1"</span><span>]</span> <span>=</span> <span>"a.id asc, a.name desc"</span><span>,</span>
    <span>[</span><span>"order2"</span><span>]</span> <span>=</span> <span>"len(a.name) desc"</span>
<span>}</span><span>;</span>

<span>//假设前端 POST 内容是 postWhere=where1&amp;postWhereValue=100&amp;postOrder=order1</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WhereIf</span><span>(</span>
        whereMapping<span>.</span><span>TryGetValue</span><span>(</span>postWhere<span>,</span> <span>out</span> <span><span>var</span></span> whereSql<span>)</span><span>,</span> 
        <span>string</span><span>.</span><span>Format</span><span>(</span>whereSql<span>,</span> postWhereValue<span>)</span>
    <span>)</span>
    <span>.</span><span>OrderBy</span><span>(</span>
        orderByMapping<span>.</span><span>TryGetValue</span><span>(</span>postOrder<span>,</span> <span>out</span> <span><span>var</span></span> orderSql<span>)</span><span>,</span> 
        orderSql
    <span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-08-15T16:01:12.000Z</published>
  </entry>
  <entry>
    <title type="html">BaseEntity</title>
    <id>https://freesql.net/guide/freeSql-extensions-baseentity.html</id>
    <link href="https://freesql.net/guide/freeSql-extensions-baseentity.html"/>
    <updated>2022-08-11T15:34:05.000Z</updated>
    <content type="html"><![CDATA[<h2 id="前言" tabindex="-1"> 前言</h2>
<p>尝试过 <a href="http://ado.net" target="_blank" rel="noopener noreferrer">ado.net</a>、dapper、ef，以及Repository仓储，甚至自己还写过生成器工具，以便做常规CRUD操作。</p>
<p>它们日常操作不方便之处：</p>
<ul>
<li>
<p>每次使用前需要声明，再操作；</p>
</li>
<li>
<p>很多人一个实体类，对应一个操作类（或DAL、DbContext、Repository）；</p>
</li>
</ul>
<p>BaseEntity 是一种极简单的 CodeFirst 开发方式，特别对单表或多表CRUD，利用继承节省了每个实体类的重复属性（创建时间、ID等字段），软件删除等功能，进行 crud 操作时不必时常考虑仓储的使用；</p>
<p>本文介绍 BaseEntity 一种极简约的 CRUD 操作方法。</p>
<h2 id="功能特点" tabindex="-1"> 功能特点</h2>
<ul>
<li>
<p>自动迁移实体结构（CodeFirst），到数据库；</p>
</li>
<li>
<p>直接操作实体的方法，进行 CRUD 操作；</p>
</li>
<li>
<p>简化用户定义实体类型，省去主键、常用字段的配置（如CreateTime、UpdateTime）；</p>
</li>
<li>
<p>实现单表、多表查询的软删除逻辑；</p>
</li>
</ul>
<h2 id="声明" tabindex="-1"> 声明</h2>
<div><pre><code>dotnet <span>add</span> package FreeSql.Extensions.BaseEntity
dotnet <span>add</span> package FreeSql.Provider.Sqlite
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>1、定义一个主键 int 并且自增的实体类型，BaseEntity TKey 指定为 int/long 时，会认为主键是自增；</p>
<div><pre><code><span>public</span> <span>class</span> <span>UserGroup</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>UserGroup<span>,</span> <span>int</span><span>></span></span></span>
<span>{</span>
    <span>public</span> <span><span>string</span></span> GroupName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>如果不想主键是自增键，可以重写属性：</p>
<div><pre><code><span>public</span> <span>class</span> <span>UserGroup</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>UserGroup<span>,</span> <span>int</span><span>></span></span></span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>false</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>override</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> GroupName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>有关更多实体的特性配置，请参考资料：<a href="/guide/entity-attribute.html">实体特性</a></p>
</blockquote>
<p>2、定义一个主键 Guid 的实体类型，保存数据时会自动产生有序不重复的 Guid 值（不用自己指定 Guid.NewGuid()）；</p>
<div><pre><code><span>public</span> <span>class</span> <span>User</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>UserGroup<span>,</span> Guid<span>></span></span></span>
<span>{</span>
    <span>public</span> <span><span>string</span></span> UserName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="crud-使用" tabindex="-1"> CRUD 使用</h2>
<div><pre><code><span>//添加</span>
<span><span>var</span></span> item <span>=</span> <span>new</span> <span>UserGroup</span> <span>{</span> GroupName <span>=</span> <span>"组一"</span> <span>}</span><span>;</span>
item<span>.</span><span>Insert</span><span>(</span><span>)</span><span>;</span>

<span>//更新</span>
item<span>.</span>GroupName <span>=</span> <span>"组二"</span><span>;</span>
item<span>.</span><span>Update</span><span>(</span><span>)</span><span>;</span>

<span>//添加或更新</span>
item<span>.</span><span>Save</span><span>(</span><span>)</span><span>;</span>

<span>//软删除</span>
item<span>.</span><span>Delete</span><span>(</span><span>)</span><span>;</span>

<span>//恢复软删除</span>
item<span>.</span><span>Restore</span><span>(</span><span>)</span><span>;</span>

<span>//根据主键获取对象</span>
<span><span>var</span></span> item <span>=</span> UserGroup<span>.</span><span>Find</span><span>(</span><span>1</span><span>)</span><span>;</span>

<span>//查询数据</span>
<span><span>var</span></span> items <span>=</span> UserGroup<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>></span> <span>10</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>实体类型.Select 是一个查询对象，使用方法和 FreeSql.ISelect 一样；</p>
<p>支持多表查询时，软删除条件会附加在每个表中；</p>
<blockquote>
<p>有关更多查询方法，请参考资料：<a href="/guide/select.html">查询</a></p>
</blockquote>
<h2 id="事务建议" tabindex="-1"> 事务建议</h2>
<p>1、同线程事务，不支持异步：</p>
<div><pre><code>fsql<span>.</span><span>Transaction</span><span>(</span><span>(</span><span>)</span> <span>=></span>
<span>{</span>
    <span>//todo ...</span>
<span>}</span><span>)</span>
```<span>;</span>

<span>2</span>、如果你是异步控

由于 AsyncLocal 平台兼容不好，所以交给外部管理事务。

```csharp
<span>static</span> <span>AsyncLocal<span>&lt;</span>IUnitOfWork<span>></span></span> _asyncUow <span>=</span> <span>new</span> <span>AsyncLocal<span>&lt;</span>IUnitOfWork<span>></span></span><span>(</span><span>)</span><span>;</span>

BaseEntity<span>.</span><span>Initialization</span><span>(</span>fsql<span>,</span> <span>(</span><span>)</span> <span>=></span> _asyncUow<span>.</span>Value<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>在 Scoped 开始时：_asyncUow.Value = fsql.CreateUnitOfWork(); (也可以使用 UnitOfWorkManager 对象获取 uow)</p>
<p>在 Scoped 结束时：_asyncUow.Value = null;</p>
<p>如下：</p>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    _asyncUow<span>.</span>Value <span>=</span> uow<span>;</span>

    <span>try</span>
    <span>{</span>
        <span>//todo ... BaseEntity 内部 curd 方法保持使用 uow 事务</span>
    <span>}</span>
    <span>finally</span>
    <span>{</span>
        _asyncUow<span>.</span>Value <span>=</span> <span>null</span><span>;</span>
    <span>}</span>
    
    uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-08-11T15:34:05.000Z</published>
  </entry>
  <entry>
    <title type="html">JsonMap</title>
    <id>https://freesql.net/guide/freesql-extensions-jsonmap.html</id>
    <link href="https://freesql.net/guide/freesql-extensions-jsonmap.html"/>
    <updated>2022-08-11T15:34:05.000Z</updated>
    <content type="html"><![CDATA[<h1 id="jsonmap" tabindex="-1"> JsonMap</h1>
<p>FreeSql 扩展包，将值对象映射成 <code>typeof(string)</code>，安装扩展包：</p>
<div><pre><code>dotnet <span>add</span> package FreeSql.Extensions.JsonMap
</code></pre><div aria-hidden="true"><div></div></div></div><div><pre><code>fsql<span>.</span><span>UseJsonMap</span><span>(</span><span>)</span><span>;</span> <span>//开启功能</span>

<span>class</span> <span>TestConfig</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"sysconfig"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>S_SysConfig<span>&lt;</span>T<span>></span></span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>JsonMap</span></span><span>]</span>
    <span>public</span> <span>T</span> Config <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-08-11T15:34:05.000Z</published>
  </entry>
  <entry>
    <title type="html">级联删除</title>
    <id>https://freesql.net/guide/cascade-delete.html</id>
    <link href="https://freesql.net/guide/cascade-delete.html"/>
    <updated>2022-07-30T09:07:52.000Z</updated>
    <content type="html"><![CDATA[<h1 id="级联删除" tabindex="-1"> 级联删除</h1>
<h2 id="基于【对象】级联删除" tabindex="-1"> 基于【对象】级联删除</h2>
<blockquote>
<p>比如 Include/IncludeMany 查询的对象，可以使用此方法级联删除它们。</p>
</blockquote>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Group<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>true</span><span>;</span> <span>//关键设置</span>
repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>UserGroup</span>
<span>{</span>
    GroupName <span>=</span> <span>"group01"</span><span>,</span>
    Users <span>=</span> <span>new</span> <span>List<span>&lt;</span>User<span>></span></span>
    <span>{</span>
        <span>new</span> <span>User</span> <span>{</span> Username <span>=</span> <span>"admin01"</span><span>,</span> Password <span>=</span> <span>"pwd01"</span><span>,</span> UserExt <span>=</span> <span>new</span> <span>UserExt</span> <span>{</span> Remark <span>=</span> <span>"用户备注01"</span> <span>}</span> <span>}</span><span>,</span>
        <span>new</span> <span>User</span> <span>{</span> Username <span>=</span> <span>"admin02"</span><span>,</span> Password <span>=</span> <span>"pwd02"</span><span>,</span> UserExt <span>=</span> <span>new</span> <span>UserExt</span> <span>{</span> Remark <span>=</span> <span>"用户备注02"</span> <span>}</span> <span>}</span><span>,</span>
        <span>new</span> <span>User</span> <span>{</span> Username <span>=</span> <span>"admin03"</span><span>,</span> Password <span>=</span> <span>"pwd03"</span><span>,</span> UserExt <span>=</span> <span>new</span> <span>UserExt</span> <span>{</span> Remark <span>=</span> <span>"用户备注03"</span> <span>}</span> <span>}</span><span>,</span>
    <span>}</span>
<span>}</span><span>)</span><span>;</span> <span>//级联添加测试数据</span>
<span>//INSERT INTO "usergroup"("groupname") VALUES('group01') RETURNING "id"</span>
<span>//INSERT INTO "user"("username", "password", "groupid") VALUES('admin01', 'pwd01', 1), ('admin02', 'pwd02', 1), ('admin03', 'pwd03', 1) RETURNING "id" as "Id", "username" as "Username", "password" as "Password", "groupid" as "GroupId"</span>
<span>//INSERT INTO "userext"("userid", "remark") VALUES(3, '用户备注01'), (4, '用户备注02'), (5, '用户备注03')</span>

<span><span>var</span></span> groups <span>=</span> repo<span>.</span>Select
    <span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Users<span>,</span> 
        then <span>=></span> then<span>.</span><span>Include</span><span>(</span>b <span>=></span> b<span>.</span>UserExt<span>)</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>Delete</span><span>(</span>groups<span>)</span><span>;</span> <span>//级联删除，递归向下遍历 group OneToOne/OneToMany/ManyToMany 导航属性</span>
<span>//DELETE FROM "userext" WHERE ("userid" IN (3,4,5))</span>
<span>//DELETE FROM "user" WHERE ("id" IN (3,4,5))</span>
<span>//DELETE FROM "usergroup" WHERE ("id" = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="基于【数据库】级联删除" tabindex="-1"> 基于【数据库】级联删除</h2>
<blockquote>
<p>根据设置的导航属性，递归删除 OneToOne/OneToMany/ManyToMany 对应数据，并返回已删除的数据。此功能不依赖数据库外键</p>
</blockquote>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Group<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> ret <span>=</span> repo<span>.</span><span>DeleteCascadeByDatabase</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>;</span>
<span>//SELECT a."id", a."username", a."password", a."groupid" FROM "user" a WHERE (a."groupid" = 1)</span>
<span>//SELECT a."userid", a."remark" FROM "userext" a WHERE (a."userid" IN (3,4,5))</span>
<span>//DELETE FROM "userext" WHERE ("userid" IN (3,4,5))</span>
<span>//DELETE FROM "user" WHERE ("id" IN (3,4,5))</span>
<span>//DELETE FROM "usergroup" WHERE ("id" = 1)</span>

<span>//ret   Count = 7 System.Collections.Generic.List&lt;object></span>
<span>//  [0] {UserExt} object {UserExt}</span>
<span>//  [1] {UserExt} object {UserExt}</span>
<span>//  [2] {UserExt} object {UserExt}</span>
<span>//  [3] {User}     object {User}</span>
<span>//  [4] {User}     object {User}</span>
<span>//  [5] {User}   object {User}</span>
<span>//  [6] {UserGroup} object {UserGroup}</span>

<span>public</span> <span>class</span> <span>Group</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> GroupName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>User<span>.</span>GroupId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>User<span>></span></span> Users <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>User</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Username <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Password <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> GroupId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>Id<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>UserExt</span> UserExt <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>UserExt</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> UserId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Remark <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>UserId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>User</span> User <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-07-30T09:07:52.000Z</published>
  </entry>
  <entry>
    <title type="html">嵌套查询 ✨</title>
    <id>https://freesql.net/guide/withtempquery.html</id>
    <link href="https://freesql.net/guide/withtempquery.html"/>
    <updated>2022-08-30T14:50:06.000Z</updated>
    <content type="html"><![CDATA[<h1 id="嵌套查询-✨" tabindex="-1"> 嵌套查询 ✨</h1>
<h2 id="withtempquery" tabindex="-1"> WithTempQuery</h2>
<p>意见往集：<a href="https://github.com/dotnetcore/FreeSql/discussions/1192" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/discussions/1192</a></p>
<p>需求版本：v3.2.666+</p>
<p>GroupBy + WithTempQuery(嵌套查询) + FromQuery + UnionAll 组合使用，会让查询功能更加强大、灵活。</p>
<h2 id="场景1-查询分组第一条记录" tabindex="-1"> 场景1：查询分组第一条记录</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>&lt;</span> <span>1000</span><span>)</span>
    <span>.</span><span>WithTempQuery</span><span>(</span>a <span>=></span> <span>new</span>
    <span>{</span>
        item <span>=</span> a<span>,</span>
        rownum <span>=</span> SqlExt<span>.</span><span>RowNumber</span><span>(</span><span>)</span><span>.</span><span>Over</span><span>(</span><span>)</span><span>.</span><span>PartitionBy</span><span>(</span>a<span>.</span>Nickname<span>)</span><span>.</span><span>OrderBy</span><span>(</span>a<span>.</span>Id<span>)</span><span>.</span><span>ToValue</span><span>(</span><span>)</span>
    <span>}</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>rownum <span>==</span> <span>1</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：支持多表嵌套查询，fsql.Select&lt;User1, UserGroup1&gt;()</p>
</blockquote>
<div><pre><code><span>SELECT</span> <span>*</span>
<span>FROM</span> <span>(</span>
    <span>SELECT</span> a<span>.</span><span>[</span>Id<span>]</span><span>,</span> a<span>.</span><span>[</span>Nickname<span>]</span><span>,</span> row_number<span>(</span><span>)</span> <span>over</span><span>(</span> <span>partition</span> <span>by</span> a<span>.</span><span>[</span>Nickname<span>]</span> <span>order</span> <span>by</span> a<span>.</span><span>[</span>Id<span>]</span><span>)</span> <span>[</span>rownum<span>]</span>
    <span>FROM</span> <span>[</span>User1<span>]</span> a
    <span>WHERE</span> a<span>.</span><span>[</span>Id<span>]</span> <span>&lt;</span> <span>1000</span>
<span>)</span> a
<span>WHERE</span> <span>(</span>a<span>.</span><span>[</span>rownum<span>]</span> <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>如果数据库不支持开窗函数，可以使用分组嵌套查询解决：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>&lt;</span> <span>1000</span><span>)</span>
    <span>.</span><span>GroupBy</span><span>(</span>a <span>=></span> a<span>.</span>Nickname<span>)</span>
    <span>.</span><span>WithTempQuery</span><span>(</span>g <span>=></span> <span>new</span> <span>{</span> min <span>=</span> g<span>.</span><span>Min</span><span>(</span>g<span>.</span>Value<span>.</span>Id<span>)</span> <span>}</span><span>)</span>
    <span>.</span><span><span>From</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>InnerJoin</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>min <span>==</span> b<span>.</span>Id<span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> b<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> b<span>.</span><span>[</span>Id<span>]</span><span>,</span> b<span>.</span><span>[</span>Nickname<span>]</span> 
<span>FROM</span> <span>(</span> 
    <span>SELECT</span> <span>min</span><span>(</span>a<span>.</span><span>[</span>Id<span>]</span><span>)</span> <span>[</span>min<span>]</span> 
    <span>FROM</span> <span>[</span>User1<span>]</span> a 
    <span>WHERE</span> a<span>.</span><span>[</span>Id<span>]</span> <span>&lt;</span> <span>1000</span> 
    <span>GROUP</span> <span>BY</span> a<span>.</span><span>[</span>Nickname<span>]</span> <span>)</span> a 
<span>INNER</span> <span>JOIN</span> <span>[</span>User1<span>]</span> b <span>ON</span> a<span>.</span><span>[</span>min<span>]</span> <span>=</span> b<span>.</span><span>[</span>Id<span>]</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="场景2-嵌套查询-join" tabindex="-1"> 场景2：嵌套查询 + Join</h2>
<p>WithTempQuery + From&lt;T2&gt; 或 FromQuery(ISelect&lt;T2&gt;) 可实现无限联表</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>&lt;</span> <span>1000</span><span>)</span>
    <span>.</span><span>WithTempQuery</span><span>(</span>a <span>=></span> <span>new</span>
    <span>{</span>
        item <span>=</span> a<span>,</span>
        rownum <span>=</span> SqlExt<span>.</span><span>RowNumber</span><span>(</span><span>)</span><span>.</span><span>Over</span><span>(</span><span>)</span><span>.</span><span>PartitionBy</span><span>(</span>a<span>.</span>Nickname<span>)</span><span>.</span><span>OrderBy</span><span>(</span>a<span>.</span>Id<span>)</span><span>.</span><span>ToValue</span><span>(</span><span>)</span>
    <span>}</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>rownum <span>==</span> <span>1</span><span>)</span>
    <span>//.From&lt;UserExt>() //普通联表</span>
    <span>.</span><span>FromQuery</span><span>(</span>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>UserExt<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Id <span>></span> <span>0</span><span>)</span><span>)</span> <span>//子查询联表</span>
    <span>//.FromQuery(fsql.Select&lt;UserExt, UserGroup, xxx>() //子多表查询联表</span>
    <span>//    .WithTempQuery((a,b,c) => new { ... }))</span>
    <span>.</span><span>InnerJoin</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>item<span>.</span>Id <span>==</span> b<span>.</span>UserId<span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span>
    <span>{</span>
        user <span>=</span> a<span>.</span>item<span>,</span>
        rownum <span>=</span> a<span>.</span>rownum<span>,</span>
        userext <span>=</span> b
    <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span> 
<span>FROM</span> <span>(</span> 
    <span>SELECT</span> a<span>.</span><span>[</span>Id<span>]</span><span>,</span> a<span>.</span><span>[</span>Nickname<span>]</span><span>,</span> row_number<span>(</span><span>)</span> <span>over</span><span>(</span> <span>partition</span> <span>by</span> a<span>.</span><span>[</span>Nickname<span>]</span> <span>order</span> <span>by</span> a<span>.</span><span>[</span>Id<span>]</span><span>)</span> <span>[</span>rownum<span>]</span> 
    <span>FROM</span> <span>[</span>User1<span>]</span> a <span>)</span> a 
<span>INNER</span> <span>JOIN</span> <span>(</span> 
    <span>SELECT</span> a<span>.</span><span>[</span>UserId<span>]</span><span>,</span> a<span>.</span><span>[</span>Remark<span>]</span> 
    <span>FROM</span> <span>[</span>TwoTablePartitionBy_UserExt<span>]</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>[</span>UserId<span>]</span> <span>></span> <span>0</span><span>)</span> <span>)</span> b <span>ON</span> a<span>.</span><span>[</span>Id<span>]</span> <span>=</span> b<span>.</span><span>[</span>UserId<span>]</span> 
<span>WHERE</span> <span>(</span>a<span>.</span><span>[</span>rownum<span>]</span> <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="场景3-分组查询嵌套" tabindex="-1"> 场景3：分组查询嵌套</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithTempQuery</span><span>(</span>a <span>=></span> <span>new</span>
    <span>{</span>
        user <span>=</span> a<span>,</span>
        rownum <span>=</span> SqlExt<span>.</span><span>RowNumber</span><span>(</span><span>)</span><span>.</span><span>Over</span><span>(</span><span>)</span><span>.</span><span>PartitionBy</span><span>(</span>a<span>.</span>Nickname<span>)</span><span>.</span><span>OrderBy</span><span>(</span>a<span>.</span>Id<span>)</span><span>.</span><span>ToValue</span><span>(</span><span>)</span>
    <span>}</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>rownum <span>==</span> <span>1</span><span>)</span>
    <span>.</span><span>FromQuery</span><span>(</span>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>UserExt<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>UserId <span>></span> <span>0</span><span>)</span>
        <span>.</span><span>GroupBy</span><span>(</span>b <span>=></span> <span>new</span> <span>{</span> b<span>.</span>UserId<span>,</span> b<span>.</span>Remark <span>}</span><span>)</span>
        <span>.</span><span>WithTempQuery</span><span>(</span>b <span>=></span> <span>new</span> <span>{</span> b<span>.</span>Key<span>,</span> sum1 <span>=</span> b<span>.</span><span>Sum</span><span>(</span>b<span>.</span>Value<span>.</span>UserId<span>)</span> <span>}</span><span>)</span><span>)</span>
    <span>.</span><span>InnerJoin</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>user<span>.</span>Id <span>==</span> b<span>.</span>Key<span>.</span>UserId<span>)</span>
    <span>.</span><span>Where</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>user<span>.</span>Nickname <span>==</span> <span>"name03"</span> <span>||</span> a<span>.</span>user<span>.</span>Nickname <span>==</span> <span>"name02"</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span>
    <span>{</span>
        user <span>=</span> a<span>.</span>user<span>,</span>
        rownum <span>=</span> a<span>.</span>rownum<span>,</span>
        groupby <span>=</span> b
    <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span> 
<span>FROM</span> <span>(</span> 
    <span>SELECT</span> a<span>.</span><span>[</span>Id<span>]</span><span>,</span> a<span>.</span><span>[</span>Nickname<span>]</span><span>,</span> row_number<span>(</span><span>)</span> <span>over</span><span>(</span> <span>partition</span> <span>by</span> a<span>.</span><span>[</span>Nickname<span>]</span> <span>order</span> <span>by</span> a<span>.</span><span>[</span>Id<span>]</span><span>)</span> <span>[</span>rownum<span>]</span> 
    <span>FROM</span> <span>[</span><span>User</span><span>]</span> a <span>)</span> a 
<span>INNER</span> <span>JOIN</span> <span>(</span> 
    <span>SELECT</span> a<span>.</span><span>[</span>UserId<span>]</span><span>,</span> a<span>.</span><span>[</span>Remark<span>]</span><span>,</span> <span>sum</span><span>(</span>a<span>.</span><span>[</span>UserId<span>]</span><span>)</span> <span>[</span>rownum<span>]</span> 
    <span>FROM</span> <span>[</span>UserExt<span>]</span> a 
    <span>WHERE</span> <span>(</span>a<span>.</span><span>[</span>UserId<span>]</span> <span>></span> <span>0</span><span>)</span> 
    <span>GROUP</span> <span>BY</span> a<span>.</span><span>[</span>UserId<span>]</span><span>,</span> a<span>.</span><span>[</span>Remark<span>]</span> <span>)</span> b <span>ON</span> a<span>.</span><span>[</span>Id<span>]</span> <span>=</span> b<span>.</span><span>[</span>UserId<span>]</span> 
<span>WHERE</span> <span>(</span>a<span>.</span><span>[</span>rownum<span>]</span> <span>=</span> <span>1</span><span>)</span> <span>AND</span> <span>(</span><span>(</span>a<span>.</span><span>[</span>Nickname<span>]</span> <span>=</span> N<span>'name03'</span> <span>OR</span> a<span>.</span><span>[</span>Nickname<span>]</span> <span>=</span> N<span>'name02'</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="场景4-内存数据嵌套" tabindex="-1"> 场景4：内存数据嵌套</h2>
<p>假设跨数据库服务器，或者数据表被缓存过，WithMemory 便可以实现数据表与内存关联查询。</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> <span>new</span> <span>List<span>&lt;</span>User1<span>></span></span><span>(</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>User1</span> <span>{</span> Id <span>=</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>User1</span> <span>{</span> Id <span>=</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>User1</span> <span>{</span> Id <span>=</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span> <span>}</span><span>)</span><span>;</span>

<span><span>var</span></span> listSql2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>UserGroup<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>FromQuery</span><span>(</span>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>WithMemory</span><span>(</span>list<span>)</span><span>)</span>
    <span>.</span><span>InnerJoin</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> a<span>.</span>Id <span>==</span> b<span>.</span>GroupId<span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span>
<span>FROM</span> <span>[</span>UserGroup<span>]</span> a
<span>INNER</span> <span>JOIN</span> <span>(</span>
    <span>SELECT</span> <span>.</span><span>.</span><span>.</span>
    <span>UNION</span> <span>ALL</span>
    <span>SELECT</span> <span>.</span><span>.</span><span>.</span>
    <span>UNION</span> <span>ALL</span>
    <span>SELECT</span> <span>.</span><span>.</span><span>.</span>
<span>)</span> b <span>ON</span> a<span>.</span><span>[</span>Id<span>]</span> <span>=</span> b<span>.</span><span>[</span>GroupId<span>]</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="子表exists" tabindex="-1"> 子表Exists</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>As</span><span>(</span><span>"b"</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Id <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.[Id], a.[Title], a.[Clicks], a.[CreateTime], a.[CategoryId]</span>
<span>//FROM [Topic] a</span>
<span>//WHERE (exists(SELECT 1</span>
<span>//    FROM [Topic] b</span>
<span>//    WHERE (b.[Id] = a.[Id])</span>
<span>//    limit 0,1))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：由于子查询的实体类与上层相同，使用 As(&quot;b&quot;) 指明别名，以便区分</p>
</blockquote>
<h2 id="子表in" tabindex="-1"> 子表In</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>As</span><span>(</span><span>"b"</span><span>)</span><span>.</span><span>ToList</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.[Id], a.[Title], a.[Clicks], a.[CreateTime], a.[CategoryId]</span>
<span>//FROM [Topic] a</span>
<span>//WHERE (((a.[Id]) in (SELECT b.[Id]</span>
<span>//    FROM [Topic] b)))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="子表join" tabindex="-1"> 子表Join</h2>
<p>v1.8.0+ string.Join + ToList 实现将子查询的多行结果，拼接为一个字符串，如：&quot;1,2,3,4&quot;</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
  id <span>=</span> a<span>.</span>Id<span>,</span>
  concat <span>=</span> <span>string</span><span>.</span><span>Join</span><span>(</span><span>","</span><span>,</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>StringJoin01<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
<span>//SELECT a.[Id], (SELECT group_concat(b.[Id] separator ',') </span>
<span>//    FROM [StringJoin01] b) </span>
<span>//FROM [Topic] a</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="子表first-count-sum-max-min-avg" tabindex="-1"> 子表First/Count/Sum/Max/Min/Avg</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Category<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span>  <span>{</span>
  all <span>=</span> a<span>,</span>
  first <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>First</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
  count <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>
  sum <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Sum</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  max <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Max</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  min <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Min</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  avg <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Avg</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="tosql-withsql" tabindex="-1"> ToSql + WithSql</h2>
<p>这是早期提供的嵌套查询方法</p>
<div><pre><code><span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>&lt;</span> <span>1000</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> <span>new</span>
    <span>{</span>
        item <span>=</span> a<span>,</span>
        rownum <span>=</span> SqlExt<span>.</span><span>RowNumber</span><span>(</span><span>)</span><span>.</span><span>Over</span><span>(</span><span>)</span><span>.</span><span>PartitionBy</span><span>(</span>a<span>.</span>Nickname<span>)</span><span>.</span><span>OrderBy</span><span>(</span>a<span>.</span>Id<span>)</span><span>.</span><span>ToValue</span><span>(</span><span>)</span>
    <span>}</span><span>,</span> FieldAliasOptions<span>.</span>AsProperty<span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span>sql<span>)</span>
    <span>.</span><span>Where</span><span>(</span><span>"a.rownum = 1"</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> a<span>.</span><span>[</span>Id<span>]</span><span>,</span> a<span>.</span><span>[</span>Nickname<span>]</span> 
<span>FROM</span> <span>(</span>
    <span>SELECT</span> a<span>.</span><span>[</span>Id<span>]</span><span>,</span> a<span>.</span><span>[</span>Nickname<span>]</span><span>,</span> row_number<span>(</span><span>)</span> <span>over</span><span>(</span> <span>partition</span> <span>by</span> a<span>.</span><span>[</span>Nickname<span>]</span> <span>order</span> <span>by</span> a<span>.</span><span>[</span>Id<span>]</span><span>)</span> <span>[</span>rownum<span>]</span>
    <span>FROM</span> <span>[</span>User1<span>]</span> a
    <span>WHERE</span> a<span>.</span><span>[</span>Id<span>]</span> <span>&lt;</span> <span>1000</span>
<span>)</span> a
<span>WHERE</span> <span>(</span>a<span>.</span>rownum <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-07-23T05:30:46.000Z</published>
  </entry>
  <entry>
    <title type="html">Castle AOP + FreeSql 跨方法异步事务</title>
    <id>https://freesql.net/extra/aop-freesql-autofac.html</id>
    <link href="https://freesql.net/extra/aop-freesql-autofac.html"/>
    <updated>2022-08-22T13:12:57.000Z</updated>
    <content type="html"><![CDATA[<h1 id="castle-aop-freesql-跨方法异步事务" tabindex="-1"> Castle AOP + FreeSql 跨方法异步事务</h1>
<p>使用Autofac基于特性标签，实现跨方法的异步事务处理</p>
<ul>
<li>Autofac.Extensions.DependencyInjection</li>
<li>Autofac.Extras.DynamicProxy</li>
<li>Castle.Core.AsyncInterceptor(异步方法AOP拦截)</li>
</ul>
<h2 id="freesql基础服务" tabindex="-1"> FreeSql基础服务</h2>
<h3 id="安装freesql包" tabindex="-1"> 安装FreeSql包</h3>
<div><pre><code>dotnet <span>add</span> package FreeSql
dotnet <span>add</span> package FreeSql.DbContext
dotnet <span>add</span> package FreeSql.Provider.MySqlConnector
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>手动创建一个MySql/MariaDB数据库,名为<code>ovov_freesql_repository</code></p>
<h3 id="appsettings-json" tabindex="-1"> appsettings.json</h3>
<div><pre><code><span>{</span>
  <span>"Default"</span><span>:</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=ovov_freesql_repository;Charset=utf8;SslMode=none;Max pool size=10"</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h3 id="配置freesql服务" tabindex="-1"> 配置FreeSql服务</h3>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
  <span>IConfigurationSection</span> Default  <span>=</span> Configuration<span>.</span><span>GetSection</span><span>(</span><span>"Default"</span><span>)</span><span>;</span>
  <span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
            <span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>MySql<span>,</span> Default<span>.</span>Value<span>)</span>
            <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
            <span>.</span><span>UseNameConvert</span><span>(</span>NameConvertType<span>.</span>PascalCaseToUnderscoreWithLower<span>)</span>
            <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Trace<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
            <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
    services<span>.</span><span><span>AddScoped</span><span><span>&lt;</span>UnitOfWorkManager<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    services<span>.</span><span>AddFreeRepository</span><span>(</span><span>null</span><span>,</span> <span>typeof</span><span>(</span><span>Startup</span><span>)</span><span>.</span>Assembly<span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="autofac-aop实现异步事务" tabindex="-1"> Autofac+AOP实现异步事务</h2>
<ul>
<li><a href="https://github.com/luoyunchong/dotnetcore-examples/blob/master/ORM/FreeSql/OvOv.FreeSql.AutoFac.DynamicProxy" target="_blank" rel="noopener noreferrer">OvOv.FreeSql.AutoFac.DynamicProxy</a></li>
</ul>
<p>csproj</p>
<div><pre><code>&lt;PackageReference Include=&quot;Autofac.Extensions.DependencyInjection&quot; Version=&quot;6.0.0&quot; /&gt;
&lt;PackageReference Include=&quot;Autofac.Extras.DynamicProxy&quot; Version=&quot;5.0.0&quot; /&gt;
&lt;PackageReference Include=&quot;Castle.Core.AsyncInterceptor&quot; Version=&quot;1.7.0&quot; /&gt;
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>或</p>
<div><pre><code>dotnet <span>add</span> package Autofac.Extensions.DependencyInjection
dotnet <span>add</span> package Autofac.Extras.DynamicProxy
dotnet <span>add</span> package Castle.Core.AsyncInterceptor
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>创建一个标识事务的特性标签</p>
<div><pre><code><span>[</span><span><span>AttributeUsage</span><span><span>(</span>AttributeTargets<span>.</span>Method<span>,</span> Inherited <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>TransactionalAttribute</span> <span>:</span> <span><span>Attribute</span></span>
<span>{</span>
    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 事务传播方式</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>public</span> <span>Propagation</span> Propagation <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> Propagation<span>.</span>Required<span>;</span>

    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 事务隔离级别</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>public</span> <span>IsolationLevel<span>?</span></span> IsolationLevel <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>TransactionalAttribute</span><span>(</span><span>)</span><span>{</span><span>}</span>

    <span>public</span> <span>TransactionalAttribute</span><span>(</span><span>Propagation</span> propagation<span>,</span> <span>IsolationLevel</span> isolationLevel<span>)</span>
    <span>{</span>
        Propagation <span>=</span> propagation<span>;</span>
        IsolationLevel <span>=</span> isolationLevel<span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="autofac集成" tabindex="-1"> Autofac集成</h2>
<p>Program.CS  替换默认的DI CreateHostBuilder方法</p>
<div><pre><code> Host<span>.</span><span>CreateDefaultBuilder</span><span>(</span>args<span>)</span><span>.</span><span>UseServiceProviderFactory</span><span>(</span><span>new</span> <span>AutofacServiceProviderFactory</span><span>(</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>Startup.cs配置服务</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureContainer</span><span>(</span><span>ContainerBuilder</span> builder<span>)</span>
<span>{</span>
    builder<span>.</span><span>RegisterModule</span><span>(</span><span>new</span> <span>AutofacModule</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>.NET6 这样注册</p>
</blockquote>
<div><pre><code>builder<span>.</span>Host
    <span>.</span><span>UseServiceProviderFactory</span><span>(</span><span>new</span> <span>AutofacServiceProviderFactory</span><span>(</span><span>)</span><span>)</span>
    <span>.</span><span><span>ConfigureContainer</span><span><span>&lt;</span>ContainerBuilder<span>></span></span></span><span>(</span><span>(</span>webBuilder<span>,</span> containerBuilder<span>)</span> <span>=></span>
    <span>{</span>
          containerBuilder<span>.</span><span>RegisterModule</span><span>(</span><span>new</span> <span>AutofacModule</span><span>(</span><span>)</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>这里给BlogService方法注入UnitOfWorkInterceptor拦截处理。直接注入类。</p>
<div><pre><code><span>public</span> <span>class</span> <span>AutofacModule</span> <span>:</span> <span><span>Autofac<span>.</span>Module</span></span>
<span>{</span>
    <span>protected</span> <span>override</span> <span><span>void</span></span> <span>Load</span><span>(</span><span>ContainerBuilder</span> builder<span>)</span>
    <span>{</span>
        builder<span>.</span><span><span>RegisterType</span><span><span>&lt;</span>UnitOfWorkInterceptor<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        builder<span>.</span><span><span>RegisterType</span><span><span>&lt;</span>UnitOfWorkAsyncInterceptor<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        
        builder<span>.</span><span><span>RegisterType</span><span><span>&lt;</span>BlogService<span>></span></span></span><span>(</span><span>)</span>
            <span>.</span><span>InterceptedBy</span><span>(</span><span>typeof</span><span>(</span><span>UnitOfWorkInterceptor</span><span>)</span><span>)</span>
            <span>.</span><span>EnableClassInterceptors</span><span>(</span><span>)</span><span>;</span>
            
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="aop" tabindex="-1"> AOP</h2>
<div><pre><code>    <span>public</span> <span>class</span> <span>UnitOfWorkInterceptor</span> <span>:</span> <span><span>IInterceptor</span></span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>UnitOfWorkAsyncInterceptor</span> asyncInterceptor<span>;</span>

        <span>public</span> <span>UnitOfWorkInterceptor</span><span>(</span><span>UnitOfWorkAsyncInterceptor</span> interceptor<span>)</span>
        <span>{</span>
            asyncInterceptor <span>=</span> interceptor<span>;</span>
        <span>}</span>

        <span>public</span> <span><span>void</span></span> <span>Intercept</span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            asyncInterceptor<span>.</span><span>ToInterceptor</span><span>(</span><span>)</span><span>.</span><span>Intercept</span><span>(</span>invocation<span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>

    <span>public</span> <span>class</span> <span>UnitOfWorkAsyncInterceptor</span> <span>:</span> <span><span>IAsyncInterceptor</span></span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>UnitOfWorkManager</span> _unitOfWorkManager<span>;</span>
        <span>private</span> <span>readonly</span> <span>ILogger<span>&lt;</span>UnitOfWorkAsyncInterceptor<span>></span></span> _logger<span>;</span>
        <span>IUnitOfWork</span> _unitOfWork<span>;</span>

        <span>public</span> <span>UnitOfWorkAsyncInterceptor</span><span>(</span><span>UnitOfWorkManager</span> unitOfWorkManager<span>,</span> <span>ILogger<span>&lt;</span>UnitOfWorkAsyncInterceptor<span>></span></span> logger<span>)</span>
        <span>{</span>
            _unitOfWorkManager <span>=</span> unitOfWorkManager<span>;</span>
            _logger <span>=</span> logger<span>;</span>
        <span>}</span>

        <span>private</span> <span><span>bool</span></span> <span>TryBegin</span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            <span><span>var</span></span> method <span>=</span> invocation<span>.</span>MethodInvocationTarget <span>??</span> invocation<span>.</span>Method<span>;</span>
            <span><span>var</span></span> attribute <span>=</span> method<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>TransactionalAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span><span>;</span>
            <span>if</span> <span>(</span>attribute <span>is</span> <span>TransactionalAttribute</span> transaction<span>)</span>
            <span>{</span>
                _unitOfWork <span>=</span> _unitOfWorkManager<span>.</span><span>Begin</span><span>(</span>transaction<span>.</span>Propagation<span>,</span> transaction<span>.</span>IsolationLevel<span>)</span><span>;</span>
                <span>return</span> <span>true</span><span>;</span>
            <span>}</span>

            <span>return</span> <span>false</span><span>;</span>
        <span>}</span>

        <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
        <span>/// 拦截同步执行的方法</span>
        <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
        <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>invocation<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
        <span>public</span> <span><span>void</span></span> <span>InterceptSynchronous</span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            <span>if</span> <span>(</span><span>TryBegin</span><span>(</span>invocation<span>)</span><span>)</span>
            <span>{</span>
                <span>try</span>
                <span>{</span>
                    invocation<span>.</span><span>Proceed</span><span>(</span><span>)</span><span>;</span>
                    _unitOfWork<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
                <span>}</span>
                <span>catch</span>
                <span>{</span>
                    _unitOfWork<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
                    <span>throw</span><span>;</span>
                <span>}</span>
                <span>finally</span>
                <span>{</span>
                    _unitOfWork<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
                <span>}</span>
            <span>}</span>
            <span>else</span>
            <span>{</span>
                invocation<span>.</span><span>Proceed</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>

        <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
        <span>/// 拦截返回结果为Task的方法</span>
        <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
        <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>invocation<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
        <span>public</span> <span><span>void</span></span> <span>InterceptAsynchronous</span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            <span>if</span> <span>(</span><span>TryBegin</span><span>(</span>invocation<span>)</span><span>)</span>
            <span>{</span>
                invocation<span>.</span>ReturnValue <span>=</span> <span>InternalInterceptAsynchronous</span><span>(</span>invocation<span>)</span><span>;</span>
            <span>}</span>
            <span>else</span>
            <span>{</span>
                invocation<span>.</span><span>Proceed</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>

        <span>private</span> <span>async</span> <span>Task</span> <span>InternalInterceptAsynchronous</span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            <span>try</span>
            <span>{</span>
                invocation<span>.</span><span>Proceed</span><span>(</span><span>)</span><span>;</span>
                <span>if</span> <span>(</span>invocation<span>.</span>ReturnValue <span>!=</span> <span>null</span><span>)</span>
                <span>{</span>
                    <span>await</span> <span>(</span>Task<span>)</span>invocation<span>.</span>ReturnValue<span>;</span>
                <span>}</span>
                _unitOfWork<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
            <span>catch</span> <span>(</span><span>System<span>.</span>Exception</span><span>)</span>
            <span>{</span>
                _unitOfWork<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
                <span>throw</span><span>;</span>
            <span>}</span>
            <span>finally</span>
            <span>{</span>
                _unitOfWork<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>


        <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
        <span>/// 拦截返回结果为Task<span><span><span>&lt;</span>TResult</span><span>></span></span>的方法</span>
        <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
        <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>invocation<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
        <span>/// <span><span><span>&lt;</span>typeparam</span> <span>name</span><span><span>=</span><span>"</span>TResult<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>typeparam</span><span>></span></span></span>
        <span>public</span> <span><span>void</span></span> <span><span>InterceptAsynchronous</span><span><span>&lt;</span>TResult<span>></span></span></span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            invocation<span>.</span>ReturnValue <span>=</span> <span><span>InternalInterceptAsynchronous</span><span><span>&lt;</span>TResult<span>></span></span></span><span>(</span>invocation<span>)</span><span>;</span>
        <span>}</span>

        <span>private</span> <span>async</span> <span>Task<span>&lt;</span>TResult<span>></span></span> <span><span>InternalInterceptAsynchronous</span><span><span>&lt;</span>TResult<span>></span></span></span><span>(</span><span>IInvocation</span> invocation<span>)</span>
        <span>{</span>
            <span>TResult</span> result<span>;</span>
            <span>if</span> <span>(</span><span>TryBegin</span><span>(</span>invocation<span>)</span><span>)</span>
            <span>{</span>
                <span>try</span>
                <span>{</span>
                    invocation<span>.</span><span>Proceed</span><span>(</span><span>)</span><span>;</span>
                    result <span>=</span> <span>await</span> <span>(</span>Task<span>&lt;</span>TResult<span>></span><span>)</span>invocation<span>.</span>ReturnValue<span>;</span>
                    _unitOfWork<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
                <span>}</span>
                <span>catch</span> <span>(</span><span>System<span>.</span>Exception</span><span>)</span>
                <span>{</span>
                    _unitOfWork<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
                    <span>throw</span><span>;</span>
                <span>}</span>
                <span>finally</span>
                <span>{</span>
                    _unitOfWork<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
                <span>}</span>
            <span>}</span>
            <span>else</span>
            <span>{</span>
                invocation<span>.</span><span>Proceed</span><span>(</span><span>)</span><span>;</span>
                result <span>=</span> <span>await</span> <span>(</span>Task<span>&lt;</span>TResult<span>></span><span>)</span>invocation<span>.</span>ReturnValue<span>;</span>
            <span>}</span>
            <span>return</span> result<span>;</span>
        <span>}</span>
    <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>当Service层没有接口，则必须使用virtual虚方法。</p>
<div><pre><code>    <span>public</span> <span>class</span> <span>BlogService</span>
    <span>{</span>
        <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
        <span>/// 当出现异常时，不会插入数据</span>
        <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
        <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>createBlogDto<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
        <span>[</span>Transactional<span>]</span>
        <span>public</span> <span>virtual</span> <span><span>void</span></span> <span>CreateBlogTransactional</span><span>(</span><span>CreateBlogDto</span> createBlogDto<span>)</span>
        <span>{</span>
            <span>Blog</span> blog <span>=</span> _mapper<span>.</span><span><span>Map</span><span><span>&lt;</span>Blog<span>></span></span></span><span>(</span>createBlogDto<span>)</span><span>;</span>
            blog<span>.</span>CreateTime <span>=</span> DateTime<span>.</span>Now<span>;</span>
            _blogRepository<span>.</span><span>Insert</span><span>(</span>blog<span>)</span><span>;</span>

            <span>List<span>&lt;</span>Tag<span>></span></span> tags <span>=</span> <span>new</span> <span>List<span>&lt;</span>Tag<span>></span></span><span>(</span><span>)</span><span>;</span>
            createBlogDto<span>.</span>Tags<span>.</span><span>ForEach</span><span>(</span>r <span>=></span>
            <span>{</span>
                tags<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Tag</span> <span>{</span> TagName <span>=</span> r <span>}</span><span>)</span><span>;</span>
            <span>}</span><span>)</span><span>;</span>
            <span>if</span> <span>(</span>createBlogDto<span>.</span>Title <span>==</span> <span>"abc"</span><span>)</span>
            <span>{</span>
                <span>throw</span> <span>new</span> <span>Exception</span><span>(</span><span>"test exception"</span><span>)</span><span>;</span>
            <span>}</span>
            _tagRepository<span>.</span><span>Insert</span><span>(</span>tags<span>)</span><span>;</span>
        <span>}</span>
    <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li><a href="https://github.com/luoyunchong/dotnetcore-examples/blob/4f4c908dc40e4c0b96ad92ad5437d071a43162cb/ORM/FreeSql/OvOv.FreeSql.AutoFac.DynamicProxy/Services/BlogService.cs#L65" target="_blank" rel="noopener noreferrer">BlogService.cs#L65</a></li>
</ul>
<p>当传入的参数，title为abc时，会出现异常，<code>throw new Exception(&quot;test exception&quot;);</code>,前面插入的数据并没有成功，会自动回滚。</p>
<h2 id="autofac批量注册" tabindex="-1"> Autofac批量注册</h2>
<ul>
<li>Autofac支持批量注入以Service后缀的接口。该方法在lin-cms-dotnetcore项目中有使用<a href="https://github.com/luoyunchong/lin-cms-dotnetcore/blob/master/src/LinCms.Web/Startup/Configuration/ServiceModule.cs" target="_blank" rel="noopener noreferrer">LinCms.Web/Startup/Configuration/ServiceModule.cs</a></li>
</ul>
<div><pre><code><span>public</span> <span>class</span> <span>ServiceModule</span> <span>:</span> <span><span>Autofac<span>.</span>Module</span></span>
<span>{</span>
    <span>protected</span> <span>override</span> <span><span>void</span></span> <span>Load</span><span>(</span><span>ContainerBuilder</span> builder<span>)</span>
    <span>{</span>
        builder<span>.</span><span><span>RegisterType</span><span><span>&lt;</span>UnitOfWorkInterceptor<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        builder<span>.</span><span><span>RegisterType</span><span><span>&lt;</span>UnitOfWorkAsyncInterceptor<span>></span></span></span><span>(</span><span>)</span><span>;</span>

        <span>List<span>&lt;</span>Type<span>></span></span> interceptorServiceTypes <span>=</span> <span>new</span> <span>List<span>&lt;</span>Type<span>></span></span><span>(</span><span>)</span>
        <span>{</span>
            <span>typeof</span><span>(</span><span>UnitOfWorkInterceptor</span><span>)</span>
        <span>}</span><span>;</span>  
        <span>//service所在dll，LinCms.Application为程序集名称，也可以通过typeof(程序集中的某个类即可).Assembly获取</span>
        <span>Assembly</span> servicesDllFile <span>=</span> Assembly<span>.</span><span>Load</span><span>(</span><span>"LinCms.Application"</span><span>)</span><span>;</span>
        
        builder<span>.</span><span>RegisterAssemblyTypes</span><span>(</span>servicesDllFile<span>)</span>
                <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name<span>.</span><span>EndsWith</span><span>(</span><span>"Service"</span><span>)</span> <span>&amp;&amp;</span> <span>!</span>a<span>.</span>IsAbstract <span>&amp;&amp;</span> <span>!</span>a<span>.</span>IsInterface <span>&amp;&amp;</span> a<span>.</span>IsPublic<span>)</span>
                <span>.</span><span>AsImplementedInterfaces</span><span>(</span><span>)</span>
                <span>.</span><span>InstancePerLifetimeScope</span><span>(</span><span>)</span>
                <span>.</span><span>PropertiesAutowired</span><span>(</span><span>)</span><span>// 属性注入</span>
                <span>.</span><span>InterceptedBy</span><span>(</span>interceptorServiceTypes<span>.</span><span>ToArray</span><span>(</span><span>)</span><span>)</span>
                <span>.</span><span>EnableInterfaceInterceptors</span><span>(</span><span>)</span><span>;</span> 
     <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>当我们使用Autofac批量注册服务后，可以直接使用Service层的接口，不需要再使用注入。</p>
<div><pre><code><span>public</span> <span>interface</span> <span>IBlogService</span>
<span>{</span>
  <span>Task</span> <span>CreateBlogTransactionalAsync</span><span>(</span><span>CreateBlogDto</span> createBlogDto<span>)</span><span>;</span>
<span>}</span>

<span>public</span> <span>class</span> <span>BlogService</span><span>:</span><span><span>IBlogService</span></span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>IBlogRepository</span> _blogRepository<span>;</span>
    <span>private</span> <span>readonly</span> <span>ITagRepository</span> _tagRepository<span>;</span>
    <span>private</span> <span>readonly</span> <span>IMapper</span> _mapper<span>;</span>

    <span>public</span> <span>BlogService</span><span>(</span><span>IBlogRepository</span> blogRepository<span>,</span> <span>ITagRepository</span> tagRepository<span>,</span> <span>IMapper</span> mapper<span>)</span>
    <span>{</span>
        _blogRepository <span>=</span> blogRepository <span>??</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>blogRepository<span>)</span><span>)</span><span>;</span>
        _tagRepository <span>=</span> tagRepository <span>??</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>tagRepository<span>)</span><span>)</span><span>;</span>
        _mapper <span>=</span> mapper <span>??</span> <span>throw</span> <span>new</span> <span>ArgumentNullException</span><span>(</span><span>nameof</span><span>(</span>mapper<span>)</span><span>)</span><span>;</span>
    <span>}</span>
    <span>[</span><span><span>Transactional</span></span><span>]</span>
    <span>public</span> <span>virtual</span> <span>async</span> <span>Task</span> <span>CreateBlogTransactionalAsync</span><span>(</span><span>CreateBlogDto</span> createBlogDto<span>)</span>
    <span>{</span>
        <span>Blog</span> blog <span>=</span> _mapper<span>.</span><span><span>Map</span><span><span>&lt;</span>Blog<span>></span></span></span><span>(</span>createBlogDto<span>)</span><span>;</span>
        blog<span>.</span>CreateTime <span>=</span> DateTime<span>.</span>Now<span>;</span>
        <span>await</span> _blogRepository<span>.</span><span>InsertAsync</span><span>(</span>blog<span>)</span><span>;</span>

        <span>List<span>&lt;</span>Tag<span>></span></span> tags <span>=</span> <span>new</span> <span>List<span>&lt;</span>Tag<span>></span></span><span>(</span><span>)</span><span>;</span>
        createBlogDto<span>.</span>Tags<span>.</span><span>ForEach</span><span>(</span>r <span>=></span>
        <span>{</span>
            tags<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Tag</span> <span>{</span> TagName <span>=</span> r <span>}</span><span>)</span><span>;</span>
        <span>}</span><span>)</span><span>;</span>
        <span>if</span> <span>(</span>createBlogDto<span>.</span>Title <span>==</span> <span>"abc"</span><span>)</span>
        <span>{</span>
            <span>throw</span> <span>new</span> <span>Exception</span><span>(</span><span>"test exception CreateBlogTransactionalAsync"</span><span>)</span><span>;</span>
        <span>}</span>
        <span>await</span> _tagRepository<span>.</span><span>InsertAsync</span><span>(</span>tags<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>使用</li>
</ul>
<div><pre><code><span>[</span><span><span>Route</span><span><span>(</span><span>"api/[controller]"</span><span>)</span></span></span><span>]</span>
<span>[</span><span><span>ApiController</span></span><span>]</span>
<span>public</span> <span>class</span> <span>BlogController</span> <span>:</span> <span><span>ControllerBase</span></span>
<span>{</span>
    <span>private</span> <span>readonly</span> <span>IBlogService</span> _blogService<span>;</span>
    <span>public</span> <span>BlogController</span><span>(</span><span>IBlogService</span> blogService<span>)</span>
    <span>{</span>
        _blogService<span>=</span>blogService<span>;</span>
    <span>}</span>

    <span>[</span><span><span>HttpPost</span><span><span>(</span><span>"CreateBlogTransactionalAsync"</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>async</span> <span>Task</span> <span>CreateBlogTransactionalAsync</span><span>(</span><span>[</span><span><span>FromBody</span></span><span>]</span> <span>CreateBlogDto</span> createBlogDto<span>)</span>
    <span>{</span>
        <span>await</span> _blogService<span>.</span><span>CreateBlogTransactionalAsync</span><span>(</span>createBlogDto<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-07-18T15:41:00.000Z</published>
  </entry>
  <entry>
    <title type="html">国产数据库</title>
    <id>https://freesql.net/guide/freesql-provider-custom.html</id>
    <link href="https://freesql.net/guide/freesql-provider-custom.html"/>
    <updated>2022-09-08T16:07:38.000Z</updated>
    <content type="html"><![CDATA[<h1 id="国产数据库" tabindex="-1"> 国产数据库</h1>
<table>
<thead>
<tr>
<th>数据库名称</th>
<th>提供者</th>
<th>系列风格</th>
</tr>
</thead>
<tbody>
<tr>
<td>达梦</td>
<td>FreeSql.Provider.Dameng</td>
<td>Oracle</td>
</tr>
<tr>
<td>神州通用</td>
<td>FreeSql.Provider.ShenTong</td>
<td>PostgreSQL</td>
</tr>
<tr>
<td>人大金仓</td>
<td>FreeSql.Provider.KingbaseES</td>
<td>PostgreSQL</td>
</tr>
<tr>
<td>南大通用</td>
<td>FreeSql.Provider.GBase</td>
<td>Informix</td>
</tr>
<tr>
<td>翰高</td>
<td>FreeSql.Provider.Custom、FreeSql.Provider.Odbc</td>
<td>PostgreSQL</td>
</tr>
</tbody>
</table>
<p>由于太多，在此不一一列举，它们大多数有共同特点：语法兼容 MySql、Oracle、SqlServer、PostgreSQL 四种常用数据库，FreeSql.Provider.Custom 提供了这四种数据库适配，并且支持 CodeFirst/DbFirst 以及完整的 FreeSql 功能。</p>
<p>FreeSql.Provider.Custom 不依赖具体 <a href="http://ado.net/odbc/oledb" target="_blank" rel="noopener noreferrer">ado.net/odbc/oledb</a> dll 驱动，使用者在外部自行引用 dll 驱动。</p>
<p>访问 MySql 数据库为例：</p>
<div><pre><code><span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionFactory</span><span>(</span>DataType<span>.</span>CustomMySql<span>,</span> <span>(</span><span>)</span> <span>=></span> 
        <span>new</span> <span>MySqlConnection</span><span>(</span><span>"Data Source=..."</span><span>)</span><span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
    <span>.</span><span>UseMonitorCommand</span><span>(</span>Console<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>SetDbProviderFactory</span><span>(</span><span>new</span> <span>MySqlClientFactory</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>若某国产数据库兼容 MySql SQL，先引用对方提供的 DLL，然后：</p>
<ul>
<li>将上面 new MySqlConnection 替换成 new XxxConnection</li>
<li>将上面 new MySqlClientFactory 替换成 new XxxClientFactory</li>
</ul>
<p>提示：对方 DLL 一般都会提供这两个现实类</p>
<h1 id="自定义适配" tabindex="-1"> 自定义适配</h1>
<p>为了让用户自己适配更多的数据库，比如连接 mssql 2000、db2 等数据库，牺牲了一些功能：</p>
<ul>
<li>不支持 CodeFirst 自动迁移</li>
<li>不支持 DbFirst 接口方法的实现</li>
<li>不支持 原来的分页方法，需要自行判断 id 进行分页</li>
<li>只支持较少的基础类型：bool,sbyte,short,int,long,byte,ushort,uint,ulong,double,float,decimal,DateTime,byte[],string,Guid</li>
</ul>
<p>使用者只需求重写类 FreeSql.Custom.CustomAdapter 就可以自定义访问不同的数据库。</p>
<p>我们默认做了一套 sqlserver 的语法和映射适配，代码在 <a href="https://github.com/2881099/FreeSql/blob/master/Providers/FreeSql.Provider.Custom/CustomAdapter.cs" target="_blank" rel="noopener noreferrer">CustomAdapter.cs</a>，请查看代码了解。</p>
<div><pre><code><span>class</span> <span>Mssql2000Adapter</span> <span>:</span> <span><span>FreeSql<span>.</span>Custom<span>.</span>CustomAdapter</span></span>
<span>{</span>
    <span>public</span> <span>override</span> <span><span>string</span></span> InsertAfterGetIdentitySql <span>=></span> <span>"SELECT SCOPE_IDENTITY()"</span><span>;</span>
    <span>//可以重写更多的设置</span>
<span>}</span>

<span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Custom<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>SqlConnection</span><span>(</span><span>@"Data Source=..."</span><span>)</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//be sure to define as singleton mode</span>

fsql<span>.</span><span>SetCustomAdapter</span><span>(</span><span>new</span> <span>Mssql2000Adapter</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>适配好新的 CustomAdapter 后，请在 FreeSqlBuilder.Build 之后调用 IFreeSql.SetCustomAdapter 方法生效。</p>
]]></content>
    <published>2022-07-09T09:12:12.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeSql.Provider.Odbc</title>
    <id>https://freesql.net/guide/freesql-provider-odbc.html</id>
    <link href="https://freesql.net/guide/freesql-provider-odbc.html"/>
    <updated>2022-09-08T15:50:22.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freesql-provider-odbc" tabindex="-1"> FreeSql.Provider.Odbc</h1>
<p>FreeSql.Provider.Odbc 实现 ODBC 访问数据库，ODBC 属于比较原始的技术，更新慢，各大数据库厂支持得标准不一，不到万不得已最好别用 odbc，坑比较多。</p>
<p>FreeSql.Provider.Odbc 做了多种数据库的专用实现：SqlServer、PostgreSQL、Oracle、MySql、达梦、人大金仓，和一种通用实现。</p>
<p>和原来的 FreeSql.Provider.SqlServer 等 <a href="http://ado.net" target="_blank" rel="noopener noreferrer">ado.net</a> 相比，只支持较少的基础类型，其他功能几乎都有，包括 CodeFirst 自动迁移。</p>
<p>国产数据库大多数都兼容 SqlServer、PostgreSQL、Oracle、MySql 这四种数据库，所以它们也可以用来访问国产数据库。</p>
<h1 id="自定义适配" tabindex="-1"> 自定义适配</h1>
<p>通用实现为了让用户自己适配更多的数据库，比如连接 mssql 2000、db2 等数据库，牺牲了一些功能：</p>
<ul>
<li>不支持 CodeFirst 自动迁移</li>
<li>不支持 DbFirst 接口方法的实现</li>
<li>不支持 原来的分页方法，需要自行判断 id 进行分页</li>
<li>只支持较少的基础类型：bool,sbyte,short,int,long,byte,ushort,uint,ulong,double,float,decimal,DateTime,byte[],string,Guid</li>
</ul>
<p>使用者只需求重写类 FreeSql.Odbc.Default.OdbcAdapter 就可以自定义访问不同的数据库。</p>
<p>我们默认做了一套 sqlserver 的语法和映射适配，代码在 <a href="https://github.com/2881099/FreeSql/blob/master/Providers/FreeSql.Provider.Odbc/Default/OdbcAdapter.cs" target="_blank" rel="noopener noreferrer">Default/OdbcAdapter.cs</a>，请查看代码了解。</p>
<div><pre><code><span>class</span> <span>Mssql2000Adapter</span> <span>:</span> <span><span>FreeSql<span>.</span>Odbc<span>.</span>Default<span>.</span>OdbcAdapter</span></span>
<span>{</span>
    <span>public</span> <span>override</span> <span><span>string</span></span> InsertAfterGetIdentitySql <span>=></span> <span>"SELECT SCOPE_IDENTITY()"</span><span>;</span>
    <span>//可以重写更多的设置</span>
<span>}</span>

fsql<span>.</span><span>SetOdbcAdapter</span><span>(</span><span>new</span> <span>Mssql2000Adapter</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>适配好新的 OdbcAdapter 后，请在 FreeSqlBuilder.Build 之后调用 IFreeSql.SetOdbcAdapter 方法生效。</p>
]]></content>
    <published>2022-07-09T09:12:12.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeSql 实现审计日志</title>
    <id>https://freesql.net/extra/freesql-auditlog.html</id>
    <link href="https://freesql.net/extra/freesql-auditlog.html"/>
    <updated>2022-08-30T23:13:53.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freesql-实现审计日志" tabindex="-1"> FreeSql 实现审计日志</h1>
<p>有两种情况，如果都是针对实体操作，确实很好做这个功能。</p>
<p>IFreeSql 更新/删除，都可以不传实体进行操作，所以这个 old_values, new_values 实现起来比较麻烦（可能需要查询一次？性能？）。另外还有批量操作。</p>
<h2 id="_1、fsql-aop-curdafter-事件是-crud-之后触发-提供以下参数" tabindex="-1"> 1、fsql.Aop.CurdAfter 事件是 CRUD 之后触发，提供以下参数</h2>
<div><pre><code><span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 标识符，可将 CurdBefore 与 CurdAfter 进行匹配</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span>Guid</span> Identifier <span>{</span> <span>get</span><span>;</span> <span>protected</span> <span>set</span><span>;</span> <span>}</span>
<span>protected</span> <span>Stopwatch</span> Stopwatch <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 操作类型</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span>CurdType</span> CurdType <span>{</span> <span>get</span><span>;</span> <span>}</span> <span>//Select, Delete, Update, Insert, InsertOrUpdate</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 实体类型</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span>Type</span> EntityType <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 实体类型的元数据</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span>TableInfo</span> Table <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 执行的 SQL</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span><span>string</span></span> Sql <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 参数化命令</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span>DbParameter<span>[</span><span>]</span></span> DbParms <span>{</span> <span>get</span><span>;</span> <span>}</span>

<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 发生的错误</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span>Exception</span> Exception <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 执行SQL命令，返回的结果</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span><span>object</span></span> ExecuteResult <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 耗时（单位：Ticks）</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span><span>long</span></span> ElapsedTicks <span>=></span> <span>this</span><span>.</span>Stopwatch<span>.</span>ElapsedTicks<span>;</span>
<span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 耗时（单位：毫秒）</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>public</span> <span><span>long</span></span> ElapsedMilliseconds <span>=></span> <span>this</span><span>.</span>Stopwatch<span>.</span>ElapsedMilliseconds<span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_2、freesql-dbcontext-或者-freesql-unitofwork-提供对象变化跟踪" tabindex="-1"> 2、FreeSql.DbContext 或者 FreeSql.UnitOfWork 提供对象变化跟踪</h2>
<p>全局设置：</p>
<div><pre><code>fsql<span>.</span><span>SetDbContextOptions</span><span>(</span>opt <span>=></span> <span>{</span>
  opt<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
    Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
  <span>}</span><span>;</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>单独设置 DbContext 或者 UnitOfWork：</p>
<div><pre><code><span><span>var</span></span> ctx <span>=</span> fsql<span>.</span><span>CreateDbContext</span><span>(</span><span>)</span><span>;</span>
ctx<span>.</span>Options<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
  Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
<span>}</span><span>;</span>

<span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>;</span>
uow<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
  Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>参数 report 是一个 List 集合，集合元素的类型定义如下：</p>
<div><pre><code><span>public</span> <span>class</span> <span>ChangeInfo</span>
<span>{</span>
    <span>public</span> <span><span>object</span></span> Object <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>EntityChangeType</span> Type <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// Type = Update 的时候，获取更新之前的对象</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>public</span> <span><span>object</span></span> BeforeObject <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 实体类型</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>public</span> <span>Type</span> EntityType <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>enum</span> <span>EntityChangeType</span> <span>{</span> Insert<span>,</span> Update<span>,</span> Delete<span>,</span> SqlRaw <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>变化类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>实体对象被插入</td>
</tr>
<tr>
<td>Update</td>
<td>实体对象被更新</td>
</tr>
<tr>
<td>Delete</td>
<td>实体对象被删除</td>
</tr>
<tr>
<td>SqlRaw</td>
<td>执行了SQL语句</td>
</tr>
</tbody>
</table>
<p>SqlRaw 目前有两处地方比较特殊：</p>
<ul>
<li>多对多联级更新导航属性的时候，对中间表的全部删除操作；</li>
<li>通用仓储类 BaseRepository 有一个 Delete 方法，参数为表达式，而并非实体；</li>
</ul>
<div><pre><code><span><span>int</span></span> <span>Delete</span><span>(</span><span>Expression<span>&lt;</span>Func<span>&lt;</span>TEntity<span>,</span> <span>bool</span><span>></span><span>></span></span> predicate<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>DbContext.SaveChanges，或者 Repository 对实体的 Insert/Update/Delete，或者 UnitOfWork.Commit 操作都会最多触发一次该事件。</p>
<ul>
<li>可根据 EntityType 获取具体的表名，数据库信息</li>
</ul>
<div><pre><code><span>//获取实体类核心配置</span>
<span>TableInfo</span>  tableInfo<span>=</span>fsql<span>.</span>CodeFrist<span>.</span><span>GetTableByEntity</span><span>(</span><span>Type</span> entityType<span>)</span><span>;</span>
<span>DbInfoResult</span>  dbinfoResult<span>=</span>fsql<span>.</span>CodeFrist<span>.</span><span>GetDbInfo</span><span>(</span><span>Type</span> entityType<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">Docker+ FreeSql</title>
    <id>https://freesql.net/extra/freesql-docker.html</id>
    <link href="https://freesql.net/extra/freesql-docker.html"/>
    <updated>2022-06-24T16:45:08.000Z</updated>
    <content type="html"><![CDATA[<h1 id="docker-freesql" tabindex="-1"> Docker+ FreeSql</h1>
<h2 id="net5-docker-encryption-ssl-tls-handshake-failed" tabindex="-1"> .net5+Docker+ Encryption(ssl/tls) handshake failed</h2>
<p>.net5 网站使用Sqlserver数据库部署在docker容器内运行报主库链接失败</p>
<h3 id="环境" tabindex="-1"> 环境</h3>
<p>数据库：Sqlserver2014
网站程序：.Net5
Docker版本：Docker version 19.03.13,
.net5环境镜像源：<a href="http://mcr.microsoft.com/dotnet/aspnet:5.0-buster-slim" target="_blank" rel="noopener noreferrer">mcr.microsoft.com/dotnet/aspnet:5.0-buster-slim</a>
Centos版本：CentOS Linux release 7.9.2009 (Core)</p>
<h3 id="使用原生方式进行测试" tabindex="-1"> 使用原生方式进行测试</h3>
<div><pre><code><span>using</span> <span>(</span><span>SqlConnection</span> connection <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span><span>"Data Source=xxxxx;User Id=sa;Password=xxxxxx;Initial Catalog=xxxxxxxx;Pooling=true;Min Pool Size=1;"</span><span>)</span><span>)</span>
<span>{</span>
    connection<span>.</span><span>Open</span><span>(</span><span>)</span><span>;</span>
    connection<span>.</span><span>Close</span><span>(</span><span>)</span><span>;</span>
    connection<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="报错" tabindex="-1"> 报错</h3>
<p>A connection was successfully established with the server, but then an error occurred during the pre-login handshake. (provider: SSL Provider, error: 31 - Encryption(ssl/tls) handshake failed)</p>
<h3 id="最终解决方案" tabindex="-1"> 最终解决方案</h3>
<p>在dockerfile里面加上这么两句</p>
<div><pre><code>RUN sed -i 's/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g' /etc/ssl/openssl.cnf
RUN sed -i 's/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g' /usr/lib/ssl/openssl.cnf
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p><strong>将TLSv1.2设为TLSv1，只能是设为TLSv1而不是设为TLSv1.0</strong></p>
<h2 id="原文链接" tabindex="-1"> 原文链接</h2>
<ul>
<li><a href="https://github.com/dotnetcore/FreeSql/issues/650" target="_blank" rel="noopener noreferrer">.net5 网站使用Sqlserver数据库部署在docker容器内运行报主库链接失败 · Issue #650 · dotnetcore/FreeSql (github.com)</a></li>
</ul>
]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">ISelect 拷贝克隆(copy/clone)</title>
    <id>https://freesql.net/extra/iselect-depcopy.html</id>
    <link href="https://freesql.net/extra/iselect-depcopy.html"/>
    <updated>2022-08-30T23:16:37.000Z</updated>
    <content type="html"><![CDATA[<h1 id="iselect-拷贝克隆-copy-clone" tabindex="-1"> ISelect 拷贝克隆(copy/clone)</h1>
<p>当一个 ISelect 构造到一定复杂程序之后，比如：</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>Test</span><span>(</span><span>)</span>
<span>{</span>
    <span><span>var</span></span> select1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>AdmRoute<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Parent<span>)</span>
        <span>.</span><span>WhereIf</span><span>(</span><span>!</span><span>string</span><span>.</span><span>IsNullOrEmpty</span><span>(</span>key<span>)</span><span>,</span> a <span>=></span> a<span>.</span>Name<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Extdata<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Remark<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>TenantId<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>Name<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>Extdata<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>Remark<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>TenantId<span>.</span><span>Contains</span><span>(</span>key<span>)</span><span>)</span>
        <span>.</span><span>WhereIf</span><span>(</span>Parent_Id<span>?.</span><span>Any</span><span>(</span><span>)</span> <span>==</span> <span>true</span><span>,</span> a <span>=></span> Parent_Id<span>.</span><span>Contains</span><span>(</span>a<span>.</span>ParentId<span>)</span><span>)</span>
        <span>.</span><span>WhereIf</span><span>(</span>mn_Roles_Id<span>?.</span><span>Any</span><span>(</span><span>)</span> <span>==</span> <span>true</span><span>,</span> a <span>=></span> a<span>.</span>Roles<span>.</span><span>AsSelect</span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span>b <span>=></span> mn_Roles_Id<span>.</span><span>Contains</span><span>(</span>b<span>.</span>Id<span>)</span><span>)</span><span>)</span><span>;</span>

    <span><span>var</span></span> select2 <span>=</span> select1<span>;</span>
    select1<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Status <span>==</span> <span>0</span><span>)</span><span>;</span>
    <span>//此时 select2 也附加了 a.Status == 0 条件</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>利用语法糖解决：</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>Test</span><span>(</span><span>)</span>
<span>{</span>
    <span>ISelect<span>&lt;</span>AdmRoute<span>></span></span> <span>GetSelect</span><span>(</span><span>)</span> <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>AdmRoute<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Parent<span>)</span>
        <span>.</span><span>WhereIf</span><span>(</span><span>!</span><span>string</span><span>.</span><span>IsNullOrEmpty</span><span>(</span>key<span>)</span><span>,</span> a <span>=></span> a<span>.</span>Name<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Extdata<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Remark<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>TenantId<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>Name<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>Extdata<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>Remark<span>.</span><span>Contains</span><span>(</span>key<span>)</span> <span>||</span> a<span>.</span>Parent<span>.</span>TenantId<span>.</span><span>Contains</span><span>(</span>key<span>)</span><span>)</span>
        <span>.</span><span>WhereIf</span><span>(</span>Parent_Id<span>?.</span><span>Any</span><span>(</span><span>)</span> <span>==</span> <span>true</span><span>,</span> a <span>=></span> Parent_Id<span>.</span><span>Contains</span><span>(</span>a<span>.</span>ParentId<span>)</span><span>)</span>
        <span>.</span><span>WhereIf</span><span>(</span>mn_Roles_Id<span>?.</span><span>Any</span><span>(</span><span>)</span> <span>==</span> <span>true</span><span>,</span> a <span>=></span> a<span>.</span>Roles<span>.</span><span>AsSelect</span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span>b <span>=></span> mn_Roles_Id<span>.</span><span>Contains</span><span>(</span>b<span>.</span>Id<span>)</span><span>)</span><span>)</span><span>;</span>

    <span><span>var</span></span> select1 <span>=</span> <span>GetSelect</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> select2 <span>=</span> <span>GetSelect</span><span>(</span><span>)</span><span>;</span>
    select1<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Status <span>==</span> <span>0</span><span>)</span><span>;</span>
    <span>//此时 select2 不会附加 a.Status == 0 条件</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>科普：</p>
<p>csharp 7.0 支持本地函数，<strong>方法内再定义临时方法</strong>，这个特性向大家推荐，在很多时候都非常有效。</p>
<p>方法内还可以定义方法，那就称它：本地函数/嵌套方法。</p>
<h2 id="原文链接" tabindex="-1"> 原文链接</h2>
<ul>
<li><a href="https://github.com/dotnetcore/FreeSql/issues/644" target="_blank" rel="noopener noreferrer">技巧：ISelect 如何拷贝(copy)复用，克隆(clone) · Issue #644 · dotnetcore/FreeSql (github.com)</a></li>
</ul>
]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">动态聚合列 sum(case when ...)</title>
    <id>https://freesql.net/extra/issues-expression-groupbysum.html</id>
    <link href="https://freesql.net/extra/issues-expression-groupbysum.html"/>
    <updated>2022-08-30T23:17:10.000Z</updated>
    <content type="html"><![CDATA[<h1 id="动态聚合列-sum-case-when" tabindex="-1"> 动态聚合列 sum(case when ...)</h1>
<div><pre><code><span>SELECT</span>
a<span>.</span><span>"Time"</span><span>,</span>
v1 <span>=</span> <span>sum</span><span>(</span><span>case</span> <span>when</span> a<span>.</span><span>"Id"</span> <span>=</span><span>=</span> <span>1</span> <span>then</span> <span>1</span> <span>else</span> <span>0</span> <span>end</span><span>)</span><span>,</span>
v2 <span>=</span> <span>sum</span><span>(</span><span>case</span> <span>when</span> a<span>.</span><span>"Id"</span> <span>=</span><span>=</span> <span>2</span> <span>then</span> <span>1</span> <span>else</span> <span>0</span> <span>end</span><span>)</span><span>,</span>
v3 <span>=</span> <span>sum</span><span>(</span><span>case</span> <span>when</span> a<span>.</span><span>"Id"</span> <span>=</span><span>=</span> <span>3</span> <span>then</span> <span>1</span> <span>else</span> <span>0</span> <span>end</span><span>)</span>
<span>FROM</span> <span>"table"</span> a
<span>WHERE</span> a<span>.</span><span>"Id"</span> <span>IN</span> <span>(</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>)</span>
<span>GROUP</span> <span>BY</span> a<span>.</span><span>"Time"</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>如上 v1,v2,v3 是动态聚合值，如果 where IN (1,2,3,4) 那就会产生 v1-v4</p>
<p>正常情况下，静态的 lambda 查询没办法处理这种动态列查询。</p>
<hr>
<p>变通一下，这样查询：</p>
<div><pre><code><span>SELECT</span>
a<span>.</span><span>"Time"</span><span>,</span>
v <span>=</span> <span>sum</span><span>(</span><span>case</span> <span>when</span> a<span>.</span><span>"Id"</span> <span>=</span><span>=</span> <span>1</span> <span>then</span> <span>1</span> <span>else</span> <span>0</span> <span>end</span><span>)</span> <span>+</span> <span>','</span>
    <span>sum</span><span>(</span><span>case</span> <span>when</span> a<span>.</span><span>"Id"</span> <span>=</span><span>=</span> <span>2</span> <span>then</span> <span>1</span> <span>else</span> <span>0</span> <span>end</span><span>)</span> <span>+</span> <span>','</span>
    <span>sum</span><span>(</span><span>case</span> <span>when</span> a<span>.</span><span>"Id"</span> <span>=</span><span>=</span> <span>3</span> <span>then</span> <span>1</span> <span>else</span> <span>0</span> <span>end</span><span>)</span>
<span>FROM</span> <span>"table"</span> a
<span>WHERE</span> a<span>.</span><span>"Id"</span> <span>IN</span> <span>(</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>)</span>
<span>GROUP</span> <span>BY</span> a<span>.</span><span>"Time"</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>如此便可以使用 FreeSql 实现：</p>
<div><pre><code><span><span>var</span></span> ids <span>=</span> <span>new</span> <span><span>int</span><span>[</span><span>]</span></span> <span>{</span> <span>1</span><span>,</span><span>2</span><span>,</span><span>3</span> <span>}</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>table<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> ids<span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span>
    <span>.</span><span>GroupBy</span><span>(</span>a <span>=></span> a<span>.</span>Time<span>)</span>
    <span>.</span><span>ToList</span><span>(</span>g <span>=></span> <span>new</span> 
    <span>{</span>
        Time <span>=</span> g<span>.</span>Key<span>,</span>
        Values <span>=</span> MyExt<span>.</span><span>SumCase</span><span>(</span>ids<span>,</span> g<span>.</span>Value<span>.</span>Id<span>)</span>
    <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>自定义解析表达式树，实现如下：</p>
<div><pre><code><span>[</span><span><span>ExpressionCall</span></span><span>]</span>
<span>public</span> <span>static</span> <span>class</span> <span>MyExt</span>
<span>{</span>
    <span>internal</span> <span>static</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span> expContext <span>=</span> <span>new</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span><span>(</span><span>)</span><span>;</span>

    <span>public</span> <span>static</span> <span><span>string</span></span> <span><span>SumCase</span><span><span>&lt;</span>TValue<span>></span></span></span><span>(</span><span>[</span><span><span>RawValue</span></span><span>]</span> <span>TValue<span>[</span><span>]</span></span> values<span>,</span> <span>TValue</span> column<span>)</span>
    <span>{</span>
        <span><span>var</span></span> ctx <span>=</span> expContext<span>.</span>Value<span>;</span>
        ctx<span>.</span>Result <span>=</span> ctx<span>.</span>Utility<span>.</span>CommonUtils<span>.</span><span>StringConcat</span><span>(</span>
            values<span>.</span><span>Select</span><span>(</span><span>(</span>val<span>,</span> idx<span>)</span> <span>=></span> 
                <span>new</span> <span>[</span><span>]</span> <span>{</span>
                    ctx<span>.</span>_commonExp<span>.</span>_common<span>.</span><span>IsNull</span><span>(</span><span><span>$"SUM(case when </span><span><span>{</span><span>ctx<span>.</span>ParsedContent<span>[</span><span>"column"</span><span>]</span></span><span>}</span></span><span> = </span><span><span>{</span><span>ctx<span>.</span><span>FormatSql</span><span>(</span>val<span>)</span></span><span>}</span></span><span> then 1 else 0 end)"</span></span><span>,</span> <span>0</span><span>)</span><span>,</span>
                    idx <span>==</span> values<span>.</span>Length <span>-</span> <span>1</span> <span>?</span> <span>"''"</span> <span>:</span> <span>"','"</span>
                <span>}</span><span>)</span><span>.</span><span>SelectMany</span><span>(</span>a <span>=></span> a<span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>,</span> 
            values<span>.</span><span>Select</span><span>(</span>val <span>=></span> 
                <span>new</span><span>[</span><span>]</span><span>{</span>
                    <span>typeof</span><span>(</span><span>TValue</span><span>)</span><span>,</span>
                    <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span>
                <span>}</span><span>)</span><span>.</span><span>SelectMany</span><span>(</span>a <span>=></span> a<span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>)</span><span>;</span>
        <span>return</span> <span>default</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">In多列查询，表达式自定义实现</title>
    <id>https://freesql.net/extra/issues-in-valuetype.html</id>
    <link href="https://freesql.net/extra/issues-in-valuetype.html"/>
    <updated>2022-06-24T16:45:08.000Z</updated>
    <content type="html"><![CDATA[<h1 id="in多列查询-表达式自定义实现" tabindex="-1"> In多列查询，表达式自定义实现</h1>
<p>FreeSql 基础库为了不依赖 System.ValueType.dll，所以将以下代码抽离了出来。</p>
<div><pre><code><span>//元组集合</span>
<span>vae</span> lst <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>(</span>Guid<span>,</span> DateTime<span>)</span><span>></span></span><span>(</span><span>)</span><span>;</span>
lst<span>.</span><span>Add</span><span>(</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>,</span> DateTime<span>.</span>Now<span>)</span><span>)</span><span>;</span>
lst<span>.</span><span>Add</span><span>(</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>,</span> DateTime<span>.</span>Now<span>)</span><span>)</span><span>;</span>

<span><span>var</span></span> t2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> lst<span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>,</span> a<span>.</span>ct1<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT .. FROM ..</span>
<span>//WHERE (a."Id" = '685ee1f6-bdf6-4719-a291-c709b8a1378f' AND a."ct1" = '2019-12-07 23:55:27' OR </span>
<span>//a."Id" = '5ecd838a-06a0-4c81-be43-1e77633b7404' AND a."ct1" = '2019-12-07 23:55:27')</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>代码实现：</p>
<div><pre><code><span>using</span> <span>FreeSql<span>.</span>DataAnnotations</span><span>;</span>
<span>using</span> <span>System<span>.</span>Collections<span>.</span>Generic</span><span>;</span>
<span>using</span> <span>System<span>.</span>Linq</span><span>;</span>
<span>using</span> <span>System<span>.</span>Text</span><span>;</span>
<span>using</span> <span>System<span>.</span>Threading</span><span>;</span>

<span>[</span><span><span>ExpressionCall</span></span><span>]</span>
<span>public</span> <span>static</span> <span>class</span> <span>MyFreeSqlExpressionCall</span>
<span>{</span>
    <span>public</span> <span>static</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span> expContext <span>=</span> <span>new</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// C#：从元组集合中查找 exp1, exp2 是否存在<span><span><span>&lt;</span>para</span><span>></span></span><span><span><span>&lt;/</span>para</span><span>></span></span></span>
    <span>/// SQL： <span><span><span>&lt;</span>para</span><span>></span></span><span><span><span>&lt;/</span>para</span><span>></span></span></span>
    <span>/// exp1 = that[0].Item1 and exp2 = that[0].Item2 OR <span><span><span>&lt;</span>para</span><span>></span></span><span><span><span>&lt;/</span>para</span><span>></span></span></span>
    <span>/// exp1 = that[1].Item1 and exp2 = that[1].Item2 OR <span><span><span>&lt;</span>para</span><span>></span></span><span><span><span>&lt;/</span>para</span><span>></span></span></span>
    <span>/// ... <span><span><span>&lt;</span>para</span><span>></span></span><span><span><span>&lt;/</span>para</span><span>></span></span></span>
    <span>/// 注意：当 that 为 null 或 empty 时，返回 1=0 <span><span><span>&lt;</span>para</span><span>></span></span><span><span><span>&lt;/</span>para</span><span>></span></span></span>
    <span>/// Oracle： (Id, Name) IN ((1, "name1"), (2, "name2"))</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>/// <span><span><span>&lt;</span>typeparam</span> <span>name</span><span><span>=</span><span>"</span>T1<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>typeparam</span><span>></span></span></span>
    <span>/// <span><span><span>&lt;</span>typeparam</span> <span>name</span><span><span>=</span><span>"</span>T2<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>typeparam</span><span>></span></span></span>
    <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>that<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
    <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>exp1<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
    <span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>exp2<span>"</span></span><span>></span></span><span><span><span>&lt;/</span>param</span><span>></span></span></span>
    <span>/// <span><span><span>&lt;</span>returns</span><span>></span></span><span><span><span>&lt;/</span>returns</span><span>></span></span></span>
    <span>public</span> <span>static</span> <span><span>bool</span></span> <span><span>Contains</span><span><span>&lt;</span>T1<span>,</span> T2<span>></span></span></span><span>(</span><span>[</span><span><span>RawValue</span></span><span>]</span> <span>this</span> <span>IEnumerable<span>&lt;</span><span>(</span>T1<span>,</span> T2<span>)</span><span>></span></span> that<span>,</span> <span>T1</span> exp1<span>,</span> <span>T2</span> exp2<span>)</span>
    <span>{</span>
        <span>if</span> <span>(</span>expContext<span>.</span>IsValueCreated <span>==</span> <span>false</span> <span>||</span> expContext<span>.</span>Value <span>==</span> <span>null</span> <span>||</span> expContext<span>.</span>Value<span>.</span>ParsedContent <span>==</span> <span>null</span><span>)</span>
            <span>return</span> that<span>?.</span><span>Any</span><span>(</span>a <span>=></span> a<span>.</span>Item1<span>.</span><span>Equals</span><span>(</span>exp1<span>)</span> <span>&amp;&amp;</span> a<span>.</span>Item2<span>.</span><span>Equals</span><span>(</span>exp2<span>)</span><span>)</span> <span>==</span> <span>true</span><span>;</span>
        <span>if</span> <span>(</span>that<span>?.</span><span>Any</span><span>(</span><span>)</span> <span>!=</span> <span>true</span><span>)</span>
        <span>{</span>
            expContext<span>.</span>Value<span>.</span>Result <span>=</span> <span>"1=0"</span><span>;</span>
            <span>return</span> <span>false</span><span>;</span>
        <span>}</span>
        <span><span>var</span></span> sb <span>=</span> <span>new</span> <span>StringBuilder</span><span>(</span><span>)</span><span>;</span>
        <span><span>var</span></span> idx <span>=</span> <span>0</span><span>;</span>

        <span>switch</span> <span>(</span>expContext<span>.</span>Value<span>.</span>DataType <span>)</span>
        <span>{</span>
            <span>case</span> FreeSql<span>.</span>DataType<span>.</span>Oracle<span>:</span>
            <span>case</span> FreeSql<span>.</span>DataType<span>.</span>OdbcOracle<span>:</span>
                sb<span>.</span><span>Append</span><span>(</span><span>"("</span><span>)</span>
                    <span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span>ParsedContent<span>[</span><span>"exp1"</span><span>]</span><span>)</span><span>.</span><span>Append</span><span>(</span><span>", "</span><span>)</span>
                    <span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span>ParsedContent<span>[</span><span>"exp2"</span><span>]</span><span>)</span>
                    <span>.</span><span>Append</span><span>(</span><span>") IN ("</span><span>)</span><span>;</span>
                <span>foreach</span> <span>(</span><span><span>var</span></span> item <span>in</span> that<span>)</span>
                <span>{</span>
                    <span>if</span> <span>(</span>idx<span>++</span> <span>></span> <span>0</span><span>)</span> sb<span>.</span><span>Append</span><span>(</span><span>", "</span><span>)</span><span>;</span>
                    sb<span>.</span><span>Append</span><span>(</span><span>"("</span><span>)</span>
                        <span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span><span>FormatSql</span><span>(</span>FreeSql<span>.</span>Internal<span>.</span>Utils<span>.</span><span>GetDataReaderValue</span><span>(</span><span>typeof</span><span>(</span><span>T1</span><span>)</span><span>,</span> item<span>.</span>Item1<span>)</span><span>)</span><span>)</span><span>.</span><span>Append</span><span>(</span><span>", "</span><span>)</span>
                        <span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span><span>FormatSql</span><span>(</span>FreeSql<span>.</span>Internal<span>.</span>Utils<span>.</span><span>GetDataReaderValue</span><span>(</span><span>typeof</span><span>(</span><span>T2</span><span>)</span><span>,</span> item<span>.</span>Item2<span>)</span><span>)</span><span>)</span>
                        <span>.</span><span>Append</span><span>(</span><span>")"</span><span>)</span><span>;</span>
                <span>}</span>
                sb<span>.</span><span>Append</span><span>(</span><span>")"</span><span>)</span><span>;</span>

                expContext<span>.</span>Value<span>.</span>Result <span>=</span> sb<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
                <span>return</span> <span>false</span><span>;</span>
        <span>}</span>
        <span>foreach</span> <span>(</span><span><span>var</span></span> item <span>in</span> that<span>)</span>
        <span>{</span>
            <span>if</span> <span>(</span>idx<span>++</span> <span>></span> <span>0</span><span>)</span> sb<span>.</span><span>Append</span><span>(</span><span>" OR \r\n"</span><span>)</span><span>;</span>
            sb
                <span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span>ParsedContent<span>[</span><span>"exp1"</span><span>]</span><span>)</span><span>.</span><span>Append</span><span>(</span><span>" = "</span><span>)</span><span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span><span>FormatSql</span><span>(</span>FreeSql<span>.</span>Internal<span>.</span>Utils<span>.</span><span>GetDataReaderValue</span><span>(</span><span>typeof</span><span>(</span><span>T1</span><span>)</span><span>,</span> item<span>.</span>Item1<span>)</span><span>)</span><span>)</span>
                <span>.</span><span>Append</span><span>(</span><span>" AND "</span><span>)</span>
                <span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span>ParsedContent<span>[</span><span>"exp2"</span><span>]</span><span>)</span><span>.</span><span>Append</span><span>(</span><span>" = "</span><span>)</span><span>.</span><span>Append</span><span>(</span>expContext<span>.</span>Value<span>.</span><span>FormatSql</span><span>(</span>FreeSql<span>.</span>Internal<span>.</span>Utils<span>.</span><span>GetDataReaderValue</span><span>(</span><span>typeof</span><span>(</span><span>T2</span><span>)</span><span>,</span> item<span>.</span>Item2<span>)</span><span>)</span><span>)</span><span>;</span>
        <span>}</span>
        expContext<span>.</span>Value<span>.</span>Result <span>=</span> sb<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>
        <span>return</span> <span>true</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">Mysql 5.5 兼容性</title>
    <id>https://freesql.net/extra/issues-mysql5_5.html</id>
    <link href="https://freesql.net/extra/issues-mysql5_5.html"/>
    <updated>2022-06-24T16:45:08.000Z</updated>
    <content type="html"><![CDATA[<h1 id="mysql-5-5-兼容性" tabindex="-1"> Mysql 5.5 兼容性</h1>
<h2 id="mysql-5-5-不支持-datetime-3-导致-codefirst-报错" tabindex="-1"> Mysql 5.5 不支持 datetime(3)，导致 codefirst 报错</h2>
<p>二种解决办法：</p>
<p>1、[Column(DbType = &quot;DATETIME&quot;)]</p>
<p>2、统一处理的话写个AOP</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>Property<span>.</span>PropertyType <span>==</span> <span>typeof</span><span>(</span><span>DateTime</span><span>)</span> <span>||</span> e<span>.</span>Property<span>.</span>PropertyType <span>==</span> <span>typeof</span><span>(</span><span>DateTime<span>?</span></span><span>)</span><span>)</span>
         e<span>.</span>ModifyResult<span>.</span>DbType <span>=</span> <span>"DATETIME"</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">MySqlConnector</title>
    <id>https://freesql.net/guide/freesql-provider-mysqlconnector.html</id>
    <link href="https://freesql.net/guide/freesql-provider-mysqlconnector.html"/>
    <updated>2022-08-11T11:13:06.000Z</updated>
    <content type="html"><![CDATA[
<p><code>FreeSql.Provider.MySqlConnector</code>是<code>FreeSql</code>基于社区提供的最新的<a href="https://github.com/mysql-net/MySqlConnector" target="_blank" rel="noopener noreferrer"><code>MySqlConnector</code></a>驱动的实现，兼容性、性能都比<code>FreeSql.Provider.MySql</code>好，且支持多种数据库，如：<code>MySQL Server, MariaDB, Percona Server, Amazon Aurora, Azure Database for MySQL, Google Cloud SQL for MySQL, OceanBase</code></p>
<p>并且支持BulkCopy，<strong>推荐使用</strong></p>
<p>如果你使用 <code>FreeSql.Provider.MySql</code> 发生了以下错误，请替换到 FreeSql.Provider.MySqlConnector：</p>
<ul>
<li>The given key '0' was not present in the dictionary.</li>
<li>The given key '25653' was not present in the dictionary.</li>
<li>The given key '26995' was not present in the dictionary.</li>
<li>The given key '28261 was not present in the dictionary.</li>
<li>The given key '65535' was not present in the dictionary.</li>
<li>The type initializer for 'MySql.Data.MySqlClient.Replication.ReplicationManager' threw an exception.</li>
<li>Parameter '@xxx' must be defined.</li>
</ul>
<h2 id="executemysqlbulkcopy" tabindex="-1"> ExecuteMySqlBulkCopy</h2>
<ul>
<li>主键无值</li>
</ul>
<div><pre><code><span>public</span> <span>class</span> <span>Department</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>,</span> IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>long</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>List<span>&lt;</span>Department<span>></span></span> departments <span>=</span> <span>new</span> <span>List<span>&lt;</span>Department<span>></span></span><span>(</span><span>)</span>
<span>{</span>
    <span>new</span> <span>Department</span><span>(</span><span>)</span> <span>{</span> Name <span>=</span><span>"部门1"</span><span>}</span><span>,</span>
    <span>new</span> <span>Department</span><span>(</span><span>)</span> <span>{</span> Name <span>=</span><span>"部门2"</span><span>}</span><span>,</span>
    <span>new</span> <span>Department</span><span>(</span><span>)</span> <span>{</span> Name <span>=</span><span>"部门3"</span><span>}</span>
<span>}</span><span>;</span>
fsql<span>.</span><span>Insert</span><span>(</span>departments<span>)</span>
    <span>.</span><span>InsertIdentity</span><span>(</span><span>)</span> <span>//这行</span>
    <span>.</span><span>ExecuteMySqlBulkCopy</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>Id主键有值时</li>
</ul>
<div><pre><code><span>List<span>&lt;</span>Department<span>></span></span> departments <span>=</span> <span>new</span> <span>List<span>&lt;</span>Department<span>></span></span><span>(</span><span>)</span>
<span>{</span>
    <span>new</span> <span>Department</span><span>(</span><span>)</span> <span>{</span> Id<span>=</span><span>1</span><span>,</span> Name <span>=</span><span>"部门1"</span><span>}</span><span>,</span>
    <span>new</span> <span>Department</span><span>(</span><span>)</span> <span>{</span> Id<span>=</span><span>2</span><span>,</span> Name <span>=</span><span>"部门2"</span><span>}</span><span>,</span>
    <span>new</span> <span>Department</span><span>(</span><span>)</span> <span>{</span> Id<span>=</span><span>3</span><span>,</span> Name <span>=</span><span>"部门3"</span><span>}</span>
<span>}</span><span>;</span>
fsql<span>.</span><span>Insert</span><span>(</span>departments<span>)</span>
    <span>.</span><span>ExecuteMySqlBulkCopy</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeSql.Provider.Oracle</title>
    <id>https://freesql.net/guide/freesql-provider-oracle.html</id>
    <link href="https://freesql.net/guide/freesql-provider-oracle.html"/>
    <updated>2022-08-26T09:51:00.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freesql-provider-oracle" tabindex="-1"> FreeSql.Provider.Oracle</h1>
<p>FreeSql 对 Oracle 支持非常友好，是 c#.net ORM 不二之选，提供了 <a href="http://Ado.net/Odbc/Oledb" target="_blank" rel="noopener noreferrer">Ado.net/Odbc/Oledb</a> 三种实现包，他们都支持 .NETCore2.1+、.NET4.0+ 等最新或较低的 .NETFramework 版本。</p>
<p>若想以 <a href="http://Ado.net" target="_blank" rel="noopener noreferrer">Ado.net</a> 驱动访问数据库，请安装：</p>
<blockquote>
<p>dotnet add package FreeSql.Provider.Oracle</p>
</blockquote>
<p>若想以 ODBC 驱动访问数据库，请安装：</p>
<blockquote>
<p>dotnet add package FreeSql.Provider.Odbc</p>
</blockquote>
<p>若想以 Oledb 驱动访问数据库，请安装：</p>
<blockquote>
<p>dotnet add package FreeSql.Provider.OracleOledb</p>
</blockquote>
<hr>
<p>关于 Oracle US7ASCII 中文乱码的问题，<a href="http://Ado.Net" target="_blank" rel="noopener noreferrer">Ado.Net</a> 和 Odbc 无法解决。<a href="http://xn--uiry38ay5bnubq85b.Net" target="_blank" rel="noopener noreferrer">包括最新的.Net</a> Core、.NET6、.NET7 都无法解决这个问题。</p>
<p>安装 FreeSql.Provider.OracleOledb 使用 Oledb 驱动解决读取使用 US7ASCII 的 Oracle 数据库中文显示乱码问题。</p>
<div><pre><code><span>public</span> <span>class</span> <span>DB</span>
<span>{</span>
    <span>static</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span> oracleLazy <span>=</span> <span>new</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
        <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Oracle<span>,</span> <span>"Provider=OraOLEDB.Oracle;user id=9user;password=123456;data source=//127.0.0.1:1521/XE;Pooling=true;Max Pool Size=2"</span><span>)</span>
        <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
        <span>.</span><span>UseNameConvert</span><span>(</span>FreeSql<span>.</span>Internal<span>.</span>NameConvertType<span>.</span>ToUpper<span>)</span>
        <span>.</span><span>UseNoneCommandParameter</span><span>(</span><span>true</span><span>)</span>
        <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Trace<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
        <span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>
    <span>public</span> <span>static</span> <span>IFreeSql</span> oracle <span>=></span> oracleLazy<span>.</span>Value<span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>定义 DB.cs 类之后就可以快乐的 CRUD 了。FreeSql 提供多种 CRUD 使用习惯，请根据实际情况选择团队合适的一种：</p>
<ul>
<li>要么 FreeSql，原始用法；</li>
<li>要么 FreeSql.Repository，仓储+工作单元习惯；</li>
<li>要么 FreeSql.DbContext，很像 EFCore 的使用习惯；</li>
<li>要么 FreeSql.BaseEntity，充血模式；</li>
<li>要么 直接像 dapper 那样使用 OracleConnection 扩展方法；</li>
</ul>
]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">PostgreSQL</title>
    <id>https://freesql.net/guide/freesql-provider-postgresql.html</id>
    <link href="https://freesql.net/guide/freesql-provider-postgresql.html"/>
    <updated>2022-06-24T16:45:08.000Z</updated>
    <content type="html"><![CDATA[<h1 id="postgresql" tabindex="-1"> PostgreSQL</h1>
]]></content>
    <published>2022-06-24T16:45:08.000Z</published>
  </entry>
  <entry>
    <title type="html">基于FreeSql扩展文档</title>
    <id>https://freesql.net/extra/</id>
    <link href="https://freesql.net/extra/"/>
    <updated>2022-08-31T14:37:49.000Z</updated>
    <content type="html"><![CDATA[<h1 id="基于freesql扩展文档" tabindex="-1"> 基于FreeSql扩展文档</h1>
<h2 id="更多文档" tabindex="-1"> 更多文档</h2>
<ul>
<li><a href="https://github.com/dotnetcore/FreeSql/issues/601" target="_blank" rel="noopener noreferrer">CentOS8 ARM 下连接 SQL Server 2008 R2（Hypervisor）</a></li>
<li><a href="https://github.com/dotnetcore/FreeSql/issues/430" target="_blank" rel="noopener noreferrer">一对多关系，分表只取关联的第一条记录，如何获取</a></li>
</ul>
]]></content>
    <published>2022-06-23T16:16:24.000Z</published>
  </entry>
  <entry>
    <title type="html">多个 IFreeSql 注入使用</title>
    <id>https://freesql.net/extra/idlebus-freesql.html</id>
    <link href="https://freesql.net/extra/idlebus-freesql.html"/>
    <updated>2022-08-30T23:13:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="多个-ifreesql-注入使用" tabindex="-1"> 多个 IFreeSql 注入使用</h1>
<p>多库切换，动态切库，动态注册数据库</p>
<h2 id="一、定义多个-ifreesql" tabindex="-1"> 一、定义多个 IFreeSql</h2>
<p>该方法适用于固定数据库，固定配置项</p>
<p>1、定义两个标识类：</p>
<div><pre><code><span>class</span> <span>MySqlFlag</span> <span>{</span><span>}</span>
<span>class</span> <span>SqlServerFlag</span> <span>{</span><span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>2、在 Startup.cs 中单例注入</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    <span>Func<span>&lt;</span>IServiceProvider<span>,</span> IFreeSql<span>&lt;</span>MySqlFlag<span>></span><span>></span></span> fsql1 <span>=</span> r <span>=></span>
    <span>{</span>
        <span><span>var</span></span> fsql1 <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>MySql<span>,</span> <span>"str1"</span><span>)</span>
            <span>.</span><span><span>Build</span><span><span>&lt;</span>MySqlFlag<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        <span>return</span> fsql1<span>;</span>
    <span>}</span><span>;</span>
    <span>Func<span>&lt;</span>IServiceProvider<span>,</span> IFreeSql<span>&lt;</span>SqlServerFlag<span>></span><span>></span></span> fsql2 <span>=</span> r <span>=></span>
    <span>{</span>
        <span><span>var</span></span> fsql2 <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>SqlServer<span>,</span> <span>"str1"</span><span>)</span>
            <span>.</span><span><span>Build</span><span><span>&lt;</span>SqlServerFlag<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        <span>return</span> fsql2<span>;</span>
    <span>}</span><span>;</span>

    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>&lt;</span>MySqlFlag<span>></span><span>></span></span></span><span>(</span>fsql1<span>)</span><span>;</span>
    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>&lt;</span>SqlServerFlag<span>></span><span>></span></span></span><span>(</span>fsql2<span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>3、在 Controller 中使用</p>
<div><pre><code><span>[</span><span><span>Route</span><span><span>(</span><span>"api/[controller]"</span><span>)</span></span></span><span>]</span>
<span>[</span><span><span>ApiController</span></span><span>]</span>
<span>public</span> <span>class</span> <span>ValuesController</span> <span>:</span> <span><span>ControllerBase</span></span>
<span>{</span>
    <span>public</span> <span>ValuesController</span><span>(</span><span>IFreeSql<span>&lt;</span>MySqlFlag<span>></span></span> mysql<span>,</span> <span>IFreeSql<span>&lt;</span>SqlServerFlag<span>></span></span> sqlserver<span>)</span>
    <span>{</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="二、使用-freesql-clound" tabindex="-1"> 二、使用 FreeSql.Clound</h2>
<p>为 FreeSql 提供跨数据库访问，分布式事务TCC、SAGA解决方案，支持 .NET Core 2.1+, .NET Framework 4.0+.</p>
<p>开源地址：<a href="https://github.com/2881099/FreeSql.Cloud" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.Cloud</a></p>
<blockquote>
<p>dotnet add package FreeSql.Cloud</p>
</blockquote>
<p>or</p>
<blockquote>
<p>Install-Package FreeSql.Cloud</p>
</blockquote>
<div><pre><code><span>public</span> <span>enum</span> <span>DbEnum</span> <span>{</span> db1<span>,</span> db2<span>,</span> db3 <span>}</span>

<span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlCloud<span>&lt;</span>DbEnum<span>></span></span><span>(</span><span>"myapp"</span><span>)</span><span>;</span> <span>//提示：泛型可以传入 string</span>
fsql<span>.</span>DistributeTrace <span>=</span> log <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>log<span>.</span><span>Split</span><span>(</span><span>'\n'</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>Trim</span><span>(</span><span>)</span><span>)</span><span>;</span>

fsql<span>.</span><span>Register</span><span>(</span>DbEnum<span>.</span>db1<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=db1.db"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>

fsql<span>.</span><span>Register</span><span>(</span>DbEnum<span>.</span>db2<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=db2.db"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>

fsql<span>.</span><span>Register</span><span>(</span>DbEnum<span>.</span>db3<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=db3.db"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>FreeSqlCloud 必须定义成单例模式</p>
</blockquote>
<blockquote>
<p>new FreeSqlCloud&lt;DbEnum&gt;() 多连接管理</p>
</blockquote>
<blockquote>
<p>new FreeSqlCloud&lt;DbEnum&gt;(&quot;myapp&quot;) 开启 TCC/SAGA 事务生效</p>
</blockquote>
<p>FreeSqlCloud 的访问方式和 IFreeSql 一样：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>

<span>//...</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>切换数据库：</p>
<div><pre><code>fsql<span>.</span><span>Change</span><span>(</span>DbEnum<span>.</span>db3<span>)</span><span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span>//以后所有 fsql.Select/Insert/Update/Delete 操作是 db3</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>自动定向数据库配置：</p>
<div><pre><code><span>//对 fsql.CRUD 方法名 + 实体类型 进行拦截，自动定向到对应的数据库，达到自动 Change 切换数据库目的</span>
fsql<span>.</span>EntitySteering <span>=</span> <span>(</span>_<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>switch</span> <span>(</span>e<span>.</span>MethodName<span>)</span>
    <span>{</span>
        <span>case</span> <span>"Select"</span><span>:</span>
            <span>if</span> <span>(</span>e<span>.</span>EntityType <span>==</span> <span>typeof</span><span>(</span><span>T</span><span>)</span><span>)</span>
            <span>{</span>
                <span>//查询 T 自动定向 db3</span>
                e<span>.</span>DBKey <span>=</span> DbEnum<span>.</span>db3<span>;</span>
            <span>}</span>
            <span>else</span> <span>if</span> <span>(</span>e<span>.</span>DBKey <span>==</span> DbEnum<span>.</span>db1<span>)</span>
            <span>{</span>
                <span>//此处像不像读写分离？</span>
                <span><span>var</span></span> dbkeyIndex <span>=</span> <span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>0</span><span>,</span> e<span>.</span>AvailableDBKeys<span>.</span>Length<span>)</span><span>;</span>
                e<span>.</span>DBKey <span>=</span> e<span>.</span>AvailableDBKeys<span>[</span>dbkeyIndex<span>]</span><span>;</span> <span>//重新定向到其他 db</span>
            <span>}</span>
            <span>break</span><span>;</span>
        <span>case</span> <span>"Insert"</span><span>:</span>
        <span>case</span> <span>"Update"</span><span>:</span>
        <span>case</span> <span>"Delete"</span><span>:</span>
        <span>case</span> <span>"InsertOrUpdate"</span><span>:</span>
            <span>break</span><span>;</span>
    <span>}</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="参考" tabindex="-1"> 参考</h2>
<p><a href="https://github.com/dotnetcore/FreeSql/issues/44" target="_blank" rel="noopener noreferrer">多个 IFreeSql 实例，如何注入使用？ · Issue #44 · dotnetcore/FreeSql (github.com)</a></p>
]]></content>
    <published>2022-06-23T16:16:24.000Z</published>
  </entry>
  <entry>
    <title type="html">支持我们</title>
    <id>https://freesql.net/reference/service-support.html</id>
    <link href="https://freesql.net/reference/service-support.html"/>
    <updated>2022-09-07T04:16:40.000Z</updated>
    <content type="html"><![CDATA[<h1 id="支持我们" tabindex="-1"> 支持我们</h1>
<p>FreeSql 采用 MIT 最宽松的开源协议，永久免费开源。任何公司或个人，都可以使用在任何商业项目中。</p>
<p>QQ 技术群：4336577(满员)、8578575(满员)、52508226(满员)、反馈问题请前往 <a href="https://github.com/dotnetcore/FreeSql/issues" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/issues</a></p>
<h2 id="💕-自愿捐赠" tabindex="-1"> 💕 自愿捐赠</h2>
<p>L*y 58 元、花花 88 元、麦兜很乖 50 元、网络来者 2000 元、John 99.99 元、alex 666 元、bacongao 36 元、无名 100 元、Eternity 188 元、无名 10 元、⌒.Helper~..oO 66 元、习惯与被习惯 100 元、无名 100 元、蔡易喋 88.88 元、中讯科技 1000 元、Good Good Work 24 元、炽焰 6.6 元、Nothing 100 元、兰州天擎赵 500 元、哈利路亚 300 元、
无名 100 元、蛰伏 99.99 元、TCYM 66.66 元、MOTA 5 元、LDZXG 30 元、Near 30 元、建爽 66 元、无名 200 元、LambertWu 100 元、无名 18.88 元、乌龙 50 元、无名 100 元、陳怼怼 66.66 元、陳怼怼 66.66 元、丁淮 100 元、李伟坚-Excel 催化剂 100 元、白狐 6.66 元、她微笑的脸 y 30 元、Eternity²º²¹ 588 元、夜归柴门 88 元、蔡易喋 666.66 元、
<em>礼 10 元、litrpa 88 元、Alax CHOW 200 元、Daily 66 元、k</em>t 66 元、蓝 100 元、*菜 10 元、生命如歌 1000 元、山鸡 88元、平凡 100元、大树 1000元、软软的毛毛虫 66.66</p>
<blockquote>
<p>超级感谢你的打赏。</p>
</blockquote>
<ul>
<li>
<p><a href="https://www.cnblogs.com/FreeSql/gallery/image/338860.html" target="_blank" rel="noopener noreferrer">Alipay</a></p>
</li>
<li>
<p><a href="https://www.cnblogs.com/FreeSql/gallery/image/338859.html" target="_blank" rel="noopener noreferrer">WeChat</a></p>
</li>
</ul>
<h2 id="🌳-有偿服务" tabindex="-1"> 🌳 有偿服务</h2>
<table>
<thead>
<tr>
<th>服务项目</th>
<th>描述</th>
<th>价格(RMB)</th>
<th>付款方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>FreeSql 技术支持(企业)</td>
<td>对企业遇到任何 FreeSql 问题，提供远程协助或紧急功能支持</td>
<td>5000/年</td>
<td>寄发票后付款</td>
</tr>
<tr>
<td>.NET 外包项目</td>
<td>价格不低于 5 万，走公司合同</td>
<td>面议</td>
<td>按合同付款</td>
</tr>
</tbody>
</table>
<p>联系方式</p>
<p>QQ：2881099</p>
<p>Weixin：q2881099</p>
<blockquote>
<p>开源不易，未来营造，感恩有你，伴我同行</p>
</blockquote>
]]></content>
    <published>2022-05-25T15:18:32.000Z</published>
  </entry>
  <entry>
    <title type="html">FreeSql.Provider.SqliteCore</title>
    <id>https://freesql.net/guide/freesql-provider-sqlitecore.html</id>
    <link href="https://freesql.net/guide/freesql-provider-sqlitecore.html"/>
    <updated>2022-08-10T01:25:50.000Z</updated>
    <content type="html"><![CDATA[<h1 id="freesql-provider-sqlitecore" tabindex="-1"> FreeSql.Provider.SqliteCore</h1>
<p>FreeSql.Provider.SqliteCore是<code>FreeSql</code>基于微软提供的最新的<a href="https://docs.microsoft.com/zh-cn/dotnet/standard/data/sqlite/?tabs=netcore-cli" target="_blank" rel="noopener noreferrer"><code>Microsoft.Data.Sqlite.Core</code></a>驱动的实现。
<strong>需要另外安装对应的bundle_xxx</strong>实现加密。</p>
<h2 id="支持的版本" tabindex="-1"> 支持的版本</h2>
<ul>
<li>.NET Standard 2.0（<a href="http://xn--ruu81c.NET" target="_blank" rel="noopener noreferrer">支持.NET</a> Framework4.6.1+/支持.NET Core 2.0+）</li>
<li>net6.0</li>
<li>SQLite（3.7 及以上版本）</li>
<li>Linux ARM/X86/MAUI Android/MAUI iOS等</li>
</ul>
<p>安装<code>FreeSql.Provider.SqliteCore</code>包。</p>
<div><pre><code>dotnet add package FreeSql.Provider.SqliteCore
dotnet add package SQLitePCLRaw.bundle_e_sqlite3
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p><code>SQLitePCLRaw.bundle_e_sqlite3</code> 不支持加密，但此方式是官方实现的<code>SQlite</code>版本，以下二选一：</p>
<table>
<thead>
<tr>
<th>捆绑</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SQLitePCLRaw.bundle_e_sqlite3</td>
<td>在所有平台上提供一致版本的 <code>SQLite</code>。 包括 FTS4、FTS5、JSON1 和 R* 树扩展。 建议使用</td>
</tr>
<tr>
<td>SQLitePCLRaw.bundle_e_sqlcipher</td>
<td>提供 <code>SQLCipher</code> 的非官方开放源代码内部版本，<strong>支持加密</strong>。</td>
</tr>
</tbody>
</table>
<h2 id="只有-sqlitepclraw-bundle-e-sqlcipher-才支持加密" tabindex="-1"> 只有 <strong>SQLitePCLRaw.bundle_e_sqlcipher</strong> 才支持加密</h2>
<p>0.选择一个目录，创建一个控制台项目<code>OvOv.FreeSqlMicrosoftSqliteCore</code></p>
<div><pre><code>dotnet new console -n OvOv.FreeSqlMicrosoftSqliteCore
cd OvOv.FreeSqlMicrosoftSqliteCore
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>1.安装包</p>
<div><pre><code>dotnet <span>add</span> package FreeSql.Provider.SqliteCore
dotnet <span>add</span> package SQLitePCLRaw.bundle_e_sqlcipher
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ol start="2">
<li>连接串直接指定Password=xxx即可</li>
</ol>
<p>创建一个类<code>DB.cs</code>,可直接通过<code>DB.sqlite</code>访问到<code>IFreeSql</code>对象</p>
<div><pre><code><span>public</span> <span>class</span> <span>DB</span>
<span>{</span>
    <span>static</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span> sqliteLazy <span>=</span> <span>new</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span><span>(</span><span>(</span><span>)</span> <span>=></span>
    <span>{</span>
        <span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
                <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=local.db;Password=123qwe"</span><span>)</span>
                <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
                <span>.</span><span>UseLazyLoading</span><span>(</span><span>true</span><span>)</span>
                <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Trace<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
                <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
        <span>return</span> fsql<span>;</span>
    <span>}</span>
   <span>)</span><span>;</span>
    <span>public</span> <span>static</span> <span>IFreeSql</span> sqlite <span>=></span> sqliteLazy<span>.</span>Value<span>;</span>
<span>}</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>测试加密,增加一些数据。<code>Program.cs</code>中测试</p>
<div><pre><code><span>Test</span><span>(</span><span>)</span><span>;</span>

<span>static</span> <span><span>void</span></span> <span>Test</span><span>(</span><span>)</span>
<span>{</span>
    <span>IInsert<span>&lt;</span>Topic<span>></span></span> insert <span>=</span> DB<span>.</span>sqlite<span>.</span><span><span>Insert</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> items <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span><span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span> a <span>&lt;</span> <span>10</span><span>;</span> a<span>++</span><span>)</span> items<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> a <span>+</span> <span>1</span><span>,</span> Title <span>=</span> <span><span>$"newTitle</span><span><span>{</span><span>a</span><span>}</span></span><span>"</span></span><span>,</span> Clicks <span>=</span> a <span>*</span> <span>100</span> <span>}</span><span>)</span><span>;</span>

    <span><span>var</span></span> affrows <span>=</span> insert<span>.</span><span>AppendData</span><span>(</span>items<span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
    Console<span>.</span><span>WriteLine</span><span>(</span><span>"affrows："</span> <span>+</span> affrows<span>)</span><span>;</span>
    <span><span>var</span></span> list <span>=</span> DB<span>.</span>sqlite<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    Console<span>.</span><span>WriteLine</span><span>(</span><span>"count："</span> <span>+</span> list<span>.</span>Count<span>)</span><span>;</span>
<span>}</span>

<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"tb_topic_insert"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>Topic</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>运行项目</p>
<div><pre><code>dotnet run
</code></pre><div aria-hidden="true"><div></div></div></div><h3 id="验证是否登录是否加密" tabindex="-1"> 验证是否登录是否加密？</h3>
<p>重新运行时，删除 连接串中的Password,发现无法获取数据。或使用<code>Navicat Premium</code>工具发现无法连接。</p>
<div><pre><code><span><span>+</span><span> .UseConnectionString(FreeSql.DataType.Sqlite, @"Data Source=local.db;") 
</span></span><span><span>-</span><span> .UseConnectionString(FreeSql.DataType.Sqlite, @"Data Source=|DataDirectory|local.db;Password=123qwe")
</span></span></code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>提示如下内容，但使用密码时又能正常访问数据。</p>
<div><pre><code>SqliteException: SQLite Error 26: 'file is not a database'.
</code></pre><div aria-hidden="true"><div></div></div></div><p>相比包 <code>FreeSql.Provider.Sqlite</code>来说，目前存在一些限制，</p>
<h4 id="datadirectory-默认不支持" tabindex="-1"> |DataDirectory| 默认不支持</h4>
<p>需要使用前，指定具体的文件夹，此处相当于指定了当前<code>dll</code>所在目录，即<code>bin/Debug/net6.0</code>。参考</p>
<div><pre><code><span><span>string</span></span> dataSubDirectory <span>=</span> Path<span>.</span><span>Combine</span><span>(</span>AppContext<span>.</span>BaseDirectory<span>)</span><span>;</span>

<span>if</span> <span>(</span><span>!</span>Directory<span>.</span><span>Exists</span><span>(</span>dataSubDirectory<span>)</span><span>)</span>
    Directory<span>.</span><span>CreateDirectory</span><span>(</span>dataSubDirectory<span>)</span><span>;</span>

AppDomain<span>.</span>CurrentDomain<span>.</span><span>SetData</span><span>(</span><span>"DataDirectory"</span><span>,</span> dataSubDirectory<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>即</p>
<div><pre><code><span>public</span> <span>class</span> <span>DB</span>
<span>{</span>
    <span>static</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span> sqliteLazy <span>=</span> <span>new</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span><span>(</span><span>(</span><span>)</span> <span>=></span>
    <span>{</span>
        <span><span>string</span></span> dataSubDirectory <span>=</span> Path<span>.</span><span>Combine</span><span>(</span>AppContext<span>.</span>BaseDirectory<span>)</span><span>;</span>

        <span>if</span> <span>(</span><span>!</span>Directory<span>.</span><span>Exists</span><span>(</span>dataSubDirectory<span>)</span><span>)</span>
            Directory<span>.</span><span>CreateDirectory</span><span>(</span>dataSubDirectory<span>)</span><span>;</span>

        AppDomain<span>.</span>CurrentDomain<span>.</span><span>SetData</span><span>(</span><span>"DataDirectory"</span><span>,</span> dataSubDirectory<span>)</span><span>;</span>

        <span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
                <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=|DataDirectory|local.db;Password=123qwe"</span><span>)</span>
                <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
                <span>.</span><span>UseLazyLoading</span><span>(</span><span>true</span><span>)</span>
                <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Trace<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
                <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>

        <span>return</span> fsql<span>;</span>
    <span>}</span>
   <span>)</span><span>;</span>
    <span>public</span> <span>static</span> <span>IFreeSql</span> sqlite <span>=></span> sqliteLazy<span>.</span>Value<span>;</span>
<span>}</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>具体的链接串，请参考  <a href="https://docs.microsoft.com/zh-cn/dotnet/standard/data/sqlite/connection-strings" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/zh-cn/dotnet/standard/data/sqlite/connection-strings</a></p>
<h4 id="数学函数" tabindex="-1"> 数学函数</h4>
<p>如下函数不支持</p>
<ul>
<li>Floor</li>
<li>Ceiling</li>
<li>Log10</li>
<li>Pow</li>
<li>Sqrt</li>
<li>Cos</li>
</ul>
<h4 id="timespantest" tabindex="-1"> TimeSpanTest</h4>
<p>测试 类中 不通过、ulong最大值，最小值，超出范围。</p>
<ul>
<li>不支持</li>
</ul>
<div><pre><code>  <span>public</span> <span><span>void</span></span> <span>Days</span><span>(</span><span>)</span>
  <span>{</span>
      <span><span>var</span></span> data <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
      data<span>.</span><span>Add</span><span>(</span><span>select</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span>TimeOfDay<span>.</span>Days <span>==</span> <span>0</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>
  <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>不支持</li>
</ul>
<div><pre><code> <span>public</span> <span><span>void</span></span> <span>Minutes</span><span>(</span><span>)</span>
  <span>{</span>
      <span><span>var</span></span> data <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
      data<span>.</span><span>Add</span><span>(</span><span>select</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span>TimeOfDay<span>.</span>Minutes <span>></span> <span>0</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>
  <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h4 id="完整代码" tabindex="-1"> 完整代码</h4>
<ul>
<li><a href="https://github.com/luoyunchong/dotnetcore-examples/blob/master/Database-Drivers/OvOv.FreeSqlMicrosoftSqliteCore/Program.cs" target="_blank" rel="noopener noreferrer">https://github.com/luoyunchong/dotnetcore-examples/blob/master/Database-Drivers/OvOv.FreeSqlMicrosoftSqliteCore/Program.cs</a></li>
</ul>
<h2 id="ios" tabindex="-1"> iOS</h2>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/standard/data/sqlite/xamarin#ios" target="_blank" rel="noopener noreferrer">https://docs.microsoft.com/zh-cn/dotnet/standard/data/sqlite/xamarin#ios</a></p>
<p><code>Microsoft.Data.Sqlite</code> 尝试自动初始化 <code>SQLitePCLRaw</code> 捆绑。 遗憾的是，由于针对 <code>Xamarin.iOS</code> 的预先 (AOT) 编译存在限制，因此尝试失败，并出现以下错误。</p>
<blockquote>
<p>需要调用 <code>SQLitePCL.raw.SetProvider()</code>。 如果使用的是捆绑包，可以通过调用 <code>SQLitePCL.Batteries.Init()</code> 来完成此操作。</p>
</blockquote>
<p>若要初始化该绑定，请在使用 <code>Microsoft.Data.Sqlite</code> 之前，将以下代码行添加到应用。</p>
<div><pre><code>SQLitePCL<span>.</span>Batteries_V2<span>.</span><span>Init</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>即在上方定义<code>FreeSql</code>单例时，在<code>new Lazy</code>内，调用一次即可。</p>
<h2 id="net-framework-支持" tabindex="-1"> .NET Framework 支持</h2>
<ul>
<li>.NETStandard2.0（<a href="http://xn--ruu81c.NET" target="_blank" rel="noopener noreferrer">支持.NET</a> Framework4.6.1+）</li>
</ul>
<p><a href="http://xn--4kqq21c2rb0po6cq3p7tx.NET" target="_blank" rel="noopener noreferrer">有二种方法支持.NET</a> Framework(选择其中一个即可)</p>
<h3 id="_1-复制-net-core中的dll" tabindex="-1"> <a href="http://1.xn--xcrp0o.NET" target="_blank" rel="noopener noreferrer">1.复制.NET</a> Core中的dll</h3>
<p><a href="http://xn--4gqvd70lutr.NET" target="_blank" rel="noopener noreferrer">创建一个.NET</a> Core的console项目，然后安装nuget包 <code>SQLitePCLRaw.bundle_e_sqlcipher</code>，编译后生成的<code>bin\Debug\net5.0\runtimes\win-x64\native\e_sqlcipher.dll</code>
复制到 .net framework 4.8的项目中<code>bin/Debug/e_sqlcipher.dll</code>中</p>
<h3 id="_2-转换项目-建议" tabindex="-1"> 2.转换项目 <strong>（建议）</strong></h3>
<p>先安装好相关的包,然后右键<code>packages.config</code>,选择将<code>packages.config 迁移到PackageReference中</code>,弹出的框勾选所有包，确定即可。</p>
<div><pre><code>Install-Package SQLitePCLRaw.bundle_e_sqlcipher
Install-Package FreeSql.Provider.SqliteCore
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p><img src="@source/guide/images/dotnetframwork-sqlitecore.png" alt="./images/dotnetframwork-sqlitecore.png" loading="lazy"></p>
]]></content>
    <published>2022-03-25T06:41:57.000Z</published>
  </entry>
  <entry>
    <title type="html">UnitOfWorkManager 事务 ✨</title>
    <id>https://freesql.net/guide/unitofwork-manager.html</id>
    <link href="https://freesql.net/guide/unitofwork-manager.html"/>
    <updated>2022-09-04T08:53:21.000Z</updated>
    <content type="html"><![CDATA[<h1 id="unitofworkmanager-事务-✨" tabindex="-1"> UnitOfWorkManager 事务 ✨</h1>
<p>本篇文章内容引导，如何在 <a href="http://asp.net" target="_blank" rel="noopener noreferrer">asp.net</a> core 项目中使用特性(注解) 的方式管理事务。</p>
<blockquote>
<p>UnitOfWorkManager 只可以管理 Repository 仓储对象的事务，直接 fsql.Insert&lt;T&gt;() 是不行的！！但是可以用 repository.Orm.Insert&lt;T&gt;！！repository.Orm 是特殊实现的 IFreeSql，与 当前事务保持一致。</p>
</blockquote>
<p>支持六种传播方式(propagation)，意味着跨方法的事务非常方便，并且支持同步异步：</p>
<ul>
<li>Requierd：如果当前没有事务，就新建一个事务，如果已存在一个事务中，加入到这个事务中，默认的选择。</li>
<li>Supports：支持当前事务，如果没有当前事务，就以非事务方法执行。</li>
<li>Mandatory：使用当前事务，如果没有当前事务，就抛出异常。</li>
<li>NotSupported：以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</li>
<li>Never：以非事务方式执行操作，如果当前事务存在则抛出异常。</li>
<li>Nested：以嵌套事务方式执行。</li>
</ul>
<h2 id="第一步-引入动态代理库" tabindex="-1"> 第一步：引入动态代理库</h2>
<blockquote>
<p>肉夹馍：<a href="https://github.com/inversionhourglass/Rougamo" target="_blank" rel="noopener noreferrer">https://github.com/inversionhourglass/Rougamo</a></p>
</blockquote>
<blockquote>
<p>dotnet add package Rougamo.Fody</p>
</blockquote>
<div><pre><code><span>[</span><span><span>AttributeUsage</span><span><span>(</span>AttributeTargets<span>.</span>Method<span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>TransactionalAttribute</span> <span>:</span> <span><span>Rougamo<span>.</span>MoAttribute</span></span>
<span>{</span>
    <span>public</span> <span>Propagation</span> Propagation <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> Propagation<span>.</span>Required<span>;</span>
    <span>public</span> <span>IsolationLevel</span> IsolationLevel <span>{</span> <span>get</span> <span>=></span> m_IsolationLevel<span>.</span>Value<span>;</span> <span>set</span> <span>=></span> m_IsolationLevel <span>=</span> <span>value</span><span>;</span> <span>}</span>
    <span>IsolationLevel<span>?</span></span> m_IsolationLevel<span>;</span>

    <span>static</span> <span>AsyncLocal<span>&lt;</span>IServiceProvider<span>></span></span> m_ServiceProvider <span>=</span> <span>new</span> <span>AsyncLocal<span>&lt;</span>IServiceProvider<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>public</span> <span>static</span> <span><span>void</span></span> <span>SetServiceProvider</span><span>(</span><span>IServiceProvider</span> serviceProvider<span>)</span> <span>=></span> m_ServiceProvider<span>.</span>Value <span>=</span> serviceProvider<span>;</span>

    <span>IUnitOfWork</span> _uow<span>;</span>
    <span>public</span> <span>override</span> <span><span>void</span></span> <span>OnEntry</span><span>(</span><span>MethodContext</span> context<span>)</span>
    <span>{</span>
        <span><span>var</span></span> uowManager <span>=</span> m_ServiceProvider<span>.</span>Value<span>.</span><span><span>GetService</span><span><span>&lt;</span>UnitOfWorkManager<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        _uow <span>=</span> uowManager<span>.</span><span>Begin</span><span>(</span><span>this</span><span>.</span>Propagation<span>,</span> <span>this</span><span>.</span>m_IsolationLevel<span>)</span><span>;</span>
    <span>}</span>
    <span>public</span> <span>override</span> <span><span>void</span></span> <span>OnExit</span><span>(</span><span>MethodContext</span> context<span>)</span>
    <span>{</span>
        <span>if</span> <span>(</span><span>typeof</span><span>(</span><span>Task</span><span>)</span><span>.</span><span>IsAssignableFrom</span><span>(</span>context<span>.</span>RealReturnType<span>)</span><span>)</span>
            <span>(</span><span>(</span>Task<span>)</span>context<span>.</span>ReturnValue<span>)</span><span>.</span><span>ContinueWith</span><span>(</span>t <span>=></span> <span>_OnExit</span><span>(</span><span>)</span><span>)</span><span>;</span>
        <span>else</span> <span>_OnExit</span><span>(</span><span>)</span><span>;</span>

        <span><span>void</span></span> <span>_OnExit</span><span>(</span><span>)</span>
        <span>{</span>
            <span>try</span>
            <span>{</span>
                <span>if</span> <span>(</span>context<span>.</span>Exception <span>==</span> <span>null</span><span>)</span> _uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
                <span>else</span> _uow<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
            <span>finally</span>
            <span>{</span>
                _uow<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>UnitOfWorkManager 成员</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>IUnitOfWork Current</td>
<td>返回当前的工作单元</td>
</tr>
<tr>
<td>void Binding(repository)</td>
<td>将仓储的事务交给它管理</td>
</tr>
<tr>
<td>IUnitOfWork Begin(propagation, isolationLevel)</td>
<td>创建工作单元</td>
</tr>
</tbody>
</table>
<h2 id="第二步-配置-startup-cs-注入、中间件" tabindex="-1"> 第二步：配置 Startup.cs 注入、中间件</h2>
<div><pre><code><span>//Startup.cs</span>
<span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
    services<span>.</span><span><span>AddScoped</span><span><span>&lt;</span>UnitOfWorkManager<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    services<span>.</span><span>AddFreeRepository</span><span>(</span><span>null</span><span>,</span> <span>typeof</span><span>(</span><span>Startup</span><span>)</span><span>.</span>Assembly<span>)</span><span>;</span>
   <span>//批量注入 Service</span>
<span>}</span>

<span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>
<span>{</span>
    app<span>.</span><span>Use</span><span>(</span><span>async</span> <span>(</span>context<span>,</span> next<span>)</span> <span>=></span>
    <span>{</span>
        TransactionalAttribute<span>.</span><span>SetServiceProvider</span><span>(</span>context<span>.</span>RequestServices<span>)</span><span>;</span>
        <span>await</span> <span>next</span><span>(</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="第三步-在-controller-或者-service-或者-repository-中使用事务特性" tabindex="-1"> 第三步：在 Controller 或者 Service 或者 Repository 中使用事务特性</h2>
<div><pre><code><span>public</span> <span>class</span> <span>SongService</span>
<span>{</span>
    <span>readonly</span> <span>IBaseRepository<span>&lt;</span>Song<span>></span></span> _repoSong<span>;</span>
    <span>readonly</span> <span>IBaseRepository<span>&lt;</span>Detail<span>></span></span> _repoDetail<span>;</span>
    <span>readonly</span> <span>ISongRepository</span> _repoSong2<span>;</span>

    <span>public</span> <span>SongService</span><span>(</span><span>IBaseRepository<span>&lt;</span>Song<span>></span></span> repoSong<span>,</span> <span>IBaseRepository<span>&lt;</span>Detail<span>></span></span> repoDetail<span>,</span> <span>ISongRepository</span> repoSong2<span>)</span>
    <span>{</span>
        _repoSong <span>=</span> repoSong<span>;</span>
        _repoDetail <span>=</span> repoDetail<span>;</span>
        _repoSong2 <span>=</span> repoSong2<span>;</span>
    <span>}</span>

    <span>[</span><span><span>Transactional</span></span><span>]</span>
    <span>public</span> <span>virtual</span> <span><span>void</span></span> <span>Test1</span><span>(</span><span>)</span>
    <span>{</span>
        <span>//这里 _repoSong、_repoDetail、_repoSong2 所有操作都是一个工作单元</span>
        <span>this</span><span>.</span><span>Test2</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>

    <span>[</span><span><span>Transactional</span><span><span>(</span>Propagation <span>=</span> Propagation<span>.</span>Nested<span>)</span></span></span><span>]</span>
    <span>public</span> <span>virtual</span> <span><span>void</span></span> <span>Test2</span><span>(</span><span>)</span> <span>//嵌套事务，新的（不使用 Test1 的事务）</span>
    <span>{</span>
        <span>//这里 _repoSong、_repoDetail、_repoSong2 所有操作都是一个工作单元</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>是不是进方法就开事务呢？</p>
<p>不一定是真实事务，有可能是虚的，就是一个假的 unitofwork（不带事务）</p>
<p>也有可能是延用上一次的事务</p>
<p>也有可能是新开事务，具体要看传播模式</p>
<h2 id="重写仓储实现" tabindex="-1"> 重写仓储实现</h2>
<p>以上使用的是泛型仓储，那我们如果是重写一个仓储 如何保持和<code>UnitOfWorkManager</code>同一个事务呢。
继承现有的<code>DefaultRepository&lt;,&gt;</code>仓储，实现自定义的仓储<code>SongRepository.cs</code>,</p>
<div><pre><code><span>public</span> <span>class</span> <span>SongRepository</span> <span>:</span> <span><span>DefaultRepository<span>&lt;</span>Song<span>,</span> <span>int</span><span>></span></span><span>,</span> <span>ISongRepository</span></span>
<span>{</span>
    <span>public</span> <span>SongRepository</span><span>(</span><span>UnitOfWorkManager</span> uowm<span>)</span> <span>:</span> <span>base</span><span>(</span>uowm<span>?.</span>Orm<span>,</span> uowm<span>)</span>
    <span>{</span>
    <span>}</span>
    <span>public</span> <span>List<span>&lt;</span>Song<span>></span></span> <span>GetSongs</span><span>(</span><span>)</span>
    <span>{</span>
        <span>return</span> Select<span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>其中接口。<code>ISongRepository.cs</code></p>
<div><pre><code><span>public</span> <span>interface</span> <span>ISongRepository</span> <span>:</span> <span><span>IBaseRepository<span>&lt;</span>Song<span>,</span> <span>int</span><span>></span></span></span>
<span>{</span>
    <span>List<span>&lt;</span>Song<span>></span></span> <span>GetSongs</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>在 startup.cs 注入此服务</p>
<div><pre><code>services<span>.</span><span><span>AddScoped</span><span><span>&lt;</span>ISongRepository<span>,</span> SongRepository<span>></span></span></span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><hr>
<h2 id="freesql-cloud-如何使用-unitofworkmanager" tabindex="-1"> FreeSql.Cloud 如何使用 UnitOfWorkManager？</h2>
<p>注意：如果是<a href="/guide/multi-tenancy.html#%E6%96%B9%E6%A1%88%E4%B8%89-%E6%8C%89%E7%A7%9F%E6%88%B7%E5%88%86%E5%BA%93">多租户分库场景</a>，请直接使用上面的方案，多租户同一请求大部分都只操作一个数据库，只需要提前将 FreeSqlCloud 对象 Change 切换好。</p>
<hr>
<p>以 DbEnum 为例定义 FreeSqlCloud 对象如下：</p>
<div><pre><code><span>public</span> <span>enum</span> <span>DbEnum</span> <span>{</span> db1<span>,</span> db2 <span>}</span>
<span>public</span> <span>class</span> <span>FreeSqlCloud</span> <span>:</span> <span><span>FreeSqlCloud<span>&lt;</span>DbEnum<span>></span></span></span> <span>//DbEnum 换成 string 就是多租户管理</span>
<span>{</span>
    <span>public</span> <span>FreeSqlCloud</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>null</span><span>)</span> <span>{</span> <span>}</span>
    <span>public</span> <span>FreeSqlCloud</span><span>(</span><span><span>string</span></span> distributeKey<span>)</span> <span>:</span> <span>base</span><span>(</span>distributeKey<span>)</span> <span>{</span> <span>}</span>
<span>}</span>

<span>public</span> <span>static</span> <span>FreeSqlCloud</span> Cloud <span>=</span> <span>new</span> <span>..</span><span>.</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>最终呈现的 AOP 事务代码如下：</p>
<div><pre><code><span>class</span> <span>UserRepository</span> <span>:</span> <span><span>RepositoryCloud<span>&lt;</span>User<span>></span></span><span>,</span> <span>IBaseRepository<span>&lt;</span>User<span>></span></span></span>
<span>{</span>
    <span>public</span> <span>UserRepository</span><span>(</span><span>UnitOfWorkManagerCloud</span> uowm<span>)</span> <span>:</span> <span>base</span><span>(</span>DbEnum<span>.</span>db3<span>,</span> uowm<span>)</span> <span>{</span> <span>}</span>
<span>}</span>

<span>class</span> <span>UserService</span> <span>:</span> <span><span>IUserService</span></span>
<span>{</span>
    <span>readonly</span> <span>IBaseRepository<span>&lt;</span>User<span>></span></span> m_repo1<span>;</span>
    <span>readonly</span> <span>BaseRepository<span>&lt;</span>User<span>></span></span> m_repo2<span>;</span>
    <span>readonly</span> <span>UserRepository</span> m_repo3<span>;</span>
    <span>public</span> <span>UserService</span><span>(</span><span>IBaseRepository<span>&lt;</span>User<span>></span></span> repo1<span>,</span> <span>BaseRepository<span>&lt;</span>User<span>></span></span> repo2<span>,</span> <span>UserRepository</span> repo3<span>)</span>
    <span>{</span>
        m_repo1 <span>=</span> repo1<span>;</span> <span>//db1</span>
        m_repo2 <span>=</span> repo2<span>;</span> <span>//db1</span>
        m_repo3 <span>=</span> repo3<span>;</span> <span>//db3</span>
    <span>}</span>

    <span>[</span><span><span>Transactional</span><span><span>(</span>DbEnum<span>.</span>db1<span>)</span></span></span><span>]</span>
    <span>[</span><span><span>Transactional</span><span><span>(</span>DbEnum<span>.</span>db3<span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>void</span></span> <span>Test01</span><span>(</span><span>)</span>
    <span>{</span>
        Console<span>.</span><span>WriteLine</span><span>(</span><span>"xxx"</span><span>)</span><span>;</span> <span>//debugger</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>约定好 IBaseRepository&lt;T&gt; 默认是 db1 的仓储实现，注入如下：</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    services<span>.</span><span>AddSingleton</span><span>(</span>Cloud<span>)</span><span>;</span> <span>//注入 FreeSqlCloud</span>
    services<span>.</span><span>AddSingleton</span><span>(</span>provider <span>=></span> Cloud<span>.</span><span>Use</span><span>(</span>DbEnum<span>.</span>db1<span>)</span><span>)</span><span>;</span> <span>//注入 IFreeSql</span>
    services<span>.</span><span><span>AddScoped</span><span><span>&lt;</span>UnitOfWorkManagerCloud<span>></span></span></span><span>(</span><span>)</span><span>;</span>

    services<span>.</span><span>AddScoped</span><span>(</span><span>typeof</span><span>(</span><span>IBaseRepository<span>&lt;</span><span>></span></span><span>)</span><span>,</span> <span>typeof</span><span>(</span><span>RepositoryCloud<span>&lt;</span><span>></span></span><span>)</span><span>)</span><span>;</span> <span>//default: db1</span>
    <span>foreach</span> <span>(</span><span><span>var</span></span> repositoryType <span>in</span> <span>typeof</span><span>(</span><span>User</span><span>)</span><span>.</span>Assembly<span>.</span><span>GetTypes</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>IsAbstract <span>==</span> <span>false</span> <span>&amp;&amp;</span> <span>typeof</span><span>(</span><span>IBaseRepository</span><span>)</span><span>.</span><span>IsAssignableFrom</span><span>(</span>a<span>)</span><span>)</span><span>)</span>
        services<span>.</span><span>AddScoped</span><span>(</span>repositoryType<span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>UnitOfWorkManagerCloud、RepositoryCloud、TransactionalAttribute 是我们需要实现的部分：</p>
<div><pre><code><span>class</span> <span>UnitOfWorkManagerCloud</span>
<span>{</span>
    <span>readonly</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> UnitOfWorkManager<span>></span></span> m_managers <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> UnitOfWorkManager<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>readonly</span> <span>FreeSqlCloud</span> m_cloud<span>;</span>
    <span>public</span> <span>UnitOfWorkManagerCloud</span><span>(</span><span>FreeSqlCloud</span> cloud<span>)</span>
    <span>{</span>
        m_cloud <span>=</span> cloud<span>;</span>
    <span>}</span>
    
    <span>public</span> <span>UnitOfWorkManager</span> <span>GetUnitOfWorkManager</span><span>(</span><span><span>string</span></span> db<span>)</span>
    <span>{</span>
        <span>if</span> <span>(</span>m_managers<span>.</span><span>TryGetValue</span><span>(</span>db<span>,</span> <span>out</span> <span><span>var</span></span> uowm<span>)</span> <span>==</span> <span>false</span><span>)</span>
            m_managers<span>.</span><span>Add</span><span>(</span>db<span>,</span> uowm <span>=</span> <span>new</span> <span>UnitOfWorkManager</span><span>(</span>m_cloud<span>.</span><span>Use</span><span>(</span>db<span>)</span><span>)</span><span>)</span><span>;</span>
        <span>return</span> uowm<span>;</span>
    <span>}</span>

    <span>public</span> <span><span>void</span></span> <span>Dispose</span><span>(</span><span>)</span>
    <span>{</span>
        <span>foreach</span><span>(</span><span><span>var</span></span> uowm <span>in</span> m_managers<span>.</span>Values<span>)</span> uowm<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
        m_managers<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span>IUnitOfWork</span> <span>Begin</span><span>(</span><span><span>string</span></span> db<span>,</span> <span>Propagation</span> propagation <span>=</span> Propagation<span>.</span>Required<span>,</span> <span>IsolationLevel<span>?</span></span> isolationLevel <span>=</span> <span>null</span><span>)</span>
    <span>{</span>
        <span>return</span> <span>GetUnitOfWorkManager</span><span>(</span>db<span>)</span><span>.</span><span>Begin</span><span>(</span>propagation<span>,</span> isolationLevel<span>)</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>class</span> <span>RepositoryCloud<span>&lt;</span>T<span>></span></span> <span>:</span> <span><span>DefaultRepository<span>&lt;</span>T<span>,</span> <span>int</span><span>></span></span></span> <span>where</span> <span>T</span> <span>:</span> <span><span>class</span></span>
<span>{</span>
    <span>public</span> <span>RepositoryCloud</span><span>(</span><span>UnitOfWorkManagerCloud</span> uomw<span>)</span> <span>:</span> <span>this</span><span>(</span>DbEnum<span>.</span>db1<span>,</span> uomw<span>)</span> <span>{</span> <span>}</span> <span>//DI</span>
    <span>public</span> <span>RepositoryCloud</span><span>(</span><span>DbEnum</span> db<span>,</span> <span>UnitOfWorkManagerCloud</span> uomw<span>)</span> <span>:</span> <span>this</span><span>(</span>uomw<span>.</span><span>GetUnitOfWorkManager</span><span>(</span>db<span>.</span><span>ToString</span><span>(</span><span>)</span><span>)</span><span>)</span> <span>{</span> <span>}</span>
    <span>RepositoryCloud</span><span>(</span><span>UnitOfWorkManager</span> uomw<span>)</span> <span>:</span> <span>base</span><span>(</span>uomw<span>.</span>Orm<span>,</span> uomw<span>)</span>
    <span>{</span>
        uomw<span>.</span><span>Binding</span><span>(</span><span>this</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>

<span>[</span><span><span>AttributeUsage</span><span><span>(</span>AttributeTargets<span>.</span>Method<span>,</span> AllowMultiple <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>TransactionalAttribute</span> <span>:</span> <span><span>Rougamo<span>.</span>MoAttribute</span></span>
<span>{</span>
    <span>public</span> <span>Propagation</span> Propagation <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> Propagation<span>.</span>Required<span>;</span>
    <span>public</span> <span>IsolationLevel</span> IsolationLevel <span>{</span> <span>get</span> <span>=></span> m_IsolationLevel<span>.</span>Value<span>;</span> <span>set</span> <span>=></span> m_IsolationLevel <span>=</span> <span>value</span><span>;</span> <span>}</span>
    <span>IsolationLevel<span>?</span></span> m_IsolationLevel<span>;</span>
    <span>readonly</span> <span>DbEnum</span> m_db<span>;</span>

    <span>public</span> <span>TransactionalAttribute</span><span>(</span><span>DbEnum</span> db<span>)</span>
    <span>{</span>
        m_db <span>=</span> db<span>;</span>
    <span>}</span>

    <span>static</span> <span>AsyncLocal<span>&lt;</span>IServiceProvider<span>></span></span> m_ServiceProvider <span>=</span> <span>new</span> <span>AsyncLocal<span>&lt;</span>IServiceProvider<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>public</span> <span>static</span> <span><span>void</span></span> <span>SetServiceProvider</span><span>(</span><span>IServiceProvider</span> serviceProvider<span>)</span> <span>=></span> m_ServiceProvider<span>.</span>Value <span>=</span> serviceProvider<span>;</span>

    <span>IUnitOfWork</span> _uow<span>;</span>
    <span>public</span> <span>override</span> <span><span>void</span></span> <span>OnEntry</span><span>(</span><span>MethodContext</span> context<span>)</span>
    <span>{</span>
        <span><span>var</span></span> uowManager <span>=</span> m_ServiceProvider<span>.</span>Value<span>.</span><span><span>GetService</span><span><span>&lt;</span>UnitOfWorkManagerCloud<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        _uow <span>=</span> uowManager<span>.</span><span>Begin</span><span>(</span>m_db<span>,</span> <span>this</span><span>.</span>Propagation<span>,</span> <span>this</span><span>.</span>m_IsolationLevel<span>)</span><span>;</span>
    <span>}</span>
    <span>public</span> <span>override</span> <span><span>void</span></span> <span>OnExit</span><span>(</span><span>MethodContext</span> context<span>)</span>
    <span>{</span>
        <span>if</span> <span>(</span><span>typeof</span><span>(</span><span>Task</span><span>)</span><span>.</span><span>IsAssignableFrom</span><span>(</span>context<span>.</span>RealReturnType<span>)</span><span>)</span>
            <span>(</span><span>(</span>Task<span>)</span>context<span>.</span>ReturnValue<span>)</span><span>.</span><span>ContinueWith</span><span>(</span>t <span>=></span> <span>_OnExit</span><span>(</span><span>)</span><span>)</span><span>;</span>
        <span>else</span> <span>_OnExit</span><span>(</span><span>)</span><span>;</span>

        <span><span>void</span></span> <span>_OnExit</span><span>(</span><span>)</span>
        <span>{</span>
            <span>try</span>
            <span>{</span>
                <span>if</span> <span>(</span>context<span>.</span>Exception <span>==</span> <span>null</span><span>)</span> _uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
                <span>else</span> _uow<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
            <span>finally</span>
            <span>{</span>
                _uow<span>.</span><span>Dispose</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-08-21T05:59:59.000Z</published>
  </entry>
  <entry>
    <title type="html">IFreeSql 和 DbContext</title>
    <id>https://freesql.net/guide/ifreesql-context.html</id>
    <link href="https://freesql.net/guide/ifreesql-context.html"/>
    <updated>2022-09-04T08:51:00.000Z</updated>
    <content type="html"><![CDATA[<h1 id="ifreesql-和-dbcontext" tabindex="-1"> IFreeSql 和 DbContext</h1>
<h2 id="两者并存" tabindex="-1"> 两者并存</h2>
<p>FreeSql 支持 IFreeSql 和 DbContext 两种形式，使用方法差异也有些大，其中 DbContext 跟 EFCore 使用方式基本一致，使用简单、依赖注入方便。</p>
<p>而 IFreeSql 支持更多细粒度的操作。在 DbContext 中，要删除多个行记录，必须先查询实体后，再使用 <code>RemoveRange()</code> 删除这些实体，当数据量非常大的时候，便会消耗大量时间和性能。而 IFreeSql 中，支持嵌入部分 SQL ，支持细粒度的行记录操作。在 IFreeSql 中批量删除、修改记录，可以使用类似 SQL 的模式：</p>
<div><pre><code><span>await</span> _freesql<span>.</span><span><span>Update</span><span><span>&lt;</span>Roles<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Set</span><span>(</span>x <span>=></span> x<span>.</span>IsDeleted<span>,</span> <span>1</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>x <span>=></span>  x<span>.</span>TenantId <span>==</span> tenantId <span>)</span>
    <span>.</span><span>ExecuteAffrowsAsync</span><span>(</span><span>)</span><span>;</span>

update roles <span>set</span> is_deleted<span>=</span><span>1</span> <span>where</span> <span>where</span> tenant_id<span>=</span><span>1</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>所以往往将 IFreesql 和 DbContext 并存，在使用时，根据场景使用这两种方式操作数据库。</p>
<h2 id="使用方法" tabindex="-1"> 使用方法</h2>
<p>IFreeSql 的创建需要定义为单例模式，示例如下：</p>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connectionString<span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>而 Freesql 也支持了类似 EFCore 的 DbContext 模式。通过引入 <code>FreeSql.DbContext</code> 库，可以使用特性、Fluent api 等配置实体映射、导航属性等，生成类似于 EFCore 的 DbContext 类型，然后通过依赖注入实例化使用。</p>
<p>通过定义 DbContext ，我们可以根据 EFCore 的使用习惯，快速掌握 FreeSql 的使用，甚至可以直接将 EFCore DbContext 转为 Freesql DbContext，因为 Freesql DbContext 支持了 95% 的 EFCore Fluent api 。</p>
<p>下面说说如何利用 FreeSql 更加方便地迁移数据库以及定义 DbContext。</p>
<p>安装 FreeSql 工具：</p>
<div><pre><code>dotnet tool <span>install</span> -g FreeSql.Generator
</code></pre><div aria-hidden="true"><div></div></div></div><p>接着还原数据库表为实体：</p>
<div><pre><code>FreeSql.Generator  -NameOptions <span>1,1</span>,0,1 -NameSpace AuthCenter.Database.Entities -DB <span>"MySql,data source=123.123.123.123;port=3306;user id=root;password=root;initial catalog=datab;charset=utf8;sslmode=none;max pool size=2"</span> -FileName <span>"{name}.cs"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>还原的实体示例：</p>
<div><pre><code><span>[</span><span><span>JsonObject</span><span><span>(</span>MemberSerialization<span>.</span>OptIn<span>)</span></span><span>,</span> <span>Table</span><span><span>(</span>Name <span>=</span> <span>"roles"</span><span>,</span> DisableSyncStructure <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>partial</span> <span>class</span> <span>Roles</span>
<span>{</span>

    <span>[</span><span><span>JsonProperty</span><span>,</span> <span>Column</span><span><span>(</span>Name <span>=</span> <span>"id"</span><span>,</span> DbType <span>=</span> <span>"bigint unsigned"</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>ulong</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 创建时间</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>[</span>JsonProperty<span>,</span> <span>Column</span><span>(</span>Name <span>=</span> <span>"creation_time"</span><span>,</span> DbType <span>=</span> <span>"bigint unsigned"</span><span>)</span><span>]</span>
    <span>public</span> <span><span>ulong</span></span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>在 FreeSql 中，实体特性优先于 Fluent api，同时 FreeSql 也兼容 EFCore 的实体特性。</p>
<p>由于 <code>FreeSql.Generator</code> 工具很方便，我们不需要另外使用 Fluent api 去定义复杂的逻辑结构。</p>
<p>接着定义 DbContext：</p>
<div><pre><code><span>using</span> <span>FreeSql</span><span>;</span>

<span>namespace</span> <span>My<span>.</span>Context</span>
<span>{</span>
    <span>public</span> <span>partial</span> <span>class</span> <span>AuthcenterContext</span> <span>:</span> <span><span>DbContext</span></span>
    <span>{</span>
        <span>private</span> <span>readonly</span> <span>IFreeSql</span> iFreesql<span>;</span>
        <span>public</span> <span>AuthcenterContext</span><span>(</span><span>)</span>
        <span>{</span>
        <span>}</span>

        <span>public</span> <span>AuthcenterContext</span><span>(</span><span>IFreeSql</span> freeSql<span>)</span>
        <span>{</span>
            iFreesql <span>=</span> freeSql<span>;</span>
        <span>}</span>

        <span>public</span> <span>virtual</span> <span>DbSet<span>&lt;</span>Roles<span>></span></span> Roles <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnConfiguring</span><span>(</span><span>DbContextOptionsBuilder</span> builder<span>)</span>
        <span>{</span>
            <span>// iFreesql.xxxx</span>
            <span>// 使用 iFreesql 调用 Fluent api</span>
            builder<span>.</span><span>UseFreeSql</span><span>(</span>iFreesql<span>)</span><span>;</span>
        <span>}</span>

        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ICodeFirst</span> codefirst<span>)</span>
        <span>{</span>

        <span>}</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>通过这种方法，IFreeSql 和 DbContext 中的实体及其实体特性、Fluent api 等都保持一致。</p>
</blockquote>
<p>接着，在依赖注入中，将 IFreeSql 和 DbContext 都注入。</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
        <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>@"data source=123.123.123.123;port=3306;user id=root;password=root;initial catalog=authcenter;charset=utf8"</span><span>)</span>
        <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
    services<span>.</span><span><span>AddFreeDbContext</span><span><span>&lt;</span>AuthcenterContext<span>></span></span></span><span>(</span>options <span>=></span> options<span>.</span><span>UseFreeSql</span><span>(</span>fsql<span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>我们在类型中通过依赖注入获取到这两种服务：</p>
<div><pre><code><span>private</span> <span>readonly</span> <span>IFreeSql</span> _freesql<span>;</span>
<span>private</span> <span>readonly</span> <span>MyContext</span> _context<span>;</span>

<span>public</span> <span>Test</span><span>(</span><span>IFreeSql</span> freeSql<span>,</span> <span>MyContext</span> context<span>)</span>
<span>{</span>
    _freesql <span>=</span> freeSql<span>;</span>
    _context <span>=</span> context<span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>然后就可以快乐地使用 Freesql 了。</p>
]]></content>
    <published>2021-07-14T05:16:31.000Z</published>
  </entry>
  <entry>
    <title type="html">WithSql</title>
    <id>https://freesql.net/guide/withsql.html</id>
    <link href="https://freesql.net/guide/withsql.html"/>
    <updated>2022-08-26T07:02:05.000Z</updated>
    <content type="html"><![CDATA[<h1 id="withsql" tabindex="-1"> WithSql</h1>
<h2 id="withsql-自定义-sql" tabindex="-1"> WithSql 自定义 SQL</h2>
<p>定义实体类</p>
<div><pre><code>    <span>public</span> <span>class</span> <span>TestClass</span>
    <span>{</span>
        <span>[</span><span><span>Column</span><span><span>(</span>Name <span>=</span> <span>"ID"</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
        <span>public</span> <span><span>string</span></span> No <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>public</span> <span><span>int</span><span>?</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>[</span><span><span>Column</span><span><span>(</span>Name <span>=</span> <span>"BIRTH_DAY"</span><span>)</span></span></span><span>]</span>
        <span>public</span> <span>DateTime<span>?</span></span> Birthday <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>public</span> <span><span>decimal</span></span> Point <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
        <span>public</span> <span>Sex<span>?</span></span> Sex <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>}</span>
    <span>public</span> <span>enum</span> <span>Sex</span>
    <span>{</span>
        Boy<span>,</span>
        Girl
    <span>}</span>
    <span>public</span> <span>class</span> <span>TestClssDto</span>
    <span>{</span>
        <span>public</span> <span><span>string</span></span> ID <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

        <span>public</span> <span><span>int</span><span>?</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

        <span>public</span> <span>DateTime<span>?</span></span> Birthday <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>不同的查询方式。</p>
<ul>
<li>返回<code>DataTable</code></li>
<li>返回<code>List&lt;Tuplue&gt;</code> 即<code>List&lt;(string,string)&gt;</code>元组</li>
<li>返回<code>List&lt;object&gt;</code> 且能支持分页</li>
<li>返回<code>List&lt;TestClassDto&gt;</code>且能支持分页</li>
</ul>
<h3 id="_1-返回-datatable" tabindex="-1"> 1.返回 DataTable</h3>
<div><pre><code><span>DataTable</span> dt1 <span>=</span> _fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"select * from TestClass "</span><span>)</span>
    <span>.</span><span>ToDataTable</span><span>(</span><span>"ID,Age"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> ID<span>,</span>Age
    <span>FROM</span><span>(</span><span>select</span> <span>*</span> <span>from</span> TestClass  <span>)</span> a
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="_2-返回-datatable" tabindex="-1"> 2.返回 DataTable</h3>
<div><pre><code><span>DataTable</span> dt2 <span>=</span> _fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"select * from TestClass "</span><span>)</span>
    <span>.</span><span>ToDataTable</span><span>(</span><span>"*"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> <span>*</span>
<span>FROM</span> <span>(</span> <span>select</span> <span>*</span> <span>from</span> TestClass  <span>)</span> a
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="_3-返回list-tuplue-即list-string-string-元组" tabindex="-1"> 3.返回<code>List&lt;Tuplue&gt;</code> 即<code>List&lt;(string,string)&gt;</code> 元组</h3>
<div><pre><code><span>List<span>&lt;</span><span>(</span><span>string</span><span>,</span><span>string</span><span>)</span><span>></span></span> list1 <span>=</span> _fsql
    <span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"select * from TestClass "</span><span>)</span>
    <span>.</span><span><span>ToList</span><span><span>&lt;</span><span>(</span><span>string</span><span>,</span> <span>string</span><span>)</span><span>></span></span></span><span>(</span><span>"ID,Age"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> ID<span>,</span> Age
    <span>FROM</span><span>(</span><span>select</span> <span>*</span> <span>from</span> TestClass  <span>)</span> a
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="_4-返回list-object" tabindex="-1"> 4.返回<code>List&lt;object&gt;</code></h3>
<div><pre><code><span><span>var</span></span> list2 <span>=</span> _fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"select * from TestClass "</span><span>)</span>
    <span>.</span><span><span>ToList</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>"*"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> <span>*</span>
    <span>FROM</span><span>(</span><span>select</span> <span>*</span> <span>from</span> TestClass  <span>)</span> a
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="_5-返回list-object-且能支持分页" tabindex="-1"> 5.返回<code>List&lt;object&gt;</code> 且能支持分页</h3>
<div><pre><code>  <span><span>var</span></span> list3 <span>=</span> _fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"select * from TestClass "</span><span>)</span>
    <span>.</span><span>WhereIf</span><span>(</span><span>true</span><span>,</span> <span>"1=1"</span><span>)</span>
    <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span><span>"ID DESC"</span><span>)</span>
    <span>.</span><span><span>ToList</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>"ID,Age"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> ID<span>,</span> Age
    <span>FROM</span><span>(</span><span>select</span> <span>*</span> <span>from</span> TestClass  <span>)</span> a
    <span>WHERE</span><span>(</span><span>1</span> <span>=</span> <span>1</span><span>)</span>
    <span>ORDER</span> <span>BY</span> ID <span>DESC</span>
    <span>limit</span> <span>0</span><span>,</span><span>10</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="_6-返回list-testclassdto-且能支持分页" tabindex="-1"> 6.返回<code>List&lt;TestClassDto&gt;</code>且能支持分页</h3>
<div><pre><code><span><span>var</span></span> list4 <span>=</span> _fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"select * from TestClass "</span><span>)</span>
    <span>.</span><span>WhereIf</span><span>(</span><span>true</span><span>,</span> <span>"1=1"</span><span>)</span>
    <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span>
    <span>.</span><span>OrderBy</span><span>(</span><span>"ID DESC"</span><span>)</span>
    <span>.</span><span><span>ToList</span><span><span>&lt;</span>TestClssDto<span>></span></span></span><span>(</span><span>"ID,Age,BIRTH_DAY as Birthday"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> ID<span>,</span>Age<span>,</span>BIRTH_DAY <span>as</span> Birthday
    <span>FROM</span><span>(</span><span>select</span> <span>*</span> <span>from</span> TestClass  <span>)</span> a
    <span>WHERE</span><span>(</span><span>1</span> <span>=</span> <span>1</span><span>)</span>
    <span>ORDER</span> <span>BY</span> ID <span>DESC</span>
    <span>limit</span> <span>0</span><span>,</span><span>10</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="通过-withsql-tosql-实现-union-all-查询方法" tabindex="-1"> 通过 WithSql+ ToSQL 实现 Union ALL 查询方法</h2>
<h3 id="_1、二次-iselect-查询-withsql-使用多次-等于-union-all-查询" tabindex="-1"> 1、二次 ISelect 查询：WithSql 使用多次，等于 UNION ALL 查询</h3>
<p>WithSql 使用多次为 UNION ALL 查询，所以我们可以利用 ISelect.ToSql(FieldAliasOptions.AsProperty) 得到生成的 SQL，如下：</p>
<div><pre><code><span><span>var</span></span> sql1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>.</span><span>Contains</span><span>(</span><span>"xxx"</span><span>)</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> sql2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>.</span><span>Contains</span><span>(</span><span>"yyy"</span><span>)</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span>sql1<span>)</span>
    <span>.</span><span>WithSql</span><span>(</span>sql2<span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
<span>FROM</span> <span>(</span> <span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
    <span>FROM</span> <span><span>`</span>tb_topic<span>`</span></span> a
    <span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span><span>`</span>Title<span>`</span></span><span>)</span> <span>LIKE</span> <span>'%xxx%'</span><span>)</span> <span>)</span> a<span>)</span> ftb

<span>UNION</span> <span>ALL</span>

<span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
<span>FROM</span> <span>(</span> <span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
    <span>FROM</span> <span><span>`</span>tb_topic<span>`</span></span> a
    <span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span><span>`</span>Title<span>`</span></span><span>)</span> <span>LIKE</span> <span>'%yyy%'</span><span>)</span> <span>)</span> a<span>)</span> ftb
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="_2、跨分表查询-astable-相同实体多次操作-等于-union-all-查询" tabindex="-1"> 2、跨分表查询：AsTable 相同实体多次操作，等于 Union ALL 查询</h3>
<div><pre><code><span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>AsTable</span><span>(</span><span>(</span>type<span>,</span> oldname<span>)</span> <span>=></span> <span>"table_1"</span><span>)</span>
    <span>.</span><span>AsTable</span><span>(</span><span>(</span>type<span>,</span> oldname<span>)</span> <span>=></span> <span>"table_2"</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> a<span>.</span><span>"Id"</span> as1 <span>FROM</span> <span>"table_1"</span> a<span>)</span> ftb
<span>UNION</span> <span>ALL</span>
<span>select</span> <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> a<span>.</span><span>"Id"</span> as1 <span>FROM</span> <span>"table_2"</span> a<span>)</span> ftb
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h3 id="_3、利用-tosql-拼接新的-sql-使用-iado-执行" tabindex="-1"> 3、利用 ToSql 拼接新的 SQL，使用 IAdo 执行</h3>
<div><pre><code><span><span>var</span></span> sql1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>></span> <span>100</span> <span>&amp;&amp;</span> a<span>.</span>Id <span>&lt;</span> <span>200</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Id<span>,</span> a<span>.</span>Title <span>}</span><span>,</span> FieldAliasOptions<span>.</span>AsProperty<span>)</span><span>;</span>
<span><span>var</span></span> sql2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>></span> <span>1001</span> <span>&amp;&amp;</span> a<span>.</span>Id <span>&lt;</span> <span>1200</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Id<span>,</span> a<span>.</span>Title <span>}</span><span>,</span> FieldAliasOptions<span>.</span>AsProperty<span>)</span><span>;</span>

fsql<span>.</span>Ado<span>.</span><span>CommandFluent</span><span>(</span><span><span>$"</span><span><span>{</span><span>sql1</span><span>}</span></span><span> UNION ALL </span><span><span>{</span><span>sql2</span><span>}</span></span><span>"</span></span><span>)</span>
    <span>.</span><span>ExecuteDataTable</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="分页问题" tabindex="-1"> 分页问题</h2>
<p>Union All 之后 如果直接 分页会有一个问题。请看具体示例</p>
<p>多次 WithSql + Page 存在问题：每个 WithSql 内都有一个 Page 分页</p>
<div><pre><code><span><span>var</span></span> sql1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>.</span><span>Contains</span><span>(</span><span>"xxx"</span><span>)</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> sql2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>.</span><span>Contains</span><span>(</span><span>"yyy"</span><span>)</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>WithSql</span><span>(</span>sql1<span>)</span><span>.</span><span>WithSql</span><span>(</span>sql2<span>)</span><span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>20</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code> <span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
    <span>FROM</span> <span>(</span> <span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
        <span>FROM</span> <span><span>`</span>tb_topic<span>`</span></span> a
        <span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span><span>`</span>Title<span>`</span></span><span>)</span> <span>LIKE</span> <span>'%xxx%'</span><span>)</span> <span>)</span> a
    <span>limit</span> <span>0</span><span>,</span><span>20</span><span>)</span> ftb

    <span>UNION</span> <span>ALL</span>

    <span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
    <span>FROM</span> <span>(</span> <span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
        <span>FROM</span> <span><span>`</span>tb_topic<span>`</span></span> a
        <span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span><span>`</span>Title<span>`</span></span><span>)</span> <span>LIKE</span> <span>'%yyy%'</span><span>)</span> <span>)</span> a
    <span>limit</span> <span>0</span><span>,</span><span>20</span><span>)</span> ftb

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>多个 sql union all 使用 withsql，直接 Page 分页，会导致每个子表都生效，子表都生成分页。</p>
<p>WithSql 可以和 AsTable 实现分表的功能。</p>
<p>分表跨表查询的时候，分页是要向每个子表（即每个 WithSql 中的 SQL 分页）都生效。</p>
<h3 id="解决方案" tabindex="-1"> 解决方案</h3>
<p>多次 withsql ，如需分页，需要按下面的二步操作</p>
<ul>
<li>第一步：通过 witsql，将二个 sql 组成一个 sql。</li>
</ul>
<div><pre><code> <span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"SELECT * FROM tb_topic where id > 11"</span><span>)</span>
    <span>.</span><span>WithSql</span><span>(</span><span>"SELECT * FROM tb_topic where id &lt; 10"</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span><span>"*"</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>如上生成的 UOION ALL 的 sql</p>
<div><pre><code><span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> <span>*</span>
    <span>FROM</span> <span>(</span> <span>SELECT</span> <span>*</span> <span>FROM</span> tb_topic <span>where</span> id <span>></span> <span>11</span> <span>)</span> a<span>)</span> ftb

    <span>UNION</span> <span>ALL</span>

    <span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> <span>*</span>
    <span>FROM</span> <span>(</span> <span>SELECT</span> <span>*</span> <span>FROM</span> tb_topic <span>where</span> id <span>&lt;</span> <span>10</span> <span>)</span> a<span>)</span> ftb
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>第二步：之后 调用 Page 则是通过 Union ALL 后的结果上分页</li>
</ul>
<div><pre><code> <span><span>var</span></span> sql2 <span>=</span> g<span>.</span>mysql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
     <span>.</span><span>WithSql</span><span>(</span>sql<span>)</span>
     <span>.</span><span>Page</span><span>(</span><span>2</span><span>,</span> <span>10</span><span>)</span>
     <span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Clicks<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TypeGuid<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CreateTime<span>`</span></span>
<span>FROM</span> <span>(</span> <span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> <span>*</span>
    <span>FROM</span> <span>(</span> <span>SELECT</span> <span>*</span> <span>FROM</span> tb_topic <span>where</span> id <span>></span> <span>11</span> <span>)</span> a<span>)</span> ftb

    <span>UNION</span> <span>ALL</span>

    <span>SELECT</span>  <span>*</span> <span>from</span> <span>(</span><span>SELECT</span> <span>*</span>
    <span>FROM</span> <span>(</span> <span>SELECT</span> <span>*</span> <span>FROM</span> tb_topic <span>where</span> id <span>&lt;</span> <span>10</span> <span>)</span> a<span>)</span> ftb <span>)</span> a
<span>limit</span> <span>10</span><span>,</span><span>10</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-06-16T16:56:09.000Z</published>
  </entry>
  <entry>
    <title type="html">Awesome FreeSql</title>
    <id>https://freesql.net/reference/awesome-freesql.html</id>
    <link href="https://freesql.net/reference/awesome-freesql.html"/>
    <updated>2022-09-05T06:51:57.000Z</updated>
    <content type="html"><![CDATA[<h1 id="awesome-freesql" tabindex="-1"> Awesome FreeSql</h1>
<h2 id="基于-freesql-的开源项目" tabindex="-1"> 基于 FreeSql 的开源项目</h2>
<div>
<table>
<thead>
<tr>
<th style="text-align:center">项目</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://github.com/zhontai/Admin.Core" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=zhontai&amp;repo=Admin.Core" alt="ReadMe Card" loading="lazy"></a></td>
<td style="text-align:left"><code>Admin</code>后端，前后端分离的权限管理系统。支持多租户、动态Api、任务调度、滑块拼图验证、国内外主流数据库自由切换和动态高级查询。基于.Net跨平台开发的WebApi。集成统一认证授权、数据验证、缓存、Ip限流、全Api鉴权、集成测试、性能分析、接口文档等。</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/luoyunchong/lin-cms-dotnetcore" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=luoyunchong&amp;repo=lin-cms-dotnetcore" alt="ReadMe Card" loading="lazy"></a></td>
<td style="text-align:left">😃A simple and practical CMS implemented by .NET 6 + FreeSql；前后端分离、Docker部署、OAtuh2授权登录、自动化部署DevOps、自动同步至Gitee、代码生成器、仿掘金专栏</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/alonsoalon/TenantSite.Server" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=alonsoalon&amp;repo=TenantSite.Server" alt="ReadMe Card" loading="lazy"></a></td>
<td style="text-align:left">SaaS 企业应用管理系统，定位于企业应用的SaaS服务框架，企业云端应用的基础开发框架（当然也可以部署于本地），系统被设计用于多租户，采用前端后端完全分离技术方案。 抽离企业应用软件研发公共部分，让研发人员有条件聚焦在业务研发，实现了用于权限管理的基础数据维护，权限赋权，缓存，上传等常规功能。</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/hejiyong/fscms" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=hejiyong&amp;repo=fscms" alt="ReadMe Card" loading="lazy"></a></td>
<td style="text-align:left">fscms 文档类的cms，通过wiki动态生成文档，包括后端完整权限管理和前端文档页，采用freesql orm，layer。</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/densen2014/FreeSqlDemos" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=densen2014&amp;repo=FreeSqlDemos" alt="ReadMe Card" loading="lazy"></a></td>
<td style="text-align:left">FreeSql 的各种工程 demo, console,xamarin app,ios,android,wpf,blazor,nf461</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://github.com/yc-l/yc.boilerplate" target="_blank" rel="noopener noreferrer"><img src="https://github-readme-stats.vercel.app/api/pin/?username=yc-l&amp;repo=yc.boilerplate" alt="ReadMe Card" loading="lazy"></a></td>
<td style="text-align:left">YC.Boilerplate 是一套快速开发框架，采用当下流行的前后端分离开发模式，前端 采用VUE 2.0、后端采用Net 5.0；框架实现了多租户、动态webApi、多种ORM、IOC、数据库表和业务代码生成等等一系列模块，并开发了用户管理、角色权限、组织机构、数据字典、审计日志等常规功能。</td>
</tr>
</tbody>
</table>
</div>


<h3 id="easycms" tabindex="-1"> <a href="https://github.com/aprilyush/EasyCMS" target="_blank" rel="noopener noreferrer">EasyCMS</a></h3>
<p>EasyCms后台权限管理系统 基于<code>Asp.net Core</code>的后台快速开发框架，可用于快速开发 企业后台管理系统，WebApi接口，微信公众号和小程序后台，企业站。</p>
<h3 id="基于-net-core-3-1-或-net-5-框架简单-2-层架构-实现基于权限角色的页面级权限后台框架" tabindex="-1"> <a href="https://gitee.com/sundayisblue/BoYuanCore/" target="_blank" rel="noopener noreferrer">基于.Net Core 3.1 或 .Net 5 框架简单 2 层架构，实现基于权限角色的页面级权限后台框架</a></h3>
<p>实现页面权限基于权限角色的后台框架，配套完善代码生成工具，可开箱即用，适用于中小型项目快速开发。 项目为<code>.Net Core 3.1</code>或<code>.Net 5</code>，使用简单的<code>service</code>分层架构，前端为<code>FineUICore</code> , 数据层使用 FreeSql ORM+
雪花算法实体模式，兼容各种不同的数据库迁移(支持的数据库：<code>SqlServer</code>, <code>Mysql</code>, <code>Postgresql</code>,<code>Oracle</code> 等)，并有完善的异常拦截写入日志功能。 优秀的编码体验，层次分明，简单易学，从而实现快速开发的目的，
或入门学习<code>.Net Core</code>。</p>
<h3 id="基于-net-5-平台的快速开发框架" tabindex="-1"> <a href="https://gitee.com/rongguohao/HaoHaoPlay_Back" target="_blank" rel="noopener noreferrer">基于.Net 5 平台的快速开发框架</a></h3>
<p>基于<code>.Net 5</code>平台的快速开发框架。
目前系统包含功能有登录，用户管理，应用菜单管理，权限管理，字典管理，退出登录，也方便扩展多租户使用。
通过这些基础功能的实现，分享自己对系统框架设计的理解，对<code>ddd</code>设计的理解，希望对大家学习使用<code>.net core</code>有帮助，少踩一些坑，当然也会存在不足之处，还望指出。</p>
<h2 id="freesql-官方博客" tabindex="-1"> FreeSql 官方博客</h2>
<ul>
<li><a href="https://www.cnblogs.com/kellynic/" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/kellynic/</a></li>
<li><a href="https://www.cnblogs.com/freesql/" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/freesql/</a></li>
</ul>
<h2 id="官方文档" tabindex="-1"> 官方文档</h2>
<ul>
<li><a href="https://freesql.net" target="_blank" rel="noopener noreferrer">https://freesql.net</a></li>
<li><a href="https://github.com/dotnetcore/FreeSql/wiki" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/wiki</a></li>
<li><a href="http://124.70.130.97:8082/api/index.html" target="_blank" rel="noopener noreferrer">API 参考(国内镜像)</a></li>
<li><a href="https://docs.dotnet-china.com/FreeSql/index.html" target="_blank" rel="noopener noreferrer">API 参考</a></li>
</ul>
<h2 id="源码" tabindex="-1"> 源码</h2>
<ul>
<li>GitHub <a href="https://github.com/dotnetcore/FreeSql" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql</a></li>
<li>Gitee <a href="https://gitee.com/FreeSql/FreeSql-ORM" target="_blank" rel="noopener noreferrer">https://gitee.com/FreeSql/FreeSql-ORM</a></li>
</ul>
]]></content>
    <published>2021-02-09T12:13:50.000Z</published>
  </entry>
  <entry>
    <title type="html">特别鸣谢</title>
    <id>https://freesql.net/reference/donation.html</id>
    <link href="https://freesql.net/reference/donation.html"/>
    <updated>2022-09-07T04:18:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="特别鸣谢" tabindex="-1"> 特别鸣谢</h1>
<table>
<thead>
<tr>
<th>捐赠者</th>
<th>金额</th>
<th>留言</th>
</tr>
</thead>
<tbody>
<tr>
<td>L*y</td>
<td>58 元</td>
<td></td>
</tr>
<tr>
<td>花花</td>
<td>88 元</td>
<td></td>
</tr>
<tr>
<td>麦兜很乖</td>
<td>50 元</td>
<td></td>
</tr>
<tr>
<td>网络来者</td>
<td>2000 元</td>
<td></td>
</tr>
<tr>
<td>John</td>
<td>99.99 元</td>
<td></td>
</tr>
<tr>
<td>alex</td>
<td>666 元</td>
<td></td>
</tr>
<tr>
<td>bacongao</td>
<td>36 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>Eternity</td>
<td>188 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>10 元</td>
<td></td>
</tr>
<tr>
<td>⌒.Helper~..oO</td>
<td>66 元</td>
<td></td>
</tr>
<tr>
<td>习惯与被习惯</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>蔡易喋</td>
<td>88.88 元</td>
<td></td>
</tr>
<tr>
<td>中讯科技</td>
<td>1000 元</td>
<td></td>
</tr>
<tr>
<td>Good Good Work</td>
<td>24 元</td>
<td></td>
</tr>
<tr>
<td>炽焰</td>
<td>6.6 元</td>
<td></td>
</tr>
<tr>
<td>Nothing</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>兰州天擎赵</td>
<td>500 元</td>
<td></td>
</tr>
<tr>
<td>哈利路亚</td>
<td>300 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>蛰伏</td>
<td>99.99 元</td>
<td></td>
</tr>
<tr>
<td>TCYM</td>
<td>66.66 元</td>
<td></td>
</tr>
<tr>
<td>MOTA</td>
<td>5 元</td>
<td></td>
</tr>
<tr>
<td>LDZXG</td>
<td>30 元</td>
<td></td>
</tr>
<tr>
<td>Near</td>
<td>30 元</td>
<td></td>
</tr>
<tr>
<td>建爽</td>
<td>66 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>200 元</td>
<td></td>
</tr>
<tr>
<td>LambertWu</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>18.88 元</td>
<td></td>
</tr>
<tr>
<td>乌龙</td>
<td>50 元</td>
<td></td>
</tr>
<tr>
<td>无名</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>陳怼怼</td>
<td>66.66 元</td>
<td></td>
</tr>
<tr>
<td>陳怼怼</td>
<td>66.66 元</td>
<td></td>
</tr>
<tr>
<td>丁淮</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>李伟坚-Excel 催化剂</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>白狐</td>
<td>6.66 元</td>
<td></td>
</tr>
<tr>
<td>她微笑的脸 y</td>
<td>30 元</td>
<td></td>
</tr>
<tr>
<td>Eternity2o21</td>
<td>588 元</td>
<td></td>
</tr>
<tr>
<td>夜归柴门</td>
<td>88 元</td>
<td></td>
</tr>
<tr>
<td>蔡易喋</td>
<td>666.66 元</td>
<td></td>
</tr>
<tr>
<td>*礼</td>
<td>10 元</td>
<td></td>
</tr>
<tr>
<td>litrpa</td>
<td>88 元</td>
<td></td>
</tr>
<tr>
<td>Alax CHOW</td>
<td>200 元</td>
<td></td>
</tr>
<tr>
<td>Daily</td>
<td>66 元</td>
<td></td>
</tr>
<tr>
<td>k*t</td>
<td>66 元</td>
<td></td>
</tr>
<tr>
<td>蓝</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>*菜</td>
<td>10 元</td>
<td></td>
</tr>
<tr>
<td>生命如歌</td>
<td>1000 元</td>
<td></td>
</tr>
<tr>
<td>山鸡</td>
<td>88 元</td>
<td></td>
</tr>
<tr>
<td>平凡</td>
<td>100 元</td>
<td></td>
</tr>
<tr>
<td>大树</td>
<td>1000 元</td>
<td></td>
</tr>
<tr>
<td>软软的毛毛虫</td>
<td>66.66 元</td>
<td></td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-09T12:13:50.000Z</published>
  </entry>
  <entry>
    <title type="html">ADO</title>
    <id>https://freesql.net/guide/ado.html</id>
    <link href="https://freesql.net/guide/ado.html"/>
    <updated>2022-07-07T01:04:44.000Z</updated>
    <content type="html"><![CDATA[<h1 id="ado" tabindex="-1"> ADO</h1>
<p>Ado 是 IFreeSql 下重要的对象之一，它包括所有对 SQL 操作的封装，提供 ExecuteReader、ExecuteDataSet、ExecuteDataTable、ExecuteNonQuery、ExecuteScalar 等方法，使用起来和传统 SqlHelper 一样。</p>
<h2 id="查询-sql-返回实体" tabindex="-1"> 查询 SQL 返回实体</h2>
<div><pre><code><span>//返回多条记录</span>
<span>List<span>&lt;</span>T<span>></span></span> list <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>"select * from t1"</span><span>)</span><span>;</span>

<span>//返回单条记录</span>
<span>T</span> item <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>QuerySingle</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>"select * from t1 where id = @id"</span><span>,</span> <span>new</span> <span>{</span> id <span>=</span> <span>1</span> <span>}</span><span>)</span><span>;</span>

<span>//返回多个结果集</span>
<span><span>var</span></span> result <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>T1<span>,</span> T2<span>></span></span></span><span>(</span><span>"select * from t1; select * from t2"</span><span>)</span><span>;</span>
<span>List<span>&lt;</span>T1<span>></span></span> list1 <span>=</span> result<span>.</span>Item1<span>;</span>
<span>List<span>&lt;</span>T2<span>></span></span> list2 <span>=</span> result<span>.</span>Item2<span>;</span>

<span>// like 查询</span>
<span><span>string</span></span> searchText <span>=</span> <span>"abc"</span><span>;</span>
<span>List<span>&lt;</span>T<span>></span></span> users <span>=</span> _fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>"select * from t1 where name like @name"</span><span>,</span> <span>new</span> <span>{</span> name <span>=</span> <span>"%"</span> <span>+</span> searchText <span>+</span> <span>"%"</span> <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="参数化" tabindex="-1"> 参数化</h2>
<p>Ado 下面所有参数 object parms 都可以接受匿名对象，或者字典：</p>
<ul>
<li id="">new</li>
<li [id]=" 1, [name&quot;]">new Dictionary&lt;string, object&gt;</li>
</ul>
<p>关于参数前缀：</p>
<ul>
<li>odbc 是 ? 并且没有标识，所以 freesql 禁用了 odbc 参数化</li>
<li>oracle 是 :</li>
<li>mysql.data 是 ?</li>
<li>mysqlconnector 是 @</li>
<li>其他基本都是 @</li>
</ul>
<p>IN 参数化查询：</p>
<blockquote>
<p>当前仅支持 Array 和 IList 类型绑定</p>
</blockquote>
<div><pre><code><span><span>var</span></span> ids <span>=</span> <span>new</span> <span><span>int</span><span>[</span><span>]</span></span> <span>{</span> <span>1</span><span>,</span><span>2</span><span>,</span><span>3</span> <span>}</span><span>;</span>
<span>List<span>&lt;</span>T<span>></span></span> list <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>"select * from t1 where id in @ids"</span><span>,</span> <span>new</span> <span>{</span> ids <span>=</span> ids <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h2 id="检测连接" tabindex="-1"> 检测连接</h2>
<div><pre><code><span><span>bool</span></span> isok <span>=</span> fsql<span>.</span>Ado<span>.</span><span>ExecuteConnectTest</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="commandfluent" tabindex="-1"> CommandFluent</h2>
<p>fsql.Ado 重载方法太多的情况下，建议使用 CommandFluent，例如存储过程：</p>
<div><pre><code><span>DbParameter</span> p2 <span>=</span> <span>null</span><span>;</span>
fsql<span>.</span>Ado<span>.</span><span>CommandFluent</span><span>(</span><span>"dbo.GetICMaxNum"</span><span>)</span>
    <span>.</span><span>CommandType</span><span>(</span>CommandType<span>.</span>StoredProcedure<span>)</span>
    <span>.</span><span>CommandTimeout</span><span>(</span><span>60</span><span>)</span>

    <span>.</span><span>WithParameter</span><span>(</span><span>"TableName"</span><span>,</span> <span>"tb1"</span><span>)</span>
    <span>.</span><span>WithParameter</span><span>(</span><span>"FInterID"</span><span>,</span> <span>null</span><span>,</span> p <span>=></span>
    <span>{</span>
        <span>//(p as OracleParameter).OracleType = ...;</span>
        p2 <span>=</span> p<span>;</span> <span>//Output 参数</span>
        p<span>.</span>DbType <span>=</span> DbType<span>.</span>Int32<span>;</span>
        p<span>.</span>Direction <span>=</span> ParameterDirection<span>.</span>Output<span>;</span>
    <span>}</span><span>)</span>
    <span>.</span><span>ExecuteNonQuery</span><span>(</span><span>)</span><span>;</span> <span>//.Query&lt;T>() 或者 .ExecuteDataTable() 或者 ...</span>

Console<span>.</span><span>WriteLine</span><span>(</span>p2<span>.</span>Value<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>Oracle 存储过程获取 DataTable：</p>
<div><pre><code><span>OracleParameter</span> p2 <span>=</span> <span>null</span><span>;</span>
<span><span>var</span></span> dt <span>=</span> fsql<span>.</span>Ado<span>.</span><span>CommandFluent</span><span>(</span><span>"getTableInfo"</span><span>)</span>
     <span>.</span><span>CommandType</span><span>(</span>CommandType<span>.</span>StoredProcedure<span>)</span>
     <span>.</span><span>CommandTimeout</span><span>(</span><span>60</span><span>)</span>
     <span>.</span><span>WithParameter</span><span>(</span><span>"out_var"</span><span>,</span> <span>null</span><span>,</span> p <span>=></span>
     <span>{</span>
         p2 <span>=</span> p <span>as</span> <span>OracleParameter</span><span>;</span>

         p2<span>.</span>OracleDbType <span>=</span> OracleDbType<span>.</span>RefCursor<span>;</span>
         p2<span>.</span>Direction <span>=</span> ParameterDirection<span>.</span>Output<span>;</span>

     <span>}</span><span>)</span>
     <span>.</span><span>ExecuteDataTable</span><span>(</span><span>)</span><span>;</span>
Console<span>.</span><span>WriteLine</span><span>(</span>dt<span>.</span>Rows<span>.</span>Count<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="ado-net-扩展方法" tabindex="-1"> <a href="http://Ado.net" target="_blank" rel="noopener noreferrer">Ado.net</a> 扩展方法</h2>
<p>提供了类似 Dapper 的使用方法，FreeSql 增加了 IDbConnection/IDbTransaction 对象的扩展方法 Select/Insert/Update/Delete 实现 CRUD。</p>
<div><pre><code><span>using</span> <span>FreeSql</span><span>;</span>

<span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span><span>..</span><span>.</span><span>)</span><span>)</span>
<span>{</span>
  <span>//IFreeSql fsql = conn.GetIFreeSql();</span>
  <span>//fsql.CodeFirst.IsNoneCommandParameter = true;</span>
  <span>//fsql.CodeFirst.IsSyncStructureToUpper = true;</span>
  <span>//fsql.Aop.CommandBefore += (_, e) => Trace.WriteLine(e.Command.CommandText);</span>
  <span>//以上整个程序只需要设置一次</span>

  conn<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>..</span><span>.</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

  conn<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>T</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
  conn<span>.</span><span>Update</span><span>(</span><span>)</span><span>.</span><span>SetSource</span><span>(</span><span>new</span> <span>T</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
  conn<span>.</span><span>InsertOrUpdate</span><span>(</span><span>)</span><span>.</span><span>SetSource</span><span>(</span><span>new</span> <span>T</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

  conn<span>.</span><span><span>Delete</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>..</span><span>.</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>每个 SqlConnection GetFreeSql() 返回的 IFreeSql 实例相同；</li>
<li>可以对 fsql 设置 Aop 事件，比如监视 SQL；</li>
<li>IFreeSql 自身的成员 IDbFirst、Transaction 不可用；</li>
</ul>
<p>利用本功能可以快速将 FreeSql 使用到项目中，只需要处理好实体类的特性。</p>
<p>提示：FreeSql 兼容 EFCore 99% 的实体特性</p>
]]></content>
    <published>2021-02-06T16:18:46.000Z</published>
  </entry>
  <entry>
    <title type="html">前言</title>
    <id>https://freesql.net/guide/BaseEntity.html</id>
    <link href="https://freesql.net/guide/BaseEntity.html"/>
    <updated>2022-07-09T09:12:32.000Z</updated>
    <content type="html"><![CDATA[<h1 id="前言" tabindex="-1"> 前言</h1>
<p>尝试过 <a href="http://ado.net" target="_blank" rel="noopener noreferrer">ado.net</a>、dapper、ef，以及 Repository 仓储，甚至自己还写过生成器工具，以便做常规 CRUD 操作。</p>
<p>它们日常操作不方便之处：</p>
<ul>
<li>
<p>每次使用前需要声明，再操作；</p>
</li>
<li>
<p>很多人一个实体类，对应一个操作类（或 DAL、DbContext、Repository）；</p>
</li>
</ul>
<p>本文介绍 BaseEntity 一种极简约的 CRUD 操作方法。</p>
<h2 id="功能特点" tabindex="-1"> 功能特点</h2>
<ul>
<li>
<p>自动迁移实体结构（CodeFirst），到数据库；</p>
</li>
<li>
<p>直接操作实体的方法，进行 CRUD 操作；</p>
</li>
<li>
<p>简化用户定义实体类型，省去主键、常用字段的配置（如 CreateTime、UpdateTime）；</p>
</li>
<li>
<p>实现单表、多表查询的软删除逻辑；</p>
</li>
</ul>
<h2 id="声明" tabindex="-1"> 声明</h2>
<p>参考 BaseEntity.cs 源码（约 100 行），copy 到项目中使用，然后添加 nuget 引用包：</p>
<blockquote>
<p>dotnet add package FreeSql.DbContext</p>
</blockquote>
<blockquote>
<p>dotnet add package FreeSql.Provider.Sqlite</p>
</blockquote>
<p>1、定义一个主键 int 并且自增的实体类型，BaseEntity TKey 指定为 int/long 时，会认为主键是自增；</p>
<div><pre><code><span>public</span> <span>class</span> <span>UserGroup</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>UserGroup<span>,</span> <span>int</span><span>></span></span></span> <span>{</span>
    <span>public</span> <span><span>string</span></span> GroupName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>如果不想主键是自增键，可以重写属性：</p>
<div><pre><code><span>public</span> <span>class</span> <span>UserGroup</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>UserGroup<span>,</span> <span>int</span><span>></span></span></span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>false</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>override</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> GroupName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>有关更多实体的特性配置，可参阅 <a href="/guide/entity-attribute.html">实体属性</a></p>
</blockquote>
<p>2、定义一个主键 Guid 的实体类型，保存数据时会自动产生有序不重复的 Guid 值（不用自己指定 Guid.NewGuid()）；</p>
<div><pre><code><span>public</span> <span>class</span> <span>User</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>UserGroup<span>,</span> Guid<span>></span></span></span> <span>{</span>
    <span>public</span> <span><span>string</span></span> UserName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>3、定义多主键的实体类型，可以在 static 构造函数中重写字段名；</p>
<div><pre><code><span>public</span> <span>class</span> <span>User2</span> <span>:</span> <span><span>BaseEntity<span>&lt;</span>User2<span>,</span> Guid<span>,</span> <span>int</span><span>></span></span></span> <span>{</span>
    <span>static</span> <span>User2</span><span>(</span><span>)</span>
    <span>{</span>
        User2<span>.</span>Orm<span>.</span>CodeFirst<span>.</span><span><span>ConfigEntity</span><span><span>&lt;</span>User2<span>></span></span></span><span>(</span>t <span>=></span>
        <span>{</span>
            t<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>PkId1<span>)</span><span>.</span><span>Name</span><span>(</span><span>"UserId"</span><span>)</span><span>;</span>
            t<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>PkId2<span>)</span><span>.</span><span>Name</span><span>(</span><span>"Index"</span><span>)</span><span>;</span>
        <span>}</span><span>)</span><span>;</span>
    <span>}</span>

    <span>public</span> <span><span>string</span></span> Username <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="crud-使用" tabindex="-1"> CRUD 使用</h2>
<div><pre><code><span>//添加</span>
<span><span>var</span></span> item <span>=</span> <span>new</span> <span>UserGroup</span> <span>{</span> GroupName <span>=</span> <span>"组一"</span> <span>}</span><span>;</span>
item<span>.</span><span>Insert</span><span>(</span><span>)</span><span>;</span>

<span>//更新</span>
item<span>.</span>GroupName <span>=</span> <span>"组二"</span><span>;</span>
item<span>.</span><span>Update</span><span>(</span><span>)</span><span>;</span>

<span>//添加或更新</span>
item<span>.</span><span>Save</span><span>(</span><span>)</span><span>;</span>

<span>//软删除</span>
item<span>.</span><span>Delete</span><span>(</span><span>)</span><span>;</span>

<span>//恢复软删除</span>
item<span>.</span><span>Restore</span><span>(</span><span>)</span><span>;</span>

<span>//根据主键获取对象</span>
<span><span>var</span></span> item <span>=</span> UserGroup<span>.</span><span>Find</span><span>(</span><span>1</span><span>)</span><span>;</span>

<span>//查询数据</span>
<span><span>var</span></span> items <span>=</span> UserGroup<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>></span> <span>10</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>实体类型.Select 是一个查询对象，使用方法和 FreeSql.ISelect 一样；</p>
<p>支持多表查询时，软删除条件会附加在每个表中；</p>
<blockquote>
<p>有关更多查询方法，可参阅 <a href="/guide/select.html">查询</a></p>
</blockquote>
<p>示范项目：<a href="https://github.com/dotnetcore/FreeSql/tree/master/Examples/base_entity" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/tree/master/Examples/base_entity</a></p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">指南</title>
    <id>https://freesql.net/guide/</id>
    <link href="https://freesql.net/guide/"/>
    <updated>2022-08-11T15:34:05.000Z</updated>
    <content type="html"><![CDATA[<h1 id="指南" tabindex="-1"> 指南</h1>
<p><a href="https://github.com/dotnetcore" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/member project of-NCC-9e20c9.svg" alt="Member project of .NET Core Community" loading="lazy"></a>
<a href="https://www.nuget.org/packages/FreeSql" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/nuget/v/FreeSql.svg?style=flat-square" alt="nuget" loading="lazy"></a>
<a href="https://www.nuget.org/packages/FreeSql" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/nuget/vpre/FreeSql.svg?style=flat-square" alt="nuget" loading="lazy"></a>
<a href="https://www.nuget.org/stats/packages/FreeSql?groupby=Version" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/nuget/dt/FreeSql.svg?style=flat-square" alt="stats" loading="lazy"></a>
<a href="https://github.com/dotnetcore/FreeSql/blob/master/LICENSE" target="_blank" rel="noopener noreferrer"><img src="https://img.shields.io/badge/license-MIT-blue.svg" alt="License" loading="lazy"></a></p>
<p><a href="https://starchart.cc/dotnetcore/FreeSql" target="_blank" rel="noopener noreferrer"><img src="https://starchart.cc/dotnetcore/FreeSql.svg" alt="Stargazers over time" loading="lazy"></a></p>
<h2 id="freesql" tabindex="-1"> FreeSql</h2>
<p><code>FreeSql</code>是功能强大的 <code>.NET ORM</code>，支持 <code>.NetFramework 4.0+</code>、<code>.NetCore 2.1+</code>、<code>Xamarin</code>等支持 NetStandard 所有运行平台。</p>
<p>支持 <code>MySql/SqlServer/PostgreSQL/Oracle/Sqlite/Firebird/ClickHouse/达梦/南大通用GBase/神通/人大金仓/翰高/华为GaussDB/MsAccess</code> 等数据库，以及自定义适配其它数据库。</p>
<ul>
<li>
<p>QQ 群：4336577(已满)、8578575(已满)、52508226(已满)、反馈问题请前往 <a href="https://github.com/dotnetcore/FreeSql/issues" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/issues</a></p>
</li>
<li>
<p>欢迎微信关注 <strong>dotNET 搬砖队</strong>，分享 .NET Core + FreeSql 相关技术栈</p>
</li>
</ul>
<p><img src="/wechat_qrcode.jpg" alt="分享.NET Core+FreeSql相关技术" loading="lazy"></p>
<h2 id="特性" tabindex="-1"> 特性</h2>
<ul>
<li><input type="checkbox" id="task-item-0" checked="checked" disabled="disabled"><label for="task-item-0"> 支持 CodeFirst 迁移；</label></li>
<li><input type="checkbox" id="task-item-1" checked="checked" disabled="disabled"><label for="task-item-1"> 支持 DbFirst 从数据库导入实体类，支持三种模板生成器；</label></li>
<li><input type="checkbox" id="task-item-2" checked="checked" disabled="disabled"><label for="task-item-2"> 采用 ExpressionTree 高性能读取数据；</label></li>
<li><input type="checkbox" id="task-item-3" checked="checked" disabled="disabled"><label for="task-item-3"> 支持深入的类型映射，比如 pgsql 的数组类型，堪称匠心制作；</label></li>
<li><input type="checkbox" id="task-item-4" checked="checked" disabled="disabled"><label for="task-item-4"> 支持丰富的表达式函数；</label></li>
<li><input type="checkbox" id="task-item-5" checked="checked" disabled="disabled"><label for="task-item-5"> 支持导航属性查询，和延时加载；</label></li>
<li><input type="checkbox" id="task-item-6" checked="checked" disabled="disabled"><label for="task-item-6"> 支持同步/异步数据库操作方法，丰富多彩的链式查询方法；</label></li>
<li><input type="checkbox" id="task-item-7" checked="checked" disabled="disabled"><label for="task-item-7"> 支持读写分离、分表分库，租户设计；</label></li>
<li><input type="checkbox" id="task-item-8" checked="checked" disabled="disabled"><label for="task-item-8"> 支持多种数据库，MySql/SqlServer/PostgreSQL/Oracle/Sqlite/Firebird/ClickHouse/达梦/南大通用GBase/神通/人大金仓/翰高/华为 GaussDB/MsAccess；</label></li>
</ul>
<h2 id="学习指南" tabindex="-1"> 学习指南</h2>
<p>FreeSql 除了支持基本的增删查改功能外，还支持基于现有数据库创建模型（<a href="/guide/db-first.html">DbFirst</a>），和支持基于模型创建数据库（<a href="/guide/code-first.html">CodeFirst</a>)。</p>
<h4 id="基础" tabindex="-1"> 基础</h4>
<ul>
<li><a href="/guide/insert.html">《学习 FreeSql 之一：添加数据》</a></li>
<li><a href="/guide/delete.html">《学习 FreeSql 之二：删除数据》</a></li>
<li><a href="/guide/update.html">《学习 FreeSql 之三：修改数据》</a></li>
<li><a href="/guide/select.html">《学习 FreeSql 之四：查询数据》</a></li>
<li><a href="/guide/repository.html">《仓储层 Repository》</a></li>
</ul>
<h4 id="进阶" tabindex="-1"> 进阶</h4>
<ul>
<li><a href="/guide/code-first.html">《CodeFirst 模式开发介绍》</a>
<ul>
<li><a href="/guide/entity-attribute.html">《CodeFirst 模式之一：实体特性》</a></li>
<li><a href="/guide/fluent-api.html">《CodeFirst 模式之二：FluentApi》</a></li>
<li><a href="/guide/custom-attribute.html">《CodeFirst 模式之三：自定义特性》</a></li>
<li><a href="/guide/type-mapping.html">《CodeFirst 模式之四：类型映射》</a></li>
<li><a href="/guide/code-first.html#%E8%BF%81%E7%A7%BB%E7%BB%93%E6%9E%84">《CodeFirst 模式之五：迁移结构》</a></li>
</ul>
</li>
</ul>
<ul>
<li><a href="/guide/db-first.html">《DbFirst 模式开发介绍》</a></li>
</ul>
<h4 id="高级" tabindex="-1"> 高级</h4>
<ul>
<li><a href="/guide/transaction.html">《数据库事务》</a></li>
<li><a href="/guide/read-write-splitting.html">《使用读写分离》</a></li>
<li><a href="/guide/sharding.html">《分表分库》</a></li>
<li><a href="/guide/multi-tenancy.html">《多租户》</a></li>
<li><a href="/guide/select-return-data.html">《返回数据》</a></li>
<li><a href="/guide/select-lazy-loading.html">《优化之：延时加载》</a></li>
<li><a href="/guide/select-include.html">《优化之：贪婪加载》</a></li>
<li><a href="/guide/expression-function.html">《Expression 表达式函数》</a></li>
<li><a href="/guide/aop.html">《AOP》</a></li>
</ul>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">AOP✨</title>
    <id>https://freesql.net/guide/aop.html</id>
    <link href="https://freesql.net/guide/aop.html"/>
    <updated>2022-08-30T23:05:04.000Z</updated>
    <content type="html"><![CDATA[<h1 id="aop✨" tabindex="-1"> AOP✨</h1>
<p>FreeSql AOP 已有的功能介绍，未来为会根据用户需求不断增强。</p>
<h2 id="审计-crud-如何监视-sql" tabindex="-1"> 审计 CRUD(如何监视 SQL？)</h2>
<p>如果因为某个 sql 骚操作耗时很高，没有一个相关的审计功能，排查起来可以说无从下手。</p>
<p>FreeSql 支持简单的类似功能：</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>CurdAfter <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"ManagedThreadId:</span><span><span>{</span><span>Thread<span>.</span>CurrentThread<span>.</span>ManagedThreadId</span><span>}</span></span><span>;"</span></span><span>+</span>
    <span><span>$" FullName:</span><span><span>{</span><span>e<span>.</span>EntityType<span>.</span>FullName</span><span>}</span></span><span> ElapsedMilliseconds:</span><span><span>{</span><span>e<span>.</span>ElapsedMilliseconds</span><span>}</span></span><span>ms, </span><span><span>{</span><span>e<span>.</span>Sql</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
    <span>if</span> <span>(</span>e<span>.</span>ElapsedMilliseconds <span>></span> <span>200</span><span>)</span>
    <span>{</span>
        <span>//记录日志</span>
        <span>//发送短信给负责人</span>
    <span>}</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>只需要一个事件，就可以对全局起到作用。</p>
<p>还有一个 CurdBefore 在执行 sql 之前触发，常用于记录日志或开发调试。</p>
<h2 id="审计属性值" tabindex="-1"> 审计属性值</h2>
<p>实现插入/更新时统一处理某些值，比如某属性的雪花算法值、创建时间值、甚至是业务值。</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>AuditValue <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>Column<span>.</span>CsType <span>==</span> <span>typeof</span><span>(</span><span><span>long</span></span><span>)</span> <span>&amp;&amp;</span>
        e<span>.</span>Property<span>.</span><span><span>GetCustomAttribute</span><span><span>&lt;</span>SnowflakeAttribute<span>></span></span></span><span>(</span><span>false</span><span>)</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span>
        e<span>.</span>Value<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>==</span> <span>"0"</span><span>)</span>
        e<span>.</span>Value <span>=</span> <span>new</span> <span>Snowflake</span><span>(</span><span>)</span><span>.</span><span>GetId</span><span>(</span><span>)</span><span>;</span>
<span>}</span><span>;</span>

<span>class</span> <span>Order</span> <span>{</span>
    <span>[</span><span><span>Snowflake</span></span><span>]</span>
    <span>public</span> <span><span>long</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>//...</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>当属性的类型是 long，并且标记了 [Snowflake]，并且当前值是 0，那么在插入/更新时它的值将设置为雪花 id 值。</p>
<blockquote>
<p>说明：SnowflakeAttribute 是使用者您来定义，new Snowflake().GetId() 也是由使用者您来实现</p>
</blockquote>
<p>如果命名规范，可以在 aop 里判断，<code>if (e.Property.Name == &quot;createtime&quot;) e.Value = DateTime.Now;</code></p>
<blockquote>
<p>v3.2.666 可设置 e.ObjectAuditBreak = true 中断对象审计，变相实现每个对象只触发一次 AuditValue 事件</p>
</blockquote>
<h2 id="审计命令" tabindex="-1"> 审计命令</h2>
<p>fsql.Aop.CommandBefore、fsql.Aop.CommandAfterHandler 这两个事件触发所有 SQL 命令的执行前、和执行后。</p>
<p>执行后的事件会附带异常信息、耗时信息等。</p>
<p>建议在开发模式下开启无参数化模式，new FreeSqlBuilder().UseNoneCommandParameter(true)。</p>
<blockquote>
<p>提示：new FreeSqlBuilder().UseMonitorCommand 也可以审计命令执行前后。</p>
</blockquote>
<div><pre><code>fsql1<span>.</span>Aop<span>.</span>CommandAfter <span>+=</span> <span>new</span> <span>EventHandler<span>&lt;</span>CommandAfterEventArgs<span>></span></span><span>(</span><span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
   <span>if</span> <span>(</span>e<span>.</span>Exception <span>!=</span> <span>null</span><span>)</span>
   <span>{</span>
     <span>//做一些日志记录的操作。以下为示例。</span>
     Trace<span>.</span><span>WriteLine</span><span>(</span><span><span>$"Message:</span><span><span>{</span><span>e<span>.</span>Exception<span>.</span>Message </span><span>}</span></span><span>\r\nStackTrace:</span><span><span>{</span><span>e<span>.</span>Exception<span>.</span>StackTrace</span><span>}</span></span><span>\r\nCommandText:</span><span><span>{</span><span>e<span>.</span>Command<span>.</span>CommandText</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
   <span>}</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="审计迁移脚本" tabindex="-1"> 审计迁移脚本</h2>
<p>FreeSql 自带迁移功能，那么迁移的 SQL 语句长啥样，你可能会好奇。</p>
<ul>
<li>
<p>比如创建表时；</p>
</li>
<li>
<p>比如添加字段时；</p>
</li>
<li>
<p>比如修改表名、修改字段名时；</p>
</li>
<li>
<p>又比如字段类型更改之后时；</p>
</li>
</ul>
<p>这些操作在 FreeSql.CodeFirst 实现下基本不需要理会，而且我们只推荐在开发环境使用自动迁移的功能，正式环境可使用其他工具替代此操作。</p>
<p>但我们仍然可能需要对项目做完整的日志记录。</p>
<p>fsql.Aop.SyncStructureBefore、fsql.Aop.SyncStructureAfter 这两个事件将排上用场。</p>
<h2 id="configentityproperty" tabindex="-1"> ConfigEntityProperty</h2>
<h3 id="mysql-enum-映射" tabindex="-1"> MySql Enum 映射</h3>
<p>默认情况 c# 枚举会映射为 MySql Enum 类型，如果想映射为 int 在 FreeSqlBuilder Build 之后执行以下 Aop 统一处理：</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span>if</span> <span>(</span>e<span>.</span>Property<span>.</span>PropertyType<span>.</span>IsEnum<span>)</span>
    e<span>.</span>ModifyResult<span>.</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>int</span></span><span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h3 id="修改-decimal-默认特性" tabindex="-1"> 修改 decimal 默认特性</h3>
<p>因为默认 decimal 只支持 decimal(10,2)，范围太小，我们可以全局修改 decimal 类型的支持范围，比如支持 decimal(18,6)</p>
<div><pre><code>fsql1<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>Property<span>.</span>PropertyType <span>==</span> <span>typeof</span><span>(</span><span><span>decimal</span></span><span>)</span><span>||</span> e<span>.</span>Property<span>.</span>PropertyType <span>==</span> <span>typeof</span><span>(</span><span><span>decimal</span><span>?</span></span><span>)</span><span>)</span>
    <span>{</span>
       e<span>.</span>ModifyResult<span>.</span>Precision <span>=</span> <span>18</span><span>;</span>
       e<span>.</span>ModifyResult<span>.</span>Scale <span>=</span> <span>6</span><span>;</span>
    <span>}</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="自定义实体特性" tabindex="-1"> 自定义实体特性</h3>
<p>比如项目内已经使用了其它 orm，如 efcore，这样意味着实体中可能存在 [Key]，但它与 FreeSql [Column(IsPrimary = true] 不同。</p>
<p>Q： FreeSql 实体特性为啥这么别扭？</p>
<p>A： 为了考虑一致性用法，全部封装在 ColumnAttribute 下，这样用户使用起来，不用到处 using 或者 回忆特性应该用哪个名字，如自增 [Column(IsIdentity = true)] 即可。</p>
<p>FreeSql 提供 AOP 自定义特性功能，实现与多个 orm 共同拥有一套实体特性，可避免重复定义特性。</p>
<blockquote>
<p>v1.4.0+ 已自动识别 EFCore 实体特性 Key/Required/NotMapped/MaxLength/StringLength/DatabaseGenerated/Table/Column</p>
</blockquote>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ConfigEntity <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span><span>var</span></span> attr <span>=</span> e<span>.</span>EntityType<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>MyTableAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span> <span>as</span> <span>MyTableAttribute</span><span>;</span>
    <span>if</span> <span>(</span>attr <span>!=</span> <span>null</span><span>)</span>
        e<span>.</span>ModifyResult<span>.</span>Name <span>=</span> attr<span>.</span>Name<span>;</span> <span>//表名</span>
<span>}</span><span>;</span>
fsql<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span><span>var</span></span> attr <span>=</span> e<span>.</span>Property<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>MyColumnAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span> <span>as</span> <span>MyColumnAttribute</span><span>;</span>
    <span>if</span> <span>(</span>attr <span>!=</span> <span>null</span><span>)</span>
        e<span>.</span>ModifyResult<span>.</span>Name <span>=</span> attr<span>.</span>Name<span>;</span> <span>//字段名</span>
<span>}</span><span>;</span>

<span>[</span><span><span>MyTable</span><span><span>(</span><span>"xxx"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>YourEntity</span>
<span>{</span>
    <span>[</span><span><span>MyColumn</span><span><span>(</span><span>"id"</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> pkid <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>class</span> <span>MyTableAttribute</span> <span>:</span> <span><span>Attribute</span></span>
<span>{</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>}</span>
    <span>public</span> <span>MyTableAttribute</span><span>(</span><span><span>string</span></span> name<span>)</span>
    <span>{</span>
      <span>this</span><span>.</span>Name <span>=</span> name<span>;</span>
    <span>}</span>
<span>}</span>
<span>class</span> <span>MyColumnAttribute</span> <span>:</span> <span><span>Attribute</span></span>
<span>{</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>}</span>
    <span>public</span> <span>MyColumnAttribute</span><span>(</span><span><span>string</span></span> name<span>)</span>
    <span>{</span>
      <span>this</span><span>.</span>Name <span>=</span> name<span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="ado-net-读取拦截" tabindex="-1"> Ado .net 读取拦截</h2>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>AuditDataReader <span>+=</span> <span>(</span>_<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>DataReader<span>.</span><span>GetFieldType</span><span>(</span>e<span>.</span>Index<span>)</span> <span>==</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span> <span>&amp;&amp;</span>
      e<span>.</span>Value <span>==</span> DBNull<span>.</span>Value<span>)</span>
        e<span>.</span>Value <span>=</span> <span>""</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="表达式拦截" tabindex="-1"> 表达式拦截</h2>
<p>FreeSql 内部表达式支持非常丰富，对各大数据库的兼容度也做得很好。</p>
<blockquote>
<p>有关表达式支持的程度，可参阅：<a href="/guide/expression-function.html">表达式函数</a></p>
</blockquote>
<p>即便如此丰富，也仍然无法满足用户需求，FreeSql 对外开放了自定义表达式解析接口：</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ParseExpression <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>Expression<span>.</span>NodeType <span>==</span> Call <span>&amp;&amp;</span> e<span>.</span>Expression<span>.</span>Name <span>==</span> <span>"get_Item"</span><span>)</span>
        e<span>.</span>Result <span>=</span> <span>"1111"</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>这个解析有点复杂，当 <code>e.Expression</code> 很复杂的时候，我们还提供了 <code>e.FreeParse</code> 方法，使用它相当于调用 <code>FreeSql</code> 内置表达式解析引擎，辅助您进行解析。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">级联保存</title>
    <id>https://freesql.net/guide/cascade-saving.html</id>
    <link href="https://freesql.net/guide/cascade-saving.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="级联保存" tabindex="-1"> 级联保存</h1>
<p>实践发现，N 对 1 不适合做级联保存。保存 Topic 的时候把 Type 信息也保存？我个人认为自下向上保存的功能太不可控了，FreeSql 目前不支持自下向上保存。因此下面我们只讲 OneToOne/OneToMany/ManyToMany 级联保存。至于 ManyToOne 级联保存使用手工处理，更加安全可控。</p>
<h2 id="savemany-手工保存" tabindex="-1"> SaveMany 手工保存</h2>
<p>完整保存，对比表已存在的数据，计算出添加、修改、删除执行。</p>
<p>递归保存导航属性不安全，不可控，并非技术问题，而是出于安全考虑，提供了手工完整保存的方式。</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Type<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> type <span>=</span> <span>new</span> <span>Type</span>
<span>{</span>
    name <span>=</span> <span>"c#"</span><span>,</span>
    Topics <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
    <span>{</span>
        <span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span>
    <span>}</span><span>)</span>
<span>}</span><span>;</span>
repo<span>.</span><span>Insert</span><span>(</span>type<span>)</span><span>;</span>
repo<span>.</span><span>SaveMany</span><span>(</span>type<span>,</span> <span>"Topics"</span><span>)</span><span>;</span> <span>//手工完整保存 Topics</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>SaveMany 仅支持 OneToMany、ManyToMany 导航属性</li>
<li>只保存 Topics，不向下递归追朔</li>
<li>当 Topics 为 Empty 时，删除 type 存在的 Topics 所有表数据，确认？</li>
<li>ManyToMany 机制为，完整对比保存中间表，外部表只追加不更新</li>
</ul>
<p>如：</p>
<ul>
<li>本表 Song</li>
<li>外部表 Tag</li>
<li>中间表 SongTag</li>
</ul>
<h2 id="enablecascadesave-仓储级联保存" tabindex="-1"> EnableCascadeSave 仓储级联保存</h2>
<p>DbContext/Repository EnableCascadeSave 可实现保存对象的时候，递归追朔其 OneToOne、OneToMany、ManyToMany 导航属性也一并保存，本文档说明实现的机制防止误用。</p>
<p>1、OneToOne 级联保存</p>
<blockquote>
<p>v3.2.606+ 支持，并且支持<a href="/guide/delete.html#ibaserepository-%E7%BA%A7%E8%81%94%E5%88%A0%E9%99%A4">级联删除功能</a></p>
</blockquote>
<p>2、OneToMany 追加或更新子表，不删除子表已存在的数据</p>
<div><pre><code>repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>true</span><span>;</span> <span>//需要手工开启</span>
repo<span>.</span><span>Insert</span><span>(</span>type<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ul>
<li>不删除 Topics 子表已存在的数据，确认？</li>
<li>当 Topics 属性为 Empty 时，不做任何操作，确认？</li>
<li>保存 Topics 的时候，还会保存 Topics[0-..] 的下级集合属性，向下 18 层，确认？</li>
</ul>
<blockquote>
<p>向下 18 层的意思，比如【类型】表，下面有集合属性【文章】，【文章】下面有集合属性【评论】。</p>
</blockquote>
<blockquote>
<p>保存【类型】表对象的时候，他会向下检索出集合属性【文章】，然后如果【文章】被保存的时候，再继续向下检索出集合属性【评论】。一起做 InsertOrUpdate 操作。</p>
</blockquote>
<p>3、ManyToMany 完整对比保存中间表，追加外部表</p>
<p>完整对比保存中间表，对比【多对多】中间表已存在的数据，计算出添加、修改、删除执行。</p>
<p>追加外部表，只追加不更新。</p>
<ul>
<li>本表 Song</li>
<li>外部表 Tag</li>
<li>中间表 SongTag</li>
</ul>
<hr>
<p>测试 1：追加保存 OneToMany</p>
<div><pre><code>
<span>class</span> <span>Cagetory</span>
<span>{</span>
    <span>public</span> <span>Guid</span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>Guid</span> ParentId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>ParentId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>Cagetory<span>></span></span> Childs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span><span>void</span></span> <span>TestOneToManyParent</span><span>(</span><span>)</span>
<span>{</span>
    <span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Cagetory<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>true</span><span>;</span>
    <span><span>var</span></span> cts <span>=</span> <span>new</span><span>[</span><span>]</span>
    <span>{</span>
        <span>new</span> <span>Cagetory</span>
        <span>{</span>
            Name <span>=</span> <span>"分类1"</span><span>,</span>
            Childs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Cagetory<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
            <span>{</span>
                <span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类1_1"</span> <span>}</span><span>,</span>
                <span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类1_2"</span> <span>}</span><span>,</span>
                <span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类1_3"</span> <span>}</span>
            <span>}</span><span>)</span>
        <span>}</span><span>,</span>
        <span>new</span> <span>Cagetory</span>
        <span>{</span>
            Name <span>=</span> <span>"分类2"</span><span>,</span>
            Childs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Cagetory<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
            <span>{</span>
                <span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类2_1"</span> <span>}</span><span>,</span>
                <span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类2_2"</span> <span>}</span>
            <span>}</span><span>)</span>
        <span>}</span>
    <span>}</span><span>;</span>
    repo<span>.</span><span>Insert</span><span>(</span>cts<span>)</span><span>;</span>
    <span>//执行创建表，和插入数据：</span>
    <span>//INSERT INTO "Cagetory"("Id", "Name", "ParentId") VALUES('5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f', '分类1', '00000000-0000-0000-0000-000000000000'), ('5d90afcb-ed57-f6f4-0082-cb6c5b531b3e', '分类2', '00000000-0000-0000-0000-000000000000')</span>
    <span>//INSERT INTO "Cagetory"("Id", "Name", "ParentId") VALUES('5d90afcb-ed57-f6f4-0082-cb6d0c1c5f1a', '分类1_1', '5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f'), ('5d90afcb-ed57-f6f4-0082-cb6e74bd8eef', '分类1_2', '5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f'), ('5d90afcb-ed57-f6f4-0082-cb6f6267cc5f', '分类1_3', '5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f'), ('5d90afcb-ed57-f6f4-0082-cb7057c41d46', '分类2_1', '5d90afcb-ed57-f6f4-0082-cb6c5b531b3e'), ('5d90afcb-ed57-f6f4-0082-cb7156e0375e', '分类2_2', '5d90afcb-ed57-f6f4-0082-cb6c5b531b3e')</span>
    cts<span>[</span><span>0</span><span>]</span><span>.</span>Name <span>=</span> <span>"分类11"</span><span>;</span>
    cts<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    cts<span>[</span><span>1</span><span>]</span><span>.</span>Name <span>=</span> <span>"分类22"</span><span>;</span>
    cts<span>[</span><span>1</span><span>]</span><span>.</span>Childs<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    repo<span>.</span><span>Update</span><span>(</span>cts<span>)</span><span>;</span>
    <span>//UPDATE "Cagetory" SET "Name" = CASE "Id"</span>
    <span>//WHEN '5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f' THEN '分类11'</span>
    <span>//WHEN '5d90afcb-ed57-f6f4-0082-cb6c5b531b3e' THEN '分类22' END</span>
    <span>//WHERE ("Id" IN ('5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f','5d90afcb-ed57-f6f4-0082-cb6c5b531b3e'))</span>
    <span>//Childs.Clear 后没有执行删除子集合操作，说明没有做完整的对比</span>
    cts<span>[</span><span>0</span><span>]</span><span>.</span>Name <span>=</span> <span>"分类111"</span><span>;</span>
    cts<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    cts<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类1_33"</span> <span>}</span><span>)</span><span>;</span>
    cts<span>[</span><span>1</span><span>]</span><span>.</span>Name <span>=</span> <span>"分类222"</span><span>;</span>
    cts<span>[</span><span>1</span><span>]</span><span>.</span>Childs<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    cts<span>[</span><span>1</span><span>]</span><span>.</span>Childs<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Cagetory</span> <span>{</span> Name <span>=</span> <span>"分类2_22"</span> <span>}</span><span>)</span><span>;</span>
    repo<span>.</span><span>Update</span><span>(</span>cts<span>)</span><span>;</span>
    <span>//UPDATE "Cagetory" SET "Name" = CASE "Id"</span>
    <span>//WHEN '5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f' THEN '分类111'</span>
    <span>//WHEN '5d90afcb-ed57-f6f4-0082-cb6c5b531b3e' THEN '分类222' END</span>
    <span>//WHERE ("Id" IN ('5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f','5d90afcb-ed57-f6f4-0082-cb6c5b531b3e'))</span>
    <span>//INSERT INTO "Cagetory"("Id", "Name", "ParentId") VALUES('5d90afe8-ed57-f6f4-0082-cb725df546ea', '分类1_33', '5d90afcb-ed57-f6f4-0082-cb6b78eaaf9f'), ('5d90afe8-ed57-f6f4-0082-cb7338a6214c', '分类2_22', '5d90afcb-ed57-f6f4-0082-cb6c5b531b3e')</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<p>测试 2：完整保存 ManyToMany</p>
<div><pre><code><span>class</span> <span>Song</span>
<span>{</span>
    <span>public</span> <span>Guid</span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>List<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>Tag</span>
<span>{</span>
    <span>public</span> <span>Guid</span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> TagName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>List<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>SongTag</span>
<span>{</span>
    <span>public</span> <span>Guid</span> SongId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Song</span> Song <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Guid</span> TagId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Tag</span> Tag <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>[</span><span><span>Fact</span></span><span>]</span>
<span>public</span> <span><span>void</span></span> <span>TestManyToMany</span><span>(</span><span>)</span>
<span>{</span>
    <span><span>var</span></span> tags <span>=</span> <span>new</span><span>[</span><span>]</span>
    <span>{</span>
        <span>new</span> <span>Tag</span> <span>{</span> TagName <span>=</span> <span>"流行"</span> <span>}</span><span>,</span>
        <span>new</span> <span>Tag</span> <span>{</span> TagName <span>=</span> <span>"80后"</span> <span>}</span><span>,</span>
        <span>new</span> <span>Tag</span> <span>{</span> TagName <span>=</span> <span>"00后"</span> <span>}</span><span>,</span>
        <span>new</span> <span>Tag</span> <span>{</span> TagName <span>=</span> <span>"摇滚"</span> <span>}</span>
    <span>}</span><span>;</span>
    <span><span>var</span></span> ss <span>=</span> <span>new</span><span>[</span><span>]</span>
    <span>{</span>
        <span>new</span> <span>Song</span>
        <span>{</span>
            Name <span>=</span> <span>"爱你一万年.mp3"</span><span>,</span>
            Tags <span>=</span> <span>new</span> <span>List<span>&lt;</span>Tag<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
            <span>{</span>
                tags<span>[</span><span>0</span><span>]</span><span>,</span> tags<span>[</span><span>1</span><span>]</span>
            <span>}</span><span>)</span>
        <span>}</span><span>,</span>
        <span>new</span> <span>Song</span>
        <span>{</span>
            Name <span>=</span> <span>"李白.mp3"</span><span>,</span>
            Tags <span>=</span> <span>new</span> <span>List<span>&lt;</span>Tag<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
            <span>{</span>
                tags<span>[</span><span>0</span><span>]</span><span>,</span> tags<span>[</span><span>2</span><span>]</span>
            <span>}</span><span>)</span>
        <span>}</span>
    <span>}</span><span>;</span>
    <span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>true</span><span>;</span>
    repo<span>.</span><span>Insert</span><span>(</span>ss<span>)</span><span>;</span>
    <span>//INSERT INTO "Song"("Id", "Name") VALUES('5d90fdb3-6a6b-2c58-00c8-37974177440d', '爱你一万年.mp3'), ('5d90fdb3-6a6b-2c58-00c8-37987f29b197', '李白.mp3')</span>
    <span>//INSERT INTO "Tag"("Id", "TagName") VALUES('5d90fdb7-6a6b-2c58-00c8-37991ead4f05', '流行'), ('5d90fdbd-6a6b-2c58-00c8-379a0432a09c', '80后')</span>
    <span>//INSERT INTO "SongTag"("SongId", "TagId") VALUES('5d90fdb3-6a6b-2c58-00c8-37974177440d', '5d90fdb7-6a6b-2c58-00c8-37991ead4f05'), ('5d90fdb3-6a6b-2c58-00c8-37974177440d', '5d90fdbd-6a6b-2c58-00c8-379a0432a09c')</span>
    <span>//INSERT INTO "Tag"("Id", "TagName") VALUES('5d90fdcc-6a6b-2c58-00c8-379b5af59d25', '00后')</span>
    <span>//INSERT INTO "SongTag"("SongId", "TagId") VALUES('5d90fdb3-6a6b-2c58-00c8-37987f29b197', '5d90fdb7-6a6b-2c58-00c8-37991ead4f05'), ('5d90fdb3-6a6b-2c58-00c8-37987f29b197', '5d90fdcc-6a6b-2c58-00c8-379b5af59d25')</span>

    ss<span>[</span><span>0</span><span>]</span><span>.</span>Name <span>=</span> <span>"爱你一万年.mp5"</span><span>;</span>
    ss<span>[</span><span>0</span><span>]</span><span>.</span>Tags<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    ss<span>[</span><span>0</span><span>]</span><span>.</span>Tags<span>.</span><span>Add</span><span>(</span>tags<span>[</span><span>0</span><span>]</span><span>)</span><span>;</span>
    ss<span>[</span><span>1</span><span>]</span><span>.</span>Name <span>=</span> <span>"李白.mp5"</span><span>;</span>
    ss<span>[</span><span>1</span><span>]</span><span>.</span>Tags<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    ss<span>[</span><span>1</span><span>]</span><span>.</span>Tags<span>.</span><span>Add</span><span>(</span>tags<span>[</span><span>3</span><span>]</span><span>)</span><span>;</span>
    repo<span>.</span><span>Update</span><span>(</span>ss<span>)</span><span>;</span>
    <span>//UPDATE "Song" SET "Name" = CASE "Id"</span>
    <span>//WHEN '5d90fdb3-6a6b-2c58-00c8-37974177440d' THEN '爱你一万年.mp5'</span>
    <span>//WHEN '5d90fdb3-6a6b-2c58-00c8-37987f29b197' THEN '李白.mp5' END</span>
    <span>//WHERE ("Id" IN ('5d90fdb3-6a6b-2c58-00c8-37974177440d','5d90fdb3-6a6b-2c58-00c8-37987f29b197'))</span>

    <span>//SELECT a."SongId", a."TagId"</span>
    <span>//FROM "SongTag" a</span>
    <span>//WHERE (a."SongId" = '5d90fdb3-6a6b-2c58-00c8-37974177440d')</span>

    <span>//DELETE FROM "SongTag" WHERE ("SongId" = '5d90fdb3-6a6b-2c58-00c8-37974177440d' AND "TagId" = '5d90fdbd-6a6b-2c58-00c8-379a0432a09c')</span>
    <span>//INSERT INTO "Tag"("Id", "TagName") VALUES('5d90febd-6a6b-2c58-00c8-379c21acfc72', '摇滚')</span>

    <span>//SELECT a."SongId", a."TagId"</span>
    <span>//FROM "SongTag" a</span>
    <span>//WHERE (a."SongId" = '5d90fdb3-6a6b-2c58-00c8-37987f29b197')</span>

    <span>//DELETE FROM "SongTag" WHERE ("SongId" = '5d90fdb3-6a6b-2c58-00c8-37987f29b197' AND "TagId" = '5d90fdb7-6a6b-2c58-00c8-37991ead4f05' OR "SongId" = '5d90fdb3-6a6b-2c58-00c8-37987f29b197' AND "TagId" = '5d90fdcc-6a6b-2c58-00c8-379b5af59d25')</span>
    <span>//INSERT INTO "SongTag"("SongId", "TagId") VALUES('5d90fdb3-6a6b-2c58-00c8-37987f29b197', '5d90febd-6a6b-2c58-00c8-379c21acfc72')</span>

    ss<span>[</span><span>0</span><span>]</span><span>.</span>Name <span>=</span> <span>"爱你一万年.mp4"</span><span>;</span>
    ss<span>[</span><span>0</span><span>]</span><span>.</span>Tags<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    ss<span>[</span><span>1</span><span>]</span><span>.</span>Name <span>=</span> <span>"李白.mp4"</span><span>;</span>
    ss<span>[</span><span>1</span><span>]</span><span>.</span>Tags<span>.</span><span>Clear</span><span>(</span><span>)</span><span>;</span>
    repo<span>.</span><span>Update</span><span>(</span>ss<span>)</span><span>;</span>
    <span>//DELETE FROM "SongTag" WHERE ("SongId" = '5d90fdb3-6a6b-2c58-00c8-37974177440d')</span>
    <span>//DELETE FROM "SongTag" WHERE ("SongId" = '5d90fdb3-6a6b-2c58-00c8-37987f29b197')</span>

    <span>//UPDATE "Song" SET "Name" = CASE "Id"</span>
    <span>//WHEN '5d90fdb3-6a6b-2c58-00c8-37974177440d' THEN '爱你一万年.mp4'</span>
    <span>//WHEN '5d90fdb3-6a6b-2c58-00c8-37987f29b197' THEN '李白.mp4' END</span>
    <span>//WHERE ("Id" IN ('5d90fdb3-6a6b-2c58-00c8-37974177440d','5d90fdb3-6a6b-2c58-00c8-37987f29b197'))</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">CodeFirst</title>
    <id>https://freesql.net/guide/code-first.html</id>
    <link href="https://freesql.net/guide/code-first.html"/>
    <updated>2022-09-04T06:05:54.000Z</updated>
    <content type="html"><![CDATA[<p><code>FreeSql</code> 支持 <code>CodeFirst</code> 迁移结构至数据库，这应该是(<code>O/RM</code>)必须标配的一个功能。</p>
<p>与其他(<code>O/RM</code>)不同的是：<code>FreeSql</code>支持更多的数据库特性，而不只是支持基础的数据类型，这既是优点也是缺点，优点是充分利用数据库特性辅助开发，缺点是切换数据库变得困难。不同程序员的理念可能不太一致，<code>FreeSql</code>尽量把功能支持到极致，至于是否使用是项目组技术衡量的另一个问题。</p>
<p>尽管多种数据库适配逻辑非常复杂，<code>FreeSql</code>始终秉承优化程序开发习惯的原则尽量去实现，中间碰到了一些非技术无法攻克的难题，比如数据库的自定义类型，和实体类本身就是一种冲突，为了减少使用成本，诸如此类的数据库功能没有得到支持。</p>
<div><pre><code><span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connectionString<span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构【开发环境必备】，FreeSql不会扫描程序集，只有CRUD时才会生成表。</span>
    <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Console<span>.</span><span>Write</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="迁移结构" tabindex="-1"> 迁移结构</h2>
<table>
<thead>
<tr>
<th>创建数据库</th>
<th>Sqlite</th>
<th>Sql Server</th>
<th>MySql</th>
<th>PostgreSQL</th>
<th>Oracle</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>√</td>
<td>X <a href="https://github.com/luoyunchong/lin-cms-dotnetcore/blob/master/src/LinCms.Infrastructure/FreeSql/FreeSqlExtension.cs#L153" target="_blank" rel="noopener noreferrer">参考</a></td>
<td>X <a href="https://github.com/luoyunchong/lin-cms-dotnetcore/blob/master/src/LinCms.Infrastructure/FreeSql/FreeSqlExtension.cs#L129" target="_blank" rel="noopener noreferrer">参考</a></td>
<td>X<a href="https://github.com/luoyunchong/lin-cms-dotnetcore/blob/master/src/LinCms.Infrastructure/FreeSql/FreeSqlExtension.cs#L233" target="_blank" rel="noopener noreferrer">参考</a></td>
<td>X</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>实体＆表对比</th>
<th>添加</th>
<th>改名</th>
<th>删除</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>√</td>
<td>√</td>
<td>X</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>实体属性＆字段对比</th>
<th>添加</th>
<th>修改可空</th>
<th>修改自增</th>
<th>修改类型</th>
<th>改名</th>
<th>删除</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>X</td>
<td>√</td>
</tr>
</tbody>
</table>
<blockquote>
<p>为了保证安全，不提供删除字段。</p>
</blockquote>
<p>警告：如果实体类属性，与数据库表字段不完整映射的时候，未映射的字段有可能发生丢失。</p>
<blockquote>
<p>原因：某些迁移对比操作是：创建临时表、导入旧表数据、删除旧表。</p>
</blockquote>
<h3 id="freesql-提供两种-codefirst-移迁方法-自动和手动。" tabindex="-1"> FreeSql 提供两种 CodeFirst 移迁方法，自动和手动。</h3>
<p><strong>注意</strong>：谨慎、谨慎、谨慎在生产环境中使用该功能。</p>
<p><strong>注意</strong>：谨慎、谨慎、谨慎在生产环境中使用该功能。</p>
<p><strong>注意</strong>：谨慎、谨慎、谨慎在生产环境中使用该功能。</p>
<h3 id="自动同步实体结构【开发环境必备】" tabindex="-1"> 自动同步实体结构【开发环境必备】</h3>
<p>自动同步实体结构到数据库，程序运行中检查实体表是否存在，然后迁移执行创建或修改。</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span>IsAutoSyncDataStructure <span>=</span> <span>true</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><blockquote>
<p>此功能默认为开启状态，发布正式环境后，请修改此设置。</p>
</blockquote>
<blockquote>
<p>虽然【自动同步实体结构】功能开发非常好用，但是有个坏处，就是数据库后面会很乱，没用的字段可能一大堆，应尽量控制实体或属性命名的修改。</p>
</blockquote>
<ul>
<li>注意：只有当 CURD 到此表时，才会自动生成表结构。如需系统运行时迁移表结构，请使用<strong>SyncStructure</strong>方法</li>
<li><code>FreeSql</code>不会帮你生成数据库，需要你手动创建数据库。<strong>如果你使用<code>Mysql</code>、<code>Sql Server</code>,<code>PostgreSQL</code>，需要自动创建数据库.请参考此代码，自行 copy，<a href="https://github.com/luoyunchong/lin-cms-dotnetcore/blob/master/src/LinCms.Infrastructure/FreeSql/FreeSqlExtension.cs" target="_blank" rel="noopener noreferrer">FreeSqlExtension.cs</a></strong></li>
</ul>
<h3 id="禁用迁移" tabindex="-1"> 禁用迁移</h3>
<p>当【实体类】对应的是数据库【视图】或者其他时，可通过 [Table(DisableSyncStructure = true)] 禁用指定的实体迁移操作。</p>
<div><pre><code><span>[</span><span><span>Table</span><span><span>(</span>DisableSyncStructure <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>ModelDisableSyncStructure</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>false</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> pkid <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="备注" tabindex="-1"> 备注</h2>
<p>FreeSql CodeFirst 支持将 c# 代码内的注释，迁移至数据库的备注。先决条件：</p>
<p>1、实体类所在程序集，需要开启 xml 文档功能；</p>
<p>2、xml 文件必须与程序集同目录，且文件名：xxx.dll -&gt; xxx.xml；</p>
<blockquote>
<p>v1.5.0+ 版本增加了对 Description 特性的解析，优先级低于 c# 代码注释；</p>
</blockquote>
<h3 id="手工同步实体结构" tabindex="-1"> 手工同步实体结构</h3>
<p>提供接口方法实现对比实体，与数据库中的变化部分，返回 SQL 语句。</p>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> mysql<span>.</span>CodeFirst<span>.</span><span><span>GetComparisonDDLStatements</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>ushort</span></span> fusho <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>CREATE</span> <span>TABLE</span> <span>IF</span> <span>NOT</span> <span>EXISTS</span> <span><span>`</span>cccddd<span>`</span></span><span>.</span><span><span>`</span>Topic<span>`</span></span> <span>(</span>
    <span><span>`</span>Id<span>`</span></span> <span>INT</span><span>(</span><span>11</span><span>)</span> <span>NOT</span> <span>NULL</span> <span>AUTO_INCREMENT</span><span>,</span>
    <span><span>`</span>Clicks<span>`</span></span> <span>INT</span><span>(</span><span>11</span><span>)</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span><span>`</span>Title<span>`</span></span> <span>VARCHAR</span><span>(</span><span>255</span><span>)</span><span>,</span>
    <span><span>`</span>CreateTime<span>`</span></span> <span>DATETIME</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span><span>`</span>fusho<span>`</span></span> <span>SMALLINT</span><span>(</span><span>5</span><span>)</span> <span>UNSIGNED</span> <span>NOT</span> <span>NULL</span><span>,</span>
    <span>PRIMARY</span> <span>KEY</span> <span>(</span><span><span>`</span>Id<span>`</span></span><span>)</span>
<span>)</span> <span>Engine</span><span>=</span><span>InnoDB</span> <span>CHARACTER</span> <span>SET</span> utf8<span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>提供接口方法实现同步结构</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span><span>SyncStructure</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span>//同步实体类型到数据库</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h4 id="批量生成表结构" tabindex="-1"> 批量生成表结构</h4>
<ul>
<li>void SyncStructure(params Type[]) 重载方法支持数组,同步实体类型集合到数据库</li>
<li>IEntity 类，是实体类所在程序集的一个类即可。</li>
</ul>
<p>方法 1：扫描 IEntity 类所在程序集，反射得到类上有特性标签为 TableAttribute 的所有类，该方法需在实体类上指定了 [Table(Name = &quot;xxx&quot;)]特性标签</p>
<div><pre><code><span>public</span> <span>static</span> <span>Type<span>[</span><span>]</span></span> <span>GetTypesByTableAttribute</span><span>(</span><span>)</span>
<span>{</span>
    <span>List<span>&lt;</span>Type<span>></span></span> tableAssembies <span>=</span> <span>new</span> <span>List<span>&lt;</span>Type<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>foreach</span> <span>(</span><span>Type</span> type <span>in</span> Assembly<span>.</span><span>GetAssembly</span><span>(</span><span>typeof</span><span>(</span><span>IEntity</span><span>)</span><span>)</span><span>.</span><span>GetExportedTypes</span><span>(</span><span>)</span><span>)</span>
        <span>foreach</span> <span>(</span><span>Attribute</span> attribute <span>in</span> type<span>.</span><span>GetCustomAttributes</span><span>(</span><span>)</span><span>)</span>
            <span>if</span> <span>(</span>attribute <span>is</span> <span>TableAttribute</span> tableAttribute<span>)</span>
                <span>if</span> <span>(</span>tableAttribute<span>.</span>DisableSyncStructure <span>==</span> <span>false</span><span>)</span>
                    tableAssembies<span>.</span><span>Add</span><span>(</span>type<span>)</span><span>;</span>

    <span>return</span> tableAssembies<span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>调用</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span>SyncStructure</span><span>(</span><span>GetTypesByTableAttribute</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>方法 2：通过命名空间得到所有要创建的实体类.根据需要调整 entitiesFullName 下的命名空间值。比如我们创建一个 Entities 文件夹，用于存放实体类。该方法通过筛选 IEntity 类所在程序集所有的实体类。他们的命名空间都是 LinCms.Entities 开头，内部通过 StartsWith 判断。</p>
<div><pre><code><span>public</span> <span>static</span> <span>Type<span>[</span><span>]</span></span> <span>GetTypesByNameSpace</span><span>(</span><span>)</span>
<span>{</span>
    <span>List<span>&lt;</span>Type<span>></span></span> tableAssembies <span>=</span> <span>new</span> <span>List<span>&lt;</span>Type<span>></span></span><span>(</span><span>)</span><span>;</span>
    <span>List<span>&lt;</span><span>string</span><span>></span></span> entitiesFullName <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>
    <span>{</span>
        <span>"LinCms.Entities.Settings"</span><span>,</span>
        <span>"LinCms.Entities.Base"</span><span>,</span>
    <span>}</span><span>;</span>
    <span>foreach</span> <span>(</span><span>Type</span> type <span>in</span> Assembly<span>.</span><span>GetAssembly</span><span>(</span><span>typeof</span><span>(</span><span>IEntity</span><span>)</span><span>)</span><span>.</span><span>GetExportedTypes</span><span>(</span><span>)</span><span>)</span>
        <span>foreach</span> <span>(</span><span><span>var</span></span> fullname <span>in</span> entitiesFullName<span>)</span>
            <span>if</span> <span>(</span>type<span>.</span>FullName<span>.</span><span>StartsWith</span><span>(</span>fullname<span>)</span> <span>&amp;&amp;</span> type<span>.</span>IsClass<span>)</span>
                tableAssembies<span>.</span><span>Add</span><span>(</span>type<span>)</span><span>;</span>

    <span>return</span> tableAssembies<span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>或通过调用同步所有表结构</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span>SyncStructure</span><span>(</span><span>GetTypesByNameSpace</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="实体特性" tabindex="-1"> 实体特性</h2>
<p>指定实体的表名，指定 Name 后，实体类名变化不影响数据库对应的表。FreeSql 尽量支持了对多数据库或 schema 支持，不防试试指定表名为：其他数据库.表名，不同数据库的指定方式有差异，这一点以后深入解答。</p>
<div><pre><code><span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"db2.tb_topic111"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>Topic</span> <span>{</span>
  <span>//...</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>无指定实体的表名，修改为实体类名。指定数据库旧的表名，修改实体命名时，同时设置此参数为修改之前的值，CodeFirst 才可以正确修改数据库表；否则将视为【创建新表】。</p>
<div><pre><code><span>[</span><span><span>Table</span><span><span>(</span>OldName <span>=</span> <span>"Topic"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>Topic2</span> <span>{</span>
  <span>//...</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>ALTER</span> <span>TABLE</span> <span><span>`</span>cccddd<span>`</span></span><span>.</span><span><span>`</span>Topic<span>`</span></span> <span>RENAME</span> <span>TO</span> <span><span>`</span>cccddd<span>`</span></span><span>.</span><span><span>`</span>Topic2<span>`</span></span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>修改字段类型，把 Title 类型改为 varchar(128)。</p>
<div><pre><code><span>[</span><span><span>Column</span><span><span>(</span>DbType <span>=</span> <span>"varchar(128)"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><div><pre><code><span>ALTER</span> <span>TABLE</span> <span><span>`</span>cccddd<span>`</span></span><span>.</span><span><span>`</span>Topic2<span>`</span></span> <span>MODIFY</span> <span><span>`</span>Title<span>`</span></span> <span>VARCHAR</span><span>(</span><span>128</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>指定属性的字段名，这样指定后，修改实体的属性名不影响数据库对应的列。</p>
<div><pre><code><span>[</span><span><span>Column</span><span><span>(</span>Name <span>=</span> <span>"titl2"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>无指定属性的字段名，修改为属性名，指定数据库旧的列名，修改实体属性命名时，同时设置此参数为修改之前的值，CodeFirst 才可以正确修改数据库字段；否则将视为【新增字段】。</p>
<div><pre><code><span>[</span><span><span>Column</span><span><span>(</span>OldName <span>=</span> <span>"Title2"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><div><pre><code><span>ALTER</span> <span>TABLE</span> <span><span>`</span>cccddd<span>`</span></span><span>.</span><span><span>`</span>Topic2<span>`</span></span> CHANGE <span>COLUMN</span> <span><span>`</span>Title2<span>`</span></span> <span><span>`</span>Title<span>`</span></span> <span>VARCHAR</span><span>(</span><span>255</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">自定义特性</title>
    <id>https://freesql.net/guide/custom-attribute.html</id>
    <link href="https://freesql.net/guide/custom-attribute.html"/>
    <updated>2021-06-16T16:56:09.000Z</updated>
    <content type="html"><![CDATA[<h1 id="自定义特性" tabindex="-1"> 自定义特性</h1>
<p>本功能可实现与其他 ORM 使用一套 Attribute，避免维护两份实体特性的烦恼：</p>
<blockquote>
<p>v1.4.0+ 已自动识别 EFCore 实体特性 Key/Required/NotMapped/MaxLength/StringLength/DatabaseGenerated/Table/Column</p>
</blockquote>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ConfigEntity <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span><span>var</span></span> attr <span>=</span> e<span>.</span>EntityType<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>MyTableAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span> <span>as</span> <span>MyTableAttribute</span><span>;</span>
  <span>if</span> <span>(</span>attr <span>!=</span> <span>null</span><span>)</span>
    e<span>.</span>ModifyResult<span>.</span>Name <span>=</span> attr<span>.</span>Name<span>;</span> <span>//表名</span>
<span>}</span><span>;</span>
fsql<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span><span>var</span></span> attr <span>=</span> e<span>.</span>Property<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>MyColumnAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span> <span>as</span> <span>MyColumnAttribute</span><span>;</span>
  <span>if</span> <span>(</span>attr <span>!=</span> <span>null</span><span>)</span>
    e<span>.</span>ModifyResult<span>.</span>Name <span>=</span> attr<span>.</span>Name<span>;</span> <span>//字段名</span>
<span>}</span><span>;</span>

<span>[</span><span><span>MyTable</span><span><span>(</span><span>"xxx"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>YourEntity</span> <span>{</span>
  <span>[</span><span><span>MyColumn</span><span><span>(</span><span>"id"</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span><span>int</span></span> pkid <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>class</span> <span>MyTableAttribute</span> <span>:</span> <span><span>Attribute</span></span> <span>{</span>
  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>}</span>
  <span>public</span> <span>MyTableAttribute</span><span>(</span><span><span>string</span></span> name<span>)</span>
  <span>{</span>
    <span>this</span><span>.</span>Name <span>=</span> name<span>;</span>
  <span>}</span>
<span>}</span>
<span>class</span> <span>MyColumnAttribute</span> <span>:</span> <span><span>Attribute</span></span> <span>{</span>
  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>}</span>
  <span>public</span> <span>MyColumnAttribute</span><span>(</span><span><span>string</span></span> name<span>)</span>
  <span>{</span>
    <span>this</span><span>.</span>Name <span>=</span> name<span>;</span>
  <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="优先级" tabindex="-1"> 优先级</h2>
<p>数据库特性 &gt; 实体特性 &gt; FluentApi（配置特性） &gt; AOP（配置特性）</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">DbContext</title>
    <id>https://freesql.net/guide/db-context.html</id>
    <link href="https://freesql.net/guide/db-context.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="dbcontext" tabindex="-1"> DbContext</h1>
<p>FreeSql.DbContext 实现类似 EFCore 使用习惯，跟踪对象状态，最终通过 SaveChanges 方法提交事务。</p>
<h2 id="特性" tabindex="-1"> 特性</h2>
<ul>
<li>Select/Attach 快照对象，Update 只更新变化的字段；</li>
<li>Add/AddRange 插入数据，适配各数据库优化执行 ExecuteAffrows/ExecuteIdentity/ExecuteInserted；</li>
<li>AddOrUpdate 插入或更新；</li>
<li>SaveMany 方法快速保存导航对象（一对多、多对多）；</li>
</ul>
<h2 id="安装" tabindex="-1"> 安装</h2>
<blockquote>
<p>dotnet add package FreeSql.DbContext</p>
</blockquote>
<h2 id="如何使用" tabindex="-1"> 如何使用</h2>
<p>0、通用方法，为啥是 0？？？</p>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> ctx <span>=</span> fsql<span>.</span><span>CreateDbContext</span><span>(</span><span>)</span><span>)</span> <span>{</span>
  <span>//var db1 = ctx.Set&lt;Song>();</span>
  <span>//var db2 = ctx.Set&lt;Tag>();</span>

  <span><span>var</span></span> item <span>=</span> <span>new</span> <span>Song</span> <span>{</span> <span>}</span><span>;</span>
  ctx<span>.</span><span>Add</span><span>(</span>item<span>)</span><span>;</span>
  ctx<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>注意：DbContext 对象多线程不安全</p>
</blockquote>
<p>1、在 OnConfiguring 方法上配置与 IFreeSql 关联</p>
<div><pre><code><span>public</span> <span>class</span> <span>SongContext</span> <span>:</span> <span><span>DbContext</span></span> <span>{</span>

  <span>public</span> <span>DbSet<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>DbSet<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnConfiguring</span><span>(</span><span>DbContextOptionsBuilder</span> builder<span>)</span> <span>{</span>
    builder<span>.</span><span>UseFreeSql</span><span>(</span>GlobalVar<span>.</span>fsql<span>)</span><span>;</span>
    <span>//这里直接指定一个静态的 IFreeSql 对象即可，切勿重新 Build()</span>
  <span>}</span>

  <span>//每个 DbContext 只触发一次</span>
  <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ICodeFirst</span> codefirst<span>)</span>
  <span>{</span>
    codefirst<span>.</span><span><span>Entity</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span>eb <span>=></span>
    <span>{</span>
      eb<span>.</span><span>ToTable</span><span>(</span><span>"tb_song"</span><span>)</span><span>;</span>
      eb<span>.</span><span>Ignore</span><span>(</span>a <span>=></span> a<span>.</span>Field1<span>)</span><span>;</span>
      eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>)</span><span>.</span><span>HasColumnType</span><span>(</span><span>"varchar(50)"</span><span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>;</span>
      eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>Url<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>100</span><span>)</span><span>;</span>

      eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>RowVersion<span>)</span><span>.</span><span>IsRowVersion</span><span>(</span><span>)</span><span>;</span>
      eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>)</span><span>.</span><span>HasDefaultValueSql</span><span>(</span><span>"current_timestamp"</span><span>)</span><span>;</span>

      eb<span>.</span><span>HasKey</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>;</span>
      eb<span>.</span><span>HasIndex</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Id<span>,</span> a<span>.</span>Title <span>}</span><span>)</span><span>.</span><span>IsUnique</span><span>(</span><span>)</span><span>.</span><span>HasName</span><span>(</span><span>"idx_xxx11"</span><span>)</span><span>;</span>

      <span>//一对多、多对一</span>
      eb<span>.</span><span>HasOne</span><span>(</span>a <span>=></span> a<span>.</span>Type<span>)</span><span>.</span><span>HasForeignKey</span><span>(</span>a <span>=></span> a<span>.</span>TypeId<span>)</span><span>.</span><span>WithMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>)</span><span>;</span>

      <span>//多对多</span>
      eb<span>.</span><span>HasMany</span><span>(</span>a <span>=></span> a<span>.</span>Tags<span>)</span><span>.</span><span>WithMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>,</span> <span>typeof</span><span>(</span><span>Song_tag</span><span>)</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>

    codefirst<span>.</span><span><span>Entity</span><span><span>&lt;</span>SongType<span>></span></span></span><span>(</span>eb <span>=></span>
    <span>{</span>
      eb<span>.</span><span>HasMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>)</span><span>.</span><span>WithOne</span><span>(</span>a <span>=></span> a<span>.</span>Type<span>)</span><span>.</span><span>HasForeignKey</span><span>(</span>a <span>=></span> a<span>.</span>TypeId<span>)</span><span>;</span>

      eb<span>.</span><span>HasData</span><span>(</span><span>new</span><span>[</span><span>]</span>
      <span>{</span>
        <span>new</span> <span>SongType</span>
        <span>{</span>
          Id <span>=</span> <span>1</span><span>,</span>
          Name <span>=</span> <span>"流行"</span><span>,</span>
          Songs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
          <span>{</span>
            <span>new</span> <span>Song</span><span>{</span> Title <span>=</span> <span>"真的爱你"</span> <span>}</span><span>,</span>
            <span>new</span> <span>Song</span><span>{</span> Title <span>=</span> <span>"爱你一万年"</span> <span>}</span><span>,</span>
          <span>}</span><span>)</span>
        <span>}</span><span>,</span>
        <span>new</span> <span>SongType</span>
        <span>{</span>
          Id <span>=</span> <span>2</span><span>,</span>
          Name <span>=</span> <span>"乡村"</span><span>,</span>
          Songs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
          <span>{</span>
            <span>new</span> <span>Song</span><span>{</span> Title <span>=</span> <span>"乡里乡亲"</span> <span>}</span><span>,</span>
          <span>}</span><span>)</span>
        <span>}</span><span>,</span>
      <span>}</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>

    codefirst<span>.</span><span><span>SyncStructure</span><span><span>&lt;</span>SongType<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    codefirst<span>.</span><span><span>SyncStructure</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>;</span>
  <span>}</span>
<span>}</span>

<span>public</span> <span>class</span> <span>SongType</span> <span>{</span>
  <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span>List<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>Song</span> <span>{</span>
  <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span><span>string</span></span> Url <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span><span>int</span></span> TypeId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>SongType</span> Type <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>List<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span><span>int</span></span> Field1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span><span>long</span></span> RowVersion <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>Song_tag</span> <span>{</span>
  <span>public</span> <span><span>int</span></span> Song_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>Song</span> Song <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span><span>int</span></span> Tag_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>Tag</span> Tag <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>Tag</span> <span>{</span>
  <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span>List<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>使用的时候与 EFCore 类似：</p>
<div><pre><code><span><span>long</span></span> id <span>=</span> <span>0</span><span>;</span>

<span>using</span> <span>(</span><span><span>var</span></span> ctx <span>=</span> <span>new</span> <span>SongContext</span><span>(</span><span>)</span><span>)</span> <span>{</span>

  <span><span>var</span></span> song <span>=</span> <span>new</span> <span>Song</span> <span>{</span> <span>}</span><span>;</span>
  <span>await</span> ctx<span>.</span>Songs<span>.</span><span>AddAsync</span><span>(</span>song<span>)</span><span>;</span>
  id <span>=</span> song<span>.</span>Id<span>;</span>

  <span><span>var</span></span> adds <span>=</span> Enumerable<span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span> <span>100</span><span>)</span>
    <span>.</span><span>Select</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span> <span>{</span> Create_time <span>=</span> DateTime<span>.</span>Now<span>,</span> Is_deleted <span>=</span> <span>false</span><span>,</span> Title <span>=</span> <span>"xxxx"</span> <span>+</span> a<span>,</span> Url <span>=</span> <span>"url222"</span> <span>}</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
  <span>await</span> ctx<span>.</span>Songs<span>.</span><span>AddRangeAsync</span><span>(</span>adds<span>)</span><span>;</span>

  <span>for</span> <span>(</span><span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span> a <span>&lt;</span> adds<span>.</span>Count<span>;</span> a<span>++</span><span>)</span>
    adds<span>[</span>a<span>]</span><span>.</span>Title <span>=</span> <span>"dkdkdkdk"</span> <span>+</span> a<span>;</span>

  ctx<span>.</span>Songs<span>.</span><span>UpdateRange</span><span>(</span>adds<span>)</span><span>;</span>

  ctx<span>.</span>Songs<span>.</span><span>RemoveRange</span><span>(</span>adds<span>.</span><span>Skip</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Take</span><span>(</span><span>20</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>

  <span>//ctx.Songs.Update(adds.First());</span>

  adds<span>.</span><span>Last</span><span>(</span><span>)</span><span>.</span>Url <span>=</span> <span>"skldfjlksdjglkjjcccc"</span><span>;</span>
  ctx<span>.</span>Songs<span>.</span><span>Update</span><span>(</span>adds<span>.</span><span>Last</span><span>(</span><span>)</span><span>)</span><span>;</span>

  <span>//throw new Exception("回滚");</span>

  <span>await</span> ctx<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>2、注入方式使用</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span> <span>{</span>
  services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>Fsql<span>)</span><span>;</span>
  services<span>.</span><span><span>AddFreeDbContext</span><span><span>&lt;</span>SongContext<span>></span></span></span><span>(</span>options <span>=></span> options<span>.</span><span>UseFreeSql</span><span>(</span>Fsql<span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>在 mvc 中获取：</p>
<div><pre><code><span>IFreeSql</span> _orm<span>;</span>
<span>public</span> <span>ValuesController</span><span>(</span><span>SongContext</span> songContext<span>)</span> <span>{</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h2 id="优先级" tabindex="-1"> 优先级</h2>
<p>OnConfiguring &gt; AddFreeDbContext</p>
<h2 id="说明" tabindex="-1"> 说明</h2>
<ul>
<li>DbContext 操作的数据在最后 SaveChanges 时才批量保存；</li>
<li>DbContext 内所有操作，使用同一个事务；</li>
<li>当实体存在自增时，或者 Add/AddRange 的时候主键值为空，会提前开启事务；</li>
<li>支持同步/异步方法；</li>
</ul>
<h2 id="合并机制" tabindex="-1"> 合并机制</h2>
<p>db.Add(new Xxx());
db.Add(new Xxx());
db.Add(new Xxx());</p>
<p>这三步，会合并成一个批量插入的语句执行，前提是它们没有自增属性。</p>
<p>适用 Guid 主键，Guid 主键的值不用设置，交给 FreeSql 处理即可，空着的 Guid 主键会在插入时获取有序不重值的 Guid 值。</p>
<p>又比如：</p>
<p>db.Add(new Xxx());
db.Add(new Xxx());
db.Update(xxx);
db.Add(new Xxx());</p>
<p>Guid Id 的情况下，执行三次命令：前两次插入合并执行，update 为一次，后面的 add 为一次。</p>
<h2 id="联级保存" tabindex="-1"> 联级保存</h2>
<p>请移步文档 <a href="/guide/cascade-saving.html">【联级保存】</a></p>
<h2 id="实体变化事件" tabindex="-1"> 实体变化事件</h2>
<p>全局设置：</p>
<div><pre><code>fsql<span>.</span><span>SetDbContextOptions</span><span>(</span>opt <span>=></span> <span>{</span>
  opt<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
    Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
  <span>}</span><span>;</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>单独设置 DbContext 或者 UnitOfWork：</p>
<div><pre><code><span><span>var</span></span> ctx <span>=</span> fsql<span>.</span><span>CreateDbContext</span><span>(</span><span>)</span><span>;</span>
ctx<span>.</span>Options<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
  Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
<span>}</span><span>;</span>

<span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>;</span>
uow<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
  Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>参数 report 是一个 List 集合，集合元素的类型定义如下：</p>
<div><pre><code><span>public</span> <span>class</span> <span>ChangeInfo</span> <span>{</span>
  <span>public</span> <span><span>object</span></span> Object <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>EntityChangeType</span> Type <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
  <span>/// Type = Update 的时候，获取更新之前的对象</span>
  <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
  <span>public</span> <span><span>object</span></span> BeforeObject <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>enum</span> <span>EntityChangeType</span> <span>{</span> Insert<span>,</span> Update<span>,</span> Delete<span>,</span> SqlRaw <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>变化类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>实体对象被插入</td>
</tr>
<tr>
<td>Update</td>
<td>实体对象被更新</td>
</tr>
<tr>
<td>Delete</td>
<td>实体对象被删除</td>
</tr>
<tr>
<td>SqlRaw</td>
<td>执行了 SQL 语句</td>
</tr>
</tbody>
</table>
<p>SqlRaw 目前有两处地方比较特殊：</p>
<ul>
<li>多对多联级更新导航属性的时候，对中间表的全部删除操作；</li>
<li>通用仓储类 BaseRepository 有一个 Delete 方法，参数为表达式，而并非实体；</li>
</ul>
<div><pre><code><span><span>int</span></span> <span>Delete</span><span>(</span><span>Expression<span>&lt;</span>Func<span>&lt;</span>TEntity<span>,</span> <span>bool</span><span>></span><span>></span></span> predicate<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>DbContext.SaveChanges，或者 Repository 对实体的 Insert/Update/Delete，或者 UnitOfWork.Commit 操作都会最多触发一次该事件。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">DbFirst</title>
    <id>https://freesql.net/guide/db-first.html</id>
    <link href="https://freesql.net/guide/db-first.html"/>
    <updated>2022-09-04T08:36:12.000Z</updated>
    <content type="html"><![CDATA[<h1 id="dbfirst" tabindex="-1"> DbFirst</h1>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span>
     <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span>
     <span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="获取所有数据库" tabindex="-1"> 获取所有数据库</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> fsql<span>.</span>DbFirst<span>.</span><span>GetDatabases</span><span>(</span><span>)</span><span>;</span>
<span>//返回字符串数组, ["cccddd", "test"]</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h2 id="获取指定数据库的表信息" tabindex="-1"> 获取指定数据库的表信息</h2>
<div><pre><code><span><span>var</span></span> t2 <span>=</span> fsql<span>.</span>DbFirst<span>.</span><span>GetTablesByDatabase</span><span>(</span>fsql<span>.</span>DbFirst<span>.</span><span>GetDatabases</span><span>(</span><span>)</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span>
<span>//返回包括表、列详情、主键、唯一键、索引、外键、备注等等</span>

<span><span>var</span></span> t3 <span>=</span> fsql<span>.</span>DbFirst<span>.</span><span>GetTableByName</span><span>(</span><span>"table1"</span><span>)</span><span>;</span>
<span>//返回表的列详情、主键、唯一键、索引、备注等等</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="net-core-cli-推荐使用" tabindex="-1"> .NET Core CLI(推荐使用)</h2>
<p>代码生成器<code>FreeSql.Generator</code>,是 FreeSql 的代码生成器，可生成实体类，支持将数据库实体动态生成实体，默认有二个模板，基于 Razor，可指定自定义模板</p>
<ul>
<li><code>dotnet-tool</code>安装 <code>FreeSql.Generator</code></li>
</ul>
<div><pre><code>dotnet tool <span>install</span> -g FreeSql.Generator
</code></pre><div aria-hidden="true"><div></div></div></div><ul>
<li>更新<code>FreeSql.Generator</code></li>
</ul>
<div><pre><code>dotnet tool update -g FreeSql.Generator
</code></pre><div aria-hidden="true"><div></div></div></div><p>新建目录，在地址栏输入 cmd 快速打开命令窗口，输入命令：</p>
<div><pre><code>FreeSql.Generator --help
</code></pre><div aria-hidden="true"><div></div></div></div><p>命令行工具生成实体类极大好处，后续再次生成覆盖操作等于一键完成，并且支持 Mac/Linux 平台。</p>
<p><a href="https://www.cnblogs.com/igeekfan/p/freesql-generator.html" target="_blank" rel="noopener noreferrer">详细解读：生成器是如何实现的？</a></p>
<div><pre><code>C:\WINDOWS\system32>FreeSql.Generator --help
        ____                   ____         __
       / __/  ____ ___  ___   / __/ ___ _  / /
      / _/   / __// -_)/ -_) _\ \  / _ `/ / /
     /_/    /_/   \__/ \__/ /___/  \_, / /_/
                                    /_/


  # Github # https://github.com/dotnetcore/FreeSql v2.0.105

    FreeSql 快速生成数据库的实体类

    更新工具：dotnet tool update -g FreeSql.Generator


  # 快速开始 #

  > FreeSql.Generator -Razor 1 -NameOptions 0,0,0,0 -NameSpace MyProject -DB "MySql,Data Source=127.0.0.1;..."

     -Razor 1                  * 选择模板：实体类+特性
     -Razor 2                  * 选择模板：实体类+特性+导航属性
     -Razor "d:\diy.cshtml"    * 自定义模板文件

     -NameOptions              * 4个布尔值对应：
                                 首字母大写
                                 首字母大写,其他小写
                                 全部小写
                                 下划线转驼峰

     -NameSpace                * 命名空间

     -DB "MySql,data source=127.0.0.1;port=3306;user id=root;password=root;initial catalog=数据库;charset=utf8;sslmode=none;max pool size=2"
     -DB "SqlServer,data source=.;integrated security=True;initial catalog=数据库;pooling=true;max pool size=2"
     -DB "PostgreSQL,host=192.168.164.10;port=5432;username=postgres;password=123456;database=数据库;pooling=true;maximum pool size=2"
     -DB "Oracle,user id=user1;password=123456;data source=//127.0.0.1:1521/XE;pooling=true;max pool size=2"
     -DB "Sqlite,data source=document.db"
     -DB "Firebird,database=localhost:D:\fbdata\EXAMPLES.fdb;user=sysdba;password=123456;max pool size=2"
     -DB "Dameng,server=127.0.0.1;port=5236;user id=2user;password=123456789;database=2user;poolsize=2"
     -DB "KingbaseES,server=127.0.0.1;port=54321;uid=USER2;pwd=123456789;database=数据库"
     -DB "ShenTong,host=192.168.164.10;port=2003;database=数据库;username=SYSDBA;password=szoscar55;maxpoolsize=2"
                               * Dameng(达梦数据库)、KingbaseES(人大金仓数据库)、ShenTong(神舟通用数据库)

     -Filter                   Table+View+StoreProcedure
                               默认生成：表+视图+存储过程
                               如果不想生成视图和存储过程 -Filter View+StoreProcedure

     -Match                    表名或正则表达式，只生成匹配的表，如：dbo\.TB_.+

     -FileName                 文件名，默认：{name}.cs
     -Output                   保存路径，默认为当前 shell 所在目录
                               推荐在实体类目录创建 gen.bat，双击它重新所有实体类
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="常用选项" tabindex="-1"> 常用选项</h3>
<table>
<thead>
<tr>
<th style="text-align:left">选项</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">-Razor</td>
<td style="text-align:left">选择模板：<code>实体类+特性</code> <code>-Razor 1</code> /<code>实体类+特性+导航属性</code> <code>-Razor 1</code>/<code>自定义模板文件</code> <code>-Razor &quot;d:\diy.cshtml&quot;</code></td>
</tr>
<tr>
<td style="text-align:left">-NameOptions</td>
<td style="text-align:left">生成的实体命名规范，应只设置某一个为参数为 1，其中 4 个布尔值对应：<code>首字母大写</code>/<code>首字母大写,其他小写</code>/<code>全部小写</code>/<code>下划线转驼</code>（-NameOptions 0,0,0,1）</td>
</tr>
<tr>
<td style="text-align:left">-NameSpace</td>
<td style="text-align:left">命名空间</td>
</tr>
<tr>
<td style="text-align:left">-DB</td>
<td style="text-align:left">看下文中的-DB 参数</td>
</tr>
<tr>
<td style="text-align:left">-Filter</td>
<td style="text-align:left">Table+View+StoreProcedure（ 默认生成：表+视图+存储过程）， 如果不想生成视图和存储过程 -Filter View+StoreProcedure</td>
</tr>
<tr>
<td style="text-align:left">-Match</td>
<td style="text-align:left">表名或正则表达式，只生成匹配的表，如：dbo.TB_.+</td>
</tr>
<tr>
<td style="text-align:left">-FileName</td>
<td style="text-align:left">文件名，默认：{name}.cs</td>
</tr>
<tr>
<td style="text-align:left">-Output</td>
<td style="text-align:left">推荐在实体类目录创建 gen.bat，双击它重新所有实体类</td>
</tr>
</tbody>
</table>
<h3 id="db-参数" tabindex="-1"> -DB 参数</h3>
<div><pre><code>-DB "MySql,data source=127.0.0.1;port=3306;user id=root;password=root;initial catalog=数据库;charset=utf8;sslmode=none;max pool size=2"
-DB "SqlServer,data source=.;integrated security=True;initial catalog=数据库;pooling=true;max pool size=2"
-DB "PostgreSQL,host=192.168.164.10;port=5432;username=postgres;password=123456;database=数据库;pooling=true;maximum pool size=2"
-DB "Oracle,user id=user1;password=123456;data source=//127.0.0.1:1521/XE;pooling=true;max pool size=2"
-DB "Sqlite,data source=document.db"
-DB "Firebird,database=localhost:D:\fbdata\EXAMPLES.fdb;user=sysdba;password=123456;max pool size=2"
-DB "Dameng,server=127.0.0.1;port=5236;user id=2user;password=123456789;database=2user;poolsize=2"
-DB "KingbaseES,server=127.0.0.1;port=54321;uid=USER2;pwd=123456789;database=数据库"
-DB "ShenTong,host=192.168.164.10;port=2003;database=数据库;username=SYSDBA;password=szoscar55;maxpoolsize=2"
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="示例" tabindex="-1"> 示例</h3>
<blockquote>
<p>FreeSql.Generator -Razor 1 -NameOptions 0,0,0,1 -NameSpace LinCms.Core.Entities -DB &quot;MySql,Data Source=127.0.0.1;Port=3306;User ID=root;Password=123456;Initial Catalog=lincms;Charset=utf8;SslMode=none;Max pool size=2&quot;</p>
</blockquote>
<ul>
<li>数据库表名是下划线，字段也是下划线方式。</li>
<li>-Razor 指定 第一个模板</li>
<li>-NameOptions 0,0,0,1 最后一个 1，代表 下划线转驼峰，满足 C#命名规则</li>
<li>-NameSpace 指定了命名空间 LinCms.Core.Entities</li>
<li>-DB 就是数据库的相关配置</li>
<li>mysql 本地地址 127.0.0.1 3306 端口 用户名 root 密码 123456 数据库 lin-cms</li>
<li>-Match book 这样就能只生成 book，支持正则表达式，如 -Match lin<em>user 就会生成以 lin_user 开头的表。如 dbo.TB</em>.+，会生成以 TB 开头的表。即只生成匹配的表</li>
</ul>
<h2 id="安装-winform-生成器-已停止更新" tabindex="-1"> 安装 Winform 生成器（已停止更新）</h2>
<p>源码地址：<a href="https://github.com/2881099/FreeSql.Tools" target="_blank" rel="noopener noreferrer">FreeSql.Tools</a></p>
<blockquote>
<p>作者：<a href="https://github.com/mypeng1985" target="_blank" rel="noopener noreferrer">mypeng1985</a> 开发了两个版本</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/16286519/76141354-4790e980-609e-11ea-869b-bb2c6980d98f.png" alt="image" loading="lazy"></p>
<p><img src="https://user-images.githubusercontent.com/16286519/58793525-e0cf3300-8628-11e9-8959-d2efed685843.png" alt="image" loading="lazy"></p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">删除</title>
    <id>https://freesql.net/guide/delete.html</id>
    <link href="https://freesql.net/guide/delete.html"/>
    <updated>2022-06-30T11:32:52.000Z</updated>
    <content type="html"><![CDATA[<h1 id="删除" tabindex="-1"> 删除</h1>
<p>删除是一个非常危险的操作，FreeSql 对删除支持并不强大，默认仅支持单表、且有条件的删除方法。</p>
<p>若 <code>Where</code> 条件为空的时候执行，仅返回 <code>0</code> 或默认值，不执行真正的 SQL 删除操作。</p>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connectionString<span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="动态条件" tabindex="-1"> 动态条件</h2>
<div><pre><code>fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span><span>object</span></span> dywhere<span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p><code>dywhere</code> 支持：</p>
<ul>
<li>主键值</li>
<li><code>new[] { 主键值1, 主键值2 }</code></li>
<li>Topic 对象</li>
<li><code>new[] { Topic对象1, Topic对象2 }</code></li>
<li><code>new { id = 1 }</code></li>
</ul>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span> <span>1</span><span>,</span> <span>2</span> <span>}</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` = 1 OR `Id` = 2)</span>

<span><span>var</span></span> t2 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>1</span><span>,</span> Title <span>=</span> <span>"test"</span> <span>}</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` = 1)</span>

<span><span>var</span></span> t3 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span> <span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>1</span><span>,</span> Title <span>=</span> <span>"test"</span> <span>}</span><span>,</span> <span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>2</span><span>,</span> Title <span>=</span> <span>"test"</span> <span>}</span> <span>}</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` in (1, 2))</span>

<span><span>var</span></span> t4 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>new</span> <span>{</span> id <span>=</span> <span>1</span> <span>}</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="删除条件" tabindex="-1"> 删除条件</h2>
<blockquote>
<p>出于安全考虑，没有条件不执行删除动作，避免误删除全表数据。删除全表数据：<code>fsql.Delete&lt;T&gt;().Where(&quot;1=1&quot;).ExecuteAffrows()</code></p>
</blockquote>
<div><pre><code><span><span>var</span></span> t5 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` = 1)</span>

<span><span>var</span></span> t6 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>"id = @id"</span><span>,</span> <span>new</span> <span>{</span> id <span>=</span> <span>1</span> <span>}</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (id = @id)</span>

<span><span>var</span></span> item <span>=</span> <span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>1</span><span>,</span> Title <span>=</span> <span>"newtitle"</span> <span>}</span><span>;</span>
<span><span>var</span></span> t7 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>item<span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` = 1)</span>

<span><span>var</span></span> items <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
<span>for</span> <span>(</span><span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span> a <span>&lt;</span> <span>10</span><span>;</span> a<span>++</span><span>)</span> items<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> a <span>+</span> <span>1</span><span>,</span> Title <span>=</span> <span><span>$"newtitle</span><span><span>{</span><span>a</span><span>}</span></span><span>"</span></span><span>,</span> Clicks <span>=</span> a <span>*</span> <span>100</span> <span>}</span><span>)</span><span>;</span>
<span><span>var</span></span> t8 <span>=</span> fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>items<span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//DELETE FROM `Topic` WHERE (`Id` IN (1,2,3,4,5,6,7,8,9,10))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="字典删除" tabindex="-1"> 字典删除</h2>
<div><pre><code><span><span>var</span></span> dic <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"id"</span><span>,</span> <span>1</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"name"</span><span>,</span> <span>"xxxx"</span><span>)</span><span>;</span>

fsql<span>.</span><span>DeleteDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="iselect-todelete-高级删除" tabindex="-1"> ISelect.ToDelete 高级删除</h2>
<p><code>IDelete</code> 默认不支持导航对象，多表关联等。<code>ISelect.ToDelete</code> 可将查询转为 <code>IDelete</code>，以便使用导航对象删除数据，如下：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T1<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Options<span>.</span>xxx <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToDelete</span><span>(</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>注意：此方法不是将数据查询到内存循环删除，上面的代码产生如下 SQL 执行：</p>
<div><pre><code><span>DELETE</span> <span>FROM</span> <span><span>`</span>T1<span>`</span></span> <span>WHERE</span> id <span>in</span> <span>(</span><span>select</span> a<span>.</span>id <span>from</span> T1 a <span>left</span> <span>join</span> Options b <span>on</span> b<span>.</span>t1id <span>=</span> a<span>.</span>id <span>where</span> b<span>.</span>xxx <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>复杂删除使用此方法的好处：</p>
<ul>
<li>删除前可预览测试数据，防止错误删除操作；</li>
<li>支持复杂的删除操作，例如：<code>ISelect</code> 上使用 <code>Limit(10)</code> 删除附合条件的前 10 条记录；</li>
</ul>
<h2 id="ibaserepository-级联删除" tabindex="-1"> IBaseRepository 级联删除</h2>
<p>1、第一种：基于【对象】级联删除</p>
<blockquote>
<p>比如 Include/IncludeMany 查询的对象，可以使用此方法级联删除它们。</p>
</blockquote>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Group<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>true</span><span>;</span> <span>//关键设置</span>
repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>UserGroup</span>
<span>{</span>
    GroupName <span>=</span> <span>"group01"</span><span>,</span>
    Users <span>=</span> <span>new</span> <span>List<span>&lt;</span>User<span>></span></span>
    <span>{</span>
        <span>new</span> <span>User</span> <span>{</span> Username <span>=</span> <span>"admin01"</span><span>,</span> Password <span>=</span> <span>"pwd01"</span><span>,</span> UserExt <span>=</span> <span>new</span> <span>UserExt</span> <span>{</span> Remark <span>=</span> <span>"用户备注01"</span> <span>}</span> <span>}</span><span>,</span>
        <span>new</span> <span>User</span> <span>{</span> Username <span>=</span> <span>"admin02"</span><span>,</span> Password <span>=</span> <span>"pwd02"</span><span>,</span> UserExt <span>=</span> <span>new</span> <span>UserExt</span> <span>{</span> Remark <span>=</span> <span>"用户备注02"</span> <span>}</span> <span>}</span><span>,</span>
        <span>new</span> <span>User</span> <span>{</span> Username <span>=</span> <span>"admin03"</span><span>,</span> Password <span>=</span> <span>"pwd03"</span><span>,</span> UserExt <span>=</span> <span>new</span> <span>UserExt</span> <span>{</span> Remark <span>=</span> <span>"用户备注03"</span> <span>}</span> <span>}</span><span>,</span>
    <span>}</span>
<span>}</span><span>)</span><span>;</span> <span>//级联添加测试数据</span>
<span>//INSERT INTO "usergroup"("groupname") VALUES('group01') RETURNING "id"</span>
<span>//INSERT INTO "user"("username", "password", "groupid") VALUES('admin01', 'pwd01', 1), ('admin02', 'pwd02', 1), ('admin03', 'pwd03', 1) RETURNING "id" as "Id", "username" as "Username", "password" as "Password", "groupid" as "GroupId"</span>
<span>//INSERT INTO "userext"("userid", "remark") VALUES(3, '用户备注01'), (4, '用户备注02'), (5, '用户备注03')</span>

<span><span>var</span></span> groups <span>=</span> repo<span>.</span>Select
    <span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Users<span>,</span>
        then <span>=></span> then<span>.</span><span>Include</span><span>(</span>b <span>=></span> b<span>.</span>UserExt<span>)</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>Delete</span><span>(</span>groups<span>)</span><span>;</span> <span>//级联删除，递归向下遍历 group OneToOne/OneToMany/ManyToMany 导航属性</span>
<span>//DELETE FROM "userext" WHERE ("userid" IN (3,4,5))</span>
<span>//DELETE FROM "user" WHERE ("id" IN (3,4,5))</span>
<span>//DELETE FROM "usergroup" WHERE ("id" = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>2、第二种：基于【数据库】级联删除</p>
<blockquote>
<p>根据设置的导航属性，递归删除 OneToOne/OneToMany/ManyToMany 对应数据，并返回已删除的数据。此功能不依赖数据库外键</p>
</blockquote>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Group<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> ret <span>=</span> repo<span>.</span><span>DeleteCascadeByDatabase</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>;</span>
<span>//SELECT a."id", a."username", a."password", a."groupid" FROM "user" a WHERE (a."groupid" = 1)</span>
<span>//SELECT a."userid", a."remark" FROM "userext" a WHERE (a."userid" IN (3,4,5))</span>
<span>//DELETE FROM "userext" WHERE ("userid" IN (3,4,5))</span>
<span>//DELETE FROM "user" WHERE ("id" IN (3,4,5))</span>
<span>//DELETE FROM "usergroup" WHERE ("id" = 1)</span>

<span>//ret   Count = 7	System.Collections.Generic.List&lt;object></span>
<span>//  [0]	{UserExt}	object {UserExt}</span>
<span>//  [1]	{UserExt}	object {UserExt}</span>
<span>//  [2]	{UserExt}	object {UserExt}</span>
<span>//  [3]	{User}	    object {User}</span>
<span>//  [4]	{User}	    object {User}</span>
<span>//  [5]	{User}  	object {User}</span>
<span>//  [6]	{UserGroup}	object {UserGroup}</span>

<span>public</span> <span>class</span> <span>Group</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> GroupName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>User<span>.</span>GroupId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>List<span>&lt;</span>User<span>></span></span> Users <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>User</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Username <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Password <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> GroupId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>Id<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>UserExt</span> UserExt <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>UserExt</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> UserId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Remark <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>UserId<span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>User</span> User <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="api" tabindex="-1"> API</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>表达式条件，仅支持实体基础成员（不包含导航对象）</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>原生 sql 语法条件，Where(&quot;id = @id&quot;, new { id = 1 })</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>传入实体或集合，将其主键作为条件</td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
</tr>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回影响的行数</td>
</tr>
<tr>
<td>ExecuteDeleted</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 语句，返回被删除的记录</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">实体特性✨</title>
    <id>https://freesql.net/guide/entity-attribute.html</id>
    <link href="https://freesql.net/guide/entity-attribute.html"/>
    <updated>2022-08-17T03:18:17.000Z</updated>
    <content type="html"><![CDATA[<h1 id="实体特性✨" tabindex="-1"> 实体特性✨</h1>
<p>v1.4.0+ 已自动识别 EFCore 实体特性 Key/Required/NotMapped/MaxLength/StringLength/DatabaseGenerated/Table/Column</p>
<h2 id="名称" tabindex="-1"> 名称</h2>
<div><pre><code><span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"tb_topic"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>Topic</span> <span>{</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>架构：[Table(Name = &quot;dbo.tb_topic&quot;)]</p>
<p>注意：带点的表名，使用 [Table(Name = &quot;`sys.config`&quot;)] 解决</p>
<blockquote>
<p>指定表名的几种方法，优先级从小到大：</p>
</blockquote>
<ul>
<li>1、实体类名</li>
<li>2、Aop fsql.Aop.ConfigEntity += (_, e) =&gt; <a href="http://e.ModifyResult.Name" target="_blank" rel="noopener noreferrer">e.ModifyResult.Name</a> = &quot;public.tabname&quot;</li>
<li>3、FluentApi fsql.CodeFirst.ConfigEntity(a =&gt; <a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>(&quot;public.tabname&quot;))</li>
<li>4、[Table(Name = &quot;public.tabname&quot;)]</li>
<li>5、AsTable fsql.Select&lt;T&gt;().AsTable((_, old) =&gt; &quot;public.tabname&quot;).ToList()</li>
</ul>
<blockquote>
<p>v3.2.660 可通过 UseMappingPriority 调整优先级</p>
</blockquote>
<p>改名：须指定旧的表名：[Table(OldName = &quot;Topic&quot;)]</p>
<blockquote>
<p>属性名称：[Column(Name = &quot;xxx&quot;)]</p>
</blockquote>
<h2 id="主键-primary-key" tabindex="-1"> 主键(Primary Key)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>约定：</p>
<ul>
<li>
<p>当没有指明主键时，命名为 id 的字段将成为主键；（不区分大小写）</p>
</li>
<li>
<p>当主键是 Guid 类型时，插入时会自动创建（有序、不重复）的值，所以不需要自己赋值；（支持分布式）</p>
</li>
</ul>
<blockquote>
<p>联合主键，在多个属性标记特性</p>
</blockquote>
<h2 id="自增-identity" tabindex="-1"> 自增(Identity)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>约定：</p>
<ul>
<li>当没有指明主键时，标记自增的成员将成为主键；</li>
<li>DbFirst 模式序列：[Column(IsIdentity = true, InsertValueSql = &quot;seqname.nextval&quot;)]</li>
</ul>
<h2 id="唯一键-unique-key-、索引-index" tabindex="-1"> 唯一键(Unique Key)、索引（Index）</h2>
<div><pre><code><span>[</span><span><span>Index</span><span><span>(</span><span>"uk_phone"</span><span>,</span> <span>"phone"</span><span>,</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>[</span><span><span>Index</span><span><span>(</span><span>"uk_group_index"</span><span>,</span> <span>"group,index"</span><span>,</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>[</span><span><span>Index</span><span><span>(</span><span>"uk_group_index22"</span><span>,</span> <span>"group, index22 desc"</span><span>,</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>AddUniquesInfo</span> <span>{</span>
    <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> phone <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>string</span></span> <span>group</span> <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> index <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> index22 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>第三个参数 true 的时候是唯一键，false 的时候是普通索引。</p>
</blockquote>
<blockquote>
<p>分表场景的索引可以这样：[Index(&quot;{tablename}_idx_01&quot;, &quot;phone&quot;)]</p>
</blockquote>
<h2 id="数据库类型-dbtype" tabindex="-1"> 数据库类型(DbType)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>DbType <span>=</span> <span>"varchar(128) NOT NULL"</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>可以在类型上指定 NOT NULL，也可以通过 [Column(IsNullable = false)] 设置；</p>
<blockquote>
<p>decimal 指定长度 [Column(DbType = &quot;decimal(10,2)&quot;)] 或者 [Column(Precision = 10, Scale = 2)]</p>
</blockquote>
<blockquote>
<p>string 指定长度 [Column(DbType = &quot;varchar(128)&quot;)] 或者 [MaxLength(128)] 或者 [Column(StringLength = 128)]，当长度 -1 时产生的映射如下：</p>
</blockquote>
<h2 id="text类型-column-stringlength-1" tabindex="-1"> Text类型 [Column(StringLength =-1)]</h2>
<p>当长度 -1 时产生的映射如下：</p>
<table>
<thead>
<tr>
<th>MySql</th>
<th>PostgreSQL</th>
<th>SqlServer</th>
<th>Oracle</th>
<th>Sqlite</th>
<th>Firebird</th>
<th>MsAccess</th>
<th>达梦</th>
<th>金仓</th>
<th>神通</th>
<th>南通</th>
</tr>
</thead>
<tbody>
<tr>
<td>text</td>
<td>text</td>
<td>nvarchar(max)</td>
<td>nclob</td>
<td>text</td>
<td>blob sub_type 1</td>
<td>longtext</td>
<td>text</td>
<td>text</td>
<td>text</td>
<td>text</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注意：Oracle nclob 需要 v1.3.2+ 版本才支持，否则将映射 nvarchar2(4000)</p>
</blockquote>
<blockquote>
<p>注意：MySql [MaxLength(-2)] 或者 [Column(StringLength = -2)] 映射类型 longtext，其他数据库的映射规则与 -1 相同</p>
</blockquote>
<h2 id="服务器时间-servertime" tabindex="-1"> 服务器时间(ServerTime)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>

    <span>[</span><span><span>Column</span><span><span>(</span>ServerTime <span>=</span> DateTimeKind<span>.</span>Utc<span>,</span> CanUpdate <span>=</span> <span>false</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    
    <span>[</span><span><span>Column</span><span><span>(</span>ServerTime <span>=</span> DateTimeKind<span>.</span>Utc<span>)</span></span></span><span>]</span>
    <span>public</span> <span>DateTime</span> UpdateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>使用数据库时间执行插入数据，注意：</p>
<p>1、一但设置了这个特性，插入的时候设置属性值是无效的；</p>
<p>2、插入实体执行成功后，实体的值还是 c# 时间；</p>
<blockquote>
<p>v1.1.0 - ServerTime 特性，对 Update 方法时也能生效</p>
</blockquote>
<h2 id="可空-nullable" tabindex="-1"> 可空(Nullable)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsNullable <span>=</span> <span>false</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>在不指定 DbType、IsNullable 时，FreeSql 提供默认设定，如：</p>
<ul>
<li>int -&gt; not null（不可为空）</li>
<li>int? -&gt; null（可空）</li>
</ul>
<p>一般在使用 string 类型时，才需要手工指明是否可空（string 默认可空）；</p>
<h2 id="忽略-ignore" tabindex="-1"> 忽略(Ignore)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIgnore <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>当实体有属性不需要映射的时候使用，内部自动忽略了对象的映射；</p>
<p>当实体内的属性不是可接受的类型时，可以不用指定该特定，如下不必要的指定：</p>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIgnore <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>Topic</span> Parent <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="乐观锁-rowversion" tabindex="-1"> 乐观锁(RowVersion)</h2>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>IsVersion <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Version <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>更新整个实体数据时，在并发情况下极容易造成旧数据将新的记录更新。</p>
<p>乐观锁的原理，是利用实体某字段，如：long version，更新前先查询数据，此时 version 为 1，更新时产生的 SQL 会附加 where version = 1，当修改失败时（即 Affrows == 0）抛出异常（DbUpdateVersionException）。</p>
<p>每个实体只支持一个乐观锁属性。</p>
<blockquote>
<p>适用 SetSource 更新，无论使用什么方法更新 version 的值都会增加 1</p>
</blockquote>
<h2 id="自定义类型映射-maptype" tabindex="-1"> 自定义类型映射(MapType)</h2>
<div><pre><code><span>class</span> <span>EnumTestMap</span> <span>{</span>
    <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum</span> enum_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum<span>?</span></span> enumnullable_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>int</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum</span> enum_to_int <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>int</span><span>?</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum<span>?</span></span> enumnullable_to_int <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>BigInteger</span> biginteger_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>BigInteger<span>?</span></span> bigintegernullable_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>enum</span> <span>ToStringMapEnum</span> <span>{</span> 中国人<span>,</span> abc<span>,</span> 香港 <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>BigInteger 也可以映射使用，但请注意：仅仅是 CURD 方便， Equals == 判断可以使用，无法实现 + - * / 等操作；</p>
<p>v0.9.15 版本还可以将值对象映射成 typeof(string)，安装扩展包：</p>
<blockquote>
<p>dotnet add package FreeSql.Extensions.JsonMap</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span>UseJsonMap</span><span>(</span><span>)</span><span>;</span> <span>//开启功能</span>

<span>class</span> <span>TestConfig</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"sysconfig"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>S_SysConfig</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>JsonMap</span></span><span>]</span>
    <span>public</span> <span>TestConfig</span> Config <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="字段位置-position" tabindex="-1"> 字段位置(Position)</h2>
<p>适用场景：当实体类继承时，CodeFirst创建表的字段顺序可能不是想要的，通过该特性可以设置顺序。</p>
<p>创建表时指定字段位置，如：[Column(Position = 1]，可为负数即反方向位置；</p>
<h2 id="可插入-caninsert-、可更新-canupdate" tabindex="-1"> 可插入(CanInsert)、可更新(CanUpdate)</h2>
<p>该字段是否可以插入或更新，默认值true，指定为false插入或更新时该字段会被忽略。</p>
<p>当指明了 InsertColumn/UpdateColumns 等方法时，该特性作用可能失效。例如 CanInsert = false 时，又指明了 InsertColumns 该属性，则仍然会插入。</p>
<h2 id="自定义插入值-insertvaluesql" tabindex="-1"> 自定义插入值(InsertValueSql)</h2>
<p>执行 Insert 方法时使用此值，它的语法是 SQL。</p>
<p>注意：如果是 getdate() 这种请可考虑使用 ServerTime，因为它对数据库间作了适配。</p>
<div><pre><code><span>class</span> <span>Type</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>InsertValueSql <span>=</span> <span>"'xxx'"</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Type</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `type`(`Name`) VALUES('xxx')</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="自定义重写-rewritesql-、重读-rereadsql" tabindex="-1"> 自定义重写(RewriteSql)、重读(RereadSql)</h2>
<p>写入时重写 SQL、读取时重写 SQL，适合 geography 类型的读写场景。</p>
<div><pre><code><span>[</span><span><span>Column</span><span><span>(</span>
    DbType <span>=</span> <span>"geography"</span><span>,</span> 
    RewriteSql <span>=</span> <span>"geography::STGeomFromText({0}, 4236)"</span><span>,</span> 
    RereadSql <span>=</span> <span>"{0}.STAsText()"</span>
<span>)</span></span></span><span>]</span>
<span>public</span> <span><span>string</span></span> geo <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

<span>//插入：INSERT INTO [ts_geocrud01]([id], [geo]) VALUES(@id_0, geography::STGeomFromText(@geo_0, 4236))</span>

<span>//查询：SELECT TOP 1 a.[id], a.[geo].STAsText() </span>
<span>//FROM [ts_geocrud01] a </span>
<span>//WHERE (a.[id] = 'c7227d5e-0bcf-4b71-8f0f-d69a552fe84e')</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="禁用迁移" tabindex="-1"> 禁用迁移</h2>
<p>IFreeSql.CodeFirst.IsAutoSyncStructure 可设置全局【自动迁移结构】功能，也可通过 FreeSqlBuilder.UseAutoSyncStructure(true) 创建 IFreeSql 的时候设置功能。</p>
<p>当【实体类】对应的是数据库【视图】或者其他时，可通过 [Table(DisableSyncStructure = true)] 禁用指定的实体迁移操作。</p>
<div><pre><code><span>[</span><span><span>Table</span><span><span>(</span>DisableSyncStructure <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>ModelDisableSyncStructure</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>false</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> pkid <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="备注" tabindex="-1"> 备注</h2>
<p>FreeSql CodeFirst 支持将 c# 代码内的注释，迁移至数据库的备注。先决条件：</p>
<p>1、实体类所在程序集，需要开启 xml 文档功能；</p>
<p>2、xml 文件必须与程序集同目录，且文件名：xxx.dll -&gt; xxx.xml；</p>
<blockquote>
<p>v1.5.0+ 版本增加了对 Description 特性的解析，优先级低于 c# 代码注释；</p>
</blockquote>
<h2 id="优先级" tabindex="-1"> 优先级</h2>
<p>数据库特性 &gt; 实体特性 &gt; FluentApi（配置特性） &gt; Aop（配置特性）</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">表达式函数</title>
    <id>https://freesql.net/guide/expression-function.html</id>
    <link href="https://freesql.net/guide/expression-function.html"/>
    <updated>2022-08-30T14:02:47.000Z</updated>
    <content type="html"><![CDATA[<h1 id="表达式函数" tabindex="-1"> 表达式函数</h1>
<p>这是 <code>FreeSql</code> 非常特色的功能之一，深入细化函数解析，所支持的类型基本都可以使用对应的表达式函数，例如 日期、字符串、<code>IN</code>查询、数组（<code>PostgreSQL</code>的数组）、字典（PostgreSQL HStore)等等。</p>
<h2 id="动态lambda表达式" tabindex="-1"> 动态Lambda表达式</h2>
<ul>
<li>
<p><code>And</code>、<code>Or</code>扩展方法 <a href="https://github.com/dotnetcore/FreeSql/blob/master/FreeSql/Extensions/LambadaExpressionExtensions.cs" target="_blank" rel="noopener noreferrer">LambadaExpressionExtensions.cs</a></p>
</li>
<li>
<p>单表</p>
</li>
</ul>
<div><pre><code><span>Expression<span>&lt;</span>Func<span>&lt;</span>T<span>,</span> <span>bool</span><span>></span><span>></span></span> <span>where</span> <span>=</span> <span>null</span><span>;</span>
<span>where</span> <span>=</span> <span>where</span><span>.</span><span>And</span><span>(</span>b <span>=></span> b<span>.</span>num <span>></span> <span>0</span><span>)</span><span>;</span>
<span>where</span> <span>=</span> <span>where</span><span>.</span><span>Or</span><span>(</span>b <span>=></span> b<span>.</span>num <span>></span> <span>0</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>where</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><ul>
<li>多表</li>
</ul>
<div><pre><code><span>Expression<span>&lt;</span>Func<span>&lt;</span>HzyTuple<span>&lt;</span>T1<span>,</span> T2<span>,</span> T3<span>,</span> T4<span>,</span> T5<span>,</span> T6<span>></span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>where</span> <span>=</span> <span>null</span><span>;</span>
<span>where</span> <span>=</span> <span>where</span><span>.</span><span>Or</span><span>(</span>a <span>=></span> a<span>.</span>t6<span>.</span>Id <span>></span> <span>0</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T1<span>,</span> T2<span>,</span> T3<span>,</span> T4<span>,</span> T5<span>,</span> T6<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>where</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h2 id="in查询" tabindex="-1"> In查询</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> <span>new</span><span>[</span><span>]</span> <span>{</span> <span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span> <span>}</span><span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT .. FROM ..</span>
<span>//WHERE (a.`Id` in (1,2,3))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>已优化，防止 where in 元素多过的 SQL 错误，如：</p>
</blockquote>
<blockquote>
<p>[Err] ORA-01795: maximum number of expressions in a list a 1000</p>
</blockquote>
<p>原来：where id in (1..1333)</p>
<p>现在：where id in (1..500) or id in (501..1000) or id in (1001..1333)</p>
<h2 id="in多列查询" tabindex="-1"> In多列查询</h2>
<div><pre><code><span>//元组集合</span>
<span>vae</span> lst <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>(</span>Guid<span>,</span> DateTime<span>)</span><span>></span></span><span>(</span><span>)</span><span>;</span>
lst<span>.</span><span>Add</span><span>(</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>,</span> DateTime<span>.</span>Now<span>)</span><span>)</span><span>;</span>
lst<span>.</span><span>Add</span><span>(</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>,</span> DateTime<span>.</span>Now<span>)</span><span>)</span><span>;</span>

<span><span>var</span></span> t2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> lst<span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>,</span> a<span>.</span>ct1<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT .. FROM ..</span>
<span>//WHERE (a."Id" = '685ee1f6-bdf6-4719-a291-c709b8a1378f' AND a."ct1" = '2019-12-07 23:55:27' OR </span>
<span>//a."Id" = '5ecd838a-06a0-4c81-be43-1e77633b7404' AND a."ct1" = '2019-12-07 23:55:27')</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>v3.2.650 使用 .Where(a =&gt; list.Any(b =&gt; b.Item1 == a. Id &amp;&amp; b.Item2 == a. ct1))</p>
</blockquote>
<blockquote>
<p>实现代码：<a href="/extra/issues-in-valuetype.html">In多列查询，表达式自定义实现</a></p>
</blockquote>
<h2 id="in子表" tabindex="-1"> In子表</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>As</span><span>(</span><span>"b"</span><span>)</span><span>.</span><span>ToList</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Title`, a.`Clicks`, a.`CreateTime`, a.`CategoryId`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (((a.`Id`) in (SELECT b.`Id`</span>
<span>//    FROM `Topic` b)))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="exists子表" tabindex="-1"> Exists子表</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>As</span><span>(</span><span>"b"</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Id <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Title`, a.`Clicks`, a.`CreateTime`, a.`CategoryId`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (exists(SELECT 1</span>
<span>//    FROM `Topic` b</span>
<span>//    WHERE (b.`Id` = a.`Id`)</span>
<span>//    limit 0,1))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：由于子查询的实体类与上层相同，使用 As(&quot;b&quot;) 指明别名，以便区分</p>
</blockquote>
<h2 id="查找今天创建的数据" tabindex="-1"> 查找今天创建的数据</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span>Date <span>==</span> DateTime<span>.</span>Today<span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//这行代码说明 FreeSql 表达式解析强大，不是所有 ORM 都支持</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span><span>Between</span><span>(</span>DateTime<span>.</span>Today<span>,</span> DateTime<span>.</span>Today<span>.</span><span>AddDays</span><span>(</span><span>1</span><span>)</span><span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//正常用法应该是这样</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>SqlServer nvarchar/varchar 已兼容表达式解析，分别解析为：N'' 和 ''，优化索引执行计划；</p>
</blockquote>
<h2 id="日期格式化" tabindex="-1"> 日期格式化</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>First</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span><span>ToString</span><span>(</span><span>"HH:mm:ss"</span><span>)</span><span>;</span>
<span>// SELECT date_format(a.`CreateTime`, '%H:%i:%s') as1 </span>
<span>// FROM `xxx` a </span>
<span>// limit 0,1</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>v1.5.0 支持了常用 c# 日期格式化，yyyy MM dd HH mm ss yy M d H hh h m s tt t</p>
</blockquote>
<blockquote>
<p>tt t 为 AM PM</p>
</blockquote>
<h2 id="开窗函数" tabindex="-1"> 开窗函数</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T1<span>,</span> T2<span>></span></span></span><span>(</span><span>)</span>
<span>.</span><span>InnerJoin</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> b<span>.</span>Id <span>==</span> a<span>.</span>Id<span>)</span>
<span>.</span><span>ToList</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span>
<span>{</span>
    Id <span>=</span> a<span>.</span>Id<span>,</span>
    EdiId <span>=</span> b<span>.</span>Id<span>,</span>
    over1 <span>=</span> SqlExt<span>.</span><span>Rank</span><span>(</span><span>)</span><span>.</span><span>Over</span><span>(</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span>a<span>.</span>Id<span>)</span><span>.</span><span>OrderByDescending</span><span>(</span>b<span>.</span>EdiId<span>)</span><span>.</span><span>ToValue</span><span>(</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>v1.6.0 利用自定义解析功能，增加 SqlExt.Rank().Over().PartitionBy(...)、MySql group_concat 常用函数，欢迎 PR 补充</p>
</blockquote>
<h2 id="子表join" tabindex="-1"> 子表Join</h2>
<blockquote>
<p>v1.8.0+ string.Join + ToList 实现将子查询的多行结果，拼接为一个字符串，如：&quot;1,2,3,4&quot;</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
  id <span>=</span> a<span>.</span>Id<span>,</span>
  concat <span>=</span> <span>string</span><span>.</span><span>Join</span><span>(</span><span>","</span><span>,</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>StringJoin01<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, (SELECT group_concat(b.`Id` separator ',') </span>
<span>//    FROM `StringJoin01` b) </span>
<span>//FROM `Topic` a</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：子查询 string.Join + ToList 适配了 sqlserver/pgsql/oracle/mysql/sqlite/firebird/达梦/金仓/南大/翰高 <a href="https://github.com/dotnetcore/FreeSql/issues/405" target="_blank" rel="noopener noreferrer">#405</a></p>
</blockquote>
<h2 id="子表first-count-sum-max-min-avg" tabindex="-1"> 子表First/Count/Sum/Max/Min/Avg</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Category<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span>  <span>{</span>
  all <span>=</span> a<span>,</span>
  first <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>First</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
  count <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>
  sum <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Sum</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  max <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Max</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  min <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Min</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  avg <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Avg</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="子表tolist" tabindex="-1"> 子表ToList</h2>
<blockquote>
<p>v3.2.650+ 以下最多执行3次 SQL</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span>
<span>{</span>
  all <span>=</span> a<span>,</span>
  list1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>,</span>
  list2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>TopicId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="自定义解析" tabindex="-1"> 自定义解析</h2>
<div><pre><code><span>[</span><span><span>ExpressionCall</span></span><span>]</span>
<span>public</span> <span>static</span> <span>class</span> <span>DbFunc</span> <span>{</span>
  <span>//必要定义 static + ThreadLocal</span>
  <span>static</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span> context <span>=</span> <span>new</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span><span>(</span><span>)</span><span>;</span>

  <span>public</span> <span>static</span> <span>DateTime</span> <span>FormatDateTime</span><span>(</span><span>this</span> <span>DateTime</span> that<span>,</span> <span><span>string</span></span> arg1<span>)</span>
  <span>{</span>
    <span><span>var</span></span> up <span>=</span> context<span>.</span>Value<span>;</span>
    <span>if</span> <span>(</span>up<span>.</span>DataType <span>==</span> FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>)</span> <span>//重写内容</span>
      up<span>.</span>Result <span>=</span> <span><span>$"date_format(</span><span><span>{</span><span>up<span>.</span>ParsedContent<span>[</span><span>"that"</span><span>]</span></span><span>}</span></span><span>, </span><span><span>{</span><span>up<span>.</span>ParsedContent<span>[</span><span>"arg1"</span><span>]</span></span><span>}</span></span><span>)"</span></span><span>;</span>
    <span>return</span> that<span>;</span>
  <span>}</span>
<span>}</span>

<span><span>var</span></span> sql1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>SysModule<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span><span>FormatDateTime</span><span>(</span><span>"yyyy-MM-dd"</span><span>)</span><span>)</span><span>;</span>
<span>//SELECT date_format(a."CreateTime", 'yyyy-MM-dd') as1 </span>
<span>//FROM "SysModule" a</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>[ExpressionCall] 特性可在静态扩展类上标记，也可以在单个静态方法上标记；</p>
<table>
<thead>
<tr>
<th>ExpressionCallContext 属性</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DataType</td>
<td>FreeSql.DataType</td>
<td>用于实现不同数据库的适配判断条件</td>
</tr>
<tr>
<td>ParsedContent</td>
<td>Dictionary&lt;string, string&gt;</td>
<td>函数的各参数解析结果</td>
</tr>
<tr>
<td>DbParameter</td>
<td>DbParameter</td>
<td>that 被参数化的对象（有可能为 null)</td>
</tr>
<tr>
<td>UserParameters</td>
<td>List&lt;DbParameter&gt;</td>
<td>可附加参数化对象</td>
</tr>
<tr>
<td>Result</td>
<td>string</td>
<td>返回表达式函数表示的 SQL 字符串</td>
</tr>
</tbody>
</table>
<blockquote>
<p>当扩展方法返回值为 string 时，其返回值也可以当作 context.Value.Result 功能</p>
</blockquote>
<blockquote>
<p>当不想解析指定参数时，使用特性 [RawValue] 标记</p>
</blockquote>
<h2 id="参数化" tabindex="-1"> 参数化</h2>
<p>Where(lambda) 解析出来的默认是纯文本（已防止SQL注入），对数据库执行计划要求特别高，可以开启 lambda 参数化功能。</p>
<div><pre><code><span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span> <span>//请务必定义成 Singleton 单例模式</span>
  <span>.</span><span>UseGenerateCommandParameterWithLambda</span><span>(</span><span>true</span><span>)</span>
  <span>..</span><span>.</span>

<span><span>var</span></span> id <span>=</span> <span>1</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT .. FROM `Song` a WHERE `Id` = @exp_0</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>生成的参数对象，DbType、Size、Precision、Scale 值设置默认已作优化，与实体属性定义一致。</p>
<p>诡异操作：</p>
<blockquote>
<p>如果不希望 string 参数与实体属性的 Size 相同，可利用自定义表达式函数功能，如下：</p>
</blockquote>
<div><pre><code><span><span>var</span></span> name <span>=</span> <span>"testname"</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>TestMySqlStringIsNullable<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>varchar <span>==</span> name<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>TestMySqlStringIsNullable<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>varchar <span>==</span> name<span>.</span><span>SetDbParameter</span><span>(</span><span>10</span><span>)</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span>public</span> <span>class</span> <span>TestMySqlStringIsNullable</span> <span>{</span>
  <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>[</span><span><span>Column</span><span><span>(</span>DbType <span>=</span> <span>"varchar(100)"</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span><span>string</span></span> varchar <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>[</span><span><span>ExpressionCall</span></span><span>]</span>
<span>public</span> <span>static</span> <span>class</span> <span>DbFunc</span> <span>{</span>
  <span>static</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span> context <span>=</span> <span>new</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span><span>(</span><span>)</span><span>;</span>

  <span>public</span> <span>static</span> <span><span>string</span></span> <span>SetDbParameter</span><span>(</span><span>this</span> <span><span>string</span></span> that<span>,</span> <span><span>int</span></span> size<span>)</span>
  <span>{</span>
    <span>if</span> <span>(</span>context<span>.</span>Value<span>.</span>DbParameter <span>!=</span> <span>null</span><span>)</span>
      context<span>.</span>Value<span>.</span>DbParameter<span>.</span>Size <span>=</span> size<span>;</span>
    <span>return</span> context<span>.</span>Value<span>.</span>ParsedContent<span>[</span><span>"that"</span><span>]</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>第一条语句产生的参数对象 Size 为 100，第二条为 10：</p>
<p><img src="https://user-images.githubusercontent.com/16286519/69433211-2c5fcf80-0d76-11ea-8eec-963eb37199c5.png" alt="image" loading="lazy"></p>
<h2 id="表达式函数全览" tabindex="-1"> 表达式函数全览</h2>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>a ? b : c</td>
<td>case when a then b else c end</td>
<td>case when a then b else c end</td>
<td>case when a then b else c end</td>
<td>case when a then b else c end</td>
<td>a成立时取b值，否则取c值</td>
</tr>
<tr>
<td>a ?? b</td>
<td>ifnull(a, b)</td>
<td>isnull(a, b)</td>
<td>coalesce(a, b)</td>
<td>nvl(a, b)</td>
<td>当a为null时，取b值</td>
</tr>
<tr>
<td>数字 + 数字</td>
<td>a + b</td>
<td>a + b</td>
<td>a + b</td>
<td>a + b</td>
<td>数字相加</td>
</tr>
<tr>
<td>数字 + 字符串</td>
<td>concat(a, b)</td>
<td>cast(a as varchar) + cast(b as varchar)</td>
<td>case(a as varchar)|| b</td>
<td>a|| b</td>
<td>字符串相加，a或b任意一个为字符串时</td>
</tr>
<tr>
<td>a - b</td>
<td>a - b</td>
<td>a - b</td>
<td>a - b</td>
<td>a - b</td>
<td>减</td>
</tr>
<tr>
<td>a * b</td>
<td>a * b</td>
<td>a * b</td>
<td>a * b</td>
<td>a * b</td>
<td>乘</td>
</tr>
<tr>
<td>a / b</td>
<td>a / b</td>
<td>a / b</td>
<td>a / b</td>
<td>a / b</td>
<td>除</td>
</tr>
<tr>
<td>a / b</td>
<td>a div b</td>
<td>a / b</td>
<td>a / b</td>
<td>trunc(a / b)</td>
<td>整除(a,b都为整数)</td>
</tr>
<tr>
<td>a % b</td>
<td>a % b</td>
<td>a % b</td>
<td>a % b</td>
<td>mod(a,b)</td>
<td>模</td>
</tr>
</tbody>
</table>
<blockquote>
<p>等等...</p>
</blockquote>
<h3 id="数组" tabindex="-1"> 数组</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>a.Length</td>
<td>-</td>
<td>-</td>
<td>case when a is null then 0 else array_length(a,1) end</td>
<td>-</td>
<td>数组长度</td>
</tr>
<tr>
<td>常量数组.Length</td>
<td>-</td>
<td>-</td>
<td>array_length(array[常量数组元素逗号分割],1)</td>
<td>-</td>
<td>数组长度</td>
</tr>
<tr>
<td>a.Any()</td>
<td>-</td>
<td>-</td>
<td>case when a is null then 0 else array_length(a,1) end &gt; 0</td>
<td>-</td>
<td>数组是否为空</td>
</tr>
<tr>
<td>常量数组.Contains(b)</td>
<td>b in (常量数组元素逗号分割)</td>
<td>b in (常量数组元素逗号分割)</td>
<td>b in (常量数组元素逗号分割)</td>
<td>b in (常量数组元素逗号分割)</td>
<td>IN查询</td>
</tr>
<tr>
<td>a.Contains(b)</td>
<td>-</td>
<td>-</td>
<td>a @&gt; array[b]</td>
<td>-</td>
<td>a数组是否包含b元素</td>
</tr>
<tr>
<td>a.Concat(b)</td>
<td>-</td>
<td>-</td>
<td>a || b</td>
<td>-</td>
<td>数组相连</td>
</tr>
<tr>
<td>a.Count()</td>
<td>-</td>
<td>-</td>
<td>同 Length</td>
<td>-</td>
<td>数组长度</td>
</tr>
</tbody>
</table>
<blockquote>
<p>一个细节证明 FreeSql 匠心制作</p>
</blockquote>
<p>通用的 in 查询 select.Where(a =&gt; new []{ 1,2,3 }.Contains(<a href="http://a.xxx" target="_blank" rel="noopener noreferrer">a.xxx</a>))</p>
<p>假设 xxxs 是 pgsql 的数组字段类型，其实会与上面的 in 查询起冲突，FreeSql 解决了这个矛盾 select.Where(a =&gt; a.xxxs.Contains(1))</p>
<h3 id="字典-dictionary-string-string" tabindex="-1"> 字典 Dictionary&lt;string, string&gt;</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>a.Count</td>
<td>-</td>
<td>-</td>
<td>case when a is null then 0 else array_length(akeys(a),1) end</td>
<td>-</td>
<td>字典长度</td>
</tr>
<tr>
<td>a.Keys</td>
<td>-</td>
<td>-</td>
<td>akeys(a)</td>
<td>-</td>
<td>返回字典所有key数组</td>
</tr>
<tr>
<td>a.Values</td>
<td>-</td>
<td>-</td>
<td>avals(a)</td>
<td>-</td>
<td>返回字典所有value数组</td>
</tr>
<tr>
<td>a.Contains(b)</td>
<td>-</td>
<td>-</td>
<td>a @&gt; b</td>
<td>-</td>
<td>字典是否包含b</td>
</tr>
<tr>
<td>a.ContainsKey(b)</td>
<td>-</td>
<td>-</td>
<td>a? b</td>
<td>-</td>
<td>字典是否包含key</td>
</tr>
<tr>
<td>a.Concat(b)</td>
<td>-</td>
<td>-</td>
<td>a || b</td>
<td>-</td>
<td>字典相连</td>
</tr>
<tr>
<td>a.Count()</td>
<td>-</td>
<td>-</td>
<td>同 Count</td>
<td>-</td>
<td>字典长度</td>
</tr>
</tbody>
</table>
<h3 id="json-jtoken-jobject-jarray" tabindex="-1"> JSON JToken/JObject/JArray</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>a.Count</td>
<td>-</td>
<td>-</td>
<td>jsonb_array_length(coalesce(a, '[]))</td>
<td>-</td>
<td>json数组类型的长度</td>
</tr>
<tr>
<td>a.Any()</td>
<td>-</td>
<td>-</td>
<td>jsonb_array_length(coalesce(a, '[])) &gt; 0</td>
<td>-</td>
<td>json数组类型，是否为空</td>
</tr>
<tr>
<td>a.Contains(b)</td>
<td>-</td>
<td>-</td>
<td>coalesce(a, '{}') @&gt; b::jsonb</td>
<td>-</td>
<td>json中是否包含b</td>
</tr>
<tr>
<td>a.ContainsKey(b)</td>
<td>-</td>
<td>-</td>
<td>coalesce(a, '{}') ? b</td>
<td>-</td>
<td>json中是否包含键b</td>
</tr>
<tr>
<td>a.Concat(b)</td>
<td>-</td>
<td>-</td>
<td>coalesce(a, '{}')</td>
<td></td>
<td>b::jsonb</td>
</tr>
<tr>
<td>Parse(a)</td>
<td>-</td>
<td>-</td>
<td>a::jsonb</td>
<td>-</td>
<td>转化字符串为json类型</td>
</tr>
<tr>
<td>a.Field[&quot;x&quot;]</td>
<td>-</td>
<td>-</td>
<td>a.Field-&gt;x</td>
<td>-</td>
<td>json成员访问</td>
</tr>
</tbody>
</table>
<h3 id="字符串" tabindex="-1"> 字符串</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>Sqlite</th>
</tr>
</thead>
<tbody>
<tr>
<td>string.Empty</td>
<td>''</td>
<td>''</td>
<td>''</td>
<td>''</td>
<td></td>
</tr>
<tr>
<td>string.IsNullOrEmpty(a)</td>
<td>(a is null or a = '')</td>
<td>(a is null or a = '')</td>
<td>(a is null or a = '')</td>
<td>(a is null or a = '')</td>
<td>(a is null or a = '')</td>
</tr>
<tr>
<td>string.Concat(a,b,c...)</td>
<td>concat(a, b, c)</td>
<td>a + b + c</td>
<td>a || b || c</td>
<td>a || b || c</td>
<td>a || b || c</td>
</tr>
<tr>
<td>a.CompareTo(b)</td>
<td>strcmp(a, b)</td>
<td>-</td>
<td>case when a = b then 0 when a &gt; b then 1 else -1 end</td>
<td>case when a = b then 0 when a &gt; b then 1 else -1 end</td>
<td>case when a = b then 0 when a &gt; b then 1 else -1 end</td>
</tr>
<tr>
<td>a.Contains('b')</td>
<td>a like '%b%'</td>
<td>a like '%b%'</td>
<td>a ilike'%b%'</td>
<td>a like '%b%'</td>
<td>a like '%b%'</td>
</tr>
<tr>
<td>a.EndsWith('b')</td>
<td>a like '%b'</td>
<td>a like '%b'</td>
<td>a ilike'%b'</td>
<td>a like '%b'</td>
<td>a like '%b'</td>
</tr>
<tr>
<td>a.IndexOf(b)</td>
<td>locate(a, b) - 1</td>
<td>locate(a, b) - 1</td>
<td>strpos(a, b) - 1</td>
<td>instr(a, b, 1, 1) - 1</td>
<td>instr(a, b) - 1</td>
</tr>
<tr>
<td>a.Length</td>
<td>char_length(a)</td>
<td>len(a)</td>
<td>char_length(a)</td>
<td>length(a)</td>
<td>length(a)</td>
</tr>
<tr>
<td>a.PadLeft(b, c)</td>
<td>lpad(a, b, c)</td>
<td>-</td>
<td>lpad(a, b, c)</td>
<td>lpad(a, b, c)</td>
<td>lpad(a, b, c)</td>
</tr>
<tr>
<td>a.PadRight(b, c)</td>
<td>rpad(a, b, c)</td>
<td>-</td>
<td>rpad(a, b, c)</td>
<td>rpad(a, b, c)</td>
<td>rpad(a, b, c)</td>
</tr>
<tr>
<td>a.Replace(b, c)</td>
<td>replace(a, b, c)</td>
<td>replace(a, b, c)</td>
<td>replace(a, b, c)</td>
<td>replace(a, b, c)</td>
<td>replace(a, b, c)</td>
</tr>
<tr>
<td>a.StartsWith('b')</td>
<td>a like 'b%'</td>
<td>a like 'b%'</td>
<td>a ilike'b%'</td>
<td>a like 'b%'</td>
<td>a like 'b%'</td>
</tr>
<tr>
<td>a.Substring(b, c)</td>
<td>substr(a, b, c + 1)</td>
<td>substring(a, b, c + 1)</td>
<td>substr(a, b, c + 1)</td>
<td>substr(a, b, c + 1)</td>
<td>substr(a, b, c + 1)</td>
</tr>
<tr>
<td>a.ToLower</td>
<td>lower(a)</td>
<td>lower(a)</td>
<td>lower(a)</td>
<td>lower(a)</td>
<td>lower(a)</td>
</tr>
<tr>
<td>a.ToUpper</td>
<td>upper(a)</td>
<td>upper(a)</td>
<td>upper(a)</td>
<td>upper(a)</td>
<td>upper(a)</td>
</tr>
<tr>
<td>a.Trim</td>
<td>trim(a)</td>
<td>trim(a)</td>
<td>trim(a)</td>
<td>trim(a)</td>
<td>trim(a)</td>
</tr>
<tr>
<td>a.TrimEnd</td>
<td>rtrim(a)</td>
<td>rtrim(a)</td>
<td>rtrim(a)</td>
<td>rtrim(a)</td>
<td>rtrim(a)</td>
</tr>
<tr>
<td>a.TrimStart</td>
<td>ltrim(a)</td>
<td>ltrim(a)</td>
<td>ltrim(a)</td>
<td>ltrim(a)</td>
<td>ltrim(a)</td>
</tr>
<tr>
<td>a.FirstOrDefault</td>
<td>substr(a,1,1)</td>
<td>substring(a,1,1)</td>
<td>substr(a,1,1)</td>
<td>substr(a,1,1)</td>
<td>substr(a,1,1)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>使用字符串函数可能会出现性能瓶颈，虽然不推荐使用，但是作为功能库这也是不可缺少的功能之一。</p>
</blockquote>
<h3 id="日期" tabindex="-1"> 日期</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
</tr>
</thead>
<tbody>
<tr>
<td>DateTime.Now</td>
<td>now()</td>
<td>getdate()</td>
<td>current_timestamp</td>
<td>systimestamp</td>
</tr>
<tr>
<td>DateTime.UtcNow</td>
<td>utc_timestamp()</td>
<td>getutcdate()</td>
<td>(current_timestamp at time zone 'UTC')</td>
<td>sys_extract_utc(systimestamp)</td>
</tr>
<tr>
<td>DateTime.Today</td>
<td>curdate</td>
<td>convert(char(10),getdate(),120)</td>
<td>current_date</td>
<td>trunc(systimestamp)</td>
</tr>
<tr>
<td>DateTime.MaxValue</td>
<td>cast('9999/12/31 23:59:59' as datetime)</td>
<td>'9999/12/31 23:59:59'</td>
<td>'9999/12/31 23:59:59'::timestamp</td>
<td>to_timestamp('9999-12-31 23:59:59','YYYY-MM-DD HH24:MI:SS.FF6')</td>
</tr>
<tr>
<td>DateTime.MinValue</td>
<td>cast('0001/1/1 0:00:00' as datetime)</td>
<td>'1753/1/1 0:00:00'</td>
<td>'0001/1/1 0:00:00'::timestamp</td>
<td>to_timestamp('0001-01-01 00:00:00','YYYY-MM-DD HH24:MI:SS.FF6')</td>
</tr>
<tr>
<td>DateTime.Compare(a, b)</td>
<td>a - b</td>
<td>a - b</td>
<td>extract(epoch from a::timestamp-b::timestamp)</td>
<td>extract(day from (a-b))</td>
</tr>
<tr>
<td>DateTime.DaysInMonth(a, b)</td>
<td>dayofmonth(last_day(concat(a, '-', b, '-1')))</td>
<td>datepart(day, dateadd(day, -1, dateadd(month, 1, cast(a as varchar) + '-' + cast(b as varchar) + '-1')))</td>
<td>extract(day from (a</td>
<td></td>
</tr>
<tr>
<td>DateTime.Equals(a, b)</td>
<td>a = b</td>
<td>a = b</td>
<td>a = b</td>
<td>a = b</td>
</tr>
<tr>
<td>DateTime.IsLeapYear(a)</td>
<td>a%4=0 and a%100&lt;&gt;0 or a%400=0</td>
<td>a%4=0 and a%100&lt;&gt;0 or a%400=0</td>
<td>a%4=0 and a%100&lt;&gt;0 or a%400=0</td>
<td>mod(a,4)=0 AND mod(a,100)&lt;&gt;0 OR mod(a,400)=0</td>
</tr>
<tr>
<td>DateTime.Parse(a)</td>
<td>cast(a as datetime)</td>
<td>cast(a as datetime)</td>
<td>a::timestamp</td>
<td>to_timestamp(a,'YYYY-MM-DD HH24:MI:SS.FF6')</td>
</tr>
<tr>
<td>a.Add(b)</td>
<td>date_add(a, interval b microsecond)</td>
<td>dateadd(millisecond, b / 1000, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddDays(b)</td>
<td>date_add(a, interval b day)</td>
<td>dateadd(day, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddHours(b)</td>
<td>date_add(a, interval b hour)</td>
<td>dateadd(hour, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddMilliseconds(b)</td>
<td>date_add(a, interval b*1000 microsecond)</td>
<td>dateadd(millisecond, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddMinutes(b)</td>
<td>date_add(a, interval b minute)</td>
<td>dateadd(minute, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddMonths(b)</td>
<td>date_add(a, interval b month)</td>
<td>dateadd(month, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddSeconds(b)</td>
<td>date_add(a, interval b second)</td>
<td>dateadd(second, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddTicks(b)</td>
<td>date_add(a, interval b/10 microsecond)</td>
<td>dateadd(millisecond, b / 10000, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.AddYears(b)</td>
<td>date_add(a, interval b year)</td>
<td>dateadd(year, b, a)</td>
<td>a::timestamp+(b</td>
<td></td>
</tr>
<tr>
<td>a.Date</td>
<td>cast(date_format(a, '%Y-%m-%d') as datetime)</td>
<td>convert(char(10),a,120)</td>
<td>a::date</td>
<td>trunc(a)</td>
</tr>
<tr>
<td>a.Day</td>
<td>dayofmonth(a)</td>
<td>datepart(day, a)</td>
<td>extract(day from a::timestamp)</td>
<td>cast(to_char(a,'DD') as number)</td>
</tr>
<tr>
<td>a.DayOfWeek</td>
<td>dayofweek(a)</td>
<td>datepart(weekday, a) - 1</td>
<td>extract(dow from a::timestamp)</td>
<td>case when to_char(a)='7' then 0 else cast(to_char(a) as number) end</td>
</tr>
<tr>
<td>a.DayOfYear</td>
<td>dayofyear(a)</td>
<td>datepart(dayofyear, a)</td>
<td>extract(doy from a::timestamp)</td>
<td>cast(to_char(a,'DDD') as number)</td>
</tr>
<tr>
<td>a.Hour</td>
<td>hour(a)</td>
<td>datepart(hour, a)</td>
<td>extract(hour from a::timestamp)</td>
<td>cast(to_char(a,'HH24') as number)</td>
</tr>
<tr>
<td>a.Millisecond</td>
<td>floor(microsecond(a) / 1000)</td>
<td>datepart(millisecond, a)</td>
<td>extract(milliseconds from a::timestamp)-extract(second from a::timestamp)*1000</td>
<td>cast(to_char(a,'FF3') as number)</td>
</tr>
<tr>
<td>a.Minute</td>
<td>minute(a)</td>
<td>datepart(minute, a)</td>
<td>extract(minute from a::timestamp)</td>
<td>cast(to_char(a,'MI') as number)</td>
</tr>
<tr>
<td>a.Month</td>
<td>month(a)</td>
<td>datepart(month, a)</td>
<td>extract(month from a::timestamp)</td>
<td>cast(to_char(a,'FF3') as number)</td>
</tr>
<tr>
<td>a.Second</td>
<td>second(a)</td>
<td>datepart(second, a)</td>
<td>extract(second from a::timestamp)</td>
<td>cast(to_char(a,'SS') as number)</td>
</tr>
<tr>
<td>a.Subtract(b)</td>
<td>timestampdiff(microsecond, b, a)</td>
<td>datediff(millisecond, b, a) * 1000</td>
<td>(extract(epoch from a::timestamp-b::timestamp)*1000000)</td>
<td>a - b</td>
</tr>
<tr>
<td>a.Ticks</td>
<td>timestampdiff(microsecond, '0001-1-1', a) * 10</td>
<td>datediff(millisecond, '1970-1-1', a) * 10000 + 621355968000000000</td>
<td>extract(epoch from a::timestamp)*10000000+621355968000000000</td>
<td>cast(to_char(a,'FF7') as number)</td>
</tr>
<tr>
<td>a.TimeOfDay</td>
<td>timestampdiff(microsecond, date_format(a, '%Y-%m-%d'), a)</td>
<td>'1970-1-1 ' + convert(varchar, a, 14)</td>
<td>extract(epoch from a::time)*1000000</td>
<td>a - trunc(a)</td>
</tr>
<tr>
<td>a.Year</td>
<td>year(a)</td>
<td>datepart(year, a)</td>
<td>extract(year from a::timestamp)</td>
<td>年</td>
</tr>
<tr>
<td>a.Equals(b)</td>
<td>a = b</td>
<td>a = b</td>
<td>a = b</td>
<td>a = b</td>
</tr>
<tr>
<td>a.CompareTo(b)</td>
<td>a - b</td>
<td>a - b</td>
<td>a - b</td>
<td>a - b</td>
</tr>
<tr>
<td>a.ToString()</td>
<td>date_format(a, '%Y-%m-%d %H:%i:%s.%f')</td>
<td>convert(varchar, a, 121)</td>
<td>to_char(a, 'YYYY-MM-DD HH24:MI:SS.US')</td>
<td>to_char(a,'YYYY-MM-DD HH24:MI:SS.FF6')</td>
</tr>
</tbody>
</table>
<h3 id="时间" tabindex="-1"> 时间</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql(微秒)</th>
<th>SqlServer(秒)</th>
<th>PostgreSQL(微秒)</th>
<th>Oracle(Interval day(9) to second(7))</th>
</tr>
</thead>
<tbody>
<tr>
<td>TimeSpan.Zero</td>
<td>0</td>
<td>0</td>
<td>-</td>
<td>0微秒</td>
</tr>
<tr>
<td>TimeSpan.MaxValue</td>
<td>922337203685477580</td>
<td>922337203685477580</td>
<td>-</td>
<td>numtodsinterval(233720368.5477580,'second')</td>
</tr>
<tr>
<td>TimeSpan.MinValue</td>
<td>-922337203685477580</td>
<td>-922337203685477580</td>
<td>-</td>
<td>numtodsinterval(-233720368.5477580,'second')</td>
</tr>
<tr>
<td>TimeSpan.Compare(a, b)</td>
<td>a - b</td>
<td>a - b</td>
<td>-</td>
<td>extract(day from (a-b))</td>
</tr>
<tr>
<td>TimeSpan.Equals(a, b)</td>
<td>a = b</td>
<td>a = b</td>
<td>-</td>
<td>a = b</td>
</tr>
<tr>
<td>TimeSpan.FromDays(a)</td>
<td>a <em>1000000</em> 60 <em>60</em> 24</td>
<td>a <em>1000000</em> 60 <em>60</em> 24</td>
<td>-</td>
<td>numtodsinterval(a*86400,'second')</td>
</tr>
<tr>
<td>TimeSpan.FromHours(a)</td>
<td>a <em>1000000</em> 60 * 60</td>
<td>a * 1000000 <em>60</em> 60</td>
<td>-</td>
<td>numtodsinterval(a*3600,'second')</td>
</tr>
<tr>
<td>TimeSpan.FromMilliseconds(a)</td>
<td>a * 1000</td>
<td>a * 1000</td>
<td>-</td>
<td>numtodsinterval(a/1000,'second')</td>
</tr>
<tr>
<td>TimeSpan.FromMinutes(a)</td>
<td>a <em>1000000</em> 60</td>
<td>a <em>1000000</em> 60</td>
<td>-</td>
<td>numtodsinterval(a*60,'second')</td>
</tr>
<tr>
<td>TimeSpan.FromSeconds(a)</td>
<td>a * 1000000</td>
<td>a * 1000000</td>
<td>-</td>
<td>numtodsinterval(a,'second')</td>
</tr>
<tr>
<td>TimeSpan.FromTicks(a)</td>
<td>a / 10</td>
<td>a / 10</td>
<td>-</td>
<td>numtodsinterval(a/10000000,'second')</td>
</tr>
<tr>
<td>a.Add(b)</td>
<td>a + b</td>
<td>a + b</td>
<td>-</td>
<td>a + b</td>
</tr>
<tr>
<td>a.Subtract(b)</td>
<td>a - b</td>
<td>a - b</td>
<td>-</td>
<td>a - b</td>
</tr>
<tr>
<td>a.CompareTo(b)</td>
<td>a - b</td>
<td>a - b</td>
<td>-</td>
<td>extract(day from (a-b))</td>
</tr>
<tr>
<td>a.Days</td>
<td>a div (1000000 <em>60</em> 60 * 24)</td>
<td>a div (1000000 * 60 <em>60</em> 24)</td>
<td>-</td>
<td>extract(day from a)</td>
</tr>
<tr>
<td>a.Hours</td>
<td>a div (1000000 <em>60</em> 60) mod 24</td>
<td>a div (1000000 <em>60</em> 60) mod 24</td>
<td>-</td>
<td>extract(hour from a)</td>
</tr>
<tr>
<td>a.Milliseconds</td>
<td>a div 1000 mod 1000</td>
<td>a div 1000 mod 1000</td>
<td>-</td>
<td>cast(substr(extract(second from a)-floor(extract(second from a)),2,3) as number)</td>
</tr>
<tr>
<td>a.Seconds</td>
<td>a div 1000000 mod 60</td>
<td>a div 1000000 mod 60</td>
<td>-</td>
<td>extract(second from a)</td>
</tr>
<tr>
<td>a.Ticks</td>
<td>a * 10</td>
<td>a * 10</td>
<td>-</td>
<td>(extract(day from a)*86400+extract(hour from a)*3600+extract(minute from a)*60+extract(second from a))*10000000</td>
</tr>
<tr>
<td>a.TotalDays</td>
<td>a / (1000000 <em>60</em> 60 * 24)</td>
<td>a / (1000000 * 60 <em>60</em> 24)</td>
<td>-</td>
<td>extract(day from a)</td>
</tr>
<tr>
<td>a.TotalHours</td>
<td>a / (1000000 <em>60</em> 60)</td>
<td>a / (1000000 <em>60</em> 60)</td>
<td>-</td>
<td>(extract(day from a)*24+extract(hour from a))</td>
</tr>
<tr>
<td>a.TotalMilliseconds</td>
<td>a / 1000</td>
<td>a / 1000</td>
<td>-</td>
<td>(extract(day from a)*86400+extract(hour from a)*3600+extract(minute from a)*60+extract(second from a))*1000</td>
</tr>
<tr>
<td>a.TotalMinutes</td>
<td>a / (1000000 * 60)</td>
<td>a / (1000000 * 60)</td>
<td>-</td>
<td></td>
</tr>
<tr>
<td>a.TotalSeconds</td>
<td>a / 1000000</td>
<td>a / 1000000</td>
<td>-</td>
<td>(extract(day from a)*86400+extract(hour from a)*3600+extract(minute from a)*60+extract(second from a))</td>
</tr>
<tr>
<td>a.Equals(b)</td>
<td>a = b</td>
<td>a = b</td>
<td>-</td>
<td>a = b</td>
</tr>
<tr>
<td>a.ToString()</td>
<td>cast(a as varchar)</td>
<td>cast(a as varchar)</td>
<td>-</td>
<td>to_char(a)</td>
</tr>
</tbody>
</table>
<h3 id="数学函数" tabindex="-1"> 数学函数</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
</tr>
</thead>
<tbody>
<tr>
<td>Math.Abs(a)</td>
<td>abs(a)</td>
<td>abs(a)</td>
<td>abs(a)</td>
<td></td>
</tr>
<tr>
<td>Math.Acos(a)</td>
<td>acos(a)</td>
<td>acos(a)</td>
<td>acos(a)</td>
<td>acos(a)</td>
</tr>
<tr>
<td>Math.Asin(a)</td>
<td>asin(a)</td>
<td>asin(a)</td>
<td>asin(a)</td>
<td>asin(a)</td>
</tr>
<tr>
<td>Math.Atan(a)</td>
<td>atan(a)</td>
<td>atan(a)</td>
<td>atan(a)</td>
<td>atan(a)</td>
</tr>
<tr>
<td>Math.Atan2(a, b)</td>
<td>atan2(a, b)</td>
<td>atan2(a, b)</td>
<td>atan2(a, b)</td>
<td>-</td>
</tr>
<tr>
<td>Math.Ceiling(a)</td>
<td>ceiling(a)</td>
<td>ceiling(a)</td>
<td>ceiling(a)</td>
<td>ceil(a)</td>
</tr>
<tr>
<td>Math.Cos(a)</td>
<td>cos(a)</td>
<td>cos(a)</td>
<td>cos(a)</td>
<td>cos(a)</td>
</tr>
<tr>
<td>Math.Exp(a)</td>
<td>exp(a)</td>
<td>exp(a)</td>
<td>exp(a)</td>
<td>exp(a)</td>
</tr>
<tr>
<td>Math.Floor(a)</td>
<td>floor(a)</td>
<td>floor(a)</td>
<td>floor(a)</td>
<td>floor(a)</td>
</tr>
<tr>
<td>Math.Log(a)</td>
<td>log(a)</td>
<td>log(a)</td>
<td>log(a)</td>
<td>log(e,a)</td>
</tr>
<tr>
<td>Math.Log10(a)</td>
<td>log10(a)</td>
<td>log10(a)</td>
<td>log10(a)</td>
<td>log(10,a)</td>
</tr>
<tr>
<td>Math.PI(a)</td>
<td>3.1415926535897931</td>
<td>3.1415926535897931</td>
<td>3.1415926535897931</td>
<td>3.1415926535897931</td>
</tr>
<tr>
<td>Math.Pow(a, b)</td>
<td>pow(a, b)</td>
<td>power(a, b)</td>
<td>pow(a, b)</td>
<td>power(a, b)</td>
</tr>
<tr>
<td>Math.Round(a, b)</td>
<td>round(a, b)</td>
<td>round(a, b)</td>
<td>round(a, b)</td>
<td>round(a, b)</td>
</tr>
<tr>
<td>Math.Sign(a)</td>
<td>sign(a)</td>
<td>sign(a)</td>
<td>sign(a)</td>
<td>sign(a)</td>
</tr>
<tr>
<td>Math.Sin(a)</td>
<td>sin(a)</td>
<td>sin(a)</td>
<td>sin(a)</td>
<td>sin(a)</td>
</tr>
<tr>
<td>Math.Sqrt(a)</td>
<td>sqrt(a)</td>
<td>sqrt(a)</td>
<td>sqrt(a)</td>
<td>sqrt(a)</td>
</tr>
<tr>
<td>Math.Tan(a)</td>
<td>tan(a)</td>
<td>tan(a)</td>
<td>tan(a)</td>
<td>tan(a)</td>
</tr>
<tr>
<td>Math.Truncate(a)</td>
<td>truncate(a, 0)</td>
<td>floor(a)</td>
<td>trunc(a, 0)</td>
<td>trunc(a, 0)</td>
</tr>
</tbody>
</table>
<h3 id="类型转换" tabindex="-1"> 类型转换</h3>
<table>
<thead>
<tr>
<th>表达式</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>Sqlite</th>
</tr>
</thead>
<tbody>
<tr>
<td>Convert.ToBoolean(a) | bool.Parse(a)</td>
<td>a not in ('0','false')</td>
<td>a not in ('0','false')</td>
<td>a::varchar not in ('0','false','f','no')</td>
<td>-</td>
<td>a not in ('0','false')</td>
</tr>
<tr>
<td>Convert.ToByte(a) | byte.Parse(a)</td>
<td>cast(a as unsigned)</td>
<td>cast(a as tinyint)</td>
<td>a::int2</td>
<td>cast(a as number)</td>
<td>cast(a as int2)</td>
</tr>
<tr>
<td>Convert.ToChar(a)</td>
<td>substr(cast(a as char),1,1)</td>
<td>substring(cast(a as nvarchar),1,1)</td>
<td>substr(a::char,1,1)</td>
<td>substr(to_char(a),1,1)</td>
<td>substr(cast(a as character),1,1)</td>
</tr>
<tr>
<td>Convert.ToDateTime(a) | DateTime.Parse(a)</td>
<td>cast(a as datetime)</td>
<td>cast(a as datetime)</td>
<td>a::timestamp</td>
<td>to_timestamp(a,'YYYY-MM-DD HH24:MI:SS.FF6')</td>
<td>datetime(a)</td>
</tr>
<tr>
<td>Convert.ToDecimal(a) | decimal.Parse(a)</td>
<td>cast(a as decimal(36,18))</td>
<td>cast(a as decimal(36,19))</td>
<td>a::numeric</td>
<td>cast(a as number)</td>
<td>cast(a as decimal(36,18))</td>
</tr>
<tr>
<td>Convert.ToDouble(a) | double.Parse(a)</td>
<td>cast(a as decimal(32,16))</td>
<td>cast(a as decimal(32,16))</td>
<td>a::float8</td>
<td>cast(a as number)</td>
<td>cast(a as double)</td>
</tr>
<tr>
<td>Convert.ToInt16(a) | short.Parse(a)</td>
<td>cast(a as signed)</td>
<td>cast(a as smallint)</td>
<td>a::int2</td>
<td>cast(a as number)</td>
<td>cast(a as smallint)</td>
</tr>
<tr>
<td>Convert.ToInt32(a) | int.Parse(a)</td>
<td>cast(a as signed)</td>
<td>cast(a as int)</td>
<td>a::int4</td>
<td>cast(a as number)</td>
<td>cast(a as smallint)</td>
</tr>
<tr>
<td>Convert.ToInt64(a) | long.Parse(a)</td>
<td>cast(a as signed)</td>
<td>cast(a as bigint)</td>
<td>a::int8</td>
<td>cast(a as number)</td>
<td>cast(a as smallint)</td>
</tr>
<tr>
<td>Convert.ToSByte(a) | sbyte.Parse(a)</td>
<td>cast(a as signed)</td>
<td>cast(a as tinyint)</td>
<td>a::int2</td>
<td>cast(a as number)</td>
<td>cast(a as smallint)</td>
</tr>
<tr>
<td>Convert.ToSingle(a) | float.Parse(a)</td>
<td>cast(a as decimal(14,7))</td>
<td>cast(a as decimal(14,7))</td>
<td>a::float4</td>
<td>cast(a as number)</td>
<td>cast(a as float)</td>
</tr>
<tr>
<td>Convert.ToString(a)</td>
<td>cast(a as char)</td>
<td>cast(a as nvarchar)</td>
<td>a::varchar</td>
<td>to_char(a)</td>
<td>cast(a as character)</td>
</tr>
<tr>
<td>Convert.ToUInt16(a) | ushort.Parse(a)</td>
<td>cast(a as unsigned)</td>
<td>cast(a as smallint)</td>
<td>a::int2</td>
<td>cast(a as number)</td>
<td>cast(a as unsigned)</td>
</tr>
<tr>
<td>Convert.ToUInt32(a) | uint.Parse(a)</td>
<td>cast(a as unsigned)</td>
<td>cast(a as int)</td>
<td>a::int4</td>
<td>cast(a as number)</td>
<td>cast(a as decimal(10,0))</td>
</tr>
<tr>
<td>Convert.ToUInt64(a) | ulong.Parse(a)</td>
<td>cast(a as unsigned)</td>
<td>cast(a as bigint)</td>
<td>a::int8</td>
<td>cast(a as number)</td>
<td>cast(a as decimal(21,0))</td>
</tr>
<tr>
<td>Guid.Parse(a)</td>
<td>substr(cast(a as char),1,36)</td>
<td>cast(a as uniqueidentifier)</td>
<td>a::uuid</td>
<td>substr(to_char(a),1,36)</td>
<td>substr(cast(a as character),1,36)</td>
</tr>
<tr>
<td>Guid.NewGuid()</td>
<td>-</td>
<td>newid()</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>new Random().NextDouble()</td>
<td>rand()</td>
<td>rand()</td>
<td>random()</td>
<td>dbms_random.value</td>
<td>random()</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">过滤器</title>
    <id>https://freesql.net/guide/filters.html</id>
    <link href="https://freesql.net/guide/filters.html"/>
    <updated>2022-08-18T07:21:07.000Z</updated>
    <content type="html"><![CDATA[<h1 id="过滤器" tabindex="-1"> 过滤器</h1>
<h2 id="全局过滤器-建议" tabindex="-1"> 全局过滤器（建议）</h2>
<p>FreeSql 基础层实现了 Select/Update/Delete 可设置的全局过滤器功能。</p>
<div><pre><code><span>public</span> <span>static</span> <span>AsyncLocal<span>&lt;</span>Guid<span>></span></span> TenantId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> <span>new</span> <span>AsyncLocal<span>&lt;</span>Guid<span>></span></span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span>GlobalFilter
    <span>.</span><span><span>Apply</span><span><span>&lt;</span>ITenant<span>></span></span></span><span>(</span><span>"test1"</span><span>,</span> a <span>=></span> a<span>.</span>TenantId <span>==</span> TenantId<span>.</span>Value<span>)</span>
    <span>.</span><span><span>Apply</span><span><span>&lt;</span>AuthorTest<span>></span></span></span><span>(</span><span>"test2"</span><span>,</span> a <span>=></span> a<span>.</span>Name <span>==</span> <span>"11"</span><span>)</span>
    
    <span>.</span><span><span>ApplyOnly</span><span><span>&lt;</span>AuthorTest<span>></span></span></span><span>(</span><span>"test3"</span><span>,</span> a <span>=></span> a<span>.</span>Name <span>==</span> <span>"11"</span><span>)</span>
    <span>//指定类型精准设置</span>

    <span>.</span><span><span>ApplyIf</span><span><span>&lt;</span>TestAddEnum<span>></span></span></span><span>(</span><span>"test4"</span><span>,</span> <span>(</span><span>)</span> <span>=></span> TenantId<span>.</span>Value <span>!=</span> Guid<span>.</span>Empty<span>,</span> a <span>=></span> a<span>.</span>Id <span>==</span> TenantId<span>.</span>Value<span>)</span><span>;</span>
    <span>//1.9.0 ApplyIf 委托的返回值(第二个参数) true 才生效</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>Apply 泛型参数可以设置为任何类型，当使用 Select/Update/Delete 方法时会进行过滤器匹配尝试（try catch）：</p>
<ul>
<li>匹配成功的，将附加 where 条件；</li>
<li>匹配失败的，标记下次不再匹配，避免性能损耗；</li>
</ul>
<p>如何禁用？</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>TestAddEnum<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span> <span>//所有生效</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>TestAddEnum<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>DisableGlobalFilter</span><span>(</span><span>"test1"</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span> <span>//禁用 test1</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>TestAddEnum<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>DisableGlobalFilter</span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span> <span>//禁用所有</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>fsql.Update/Delete 方法效果同上。</p>
<h2 id="仓储过滤器" tabindex="-1"> 仓储过滤器</h2>
<blockquote>
<p>注意：仓储过滤器属于早期功能，如果 fsql.GlobalFilter 够用的话，可以跳过以下内容。</p>
</blockquote>
<p>FreeSql.Repository 也实现了过滤器功能，它在查询时过滤，删除/修改/插入篇还会进行验证数据，避免数据安全问题。</p>
<blockquote>
<p>注意：仓储的过滤器与 IFreeSql.GlobalFilter 不是一个功能，可以同时生效。</p>
</blockquote>
<blockquote>
<p>推荐使用 IFreeSql.GlobalFilter。仓储过滤器在早期出的功能，会一直保留。</p>
</blockquote>
<p>每个仓储实例都有 IDataFilter 属性，可利用其完成过滤器管理，它是独立的修改后不影响全局。</p>
<div><pre><code><span>public</span> <span>interface</span> <span>IDataFilter<span>&lt;</span>TEntity<span>></span></span> <span>where</span> <span>TEntity</span> <span>:</span> <span><span>class</span></span> <span>{</span>
    <span>IDataFilter<span>&lt;</span>TEntity<span>></span></span> <span>Apply</span><span>(</span><span><span>string</span></span> filterName<span>,</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span>TEntity<span>,</span> <span>bool</span><span>></span><span>></span></span> filterAndValidateExp<span>)</span><span>;</span>

    <span>IDisposable</span> <span>Enable</span><span>(</span><span>params</span> <span><span>string</span><span>[</span><span>]</span></span> filterName<span>)</span><span>;</span>
    <span>IDisposable</span> <span>EnableAll</span><span>(</span><span>)</span><span>;</span>

    <span>IDisposable</span> <span>Disable</span><span>(</span><span>params</span> <span><span>string</span><span>[</span><span>]</span></span> filterName<span>)</span><span>;</span>
    <span>IDisposable</span> <span>DisableAll</span><span>(</span><span>)</span><span>;</span>

    <span><span>bool</span></span> <span>IsEnabled</span><span>(</span><span><span>string</span></span> filterName<span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="临时禁用" tabindex="-1"> 临时禁用</h2>
<div><pre><code><span>using</span> <span>(</span>repo1<span>.</span>DataFilter<span>.</span><span>Disable</span><span>(</span><span>"test"</span><span>)</span><span>)</span> <span>{</span>
    <span>//在这段中，repo1 之 test 过滤器失效</span>
<span>}</span>

<span>//repo1 之 test 过滤器重新生效</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="过滤与验证" tabindex="-1"> 过滤与验证</h2>
<p>假设我们有 User(用户)、Topic(主题)两个实体，在领域类中定义了两个仓储：</p>
<div><pre><code><span><span>var</span></span> userRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> topicRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>在开发过程中，总是担心 topicRepository 的数据安全问题，即有可能查询或操作到其他用户的主题。因此我们在 v0.0.7 版本进行了改进，增加了 filter lambda 表达式参数。</p>
<div><pre><code><span><span>var</span></span> userRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>;</span>
<span><span>var</span></span> topicRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span>a <span>=></span> a<span>.</span>UserId <span>==</span> <span>1</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ul>
<li>在查询/修改/删除时附加此条件，从而达到不会修改其他用户的数据；</li>
<li>在添加时，使用表达式验证数据的合法性，若不合法则抛出异常；</li>
</ul>
<p>仓储过滤器，可帮助实现“软删除”、“租户”等设计，目前使用 AspNetCore 注入的方式实现的仓储过滤器。</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span> <span>{</span>

    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>Fsql<span>)</span><span>;</span>
    services<span>.</span><span>AddFreeRepository</span><span>(</span>filter <span>=></span> filter
        <span>.</span><span><span>Apply</span><span><span>&lt;</span>ISoftDelete<span>></span></span></span><span>(</span><span>"SoftDelete"</span><span>,</span> a <span>=></span> a<span>.</span>IsDeleted <span>==</span> <span>false</span><span>)</span>
        <span>.</span><span><span>Apply</span><span><span>&lt;</span>ITenant<span>></span></span></span><span>(</span><span>"Tenant"</span><span>,</span> a <span>=></span> a<span>.</span>TenantId <span>==</span> <span>1</span><span>)</span>
        <span>.</span><span><span>Apply</span><span><span>&lt;</span>ITenant<span>></span></span></span><span>(</span><span>"Song"</span><span>,</span> a <span>=></span> a<span>.</span>TenantId <span>==</span> <span>1</span><span>)</span>
        <span>,</span>
        <span>this</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span>.</span>Assembly
    <span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>比 abpvnext 还要方便，因为 abp 的相关实体需要实现接口 ISoftDelete、ITenant；</p>
<p>我们没有这个限制，只要过滤器的表达式解析成功，就算可用；</p>
<p>使用在任何实体上的时候，只要 [实体].IsDeleted == false 能解析能过，就算可用；</p>
<div><pre><code><span>public</span> <span>class</span> <span>xxxx</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>Song</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>//在控制器使用</span>
<span>public</span> <span>SongsController</span><span>(</span><span>IBaseRepository<span>&lt;</span>Song<span>></span></span> repo1<span>,</span> <span>IBaseRepository<span>&lt;</span>xxxx<span>></span></span> repos2<span>)</span> <span>{</span>
    <span>//在此打断点，调试</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>第一次请求：</p>
<p>repo1.Select.ToSql()</p>
<div><pre><code><span>"SELECT a."</span>Id<span>", a."</span>Title<span>"  FROM "</span>Song<span>" a WHERE (a."</span>Title<span>" = strftime('%Y-%m-%d %H:%M.%f',datetime(current_timestamp,'localtime')) || 21)"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>repos2.Select.ToSql()</p>
<div><pre><code><span>"SELECT a."</span>Id<span>"  FROM "</span>xxxx<span>" a"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>第二次请求：</p>
<p>repo1.Select.ToSql()</p>
<div><pre><code><span>"SELECT a."</span>Id<span>", a."</span>Title<span>"  FROM "</span>Song<span>" a  WHERE (a."</span>Title<span>" = strftime('%Y-%m-%d %H:%M.%f',datetime(current_timestamp,'localtime')) || 4)"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>repos2.Select.ToSql()</p>
<div><pre><code><span>"SELECT a."</span>Id<span>"  FROM "</span>xxxx<span>" a"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>//禁用过滤器
repo1.DataFilter.Disable(&quot;test&quot;)</p>
<p>repo1.Select.ToSql()</p>
<div><pre><code> <span>"SELECT a."</span>Id<span>", a."</span>Title<span>"  FROM "</span>Song<span>" a"</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>1、注入的变量值在使用时有了动态变化，每次获取时都是新的（Thread.CurrentThread.ManagedThreadId）；</p>
<p>2、设定的全局过滤，若某实体不存在表达式函数中的字段时，不会生效（如上 xxxx 不存在 Title）；</p>
<p>3、使用 DataFilter.Disable(&quot;test&quot;) 可临时关闭过滤器的效果，使用 DataFilter.Enable(&quot;test&quot;) 可重新开启；</p>
<p>4、仓储对象创建时，从全局过滤器 copy 进来，然后自己管理自己。修改后不影响其他或全局设置。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">流式接口</title>
    <id>https://freesql.net/guide/fluent-api.html</id>
    <link href="https://freesql.net/guide/fluent-api.html"/>
    <updated>2022-08-11T15:34:05.000Z</updated>
    <content type="html"><![CDATA[<h2 id="支持-fluent-api" tabindex="-1"> 支持 Fluent API</h2>
<p>FreeSql 提供了 Fluent Api 的方式,使用链式调用，可在外部配置实体的数据库特性。<code>Fluent Api</code> 的方法命名与特性名保持一致，共三种使用方法，选择<strong>一种即可</strong>：</p>
<blockquote>
<p>fsql 是一个 IFreeSql 对象、配置尽量只执行一次，避免性能损耗 参考：<a href="/guide/entity-attribute.html">《实体特性说明》</a></p>
</blockquote>
<h2 id="configentity" tabindex="-1"> ConfigEntity</h2>
<div><pre><code>fsql<span>.</span>CodeFirst
    <span>.</span><span><span>ConfigEntity</span><span><span>&lt;</span>TestFluenttb1<span>></span></span></span><span>(</span>a <span>=></span>
    <span>{</span>
        a<span>.</span><span>Name</span><span>(</span><span>"xxdkdkdk1"</span><span>)</span><span>;</span>
        a<span>.</span><span>Property</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>.</span><span>Name</span><span>(</span><span>"Id22"</span><span>)</span><span>.</span><span>IsIdentity</span><span>(</span><span>true</span><span>)</span><span>;</span>
        a<span>.</span><span>Property</span><span>(</span>b <span>=></span> b<span>.</span>name<span>)</span><span>.</span><span>DbType</span><span>(</span><span>"varchar(100)"</span><span>)</span><span>.</span><span>IsNullable</span><span>(</span><span>true</span><span>)</span><span>;</span>
    <span>}</span><span>)</span>
    <span>.</span><span><span>ConfigEntity</span><span><span>&lt;</span>TestFluenttb2<span>></span></span></span><span>(</span>a <span>=></span>
    <span>{</span>
        a<span>.</span><span>Name</span><span>(</span><span>"xxdkdkdk2"</span><span>)</span><span>;</span>
        a<span>.</span><span>Property</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>.</span><span>Name</span><span>(</span><span>"Id22"</span><span>)</span><span>.</span><span>IsIdentity</span><span>(</span><span>true</span><span>)</span><span>;</span>
        a<span>.</span><span>Property</span><span>(</span>b <span>=></span> b<span>.</span>name<span>)</span><span>.</span><span>DbType</span><span>(</span><span>"varchar(100)"</span><span>)</span><span>.</span><span>IsNullable</span><span>(</span><span>true</span><span>)</span><span>;</span>
    <span>}</span><span>)</span><span>;</span>

<span>//以下为实体类</span>
<span>class</span> <span>TestFluenttb1</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> <span>"defaultValue"</span><span>;</span>
<span>}</span>

<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"cccccdddwww"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>TestFluenttb2</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> <span>"defaultValue"</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>FreeSql.DbContext v1.4.0+ 实现了 EfCore FluentApi 99% 相似的语法</p>
</blockquote>
<h2 id="entity" tabindex="-1"> Entity</h2>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span><span>Entity</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span>eb <span>=></span> <span>{</span>
    eb<span>.</span><span>ToTable</span><span>(</span><span>"tb_song"</span><span>)</span><span>;</span>
    eb<span>.</span><span>Ignore</span><span>(</span>a <span>=></span> a<span>.</span>Field1<span>)</span><span>;</span>
    eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>)</span><span>.</span><span>HasColumnType</span><span>(</span><span>"varchar(50)"</span><span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>;</span>
    eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>Url<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>100</span><span>)</span><span>;</span>

    eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>RowVersion<span>)</span><span>.</span><span>IsRowVersion</span><span>(</span><span>)</span><span>;</span>
    eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>)</span><span>.</span><span>HasDefaultValueSql</span><span>(</span><span>"current_timestamp"</span><span>)</span><span>;</span>

    eb<span>.</span><span>HasKey</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>;</span>
    eb<span>.</span><span>HasIndex</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Id<span>,</span> a<span>.</span>Title <span>}</span><span>)</span><span>.</span><span>IsUnique</span><span>(</span><span>)</span><span>.</span><span>HasName</span><span>(</span><span>"idx_xxx11"</span><span>)</span><span>;</span>

    <span>//一对多、多对一</span>
    eb<span>.</span><span>HasOne</span><span>(</span>a <span>=></span> a<span>.</span>Type<span>)</span><span>.</span><span>HasForeignKey</span><span>(</span>a <span>=></span> a<span>.</span>TypeId<span>)</span><span>.</span><span>WithMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>)</span><span>;</span>

    <span>//多对多</span>
    eb<span>.</span><span>HasMany</span><span>(</span>a <span>=></span> a<span>.</span>Tags<span>)</span><span>.</span><span>WithMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>,</span> <span>typeof</span><span>(</span><span>Song_tag</span><span>)</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>

fsql<span>.</span>CodeFirst<span>.</span><span><span>Entity</span><span><span>&lt;</span>SongType<span>></span></span></span><span>(</span>eb <span>=></span> <span>{</span>
    eb<span>.</span><span>HasMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>)</span><span>.</span><span>WithOne</span><span>(</span>a <span>=></span> a<span>.</span>Type<span>)</span><span>.</span><span>HasForeignKey</span><span>(</span>a <span>=></span> a<span>.</span>TypeId<span>)</span><span>;</span>
    eb<span>.</span><span>HasData</span><span>(</span><span>new</span><span>[</span><span>]</span>
    <span>{</span>
        <span>new</span> <span>SongType</span>
        <span>{</span>
            Id <span>=</span> <span>1</span><span>,</span>
            Name <span>=</span> <span>"流行"</span><span>,</span>
            Songs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
            <span>{</span>
                <span>new</span> <span>Song</span><span>{</span> Title <span>=</span> <span>"真的爱你"</span> <span>}</span><span>,</span>
                <span>new</span> <span>Song</span><span>{</span> Title <span>=</span> <span>"爱你一万年"</span> <span>}</span><span>,</span>
            <span>}</span><span>)</span>
        <span>}</span><span>,</span>
        <span>new</span> <span>SongType</span>
        <span>{</span>
            Id <span>=</span> <span>2</span><span>,</span>
            Name <span>=</span> <span>"乡村"</span><span>,</span>
            Songs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span>
            <span>{</span>
                <span>new</span> <span>Song</span><span>{</span> Title <span>=</span> <span>"乡里乡亲"</span> <span>}</span><span>,</span>
            <span>}</span><span>)</span>
        <span>}</span><span>,</span>
    <span>}</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>

<span>public</span> <span>class</span> <span>SongType</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>List<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>Song</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Url <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> TypeId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>SongType</span> Type <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> Field1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>long</span></span> RowVersion <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="ientitytypeconfiguration" tabindex="-1"> IEntityTypeConfiguration</h2>
<p>以继承接口<code>IEntityTypeConfiguration</code>形式配置实体的。</p>
<ul>
<li>.NET Framework4.0 不支持</li>
</ul>
<h3 id="实体配置类" tabindex="-1"> 实体配置类</h3>
<div><pre><code><span>public</span> <span>class</span> <span>SongConfiguration</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>Song<span>></span></span></span>
<span>{</span>
    <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EfCoreTableFluent<span>&lt;</span>Song<span>></span></span> eb<span>)</span>
    <span>{</span>
        eb<span>.</span><span>ToTable</span><span>(</span><span>"tb_song1"</span><span>)</span><span>;</span>
        eb<span>.</span><span>Ignore</span><span>(</span>a <span>=></span> a<span>.</span>Field1<span>)</span><span>;</span>
        eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>)</span><span>.</span><span>HasColumnType</span><span>(</span><span>"varchar(50)"</span><span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>;</span>
        eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>Url<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>100</span><span>)</span><span>;</span>

        eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>RowVersion<span>)</span><span>.</span><span>IsRowVersion</span><span>(</span><span>)</span><span>;</span>
        eb<span>.</span><span>Property</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>)</span><span>.</span><span>HasDefaultValueSql</span><span>(</span><span>"current_timestamp"</span><span>)</span><span>;</span>

        eb<span>.</span><span>HasKey</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>;</span>
        eb<span>.</span><span>HasIndex</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>)</span><span>.</span><span>IsUnique</span><span>(</span><span>)</span><span>.</span><span>HasName</span><span>(</span><span>"idx_tb_song1111"</span><span>)</span><span>;</span>

        <span>//一对多、多对一</span>
        eb<span>.</span><span>HasOne</span><span>(</span>a <span>=></span> a<span>.</span>Type<span>)</span><span>.</span><span>HasForeignKey</span><span>(</span>a <span>=></span> a<span>.</span>TypeId<span>)</span><span>.</span><span>WithMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>)</span><span>;</span>

        <span>//多对多</span>
        eb<span>.</span><span>HasMany</span><span>(</span>a <span>=></span> a<span>.</span>Tags<span>)</span><span>.</span><span>WithMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>,</span> <span>typeof</span><span>(</span><span>Song_tag</span><span>)</span><span>)</span><span>;</span>
    <span>}</span>
<span>}</span>

</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="二种使用方式" tabindex="-1"> 二种使用方式</h3>
<p>1.单个配置</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>SongConfiguration</span><span>(</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>2.批量配置</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span>ApplyConfigurationsFromAssembly</span><span>(</span><span>typeof</span><span>(</span><span>SongConfiguration</span><span>)</span><span>.</span>Assembly<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="优先级" tabindex="-1"> 优先级</h2>
<p>数据库特性 &gt; 实体特性 &gt; FluentApi（配置特性） &gt; Aop（配置特性）</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">入门</title>
    <id>https://freesql.net/guide/getting-started.html</id>
    <link href="https://freesql.net/guide/getting-started.html"/>
    <updated>2022-09-08T05:59:57.000Z</updated>
    <content type="html"><![CDATA[<h1 id="入门" tabindex="-1"> 入门</h1>
<h2 id="模型" tabindex="-1"> 模型</h2>
<p><code>FreeSql</code> 使用模型执行数据访问，模型由实体类表示数据库表或视图，用于查询和保存数据。</p>
<p>可从现有数据库生成实体模型，<code>FreeSql</code> 提供 <code>IDbFirst</code> 接口实现<a href="/guide/db-first.html">生成实体模型</a>。</p>
<p>或者手动创建模型，基于模型创建或修改数据库，提供 <code>ICodeFirst</code> 同步结构的 <code>API</code>（甚至可以做到开发阶段自动同步）。</p>
<div><pre><code><span>using</span> <span>FreeSql<span>.</span>DataAnnotations</span><span>;</span>
<span>using</span> <span>System</span><span>;</span>

<span>public</span> <span>class</span> <span>Blog</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> BlogId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Url <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Rating <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="安装包" tabindex="-1"> 安装包</h2>
<p><a href="http://FreeSql.Provider.xxx" target="_blank" rel="noopener noreferrer">FreeSql.Provider.xxx</a>(<a href="/guide/install.html">可选的驱动</a>)</p>
<CodeTabs :data='[{"title":".NET CLI"},{"title":"Package Manager"}]' :active="0">

<template #tab0="{ title, value, isActive }">
<div><pre><code>dotnet <span>add</span> package FreeSql
dotnet <span>add</span> package FreeSql.Provider.Sqlite
</code></pre><div aria-hidden="true"><div></div><div></div></div></div></template>
<template #tab1="{ title, value, isActive }">
<div><pre><code>Install-Package FreeSql
Install-Package FreeSql.Provider.Sqlite
</code></pre><div aria-hidden="true"><div></div><div></div></div></div></template>
</CodeTabs>
<h2 id="声明" tabindex="-1"> 声明</h2>
<blockquote>
<p>注意： IFreeSql 在项目中应以单例声明，而不是在每次使用的时候创建。</p>
</blockquote>
<ul>
<li>.NET Core 单例模式</li>
</ul>
<CodeTabs :data='[{"title":".NET Core 5的Startup.cs"},{"title":".NET 6的Program.cs"}]' :active="1">

<template #tab0="{ title, value, isActive }">
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    <span>Func<span>&lt;</span>IServiceProvider<span>,</span> IFreeSql<span>></span></span> fsql <span>=</span> r <span>=></span>
    <span>{</span>
        <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
            <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=freedb.db"</span><span>)</span>
            <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"Sql：</span><span><span>{</span><span>cmd<span>.</span>CommandText</span><span>}</span></span><span>"</span></span><span>)</span><span>)</span><span>//监听SQL语句</span>
            <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库，FreeSql不会扫描程序集，只有CRUD时才会生成表。</span>
            <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
        <span>return</span> fsql<span>;</span>
    <span>}</span><span>;</span>
    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
<span>}</span>
<span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>
<span>{</span>
    <span>//在项目启动时，从容器中获取IFreeSql实例，并执行一些操作：同步表，种子数据,FluentAPI等</span>
    <span>using</span><span>(</span><span>IServiceScope</span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>
    <span>{</span>
        <span><span>var</span></span> fsql <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span><span>)</span><span>;</span>
        fsql<span>.</span>CodeFirst<span>.</span><span>SyncStructure</span><span>(</span><span>typeof</span><span>(</span><span>Topic</span><span>)</span><span>)</span><span>;</span><span>//Topic 为要同步的实体类</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></template>
<template #tab1="{ title, value, isActive }">
<div><pre><code><span><span>var</span></span> builder <span>=</span> WebApplication<span>.</span><span>CreateBuilder</span><span>(</span>args<span>)</span><span>;</span>
<span>Func<span>&lt;</span>IServiceProvider<span>,</span> IFreeSql<span>></span></span> fsql <span>=</span> r <span>=></span>
<span>{</span>
    <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
        <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=freedb.db"</span><span>)</span>
        <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"Sql：</span><span><span>{</span><span>cmd<span>.</span>CommandText</span><span>}</span></span><span>"</span></span><span>)</span><span>)</span><span>//监听SQL语句</span>
        <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库，FreeSql不会扫描程序集，只有CRUD时才会生成表。</span>
        <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
    <span>return</span> fsql<span>;</span>
<span>}</span><span>;</span>
builder<span>.</span>Services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>

<span>WebApplication</span> app <span>=</span> builder<span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
<span>//在项目启动时，从容器中获取IFreeSql实例，并执行一些操作：同步表，种子数据,FluentAPI等</span>
<span>using</span><span>(</span><span>IServiceScope</span> serviceScope <span>=</span> app<span>.</span>Services<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    <span><span>var</span></span> fsql <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    fsql<span>.</span>CodeFirst<span>.</span><span>SyncStructure</span><span>(</span><span>typeof</span><span>(</span><span>Topic</span><span>)</span><span>)</span><span>;</span><span>//Topic 为要同步的实体类</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></template>
</CodeTabs>
<ul>
<li><a href="/extra/idlebus-freesql.html">.NET Core 注入多个 FreeSql 实例</a></li>
<li>.NET Framework 单例</li>
</ul>
<div><pre><code><span>public</span> <span>class</span> <span>DB</span>
<span>{</span>
   <span>static</span> Lazy<span>&lt;</span>IFreeSql<span>></span>sqliteLazy <span>=</span> <span>new</span> <span>Lazy<span>&lt;</span>IFreeSql<span>></span></span><span>(</span><span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
         <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Trace<span>.</span><span>WriteLine</span><span>(</span><span><span>$"Sql：</span><span><span>{</span><span>cmd<span>.</span>CommandText</span><span>}</span></span><span>"</span></span><span>)</span><span>)</span><span>//监听SQL语句,Trace在输入选项卡中查看</span>
         <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=freedb.db"</span><span>)</span>
         <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库，FreeSql不会扫描程序集，只有CRUD时才会生成表。</span>
         <span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>
    <span>public</span> <span>static</span> <span>IFreeSql</span> Sqlite <span>=></span> sqliteLazy<span>.</span>Value<span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>注意：<code>class DB&lt;T&gt;</code> 泛型类不适合定义 static 单例</p>
</blockquote>
<p>然后直接通过 <code>IFreeSql  fsql = DB.Sqlite;</code>  即可得到 fsql 实例。</p>
<p><code>IFreeSql</code> 是 <code>ORM</code> 最顶级对象，所有操作都是使用它的方法或者属性：</p>
<div><pre><code>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span> <span>//查询</span>
fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span> <span>//插入</span>
fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span> <span>//更新</span>
fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span> <span>//删除</span>
fsql<span>.</span><span><span>InsertOrUpdate</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>// 插入或更新</span>
fsql<span>.</span><span>Transaction</span><span>(</span><span>..</span><span>)</span><span>;</span> <span>//事务</span>

fsql<span>.</span>CodeFirst<span>;</span> <span>//CodeFirst 对象</span>
fsql<span>.</span>DbFirst<span>;</span> <span>//DbFirst 对象</span>
fsql<span>.</span>Ado<span>;</span> <span>//Ado 对象</span>
fsql<span>.</span>Aop<span>;</span> <span>//Aop 对象</span>
fsql<span>.</span>GlobalFilter<span>;</span> <span>//全局过滤器对象</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="迁移" tabindex="-1"> 迁移</h2>
<p>程序运行中<code>FreeSql</code>会检查<code>AutoSyncStructure</code>参数，以此条件判断是否对比实体与数据库结构之间的变化，达到自动迁移的目的,更多请查看<a href="/guide/code-first.html">CodeFirst</a>文档，</p>
<blockquote>
<p>注意：谨慎、谨慎、谨慎在生产环境中使用该功能。</p>
</blockquote>
<blockquote>
<p>注意：谨慎、谨慎、谨慎在生产环境中使用该功能。</p>
</blockquote>
<blockquote>
<p>注意：谨慎、谨慎、谨慎在生产环境中使用该功能。</p>
</blockquote>
<h2 id="查询" tabindex="-1"> 查询</h2>
<div><pre><code><span><span>var</span></span> blogs <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Blog<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Rating <span>></span> <span>3</span><span>)</span>
    <span>.</span><span>OrderBy</span><span>(</span>b <span>=></span> b<span>.</span>Url<span>)</span>
    <span>.</span><span>Skip</span><span>(</span><span>100</span><span>)</span>
    <span>.</span><span>Limit</span><span>(</span><span>10</span><span>)</span> <span>//第100行-110行的记录</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="插入" tabindex="-1"> 插入</h2>
<div><pre><code><span><span>var</span></span> blog <span>=</span> <span>new</span> <span>Blog</span> <span>{</span> Url <span>=</span> <span>"http://sample.com"</span> <span>}</span><span>;</span>
blog<span>.</span>BlogId <span>=</span> <span>(</span><span>int</span><span>)</span>fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span>Blog<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>AppendData</span><span>(</span>blog<span>)</span>
    <span>.</span><span>ExecuteIdentity</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="更新" tabindex="-1"> 更新</h2>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Blog<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Set</span><span>(</span>b <span>=></span> b<span>.</span>Url<span>,</span> <span>"http://sample2222.com"</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Url <span>==</span> <span>"http://sample.com"</span><span>)</span>
    <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="删除" tabindex="-1"> 删除</h2>
<div><pre><code>fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Blog<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Url <span>==</span> <span>"http://sample.com"</span><span>)</span>
    <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h2 id="freesqlbuilder" tabindex="-1"> FreeSqlBuilder</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>UseConnectionString</td>
<td>this</td>
<td>设置连接串</td>
</tr>
<tr>
<td>UseSlave</td>
<td>this</td>
<td>设置从数据库，支持多个</td>
</tr>
<tr>
<td>UseConnectionFactory</td>
<td>this</td>
<td>设置自定义数据库连接对象（放弃内置对象连接池技术）</td>
</tr>
<tr>
<td>UseAutoSyncStructure</td>
<td>this</td>
<td>【开发环境必备】自动同步实体结构到数据库，程序运行中检查实体创建或修改表结构</td>
</tr>
<tr>
<td>UseNoneCommandParameter</td>
<td>this</td>
<td>不使用命令参数化执行，针对 Insert/Update，也可临时使用 IInsert/IUpdate.NoneParameter()</td>
</tr>
<tr>
<td>UseGenerateCommandParameterWithLambda</td>
<td>this</td>
<td>生成命令参数化执行，针对 lambda 表达式解析</td>
</tr>
<tr>
<td>UseLazyLoading</td>
<td>this</td>
<td>开启延时加载功能</td>
</tr>
<tr>
<td>UseMonitorCommand</td>
<td>this</td>
<td>监视全局 SQL 执行前后</td>
</tr>
<tr>
<td>UseMappingPriority</td>
<td>this</td>
<td>指定映射优先级（默认 Aop &lt; FluentApi &lt; Attribute）</td>
</tr>
<tr>
<td>UseNameConvert</td>
<td>this</td>
<td>自动转换名称 Entity -&gt; Db</td>
</tr>
<tr>
<td>UseExitAutoDisposePool</td>
<td>this</td>
<td>监听 AppDomain.CurrentDomain.ProcessExit/Console.CancelKeyPress 事件自动释放连接池 (默认 true)</td>
</tr>
<tr>
<td>Build&lt;T&gt;</td>
<td>IFreeSql&lt;T&gt;</td>
<td>创建一个 IFreeSql 对象，注意：单例设计，不要重复创建</td>
</tr>
</tbody>
</table>
<h2 id="connectionstrings" tabindex="-1"> ConnectionStrings</h2>
<table>
<thead>
<tr>
<th>DataType</th>
<th>ConnectionString</th>
</tr>
</thead>
<tbody>
<tr>
<td>DataType.MySql</td>
<td>Data Source=127.0.0.1;Port=3306;User ID=root;Password=root; Initial Catalog=cccddd;Charset=utf8; SslMode=none;Min pool size=1</td>
</tr>
<tr>
<td>DataType.PostgreSQL</td>
<td>Host=192.168.164.10;Port=5432;Username=postgres;Password=123456; Database=tedb;Pooling=true;Minimum Pool Size=1</td>
</tr>
<tr>
<td>DataType.SqlServer</td>
<td>Data Source=.;User Id=sa;Password=123456;Initial Catalog=freesqlTest;Encrypt=True;TrustServerCertificate=True;Pooling=true;Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.Oracle</td>
<td>user id=user1;password=123456; data source=//127.0.0.1:1521/XE;Pooling=true;Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.Sqlite</td>
<td>Data Source=|DataDirectory|\document.db; Attachs=xxxtb.db; Pooling=true;Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.ClickHouse</td>
<td>DataCompress=False;BufferSize=32768;SocketTimeout=10000;CheckCompressedHash=False;Encrypt=False;Compressor=lz4;Host=192.168.0.121;Port=8125;Database=PersonnelLocation;Username=root;Password=123</td>
</tr>
<tr>
<td>DataType.Firebird</td>
<td>database=localhost:D:\fbdata\EXAMPLES.fdb;user=sysdba;password=123456</td>
</tr>
<tr>
<td>DataType.MsAccess</td>
<td>Provider=Microsoft.Jet.OleDb.4.0;Data Source=d:/accdb/2003.mdb</td>
</tr>
<tr>
<td>DataType.Dameng(达梦)</td>
<td>server=127.0.0.1;port=5236;user id=2user;password=123456789;database=2user;poolsize=5</td>
</tr>
<tr>
<td>DataType.ShenTong(神通)</td>
<td>HOST=192.168.164.10;PORT=2003;DATABASE=OSRDB;USERNAME=SYSDBA;PASSWORD=szoscar55;MAXPOOLSIZE=2</td>
</tr>
<tr>
<td>DataType.KingbaseES(人大金仓) V008R003</td>
<td>Server=127.0.0.1;Port=54321;UID=USER2;PWD=123456789;database=TEST;MAXPOOLSIZE=2</td>
</tr>
<tr>
<td>DataType.Gbase(南大通用)</td>
<td>Driver={GBase ODBC DRIVER (64-Bit)};Host=192.168.164.134;Service=9088;Server=gbase01;Database=testdb;Protocol=onsoctcp;Uid=gbasedbt;Pwd=GBase123;Db_locale=zh_CN.utf8;Client_locale=zh_CN.utf8</td>
</tr>
<tr>
<td>DataType.OdbcMySql</td>
<td>Driver={MySQL ODBC 8.0 Unicode Driver}; Server=127.0.0.1;Persist Security Info=False; Trusted_Connection=Yes;UID=root;PWD=root; DATABASE=cccddd_odbc;Charset=utf8; SslMode=none;Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.OdbcSqlServer</td>
<td>Driver={SQL Server};Data Source=.;User Id=sa;Password=123456;Initial Catalog=freesqlTest;Encrypt=True;TrustServerCertificate=True;Pooling=true;Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.OdbcOracle</td>
<td>Driver={Oracle in XE};Server=//127.0.0.1:1521/XE; Persist Security Info=False; Trusted_Connection=Yes;UID=odbc1;PWD=123456; Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.OdbcPostgreSQL</td>
<td>Driver={PostgreSQL Unicode(x64)};Server=192.168.164.10; Port=5432;UID=postgres;PWD=123456; Database=tedb_odbc;Pooling=true;Min Pool Size=1</td>
</tr>
<tr>
<td>DataType.OdbcDameng (达梦)</td>
<td>Driver={DM8 ODBC DRIVER};Server=127.0.0.1:5236; Persist Security Info=False; Trusted_Connection=Yes; UID=USER1;PWD=123456789</td>
</tr>
<tr>
<td>DataType.OdbcKingbaseES (人大金仓) V008R003</td>
<td>Driver={KingbaseES 8.2 ODBC Driver ANSI};Server=127.0.0.1;Port=54321;UID=USER2;PWD=123456789;database=TEST</td>
</tr>
<tr>
<td>DataType.Odbc</td>
<td>Driver={SQL Server};Server=.;Persist Security Info=False; Trusted_Connection=Yes;Integrated Security=True; DATABASE=freesqlTest_odbc; Pooling=true;Min pool size=1</td>
</tr>
<tr>
<td><a href="https://github.com/dotnetcore/FreeSql/tree/master/Providers/FreeSql.Provider.Custom" target="_blank" rel="noopener noreferrer">DataType.Custom</a></td>
<td>自定义连接串，访问任何数据库</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">新增和修改</title>
    <id>https://freesql.net/guide/insert-or-update.html</id>
    <link href="https://freesql.net/guide/insert-or-update.html"/>
    <updated>2022-08-17T11:56:29.000Z</updated>
    <content type="html"><![CDATA[<h1 id="新增和修改" tabindex="-1"> 新增和修改</h1>
<h2 id="_1、ifreesql-insertorupdate" tabindex="-1"> 1、IFreeSql.InsertOrUpdate</h2>
<p>IFreeSql 定义了 InsertOrUpdate 方法实现添加或修改的功能，利用数据库特性：(v1.5.0+)</p>
<table>
<thead>
<tr>
<th>Database</th>
<th>Features</th>
<th></th>
<th>Database</th>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySql</td>
<td>on duplicate key update</td>
<td></td>
<td>达梦</td>
<td>merge into</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>on conflict do update</td>
<td></td>
<td>人大金仓</td>
<td>on conflict do update</td>
</tr>
<tr>
<td>SqlServer</td>
<td>merge into</td>
<td></td>
<td>神通</td>
<td>merge into</td>
</tr>
<tr>
<td>Oracle</td>
<td>merge into</td>
<td></td>
<td>南大通用</td>
<td>merge into</td>
</tr>
<tr>
<td>Sqlite</td>
<td>replace into</td>
<td></td>
<td>MsAccess</td>
<td>不支持</td>
</tr>
<tr>
<td>Firebird</td>
<td>merge into</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div><pre><code>fsql<span>.</span><span><span>InsertOrUpdate</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>items<span>)</span> <span>//需要操作的数据</span>
  <span>//.IfExistsDoNothing() //如果数据存在，啥事也不干（相当于只有不存在数据时才插入）</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

<span>//或者..</span>
<span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>,</span> T3<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>ToSql</span><span>(</span><span>(</span>a<span>,</span> b<span>)</span> <span>=></span> <span>new</span>
  <span>{</span>
    id <span>=</span> a<span>.</span>id <span>+</span> <span>1</span><span>,</span>
    name <span>=</span> <span>"xxx"</span>
  <span>}</span><span>,</span> FieldAliasOptions<span>.</span>AsProperty<span>)</span><span>;</span>

fsql<span>.</span><span><span>InsertOrUpdate</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>sql<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>当实体类有自增属性时，批量 InsertOrUpdate 最多可被拆成两次执行，内部计算出未设置自增值、和有设置自增值的数据，分别执行 insert into 和 上面讲到的 merge into 两种命令（采用事务执行）。</p>
<p>注意：FreeSql.Repository 通用仓储也有 InsertOrUpdate 方法，它们的机制不一样。</p>
<hr>
<h2 id="_2、字典插入或更新" tabindex="-1"> 2、字典插入或更新</h2>
<div><pre><code><span><span>var</span></span> dic <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"id"</span><span>,</span> <span>1</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"name"</span><span>,</span> <span>"xxxx"</span><span>)</span><span>;</span>

fsql<span>.</span><span>InsertOrUpdateDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>WherePrimary</span><span>(</span><span>"id"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//（产生 SQL 同上）</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="_3、freesql-repository-之-insertorupdate" tabindex="-1"> 3、FreeSql.Repository 之 InsertOrUpdate</h2>
<p>使用此方法需要引用 FreeSql.Repository 或 FreeSql.DbContext 功能包。</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>InsertOrUpdate</span><span>(</span>实体<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>如果内部的状态管理存在数据，则更新。</p>
<p>如果内部的状态管理不存在数据，则查询数据库，判断是否存在。</p>
<blockquote>
<p>存在则更新，不存在则插入</p>
</blockquote>
<p>缺点：不支持批量操作</p>
<hr>
<h2 id="_4、beginedit-批量编辑" tabindex="-1"> 4、BeginEdit 批量编辑</h2>
<div><pre><code><span>[</span><span><span>Fact</span></span><span>]</span>
<span>public</span> <span><span>void</span></span> <span>BeginEdit</span><span>(</span><span>)</span>
<span>{</span>
    fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>BeginEdit01<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>"1=1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>BeginEdit01<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> cts <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类1"</span> <span>}</span><span>,</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类1_1"</span> <span>}</span><span>,</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类1_2"</span> <span>}</span><span>,</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类1_3"</span> <span>}</span><span>,</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类2"</span> <span>}</span><span>,</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类2_1"</span> <span>}</span><span>,</span>
        <span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类2_2"</span> <span>}</span>
    <span>}</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    repo<span>.</span><span>Insert</span><span>(</span>cts<span>)</span><span>;</span>

    repo<span>.</span><span>BeginEdit</span><span>(</span>cts<span>)</span><span>;</span> <span>//开始对 cts 进行编辑</span>

    cts<span>.</span><span>Add</span><span>(</span><span>new</span> <span>BeginEdit01</span> <span>{</span> Name <span>=</span> <span>"分类2_3"</span> <span>}</span><span>)</span><span>;</span>
    cts<span>[</span><span>0</span><span>]</span><span>.</span>Name <span>=</span> <span>"123123"</span><span>;</span>
    cts<span>.</span><span>RemoveAt</span><span>(</span><span>1</span><span>)</span><span>;</span>

    Assert<span>.</span><span>Equal</span><span>(</span><span>3</span><span>,</span> repo<span>.</span><span>EndEdit</span><span>(</span><span>)</span><span>)</span><span>;</span> <span>//重载方法新旧对比 repo.EndEdit(newlist)</span>
<span>}</span>
<span>class</span> <span>BeginEdit01</span>
<span>{</span>
    <span>public</span> <span>Guid</span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>上面的代码 EndEdit 方法执行的时候产生 3 条 SQL 如下：</p>
<div><pre><code><span>INSERT</span> <span>INTO</span> <span>"BeginEdit01"</span><span>(</span><span>"Id"</span><span>,</span> <span>"Name"</span><span>)</span> <span>VALUES</span><span>(</span><span>'5f26bf07-6ac3-cbe8-00da-7dd74818c3a6'</span><span>,</span> <span>'分类2_3'</span><span>)</span>


<span>UPDATE</span> <span>"BeginEdit01"</span> <span>SET</span> <span>"Name"</span> <span>=</span> <span>'123123'</span>
<span>WHERE</span> <span>(</span><span>"Id"</span> <span>=</span> <span>'5f26bf00-6ac3-cbe8-00da-7dd01be76e26'</span><span>)</span>


<span>DELETE</span> <span>FROM</span> <span>"BeginEdit01"</span> <span>WHERE</span> <span>(</span><span>"Id"</span> <span>=</span> <span>'5f26bf00-6ac3-cbe8-00da-7dd11bcf54dc'</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>场景：winform 加载表数据后，一顿添加、修改、删除操作之后，点击【保存】</p>
<p>提醒：该操作只对变量 cts 有效，不是针对全表对比更新。</p>
<h2 id="_5、mysql-特有功能-on-duplicate-key-update" tabindex="-1"> 5、MySql 特有功能 On Duplicate Key Update</h2>
<p>FreeSql.Provider.MySql 和 FreeSql.Provider.MySqlConnector 支持 MySql 特有的功能，On Duplicate Key Update。</p>
<p>这个功能也可以实现插入或更新数据，并且支持批量操作。</p>
<div><pre><code><span>class</span> <span>TestOnDuplicateKeyUpdateInfo</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> time <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> item <span>=</span> <span>new</span> <span>TestOnDuplicateKeyUpdateInfo</span> <span>{</span> id <span>=</span> <span>100</span><span>,</span> title <span>=</span> <span>"title-100"</span><span>,</span> time <span>=</span> DateTime<span>.</span><span>Parse</span><span>(</span><span>"2000-01-01"</span><span>)</span> <span>}</span><span>;</span>
fsql<span>.</span><span>Insert</span><span>(</span>item<span>)</span>
    <span>.</span><span>NoneParameter</span><span>(</span><span>)</span>
    <span>.</span><span>OnDuplicateKeyUpdate</span><span>(</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `TestOnDuplicateKeyUpdateInfo`(`id`, `title`, `time`) VALUES(100, 'title-100', '2000-01-01 00:00:00.000')</span>
<span>//ON DUPLICATE KEY UPDATE</span>
<span>//`title` = VALUES(`title`),</span>
<span>//`time` = VALUES(`time`)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>OnDuplicateKeyUpdate() 之后可以调用的方法：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>IgnoreColumns</td>
<td>忽略更新的列，机制和 IUpdate.IgnoreColumns 一样</td>
</tr>
<tr>
<td>UpdateColumns</td>
<td>指定更新的列，机制和 IUpdate.UpdateColumns 一样</td>
</tr>
<tr>
<td>Set</td>
<td>手工指定更新的列，与 IUpdate.Set 功能一样</td>
</tr>
<tr>
<td>SetRaw</td>
<td>作为 Set 方法的补充，可传入 SQL 字符串</td>
</tr>
<tr>
<td>ToSql</td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>执行，返回影响的行数</td>
</tr>
</tbody>
</table>
<p>IInsert 与 OnDuplicateKeyUpdate 都有 IgnoreColumns、UpdateColumns 方法。</p>
<p>当插入实体/集合实体的时候，忽略了 time 列，代码如下：</p>
<div><pre><code>fsql<span>.</span><span>Insert</span><span>(</span>item<span>)</span>
    <span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> a<span>.</span>time<span>)</span>
    <span>.</span><span>NoneParameter</span><span>(</span><span>)</span>
    <span>.</span><span>OnDuplicateKeyUpdate</span><span>(</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `TestOnDuplicateKeyUpdateInfo`(`id`, `title`) VALUES(200, 'title-200')</span>
<span>//ON DUPLICATE KEY UPDATE</span>
<span>//`title` = VALUES(`title`),</span>
<span>//`time` = '2000-01-01 00:00:00.000'</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>我们发现，UPDATE time 部分变成了常量，而不是 VALUES(`time`)，机制如下：</p>
<p>当 insert 部分中存在的列，在 update 中将以 VALUES(`字段`) 的形式设置；</p>
<p>当 insert 部分中不存在的列，在 update 中将为常量形式设置，当操作实体数组的时候，此常量为 case when ... end 执行（与 IUpdate 一样）；</p>
<hr>
<h2 id="_6、postgresql-特有功能-on-conflict-do-update" tabindex="-1"> 6、PostgreSQL 特有功能 On Conflict Do Update</h2>
<p>FreeSql.Provider.PostgreSQL 支持 PostgreSQL 9.5+ 特有的功能，On Conflict(id) Do Update。</p>
<p>使用方法 MySql OnDuplicateKeyUpdate 大致相同。</p>
<div><pre><code><span>class</span> <span>TestOnConflictDoUpdateInfo</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime<span>?</span></span> time <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> items <span>=</span> <span>new</span> <span>[</span><span>]</span> <span>{</span>
    <span>new</span> <span>TestOnConflictDoUpdateInfo</span> <span>{</span> id <span>=</span> <span>200</span><span>,</span> title <span>=</span> <span>"title-200"</span><span>,</span> time <span>=</span> DateTime<span>.</span><span>Parse</span><span>(</span><span>"2000-01-01"</span><span>)</span> <span>}</span><span>,</span>
    <span>new</span> <span>TestOnConflictDoUpdateInfo</span> <span>{</span> id <span>=</span> <span>201</span><span>,</span> title <span>=</span> <span>"title-201"</span><span>,</span> time <span>=</span> DateTime<span>.</span><span>Parse</span><span>(</span><span>"2000-01-01"</span><span>)</span> <span>}</span><span>,</span>
    <span>new</span> <span>TestOnConflictDoUpdateInfo</span> <span>{</span> id <span>=</span> <span>202</span><span>,</span> title <span>=</span> <span>"title-202"</span><span>,</span> time <span>=</span> DateTime<span>.</span><span>Parse</span><span>(</span><span>"2000-01-01"</span><span>)</span> <span>}</span>
<span>}</span><span>;</span>
fsql<span>.</span><span>Insert</span><span>(</span>items<span>)</span>
    <span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> a<span>.</span>time<span>)</span>
    <span>.</span><span>NoneParameter</span><span>(</span><span>)</span>
    <span>.</span><span>OnConflictDoUpdate</span><span>(</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO ""testonconflictdoupdateinfo""(""id"", ""title"") VALUES(200, 'title-200'), (201, 'title-201'), (202, 'title-202')</span>
<span>//ON CONFLICT(""id"") DO UPDATE SET</span>
<span>//""title"" = EXCLUDED.""title"",</span>
<span>//""time"" = CASE EXCLUDED.""id""</span>
<span>//WHEN 200 THEN '2000-01-01 00:00:00.000000'</span>
<span>//WHEN 201 THEN '2000-01-01 00:00:00.000000'</span>
<span>//WHEN 202 THEN '2000-01-01 00:00:00.000000' END::timestamp</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">新增</title>
    <id>https://freesql.net/guide/insert.html</id>
    <link href="https://freesql.net/guide/insert.html"/>
    <updated>2022-08-17T03:27:37.000Z</updated>
    <content type="html"><![CDATA[<h1 id="新增" tabindex="-1"> 新增</h1>
<p><code>FreeSql</code> 提供单条和批量插入数据的方法，在特定的数据库执行还可以返回插入后的记录。</p>
<div><pre><code><span><span>var</span></span> connectionString <span>=</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;"</span> <span>+</span>
    <span>"Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>;</span>

<span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connectionString<span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> items <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
<span>for</span> <span>(</span><span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span> a <span>&lt;</span> <span>10</span><span>;</span> a<span>++</span><span>)</span> items<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> Title <span>=</span> <span><span>$"newtitle</span><span><span>{</span><span>a</span><span>}</span></span><span>"</span></span><span>,</span> Clicks <span>=</span> a <span>*</span> <span>100</span> <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_1、单条插入" tabindex="-1"> 1、单条插入</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>[</span><span>0</span><span>]</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `Topic`(`Clicks`, `Title`, `CreateTime`)</span>
<span>//VALUES(?Clicks0, ?Title0, ?CreateTime0)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>如果表有自增列，插入数据后应该要返回 id。</p>
<p>方法 1：(原始)</p>
<div><pre><code><span><span>long</span></span> id <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>[</span><span>0</span><span>]</span><span>)</span><span>.</span><span>ExecuteIdentity</span><span>(</span><span>)</span><span>;</span>
items<span>[</span><span>0</span><span>]</span><span>.</span>Id <span>=</span> id<span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>方法 2：(依赖 FreeSql.Repository)</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>Insert</span><span>(</span>items<span>[</span><span>0</span><span>]</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><blockquote>
<p>内部会将插入后的自增值填充给 items[0].Id (支持批量插入回填)</p>
</blockquote>
<blockquote>
<p>DbFirst 模式序列：[Column(IsIdentity = true, InsertValueSql = &quot;seqname.nextval&quot;)]</p>
</blockquote>
<h2 id="_2、批量插入" tabindex="-1"> 2、批量插入</h2>
<div><pre><code><span><span>var</span></span> t2 <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `Topic`(`Clicks`, `Title`, `CreateTime`)</span>
<span>//VALUES(?Clicks0, ?Title0, ?CreateTime0), (?Clicks1, ?Title1, ?CreateTime1),</span>
<span>//(?Clicks2, ?Title2, ?CreateTime2), (?Clicks3, ?Title3, ?CreateTime3),</span>
<span>//(?Clicks4, ?Title4, ?CreateTime4), (?Clicks5, ?Title5, ?CreateTime5),</span>
<span>//(?Clicks6, ?Title6, ?CreateTime6), (?Clicks7, ?Title7, ?CreateTime7),</span>
<span>//(?Clicks8, ?Title8, ?CreateTime8), (?Clicks9, ?Title9, ?CreateTime9)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>解决了 SqlServer 批量添加容易导致的错误：传入的请求具有过多的参数。该服务器支持最多 2100 个参数。请减少参数的数目，然后重新发送该请求。</p>
</blockquote>
<blockquote>
<p>原理为拆成多个包用事务执行；</p>
</blockquote>
<p>当插入大批量数据时，内部采用分割分批执行的逻辑进行。分割规则如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>数量</th>
<th>参数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySql</td>
<td>5000</td>
<td>3000</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>5000</td>
<td>3000</td>
</tr>
<tr>
<td>SqlServer</td>
<td>1000</td>
<td>2100</td>
</tr>
<tr>
<td>Oracle</td>
<td>500</td>
<td>999</td>
</tr>
<tr>
<td>Sqlite</td>
<td>5000</td>
<td>999</td>
</tr>
</tbody>
</table>
<blockquote>
<p>数量：为每批分割的大小，如批量插入 10000 条数据，在 mysql 执行时会分割为两批。<br />
参数量：为每批分割的参数量大小，如批量插入 10000 条数据，每行需要使用 5 个参数化，在 mysql 执行时会分割为每批 3000 / 5。</p>
</blockquote>
<p>分割执行后，当外部未提供事务时，内部自开事务，实现插入完整性。也可以通过 BatchOptions 设置合适的值。</p>
<p>FreeSql 适配了每一种数据类型参数化，和不参数化的使用。批量插入建议关闭参数化功能，使用 .NoneParameter() 进行执行。</p>
<h2 id="_3、executesqlbulkcopy、executepgcopy、executemysqlbulkcopy" tabindex="-1"> 3、ExecuteSqlBulkCopy、ExecutePgCopy、ExecuteMySqlBulkCopy</h2>
<p>Bulk Copy 操作以扩展方法的形式实现，针对 SqlServer/PostgreSQL/MySql 数据库，可用的包：FreeSql.Provider.SqlServer/FreeSql.Provider.PostgreSQL/FreeSql.Provider.MySqlConnector。</p>
<h3 id="批量插入测试参考-52-个字段" tabindex="-1"> 批量插入测试参考(52 个字段)</h3>
<table>
<thead>
<tr>
<th></th>
<th>18W</th>
<th>1W</th>
<th>5K</th>
<th>2K</th>
<th>1K</th>
<th>500</th>
<th>100</th>
<th>50</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySql 5.5 ExecuteAffrows</td>
<td>38,481</td>
<td>2,234</td>
<td>1,136</td>
<td>284</td>
<td>239</td>
<td>167</td>
<td>66</td>
<td>30</td>
</tr>
<tr>
<td>MySql 5.5 ExecuteMySqlBulkCopy</td>
<td>28,405</td>
<td>1,142</td>
<td>657</td>
<td>451</td>
<td>435</td>
<td>592</td>
<td>47</td>
<td>22</td>
</tr>
<tr>
<td>SqlServer Express ExecuteAffrows</td>
<td>402,355</td>
<td>24,847</td>
<td>11,465</td>
<td>4,971</td>
<td>2,437</td>
<td>915</td>
<td>138</td>
<td>88</td>
</tr>
<tr>
<td>SqlServer Express ExecuteSqlBulkCopy</td>
<td>21,065</td>
<td>578</td>
<td>326</td>
<td>139</td>
<td>105</td>
<td>79</td>
<td>60</td>
<td>48</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecuteAffrows</td>
<td>46,756</td>
<td>3,294</td>
<td>2,269</td>
<td>1,019</td>
<td>374</td>
<td>209</td>
<td>51</td>
<td>37</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecutePgCopy</td>
<td>10,090</td>
<td>583</td>
<td>337</td>
<td>136</td>
<td>88</td>
<td>61</td>
<td>30</td>
<td>25</td>
</tr>
</tbody>
</table>
<blockquote>
<p>18W 解释：插入 18 万行记录，表格中的数字是执行时间（单位 ms）</p>
</blockquote>
<h3 id="批量插入测试参考-10-个字段" tabindex="-1"> 批量插入测试参考(10 个字段)</h3>
<table>
<thead>
<tr>
<th></th>
<th>18W</th>
<th>1W</th>
<th>5K</th>
<th>2K</th>
<th>1K</th>
<th>500</th>
<th>100</th>
<th>50</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySql 5.5 ExecuteAffrows</td>
<td>11,171</td>
<td>866</td>
<td>366</td>
<td>80</td>
<td>83</td>
<td>50</td>
<td>24</td>
<td>34</td>
</tr>
<tr>
<td>MySql 5.5 ExecuteMySqlBulkCopy</td>
<td>6,504</td>
<td>399</td>
<td>257</td>
<td>116</td>
<td>87</td>
<td>100</td>
<td>16</td>
<td>16</td>
</tr>
<tr>
<td>SqlServer Express ExecuteAffrows</td>
<td>47,204</td>
<td>2,275</td>
<td>1,108</td>
<td>488</td>
<td>279</td>
<td>123</td>
<td>35</td>
<td>16</td>
</tr>
<tr>
<td>SqlServer Express ExecuteSqlBulkCopy</td>
<td>4,248</td>
<td>127</td>
<td>71</td>
<td>30</td>
<td>48</td>
<td>14</td>
<td>11</td>
<td>10</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecuteAffrows</td>
<td>9,786</td>
<td>568</td>
<td>336</td>
<td>157</td>
<td>102</td>
<td>34</td>
<td>9</td>
<td>6</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecutePgCopy</td>
<td>4,081</td>
<td>167</td>
<td>93</td>
<td>39</td>
<td>21</td>
<td>12</td>
<td>4</td>
<td>2</td>
</tr>
</tbody>
</table>
<blockquote>
<p>测试结果，是在相同操作系统下进行的，并且都有预热</p>
</blockquote>
<h2 id="_4、插入指定的列" tabindex="-1"> 4、插入指定的列</h2>
<div><pre><code><span><span>var</span></span> t3 <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>)</span><span>.</span><span>InsertColumns</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `Topic`(`Title`)</span>
<span>//VALUES(?Title0), (?Title1), (?Title2), (?Title3), (?Title4),</span>
<span>//(?Title5), (?Title6), (?Title7), (?Title8), (?Title9)</span>

<span><span>var</span></span> t4 <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>)</span><span>.</span><span>InsertColumns</span><span>(</span>a <span>=></span><span>new</span> <span>{</span> a<span>.</span>Title<span>,</span> a<span>.</span>Clicks <span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `Topic`(`Clicks`, `Title`)</span>
<span>//VALUES(?Clicks0, ?Title0), (?Clicks1, ?Title1), (?Clicks2, ?Title2),</span>
<span>//(?Clicks3, ?Title3), (?Clicks4, ?Title4), (?Clicks5, ?Title5),</span>
<span>//(?Clicks6, ?Title6), (?Clicks7, ?Title7), (?Clicks8, ?Title8),</span>
<span>//(?Clicks9, ?Title9)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_5、忽略列" tabindex="-1"> 5、忽略列</h2>
<div><pre><code><span><span>var</span></span> t5 <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>)</span><span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `Topic`(`Clicks`, `Title`)</span>
<span>//VALUES(?Clicks0, ?Title0), (?Clicks1, ?Title1), (?Clicks2, ?Title2),</span>
<span>//(?Clicks3, ?Title3), (?Clicks4, ?Title4), (?Clicks5, ?Title5),</span>
<span>//(?Clicks6, ?Title6), (?Clicks7, ?Title7), (?Clicks8, ?Title8),</span>
<span>//(?Clicks9, ?Title9)</span>

<span><span>var</span></span> t6 <span>=</span> fsql<span>.</span><span>Insert</span><span>(</span>items<span>)</span><span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Title<span>,</span> a<span>.</span>CreateTime <span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>///INSERT INTO `Topic`(`Clicks`)</span>
<span>//VALUES(?Clicks0), (?Clicks1), (?Clicks2), (?Clicks3), (?Clicks4),</span>
<span>//(?Clicks5), (?Clicks6), (?Clicks7), (?Clicks8), (?Clicks9)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_6、列插入优先级" tabindex="-1"> 6、列插入优先级</h2>
<div><pre><code>全部列 <span>&lt;</span> 指定列<span>(</span>InsertColumns<span>)</span> <span>&lt;</span> 忽略列<span>(</span>IgnoreColumns<span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>在没有使用 <code>InsertColumns/IgnoreColumns</code> 的情况下，实体所有列将被插入数据库；</p>
<p>在使用 <code>InsertColumns</code>，没有使用 <code>IgnoreColumns</code> 的情况下，只有指定的列插入数据库；</p>
<p>在使用 <code>IgnoreColumns</code> 的情况下，只有未被指定的列插入数据库；</p>
<h2 id="_7、字典插入" tabindex="-1"> 7、字典插入</h2>
<div><pre><code><span><span>var</span></span> dic <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"id"</span><span>,</span> <span>1</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"name"</span><span>,</span> <span>"xxxx"</span><span>)</span><span>;</span>

fsql<span>.</span><span>InsertDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_8、导入表数据" tabindex="-1"> 8、导入表数据</h2>
<div><pre><code><span><span>int</span></span> affrows <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Limit</span><span>(</span><span>10</span><span>)</span>
  <span>.</span><span>InsertInto</span><span>(</span><span>null</span><span>,</span> a <span>=></span> <span>new</span> <span>Topic2</span>
  <span>{</span>
    Title <span>=</span> a<span>.</span>Title
  <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>INSERT</span> <span>INTO</span> <span><span>`</span>Topic2<span>`</span></span><span>(</span><span><span>`</span>Title<span>`</span></span><span>,</span> <span><span>`</span>Clicks<span>`</span></span><span>,</span> <span><span>`</span>CreateTime<span>`</span></span><span>)</span>
<span>SELECT</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> <span>0</span><span>,</span> <span>'0001-01-01 00:00:00'</span>
<span>FROM</span> <span><span>`</span>Topic<span>`</span></span> a
<span>limit</span> <span>10</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>注意：因为 <code>Clicks</code>、<code>CreateTime</code> 没有被选择，所以使用目标实体属性<code>[Column(InsertValueSql = xx)]</code> 设置的值，或者使用目标实体属性的 <code>c#</code>默认值。</p>
<h2 id="_9、mysql-特有功能-insert-ignore-into" tabindex="-1"> 9、MySql 特有功能 <code>Insert Ignore Into</code></h2>
<div><pre><code>fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>MySqlIgnoreInto</span><span>(</span><span>)</span><span>.</span><span>AppendData</span><span>(</span>items<span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>///INSERT IGNORE INTO `Topic`(`Clicks`)</span>
<span>//VALUES(?Clicks0), (?Clicks1), (?Clicks2), (?Clicks3), (?Clicks4),</span>
<span>//(?Clicks5), (?Clicks6), (?Clicks7), (?Clicks8), (?Clicks9)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="_10、mysql-特有功能-on-duplicate-key-update" tabindex="-1"> 10、MySql 特有功能 <code>On Duplicate Key Update</code></h2>
<p>FreeSql.Provider.MySql 和 FreeSql.Provider.MySqlConnector 支持 MySql 特有的功能，On Duplicate Key Update。</p>
<p>这个功能也可以实现插入或更新数据，并且支持批量操作。</p>
<div><pre><code><span>class</span> <span>TestOnDuplicateKeyUpdateInfo</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> time <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> item <span>=</span> <span>new</span> <span>TestOnDuplicateKeyUpdateInfo</span> <span>{</span> id <span>=</span> <span>100</span><span>,</span> title <span>=</span> <span>"title-100"</span><span>,</span> time <span>=</span> DateTime<span>.</span><span>Parse</span><span>(</span><span>"2000-01-01"</span><span>)</span> <span>}</span><span>;</span>
fsql<span>.</span><span>Insert</span><span>(</span>item<span>)</span>
    <span>.</span><span>NoneParameter</span><span>(</span><span>)</span>
    <span>.</span><span>OnDuplicateKeyUpdate</span><span>(</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `TestOnDuplicateKeyUpdateInfo`(`id`, `title`, `time`) VALUES(100, 'title-100', '2000-01-01 00:00:00.000')</span>
<span>//ON DUPLICATE KEY UPDATE</span>
<span>//`title` = VALUES(`title`), </span>
<span>//`time` = VALUES(`time`)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>OnDuplicateKeyUpdate() 之后可以调用的方法：</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>IgnoreColumns</td>
<td>忽略更新的列，机制和 IUpdate.IgnoreColumns 一样</td>
</tr>
<tr>
<td>UpdateColumns</td>
<td>指定更新的列，机制和 IUpdate.UpdateColumns 一样</td>
</tr>
<tr>
<td>Set</td>
<td>手工指定更新的列，与 IUpdate.Set 功能一样</td>
</tr>
<tr>
<td>SetRaw</td>
<td>作为 Set 方法的补充，可传入 SQL 字符串</td>
</tr>
<tr>
<td>ToSql</td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>执行，返回影响的行数</td>
</tr>
</tbody>
</table>
<p>IInsert 与 OnDuplicateKeyUpdate 都有 IgnoreColumns、UpdateColumns 方法。</p>
<p>当插入实体/集合实体的时候，忽略了 time 列，代码如下：</p>
<div><pre><code>fsql<span>.</span><span>Insert</span><span>(</span>item<span>)</span>
    <span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> a<span>.</span>time<span>)</span>
    <span>.</span><span>NoneParameter</span><span>(</span><span>)</span>
    <span>.</span><span>OnDuplicateKeyUpdate</span><span>(</span><span>)</span><span>.</span><span>ToSql</span><span>(</span><span>)</span><span>;</span>
<span>//INSERT INTO `TestOnDuplicateKeyUpdateInfo`(`id`, `title`) VALUES(200, 'title-200')</span>
<span>//ON DUPLICATE KEY UPDATE</span>
<span>//`title` = VALUES(`title`), </span>
<span>//`time` = '2000-01-01 00:00:00.000'</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>我们发现，UPDATE time 部分变成了常量，而不是 VALUES(`time`)，机制如下：</p>
<p>当 insert 部分中存在的列，在 update 中将以 VALUES(`字段`) 的形式设置；</p>
<p>当 insert 部分中不存在的列，在 update 中将为常量形式设置，当操作实体数组的时候，此常量为 case when ... end 执行（与 IUpdate 一样）；</p>
<h2 id="api" tabindex="-1"> API</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>AppendData</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>追加准备插入的实体</td>
</tr>
<tr>
<td>InsertIdentity</td>
<td>&lt;this&gt;</td>
<td>无</td>
<td>指明插入自增列</td>
</tr>
<tr>
<td>InsertColumns</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>只插入的列</td>
</tr>
<tr>
<td>IgnoreColumns</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>忽略的列</td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
</tr>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>OnDuplicateKeyUpdate</td>
<td>OnDuplicateKeyUpdate&lt;T1&gt;</td>
<td>无</td>
<td>MySql 特有的功能，On Duplicate Key Update</td>
</tr>
<tr>
<td>OnConflictDoUpdate</td>
<td>OnConflictDoUpdate&lt;T1&gt;</td>
<td>无</td>
<td>PostgreSQL 特有的功能，On Conflict Do Update</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回影响的行数</td>
</tr>
<tr>
<td>ExecuteIdentity</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回自增值</td>
</tr>
<tr>
<td>ExecuteInserted</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 语句，返回插入后的记录</td>
</tr>
<tr>
<td>ExecuteSqlBulkCopy</td>
<td>void</td>
<td></td>
<td>SqlServer 特有的功能，执行 SqlBulkCopy 批量插入的封装</td>
</tr>
<tr>
<td>ExecutePgCopy</td>
<td>void</td>
<td></td>
<td>PostgreSQL 特有的功能，执行 Copy 批量导入数据</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">安装</title>
    <id>https://freesql.net/guide/install.html</id>
    <link href="https://freesql.net/guide/install.html"/>
    <updated>2022-08-22T17:38:16.000Z</updated>
    <content type="html"><![CDATA[<h1 id="安装" tabindex="-1"> 安装</h1>
<h2 id="版本" tabindex="-1"> 版本</h2>
<p>FreeSql 是一个 .NET Standard 2.0 库，仅支持 .NET Framework 4.0 或 .NET Core 或更高版本的应用程序。</p>
<h2 id="安装包" tabindex="-1"> 安装包</h2>
<div><pre><code>dotnet <span>add</span> package FreeSql
dotnet <span>add</span> package FreeSql.DbContext
dotnet <span>add</span> package FreeSql.Provider.Sqlite
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>需要访问什么数据库，就安装对应的Provider.XX类库，也可直接安装FreeSql.All</p>
<div><pre><code>dotnet <span>add</span> package FreeSql.All
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="packages" tabindex="-1"> Packages</h2>
<table>
<thead>
<tr>
<th>Package Name</th>
<th>Version</th>
<th>说明</th>
<th>NUGET</th>
</tr>
</thead>
<tbody>
<tr>
<td>FreeSql</td>
<td>netstandard2.0+、net45+、net40+</td>
<td>freesql基础包</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/repository.html">FreeSql.Repository</a></td>
<td>NETStandard2.0、net45、net40</td>
<td>通用仓储 + UnitOfWork 实现</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Repository" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Repository" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/db-context.html">FreeSql.DbContext</a></td>
<td>NETStandard2.0、net45、net40</td>
<td>EFCore 的使用风格实现</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.DbContext" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.DbContext" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.MySql</td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 MySql.Data（Oracle 官方）</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.MySql" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.MySql" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/freesql-provider-mysqlconnector.html">FreeSql.Provider.MySqlConnector</a></td>
<td>NETStandard2.0、net45</td>
<td>基于 MySqlConnector</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.MySqlConnector" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.MySqlConnector" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.PostgreSQL</td>
<td>NETStandard2.0、net45</td>
<td>基于 PostgreSQL 9.5+</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.PostgreSQL" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.PostgreSQL" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.SqlServer</td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 SqlServer 2005+</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.SqlServer" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.SqlServer" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.SqlServerForSystem</td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 System.Data.SqlClient + SqlServer 2005+</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.SqlServerForSystem" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.SqlServerForSystem" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.Sqlite</td>
<td>NETStandard2.0、net45、net40</td>
<td></td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.Sqlite" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.Sqlite" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/freesql-provider-sqlitecore.html">FreeSql.Provider.SqliteCore</a></td>
<td>NETStandard2.0、net6.0</td>
<td>基于Microsoft.Data.Sqlite.Core，需安装bundle_xxx</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.SqliteCore" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.SqliteCore" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.ClickHouse</td>
<td>NETStandard2.1</td>
<td>基于ClickHouse.Client</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.ClickHouse" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.ClickHouse" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.Oracle</td>
<td>NETStandard2.0、net45、net40</td>
<td></td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.Oracle" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.Oracle" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.OracleOledb</td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 Oledb 解决 US7ASCII 中文乱码问题</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.OracleOledb" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.OracleOledb" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.Firebird</td>
<td>NETStandard2.0、net452</td>
<td></td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.Firebird" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.Firebird" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.MsAccess</td>
<td>NETStandard2.0、net45、net40</td>
<td></td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.MsAccess" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.MsAccess" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.Dameng</td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 达梦数据库</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.Dameng" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.Dameng" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.ShenTong</td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 神舟通用数据库</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.ShenTong" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.ShenTong" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.KingbaseES</td>
<td>NETStandard2.0、net461</td>
<td>基于 人大金仓数据库</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.KingbaseES" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.KingbaseES" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Provider.GBase</td>
<td>NETStandard2.0、net461</td>
<td>基于 南大通用GBase数据库</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.GBase" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.GBase" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/freesql-provider-odbc.html">FreeSql.Provider.Odbc</a></td>
<td>NETStandard2.0、net45、net40</td>
<td>基于 ODBC</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.Odbc" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.Odbc" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/freesql-provider-custom.html">FreeSql.Provider.Custom</a></td>
<td>NETStandard2.0、net45、net40</td>
<td>自定义数据库访问</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Provider.Custom" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Provider.Custom" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Extensions.LazyLoading</td>
<td>NETStandard2.0、net45、net40</td>
<td>延时属性扩展包</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Extensions.LazyLoading" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Extensions.LazyLoading" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/freesql-extensions-jsonmap.html">FreeSql.Extensions.JsonMap</a></td>
<td>NETStandard2.0、net45、net40</td>
<td>Json 序列化扩展包</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Extensions.JsonMap" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Extensions.JsonMap" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Extensions.Linq</td>
<td>NETStandard2.0、net45、net40</td>
<td>LinqToSql IQueryable 扩展包</td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Extensions.Linq" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Extensions.Linq" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td><a href="/guide/freesql-extensions-baseentity.html">FreeSql.Extensions.BaseEntity</a></td>
<td>NETStandard2.0</td>
<td></td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Extensions.BaseEntity" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Extensions.BaseEntity" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
<tr>
<td>FreeSql.Generator</td>
<td>NETCoreapp3.1</td>
<td>从数据库生成实体类，<a href="https://www.cnblogs.com/igeekfan/p/freesql-generator.html" target="_blank" rel="noopener noreferrer">生成器是如何实现的？</a></td>
<td><strong><a href="https://www.nuget.org/packages/FreeSql.Generator" target="_blank" rel="noopener noreferrer"><img src="https://buildstats.info/nuget/FreeSql.Generator" alt="NuGet" loading="lazy"></a></strong></td>
</tr>
</tbody>
</table>
<h2 id="学习指南" tabindex="-1"> 学习指南</h2>
<p>FreeSql 除了支持基本的增删查改功能外，还支持基于现有数据库创建模型（<a href="/guide/db-first.html">db-first</a>），和支持基于模型创建数据库（<a href="/guide/code-first.html">code-first</a>)。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">LinqToSql</title>
    <id>https://freesql.net/guide/linq-to-sql.html</id>
    <link href="https://freesql.net/guide/linq-to-sql.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="linqtosql" tabindex="-1"> LinqToSql</h1>
<p>原本不支持 IQueryable 主要出于使用习惯的考虑，编写代码的智能总会提示出现一堆你不想使用的方法（对不起，我有强迫症），IQueryable 自身提供了一堆没法实现的方法，还有外部入侵的扩展方法，严重影响编码体验。如下图：</p>
<p><img src="https://user-images.githubusercontent.com/16286519/57295126-5dd7bd00-70fc-11e9-99c0-d1c46423afa2.png" alt="image" loading="lazy"></p>
<p>v1.4.0+ 版本请使用以下命令安装（老版本不需要安装）：</p>
<blockquote>
<p>dotnet add package FreeSql.Extensions.Linq</p>
</blockquote>
<h2 id="特别说明" tabindex="-1"> 特别说明</h2>
<ul>
<li>
<p>请尽量不要在 ISelect 模式下的使用 Linq 方法：GroupJoin、Select、SelectMany、Join、DefaultIfEmpty；</p>
</li>
<li>
<p>如果一定要在 ISelect 中使用 .Select() 方法，请务必在 .ToList() 之前调用它；</p>
</li>
</ul>
<h2 id="iqueryable" tabindex="-1"> IQueryable</h2>
<p>FreeSql 提供强大的数据查询对象 ISelect。</p>
<p>FreeSql.Extensions.Linq v1.4.0+ 实现了 IQueryable 查询对象常用功能，以便在各框架中交互使用。</p>
<div><pre><code><span>//将 ISelect 转为 IQueryable</span>
<span>IQueryable<span>&lt;</span>Student<span>></span></span> queryable <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsQueryable</span><span>(</span><span>)</span><span>;</span>

<span>//Linq 方法查询</span>
<span><span>var</span></span> t1 <span>=</span> queryable<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>id <span>==</span> <span>1</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span><span>;</span>

<span>//将 IQueryable 还原为 ISelect</span>
<span>ISelect<span>&lt;</span>Studeng<span>></span></span> <span>select</span> <span>=</span> queryable<span>.</span><span>RestoreToSelect</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>注意：IQueryable 的实现目前不支持 GroupBy，可以考虑使用 RestoreSelect 方法转回 ISelect 进行查询</p>
<h2 id="where" tabindex="-1"> Where</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>select</span> a
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="select-指定字段" tabindex="-1"> Select(指定字段)</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="casewhen" tabindex="-1"> CaseWhen</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>select</span> <span>new</span> <span>{</span>
        a<span>.</span>id<span>,</span>
        a<span>.</span>name<span>,</span>
        testsub <span>=</span> <span>new</span> <span>{</span>
            time <span>=</span> a<span>.</span>age <span>></span> <span>10</span> <span>?</span> <span>"大于"</span> <span>:</span> <span>"小于或等于"</span>
        <span>}</span>
    <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="join" tabindex="-1"> Join</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>join</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span> <span>on</span> a<span>.</span>id equals b<span>.</span>StudentId
    <span>select</span> a
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> t2 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>join</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span> <span>on</span> a<span>.</span>id equals b<span>.</span>StudentId
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id<span>,</span> bid <span>=</span> b<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> t3 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>join</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span> <span>on</span> a<span>.</span>id equals b<span>.</span>StudentId
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id<span>,</span> bid <span>=</span> b<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="leftjoin" tabindex="-1"> LeftJoin</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>join</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span> <span>on</span> a<span>.</span>id equals b<span>.</span>StudentId <span>into</span> temp
    <span>from</span> tc <span>in</span> temp<span>.</span><span>DefaultIfEmpty</span><span>(</span><span>)</span>
    <span>select</span> a
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> t2 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>join</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span> <span>on</span> a<span>.</span>id equals b<span>.</span>StudentId <span>into</span> temp
    <span>from</span> tc <span>in</span> temp<span>.</span><span>DefaultIfEmpty</span><span>(</span><span>)</span>
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id<span>,</span> bid <span>=</span> tc<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> t3 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>join</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span> <span>on</span> a<span>.</span>id equals b<span>.</span>StudentId <span>into</span> temp
    <span>from</span> tc <span>in</span> temp<span>.</span><span>DefaultIfEmpty</span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id<span>,</span> bid <span>=</span> tc<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="from-多表查询" tabindex="-1"> From(多表查询)</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>from</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> b<span>.</span>StudentId
    <span>select</span> a
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> t2 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>from</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> b<span>.</span>StudentId
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id<span>,</span> bid <span>=</span> b<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

<span><span>var</span></span> t3 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>from</span> b <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>School<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> b<span>.</span>StudentId
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>select</span> <span>new</span> <span>{</span> a<span>.</span>id<span>,</span> bid <span>=</span> b<span>.</span>id <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="groupby-分组" tabindex="-1"> GroupBy(分组)</h2>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> <span>(</span>
    <span>from</span> a <span>in</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Student<span>></span></span></span><span>(</span><span>)</span>
    <span>where</span> <span>a</span><span>.</span>id <span>==</span> item<span>.</span>id
    <span>group</span> a <span>by</span> <span>new</span> <span>{</span>a<span>.</span>id<span>,</span> a<span>.</span>name <span>}</span> <span>into</span> g
    <span>select</span> <span>new</span> <span>{</span>
        g<span>.</span>Key<span>.</span>id<span>,</span> g<span>.</span>Key<span>.</span>name<span>,</span>
        cou <span>=</span> g<span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>
        avg <span>=</span> g<span>.</span><span>Avg</span><span>(</span>g<span>.</span>Value<span>.</span>age<span>)</span><span>,</span>
        sum <span>=</span> g<span>.</span><span>Sum</span><span>(</span>g<span>.</span>Value<span>.</span>age<span>)</span><span>,</span>
        max <span>=</span> g<span>.</span><span>Max</span><span>(</span>g<span>.</span>Value<span>.</span>age<span>)</span><span>,</span>
        min <span>=</span> g<span>.</span><span>Min</span><span>(</span>g<span>.</span>Value<span>.</span>age<span>)</span>
    <span>}</span>
<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">你不知道的功能 ✨</title>
    <id>https://freesql.net/guide/more.html</id>
    <link href="https://freesql.net/guide/more.html"/>
    <updated>2022-08-30T22:49:37.000Z</updated>
    <content type="html"><![CDATA[<h1 id="你不知道的功能-✨" tabindex="-1"> 你不知道的功能 ✨</h1>
<h2 id="_1、备注-迁移到数据库" tabindex="-1"> 1、备注 -&gt; 迁移到数据库</h2>
<p>FreeSql CodeFirst 支持将 c# 代码内的注释，迁移至数据库的备注。先决条件：</p>
<p>1、实体类所在程序集，需要开启 xml 文档功能；</p>
<p>2、xml 文件必须与程序集同目录，且文件名：xxx.dll -&gt; xxx.xml；</p>
<blockquote>
<p>v1.5.0+ 版本增加了对 Description 特性的解析，优先级低于 c# 代码注释；</p>
</blockquote>
<hr>
<h2 id="_2、noneparameter" tabindex="-1"> 2、NoneParameter</h2>
<p>这个方法可以设置不使用 参数化 执行 SQL 命令，方便开发调试。</p>
<div><pre><code><span>INSERT</span> <span>INTO</span> <span><span>`</span>tb_topic<span>`</span></span><span>(</span><span><span>`</span>Title<span>`</span></span><span>)</span> <span>VALUES</span><span>(</span>?Title0<span>)</span>

<span>INSERT</span> <span>INTO</span> <span><span>`</span>tb_topic<span>`</span></span><span>(</span><span><span>`</span>Title<span>`</span></span><span>)</span> <span>VALUES</span><span>(</span><span>'Title_1'</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>在 new FreeSqlBuilder().UseNoneParameter(true) 可以全局设置。</p>
<p>在 单次 IInsert、IUpdate 上使用 NoneParameter() 设置单次生效。</p>
<hr>
<h2 id="_3、添加或修改" tabindex="-1"> 3、添加或修改</h2>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>InsertOrUpdate</span><span>(</span>实体<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><blockquote>
<p>更多内容可参阅：<a href="/guide/insert-or-update.html">添加或修改</a></p>
</blockquote>
<hr>
<h2 id="_4、弱类型-curd" tabindex="-1"> 4、弱类型 CURD</h2>
<div><pre><code>fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span>
  <span>.</span><span>AppendData</span><span>(</span>data<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>data<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> <span>(</span>a <span>as</span> <span>BaseEntity</span><span>)</span><span>.</span>Id <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

<span>//或者仓储</span>
<span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span><span>object</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>AsType</span><span>(</span>实体类型<span>)</span><span>;</span>

repo<span>.</span><span>Insert</span><span>(</span><span>..</span><span>)</span><span>;</span>
repo<span>.</span><span>Update</span><span>(</span><span>..</span><span>)</span><span>;</span>
repo<span>.</span><span>Delete</span><span>(</span><span>..</span><span>)</span><span>;</span>
repo<span>.</span><span>InsertOrUpdate</span><span>(</span><span>..</span><span>)</span><span>;</span>

<span>//或者字典</span>
<span><span>var</span></span> dic <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"id"</span><span>,</span> <span>1</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"name"</span><span>,</span> <span>"xxxx"</span><span>)</span><span>;</span>

fsql<span>.</span><span>InsertDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>UpdateDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>WherePrimary</span><span>(</span><span>"id"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>DeleteDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>InsertOrUpdateDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>WherePrimary</span><span>(</span><span>"id"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="_5、withsql" tabindex="-1"> 5、WithSql</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithSql</span><span>(</span><span>"select * from Topic where clicks > @val"</span><span>,</span> <span>new</span> <span>{</span> val <span>=</span> <span>10</span> <span>}</span><span>)</span>
  <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime` </span>
<span>//FROM (select * from Topic where clicks > @val) a </span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li><a href="/guide/withsql.html">WithSql</a>使用多次为 UNION ALL 查询</li>
</ul>
<blockquote>
<p>v3.2.666 <a href="/guide/unionall.html">UnionAll 联合查询</a>、<a href="/guide/withtempquery.html">WithTempQuery + FromQuery 嵌套查询</a></p>
</blockquote>
<blockquote>
<p>v3.2.666 WithMemory 使用内存数据进行查询</p>
</blockquote>
<blockquote>
<p>假设跨数据库服务器，或者数据表被缓存过，WithMemory 便可以实现数据表与内存关联查询。</p>
</blockquote>
<div><pre><code><span><span>var</span></span> list <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithMemory</span><span>(</span>list<span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime` </span>
<span>//FROM (</span>
<span>//  SELECT ...</span>
<span>//  UNION ALL</span>
<span>//  SELECT ...</span>
<span>//) a </span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="_6、你不知道的-指定字段返回" tabindex="-1"> 6、你不知道的，指定字段返回</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>t1<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
    a<span>.</span>Id<span>,</span>
    a<span>.</span>Title<span>,</span>
    cstitle <span>=</span> <span>"substr(a.title, 0, 2)"</span><span>,</span> <span>//将 substr(a.title, 0, 2) 作为查询字段</span>
    csnow <span>=</span> Convert<span>.</span><span>ToDateTime</span><span>(</span><span>"now()"</span><span>)</span><span>,</span> <span>//将 now() 作为查询字段</span>
    <span>//奇思妙想：怎么查询开窗函数的结果</span>

    count <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>
    max <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Max</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
    min <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Min</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
    name <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>First</span><span>(</span>b <span>=></span> b<span>.</span>name<span>)</span><span>,</span>

    <span>//导航属性</span>
    t1Type <span>=</span> a<span>.</span>Type<span>,</span>

    <span>//子查询</span>
    childs <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>t1_id <span>==</span> a<span>.</span>id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span>
  <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="_7、dto-映射查询" tabindex="-1"> 7、Dto 映射查询</h2>
<p>映射查询支持单表/多表，在查询数据之前映射（不是先查询所有字段再到内存映射）</p>
<p>规则：查找属性名，会循环内部对象 _tables（多表会增长），以 主表优先查，直到查到相同的字段。</p>
<p>如：</p>
<p>A, B, C 都有 id，Dto { id, a1, a2, b1, b2 }，<a href="http://A.id" target="_blank" rel="noopener noreferrer">A.id</a> 被映射。也可以指定 id = <a href="http://C.id" target="_blank" rel="noopener noreferrer">C.id</a> 映射。</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span><span>ToList</span><span><span>&lt;</span>Dto<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span>//情况1：Dto 与 Song 属性名相同的字段被查询，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span> <span>{</span> xxx <span>=</span> a<span>.</span>ext <span>}</span><span>)</span> 
<span>//情况2：Dto 与 Song 属性名相同的字段被查询，纠正映射 ext，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span> <span>{</span> id <span>=</span> a<span>.</span>id <span>}</span><span>)</span> 
<span>//情况3：Lambda 与 Song 类型一样，只查询指定字段 id，返回 List&lt;Song></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> id <span>=</span> a<span>.</span>id <span>}</span><span>)</span> 
<span>//情况4：Lambda 匿名类型，只查询指定字段 id，返回 List&lt;匿名对象></span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>请仔细处理区别，请仔细处理区别，请仔细处理区别</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span><span>(</span>a<span>.</span>id<span>)</span><span>)</span>
<span>//情况5：只查询 id，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span><span>(</span>a<span>.</span>id<span>)</span> <span>{</span> xxx <span>=</span> a<span>.</span>ext <span>}</span><span>)</span>
<span>//情况6：查询 id, ext，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span><span>(</span>a<span>.</span>id<span>)</span><span>)</span>
<span>//情况7：查询 id，返回 List&lt;Song></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span><span>(</span>a<span>.</span>id<span>)</span> <span>{</span> xxx <span>=</span> a<span>.</span>ext <span>}</span><span>)</span>
<span>//情况8：查询 id, ext，返回 List&lt;Song></span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>GroupBy 所有方法不使用 DTO 映射规则</p>
</blockquote>
<p>DTO 查询只映射默认字段（普通属性），映射对象请使用：</p>
<blockquote>
<p>导航对象：ToList(a =&gt; new Dto { Catalog = a.Catalog })</p>
</blockquote>
<blockquote>
<p>多表对象：ToList((a, b) =&gt; new Dto { Catalog = b })</p>
</blockquote>
<hr>
<h2 id="_8、父子关系表" tabindex="-1"> 8、父子关系表</h2>
<div><pre><code><span>List<span>&lt;</span>Category<span>></span></span> t2 <span>=</span> fsql<span>.</span>Select<span>&lt;</span>Category<span>></span><span>.</span><span>ToTreeList</span><span>(</span><span>)</span><span>;</span>
<span>List<span>&lt;</span>Category<span>></span></span> t3 <span>=</span> fsql<span>.</span>Select<span>&lt;</span>Category<span>></span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>=</span> <span>"家电"</span><span>)</span><span>.</span><span>AsTreeCte</span><span>(</span><span>)</span><span>.</span><span>ToTreeList</span><span>(</span><span>)</span><span>;</span>
<span>//v1.6.0 AsTreeCte() 递归CTE查询 家电 下的所有子分类</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>ToTreeList 查询数据后加工为树型，注意：实体需要配置父子导航属性</p>
<div><pre><code><span>//返回 AsTreeCte() 树状层级信息</span>
t4 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span>
  <span>.</span><span>AsTreeCte</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>+</span> <span>"["</span> <span>+</span> a<span>.</span>Code <span>+</span> <span>"]"</span><span>)</span>
  <span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Code<span>)</span>
  <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> item <span>=</span> a<span>,</span> level <span>=</span> Convert<span>.</span><span>ToInt32</span><span>(</span><span>"a.cte_level"</span><span>)</span><span>,</span> path <span>=</span> <span>"a.cte_path"</span> <span>}</span><span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>4</span><span>,</span> t4<span>.</span>Count<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"100000"</span><span>,</span> t4<span>[</span><span>0</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110000"</span><span>,</span> t4<span>[</span><span>1</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110100"</span><span>,</span> t4<span>[</span><span>2</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110101"</span><span>,</span> t4<span>[</span><span>3</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000]"</span><span>,</span> t4<span>[</span><span>0</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000] -> 北京[110000]"</span><span>,</span> t4<span>[</span><span>1</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000] -> 北京[110000] -> 北京市[110100]"</span><span>,</span> t4<span>[</span><span>2</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000] -> 北京[110000] -> 东城区[110101]"</span><span>,</span> t4<span>[</span><span>3</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_9、级联加载" tabindex="-1"> 9、级联加载</h2>
<p>有设置导航属性关系的（支持一对多、多对多）：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Goods<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>未设置导航属性关系的，临时指定关系（只支持一对多）：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Goods<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Comment<span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>TagId <span>==</span> a<span>.</span>Id<span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>只查询每项子集合的前几条数据，避免像 EfCore 加载所有数据导致 IO 性能低下（比如某商品下有 2000 条评论）：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Goods<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Comment<span>.</span><span>Take</span><span>(</span><span>10</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>在 Dto 上做映射 IncludeMany：</p>
<div><pre><code><span>//定义临时类，也可以是 Dto 类</span>
<span>class</span> <span>Dto</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> TypeId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>List<span>&lt;</span>Goods <span>></span></span> GoodsList <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>//查询 Goods 商品表，分类1、分类2、分类3 各10条数据</span>
<span><span>var</span></span> dto <span>=</span> <span>new</span> <span>[</span><span>]</span> <span>{</span> <span>1</span><span>,</span><span>2</span><span>,</span><span>3</span> <span>}</span><span>.</span><span>Select</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span> <span>{</span> TypeId <span>=</span> a <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
dto<span>.</span><span>IncludeMany</span><span>(</span>d <span>=></span> d<span>.</span>GoodsList<span>.</span><span>Take</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Where</span><span>(</span>gd <span>=></span> gd<span>.</span>TypeId <span>==</span> d<span>.</span>TypeId<span>)</span><span>)</span><span>;</span>

<span>//执行后，dto 每个元素.GoodsList 将只有 10条记录</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>查询子集合表的部分字段，避免子集合字段过多的问题：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Goods<span>.</span><span>Select</span><span>(</span>b <span>=></span> <span>new</span> <span>Goods</span> <span>{</span> Id <span>=</span> b<span>.</span>Id<span>,</span> Title <span>=</span> b<span>.</span>Title <span>}</span><span>)</span><span>)</span><span>;</span>
<span>//只查询 goods 表 id, title 字段，再作填充</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><hr>
<h2 id="_10、wherecascade" tabindex="-1"> 10、WhereCascade</h2>
<p>多表查询时，像 isdeleted 每个表都给条件，挺麻烦的。WhereCascade 使用后生成 sql 时，所有表都附上这个条件。</p>
<p>如：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>t1<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span><span>LeftJoin</span><span><span>&lt;</span>t2<span>></span></span></span><span>(</span><span>..</span><span>.</span><span>)</span>
    <span>.</span><span>WhereCascade</span><span>(</span>x <span>=></span> x<span>.</span>IsDeleted <span>==</span> <span>false</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>得到的 SQL：</p>
<div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span>
<span>FROM</span> t1
<span>LEFT</span> <span>JOIN</span> t2 <span>on</span> <span>.</span><span>.</span><span>.</span> <span>AND</span> <span>(</span>t2<span>.</span>IsDeleted <span>=</span> <span>0</span><span>)</span>
<span>WHERE</span> t1<span>.</span>IsDeleted <span>=</span> <span>0</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>实体可附加表达式时才生效，支持子表查询。单次查询使用的表数目越多收益越大。</p>
<hr>
<h2 id="_11、wheredynamicfilter" tabindex="-1"> 11、WhereDynamicFilter</h2>
<p>ISelect.WhereDynamicFilter 方法实现动态过滤条件（与前端交互），支持的操作符：</p>
<ul>
<li>Contains/StartsWith/EndsWith/NotContains/NotStartsWith/NotEndsWith：包含/不包含，like '%xx%'，或者 like 'xx%'，或者 like '%xx'</li>
<li>Equal/NotEqual：等于/不等于</li>
<li>GreaterThan/GreaterThanOrEqual：大于/大于等于</li>
<li>LessThan/LessThanOrEqual：小于/小于等于</li>
<li>Range：范围查询</li>
<li>DateRange：日期范围，有特殊处理 value[1] + 1</li>
<li>Any/NotAny：是否符合 value 中任何一项（直白的说是 SQL IN）</li>
<li>Custom：自定义解析</li>
</ul>
<div><pre><code><span>DynamicFilterInfo</span> dyfilter <span>=</span> JsonConvert<span>.</span><span><span>DeserializeObject</span><span><span>&lt;</span>DynamicFilterInfo<span>></span></span></span><span>(</span><span>@"
{
    ""Logic"": ""And"",
    ""Filters"":
    [
        { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 1 },
        {
            ""Logic"": ""Or"",
            ""Filters"":
            [
                { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 2 },
                { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 3 }
            ]
        }
    ]
}"</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>WhereDynamicFilter</span><span>(</span>dyfilter<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//WHERE id = 1 AND (id = 2 OR id = 3)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="_12、iselect-todelete、iselect-toupdate" tabindex="-1"> 12、ISelect.ToDelete、ISelect.ToUpdate</h2>
<p>默认 IDelete 不支持导航对象，多表关联等。ISelect.ToDelete 可将查询转为删除对象，以便支持导航对象或其他查询功能删除数据，如下：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T1<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Options<span>.</span>xxx <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToDelete</span><span>(</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>注意：此方法不是将数据查询到内存循环删除，上面的代码产生如下 SQL 执行：</p>
<div><pre><code><span>DELETE</span> <span>FROM</span> <span><span>`</span>T1<span>`</span></span> <span>WHERE</span> id <span>in</span> <span>(</span><span>select</span> a<span>.</span>id <span>from</span> T1 a <span>left</span> <span>join</span> Options b <span>on</span> b<span>.</span>t1id <span>=</span> a<span>.</span>id <span>where</span> b<span>.</span>xxx <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>复杂删除使用该方案的好处：</p>
<ul>
<li>删除前可预览测试数据，防止错误删除操作；</li>
<li>支持更加复杂的删除操作（IDelete 默认只支持简单的操作），甚至在 ISelect 上使用 Limit(10) 将只删除附合条件的前 10 条记录；</li>
</ul>
<blockquote>
<p>ISelect.ToUpdate 操作类似</p>
</blockquote>
<hr>
<h2 id="_13、保存多对多数据-savemany" tabindex="-1"> 13、保存多对多数据 SaveMany</h2>
<p>之前：</p>
<p>FreeSql.DbContext 和 仓储实现，已经实现了联级保存功能，可实现保存对象的时候，将其【OneToMany】、【ManyToMany】导航属性集合也一并保存。</p>
<p>全局关闭：</p>
<div><pre><code>fsql<span>.</span><span>SetDbContextOptions</span><span>(</span>opt <span>=></span> opt<span>.</span>EnableCascadeSave <span>=</span> <span>false</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>局部关闭：</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>false</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h3 id="导航属性" tabindex="-1"> 导航属性</h3>
<p>保存实体的指定【一对多】、【多对多】导航属性，SaveMany 方法实现在 BaseRepository、DbContext。</p>
<p>解决问题：当实体类导航数据过于复杂的时候，选择关闭联级保存的功能是明智之选，但是此时【一对多】、【多对多】数据保存功能写起来非常繁琐麻烦（与现有数据对比后保存）。</p>
<div><pre><code><span><span>var</span></span> song <span>=</span> <span>new</span> <span>Song</span> <span>{</span> Id <span>=</span> <span>1</span> <span>}</span><span>;</span>
song<span>.</span>Tags <span>=</span> <span>new</span> <span>List<span>&lt;</span>Tag<span>></span></span><span>(</span><span>)</span><span>;</span>
song<span>.</span>Tags<span>.</span><span>Add</span><span>(</span><span>new</span> Tag <span>..</span><span>.</span><span>)</span><span>;</span>
song<span>.</span>Tags<span>.</span><span>Add</span><span>(</span><span>new</span> Tag <span>..</span><span>.</span><span>)</span><span>;</span>
song<span>.</span>Tags<span>.</span><span>Add</span><span>(</span><span>new</span> Tag <span>..</span><span>.</span><span>)</span><span>;</span>
repo<span>.</span><span>SaveMany</span><span>(</span>song<span>,</span> <span>"Tags"</span><span>)</span><span>;</span>
<span>//轻松保存 song 与 tag 表的关联</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>SaveMany【一对多】的机制是完整对比保存。</p>
<p>SaveMany【多对多】的机制规则与联级保存的一样，如下：</p>
<p>我们对中间表的保存是完整对比操作，对外部实体的操作只作新增（注意不会更新）</p>
<ul>
<li>属性集合为空时，删除他们的所有关联数据（中间表）</li>
<li>属性集合不为空时，与数据库存在的关联数据（中间表）完全对比，计算出应该删除和添加的记录</li>
</ul>
<hr>
<h2 id="_14、自定义表达式函数" tabindex="-1"> 14、自定义表达式函数</h2>
<div><pre><code><span>[</span><span><span>ExpressionCall</span></span><span>]</span>
<span>public</span> <span>static</span> <span>class</span> <span>DbFunc</span> <span>{</span>
  <span>//必要定义 static + ThreadLocal</span>
  <span>static</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span> context <span>=</span> <span>new</span> <span>ThreadLocal<span>&lt;</span>ExpressionCallContext<span>></span></span><span>(</span><span>)</span><span>;</span>

  <span>public</span> <span>static</span> <span>DateTime</span> <span>FormatDateTime</span><span>(</span><span>this</span> <span>DateTime</span> that<span>,</span> <span><span>string</span></span> arg1<span>)</span>
  <span>{</span>
    <span><span>var</span></span> up <span>=</span> context<span>.</span>Value<span>;</span>
    <span>if</span> <span>(</span>up<span>.</span>DataType <span>==</span> FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>)</span> <span>//重写内容</span>
      up<span>.</span>Result <span>=</span> <span><span>$"date_format(</span><span><span>{</span><span>up<span>.</span>ParsedContent<span>[</span><span>"that"</span><span>]</span></span><span>}</span></span><span>, </span><span><span>{</span><span>up<span>.</span>ParsedContent<span>[</span><span>"arg1"</span><span>]</span></span><span>}</span></span><span>)"</span></span><span>;</span>
    <span>return</span> that<span>;</span>
  <span>}</span>
<span>}</span>

<span><span>var</span></span> sql1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>SysModule<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>.</span><span>FormatDateTime</span><span>(</span><span>"yyyy-MM-dd"</span><span>)</span><span>)</span><span>;</span>
<span>//SELECT date_format(a."CreateTime", 'yyyy-MM-dd') as1</span>
<span>//FROM "SysModule" a</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>[ExpressionCall] 特性可在静态扩展类上标记，也可以在单个静态方法上标记；</p>
<table>
<thead>
<tr>
<th>ExpressionCallContext 属性</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DataType</td>
<td>FreeSql.DataType</td>
<td>用于实现不同数据库的适配判断条件</td>
</tr>
<tr>
<td>ParsedContent</td>
<td>Dictionary&lt;string, string&gt;</td>
<td>函数的各参数解析结果</td>
</tr>
<tr>
<td>DbParameter</td>
<td>DbParameter</td>
<td>that 被参数化的对象（有可能为 null)</td>
</tr>
<tr>
<td>UserParameters</td>
<td>List&lt;DbParameter&gt;</td>
<td>可附加参数化对象</td>
</tr>
<tr>
<td>Result</td>
<td>string</td>
<td>返回表达式函数表示的 SQL 字符串</td>
</tr>
</tbody>
</table>
<blockquote>
<p>当扩展方法返回值为 string 时，其返回值也可以当作 context.Value.Result 设置</p>
</blockquote>
<blockquote>
<p>当不想解析指定参数时，使用特性 [RawValue] 标记</p>
</blockquote>
<hr>
<h2 id="_15、自定义实体特性、与其他-orm-共用特性" tabindex="-1"> 15、自定义实体特性、与其他 ORM 共用特性</h2>
<p>本功能可实现与其他 ORM 使用一套 Attribute，避免维护两份实体特性的烦恼：</p>
<blockquote>
<p>v1.4.0+ 已自动识别 EFCore 实体特性 Key/Required/NotMapped/MaxLength/StringLength/DatabaseGenerated/Table/Column</p>
</blockquote>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ConfigEntity <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span><span>var</span></span> attr <span>=</span> e<span>.</span>EntityType<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>MyTableAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span> <span>as</span> <span>MyTableAttribute</span><span>;</span>
  <span>if</span> <span>(</span>attr <span>!=</span> <span>null</span><span>)</span>
    e<span>.</span>ModifyResult<span>.</span>Name <span>=</span> attr<span>.</span>Name<span>;</span> <span>//表名</span>
<span>}</span><span>;</span>
fsql<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span><span>var</span></span> attr <span>=</span> e<span>.</span>Property<span>.</span><span>GetCustomAttributes</span><span>(</span><span>typeof</span><span>(</span><span>MyColumnAttribute</span><span>)</span><span>,</span> <span>false</span><span>)</span><span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span> <span>as</span> <span>MyColumnAttribute</span><span>;</span>
  <span>if</span> <span>(</span>attr <span>!=</span> <span>null</span><span>)</span>
    e<span>.</span>ModifyResult<span>.</span>Name <span>=</span> attr<span>.</span>Name<span>;</span> <span>//字段名</span>
<span>}</span><span>;</span>

<span>[</span><span><span>MyTable</span><span><span>(</span><span>"xxx"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>YourEntity</span> <span>{</span>
  <span>[</span><span><span>MyColumn</span><span><span>(</span><span>"id"</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span><span>int</span></span> pkid <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>class</span> <span>MyTableAttribute</span> <span>:</span> <span><span>Attribute</span></span> <span>{</span>
  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>}</span>
  <span>public</span> <span>MyTableAttribute</span><span>(</span><span><span>string</span></span> name<span>)</span>
  <span>{</span>
    <span>this</span><span>.</span>Name <span>=</span> name<span>;</span>
  <span>}</span>
<span>}</span>
<span>class</span> <span>MyColumnAttribute</span> <span>:</span> <span><span>Attribute</span></span> <span>{</span>
  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>}</span>
  <span>public</span> <span>MyColumnAttribute</span><span>(</span><span><span>string</span></span> name<span>)</span>
  <span>{</span>
    <span>this</span><span>.</span>Name <span>=</span> name<span>;</span>
  <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h2 id="_16、审计-curd" tabindex="-1"> 16、审计 CURD</h2>
<p>如果因为某个 sql 骚操作耗时很高，没有一个相关的审计功能，排查起来可以说无从下手。</p>
<p>FreeSql 支持简单的类似功能：</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>CurdAfter <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
 <span>if</span> <span>(</span>e<span>.</span>ElapsedMilliseconds <span>></span> <span>200</span><span>)</span> <span>{</span>
  <span>//记录日志</span>
  <span>//发送短信给负责人</span>
 <span>}</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>只需要一个事件，就可以对全局起到作用。</p>
<p>还有一个 CurdBefore 在执行 sql 之前触发，常用于记录日志或开发调试。</p>
<hr>
<h2 id="_17、审计属性值" tabindex="-1"> 17、审计属性值</h2>
<p>实现插入/更新时统一处理某些值，比如某属性的雪花算法值、创建时间值、甚至是业务值。</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>AuditValue <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span>if</span> <span>(</span>e<span>.</span>Column<span>.</span>CsType <span>==</span> <span>typeof</span><span>(</span><span><span>long</span></span><span>)</span> <span>&amp;&amp;</span> 
    e<span>.</span>Property<span>.</span><span><span>GetCustomAttribute</span><span><span>&lt;</span>SnowflakeAttribute<span>></span></span></span><span>(</span><span>false</span><span>)</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> 
    e<span>.</span>Value<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>==</span> <span>"0"</span><span>)</span>
    e<span>.</span>Value <span>=</span> <span>new</span> <span>Snowflake</span><span>(</span><span>)</span><span>.</span><span>GetId</span><span>(</span><span>)</span><span>;</span>
<span>}</span><span>;</span>

<span>class</span> <span>Order</span> <span>{</span>
  <span>[</span><span><span>Snowflake</span></span><span>]</span>
  <span>public</span> <span><span>long</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>//...</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>当属性的类型是 long，并且标记了 [Snowflake]，并且当前值是 0，那么在插入/更新时它的值将设置为雪花id值。</p>
<blockquote>
<p>说明：SnowflakeAttribute 是使用者您来定义，new Snowflake().GetId() 也是由使用者您来实现</p>
</blockquote>
<p>如果命名规范，可以在 aop 里判断，if (<a href="http://e.Property.Name" target="_blank" rel="noopener noreferrer">e.Property.Name</a> == &quot;createtime&quot;) e.Value = DateTime.Now;</p>
<blockquote>
<p>v3.2.666 可设置 e.ObjectAuditBreak = true 中断对象审计，变相实现每个对象只触发一次 AuditValue 事件</p>
</blockquote>
<h2 id="_18、ado-net-扩展方法" tabindex="-1"> 18、Ado .Net 扩展方法</h2>
<p>提供了类似 Dapper 的使用方法，FreeSql 增加了 IDbConnection/IDbTransaction 对象的扩展方法 Select/Insert/Update/Delete 实现 CRUD。</p>
<div><pre><code><span>using</span> <span>FreeSql</span><span>;</span>

<span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span><span>..</span><span>.</span><span>)</span><span>)</span>
<span>{</span>
  <span>IFreeSql</span> fsql <span>=</span> conn<span>.</span><span>GetIFreeSql</span><span>(</span><span>)</span><span>;</span>
  fsql<span>.</span>CodeFirst<span>.</span>IsNoneCommandParameter <span>=</span> <span>true</span><span>;</span>
  fsql<span>.</span>CodeFirst<span>.</span>IsSyncStructureToUpper <span>=</span> <span>true</span><span>;</span>
  fsql<span>.</span>Aop<span>.</span>CommandBefore <span>+=</span> <span>(</span>_<span>,</span> e<span>)</span> <span>=></span> Trace<span>.</span><span>WriteLine</span><span>(</span>e<span>.</span>Command<span>.</span>CommandText<span>)</span><span>;</span>
  <span>//以上整个程序只需要设置一次</span>

  conn<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>..</span><span>.</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>

  conn<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>T</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
  conn<span>.</span><span>Update</span><span>(</span><span>)</span><span>.</span><span>SetSource</span><span>(</span><span>new</span> <span>T</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
  conn<span>.</span><span>InsertOrUpdate</span><span>(</span><span>)</span><span>.</span><span>SetSource</span><span>(</span><span>new</span> <span>T</span> <span>{</span><span>}</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>

  conn<span>.</span><span><span>Delete</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>..</span><span>.</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>每个 SqlConnection GetFreeSql() 返回的 IFreeSql 实例相同；</li>
<li>可以对 fsql 设置 Aop 事件，比如监视 SQL；</li>
<li>IFreeSql 自身的成员 IDbFirst、Transaction 不可用；</li>
</ul>
<p>利用本功能可以快速将 FreeSql 使用到项目中，只需要处理好实体类的特性。</p>
<p>提示：FreeSql 兼容 EFCore 99% 的实体特性</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">多租户</title>
    <id>https://freesql.net/guide/multi-tenancy.html</id>
    <link href="https://freesql.net/guide/multi-tenancy.html"/>
    <updated>2022-08-20T05:04:09.000Z</updated>
    <content type="html"><![CDATA[<h1 id="多租户" tabindex="-1"> 多租户</h1>
<h3 id="什么是多租户" tabindex="-1"> 什么是多租户</h3>
<p>维基百科：“软件多租户是指一种软件架构，在这种软件架构中，软件的一个实例运行在服务器上并且为多个租户服务”。一个租户是一组共享该软件实例特定权限的用户。有了多租户架构，软件应用被设计成为每个租户提供一个 专用的实例包括该实例的数据的共享，还可以共享配置，用户管理，租户自己的功能和非功能属性。多租户和多实例架构相比，多租户分离了代表不同的租户操作的多个实例。</p>
<p>多租户用于创建 Saas（Software as-a service）应用（云处理）。</p>
<h3 id="方案一-按租户字段区分" tabindex="-1"> 方案一：按租户字段区分</h3>
<p>第1步：了解 AsyncLocal&lt;int&gt;</p>
<p>ThreadLocal 可以理解为字典 Dictionary&lt;int, string&gt; Key=线程ID Value=值，跨方法时只需要知道线程ID，就能取得对应的 Value。</p>
<p>我们知道跨异步方法可能造成线程ID变化，ThreadLocal 将不能满足我们使用。</p>
<p>AsyncLocal 是 ThreadLocal 的升级版，解决跨异步方法也能获取到对应的 Value。</p>
<div><pre><code><span>public</span> <span>class</span> <span>TenantManager</span>
<span>{</span>
    <span>// 注意一定是 static 静态化</span>
    <span>static</span> <span>AsyncLocal<span>&lt;</span><span>int</span><span>></span></span> _asyncLocal <span>=</span> <span>new</span> <span>AsyncLocal<span>&lt;</span><span>int</span><span>></span></span><span>(</span><span>)</span><span>;</span>

    <span>public</span> <span>static</span> <span><span>int</span></span> Current
    <span>{</span>
        <span>get</span> <span>=></span> _asyncLocal<span>.</span>Value<span>;</span>
        <span>set</span> <span>=></span> _asyncLocal<span>.</span>Value <span>=</span> <span>value</span><span>;</span>    
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>第2步：FreeSql 全局过滤器，让任何查询/更新/删除，都附带租户条件；</p>
<p>以下代码若当前没有设置租户值，则过滤器不生效，什么意思？</p>
<div><pre><code><span>// 全局过滤器只需要在 IFreeSql 初始化处执行一次</span>
<span>// ITenant 可以是自定义接口，也可以是任何一个包含 TenantId 属性的实体类型，FreeSql 不需要为每个实体类型都设置过滤器（一次即可）</span>
fsql<span>.</span>GlobalFilter<span>.</span><span><span>ApplyIf</span><span><span>&lt;</span>ITenant<span>></span></span></span><span>(</span>
    <span>"TenantFilter"</span><span>,</span> <span>// 过滤器名称</span>
    <span>(</span><span>)</span> <span>=></span> TenantManager<span>.</span>Current <span>></span> <span>0</span><span>,</span> <span>// 过滤器生效判断</span>
    a <span>=></span> a<span>.</span>TenantId <span>==</span> TenantManager<span>.</span>Current <span>// 过滤器条件</span>
<span>)</span><span>;</span>

TenantManager<span>.</span>Current <span>=</span> <span>0</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span> <span>// SELECT .. FROM T</span>

TenantManager<span>.</span>Current <span>=</span> <span>1</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span> <span>// SELECT .. FROM T WHERE TenantId = 1</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>第3步：FreeSql Aop.AuditValue 对象审计事件，实现统一拦截插入、更新实体对象；</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>AuditValue <span>+=</span> <span>(</span>_<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>TenantManager<span>.</span>Current <span>></span> <span>0</span> <span>&amp;&amp;</span> e<span>.</span>Property<span>.</span>PropertyType <span>==</span> <span>typeof</span><span>(</span><span><span>int</span></span><span>)</span> <span>&amp;&amp;</span> e<span>.</span>Property<span>.</span>Name <span>==</span> <span>"TenantId"</span><span>)</span>
    <span>{</span>
        e<span>.</span>Value <span>=</span> TenantManager<span>.</span>Current
    <span>}</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>第4步：AspnetCore Startup.cs Configure 中间件处理租户逻辑；</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>)</span>
<span>{</span>
    app<span>.</span><span>Use</span><span>(</span><span>async</span> <span>(</span>context<span>,</span> next<span>)</span> <span>=></span>
    <span>{</span>
        <span>try</span>
        <span>{</span>
            <span>// 使用者通过 aspnetcore 中间件，解析 token 获得 租户ID</span>
            TenantManager<span>.</span>Current <span>=</span> <span>YourGetTenantIdFunction</span><span>(</span><span>)</span><span>;</span>
            <span>await</span> <span>next</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>
        <span>finally</span>
        <span>{</span>
            <span>// 清除租户状态</span>
            TenantManager<span>.</span>Current <span>=</span> <span>0</span><span>;</span>
        <span>}</span>
    <span>}</span><span>)</span><span>;</span>
    app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>
    app<span>.</span><span>UseEndpoints</span><span>(</span>a <span>=></span> a<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="wherecascade" tabindex="-1"> WhereCascade</h3>
<p>多表查询时，像 isdeleted 每个表都给条件，挺麻烦的。WhereCascade 使用后生成 sql 时，所有表都附上这个条件。多表租户条件也可以这样解决。</p>
<p>如：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>t1<span>></span></span></span><span>(</span><span>)</span>
<span>.</span><span><span>LeftJoin</span><span><span>&lt;</span>t2<span>></span></span></span><span>(</span><span>..</span><span>.</span><span>)</span>
<span>.</span><span>WhereCascade</span><span>(</span>x <span>=></span> x<span>.</span>IsDeleted <span>==</span> <span>false</span><span>)</span>
<span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>得到的 SQL：</p>
<div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span>
<span>FROM</span> t1
<span>LEFT</span> <span>JOIN</span> t2 <span>on</span> <span>.</span><span>.</span><span>.</span> <span>AND</span> <span>(</span>t2<span>.</span>IsDeleted <span>=</span> <span>0</span><span>)</span>
<span>WHERE</span> t1<span>.</span>IsDeleted <span>=</span> <span>0</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>实体可附加表达式时才生效，支持子表查询。单次查询使用的表数目越多收益越大。</p>
<p>可应用范围：</p>
<ul>
<li>子查询，一对多、多对多、自定义的子查询；</li>
<li>Join 查询，导航属性、自定义的 Join 查询；</li>
<li>Include/IncludeMany 的子集合查询；</li>
</ul>
<blockquote>
<p>暂时不支持【延时属性】的广播；</p>
</blockquote>
<blockquote>
<p>此功能和【过滤器】不同，用于单次多表查询条件的传播；</p>
</blockquote>
<h3 id="方案二-按租户分表" tabindex="-1"> 方案二：按租户分表</h3>
<p>此方案要求每个租户对应不同的数据表，如 Goods_1、Goods_2、Goods_3 分别对应 租户1、租户2、租户3 的商品表。</p>
<p>这其实就是一般的分表方案，FreeSql 提供了分表场景的几个 API：</p>
<ul>
<li>创建表 fsql.CodeFirst.SyncStructure(typeof(Goods), &quot;Goods_1&quot;)</li>
<li>操作表 CURD</li>
</ul>
<div><pre><code><span><span>var</span></span> goodsRepository <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Goods<span>></span></span></span><span>(</span><span>null</span><span>,</span> old <span>=></span> <span><span>$"</span><span><span>{</span><span>Goods</span><span>}</span></span><span>_</span><span><span>{</span><span>TenantManager<span>.</span>Current</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>上面我们得到一个仓储按租户分表，使用它 CURD 最终会操作 Goods_1 表。</p>
<blockquote>
<p>更多说明参考：<a href="/guide/repository.html">《FreeSql.Repository 仓储》</a>、<a href="/guide/sharding.html">《分表分库》</a>。</p>
</blockquote>
<h3 id="方案三-按租户分库" tabindex="-1"> 方案三：按租户分库</h3>
<ul>
<li>场景1：同数据库实例（未跨服务器），租户间使用不同的数据库名或Schema区分，使用方法与方案二相同；</li>
<li>场景2：跨服务器分库，本段讲解该场景；</li>
</ul>
<p>第1步：FreeSql.Cloud 为 FreeSql 提供跨数据库访问，分布式事务TCC、SAGA解决方案，支持 .NET Core 2.1+, .NET Framework 4.0+.</p>
<p>原本使用 FreeSqlBuilder 创建 IFreeSql，需要使用 FreeSqlCloud 代替，因为 FreeSqlCloud 也实现了 IFreeSql 接口。</p>
<blockquote>
<p>dotnet add package FreeSql.Cloud</p>
</blockquote>
<p>or</p>
<blockquote>
<p>Install-Package FreeSql.Cloud</p>
</blockquote>
<div><pre><code><span>FreeSqlCloud<span>&lt;</span><span>string</span><span>></span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlCloud<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>;</span>

<span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    fsql<span>.</span>DistributeTrace <span>=</span> log <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>log<span>.</span><span>Split</span><span>(</span><span>'\n'</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>Trim</span><span>(</span><span>)</span><span>)</span><span>;</span>
    fsql<span>.</span><span>Register</span><span>(</span><span>"main"</span><span>,</span> <span>(</span><span>)</span> <span>=></span>
    <span>{</span>
        <span><span>var</span></span> db <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>SqlServer<span>,</span> <span>"data source=main.db"</span><span>)</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
        <span>//db.Aop.CommandAfter += ...</span>
        <span>return</span> db<span>;</span>
    <span>}</span><span>)</span><span>;</span>

    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
    services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>
<span>}</span>

<span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>
<span>{</span>
    app<span>.</span><span>Use</span><span>(</span><span>async</span> <span>(</span>context<span>,</span> next<span>)</span> <span>=></span>
    <span>{</span>
        <span>try</span>
        <span>{</span>
            <span>// 使用者通过 aspnetcore 中间件，解析 token，查询  main 库得到租户信息。</span>
            <span>(</span><span><span>string</span></span> tenant<span>,</span> <span><span>string</span></span> connectionString<span>)</span> <span>=</span> <span>YourGetTenantFunction</span><span>(</span><span>)</span><span>;</span>

            <span>// 只会首次注册，如果已经注册过则不生效</span>
            fsql<span>.</span><span>Register</span><span>(</span>tenant<span>,</span> <span>(</span><span>)</span> <span>=></span>
            <span>{</span>
                <span><span>var</span></span> db <span>=</span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>SqlServer<span>,</span> connectionString<span>)</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
                <span>//db.Aop.CommandAfter += ...</span>
                <span>return</span> db<span>;</span>
            <span>}</span><span>)</span><span>;</span>

            <span>// 切换租户</span>
            fsql<span>.</span><span>Change</span><span>(</span>tenant<span>)</span><span>;</span>
            <span>await</span> <span>next</span><span>(</span><span>)</span><span>;</span>
        <span>}</span>
        <span>finally</span>
        <span>{</span>
            <span>// 切换回 main 库</span>
            fsql<span>.</span><span>Change</span><span>(</span><span>"main"</span><span>)</span><span>;</span>
        <span>}</span>
    <span>}</span><span>)</span><span>;</span>
    app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>
    app<span>.</span><span>UseEndpoints</span><span>(</span>a <span>=></span> a<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>第2步：直接使用 IFreeSql 访问租户数据库</p>
<div><pre><code><span>public</span> <span>class</span> <span>HomeController</span> <span>:</span> <span><span>ControllerBase</span></span>
<span>{</span>

    <span>[</span><span><span>HttpGet</span></span><span>]</span>
    <span>public</span> <span><span>object</span></span> <span>Get</span><span>(</span><span>[</span><span><span>FromServices</span></span><span>]</span> <span>IFreeSql</span> fsql<span>)</span>
    <span>{</span>
        <span>// 使用 fsql 操作当前租户对应的数据库</span>
        <span>return</span> <span>""</span><span>;</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>临时访问其他数据库表，使用 FreeSqlCloud 对象 Use(&quot;db3&quot;).Select&lt;T&gt;().ToList()</li>
<li>主库基础表，应该使用 FreeSqlCloud 对象 EntitySteering 设置固定永久定向到 main，而不需要使用 .Use 手工切换</li>
</ul>
<div><pre><code>fsql<span>.</span>EntitySteering <span>=</span> <span>(</span>_<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>EntityType <span>==</span> <span>typeof</span><span>(</span><span>T</span><span>)</span><span>)</span>
    <span>{</span>
        <span>//查询 T 自动定向 db3</span>
        e<span>.</span>DBKey <span>=</span> <span>"db3"</span><span>;</span>
    <span>}</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">导航属性 ✨</title>
    <id>https://freesql.net/guide/navigate-attribute.html</id>
    <link href="https://freesql.net/guide/navigate-attribute.html"/>
    <updated>2022-09-04T05:56:42.000Z</updated>
    <content type="html"><![CDATA[<h1 id="导航属性-✨" tabindex="-1"> 导航属性 ✨</h1>
<p>导航属性是 FreeSql 的特色功能之一，可通过约定配置、或自定义配置对象间的关系。</p>
<p>导航属性有 OneToMany, ManyToOne, ManyToMany, OneToOne, Parent, <a href="https://www.cnblogs.com/FreeSql/p/16351417.html" target="_blank" rel="noopener noreferrer">PgArrayToMany</a> 六种配置关系。</p>
<p>有了导航属性，多表查询会非常方便，lambda 表达式中直接使用导航对象点点点，舒服！！</p>
<ul>
<li>可约定（命名约定），可不约定（需指定 Navigate 特性关联）；</li>
<li>无关联的，查询时可以指明 On 条件，LeftJoin(a =&gt; <a href="http://a.Parent.Id" target="_blank" rel="noopener noreferrer">a.Parent.Id</a> == a.ParentId)；</li>
<li>已关联的，直接使用导航对象就行，On 条件会自动附上；</li>
</ul>
<p><a href="https://www.cnblogs.com/kellynic/p/13575053.html" target="_blank" rel="noopener noreferrer">《导航属性【到底】可以解决什么问题？》</a></p>
<blockquote>
<p>预热说明：导航属性加载，因为要解决死循环引用问题，当引用关系很复杂的时候，有可能导致首次使用导航属性失败，第二次就可以了。解决办法可以程序启动时就预热所有实体类，循环执行 fsql.Select&lt;object&gt;().AsType(实体类);</p>
</blockquote>
<p>OneToMany/ManyToMany 集合导航属性支持的类型：ICollection&lt;T&gt;、List&lt;T&gt;、ObservableCollection&lt;T&gt;</p>
<h1 id="自定义导航关系" tabindex="-1"> 自定义导航关系</h1>
<div><pre><code><span>//导航属性，OneToMany</span>
<span>[</span><span>Navigate</span><span>(</span><span>nameof</span><span>(</span>song_tag<span>.</span>song_id<span>)</span><span>)</span><span>]</span>
<span>public</span> <span>virtual</span> <span>List<span>&lt;</span>song_tag<span>></span></span> Obj_song_tag <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>//在 song_tag 查找 song_id 属性，与 本实体.主键 关联</span>

<span>//导航属性，ManyToOne/OneToOne</span>
<span>[</span><span>Navigate</span><span>(</span><span>nameof</span><span>(</span>song_id<span>)</span><span>)</span><span>]</span>
<span>public</span> <span>virtual</span> <span>Song</span> Obj_song <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>//在 本实体 查找 song_id 属性，与 Song.主键 关联</span>

<span>//导航属性，ManyToMany</span>
<span>[</span><span>Navigate</span><span>(</span>ManyToMany <span>=</span> <span>typeof</span><span>(</span><span>tag_song</span><span>)</span><span>)</span><span>]</span>
<span>public</span> <span>virtual</span> <span>List<span>&lt;</span>tag<span>></span></span> tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<p>也可以使用 FluentApi 在外部设置导航关系：</p>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span><span>ConfigEntity</span><span><span>&lt;</span>实体类<span>></span></span></span><span>(</span>a <span>=></span> a
    <span>.</span><span>Navigate</span><span>(</span>b <span>=></span> b<span>.</span>roles<span>,</span> <span>null</span><span>,</span> <span>typeof</span><span>(</span><span>多对多中间实体类</span><span>)</span><span>)</span>
    <span>.</span><span>Navigate</span><span>(</span>b <span>=></span> b<span>.</span>users<span>,</span> <span>"uid"</span><span>)</span>
<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>优先级，特性 &gt; FluentApi</p>
<blockquote>
<p>注意：</p>
</blockquote>
<p>1、属性设置 Column(IsIgnore = true) 后，导航属性会失效</p>
<p>2、Navigate 设置的字符串是 类属性名，不是表 字段名！！！</p>
<h1 id="检测导航属性" tabindex="-1"> 检测导航属性</h1>
<p>如何检测一个导航属性是否配置生效：</p>
<div><pre><code><span><span>var</span></span> tbref <span>=</span> fsql<span>.</span>CodeFirst
    <span>.</span><span>GetTableByEntity</span><span>(</span><span>typeof</span><span>(</span><span>T</span><span>)</span><span>)</span>
    <span>.</span><span>GetTableRef</span><span>(</span><span>"Children"</span><span>,</span> <span>true</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>GetTableRef(string propertyName, bool isThrow);</p>
<h1 id="约定命名-无须指明-navigate" tabindex="-1"> 约定命名（无须指明 Navigate）</h1>
<h3 id="onetoone-一对一" tabindex="-1"> OneToOne 一对一</h3>
<div><pre><code><span>class</span> <span>User</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>UserExt</span> Ext <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>class</span> <span>UserExt</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>User</span> User <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p><a href="https://github.com/dotnetcore/FreeSql/issues/45" target="_blank" rel="noopener noreferrer">《OneToOne 一对一，怎么添加数据？》</a></p>
<h3 id="manytoone-多对一" tabindex="-1"> ManyToOne 多对一</h3>
<div><pre><code><span>class</span> <span>Group</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>//Id、GroupId、Group_id</span>
<span>}</span>

<span>class</span> <span>User</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>//Id、UserId、User_id</span>

    <span>public</span> <span><span>int</span></span> AGroupId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Group</span> AGroup <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> BGroupId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Group</span> BGroup <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="onetomany-一对多" tabindex="-1"> OneToMany 一对多</h3>
<div><pre><code><span>class</span> <span>Group</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>//Id、GroupId、Group_id</span>

    <span>public</span> <span>ICollection<span>&lt;</span>User<span>></span></span> AUsers <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>ICollection<span>&lt;</span>User<span>></span></span> BUsers <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>class</span> <span>User</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>//Id、UserId、User_id</span>

    <span>public</span> <span><span>int</span></span> AGroupId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Group</span> AGroup <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> BGroupId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Group</span> BGroup <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p><a href="https://github.com/dotnetcore/FreeSql/issues/46" target="_blank" rel="noopener noreferrer">《OneToMany 一对多，怎么添加数据？》</a></p>
<h3 id="parent-父子" tabindex="-1"> Parent 父子</h3>
<div><pre><code><span>class</span> <span>Group</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>//Id、GroupId、Group_id</span>

    <span>public</span> <span><span>int</span></span> ParentId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>//ParentId、Parent_id</span>
    <span>public</span> <span>Group</span> Parent <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>ICollection<span>&lt;</span>Group<span>></span></span> Childs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>父子关系，与一对多其实差不多，添加数据参数上面的连接；</p>
<h3 id="manytomany-多对多" tabindex="-1"> ManyToMany 多对多</h3>
<div><pre><code><span>class</span> <span>Song</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>virtual</span> <span>ICollection<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>Song_tag</span>
<span>{</span>
    <span>public</span> <span><span>int</span></span> Song_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Song</span> Song <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> Tag_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Tag</span> Tag <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>Tag</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span><span>?</span></span> Parent_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Tag</span> Parent <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>virtual</span> <span>ICollection<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>ICollection<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>Song、Tag、Song_tag，这三个实体使用了 OneToMany、ManyToOne、Parent、ManyToMany 4 种关系。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">分页查询</title>
    <id>https://freesql.net/guide/paging.html</id>
    <link href="https://freesql.net/guide/paging.html"/>
    <updated>2022-09-01T06:44:29.000Z</updated>
    <content type="html"><![CDATA[<h1 id="分页查询" tabindex="-1"> 分页查询</h1>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> CategoryId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="每页-20-条数据-查询第-1-页" tabindex="-1"> 每页 20 条数据，查询第 1 页</h2>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>></span> <span>10</span><span>)</span>
    <span>.</span><span>Count</span><span>(</span><span>out</span> <span><span>var</span></span> total<span>)</span> <span>//总记录数量</span>
    <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>20</span><span>)</span>
    <span>.</span><span>Tolist</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>Count(out var total) 是同步方法，原因是 out 不支持异步，如果介意可以单独执行如下：</p>
</blockquote>
<p>提示：数据量大一般不建议查 Count/CountAsync，而应该采用流式分页（上一页、下一页、不返回总数量）</p>
<div><pre><code><span><span>var</span></span> <span>select</span> <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>></span> <span>10</span><span>)</span><span>;</span>
<span><span>var</span></span> total <span>=</span> <span>await</span> <span>select</span><span>.</span><span>CountAsync</span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> list <span>=</span> <span>await</span> <span>select</span><span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>20</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p><code>BasePagingInfo</code>是提供的分页类,<code>PageNumber</code>,<code>PageSize</code>,<code>Count</code>，如下内容，<code>.Page(page)</code>后，<code>page.Count</code>就有统计值了</p>
<div><pre><code><span>public</span> <span>class</span> <span>TopicGetListInput</span><span>:</span> <span><span>BasePagingInfo</span></span>
<span>{</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span><span>var</span></span> list <span>=</span> <span>await</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WhereIf</span><span>(</span><span>!</span><span>string</span><span>.</span><span>IsNullOrEmpty</span><span>(</span>page<span>.</span>Name<span>)</span><span>,</span>r <span>=></span> r<span>.</span>Name<span>.</span><span>Contains</span><span>(</span>page<span>.</span>Name<span>)</span><span>)</span>
    <span>.</span><span>OrderByDescending</span><span>(</span>c <span>=></span> c<span>.</span>CreateTime<span>)</span>
    <span>.</span><span>Page</span><span>(</span>page<span>)</span>
    <span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="优化" tabindex="-1"> 优化</h2>
<p>SqlServer 2012 以前的版本，使用 row_number 分页；</p>
<p>SqlServer 2012+ 版本，使用最新的 fetch next rows 分页；</p>
<h2 id="api" tabindex="-1"> API</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ToList</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 查询，返回 T1 实体所有字段的记录，若存在导航属性则一起查询返回，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>Lambda</td>
<td>执行 SQL 查询，返回指定字段的记录，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>string field</td>
<td>执行 SQL 查询，返回 field 指定字段的记录，并以元组或基础类型(int,string,long)接收，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>【分页】</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Count</td>
<td>long</td>
<td></td>
<td>查询的记录数量</td>
</tr>
<tr>
<td>Count</td>
<td>&lt;this&gt;</td>
<td>out long</td>
<td>查询的记录数量，以参数 out 形式返回</td>
</tr>
<tr>
<td>Skip</td>
<td>&lt;this&gt;</td>
<td>int offset</td>
<td>查询向后偏移行数</td>
</tr>
<tr>
<td>Offset</td>
<td>&lt;this&gt;</td>
<td>int offset</td>
<td>查询向后偏移行数</td>
</tr>
<tr>
<td>Limit</td>
<td>&lt;this&gt;</td>
<td>int limit</td>
<td>查询多少条数据</td>
</tr>
<tr>
<td>Take</td>
<td>&lt;this&gt;</td>
<td>int limit</td>
<td>查询多少条数据</td>
</tr>
<tr>
<td>Page</td>
<td>&lt;this&gt;</td>
<td>int pageIndex, int pageSize</td>
<td>分页</td>
</tr>
<tr>
<td>Page</td>
<td>&lt;this&gt;</td>
<td>BasePagingInfo(int PageNumber,int PageSize,long Count )</td>
<td>分页,并且求Count和</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">性能</title>
    <id>https://freesql.net/guide/performance.html</id>
    <link href="https://freesql.net/guide/performance.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="性能" tabindex="-1"> 性能</h1>
<p>FreeSql 实现了强大功能的同时，性能没有受到影响，项目中使用反射或耗时的操作都经过了缓存处理。读取数据部分采用了 ExpressionTree，使得 FreeSql 解析实体数据的速度与 Dapper 非常接近。</p>
<h1 id="插入测试" tabindex="-1"> 插入测试</h1>
<h3 id="测试结果-52-个字段" tabindex="-1"> 测试结果(52 个字段)</h3>
<table>
<thead>
<tr>
<th></th>
<th>18W</th>
<th>1W</th>
<th>5K</th>
<th>2K</th>
<th>1K</th>
<th>500</th>
<th>100</th>
<th>50</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySql 5.5 ExecuteAffrows</td>
<td>38,481</td>
<td>2,234</td>
<td>1,136</td>
<td>284</td>
<td>239</td>
<td>167</td>
<td>66</td>
<td>30</td>
</tr>
<tr>
<td>MySql 5.5 ExecuteMySqlBulkCopy</td>
<td>28,405</td>
<td>1,142</td>
<td>657</td>
<td>451</td>
<td>435</td>
<td>592</td>
<td>47</td>
<td>22</td>
</tr>
<tr>
<td>SqlServer Express ExecuteAffrows</td>
<td>402,355</td>
<td>24,847</td>
<td>11,465</td>
<td>4,971</td>
<td>2,437</td>
<td>915</td>
<td>138</td>
<td>88</td>
</tr>
<tr>
<td>SqlServer Express ExecuteSqlBulkCopy</td>
<td>21,065</td>
<td>578</td>
<td>326</td>
<td>139</td>
<td>105</td>
<td>79</td>
<td>60</td>
<td>48</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecuteAffrows</td>
<td>46,756</td>
<td>3,294</td>
<td>2,269</td>
<td>1,019</td>
<td>374</td>
<td>209</td>
<td>51</td>
<td>37</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecutePgCopy</td>
<td>10,090</td>
<td>583</td>
<td>337</td>
<td>136</td>
<td>88</td>
<td>61</td>
<td>30</td>
<td>25</td>
</tr>
<tr>
<td>Oracle XE ExecuteAffrows</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>24,528</td>
<td>10,648</td>
<td>571</td>
<td>200</td>
</tr>
<tr>
<td>Sqlite ExecuteAffrows</td>
<td>28,554</td>
<td>1,149</td>
<td>701</td>
<td>327</td>
<td>155</td>
<td>91</td>
<td>44</td>
<td>35</td>
</tr>
</tbody>
</table>
<blockquote>
<p>18W 解释：插入 18 万行记录，表格中的数字是执行时间（单位 ms）</p>
</blockquote>
<blockquote>
<p>Oracle 插入性能不用怀疑，可能安装学生版限制较大</p>
</blockquote>
<p>提醒：开源数据库测试结果比较有意义，商业数据库版本之间性能可能有较大差距</p>
<h3 id="测试结果-10-个字段" tabindex="-1"> 测试结果(10 个字段)</h3>
<table>
<thead>
<tr>
<th></th>
<th>18W</th>
<th>1W</th>
<th>5K</th>
<th>2K</th>
<th>1K</th>
<th>500</th>
<th>100</th>
<th>50</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySql 5.5 ExecuteAffrows</td>
<td>11,171</td>
<td>866</td>
<td>366</td>
<td>80</td>
<td>83</td>
<td>50</td>
<td>24</td>
<td>34</td>
</tr>
<tr>
<td>MySql 5.5 ExecuteMySqlBulkCopy</td>
<td>6,504</td>
<td>399</td>
<td>257</td>
<td>116</td>
<td>87</td>
<td>100</td>
<td>16</td>
<td>16</td>
</tr>
<tr>
<td>SqlServer Express ExecuteAffrows</td>
<td>47,204</td>
<td>2,275</td>
<td>1,108</td>
<td>488</td>
<td>279</td>
<td>123</td>
<td>35</td>
<td>16</td>
</tr>
<tr>
<td>SqlServer Express ExecuteSqlBulkCopy</td>
<td>4,248</td>
<td>127</td>
<td>71</td>
<td>30</td>
<td>48</td>
<td>14</td>
<td>11</td>
<td>10</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecuteAffrows</td>
<td>9,786</td>
<td>568</td>
<td>336</td>
<td>157</td>
<td>102</td>
<td>34</td>
<td>9</td>
<td>6</td>
</tr>
<tr>
<td>PostgreSQL 10 ExecutePgCopy</td>
<td>4,081</td>
<td>167</td>
<td>93</td>
<td>39</td>
<td>21</td>
<td>12</td>
<td>4</td>
<td>2</td>
</tr>
<tr>
<td>Oracle XE ExecuteAffrows</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>-</td>
<td>2,394</td>
<td>731</td>
<td>67</td>
<td>33</td>
</tr>
<tr>
<td>Sqlite ExecuteAffrows</td>
<td>4,524</td>
<td>246</td>
<td>137</td>
<td>94</td>
<td>35</td>
<td>19</td>
<td>14</td>
<td>11</td>
</tr>
</tbody>
</table>
<blockquote>
<p>测试结果，是在相同操作系统下进行的，并且都有预热</p>
</blockquote>
<blockquote>
<p>ExecuteMySqlBulkCopy 方法在 FreeSql.Provider.MySqlConnector 中实现的</p>
</blockquote>
<div><pre><code><span>//测试实体类</span>
<span>public</span> <span>class</span> <span>TestInsert10c</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>Guid</span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>string</span></span> UserName0 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> PassWord0 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime0 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>string</span></span> UserName1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> PassWord1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>string</span></span> UserName2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> PassWord2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>//生成测试数据</span>
<span>IFreeSql</span> orm <span>=</span> <span>..</span><span>.</span><span>;</span>
<span><span>var</span></span> testCount <span>=</span> <span>10000</span><span>;</span>
<span><span>var</span></span> t10cs <span>=</span> <span>new</span> <span>List<span>&lt;</span>TestInsert10c<span>></span></span><span>(</span><span>)</span><span>;</span>
<span>for</span> <span>(</span><span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span> a <span>&lt;</span> testCount<span>;</span> a<span>++</span><span>)</span> <span>{</span>
    <span><span>var</span></span> item <span>=</span> <span>new</span> <span>TestInsert10c</span><span>(</span><span>)</span><span>;</span>
    <span>for</span> <span>(</span><span><span>var</span></span> b <span>=</span> <span>0</span><span>;</span> b <span>&lt;=</span> <span>2</span><span>;</span> b<span>++</span><span>)</span>
    <span>{</span>
        orm<span>.</span><span>SetEntityValueWithPropertyName</span><span>(</span><span>typeof</span><span>(</span><span>TestInsert10c</span><span>)</span><span>,</span> item<span>,</span> <span>"UserName"</span> <span>+</span> b<span>,</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>"N"</span><span>)</span><span>)</span><span>;</span>
        orm<span>.</span><span>SetEntityValueWithPropertyName</span><span>(</span><span>typeof</span><span>(</span><span>TestInsert10c</span><span>)</span><span>,</span> item<span>,</span> <span>"PassWord"</span> <span>+</span> b<span>,</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>"N"</span><span>)</span><span>)</span><span>;</span>
        orm<span>.</span><span>SetEntityValueWithPropertyName</span><span>(</span><span>typeof</span><span>(</span><span>TestInsert10c</span><span>)</span><span>,</span> item<span>,</span> <span>"CreateTime"</span> <span>+</span> b<span>,</span> DateTime<span>.</span>Now<span>)</span><span>;</span>
    <span>}</span>
    t10cs<span>.</span><span>Add</span><span>(</span>item<span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h1 id="查询测试" tabindex="-1"> 查询测试</h1>
<div><pre><code><span>IFreeSql</span> mysql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=100"</span><span>)</span>
    <span>//由于null会默认输出日志到控制台，影响测试结果。这里传入一个空的日志输出对象</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>false</span><span>)</span>
    <span>//关闭自动迁移功能</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Song</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Url <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> Create_time <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>bool</span></span> Is_deleted <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>测试方法：运行两次，以第二次性能报告，避免了首个运行慢不公平的情况。</p>
<h3 id="测试结果" tabindex="-1"> 测试结果</h3>
<table>
<thead>
<tr>
<th></th>
<th>数量</th>
<th>Query&lt;Class&gt;</th>
<th>Query&lt;Tuple&gt;</th>
<th>Query&lt;dynamic&gt;</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dapper.Query(sql)</td>
<td>131072</td>
<td>623.4959ms</td>
<td>424.2411ms</td>
<td>644.8897ms</td>
</tr>
<tr>
<td>FreeSql.Query(sql)</td>
<td>131072</td>
<td>647.0552ms</td>
<td>577.3532ms</td>
<td>944.7454ms</td>
</tr>
<tr>
<td>FreeSql.ToList</td>
<td>131072</td>
<td>622.8980ms</td>
<td>435.3532ms</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>FreeSql 以微小的性能差距输了，原因是支持了更多的类型，某些类型解析需要 Parse、递归或循环处理。</p>
<blockquote>
<p>由于 Dapper 没有批量插入/更新/删除的功能，并且都是执行一条 SQL 命令，测试结果没有意义。</p>
</blockquote>
<blockquote>
<p>FreeSql 批量插入使用的命令：INSERT INTO Song (...) VALUES(...),VALUES(...),VALUES(...)...</p>
</blockquote>
<h3 id="执行-sql-返回实体列表-dapper-query-class-vs-freesql-query-class" tabindex="-1"> 执行 SQL 返回实体列表 Dapper.Query&lt;Class&gt; VS FreeSql.Query&lt;Class&gt;</h3>
<div><pre><code><span>[</span><span><span>Fact</span></span><span>]</span>
<span>public</span> <span><span>void</span></span> <span>QueryEntity</span><span>(</span><span>)</span> <span>{</span>
    <span><span>var</span></span> sb <span>=</span> <span>new</span> <span>StringBuilder</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> time <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span>List<span>&lt;</span>Song<span>></span></span> dplist1 <span>=</span> <span>null</span><span>;</span>
    <span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>)</span> <span>{</span>
        dplist1 <span>=</span> Dapper<span>.</span>SqlMapper<span>.</span><span><span>Query</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span>conn<span>.</span>Value<span>,</span> <span>"select * from song"</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Entity Counts: </span><span><span>{</span><span>dplist1<span>.</span>Count</span><span>}</span></span><span>; ORM: Dapper"</span></span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> t3 <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>"select * from song"</span><span>)</span><span>;</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Entity Counts: </span><span><span>{</span><span>t3<span>.</span>Count</span><span>}</span></span><span>; ORM: FreeSql*"</span></span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="执行-sql-返回元组列表-dapper-query-tuple-vs-freesql-query-tuple" tabindex="-1"> 执行 SQL 返回元组列表 Dapper.Query&lt;Tuple&gt; VS FreeSql.Query&lt;Tuple&gt;</h3>
<div><pre><code><span>[</span><span><span>Fact</span></span><span>]</span>
<span>public</span> <span><span>void</span></span> <span>QueryTuple</span><span>(</span><span>)</span> <span>{</span>
    <span><span>var</span></span> sb <span>=</span> <span>new</span> <span>StringBuilder</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> time <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span>List<span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>,</span> <span>string</span><span>)</span><span>></span></span> dplist2 <span>=</span> <span>null</span><span>;</span>
    <span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>)</span> <span>{</span>
        dplist2 <span>=</span> Dapper<span>.</span>SqlMapper<span>.</span><span><span>Query</span><span><span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>,</span> <span>string</span><span>)</span><span>></span></span></span><span>(</span>conn<span>.</span>Value<span>,</span> <span>"select * from song"</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Tuple Counts: </span><span><span>{</span><span>dplist2<span>.</span>Count</span><span>}</span></span><span>; ORM: Dapper"</span></span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> t4 <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>,</span> <span>string</span><span>)</span><span>></span></span></span><span>(</span><span>"select * from song"</span><span>)</span><span>;</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Tuple Counts: </span><span><span>{</span><span>t4<span>.</span>Count</span><span>}</span></span><span>; ORM: FreeSql*"</span></span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="执行-sql-返回-dynamic-列表-dapper-query-dynamic-vs-freesql-query-dynamic" tabindex="-1"> 执行 SQL 返回 dynamic 列表 Dapper.Query&lt;dynamic&gt; VS FreeSql.Query&lt;dynamic&gt;</h3>
<div><pre><code><span>[</span><span><span>Fact</span></span><span>]</span>
<span>public</span> <span><span>void</span></span> <span>QueryDynamic</span><span>(</span><span>)</span> <span>{</span>
    <span><span>var</span></span> sb <span>=</span> <span>new</span> <span>StringBuilder</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> time <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span>List<span>&lt;</span><span>dynamic</span><span>></span></span> dplist3 <span>=</span> <span>null</span><span>;</span>
    <span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>)</span> <span>{</span>
        dplist3 <span>=</span> Dapper<span>.</span>SqlMapper<span>.</span><span><span>Query</span><span><span>&lt;</span><span>dynamic</span><span>></span></span></span><span>(</span>conn<span>.</span>Value<span>,</span> <span>"select * from song"</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Dynamic Counts: </span><span><span>{</span><span>dplist3<span>.</span>Count</span><span>}</span></span><span>; ORM: Dapper"</span></span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> t5 <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span><span>dynamic</span><span>></span></span></span><span>(</span><span>"select * from song"</span><span>)</span><span>;</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Dynamic Counts: </span><span><span>{</span><span>t3<span>.</span>Count</span><span>}</span></span><span>; ORM: FreeSql*"</span></span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="dapper-query-vs-freesql-tolist" tabindex="-1"> Dapper.Query VS FreeSql.ToList</h3>
<div><pre><code><span>[</span><span><span>Fact</span></span><span>]</span>
<span>public</span> <span><span>void</span></span> <span>QueryList</span><span>(</span><span>)</span> <span>{</span>
    <span><span>var</span></span> sb <span>=</span> <span>new</span> <span>StringBuilder</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> time <span>=</span> <span>new</span> <span>Stopwatch</span><span>(</span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span><span>var</span></span> t3 <span>=</span> g<span>.</span>mysql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; ToList Entity Counts: </span><span><span>{</span><span>t3<span>.</span>Count</span><span>}</span></span><span>; ORM: FreeSql*"</span></span><span>)</span><span>;</span>

    time<span>.</span><span>Restart</span><span>(</span><span>)</span><span>;</span>
    <span>List<span>&lt;</span>Song<span>></span></span> dplist1 <span>=</span> <span>null</span><span>;</span>
    <span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> g<span>.</span>mysql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>)</span> <span>{</span>
        dplist1 <span>=</span> Dapper<span>.</span>SqlMapper<span>.</span><span><span>Query</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span>conn<span>.</span>Value<span>,</span> <span>"select * from song"</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    time<span>.</span><span>Stop</span><span>(</span><span>)</span><span>;</span>
    sb<span>.</span><span>AppendLine</span><span>(</span><span><span>$"Elapsed: </span><span><span>{</span><span>time<span>.</span>Elapsed</span><span>}</span></span><span>; Query Entity Counts: </span><span><span>{</span><span>dplist1<span>.</span>Count</span><span>}</span></span><span>; ORM: Dapper"</span></span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>更多测试源码：FreeSql/FreeSql.Tests.PerformanceTests/MySqlAdoTest.cs</p>
</blockquote>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">读写分离</title>
    <id>https://freesql.net/guide/read-write-splitting.html</id>
    <link href="https://freesql.net/guide/read-write-splitting.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="读写分离" tabindex="-1"> 读写分离</h1>
<p>FreeSql 支持数据库读写分离，本功能是客户端的读写分离行为，数据库服务器该怎么配置仍然那样配置，不受本功能影响，为了方便描术后面讲到的【读写分离】都是指客户端的功能支持。</p>
<p>各种数据库的读写方案不一，数据库端开启读写分离功能后，读写分离的实现大致分为以下几种：</p>
<p>1、nginx 代理，配置繁琐且容易出错；</p>
<p>2、中件间，如 MyCat；</p>
<p>3、在 client 端支持；</p>
<p>FreeSql 实现了第 3 种方案，支持一个【主库】多个【从库】，【从库】的查询策略为随机方式。</p>
<p>若某【从库】发生故障，将切换到其他可用【从库】，若已全部不可用则使用【主库】查询。</p>
<p>出现故障【从库】被隔离起来间隔性的检查可用状态，以待恢复。</p>
<div><pre><code><span><span>var</span></span> connstr <span>=</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;"</span> <span>+</span>
    <span>"Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>;</span>

<span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connstr<span>)</span>
    <span>.</span><span>UseSlave</span><span>(</span><span>"connectionString1"</span><span>,</span> <span>"connectionString2"</span><span>)</span> <span>//使用从数据库，支持多个</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToOne</span><span>(</span><span>)</span><span>;</span> <span>//读【从库】（默认）</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Master</span><span>(</span><span>)</span><span>.</span><span>WhereId</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToOne</span><span>(</span><span>)</span><span>;</span> <span>//强制读【主库】</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">仓储</title>
    <id>https://freesql.net/guide/repository.html</id>
    <link href="https://freesql.net/guide/repository.html"/>
    <updated>2022-08-15T16:01:12.000Z</updated>
    <content type="html"><![CDATA[<p><code>FreeSql.Repository</code> 作为扩展，实现了通用仓储层功能。与其他规范标准一样，仓储层也有相应的规范定义。FreeSql.Repository 参考 abp vnext 接口，定义和实现基础的仓储层（CURD），应该算比较通用的方法吧。</p>
<h2 id="特性" tabindex="-1"> 特性</h2>
<ul>
<li>Select/Attach 快照对象，Update 只更新变化的字段；</li>
<li>Insert 插入数据，适配各数据库优化执行 ExecuteAffrows/ExecuteIdentity/ExecuteInserted；</li>
<li>InsertOrUpdate 插入或更新；</li>
<li>SaveMany 方法快速保存导航对象（一对多、多对多）；</li>
</ul>
<h2 id="安装" tabindex="-1"> 安装</h2>
<CodeTabs :data='[{"title":".NET CLI"},{"title":".NET Framework"}]' :active="0">

<template #tab0="{ title, value, isActive }">
<div><pre><code> dotnet <span>add</span> package FreeSql.Repository
</code></pre><div aria-hidden="true"><div></div></div></div></template>
<template #tab1="{ title, value, isActive }">
<div><pre><code>Install-Package FreeSql.Repository
</code></pre><div aria-hidden="true"><div></div></div></div></template>
</CodeTabs>
<h2 id="定义" tabindex="-1"> 定义</h2>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> connectionString<span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动迁移实体的结构到数据库</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>public</span> <span>class</span> <span>Song</span>
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="使用方法" tabindex="-1"> 使用方法</h2>
<p>方法 1、IFreeSql 的扩展方法；</p>
<div><pre><code><span><span>var</span></span> curd <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><blockquote>
<p>注意：Repository 对象多线程不安全,因此不应在多个线程上同时对其执行工作。</p>
</blockquote>
<ul>
<li>不支持从不同的线程同时使用同一仓储实例</li>
</ul>
<p>方法 2、继承实现；</p>
<div><pre><code><span>public</span> <span>class</span> <span>SongRepository</span> <span>:</span> <span><span>BaseRepository<span>&lt;</span>Song<span>,</span> <span>int</span><span>></span></span></span>
<span>{</span>
    <span>public</span> <span>SongRepository</span><span>(</span><span>IFreeSql</span> fsql<span>)</span> <span>:</span> <span>base</span><span>(</span>fsql<span>,</span> <span>null</span><span>,</span> <span>null</span><span>)</span> <span>{</span><span>}</span>

    <span>//在这里增加 CURD 以外的方法</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>方法 3、依赖注入；</p>
<div><pre><code><span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>
<span>{</span>
    services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
    services<span>.</span><span>AddFreeRepository</span><span>(</span><span>null</span><span>,</span> <span>this</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span>.</span>Assembly<span>)</span><span>;</span>
<span>}</span>

<span>//在控制器使用</span>
<span>public</span> <span>SongsController</span><span>(</span><span>IBaseRepository<span>&lt;</span>Song<span>></span></span> songRepository<span>)</span>
<span>{</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>依赖注入的方式可实现全局【过滤与验证】的设定，方便租户功能的设计；</p>
</blockquote>
<p>更多资料：<a href="/guide/filters.html">《过滤器、全局过滤器》</a></p>
<h2 id="状态管理" tabindex="-1"> 状态管理</h2>
<p>只更新变化的属性：</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> item <span>=</span> repo<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span>  <span>//此时快照 item</span>
item<span>.</span>Title <span>=</span> <span>"newtitle"</span><span>;</span>
repo<span>.</span><span>Update</span><span>(</span>item<span>)</span><span>;</span> <span>//对比快照时的变化</span>
<span>//UPDATE `tb_topic` SET `Title` = ?p_0</span>
<span>//WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>是不是觉得先查询再更新，啰嗦？</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> item <span>=</span> <span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>1</span> <span>}</span><span>;</span>
repo<span>.</span><span>Attach</span><span>(</span>item<span>)</span><span>;</span> <span>//此时快照 item</span>
item<span>.</span>Title <span>=</span> <span>"newtitle"</span><span>;</span>
repo<span>.</span><span>Update</span><span>(</span>item<span>)</span><span>;</span> <span>//对比快照时的变化</span>
<span>//UPDATE `tb_topic` SET `Title` = ?p_0</span>
<span>//WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>repo.CompareState(item) 可获取 item 的状态变化信息</p>
<div><pre><code><span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
<span>/// 比较实体，计算出值发生变化的属性，以及属性变化的前后值</span>
<span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
<span>/// <span><span><span>&lt;</span>param</span> <span>name</span><span><span>=</span><span>"</span>newdata<span>"</span></span><span>></span></span>最新的实体对象，它将与附加实体的状态对比<span><span><span>&lt;/</span>param</span><span>></span></span></span>
<span>/// <span><span><span>&lt;</span>returns</span><span>></span></span>key: 属性名, value: [旧值, 新值]<span><span><span>&lt;/</span>returns</span><span>></span></span></span>
<span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>[</span><span>]</span><span>></span></span> <span>CompareState</span><span>(</span><span>TEntity</span> newdata<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="过滤与验证" tabindex="-1"> 过滤与验证</h2>
<p>假设我们有 User(用户)、Topic(主题)两个实体，在领域类中定义了两个仓储：</p>
<div><pre><code><span><span>var</span></span> userRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> topicRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>在开发过程中，总是担心 topicRepository 的数据安全问题，即有可能查询或操作到其他用户的主题。因此我们在 v0.0.7 版本进行了改进，增加了 filter lambda 表达式参数。</p>
<div><pre><code><span><span>var</span></span> userRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>;</span>
<span><span>var</span></span> topicRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span>a <span>=></span> a<span>.</span>UserId <span>==</span> <span>1</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ul>
<li>在查询/修改/删除时附加此条件，从而达到不会修改其他用户的数据；</li>
<li>在添加时，使用表达式验证数据的合法性，若不合法则抛出异常；</li>
</ul>
<h2 id="分表与分库" tabindex="-1"> 分表与分库</h2>
<p>FreeSql 提供 AsTable 分表的基础方法，GuidRepository 作为分存式仓储将实现了分表与分库（不支持跨服务器分库）的封装。</p>
<div><pre><code><span><span>var</span></span> logRepository <span>=</span> fsql<span>.</span><span><span>GetGuidRepository</span><span><span>&lt;</span>Log<span>></span></span></span><span>(</span><span>null</span><span>,</span> oldname <span>=></span> <span><span>$"</span><span><span>{</span><span>oldname</span><span>}</span></span><span>_</span><span><span>{</span><span>DateTime<span>.</span>Now<span>.</span><span>ToString</span><span>(</span><span>"YYYYMM"</span><span>)</span></span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>上面我们得到一个日志仓储按年月分表，使用它 CURD 最终会操作 Log_201903 表。</p>
<p>注意事项：</p>
<ul>
<li>v0.11.12 以后的版本可以使用 CodeFirst 迁移分表；</li>
<li>不可在分表分库的实体类型中使用《延时加载》；</li>
</ul>
<h2 id="兼容问题" tabindex="-1"> 兼容问题</h2>
<p>SqlServer 提供的 output inserted 特性，在表使用了自增或数据库定义了默认值的时候，使用它可以快速将 insert 的数据返回。PostgreSQL 也有相应的功能，如此方便但不是每个数据库都支持。</p>
<p>当采用了不支持该特性的数据库（Sqlite/MySql/Oracle/达梦/南大通用/MsAccess），并且实体使用了自增属性，仓储批量插入将变为逐条执行，可以考虑以下改进：</p>
<ul>
<li>使用 uuid 作为主键（即 Guid）；</li>
<li>避免使用数据库的默认值功能；</li>
</ul>
<h2 id="联级保存" tabindex="-1"> 联级保存</h2>
<p>请移步文档 <a href="/guide/cascade-saving.html">《联级保存》</a></p>
<h2 id="api" tabindex="-1"> API</h2>
<table>
<thead>
<tr>
<th>属性</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>EntityType</td>
<td>Type</td>
<td>仓储正在操作的实体类型，注意它不一定是 TEntity</td>
</tr>
<tr>
<td>UnitOfWork</td>
<td>IUnitOfWork</td>
<td>正在使用的工作单元</td>
</tr>
<tr>
<td>Orm</td>
<td>IFreeSql</td>
<td>正在使用的 Orm</td>
</tr>
<tr>
<td>DbContextOptions</td>
<td>DbContextOptions</td>
<td>正在使用的 DbContext 设置，修改设置不影响其他</td>
</tr>
<tr>
<td>DataFilter</td>
<td>IDataFilter&lt;TEntity&gt;</td>
<td>仓储过滤器，本对象内生效</td>
</tr>
<tr>
<td>UpdateDiy</td>
<td>IUpdate&lt;TEntity&gt;</td>
<td>准备更新数据，与仓储同事务</td>
</tr>
<tr>
<td>Select</td>
<td>ISelect&lt;TEntity&gt;</td>
<td>准备查询数据</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AsType</td>
<td>void</td>
<td>Type</td>
<td>改变仓储正在操作的实体类型</td>
</tr>
<tr>
<td>Get</td>
<td>TEntity</td>
<td>TKey</td>
<td>根据主键，查询数据</td>
</tr>
<tr>
<td>Find</td>
<td>TEntity</td>
<td>TKey</td>
<td>根据主键，查询数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>TKey</td>
<td>根据主键删除数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>Lambda</td>
<td>根据 lambda 条件删除数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>TEntity</td>
<td>删除数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量删除数据</td>
</tr>
<tr>
<td><a href="https://freesql.net/guide/cascade-delete.html" target="_blank" rel="noopener noreferrer">DeleteCascadeByDatabase</a></td>
<td>List&lt;object&gt;</td>
<td>Lambda</td>
<td>根据导航属性递归数据库删除数据</td>
</tr>
<tr>
<td>Insert</td>
<td>-</td>
<td>TEntity</td>
<td>插入数据，若实体有自增列，插入后的自增值会填充到实体中</td>
</tr>
<tr>
<td>Insert</td>
<td>-</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量插入数据</td>
</tr>
<tr>
<td>Update</td>
<td>-</td>
<td>TEntity</td>
<td>更新数据</td>
</tr>
<tr>
<td>Update</td>
<td>-</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量更新数据</td>
</tr>
<tr>
<td>InsertOrUpdate</td>
<td>-</td>
<td>TEntity</td>
<td>插入或更新数据</td>
</tr>
<tr>
<td>FlushState</td>
<td>-</td>
<td>无</td>
<td>清除状态管理数据</td>
</tr>
<tr>
<td>Attach</td>
<td>-</td>
<td>TEntity</td>
<td>附加实体到状态管理，可用于不查询就更新或删除</td>
</tr>
<tr>
<td>Attach</td>
<td>-</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量附加实体到状态管理</td>
</tr>
<tr>
<td>AttachOnlyPrimary</td>
<td>-</td>
<td>TEntity</td>
<td>只附加实体的主键数据到状态管理</td>
</tr>
<tr>
<td><a href="/guide/cascade-saving.html">SaveMany</a></td>
<td>-</td>
<td>TEntity, string</td>
<td>保存实体的指定 ManyToMany/OneToMany 导航属性（完整对比）</td>
</tr>
<tr>
<td><a href="/guide/insert-or-update.html#_4%E3%80%81beginedit-%E6%89%B9%E9%87%8F%E7%BC%96%E8%BE%91">BeginEdit</a></td>
<td>-</td>
<td>List&lt;TEntity&gt;</td>
<td>准备编辑一个 List 实体</td>
</tr>
<tr>
<td>EndEdit</td>
<td>int</td>
<td>无</td>
<td>完成编辑数据，进行保存动作</td>
</tr>
</tbody>
</table>
<blockquote>
<p>状态管理，可实现 Update 只更新变化的字段（不更新所有字段），灵活使用 Attach 和 Update 用起来非常舒服。</p>
</blockquote>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">树型查询 ✨</title>
    <id>https://freesql.net/guide/select-as-tree.html</id>
    <link href="https://freesql.net/guide/select-as-tree.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="树型查询-✨" tabindex="-1"> 树型查询 ✨</h1>
<p>无限级分类（父子）是一种比较常用的表设计，每种设计方式突出优势的同时也带来缺陷，如：</p>
<ul>
<li>方法 1：表设计中只有 parent_id 字段，困扰：查询麻烦（本文可解决）；</li>
<li>方法 2：表设计中冗余子级 id 便于查询，困扰：添加/更新/删除的时候需要重新计算；</li>
<li>方法 3：表设计中存储左右值编码，困扰：同上；</li>
</ul>
<p>方法 1 设计最简单，本文解决它的递归查询问题，让使用透明化。</p>
<h2 id="父子导航属性" tabindex="-1"> 父子导航属性</h2>
<p>FreeSql 导航属性之中，有针对父子关系的设置方式，如下：</p>
<div><pre><code><span>public</span> <span>class</span> <span>Area</span>
<span>{</span>
  <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span><span>string</span></span> Code <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span><span>string</span></span> ParentCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

  <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>ParentCode<span>)</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span>Area</span> Parent <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>[</span><span><span>Navigate</span><span><span>(</span><span>nameof</span><span>(</span>ParentCode<span>)</span><span>)</span></span></span><span>]</span>
  <span>public</span> <span>List<span>&lt;</span>Area<span>></span></span> Childs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>定义 Parent 属性，在表达式中可以这样：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Parent<span>.</span>Parent<span>.</span>Parent<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>定义 Childs 属性，在表达式中可以这样（子查询）：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Childs<span>.</span><span>Any</span><span>(</span>c <span>=></span> c<span>.</span>Name <span>==</span> <span>"北京"</span><span>)</span><span>)</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>定义 Childs 属性，还可以使用【级联保存】、【贪婪加载】等等操作。</p>
<div><pre><code>fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span><span>"1=1"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span>DbContextOptions<span>.</span>EnableCascadeSave <span>=</span> <span>true</span><span>;</span>
repo<span>.</span>DbContextOptions<span>.</span>NoneParameter <span>=</span> <span>true</span><span>;</span>
repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Area</span>
<span>{</span>
  Code <span>=</span> <span>"100000"</span><span>,</span>
  Name <span>=</span> <span>"中国"</span><span>,</span>
  Childs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Area<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span>
    <span>new</span> <span>Area</span>
    <span>{</span>
      Code <span>=</span> <span>"110000"</span><span>,</span>
      Name <span>=</span> <span>"北京"</span><span>,</span>
      Childs <span>=</span> <span>new</span> <span>List<span>&lt;</span>Area<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span>
        <span>new</span> <span>Area</span><span>{</span> Code<span>=</span><span>"110100"</span><span>,</span> Name <span>=</span> <span>"北京市"</span> <span>}</span><span>,</span>
        <span>new</span> <span>Area</span><span>{</span> Code<span>=</span><span>"110101"</span><span>,</span> Name <span>=</span> <span>"东城区"</span> <span>}</span><span>,</span>
      <span>}</span><span>)</span>
    <span>}</span>
  <span>}</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_1、totreelist" tabindex="-1"> 1、ToTreeList</h2>
<p>配置好父子属性之后，就可以这样用了：</p>
<div><pre><code><span><span>var</span></span> t1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToTreeList</span><span>(</span><span>)</span><span>;</span>
Assert<span>.</span><span>Single</span><span>(</span>t1<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"100000"</span><span>,</span> t1<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Single</span><span>(</span>t1<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110000"</span><span>,</span> t1<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>2</span><span>,</span> t1<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>.</span>Count<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110100"</span><span>,</span> t1<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110101"</span><span>,</span> t1<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>1</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>查询数据本来是平面的，ToTreeList 方法将返回的平面数据在内存中加工为树型 List 返回。</p>
<h2 id="_2、astreecte-递归删除" tabindex="-1"> 2、AsTreeCte 递归删除</h2>
<p>很常见的无限级分类表功能，删除树节点时，把子节点也处理一下。</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span>
  <span>.</span><span>AsTreeCte</span><span>(</span><span>)</span>
  <span>.</span><span>ToDelete</span><span>(</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//删除 中国 下的所有记录</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>如果软删除：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span>
  <span>.</span><span>AsTreeCte</span><span>(</span><span>)</span>
  <span>.</span><span>ToUpdate</span><span>(</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>IsDeleted<span>,</span> <span>true</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//软删除 中国 下的所有记录</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_3、astreecte-递归查询" tabindex="-1"> 3、AsTreeCte 递归查询</h2>
<p>若不做数据冗余的无限级分类表设计，递归查询少不了，AsTreeCte 正是解决递归查询的封装，方法参数说明：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>(可选) pathSelector</td>
<td>路径内容选择，可以设置查询返回：中国 -&gt; 北京 -&gt; 东城区</td>
</tr>
<tr>
<td>(可选) up</td>
<td>false(默认)：由父级向子级的递归查询，true：由子级向父级的递归查询</td>
</tr>
<tr>
<td>(可选) pathSeparator</td>
<td>设置 pathSelector 的连接符，默认：-&gt;</td>
</tr>
<tr>
<td>(可选) level</td>
<td>设置递归层级</td>
</tr>
</tbody>
</table>
<blockquote>
<p>通过测试的数据库：MySql8.0、SqlServer、PostgreSQL、Oracle、Sqlite、Firebird、达梦、人大金仓、南大通用、翰高</p>
</blockquote>
<p>姿势一：AsTreeCte() + ToTreeList</p>
<div><pre><code><span><span>var</span></span> t2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span>
  <span>.</span><span>AsTreeCte</span><span>(</span><span>)</span> <span>//查询 中国 下的所有记录</span>
  <span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Code<span>)</span>
  <span>.</span><span>ToTreeList</span><span>(</span><span>)</span><span>;</span> <span>//非必须，也可以使用 ToList（见姿势二）</span>
Assert<span>.</span><span>Single</span><span>(</span>t2<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"100000"</span><span>,</span> t2<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Single</span><span>(</span>t2<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110000"</span><span>,</span> t2<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>2</span><span>,</span> t2<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>.</span>Count<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110100"</span><span>,</span> t2<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110101"</span><span>,</span> t2<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>0</span><span>]</span><span>.</span>Childs<span>[</span><span>1</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
<span>// WITH "as_tree_cte"</span>
<span>// as</span>
<span>// (</span>
<span>// SELECT 0 as cte_level, a."Code", a."Name", a."ParentCode"</span>
<span>// FROM "Area" a</span>
<span>// WHERE (a."Name" = '中国')</span>

<span>// union all</span>

<span>// SELECT wct1.cte_level + 1 as cte_level, wct2."Code", wct2."Name", wct2."ParentCode"</span>
<span>// FROM "as_tree_cte" wct1</span>
<span>// INNER JOIN "Area" wct2 ON wct2."ParentCode" = wct1."Code"</span>
<span>// )</span>
<span>// SELECT a."Code", a."Name", a."ParentCode"</span>
<span>// FROM "as_tree_cte" a</span>
<span>// ORDER BY a."Code"</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>姿势二：AsTreeCte() + ToList</p>
<div><pre><code><span><span>var</span></span> t3 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span>
  <span>.</span><span>AsTreeCte</span><span>(</span><span>)</span>
  <span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Code<span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>4</span><span>,</span> t3<span>.</span>Count<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"100000"</span><span>,</span> t3<span>[</span><span>0</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110000"</span><span>,</span> t3<span>[</span><span>1</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110100"</span><span>,</span> t3<span>[</span><span>2</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110101"</span><span>,</span> t3<span>[</span><span>3</span><span>]</span><span>.</span>Code<span>)</span><span>;</span>
<span>//执行的 SQL 与姿势一相同</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>姿势三：AsTreeCte(pathSelector) + ToList</p>
<p>设置 pathSelector 参数后，如何返回隐藏字段？</p>
<div><pre><code><span><span>var</span></span> t4 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Area<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>==</span> <span>"中国"</span><span>)</span>
  <span>.</span><span>AsTreeCte</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>+</span> <span>"["</span> <span>+</span> a<span>.</span>Code <span>+</span> <span>"]"</span><span>)</span>
  <span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Code<span>)</span>
  <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
    item <span>=</span> a<span>,</span>
    level <span>=</span> Convert<span>.</span><span>ToInt32</span><span>(</span><span>"a.cte_level"</span><span>)</span><span>,</span>
    path <span>=</span> <span>"a.cte_path"</span>
  <span>}</span><span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>4</span><span>,</span> t4<span>.</span>Count<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"100000"</span><span>,</span> t4<span>[</span><span>0</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110000"</span><span>,</span> t4<span>[</span><span>1</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110100"</span><span>,</span> t4<span>[</span><span>2</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"110101"</span><span>,</span> t4<span>[</span><span>3</span><span>]</span><span>.</span>item<span>.</span>Code<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000]"</span><span>,</span> t4<span>[</span><span>0</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000] -> 北京[110000]"</span><span>,</span> t4<span>[</span><span>1</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000] -> 北京[110000] -> 北京市[110100]"</span><span>,</span> t4<span>[</span><span>2</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
Assert<span>.</span><span>Equal</span><span>(</span><span>"中国[100000] -> 北京[110000] -> 东城区[110101]"</span><span>,</span> t4<span>[</span><span>3</span><span>]</span><span>.</span>path<span>)</span><span>;</span>
<span>// WITH "as_tree_cte"</span>
<span>// as</span>
<span>// (</span>
<span>// SELECT 0 as cte_level, a."Name" || '[' || a."Code" || ']' as cte_path, a."Code", a."Name", a."ParentCode"</span>
<span>// FROM "Area" a</span>
<span>// WHERE (a."Name" = '中国')</span>

<span>// union all</span>

<span>// SELECT wct1.cte_level + 1 as cte_level, wct1.cte_path || ' -> ' || wct2."Name" || '[' || wct2."Code" || ']' as cte_path, wct2."Code", wct2."Name", wct2."ParentCode"</span>
<span>// FROM "as_tree_cte" wct1</span>
<span>// INNER JOIN "Area" wct2 ON wct2."ParentCode" = wct1."Code"</span>
<span>// )</span>
<span>// SELECT a."Code" as1, a."Name" as2, a."ParentCode" as5, a.cte_level as6, a.cte_path as7</span>
<span>// FROM "as_tree_cte" a</span>
<span>// ORDER BY a."Code"</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>更多姿势...请根据代码注释进行尝试</p>
</blockquote>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">分组聚合</title>
    <id>https://freesql.net/guide/select-group-by.html</id>
    <link href="https://freesql.net/guide/select-group-by.html"/>
    <updated>2022-09-05T11:27:53.000Z</updated>
    <content type="html"><![CDATA[<h1 id="分组聚合" tabindex="-1"> 分组聚合</h1>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> 
<span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="groupby分组聚合" tabindex="-1"> GroupBy分组聚合</h2>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>GroupBy</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> tt2 <span>=</span> a<span>.</span>Title<span>.</span><span>Substring</span><span>(</span><span>0</span><span>,</span> <span>2</span><span>)</span><span>,</span> mod4 <span>=</span> a<span>.</span>Id <span>%</span> <span>4</span> <span>}</span><span>)</span>
    <span>.</span><span>Having</span><span>(</span>a <span>=></span> a<span>.</span><span>Count</span><span>(</span><span>)</span> <span>></span> <span>0</span> <span>&amp;&amp;</span> a<span>.</span><span>Avg</span><span>(</span>a<span>.</span>Key<span>.</span>mod4<span>)</span> <span>></span> <span>0</span> <span>&amp;&amp;</span> a<span>.</span><span>Max</span><span>(</span>a<span>.</span>Key<span>.</span>mod4<span>)</span> <span>></span> <span>0</span><span>)</span>
    <span>.</span><span>Having</span><span>(</span>a <span>=></span> a<span>.</span><span>Count</span><span>(</span><span>)</span> <span>&lt;</span> <span>300</span> <span>||</span> a<span>.</span><span>Avg</span><span>(</span>a<span>.</span>Key<span>.</span>mod4<span>)</span> <span>&lt;</span> <span>100</span><span>)</span>
    <span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Key<span>.</span>tt2<span>)</span>
    <span>.</span><span>OrderByDescending</span><span>(</span>a <span>=></span> a<span>.</span><span>Count</span><span>(</span><span>)</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Key<span>,</span> cou1 <span>=</span> a<span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span> arg1 <span>=</span> a<span>.</span><span>Avg</span><span>(</span>a<span>.</span>Value<span>.</span>Clicks<span>)</span> <span>}</span><span>)</span><span>;</span>
<span>//SELECT substr(a.`Title`, 1, 2) as1, count(1) as2, avg(a.`Id`) as3 </span>
<span>//FROM `Topic` a </span>
<span>//GROUP BY substr(a.`Title`, 1, 2), (a.`Id` % 4) </span>
<span>//HAVING (count(1) > 0 AND avg((a.`Id` % 4)) > 0 AND max((a.`Id` % 4)) > 0) AND (count(1) &lt; 300 OR avg((a.`Id` % 4)) &lt; 100)</span>
<span>//ORDER BY substr(a.`Title`, 1, 2), count(1) DESC</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>不分组求聚合值，请使用 ToAggregate 替代 ToList</p>
</blockquote>
<h2 id="导航属性分组" tabindex="-1"> 导航属性分组</h2>
<p>假如 Topic 有导航属性 Category，Category 又有导航属性 Area，导航属性分组代码如下：</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>GroupBy</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Clicks<span>,</span> a<span>.</span>Category <span>}</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Key<span>.</span>Category<span>.</span>Area<span>.</span>Name <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>注意：如上这样编写，会报错无法解析 <a href="http://a.Key.Category.Area.Name" target="_blank" rel="noopener noreferrer">a.Key.Category.Area.Name</a>，解决办法使用 Include：</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Category<span>.</span>Area<span>)</span>
    <span>//必须添加此行，否则只分组 Category 而不包含它的下级导航属性 Area</span>

    <span>.</span><span>GroupBy</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Clicks<span>,</span> a<span>.</span>Category <span>}</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Key<span>.</span>Category<span>.</span>Area<span>.</span>Name <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>但是，你还可以这样解决：</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>GroupBy</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Clicks<span>,</span> a<span>.</span>Category<span>,</span> a<span>.</span>Category<span>.</span>Area <span>}</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Key<span>.</span>Area<span>.</span>Name <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><h2 id="多表分组" tabindex="-1"> 多表分组</h2>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>,</span> Category<span>,</span> Area<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>GroupBy</span><span>(</span><span>(</span>a<span>,</span> b<span>,</span> c<span>)</span> <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Title<span>,</span> c<span>.</span>Name <span>}</span><span>)</span>
    <span>.</span><span>Having</span><span>(</span>g <span>=></span> g<span>.</span><span>Count</span><span>(</span><span>)</span> <span>&lt;</span> <span>300</span> <span>||</span> g<span>.</span><span>Avg</span><span>(</span>g<span>.</span>Value<span>.</span>Item1<span>.</span>Clicks<span>)</span> <span>&lt;</span> <span>100</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span>g <span>=></span> <span>new</span> <span>{</span> count <span>=</span> g<span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span> Name <span>=</span> g<span>.</span>Key<span>.</span>Name <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><ul>
<li>g.Value.Item1 对应 Topic</li>
<li>g.Value.Item2 对应 Category</li>
<li>g.Value.Item3 对应 Area</li>
</ul>
<h2 id="aggregate" tabindex="-1"> Aggregate</h2>
<h3 id="distinct" tabindex="-1"> Distinct</h3>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Aggregate</span><span>(</span>a <span>=></span> Convert<span>.</span><span>ToInt32</span><span>(</span><span>"count(distinct title)"</span><span>)</span><span>,</span> <span>out</span> <span><span>var</span></span> count<span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><blockquote>
<p>SELECT count(distinct title) as1
FROM &quot;Topic&quot; a</p>
</blockquote>
<blockquote>
<p>SELECT a.&quot;Id&quot;, a.&quot;Clicks&quot;, a.&quot;Title&quot;, a.&quot;CreateTime&quot;
FROM &quot;Topic&quot; a</p>
</blockquote>
<h3 id="sqlext-distinctcount" tabindex="-1"> SqlExt.DistinctCount</h3>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Aggregate</span><span>(</span>a <span>=></span> SqlExt<span>.</span><span>DistinctCount</span><span>(</span>a<span>.</span>Key<span>.</span>Title<span>)</span><span>,</span> <span>out</span> <span><span>var</span></span> count<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><blockquote>
<p>SELECT count(distinct a.&quot;title&quot;) as1 FROM &quot;Topic&quot; a</p>
</blockquote>
<h3 id="toaggregate-sqlext-distinctcount" tabindex="-1"> ToAggregate + SqlExt.DistinctCount</h3>
<div><pre><code><span><span>var</span></span> distinctAggregate <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToAggregate</span><span>(</span>a <span>=></span> <span>new</span>
    <span>{</span>
        TitleCount <span>=</span> SqlExt<span>.</span><span>DistinctCount</span><span>(</span>a<span>.</span>Key<span>.</span>Title<span>)</span><span>,</span>
        ClicksCount<span>=</span> SqlExt<span>.</span><span>DistinctCount</span><span>(</span>a<span>.</span>Key<span>.</span>Clicks<span>)</span><span>,</span>
    <span>}</span>
<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>SELECT count(distinct a.&quot;Title&quot;) as1, count(distinct a.&quot;Clicks&quot;) as2
FROM &quot;Topic&quot; a</p>
</blockquote>
<h2 id="api" tabindex="-1"> API</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>Lambda</td>
<td>执行 SQL 查询，返回指定字段的记录，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>string field</td>
<td>执行 SQL 查询，返回 field 指定字段的记录，并以元组或基础类型(int,string,long)接收，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToAggregate&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>Lambda</td>
<td>执行 SQL 查询，返回指定字段的聚合结果（适合不需要 GroupBy 的场景）</td>
</tr>
<tr>
<td>Sum</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求和</td>
</tr>
<tr>
<td>Min</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最小值</td>
</tr>
<tr>
<td>Max</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最大值</td>
</tr>
<tr>
<td>Avg</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求平均值</td>
</tr>
<tr>
<td>【分组】</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GroupBy</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按选择的列分组，GroupBy(a =&gt; <a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>)</td>
</tr>
<tr>
<td>GroupBy</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生sql语法分组，GroupBy(&quot;concat(name, @cc)&quot;, new { cc = 1 })</td>
</tr>
<tr>
<td>Having</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生sql语法聚合条件过滤，Having(&quot;count(name) = @cc&quot;, new { cc = 1 })</td>
</tr>
<tr>
<td>【成员】</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Key</td>
<td></td>
<td></td>
<td>返回 GroupBy 选择的对象</td>
</tr>
<tr>
<td>Value</td>
<td></td>
<td></td>
<td>返回主表 或 From&lt;T2,T3....&gt; 的字段选择器</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">贪婪加载 ✨</title>
    <id>https://freesql.net/guide/select-include.html</id>
    <link href="https://freesql.net/guide/select-include.html"/>
    <updated>2022-08-13T05:28:52.000Z</updated>
    <content type="html"><![CDATA[<h1 id="贪婪加载-✨" tabindex="-1"> 贪婪加载 ✨</h1>
<h2 id="_1、导航属性-manytoone" tabindex="-1"> 1、导航属性 ManyToOne</h2>
<p>ManyToOne 导航属性通过 ToList(includeNestedMembers: false) 加载，参数说明：</p>
<p>false: 返回 2 级 Join 的导航数据（默认）；</p>
<p>true: 返回所有层级深度 Join 的导航数据（未使用的导航数据不会返回）；</p>
<div><pre><code><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Parent<span>.</span>Parent<span>)</span><span>.</span><span>ToList</span><span>(</span><span>true</span><span>)</span><span>;</span>

<span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Parent<span>.</span>Parent<span>.</span>Name <span>==</span> <span>"1"</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>true</span><span>)</span><span>;</span>
<span>//这样写，不需要再标记 Join，解析表达式时自动处理成 LeftJoin</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="_2、导航属性-onetomany-manytomany-pgarraytomany" tabindex="-1"> 2、导航属性 OneToMany/ManyToMany/PgArrayToMany</h2>
<p>IncludeMany 贪婪加载集合的导航属性，其实是分两次查询，在 ToList 后进行了数据重装。</p>
<div><pre><code><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>IncludeMany 有第二个参数，可以进行二次查询前的修饰工作。</p>
<div><pre><code><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>Songs<span>,</span>
    then <span>=></span> then<span>.</span><span>Where</span><span>(</span>song <span>=></span> song<span>.</span>User <span>==</span> <span>"admin"</span><span>)</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>其实在 then 那里，还可以继续进行向下 Include/IncludeMany。只要你喜欢，向下 100 层也没问题。</p>
<h2 id="_3、变异" tabindex="-1"> 3、变异</h2>
<p>没有配置导航关系，也可以贪婪加载。</p>
<div><pre><code><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>TestManys<span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>TagId <span>==</span> a<span>.</span>Id<span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>只查询每项子集合的前几条数据，避免像 EfCore 加载所有数据导致 IO 性能低下（比如某商品下有 2000 条评论）。</p>
<div><pre><code><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>TestManys<span>.</span><span>Take</span><span>(</span><span>10</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>子集合返回部分字段，避免字段过多的问题。</p>
<div><pre><code><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>IncludeMany</span><span>(</span>a <span>=></span> a<span>.</span>TestManys<span>.</span><span>Select</span><span>(</span>b <span>=></span> <span>new</span> <span>TestMany</span> <span>{</span> Title <span>=</span> b<span>.</span>Title <span>..</span><span>.</span> <span>}</span><span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="_4、includemany-扩展方法" tabindex="-1"> 4、IncludeMany 扩展方法</h2>
<p>当主数据已存在内存中，子数据怎么加载？所以我们增加了 List&lt;T&gt; 扩展方法，示例如下：</p>
<div><pre><code><span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span> song1<span>,</span> song2<span>,</span> song3 <span>}</span><span>)</span>
    <span>.</span><span>IncludeMany</span><span>(</span>fsql<span>,</span> a <span>=></span> a<span>.</span>Tags<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><div><pre><code><span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>new</span><span>[</span><span>]</span> <span>{</span> song1<span>,</span> song2<span>,</span> song3 <span>}</span><span>)</span>
    <span>.</span><span>IncludeByPropertyName</span><span>(</span>
        <span>orm</span><span>:</span> fsql<span>,</span>
        <span>property</span><span>:</span> <span>"Tags"</span><span>,</span>
        <span>where</span><span>:</span> <span>"ParentId=Code"</span><span>,</span>
        <span>take</span><span>:</span> <span>5</span><span>,</span>
        <span>select</span><span>:</span> <span>"id,name"</span>
    <span>)</span><span>;</span>
<span>//v3.2.605+</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_5、子查询-tolist" tabindex="-1"> 5、子查询 ToList</h2>
<blockquote>
<p>v3.2.650+ 以下最多执行3次 SQL</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span>
<span>{</span>
    all <span>=</span> a<span>,</span>
    list1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Tag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>,</span>
    list2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>SongTag<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>SongId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_6、includemany-两种方式对比" tabindex="-1"> 6、IncludeMany 两种方式对比</h2>
<p>方式一（IncludeMany 扩展方法）：</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>SysModule<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> Id <span>=</span> a<span>.</span>Id <span>}</span><span>)</span> <span>//查询数据 id</span>
    <span>.</span><span>Select</span><span>(</span>a <span>=></span> <span>new</span> <span>SysModule</span> <span>{</span> Id <span>=</span> a<span>.</span>Id <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span> <span>//内存操作</span>
    <span>.</span><span>IncludeMany</span><span>(</span>fsql<span>,</span> a <span>=></span> a<span>.</span>Permissions<span>,</span> then <span>=></span> then<span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Button<span>)</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> a<span>.</span><span>"Id"</span> as1 
<span>FROM</span> <span>"SysModule"</span> a 
<span>limit</span> <span>0</span><span>,</span><span>10</span>

<span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"SysModuleId"</span><span>,</span> a<span>.</span><span>"SysModuleButtonId"</span><span>,</span> a<span>.</span><span>"Status"</span><span>,</span> 
a__Button<span>.</span><span>"Id"</span> as5<span>,</span> a__Button<span>.</span><span>"Name"</span><span>,</span> a__Button<span>.</span><span>"EventName"</span><span>,</span> a__Button<span>.</span><span>"EnCode"</span><span>,</span> a__Button<span>.</span><span>"Icon"</span><span>,</span> a__Button<span>.</span><span>"Sort"</span><span>,</span> a__Button<span>.</span><span>"CreateTime"</span> 
<span>FROM</span> <span>"SysModulePermission"</span> a 
<span>LEFT</span> <span>JOIN</span> <span>"SysModuleButton"</span> a__Button <span>ON</span> a__Button<span>.</span><span>"Id"</span> <span>=</span> a<span>.</span><span>"SysModuleButtonId"</span> 
<span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span>"SysModuleId"</span><span>)</span> <span>in</span> <span>(</span><span>'menu1'</span><span>,</span><span>'menu2'</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<p>方式二（直接 IncludeMany + ToList）：</p>
<div><pre><code><span><span>var</span></span> list <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>SysModule<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>IncludeMany</span><span>(</span>m <span>=></span> m<span>.</span>Permissions<span>,</span> then <span>=></span> then<span>.</span><span>Include</span><span>(</span>a <span>=></span> a<span>.</span>Button<span>)</span><span>)</span>
    <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span>
    <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><div><pre><code><span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"ParentId"</span><span>,</span> a<span>.</span><span>"Name"</span><span>,</span> a<span>.</span><span>"Icon"</span><span>,</span> a<span>.</span><span>"UrlAddress"</span><span>,</span> a<span>.</span><span>"IsShow"</span><span>,</span> a<span>.</span><span>"Sort"</span><span>,</span> a<span>.</span><span>"Description"</span><span>,</span> a<span>.</span><span>"CreateTime"</span>
<span>FROM</span> <span>"SysModule"</span> a
<span>limit</span> <span>0</span><span>,</span><span>10</span>

<span>SELECT</span> a<span>.</span><span>"Id"</span><span>,</span> a<span>.</span><span>"SysModuleId"</span><span>,</span> a<span>.</span><span>"SysModuleButtonId"</span><span>,</span> a<span>.</span><span>"Status"</span><span>,</span>
a__Button<span>.</span><span>"Id"</span> as5<span>,</span> a__Button<span>.</span><span>"Name"</span><span>,</span> a__Button<span>.</span><span>"EventName"</span><span>,</span> a__Button<span>.</span><span>"EnCode"</span><span>,</span> a__Button<span>.</span><span>"Icon"</span><span>,</span> a__Button<span>.</span><span>"Sort"</span><span>,</span> a__Button<span>.</span><span>"CreateTime"</span>
<span>FROM</span> <span>"SysModulePermission"</span> a
<span>LEFT</span> <span>JOIN</span> <span>"SysModuleButton"</span> a__Button <span>ON</span> a__Button<span>.</span><span>"Id"</span> <span>=</span> a<span>.</span><span>"SysModuleButtonId"</span>
<span>WHERE</span> <span>(</span><span>(</span>a<span>.</span><span>"SysModuleId"</span><span>)</span> <span>in</span> <span>(</span><span>'menu1'</span><span>,</span><span>'menu2'</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>案例：查询 Vod 表，分类 1、分类 2、分类 3 各 10 条数据</p>
<div><pre><code><span>class</span> <span>Vod</span> <span>{</span>
    <span>public</span> <span>Guid</span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> TypeId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>//定义临时类，也可以是 Dto 类</span>
<span>class</span> <span>Dto</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> TypeId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>List<span>&lt;</span>Vod<span>></span></span> Vods <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> dto <span>=</span> <span>new</span> <span>[</span><span>]</span> <span>{</span> <span>1</span><span>,</span><span>2</span><span>,</span><span>3</span> <span>}</span><span>.</span><span>Select</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span> <span>{</span> TypeId <span>=</span> a <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
dto<span>.</span><span>IncludeMany</span><span>(</span>fsql<span>,</span> d <span>=></span> d<span>.</span>Vods<span>.</span><span>Take</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Where</span><span>(</span>vod <span>=></span> vod<span>.</span>TypeId <span>==</span> d<span>.</span>TypeId<span>)</span><span>)</span><span>;</span>

<span>//执行后，dto 每个元素.Vods 将只有 10条记录</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">延时加载</title>
    <id>https://freesql.net/guide/select-lazy-loading.html</id>
    <link href="https://freesql.net/guide/select-lazy-loading.html"/>
    <updated>2022-08-24T13:04:12.000Z</updated>
    <content type="html"><![CDATA[<h1 id="延时加载" tabindex="-1"> 延时加载</h1>
<p>FreeSql 支持导航属性延时加载，即当我们需要用到的时候才进行加载（读取），支持 1 对 1、多对 1、1 对多、多对多关系的导航属性。</p>
<p>当我们希望浏览某条订单信息的时候，才显示其对应的订单详细记录时，我们希望使用延迟加载来实现，这样不仅加快的了 读取的效率，同时也避免加载不需要的数据。延迟加载通常用于 foreach 循环读取数据时。</p>
<p>那么我们在定义 Model 的时候，需要在属性前面添加 virtual 关键字。如下</p>
<div><pre><code><span>public</span> <span>class</span> <span>Order</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> OrderID <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> OrderTitle <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> CustomerName <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> TransactionDate <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>List<span>&lt;</span>OrderDetail<span>></span></span> OrderDetails <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>class</span> <span>OrderDetail</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> DetailId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> OrderId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Order</span> Order <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>延时加载功能默认被关闭的，使用此功能之前，请在声明处开启；</p>
</blockquote>
<blockquote>
<p>延时加载功能，依赖 FreeSql.Extensions.LazyLoading 包，请前往 nuget 下载；</p>
</blockquote>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>)</span>
    <span>.</span><span>UseLazyLoading</span><span>(</span><span>true</span><span>)</span> <span>//开启延时加载功能</span>
    <span>.</span><span>UseMonitorCommand</span><span>(</span>
        cmd <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span> <span>//监听SQL命令对象，在执行前</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span><span>var</span></span> order <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>OrderID <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToOne</span><span>(</span><span>)</span><span>;</span> <span>//查询订单表</span>
<span><span>var</span></span> orderDetail1 <span>=</span> order<span>.</span>OrderDetails<span>;</span> <span>//第一次访问，查询数据库</span>
<span><span>var</span></span> orderDetail2 <span>=</span> order<span>.</span>OrderDetails<span>;</span> <span>//第二次访问，不查</span>
<span><span>var</span></span> order1 <span>=</span> orderDetail1<span>.</span><span>FirstOrDefault</span><span>(</span><span>)</span><span>;</span> <span>//访问导航属性，此时不查数据库，因为 OrderDetails 查询出来的时候已填充了该属性</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>控制台输出内容：</p>
<div><pre><code><span>SELECT</span> a<span>.</span><span><span>`</span>OrderID<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>OrderTitle<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>CustomerName<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>TransactionDate<span>`</span></span>
<span>FROM</span> <span><span>`</span>Order<span>`</span></span> a
<span>WHERE</span> <span>(</span>a<span>.</span><span><span>`</span>OrderID<span>`</span></span> <span>=</span> <span>1</span><span>)</span>
<span>limit</span> <span>0</span><span>,</span><span>1</span>

<span>SELECT</span> a<span>.</span><span><span>`</span>DetailId<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>OrderId<span>`</span></span>
<span>FROM</span> <span><span>`</span>OrderDetail<span>`</span></span> a
<span>WHERE</span> <span>(</span>a<span>.</span><span><span>`</span>OrderId<span>`</span></span> <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>FreeSql 延时加载支持 1 对 1、多对 1、1 对多、多对多关系的导航属性，前三者大小同异，以下我们单独介绍多对多关系。</p>
<h2 id="多对多延时加载" tabindex="-1"> 多对多延时加载</h2>
<div><pre><code><span>public</span> <span>partial</span> <span>class</span> <span>Song</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime<span>?</span></span> Create_time <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>bool</span><span>?</span></span> Is_deleted <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Url <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>virtual</span> <span>ICollection<span>&lt;</span>Tag<span>></span></span> Tags <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>partial</span> <span>class</span> <span>Song_tag</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Song_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Song</span> Song <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> Tag_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Tag</span> Tag <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>partial</span> <span>class</span> <span>Tag</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span><span>?</span></span> Parent_id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>virtual</span> <span>Tag</span> Parent <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>decimal</span><span>?</span></span> Ddd <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span>virtual</span> <span>ICollection<span>&lt;</span>Song<span>></span></span> Songs <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>如上有三个表，音乐、标签，以及他们的关系表。</p>
<div><pre><code><span><span>var</span></span> songs <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Limit</span><span>(</span><span>10</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span> <span>//取10条音乐</span>
<span><span>var</span></span> songs1 <span>=</span> songs<span>.</span><span>First</span><span>(</span><span>)</span><span>.</span>Tags<span>;</span> <span>//第一次访问，查询数据库</span>
<span><span>var</span></span> songs2 <span>=</span> Songs<span>.</span><span>First</span><span>(</span><span>)</span><span>.</span>Tags<span>;</span> <span>//第二次访问，不查</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>控制台输出内容：</p>
<div><pre><code><span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Create_time<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Is_deleted<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Title<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Url<span>`</span></span>
<span>FROM</span> <span><span>`</span>Song<span>`</span></span> a
<span>limit</span> <span>0</span><span>,</span><span>10</span>

<span>SELECT</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Parent_id<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Ddd<span>`</span></span><span>,</span> a<span>.</span><span><span>`</span>Name<span>`</span></span>
<span>FROM</span> <span><span>`</span>Tag<span>`</span></span> a
<span>WHERE</span> <span>(</span><span>exists</span><span>(</span><span>SELECT</span> <span>1</span>
<span>FROM</span> <span><span>`</span>Song_tag<span>`</span></span> b
<span>WHERE</span> <span>(</span>b<span>.</span><span><span>`</span>Song_id<span>`</span></span> <span>=</span> <span>2</span> <span>AND</span> b<span>.</span><span><span>`</span>Tag_id<span>`</span></span> <span>=</span> a<span>.</span><span><span>`</span>Id<span>`</span></span><span>)</span>
<span>limit</span> <span>0</span><span>,</span><span>1</span><span>)</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="总结" tabindex="-1"> 总结</h2>
<p>优点：只在需要的时候加载数据，不需要预先计划，避免了各种复杂的外连接、索引、视图操作带来的低效率问题。</p>
<p>缺陷：多次与 DB 交互，性能降低。</p>
<p>如果要在循环中使用数据，请使用贪婪加载，否则使用懒加载。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">多表查询</title>
    <id>https://freesql.net/guide/select-multi-table.html</id>
    <link href="https://freesql.net/guide/select-multi-table.html"/>
    <updated>2022-07-23T05:30:46.000Z</updated>
    <content type="html"><![CDATA[<h1 id="多表查询" tabindex="-1"> 多表查询</h1>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> CategoryId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>Category</span> Category <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>Category</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> ParentId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>CategoryType</span> Parent <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>List<span>&lt;</span>Topic<span>></span></span> Topics <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>class</span> <span>CategoryType</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_1、导航属性联表" tabindex="-1"> 1、导航属性联表</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span>a <span>=></span> a<span>.</span>Category<span>.</span>Id <span>==</span> a<span>.</span>CategoryId<span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span>a <span>=></span> a<span>.</span>Category<span>.</span>Parent<span>.</span>Id <span>==</span> a<span>.</span>Category<span>.</span>ParentId<span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Category<span>.</span>Parent<span>.</span>Id <span>></span> <span>0</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Title`, a.`Clicks`, a.`CreateTime`, a.`CategoryId`, a__Category.`Id` as6, a__Category.`Name`, a__Category.`ParentId`</span>
<span>//FROM `Topic` a</span>
<span>//LEFT JOIN `Category` a__Category ON a__Category.`Id` = a.`CategoryId`</span>
<span>//LEFT JOIN `CategoryType` a__Category__Parent ON a__Category__Parent.`Id` = a__Category.`ParentId`</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：正确配置 【导航关系】后，不需要手工调用 LeftJoin</p>
</blockquote>
<h2 id="_2、复杂联表" tabindex="-1"> 2、复杂联表</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>,</span> Category<span>,</span> CategoryType<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> a<span>.</span>CategoryId <span>==</span> b<span>.</span>Id<span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> b<span>.</span>ParentId <span>==</span> c<span>.</span>Id<span>)</span>
  <span>.</span><span>Where</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> c<span>.</span>Id <span>></span> <span>0</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> <span>new</span> <span>{</span> a<span>,</span>b<span>,</span>c <span>}</span><span>)</span><span>;</span>

<span>//或者</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span><span>From</span><span><span>&lt;</span>Category<span>,</span> CategoryType<span>></span></span></span><span>(</span><span>(</span>s<span>,</span> b<span>,</span> c<span>)</span> <span>=></span> s
  <span>.</span><span>LeftJoin</span><span>(</span>a <span>=></span> a<span>.</span>CategoryId <span>==</span> b<span>.</span>Id<span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span>a <span>=></span> b<span>.</span>ParentId <span>==</span> c<span>.</span>Id<span>)</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> c<span>.</span>Id <span>></span> <span>0</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> <span>new</span> <span>{</span> a<span>,</span>b<span>,</span>c <span>}</span><span>)</span><span>;</span>
  
<span>//减少定义 a,b,c 写法</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>,</span> Category<span>,</span> CategoryType<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span>w <span>=></span> w<span>.</span>t1<span>.</span>CategoryId <span>==</span> w<span>.</span>t2<span>.</span>Id<span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span>w <span>=></span> w<span>.</span>t2<span>.</span>ParentId <span>==</span> w<span>.</span>t3<span>.</span>Id<span>)</span>
  <span>.</span><span>Where</span><span>(</span>w <span>=></span> w<span>.</span>t3<span>.</span>Id <span>></span> <span>0</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span>w <span>=></span> <span>new</span> <span>{</span> w<span>.</span>t1<span>,</span>w<span>.</span>t2<span>,</span>w<span>.</span>t3 <span>}</span><span>)</span><span>;</span>
  
<span>//SELECT ...</span>
<span>//FROM `Topic` a</span>
<span>//LEFT JOIN `Category` b ON a.`CategoryId` = b.`Id`</span>
<span>//LEFT JOIN `CategoryType` c ON b.`ParentId` = c.`Id`</span>
<span>//WHERE c. `Id` > 0</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>经验：<a href="https://github.com/dotnetcore/FreeSql/issues/430" target="_blank" rel="noopener noreferrer">一对多，分表只取最后一条记录</a></p>
</blockquote>
<h2 id="_3、withsql" tabindex="-1"> 3、WithSql</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>,</span> Category<span>,</span> CategoryType<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithSql</span><span>(</span>
      <span>"select * from Topic where id=@id1"</span><span>,</span>
      <span>"select * from Category where id=@id2"</span><span>,</span>
      <span>null</span><span>,</span> <span>//不设置 CategoryType 对应的 SQL</span>
      <span>new</span> <span>{</span> id1 <span>=</span> <span>10</span><span>,</span> id2 <span>=</span> <span>11</span><span>,</span> id3 <span>=</span> <span>13</span> <span>}</span>
  <span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> a<span>.</span>CategoryId <span>==</span> b<span>.</span>Id<span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span><span>(</span>a<span>,</span>b<span>,</span>c<span>)</span> <span>=></span> b<span>.</span>ParentId <span>==</span> c<span>.</span>Id<span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT ...</span>
<span>//FROM ( select * from Topic where id=@id1 ) a</span>
<span>//LEFT JOIN ( select * from Category where id=@id2 ) b ON a.`CategoryId` = b.`Id`</span>
<span>//LEFT JOIN `CategoryType` c ON b.`ParentId` = c.`Id`</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：ISelect.ToSql 可与 WithSql 配合使用</p>
</blockquote>
<h2 id="_4、sql联表" tabindex="-1"> 4、SQL联表</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>LeftJoin</span><span>(</span><span>"Category b on b.Id = a.CategoryId and b.Name = @bname"</span><span>,</span> <span>new</span> <span>{</span> bname <span>=</span> <span>"xxx"</span> <span>}</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Title`, a.`Clicks`, a.`CreateTime`, a.`CategoryId`</span>
<span>//FROM `Topic` a</span>
<span>//LEFT JOIN Category b on b.Id = a.CategoryId and b.Name = @bname</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>延伸问题：SQL联表 b 表的字段如何在 ToList 中指定？</p>
<div><pre><code><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
  bid <span>=</span> Convert<span>.</span><span>ToInt32</span><span>(</span><span>"b.Id"</span><span>)</span><span>,</span>
  bName <span>=</span> <span>"b.Name"</span>
<span>}</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="_5、子表exists" tabindex="-1"> 5、子表Exists</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>As</span><span>(</span><span>"b"</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>Id <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Title`, a.`Clicks`, a.`CreateTime`, a.`CategoryId`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (exists(SELECT 1</span>
<span>//    FROM `Topic` b</span>
<span>//    WHERE (b.`Id` = a.`Id`)</span>
<span>//    limit 0,1))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：由于子查询的实体类与上层相同，使用 As(&quot;b&quot;) 指明别名，以便区分</p>
</blockquote>
<h2 id="_6、子表in" tabindex="-1"> 6、子表In</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>As</span><span>(</span><span>"b"</span><span>)</span><span>.</span><span>ToList</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Title`, a.`Clicks`, a.`CreateTime`, a.`CategoryId`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (((a.`Id`) in (SELECT b.`Id`</span>
<span>//    FROM `Topic` b)))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_7、子表join" tabindex="-1"> 7、子表Join</h2>
<p>v1.8.0+ string.Join + ToList 实现将子查询的多行结果，拼接为一个字符串，如：&quot;1,2,3,4&quot;</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
  id <span>=</span> a<span>.</span>Id<span>,</span>
  concat <span>=</span> <span>string</span><span>.</span><span>Join</span><span>(</span><span>","</span><span>,</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>StringJoin01<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, (SELECT group_concat(b.`Id` separator ',') </span>
<span>//    FROM `StringJoin01` b) </span>
<span>//FROM `Topic` a</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>提示：子查询 string.Join + ToList 适配了 sqlserver/pgsql/oracle/mysql/sqlite/firebird/达梦/金仓/南大/翰高 <a href="https://github.com/dotnetcore/FreeSql/issues/405" target="_blank" rel="noopener noreferrer">#405</a></p>
</blockquote>
<h2 id="_8、子表first-count-sum-max-min-avg" tabindex="-1"> 8、子表First/Count/Sum/Max/Min/Avg</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Category<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span>  <span>{</span>
  all <span>=</span> a<span>,</span>
  first <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>First</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
  count <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>
  sum <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Sum</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  max <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Max</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  min <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Min</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span><span>,</span>
  avg <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>CategoryId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>Avg</span><span>(</span>b <span>=></span> b<span>.</span>Clicks<span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_9、子表tolist" tabindex="-1"> 9、子表ToList</h2>
<blockquote>
<p>v3.2.650+ 以下最多执行3次 SQL</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span>
<span>{</span>
  all <span>=</span> a<span>,</span>
  list1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>,</span>
  list2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>TopicId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_10、集合属性" tabindex="-1"> 10、集合属性</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Category<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Topics<span>.</span><span>Any</span><span>(</span>b <span>=></span> b<span>.</span>Title<span>.</span><span>Contains</span><span>(</span><span>"xx"</span><span>)</span><span>)</span><span>)</span> <span>//v3.2.600 以下使用 a.Topics.AsSelect()</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>效果等同于：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Category<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span>b <span>=></span> b<span>.</span>Title<span>.</span><span>Contains</span><span>(</span><span>"xx"</span><span>)</span><span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>将集合属性快速转换为 ISelect 进行子查询操作。</p>
<h2 id="_11、wherecascade" tabindex="-1"> 11、WhereCascade</h2>
<p>多表查询时，像isdeleted每个表都给条件，挺麻烦的。WhereCascade使用后生成sql时，所有表都附上这个条件。</p>
<p>如：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>t1<span>></span></span></span><span>(</span><span>)</span>
<span>.</span><span><span>LeftJoin</span><span><span>&lt;</span>t2<span>></span></span></span><span>(</span><span>..</span><span>.</span><span>)</span>
<span>.</span><span>WhereCascade</span><span>(</span>x <span>=></span> x<span>.</span>IsDeleted <span>==</span> <span>false</span><span>)</span>
<span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>得到的 SQL：</p>
<div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span>
<span>FROM</span> t1
<span>LEFT</span> <span>JOIN</span> t2 <span>on</span> <span>.</span><span>.</span><span>.</span> <span>AND</span> <span>(</span>t2<span>.</span>IsDeleted <span>=</span> <span>0</span><span>)</span> 
<span>WHERE</span> t1<span>.</span>IsDeleted <span>=</span> <span>0</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>实体可附加表达式时才生效，支持子表查询。单次查询使用的表数目越多收益越大。</p>
<p>可应用范围：</p>
<ul>
<li>子查询，一对多、多对多、自定义的子查询；</li>
<li>Join 查询，导航属性、自定义的Join查询；</li>
<li>Include/<a href="/guide/select-include.html">IncludeMany</a> 的子集合查询；</li>
</ul>
<blockquote>
<p>暂时不支持【延时属性】的广播；</p>
</blockquote>
<blockquote>
<p>此功能和【过滤器】不同，用于单次多表查询条件的传播；</p>
</blockquote>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">返回数据 ✨</title>
    <id>https://freesql.net/guide/select-return-data.html</id>
    <link href="https://freesql.net/guide/select-return-data.html"/>
    <updated>2022-08-26T09:42:24.000Z</updated>
    <content type="html"><![CDATA[<h1 id="返回数据-✨" tabindex="-1"> 返回数据 ✨</h1>
<p>FreeSql 采用 ExpressionTree 优化读取速度，如果懂技术的你一定知道 .NET Core 技术下除了原生代码，最快就是 Emit 和 ExpressionTree。项目在初期使用的反射 + 缓存，虽然 .NET Core 优化了反射性能，但经过与 Dapper 性能测试对比之后，发现仍然有一定差距，改成 ExpresstionTree 后才与 Dapper 性能相当。FreeSql 支持的类型较多，实现 ExpressionTree 的复杂度较大，有兴趣的朋友可以翻阅源代码。</p>
<h2 id="_1、返回单条记录" tabindex="-1"> 1、返回单条记录</h2>
<div><pre><code><span>Topic</span> t1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToOne</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><blockquote>
<p>FreeSql 约定，ToOne/First 永远返回 null 或 有数据的实体对象，ToList 永远返回非 null 的 List&lt;实体类型&gt;</p>
</blockquote>
<h2 id="_2、返回-list" tabindex="-1"> 2、返回 List</h2>
<div><pre><code><span>List<span>&lt;</span>Topic<span>></span></span> t1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="_3、返回-treelist" tabindex="-1"> 3、返回 TreeList</h2>
<div><pre><code><span>List<span>&lt;</span>Category<span>></span></span> t2 <span>=</span> fsql<span>.</span>Select<span>&lt;</span>Category<span>></span><span>.</span><span>ToTreeList</span><span>(</span><span>)</span><span>;</span>
<span>List<span>&lt;</span>Category<span>></span></span> t3 <span>=</span> fsql<span>.</span>Select<span>&lt;</span>Category<span>></span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Name <span>=</span> <span>"家电"</span><span>)</span><span>.</span><span>AsTreeCte</span><span>(</span><span>)</span><span>.</span><span>ToTreeList</span><span>(</span><span>)</span><span>;</span>
<span>//v1.6.0 AsTreeCte() 递归CTE查询 家电 下的所有子分类</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><blockquote>
<p>查询数据加工为树型，注意：实体需要配置父子导航属性</p>
</blockquote>
<h2 id="_4、返回-list-导航属性的数据" tabindex="-1"> 4、返回 List + 导航属性的数据</h2>
<div><pre><code><span>List<span>&lt;</span>Topic<span>></span></span> t4 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>LeftJoin</span><span>(</span>a <span>=></span> a<span>.</span>Type<span>.</span>Id <span>==</span> a<span>.</span>TypeId<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//此时会查询 Topic普通字段 + 导航对象Type 字段</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><h2 id="_5、指定字段返回" tabindex="-1"> 5、指定字段返回</h2>
<div><pre><code><span>//返回一个字段</span>
<span>List<span>&lt;</span><span>int</span><span>></span></span> t5 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>;</span>

<span>//返回匿名类</span>
<span>List<span>&lt;</span>匿名类<span>></span></span> t6 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Id<span>,</span> a<span>.</span>Title <span>}</span><span>)</span><span>;</span>

<span>//返回元组</span>
<span>List<span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>)</span><span>></span></span> t7 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span><span>ToList</span><span><span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>)</span><span>></span></span></span><span>(</span><span>"id, title"</span><span>)</span><span>;</span>

<span>//返回导航属性</span>
<span>List<span>&lt;</span>匿名类<span>></span></span> t8 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
    a<span>.</span>Id<span>,</span> a<span>.</span>Title<span>,</span>
    a<span>.</span>Type <span>//导航属性</span>
<span>}</span><span>)</span><span>;</span>

<span>//返回SQL字段</span>
<span>List<span>&lt;</span>匿名类<span>></span></span> t9 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
    cstitle <span>=</span> <span>"substr(a.title, 0, 2)"</span><span>,</span> <span>//将 substr(a.title, 0, 2) 作为查询字段</span>
    csnow <span>=</span> Convert<span>.</span><span>ToDateTime</span><span>(</span><span>"now()"</span><span>)</span><span>,</span> <span>//将 now() 作为查询字段</span>
    <span>//奇思妙想：怎么查询开窗函数的结果</span>
<span>}</span><span>)</span><span>;</span>

<span>//返回子查询的字段</span>
<span>List<span>&lt;</span>匿名类<span>></span></span> t10 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
    a<span>.</span>Id<span>,</span>
    count <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>
    max <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Max</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
    min <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Min</span><span>(</span>b <span>=></span> b<span>.</span>Id<span>)</span><span>,</span>
    name <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>First</span><span>(</span>b <span>=></span> b<span>.</span>name<span>)</span>
<span>}</span><span>)</span><span>;</span>

<span>//返回子查询集合 v3.2.650+ 以下最多执行3次 SQL</span>
<span>List<span>&lt;</span>匿名类<span>></span></span> t11 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span>
    a<span>.</span>Id<span>,</span>
    list1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>,</span>
    list2 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T2<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>b <span>=></span> b<span>.</span>TopicId <span>==</span> a<span>.</span>Id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>常量机制早期留给了原生 SQL，如果真的需要返回该字符串：&quot;'xxx'&quot;</p>
</blockquote>
<h2 id="_6、忽略字段返回" tabindex="-1"> 6、忽略字段返回</h2>
<p>参考实现：<a href="https://github.com/dotnetcore/FreeSql/issues/528" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/issues/528</a></p>
<h2 id="_7、tosql" tabindex="-1"> 7、ToSql</h2>
<p>每个 ToList 都可以使用 ToSql 返回 SQL String，有两个选项：</p>
<ul>
<li>FieldAliasOptions.AsIndex(默认) 自动产生 as1, as2, as3 .... 字段别名，可以最大程度防止多表，存在相同字段的问题；</li>
<li>FieldAliasOptions.AsProperty 使用属性名作为字段别名，合适使用二次构造 SQL 再次执行；</li>
</ul>
<blockquote>
<p>v3.2.666 开启参数化查询功能后，使用 WithParameters 共享参数化，避免多个查询对象产生相同的参数名称，例如：<a href="%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2">UnionAll 联合查询</a></p>
</blockquote>
<h2 id="_8、执行-sql" tabindex="-1"> 8、执行 SQL</h2>
<div><pre><code><span>class</span> <span>xxx</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Path <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>

<span>List<span>&lt;</span>xxx<span>></span></span> t11 <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>xxx<span>></span></span></span><span>(</span><span>"select * from song"</span><span>)</span><span>;</span>
<span>List<span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span> <span>,</span><span>string</span><span>)</span><span>></span></span> t12 <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span><span>(</span><span>int</span><span>,</span> <span>string</span><span>,</span> <span>string</span><span>)</span><span>></span></span></span><span>(</span><span>"select * from song"</span><span>)</span><span>;</span>
<span>List<span>&lt;</span><span>dynamic</span><span>></span></span> t13 <span>=</span> fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span><span>dynamic</span><span>></span></span></span><span>(</span><span>"select * from song"</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>注意：Ado.Query 的实体特性是无效的，比如 [Column(Name = &quot;xxx&quot;)] 无效</p>
</blockquote>
<h2 id="_9、withsql" tabindex="-1"> 9、WithSql</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithSql</span><span>(</span><span>"select * from Topic where clicks > @val"</span><span>,</span> <span>new</span> <span>{</span> val <span>=</span> <span>10</span> <span>}</span><span>)</span>
  <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime`</span>
<span>//FROM (select * from Topic where clicks > @val) a</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>WithSql 使用多次为 UNION ALL 查询</p>
</blockquote>
<blockquote>
<p>v3.2.666 <a href="/guide/unionall.html">UnionAll 联合查询</a>、<a href="/guide/withtempquery.html">WithTempQuery + FromQuery 嵌套查询</a></p>
</blockquote>
<blockquote>
<p>v3.2.666 WithMemory 使用内存数据进行查询</p>
</blockquote>
<div><pre><code><span><span>var</span></span> list <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithMemory</span><span>(</span>list<span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime` </span>
<span>//FROM (</span>
<span>//  SELECT ...</span>
<span>//  UNION ALL</span>
<span>//  SELECT ...</span>
<span>//) a </span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_10、tochunk" tabindex="-1"> 10、ToChunk</h2>
<p>执行查询，分块返回数据，可减少内存开销。比如读取 10 万条数据，每次返回 100 条处理。</p>
<div><pre><code><span><span>var</span></span> testlist1 <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> testlist2 <span>=</span> <span>new</span> <span>List<span>&lt;</span>Song<span>></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>.</span><span>ToChunk</span><span>(</span><span>100</span><span>,</span> done <span>=></span> <span>{</span>
    testlist2<span>.</span><span>AddRange</span><span>(</span>done<span>.</span>Object<span>)</span><span>;</span>
    <span>//done.IsBreak = true; v1.7.0 停止读取</span>
<span>}</span><span>)</span><span>;</span>
<span>//这里示范，最终 testlist1 与 testlist2 返回的数据相同。</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_11、dto-映射查询" tabindex="-1"> 11、Dto 映射查询</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span><span>ToList</span><span><span>&lt;</span>Dto<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span>//情况1：Dto 与 Song 属性名相同的字段被查询，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span> <span>{</span> xxx <span>=</span> a<span>.</span>ext <span>}</span><span>)</span>
<span>//情况2：Dto 与 Song 属性名相同的字段被查询，纠正映射 ext，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span> <span>{</span> id <span>=</span> a<span>.</span>id <span>}</span><span>)</span>
<span>//情况3：Lambda 与 Song 类型一样，只查询指定字段 id，返回 List&lt;Song></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> id <span>=</span> a<span>.</span>id <span>}</span><span>)</span>
<span>//情况4：Lambda 匿名类型，只查询指定字段 id，返回 List&lt;匿名对象></span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>请仔细处理区别，请仔细处理区别，请仔细处理区别</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span><span>(</span>a<span>.</span>id<span>)</span><span>)</span>
<span>//情况5：只查询 id，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Dto</span><span>(</span>a<span>.</span>id<span>)</span> <span>{</span> xxx <span>=</span> a<span>.</span>ext <span>}</span><span>)</span>
<span>//情况6：查询 id, ext，返回 List&lt;Dto></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span><span>(</span>a<span>.</span>id<span>)</span><span>)</span>
<span>//情况7：查询 id，返回 List&lt;Song></span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span>a <span>=></span> <span>new</span> <span>Song</span><span>(</span>a<span>.</span>id<span>)</span> <span>{</span> xxx <span>=</span> a<span>.</span>ext <span>}</span><span>)</span>
<span>//情况8：查询 id, ext，返回 List&lt;Song></span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>GroupBy 所有方法不使用 DTO 映射规则</p>
</blockquote>
<p>这种映射支持单表/多表，在查询数据之前映射（不是先查询所有字段再到内存映射）</p>
<p>查找规则，查找属性名，会循环内部对象 _tables（join 查询后会增长），以 主表优先查，直到查到相同的字段。</p>
<p>如：</p>
<p>A, B, C 都有 id，Dto { id, a1, a2, b1, b2 }，<a href="http://A.id" target="_blank" rel="noopener noreferrer">A.id</a> 被映射。也可以指定 id = <a href="http://C.id" target="_blank" rel="noopener noreferrer">C.id</a> 映射。</p>
<p>DTO 查询只映射默认字段（普通属性），映射对象请使用：</p>
<blockquote>
<p>导航对象：ToList(a =&gt; new Dto { Catalog = a.Catalog })</p>
</blockquote>
<blockquote>
<p>多表对象：ToList((a, b) =&gt; new Dto { Catalog = b })</p>
</blockquote>
<h2 id="_12、api" tabindex="-1"> 12、API</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的SQL语句</td>
</tr>
<tr>
<td>ToList</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行SQL查询，返回 T1 实体所有字段的记录，若存在导航属性则一起查询返回，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToList&lt;Dto&gt;</td>
<td>List&lt;Dto&gt;</td>
<td>Lambda</td>
<td>执行SQL查询，返回指定字段或Dto映射的记录，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>string field</td>
<td>执行SQL查询，返回 field 指定字段的记录，并以元组或基础类型(int,string,long)接收，记录不存在时返回 Count 为 0 的列表</td>
</tr>
<tr>
<td>ToOne</td>
<td>T1</td>
<td></td>
<td>执行SQL查询，返回 T1 实体所有字段的第一条记录，记录不存在时返回 null</td>
</tr>
<tr>
<td>ToChunk</td>
<td>&lt;空&gt;</td>
<td>int size, Action&lt;FetchCallbackArgs&lt;List&lt;T1&gt;&gt;&gt; done</td>
<td>执行SQL查询，分块返回数据，可减少内存开销。比如读取10万条数据，每次返回100条处理。</td>
</tr>
<tr>
<td>Any</td>
<td>bool</td>
<td></td>
<td>执行SQL查询，是否有记录</td>
</tr>
<tr>
<td>Sum</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求和</td>
</tr>
<tr>
<td>Min</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最小值</td>
</tr>
<tr>
<td>Max</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最大值</td>
</tr>
<tr>
<td>Avg</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求平均值</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">单表查询</title>
    <id>https://freesql.net/guide/select-single-table.html</id>
    <link href="https://freesql.net/guide/select-single-table.html"/>
    <updated>2022-08-26T09:39:37.000Z</updated>
    <content type="html"><![CDATA[<h1 id="单表查询" tabindex="-1"> 单表查询</h1>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>)</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>public</span> <span><span>int</span></span> CategoryId <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="单表" tabindex="-1"> 单表</h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>10</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>///SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (a.`Id` = 10)</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>10</span> <span>&amp;&amp;</span> a<span>.</span>Id <span>></span> <span>10</span> <span>||</span> a<span>.</span>Clicks <span>></span> <span>100</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>///SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (a.`Id` = 10 AND a.`Id` > 10 OR a.`Clicks` > 100)</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> <span>new</span> <span>[</span><span>]</span><span>{</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>}</span><span>.</span><span>Contains</span><span>(</span>a<span>.</span>Id<span>)</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime`</span>
<span>//FROM `Topic` a</span>
<span>//WHERE (a.`Id` in (1,2,3))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="withsql" tabindex="-1"> <a href="/guide/withsql.html">WithSql</a></h2>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithSql</span><span>(</span><span>"select * from Topic where clicks > @val"</span><span>,</span> <span>new</span> <span>{</span> val <span>=</span> <span>10</span> <span>}</span><span>)</span>
  <span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime` </span>
<span>//FROM (select * from Topic where clicks > @val) a </span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>关于<a href="/guide/withsql.html">WithSql</a>的详情文档， 使用多次为 UNION ALL 查询</p>
</blockquote>
<blockquote>
<p>v3.2.666 <a href="/guide/unionall.html">UnionAll 联合查询</a>、<a href="/guide/withtempquery.html">WithTempQuery + FromQuery 嵌套查询</a></p>
</blockquote>
<blockquote>
<p>v3.2.666 WithMemory 使用内存数据进行查询</p>
</blockquote>
<blockquote>
<p>假设跨数据库服务器，或者数据表被缓存过，WithMemory 便可以实现数据表与内存关联查询。</p>
</blockquote>
<div><pre><code><span><span>var</span></span> list <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>
list<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>WithMemory</span><span>(</span>list<span>)</span>
  <span>.</span><span>ToList</span><span>(</span><span>)</span>
<span>//SELECT a.`Id`, a.`Clicks`, a.`CategoryId`, a.`Title`, a.`CreateTime` </span>
<span>//FROM (</span>
<span>//  SELECT ...</span>
<span>//  UNION ALL</span>
<span>//  SELECT ...</span>
<span>//) a </span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div>]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">查询</title>
    <id>https://freesql.net/guide/select.html</id>
    <link href="https://freesql.net/guide/select.html"/>
    <updated>2022-08-26T10:36:26.000Z</updated>
    <content type="html"><![CDATA[<h1 id="查询" tabindex="-1"> 查询</h1>
<p>FreeSql 在查询数据下足了功夫，链式查询语法、多表查询、表达式函数支持得非常到位。</p>
<ul>
<li><a href="/guide/paging.html">分页查询</a></li>
<li><a href="/guide/select-single-table.html">单表查询</a></li>
<li><a href="/guide/select-multi-table.html">多表查询</a></li>
<li><a href="/guide/withtempquery.html">嵌套查询</a></li>
<li><a href="/guide/select-group-by.html">分组聚合查询</a></li>
<li><a href="/guide/select-return-data.html">返回数据</a></li>
<li><a href="/guide/linq-to-sql.html">LinqToSql</a></li>
<li><a href="/guide/repository.html">仓储层 Repository</a></li>
<li><a href="/guide/filters.html">过滤器</a></li>
<li><a href="/guide/select-lazy-loading.html">延时加载</a></li>
<li><a href="/guide/select-include.html">贪婪加载</a></li>
<li><a href="/guide/expression-function.html">表达式函数</a></li>
<li><a href="/guide/read-write-splitting.html">读写分离</a></li>
<li><a href="/guide/performance.html">性能</a></li>
<li><a href="/guide/sharding.html">分表分库</a></li>
<li><a href="/guide/multi-tenancy.html">多租户</a></li>
</ul>
<h2 id="特别介绍-wheredynamicfilter" tabindex="-1"> 特别介绍 WhereDynamicFilter</h2>
<p><a href="https://www.cnblogs.com/FreeSql/p/16485310.html" target="_blank" rel="noopener noreferrer">《高效理解 FreeSql WhereDynamicFilter，深入了解设计初衷》</a></p>
<p>ISelect.WhereDynamicFilter 方法实现动态过滤条件（与前端交互），支持的操作符：</p>
<ul>
<li>Contains/StartsWith/EndsWith/NotContains/NotStartsWith/NotEndsWith：包含/不包含，like '%xx%'，或者 like 'xx%'，或者 like '%xx'</li>
<li>Equal/NotEqual：等于/不等于</li>
<li>GreaterThan/GreaterThanOrEqual：大于/大于等于</li>
<li>LessThan/LessThanOrEqual：小于/小于等于</li>
<li>Range：范围查询</li>
<li>DateRange：日期范围，有特殊处理 value[1] + 1</li>
<li>Any/NotAny：是否符合 value 中任何一项（直白的说是 SQL IN）</li>
</ul>
<div><pre><code><span>DynamicFilterInfo</span> dyfilter <span>=</span> JsonConvert<span>.</span><span><span>DeserializeObject</span><span><span>&lt;</span>DynamicFilterInfo<span>></span></span></span><span>(</span><span>@"
{
    ""Logic"": ""And"",
    ""Filters"":
    [
        { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 1 },
        {
            ""Logic"": ""Or"",
            ""Filters"":
            [
                { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 2 },
                { ""Field"": ""id"", ""Operator"": ""Equals"", ""Value"": 3 }
            ]
        }
    ]
}"</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>Region<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>WhereDynamicFilter</span><span>(</span>dyfilter<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//WHERE id = 1 AND (id = 2 OR id = 3)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>动态排序：ISelect.OrderByPropertyName(&quot;Parent.Code&quot;)</p>
</blockquote>
<h2 id="api" tabindex="-1"> API</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
<td></td>
</tr>
<tr>
<td>ToList</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 查询，返回 T1 实体所有字段的记录，若存在导航属性则一起查询返回，记录不存在时返回 Count 为 0 的列表</td>
<td></td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>Lambda</td>
<td>执行 SQL 查询，返回指定字段的记录，记录不存在时返回 Count 为 0 的列表</td>
<td></td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>string field</td>
<td>执行 SQL 查询，返回 field 指定字段的记录，并以元组或基础类型(int,string,long)接收，记录不存在时返回 Count 为 0 的列表</td>
<td></td>
</tr>
<tr>
<td>ToOne</td>
<td>T1</td>
<td></td>
<td>执行 SQL 查询，返回 T1 实体所有字段的第一条记录，记录不存在时返回 null</td>
<td></td>
</tr>
<tr>
<td>ToAggregate&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>Lambda</td>
<td>执行 SQL 查询，返回指定字段的聚合结果（适合不需要 GroupBy 的场景）</td>
<td></td>
</tr>
<tr>
<td>Any</td>
<td>bool</td>
<td></td>
<td>执行 SQL 查询，是否有记录</td>
<td></td>
</tr>
<tr>
<td>Sum</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求和</td>
<td></td>
</tr>
<tr>
<td>Min</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最小值</td>
<td></td>
</tr>
<tr>
<td>Max</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最大值</td>
<td></td>
</tr>
<tr>
<td>Avg</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求平均值</td>
<td></td>
</tr>
<tr>
<td>【分页】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Count</td>
<td>long</td>
<td></td>
<td>查询的记录数量</td>
<td></td>
</tr>
<tr>
<td>Count</td>
<td>&lt;this&gt;</td>
<td>out long</td>
<td>查询的记录数量，以参数 out 形式返回</td>
<td></td>
</tr>
<tr>
<td>Skip</td>
<td>&lt;this&gt;</td>
<td>int offset</td>
<td>查询向后偏移行数</td>
<td></td>
</tr>
<tr>
<td>Offset</td>
<td>&lt;this&gt;</td>
<td>int offset</td>
<td>查询向后偏移行数</td>
<td></td>
</tr>
<tr>
<td>Limit</td>
<td>&lt;this&gt;</td>
<td>int limit</td>
<td>查询多少条数据</td>
<td></td>
</tr>
<tr>
<td>Take</td>
<td>&lt;this&gt;</td>
<td>int limit</td>
<td>查询多少条数据</td>
<td></td>
</tr>
<tr>
<td>Page</td>
<td>&lt;this&gt;</td>
<td>int pageIndex, int pageSize</td>
<td>分页</td>
<td></td>
</tr>
<tr>
<td>【条件】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>支持多表查询表达式，多次使用相当于 AND</td>
<td></td>
</tr>
<tr>
<td>WhereIf</td>
<td>&lt;this&gt;</td>
<td>bool, Lambda</td>
<td>支持多表查询表达式</td>
<td></td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>原生 sql 语法条件，Where(&quot;id = @id&quot;, new { id = 1 } ,<a href="/guide/ado.html#%E5%8F%82%E6%95%B0%E5%8C%96">注意前缀@,根据具体数据库决定</a> 其他地方不再说明。同理 )</td>
<td></td>
</tr>
<tr>
<td>WhereIf</td>
<td>&lt;this&gt;</td>
<td>bool, string, parms</td>
<td id="">原生 sql 语法条件，WhereIf(true, &quot;id = @id&quot;, new</td>
<td></td>
</tr>
<tr>
<td>WhereCascade</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>实现多表查询时，向每个表中附加条件</td>
<td></td>
</tr>
<tr>
<td>WhereDynamicFilter</td>
<td>&lt;this&gt;</td>
<td>DynamicFilterInfo</td>
<td>动态过滤条件(与前端交互)</td>
<td></td>
</tr>
<tr>
<td>【分组】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GroupBy</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按选择的列分组，GroupBy(a =&gt; <a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>)</td>
<td>GroupBy(a =&gt; new{<a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>,a.Time})</td>
</tr>
<tr>
<td>GroupBy</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生 sql 语法分组，GroupBy(&quot;concat(name, @cc)&quot;, new { cc = 1 })</td>
<td></td>
</tr>
<tr>
<td>Having</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生 sql 语法聚合条件过滤，Having(&quot;count(name) = @cc&quot;, new { cc = 1 })</td>
<td></td>
</tr>
<tr>
<td>Disdinct</td>
<td>&lt;this&gt;</td>
<td></td>
<td>.Distinct().ToList(x =&gt; x.GroupName) 是对指定字段</td>
<td></td>
</tr>
<tr>
<td>【排序】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OrderBy</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按列排序，OrderBy(a =&gt; a.Time)，可多次使用</td>
<td></td>
</tr>
<tr>
<td>OrderByDescending</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按列倒向排序，OrderByDescending(a =&gt; a.Time)</td>
<td></td>
</tr>
<tr>
<td>OrderBy</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生 sql 语法排序，OrderBy(&quot;count(name) + @cc&quot;, new { cc = 1 })</td>
<td></td>
</tr>
<tr>
<td>OrderByPropertyName</td>
<td>string, bool</td>
<td>按属性名字符串排序（支持导航属性）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>【联表】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LeftJoin</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>左联查询，可使用导航属性，或指定关联的实体类型</td>
<td></td>
</tr>
<tr>
<td>InnerJoin</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>联接查询，可使用导航属性，或指定关联的实体类型</td>
<td></td>
</tr>
<tr>
<td>RightJoin</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>右联查询，可使用导航属性，或指定关联的实体类型</td>
<td></td>
</tr>
<tr>
<td>LeftJoin</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>左联查询，使用原生 sql 语法，LeftJoin(&quot;type b on <a href="http://b.id" target="_blank" rel="noopener noreferrer">b.id</a> = <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a> and b.clicks &gt; @clicks&quot;, new { clicks = 1 })</td>
<td></td>
</tr>
<tr>
<td>InnerJoin</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>联接查询，使用原生 sql 语法，InnerJoin(&quot;type b on <a href="http://b.id" target="_blank" rel="noopener noreferrer">b.id</a> = <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a> and b.clicks &gt; @clicks&quot;, new { clicks = 1 })</td>
<td></td>
</tr>
<tr>
<td>RightJoin</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>右联查询，使用原生 sql 语法，RightJoin(&quot;type b on <a href="http://b.id" target="_blank" rel="noopener noreferrer">b.id</a> = <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a> and b.clicks &gt; @clicks&quot;, new { clicks = 1 })</td>
<td></td>
</tr>
<tr>
<td>From</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>多表查询，3 个表以上使用非常方便，目前设计最大支持 10 个表</td>
<td></td>
</tr>
<tr>
<td>FromQuery</td>
<td>ISelect&lt;T1, T2&gt;</td>
<td>ISelect&lt;T2&gt;</td>
<td>单表连成双表查询</td>
<td></td>
</tr>
<tr>
<td>WithTempQuery</td>
<td>ISelect&lt;T1&gt;</td>
<td>Lambda</td>
<td>将单表或多表查询嵌套成单表查询</td>
<td></td>
</tr>
<tr>
<td>WithMemory</td>
<td>ISelect&lt;T1&gt;</td>
<td>List&lt;T1&gt;</td>
<td>使用内存数据查询</td>
<td></td>
</tr>
<tr>
<td>UnionAll</td>
<td>ISelect&lt;T1&gt;</td>
<td>ISelect&lt;T1&gt;[]</td>
<td>联合查询</td>
<td></td>
</tr>
<tr>
<td>【其他】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>As</td>
<td>&lt;this&gt;</td>
<td>string alias = &quot;a&quot;</td>
<td>指定别名</td>
<td></td>
</tr>
<tr>
<td>Master</td>
<td>&lt;this&gt;</td>
<td></td>
<td>指定从主库查询（默认查询从库）</td>
<td></td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
<td></td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
<td></td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
<td></td>
</tr>
<tr>
<td>WithLock</td>
<td>&lt;this&gt;</td>
<td>Enum</td>
<td>SqlServer NoLock 等特有的设置</td>
<td></td>
</tr>
<tr>
<td>ForUpdate</td>
<td>&lt;this&gt;</td>
<td>bool</td>
<td>排他更新锁，对不同的数据库已作适配，详细说明见注释</td>
<td></td>
</tr>
<tr>
<td>AsQueryable</td>
<td>IQueryable</td>
<td></td>
<td>将 ISelect 转换为 IQueryable，此方法主要用于扩展，比如：abp IRepository GetAll() 接口方法需要返回 IQueryable 对象。注意：IQueryable 方法污染较为严重，请尽量避免此转换</td>
<td></td>
</tr>
<tr>
<td>ToTreeList()</td>
<td>List&lt;TEntity&gt;</td>
<td>无</td>
<td>将父子关系的数据以 TreeList 的形式返回</td>
<td></td>
</tr>
<tr>
<td>AsTreeCte()</td>
<td>ISelect</td>
<td>(up, pathSelector, level)</td>
<td>递归查询父子关系表</td>
<td></td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">分表分库</title>
    <id>https://freesql.net/guide/sharding.html</id>
    <link href="https://freesql.net/guide/sharding.html"/>
    <updated>2022-08-25T02:13:17.000Z</updated>
    <content type="html"><![CDATA[<h1 id="分表分库" tabindex="-1"> 分表分库</h1>
<h2 id="理论知识" tabindex="-1"> 理论知识</h2>
<p>分表 - 从表面意思上看呢，就是把一张表分成 N 多个小表，每一个小表都是完整的一张表。分表后数据都是存放在分表里，总表只是一个外壳，存取数据发生在一个一个的分表里面。分表后单表的并发能力提高了，磁盘 I/O 性能也提高了。并发能力为什么提高了呢，因为查寻一次所花的时间变短了，如果出现高并发的话，总表可以根据不同 的查询，将并发压力分到不同的小表里面。</p>
<p>分库 - 把原本存储于一个库的数据分块存储到多个库上，把原本存储于一个表的数据分块存储到多个表上。数据库中的数据量不一定是可控的，在未进行分表分库的情况下，随着时间和业务的发展，库中的表会越来越多，表中的数据量也会越来越大，相应地，数据操作，增删改查的开销也会越来越大；另外，一台服务器的资源（CPU、磁盘、内存、IO 等）是有限的，最终数据库所能承载的数据量、数据处理能力都将遭遇瓶颈。</p>
<h2 id="手工分表-astable" tabindex="-1"> 手工分表 AsTable</h2>
<p>FreeSql 原生用法、FreeSql.Repository 仓储用法 都提供了 AsTable 方法对分表进行 CRUD 操作，例如：</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Log<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repo<span>.</span><span>AsTable</span><span>(</span>oldname <span>=></span> <span><span>$"</span><span><span>{</span><span>oldname</span><span>}</span></span><span>_201903"</span></span><span>)</span><span>;</span> <span>//对 Log_201903 表 CRUD</span>

repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Log</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>跨库，但是在同一个数据库服务器下，也可以使用 AsTable(oldname =&gt; $&quot;db2.dbo.{oldname}&quot;)</p>
<div><pre><code><span>//跨表查询</span>
<span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>AsTable</span><span>(</span><span>(</span>type<span>,</span> oldname<span>)</span> <span>=></span> <span>"table_1"</span><span>)</span>
    <span>.</span><span>AsTable</span><span>(</span><span>(</span>type<span>,</span> oldname<span>)</span> <span>=></span> <span>"table_2"</span><span>)</span>
    <span>.</span><span>ToSql</span><span>(</span>a <span>=></span> a<span>.</span>Id<span>)</span><span>;</span>

<span>//select * from (SELECT a."Id" as1 FROM "table_1" a) ftb</span>
<span>//UNION ALL</span>
<span>//select * from (SELECT a."Id" as1 FROM "table_2" a) ftb</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>分表总结：</p>
<ul>
<li>分表、相同服务器跨库 可以使用 AsTable 进行 CRUD；</li>
<li>AsTable CodeFirst 会自动创建不存在的分表；</li>
<li>不可在分表分库的实体类型中使用《延时加载》；</li>
</ul>
<p>SqlServer 跨库事务 可以使用 TransactionScope，如下：</p>
<div><pre><code><span><span>var</span></span> repoLog <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Log<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> repoComment <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Comment<span>></span></span></span><span>(</span><span>)</span><span>;</span>
repoLog<span>.</span><span>AsTable</span><span>(</span>oldname <span>=></span> <span><span>$"</span><span><span>{</span><span><span>201903</span></span><span>}</span></span><span>.dbo.</span><span><span>{</span><span>oldname</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
repoComment<span>.</span><span>AsTable</span><span>(</span>oldname <span>=></span> <span><span>$"</span><span><span>{</span><span><span>201903</span></span><span>}</span></span><span>.dbo.</span><span><span>{</span><span>oldname</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>

<span>using</span> <span>(</span><span>TransactionScope</span> ts <span>=</span> <span>new</span> <span>TransactionScope</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    repoComment<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Comment</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>
    repoLog<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Log</span> <span>{</span> <span>..</span><span>.</span> <span>}</span><span>)</span><span>;</span>
    ts<span>.</span><span>Complete</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>分布式数据库 TCC/SAGA 方案请移步：<a href="https://github.com/2881099/FreeSql.Cloud" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.Cloud</a></p>
<h2 id="自动分表-astable-beta" tabindex="-1"> 自动分表 AsTable (beta)</h2>
<p>【自动分表】不同于 CURD.AsTable 方法，目前第一期完成按【时间】自动分表（不支持分库）。</p>
<p>欢迎积极参与测试、反馈，请优先使用源代码进行测试，方便反馈定位问题，谢谢。</p>
<div><pre><code><span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"as_table_log_{yyyyMM}"</span><span>,</span> AsTable <span>=</span> <span>"createtime=2022-1-1(1 month)"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>AsTableLog</span>
<span>{</span>
    <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> msg <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> createtime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>从 2022-1-1 开始至当前时间，每月创建一个分表，按 createtime 字段分表</p>
</blockquote>
<blockquote>
<p>若最大日期大于当前时间，可手工扩容分表：</p>
</blockquote>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span>GetTableByEntity</span><span>(</span><span>typeof</span><span>(</span><span>AsTableLog</span><span>)</span><span>)</span>
    <span>.</span>AsTableImpl
    <span>.</span><span>GetTableNameByColumnValue</span><span>(</span>DateTime<span>.</span><span>Parse</span><span>(</span><span>"2023-7-1"</span><span>)</span><span>,</span> <span>autoExpand</span><span>:</span> <span>true</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>示范</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(1 year)&quot;</td>
<td>一年一个分表</td>
</tr>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(2 year)&quot;</td>
<td>两年一个分表</td>
</tr>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(1 month)&quot;</td>
<td>一月一个分表</td>
</tr>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(3 month)&quot;</td>
<td>三月一个分表</td>
</tr>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(1 day)&quot;</td>
<td>一天一个分表</td>
</tr>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(7 day)&quot;</td>
<td>七天一个分表</td>
</tr>
<tr>
<td>AsTable = &quot;createtime=2022-1-1(12 hour)&quot;</td>
<td>12小时一个分表</td>
</tr>
</tbody>
</table>
<p>详细介绍：<a href="https://github.com/dotnetcore/FreeSql/discussions/1066" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/discussions/1066</a></p>
<h2 id="【分库】常规技巧" tabindex="-1"> 【分库】常规技巧</h2>
<p>1、Sqlite 跨库</p>
<div><pre><code><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"data source=document.db;attachs=db2.db,db3.db"</span><span>)</span>

<span>[</span><span>Table</span><span>(</span>Name <span>=</span> <span>"db2.Comment"</span><span>)</span><span>]</span>
<span>class</span> <span>Comment</span> <span>{</span> <span>..</span><span>.</span> <span>}</span>

<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"db3.Comment"</span><span>)</span></span></span><span>]</span>
<span>class</span> <span>Topic</span> <span>{</span> <span>..</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>SQLite 跨库操作是 FreeSql 独有的功能，连接串 attachs 参数值逗号分割。</p>
<p>2、SqlServer 跨库</p>
<div><pre><code><span>//相同数据库实例，跨库访问</span>
<span>[</span><span>Table</span><span>(</span>Name <span>=</span> <span>"db2.dbo.tablename"</span><span>)</span><span>]</span>
<span>class</span> <span>Comment</span> <span>{</span> <span>..</span><span>.</span> <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div></div></div><p>不同数据库实例，可使用 SQLServer linkserver 技术，具体请百度了解。</p>
<p>3、其他</p>
<p>几乎每种数据库都支持 dbo.table 的方式访问：</p>
<ul>
<li>MySql -&gt; dbname.tabname</li>
<li>PostgreSQL/SqlServer -&gt; dbname.schema.tbname</li>
</ul>
<p>可将其设置到 <code>[Table(Name = ...)]</code> 特性，或者使用 <code>.AsTable</code> 方法设置本次生效。</p>
<h2 id="【分库】使用-freesql-cloud" tabindex="-1"> 【分库】使用 FreeSql.Cloud</h2>
<p>为 FreeSql 提供跨数据库访问，分布式事务TCC、SAGA解决方案，支持 .NET Core 2.1+, .NET Framework 4.0+.</p>
<p>开源地址：<a href="https://github.com/2881099/FreeSql.Cloud" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.Cloud</a></p>
<blockquote>
<p>dotnet add package FreeSql.Cloud</p>
</blockquote>
<p>or</p>
<blockquote>
<p>Install-Package FreeSql.Cloud</p>
</blockquote>
<div><pre><code><span>public</span> <span>enum</span> <span>DbEnum</span> <span>{</span> db1<span>,</span> db2 <span>}</span>
<span>public</span> <span>class</span> <span>FreeSqlCloud</span> <span>:</span> <span><span>FreeSqlCloud<span>&lt;</span>DbEnum<span>></span></span></span> <span>//DbEnum 换成 string 就是多租户管理</span>
<span>{</span>
    <span>public</span> <span>FreeSqlCloud</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>null</span><span>)</span> <span>{</span> <span>}</span>
    <span>public</span> <span>FreeSqlCloud</span><span>(</span><span><span>string</span></span> distributeKey<span>)</span> <span>:</span> <span>base</span><span>(</span>distributeKey<span>)</span> <span>{</span> <span>}</span>
<span>}</span>

<span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlCloud</span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span>DistributeTrace <span>=</span> log <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span>log<span>.</span><span>Split</span><span>(</span><span>'\n'</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>Trim</span><span>(</span><span>)</span><span>)</span><span>;</span>

fsql<span>.</span><span>Register</span><span>(</span>DbEnum<span>.</span>db1<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=db1.db"</span><span>)</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>
fsql<span>.</span><span>Register</span><span>(</span>DbEnum<span>.</span>db2<span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSqlBuilder</span><span>(</span><span>)</span><span>.</span><span>UseConnectionString</span><span>(</span>DataType<span>.</span>Sqlite<span>,</span> <span>@"Data Source=db2.db"</span><span>)</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span>

services<span>.</span><span><span>AddSingleton</span><span><span>&lt;</span>IFreeSql<span>></span></span></span><span>(</span>fsql<span>)</span><span>;</span>
services<span>.</span><span>AddSingleton</span><span>(</span>fsql<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>FreeSqlCloud 必须定义成单例模式</p>
</blockquote>
<blockquote>
<p>new FreeSqlCloud() 多连接管理</p>
</blockquote>
<blockquote>
<p>new FreeSqlCloud(&quot;myapp&quot;) 开启 TCC/SAGA 事务生效</p>
</blockquote>
<p>FreeSqlCloud 的访问方式和 IFreeSql 一样：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Insert</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span><span>Delete</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>

<span>//...</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>1、切换数据库（多线程安全）：</p>
<div><pre><code>fsql<span>.</span><span>Change</span><span>(</span>DbEnum<span>.</span>db2<span>)</span><span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span>//同一线程，或异步await 后续 fsql.Select/Insert/Update/Delete 操作是 db2</span>

fsql<span>.</span><span>Use</span><span>(</span>DbEnum<span>.</span>db2<span>)</span><span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span>//单次有效</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>2、自动定向数据库配置：</p>
<div><pre><code>fsql<span>.</span>EntitySteering <span>=</span> <span>(</span>_<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
    <span>if</span> <span>(</span>e<span>.</span>EntityType <span>==</span> <span>typeof</span><span>(</span><span>User</span><span>)</span><span>)</span> e<span>.</span>DBKey <span>=</span> DbEnum<span>.</span>db2<span>;</span>
    <span>//查询 User 自动定向 db2</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>3、静态仓储对象</p>
<p>FreeSql.Repository/UnitOfWorkManager 对象创建时固定了 IFreeSql，因此无法跟随 FreeSqlCloud 切换数据库。</p>
<blockquote>
<p>注意：是同一个对象实例创建之后，无法跟随切换，创建新对象实例不受影响。</p>
</blockquote>
<p>租户分库场景 Repository/UnitOfWorkManager 创建之前，先调用 fsql.Change 切换好数据库。</p>
<p><a href="/guide/unitofwork-manager.html#freesql-cloud-%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-unitofworkmanager">《FreeSql.Cloud 如何使用 UnitOfWorkManager 实现 AOP 事务？》</a></p>
<p>4、动态创建对象（不推荐）</p>
<p>但是。。。仍然有一种特殊需求，Repository 在创建之后，仍然能跟随 fsql.Change 切换数据库。</p>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetCloudRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>;</span>
fsql<span>.</span><span>Change</span><span>(</span>DbEnum<span>.</span>db2<span>)</span><span>;</span>
Console<span>.</span><span>WriteLine</span><span>(</span>repo<span>.</span>Orm<span>.</span>Ado<span>.</span>ConnectionString<span>)</span><span>;</span> <span>//repo -> db2</span>
fsql<span>.</span><span>Change</span><span>(</span>DbEnum<span>.</span>db1<span>)</span><span>;</span>
Console<span>.</span><span>WriteLine</span><span>(</span>repo<span>.</span>Orm<span>.</span>Ado<span>.</span>ConnectionString<span>)</span><span>;</span> <span>//repo -> db1</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>这种机制太不可控，所以只做了简单的扩展方法创建，并不推荐 Ioc 注入。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">事务</title>
    <id>https://freesql.net/guide/transaction.html</id>
    <link href="https://freesql.net/guide/transaction.html"/>
    <updated>2022-08-19T12:05:37.000Z</updated>
    <content type="html"><![CDATA[<h1 id="事务" tabindex="-1"> 事务</h1>
<p>本文所有内容基于单机数据库事务，分布式数据库 TCC/SAGA 方案请移步：<a href="https://github.com/2881099/FreeSql.Cloud" target="_blank" rel="noopener noreferrer">https://github.com/2881099/FreeSql.Cloud</a></p>
<h2 id="_0、unitofworkmanager跨方法异步" tabindex="-1"> 0、UnitOfWorkManager跨方法异步</h2>
<ul>
<li><a href="/guide/unitofwork-manager.html">AOP + FreeSql 基于特性标签实现跨方法异步事务</a></li>
</ul>
<h2 id="_1、unitofwork-事务" tabindex="-1"> 1、UnitOfWork 事务</h2>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
  <span><span>var</span></span> songRepo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>;</span>
  <span><span>var</span></span> userRepo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>;</span>
  songRepo<span>.</span>UnitOfWork <span>=</span> uow<span>;</span> <span>//手工绑定工作单元</span>
  userRepo<span>.</span>UnitOfWork <span>=</span> uow<span>;</span>

  songRepo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Song</span><span>(</span><span>)</span><span>)</span><span>;</span>
  userRepo<span>.</span><span>Update</span><span>(</span><span>..</span><span>.</span><span>)</span><span>;</span>

  uow<span>.</span>Orm<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Song</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
  <span>//注意：uow.Orm 和 fsql 都是 IFreeSql</span>
  <span>//uow.Orm CRUD 与 uow 是一个事务（理解为临时 IFreeSql）</span>
  <span>//fsql CRUD 与 uow 不在一个事务</span>

  uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_2、dbcontext-事务" tabindex="-1"> 2、DbContext 事务</h2>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> ctx <span>=</span> fsql<span>.</span><span>CreateDbContext</span><span>(</span><span>)</span><span>)</span> <span>{</span>
  <span><span>var</span></span> song <span>=</span> ctx<span>.</span><span><span>Set</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>;</span>
  <span><span>var</span></span> user <span>=</span> ctx<span>.</span><span><span>Set</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>;</span>

  song<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Song</span><span>(</span><span>)</span><span>)</span><span>;</span>
  user<span>.</span><span>Update</span><span>(</span><span>..</span><span>.</span><span>)</span><span>;</span>

  ctx<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_3、同线程事务" tabindex="-1"> 3、同线程事务</h2>
<p>同线程事务，由 fsql.Transaction 管理事务提交回滚（缺点：不支持异步），比较适合 WinForm/WPF UI 主线程使用事务的场景。</p>
<p>用户购买了价值 100 元的商品：扣余额、扣库存。</p>
<div><pre><code>fsql<span>.</span><span>Transaction</span><span>(</span><span>(</span><span>)</span> <span>=></span>  <span>{</span>
  <span>//fsql.Ado.TransactionCurrentThread 获得当前事务对象</span>

  <span><span>var</span></span> affrows <span>=</span> fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Wealth <span>-</span> <span>100</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Wealth <span>>=</span> <span>100</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
    <span>//判断别让用户余额扣成负数</span>

  <span>if</span> <span>(</span>affrows <span>&lt;</span> <span>1</span><span>)</span>
    <span>throw</span> <span>new</span> <span>Exception</span><span>(</span><span>"用户余额不足"</span><span>)</span><span>;</span>
    <span>//抛出异常，回滚事务，事务退出</span>

  affrows <span>=</span> fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Goods<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Stock <span>-</span> <span>1</span><span>)</span>
    <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Stock <span>>=</span> <span>1</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
    <span>//判断别让用库存扣成负数</span>

  <span>if</span> <span>(</span>affrows <span>&lt;</span> <span>1</span><span>)</span>
    <span>throw</span> <span>new</span> <span>Exception</span><span>(</span><span>"商品库存不足"</span><span>)</span><span>;</span>
    <span>//抛出异常，回滚事务，事务退出</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>同线程事务使用简单，需要注意的限制：</p>
<ul>
<li>
<p>事务对象在线程挂载，每个线程只可开启一个事务连接，嵌套使用的是同一个事务；</p>
</li>
<li>
<p>事务体内代码不可以切换线程，因此不可使用任何异步方法，包括 FreeSql 提供的数据库异步方法（可以使用任何 Curd 同步方法）；</p>
</li>
</ul>
<h2 id="_4、外部事务" tabindex="-1"> 4、外部事务</h2>
<p>在与其他开源项目一起使用时，事务由外部开启，使用 WithTransaction 将事务对象传入执行。</p>
<div><pre><code>    <span>await</span> fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>xxx<span>></span></span></span><span>(</span><span>)</span>
    <span>.</span><span>WithTransaction</span><span>(</span>指定事务<span>)</span>
    <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Clicks <span>+</span> <span>1</span><span>)</span>
    <span>.</span><span>ExecuteAffrowsAsync</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>ISelect、IInsert、IUpdate、IDelete，都支持 WithTransaction 方法。</p>
<h3 id="获取dbtransaction" tabindex="-1"> 获取DbTransaction</h3>
<ul>
<li>异步方法</li>
</ul>
<div><pre><code>    <span>using</span> <span>Object<span>&lt;</span>DbConnection<span>></span></span> conn <span>=</span> <span>await</span> _freeSql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>GetAsync</span><span>(</span><span>)</span><span>;</span>
    <span>await</span> <span>using</span> <span>DbTransaction</span> transaction <span>=</span> <span>await</span> conn<span>.</span>Value<span>.</span><span>BeginTransactionAsync</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ul>
<li>同步方法(using新语法)</li>
</ul>
<div><pre><code>    <span>using</span> <span>Object<span>&lt;</span>DbConnection<span>></span></span> conn <span>=</span> _freeSql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>;</span>
    <span>using</span> <span>DbTransaction</span> transaction <span>=</span> conn<span>.</span>Value<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ul>
<li>同步方法(using旧语法)</li>
</ul>
<div><pre><code>    <span>using</span><span>(</span><span>Object<span>&lt;</span>DbConnection<span>></span></span> conn <span>=</span> _freeSql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>)</span>
    <span>{</span>
        <span>using</span><span>(</span><span>DbTransaction</span> transaction <span>=</span> conn<span>.</span>Value<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>)</span>
        <span>{</span>
            <span>..</span><span>.</span>
        <span>}</span>
    <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h3 id="示例" tabindex="-1"> 示例</h3>
<div><pre><code><span>public</span> <span>async</span> <span>Task</span> <span>CreateAsync</span><span>(</span><span>CreateGroupDto</span> inputDto<span>)</span>
<span>{</span>
    <span>using</span> <span>Object<span>&lt;</span>DbConnection<span>></span></span> conn <span>=</span> _freeSql<span>.</span>Ado<span>.</span>MasterPool<span>.</span><span>Get</span><span>(</span><span>)</span><span>;</span>
    <span>using</span> <span>DbTransaction</span> transaction <span>=</span> conn<span>.</span>Value<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>;</span>
    <span>try</span>
    <span>{</span>
        <span>await</span> fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>xxx<span>></span></span></span><span>(</span><span>)</span>
        <span>.</span><span>WithTransaction</span><span>(</span>transaction<span>)</span>
        <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Clicks <span>+</span> <span>1</span><span>)</span>
        <span>.</span><span>ExecuteAffrowsAsync</span><span>(</span><span>)</span><span>;</span>

        transaction<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>catch</span> <span>(</span><span>Exception</span> ex<span>)</span>
    <span>{</span>
        transaction<span>.</span><span>Rollback</span><span>(</span><span>)</span><span>;</span>
        <span>//记录日志，抛出异常（使用全局异常）或者返回自定义数据 </span>
        <span>throw</span><span>;</span>
    <span>}</span> 
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_5、更新排他锁" tabindex="-1"> 5、更新排他锁</h2>
<div><pre><code><span><span>var</span></span> user <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>ForUpdate</span><span>(</span><span>true</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>ToOne</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT ... FROM User a for update nowait</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>for update 在 Oracle/PostgreSQL/MySql 是通用的写法，我们对 SqlServer 做了特别适配，执行的 SQL 语句大致如下：</p>
<div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span> <span>FROM</span> <span>[</span><span>User</span><span>]</span> a <span>With</span><span>(</span>UpdLock<span>,</span> RowLock<span>,</span> NoWait<span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="_6、示范代码" tabindex="-1"> 6、示范代码</h2>
<div><pre><code><span>//使用 全局线程事务</span>
fsql<span>.</span><span>Transaction</span><span>(</span><span>(</span><span>)</span> <span>=></span>
<span>{</span>
    fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
    fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span><span>)</span><span>;</span>


<span>//使用 UnitOfWork 事务</span>
<span>using</span> <span>(</span><span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    <span><span>var</span></span> repo <span>=</span> uow<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Products<span>></span></span></span><span>(</span><span>)</span><span>;</span>
    repo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>;</span>

    uow<span>.</span>Orm<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//正常</span>
    fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//错误，没有传事务</span>
    fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>WithTransaction</span><span>(</span>uow<span>.</span><span>GetOrBeginTransaction</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//正常</span>

    uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
<span>}</span>


<span>//使用 DbContext 事务</span>
<span>using</span> <span>(</span><span><span>var</span></span> ctx <span>=</span> fsql<span>.</span><span>CreateDbContext</span><span>(</span><span>)</span><span>)</span>
<span>{</span>
    ctx<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>;</span>

    ctx<span>.</span>Orm<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//正常</span>
    fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//错误，没有传事务</span>
    fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>WithTransaction</span><span>(</span>ctx<span>.</span>UnitOfWork<span>.</span><span>GetOrBeginTransaction</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//正常</span>

    ctx<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>
<span>}</span>


<span>//使用 UnitOfWorkManager 管理类事务</span>
<span>using</span> <span>(</span><span><span>var</span></span> uowManager <span>=</span> <span>new</span> <span>UnitOfWorkManager</span><span>(</span>fsql<span>)</span><span>)</span>
<span>{</span>
    <span>using</span> <span>(</span><span><span>var</span></span> uow <span>=</span> uowManager<span>.</span><span>Begin</span><span>(</span><span>)</span><span>)</span>
    <span>{</span>
        uow<span>.</span>Orm<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//正常</span>
        fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//错误，没有传事务</span>
        fsql<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>.</span><span>WithTransaction</span><span>(</span>uow<span>.</span><span>GetOrBeginTransaction</span><span>(</span><span>)</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span> <span>//正常</span>

        <span>using</span> <span>(</span><span><span>var</span></span> uow2 <span>=</span> uowManager<span>.</span><span>Begin</span><span>(</span><span>)</span><span>)</span> <span>//与 uow 同一个事务</span>
        <span>{</span>
            <span><span>var</span></span> repo1 <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Products<span>></span></span></span><span>(</span><span>)</span><span>;</span>
            repo1<span>.</span>UnitOfWork <span>=</span> uow2<span>;</span>
            repo1<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Products</span><span>(</span><span>)</span><span>)</span><span>;</span>

            uow2<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span> <span>//事务还未提交</span>
        <span>}</span>

        uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span> <span>//事务提交</span>
    <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>IFreeSql Curd 方法若不是使用同线程事务，需要指定 WithTransaction 传入事务；</li>
<li>IUnitOfWork Orm 与工作单元事务一致；</li>
<li>FreeSql.IBaseRepository curd 方法需要指定 UnitOfWork 传递工作单元事务；</li>
<li>FreeSql.DbContext 自带事务；</li>
<li>UnitOfWorkManager 适合做跨方法事务；</li>
</ul>
<p><a href="https://github.com/dotnetcore/FreeSql/issues/322" target="_blank" rel="noopener noreferrer">扩展阅读 1：IFreeSql 事务另类玩法，理解上面各种事务场景之后再看会更佳</a></p>
<p><a href="https://www.cnblogs.com/kellynic/p/13551855.html" target="_blank" rel="noopener noreferrer">扩展阅读 2：对以上各种事务的理解及演变</a></p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">类型映射</title>
    <id>https://freesql.net/guide/type-mapping.html</id>
    <link href="https://freesql.net/guide/type-mapping.html"/>
    <updated>2022-05-31T14:08:53.000Z</updated>
    <content type="html"><![CDATA[<h1 id="类型映射" tabindex="-1"> 类型映射</h1>
<h2 id="自定义类型映射-maptype" tabindex="-1"> 自定义类型映射(MapType)</h2>
<div><pre><code><span>class</span> <span>EnumTestMap</span> <span>{</span>
    <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum</span> enum_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum<span>?</span></span> enumnullable_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>int</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum</span> enum_to_int <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>int</span><span>?</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>ToStringMapEnum<span>?</span></span> enumnullable_to_int <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>BigInteger</span> biginteger_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>[</span><span><span>Column</span><span><span>(</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>string</span></span><span>)</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span>BigInteger<span>?</span></span> bigintegernullable_to_string <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>enum</span> <span>ToStringMapEnum</span> <span>{</span> 中国人<span>,</span> abc<span>,</span> 香港 <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>应该不需要解释了吧？</p>
<p>BigInteger 都可以映射使用了，但请注意：仅仅是 CURD 方便， Equals == 判断可以使用，无法实现 + - * / 等操作；</p>
<p>v0.9.15 版本还可以将值对象映射成 typeof(string)，安装扩展包：</p>
<blockquote>
<p>dotnet add package FreeSql.Extensions.JsonMap</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span>UseJsonMap</span><span>(</span><span>)</span><span>;</span> <span>//开启功能</span>

<span>class</span> <span>TestConfig</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"sysconfig"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>S_SysConfig</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>JsonMap</span></span><span>]</span>
    <span>public</span> <span>TestConfig</span> Config <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="默认类型映射" tabindex="-1"> 默认类型映射</h2>
<table>
<thead>
<tr>
<th>csharp</th>
<th>MySql</th>
<th>SqlServer</th>
<th>PostgreSQL</th>
<th>Oracle</th>
<th>Sqlite</th>
<th>达梦</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool | bool?</td>
<td>bit(1)</td>
<td>bit</td>
<td>bool</td>
<td>number(1)</td>
<td>boolean</td>
<td>number(1)</td>
</tr>
<tr>
<td>sbyte | sbyte?</td>
<td>tinyint(3)</td>
<td>smallint</td>
<td>int2</td>
<td>number(4)</td>
<td>smallint</td>
<td>number(4)</td>
</tr>
<tr>
<td>short | short?</td>
<td>smallint(6)</td>
<td>smallint</td>
<td>int2</td>
<td>number(6)</td>
<td>smallint</td>
<td>number(6)</td>
</tr>
<tr>
<td>int | int?</td>
<td>int(11)</td>
<td>int</td>
<td>int4</td>
<td>number(11)</td>
<td>integer</td>
<td>number(11)</td>
</tr>
<tr>
<td>long | long?</td>
<td>bigint(20)</td>
<td>bigint</td>
<td>int8</td>
<td>number(21)</td>
<td>integer</td>
<td>number(21)</td>
</tr>
<tr>
<td>byte | byte?</td>
<td>tinyint(3) unsigned</td>
<td>tinyint</td>
<td>int2</td>
<td>number(3)</td>
<td>int2</td>
<td>number(3)</td>
</tr>
<tr>
<td>ushort | ushort?</td>
<td>smallint(5) unsigned</td>
<td>int</td>
<td>int4</td>
<td>number(5)</td>
<td>unsigned</td>
<td>number(5)</td>
</tr>
<tr>
<td>uint | uint?</td>
<td>int(10) unsigned</td>
<td>bigint</td>
<td>int8</td>
<td>number(10)</td>
<td>decimal(10,0)</td>
<td>number(10)</td>
</tr>
<tr>
<td>ulong | ulong?</td>
<td>bigint(20) unsigned</td>
<td>decimal(20,0)</td>
<td>numeric(20,0)</td>
<td>number(20)</td>
<td>decimal(21,0)</td>
<td>number(20)</td>
</tr>
<tr>
<td>double | double?</td>
<td>double</td>
<td>float</td>
<td>float8</td>
<td>float(126)</td>
<td>double</td>
<td>double</td>
</tr>
<tr>
<td>float | float?</td>
<td>float</td>
<td>real</td>
<td>float4</td>
<td>float(63)</td>
<td>float</td>
<td>real</td>
</tr>
<tr>
<td>decimal | decimal?</td>
<td>decimal(10,2)</td>
<td>decimal(10,2)</td>
<td>numeric(10,2)</td>
<td>number(10,2)</td>
<td>decimal(10,2)</td>
<td>number(10,2)</td>
</tr>
<tr>
<td>Guid | Guid?</td>
<td>char(36)</td>
<td>uniqueidentifier</td>
<td>uuid</td>
<td>char(36 CHAR)</td>
<td>character(36)</td>
<td>char(36)</td>
</tr>
<tr>
<td>TimeSpan | TimeSpan?</td>
<td>time</td>
<td>time</td>
<td>time</td>
<td>interval day(2) to second(6)</td>
<td>bigint</td>
<td>-</td>
</tr>
<tr>
<td>DateTime | DateTime?</td>
<td>datetime</td>
<td>datetime</td>
<td>timestamp</td>
<td>timestamp(6)</td>
<td>datetime</td>
<td>timestamp(6)</td>
</tr>
<tr>
<td>DateTimeOffset | DateTimeOffset?</td>
<td>-</td>
<td>datetimeoffset</td>
<td>-</td>
<td>timestamp(6) with local time zone</td>
<td>-</td>
<td>timestamp(6)</td>
</tr>
<tr>
<td>Enum | Enum?</td>
<td>enum</td>
<td>int</td>
<td>int4</td>
<td>number(16)</td>
<td>mediumint</td>
<td>number(16)</td>
</tr>
<tr>
<td>FlagsEnum | FlagsEnum?</td>
<td>set</td>
<td>bigint</td>
<td>int8</td>
<td>number(32)</td>
<td>bigint</td>
<td>number(32)</td>
</tr>
<tr>
<td>byte[]</td>
<td>varbinary(255)</td>
<td>varbinary(255)</td>
<td>bytea</td>
<td>blob</td>
<td>blob</td>
<td>blob</td>
</tr>
<tr>
<td>string</td>
<td>varchar(255)</td>
<td>nvarchar(255)</td>
<td>varchar(255)</td>
<td>nvarchar2(255)</td>
<td>nvarchar(255)</td>
<td>nvarchar2(255)</td>
</tr>
</tbody>
</table>
<blockquote>
<p>以上类型和长度是默认值，可手工设置 Column 特性 DbType 值</p>
</blockquote>
<blockquote>
<p>string 指定长度 [Column(DbType = &quot;varchar(max)&quot;)] 或者 [MaxLength(-1)] 或者 [Column(StringLength = -1)]，当长度 -1 时产生的映射如下：</p>
</blockquote>
<table>
<thead>
<tr>
<th>MySql</th>
<th>PostgreSQL</th>
<th>SqlServer</th>
<th>Oracle</th>
<th>Sqlite</th>
<th>Firebird</th>
<th>MsAccess</th>
<th>达梦</th>
<th>金仓</th>
<th>神通</th>
</tr>
</thead>
<tbody>
<tr>
<td>text</td>
<td>text</td>
<td>varchar(max)</td>
<td>nclob</td>
<td>text</td>
<td>blob sub_type 1</td>
<td>longtext</td>
<td>text</td>
<td>text</td>
<td>text</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注意：Oracle nclob 需要 v1.3.2+ 版本才支持，否则将映射 nvarchar2(4000)</p>
</blockquote>
<blockquote>
<p>注意：MySql [MaxLength(-2)] 或者 [Column(StringLength = -2)] 映射类型 longtext，其他数据库的映射规则与 -1 相同</p>
</blockquote>
<blockquote>
<p>decimal 指定长度 [Column(Precision = 10, Scale = 2)]</p>
</blockquote>
<h2 id="mysql-特别类型映射" tabindex="-1"> MySql 特别类型映射</h2>
<table>
<thead>
<tr>
<th>csharp</th>
<th>MySql</th>
</tr>
</thead>
<tbody>
<tr>
<td>MygisPoint</td>
<td>point</td>
</tr>
<tr>
<td>MygisLineString</td>
<td>linestring</td>
</tr>
<tr>
<td>MygisPolygon</td>
<td>polygon</td>
</tr>
<tr>
<td>MygisMultiPoint</td>
<td>multipoint</td>
</tr>
<tr>
<td>MygisMultiLineString</td>
<td>multilinestring</td>
</tr>
<tr>
<td>MygisMultiPolygon</td>
<td>multipolygon</td>
</tr>
</tbody>
</table>
<h2 id="mysql注意事项" tabindex="-1"> Mysql注意事项</h2>
<p>如果<code>int、byte</code>类型，指定了 <code>DbType=&quot;tinyint(1)&quot;</code>,请注意，<code>tinyint(1)</code>在ado.net中默认将此值映射为<code>bool</code>类型，可在链接串中指定<code>TreatTinyAsBoolean=false</code>,使映射 <code>tinyint(1) </code>为 <code>SByte</code> 而非 <code>bool</code>。</p>
<h2 id="postgresql-特别类型映射" tabindex="-1"> PostgreSQL 特别类型映射</h2>
<table>
<thead>
<tr>
<th>csharp</th>
<th>PostgreSQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>BitArray</td>
<td>varbit(64)</td>
</tr>
<tr>
<td>NpgsqlPoint | NpgsqlPoint?</td>
<td>point</td>
</tr>
<tr>
<td>NpgsqlLine | NpgsqlLine?</td>
<td>line</td>
</tr>
<tr>
<td>NpgsqlLSeg | NpgsqlLSeg?</td>
<td>lseg</td>
</tr>
<tr>
<td>NpgsqlBox | NpgsqlBox?</td>
<td>box</td>
</tr>
<tr>
<td>NpgsqlPath | NpgsqlPath?</td>
<td>path</td>
</tr>
<tr>
<td>NpgsqlPolygon | NpgsqlPolygon?</td>
<td>polygon</td>
</tr>
<tr>
<td>NpgsqlCircle | NpgsqlCircle?</td>
<td>circle</td>
</tr>
<tr>
<td>(IPAddress Address, int Subnet) | (IPAddress Address, int Subnet)?</td>
<td>cidr</td>
</tr>
<tr>
<td>IPAddress</td>
<td>inet</td>
</tr>
<tr>
<td>PhysicalAddress</td>
<td>macaddr</td>
</tr>
<tr>
<td>NpgsqlRange&lt;int&gt; | NpgsqlRange&lt;int&gt;?</td>
<td>int4range</td>
</tr>
<tr>
<td>NpgsqlRange&lt;long&gt; | NpgsqlRange&lt;long&gt;?</td>
<td>int8range</td>
</tr>
<tr>
<td>NpgsqlRange&lt;decimal&gt; | NpgsqlRange&lt;decimal&gt;?</td>
<td>numrange</td>
</tr>
<tr>
<td>NpgsqlRange&lt;DateTime&gt; | NpgsqlRange&lt;DateTime&gt;?</td>
<td>tsrange</td>
</tr>
<tr>
<td>PostgisPoint</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisLineString</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisPolygon</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisMultiPoint</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisMultiLineString</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisMultiPolygon</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisGeometry</td>
<td>geometry</td>
</tr>
<tr>
<td>PostgisGeometryCollection</td>
<td>geometry</td>
</tr>
<tr>
<td>Dictionary&lt;string, string&gt;</td>
<td>hstore</td>
</tr>
<tr>
<td>JToken</td>
<td>jsonb</td>
</tr>
<tr>
<td>JObject</td>
<td>jsonb</td>
</tr>
<tr>
<td>JArray</td>
<td>jsonb</td>
</tr>
<tr>
<td>数组</td>
<td>以上所有类型都支持，包括默认类型</td>
</tr>
</tbody>
</table>
<h2 id="优先级" tabindex="-1"> 优先级</h2>
<p>从数据库导入特性 &gt; 实体特性 &gt; FluentApi &gt; Aop</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">UnitOfWork</title>
    <id>https://freesql.net/guide/unit-of-work.html</id>
    <link href="https://freesql.net/guide/unit-of-work.html"/>
    <updated>2022-08-19T12:06:05.000Z</updated>
    <content type="html"><![CDATA[<h1 id="unitofwork" tabindex="-1"> UnitOfWork</h1>
<p>UnitOfWork 可将多个仓储放在一个单元管理执行，最终通用 Commit 执行所有操作，内部采用了数据库事务；</p>
<div><pre><code><span><span>var</span></span> connstr <span>=</span> <span>"Data Source=127.0.0.1;Port=3306;User ID=root;Password=root;"</span> <span>+</span>
  <span>"Initial Catalog=cccddd;Charset=utf8;SslMode=none;Max pool size=10"</span><span>;</span>

<span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
  <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connstr<span>)</span>
  <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库</span>
  <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="如何使用" tabindex="-1"> 如何使用</h2>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>)</span> 
<span>{</span>
  <span><span>var</span></span> songRepo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>)</span><span>;</span>
  songRepo<span>.</span>UnitOfWork <span>=</span> uow<span>;</span>
  <span><span>var</span></span> userRepo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span><span>;</span>
  userRepo<span>.</span>UnitOfWork <span>=</span> uow<span>;</span>

  songRepo<span>.</span><span>Insert</span><span>(</span><span>new</span> <span>Song</span><span>(</span><span>)</span><span>)</span><span>;</span>
  userRepo<span>.</span><span>Update</span><span>(</span><span>..</span><span>.</span><span>)</span><span>;</span>

  uow<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>参考：<a href="/guide/unitofwork-manager.html">在 asp.net core 中使用 TransactionalAttribute + UnitOfWorkManager 实现多种事务传播</a></p>
<h2 id="接口定义" tabindex="-1"> 接口定义</h2>
<p>uow.GetOrBeginTransaction() 方法可获取事务对象。</p>
<div><pre><code><span>public</span> <span>interface</span> <span>IUnitOfWork</span> <span>:</span> <span><span>IDisposable</span></span>
<span>{</span>
    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 该对象 Select/Delete/Insert/Update/InsertOrUpdate 与工作单元事务保持一致，可省略传递 WithTransaction</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>IFreeSql</span> Orm <span>{</span> <span>get</span><span>;</span> <span>}</span>

    <span>DbTransaction</span> <span>GetOrBeginTransaction</span><span>(</span><span><span>bool</span></span> isCreate <span>=</span> <span>true</span><span>)</span><span>;</span>

    <span>IsolationLevel<span>?</span></span> IsolationLevel <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span><span>void</span></span> <span>Commit</span><span>(</span><span>)</span><span>;</span>

    <span><span>void</span></span> <span>Rollback</span><span>(</span><span>)</span><span>;</span>

    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 工作单元内的实体变化跟踪</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>DbContext<span>.</span>EntityChangeReport</span> EntityChangeReport <span>{</span> <span>get</span><span>;</span> <span>}</span>

    <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
    <span>/// 用户自定义的状态数据，便于扩展</span>
    <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
    <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span> States <span>{</span> <span>get</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="实体变化事件" tabindex="-1"> 实体变化事件</h2>
<p>全局设置：</p>
<div><pre><code>fsql<span>.</span><span>SetDbContextOptions</span><span>(</span>opt <span>=></span> <span>{</span>
  opt<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
    Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
  <span>}</span><span>;</span>
<span>}</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>单独设置：</p>
<div><pre><code><span><span>var</span></span> uow <span>=</span> fsql<span>.</span><span>CreateUnitOfWork</span><span>(</span><span>)</span><span>;</span>
uow<span>.</span>OnEntityChange <span>=</span> report <span>=></span> <span>{</span>
  Console<span>.</span><span>WriteLine</span><span>(</span>report<span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>参数 report 是一个 List 集合，集合元素的类型定义如下：</p>
<div><pre><code><span>public</span> <span>class</span> <span>ChangeInfo</span> <span>{</span>
  <span>public</span> <span><span>object</span></span> Object <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>public</span> <span>EntityChangeType</span> Type <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
  <span>/// <span><span><span>&lt;</span>summary</span><span>></span></span></span>
  <span>/// Type = Update 的时候，获取更新之前的对象</span>
  <span>/// <span><span><span>&lt;/</span>summary</span><span>></span></span></span>
  <span>public</span> <span><span>object</span></span> BeforeObject <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>public</span> <span>enum</span> <span>EntityChangeType</span> <span>{</span> Insert<span>,</span> Update<span>,</span> Delete<span>,</span> SqlRaw <span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>变化类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Insert</td>
<td>实体对象被插入</td>
</tr>
<tr>
<td>Update</td>
<td>实体对象被更新</td>
</tr>
<tr>
<td>Delete</td>
<td>实体对象被删除</td>
</tr>
<tr>
<td>SqlRaw</td>
<td>执行了 SQL 语句</td>
</tr>
</tbody>
</table>
<p>SqlRaw 目前有两处地方比较特殊：</p>
<ul>
<li>多对多联级更新导航属性的时候，对中间表的全部删除操作；</li>
<li>通用仓储类 BaseRepository 有一个 Delete 方法，参数为表达式，而并非实体；</li>
</ul>
<div><pre><code><span><span>int</span></span> <span>Delete</span><span>(</span><span>Expression<span>&lt;</span>Func<span>&lt;</span>TEntity<span>,</span> <span>bool</span><span>></span><span>></span></span> predicate<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>DbContext.SaveChanges，或者 Repository 对实体的 Insert/Update/Delete，或者 UnitOfWork.Commit 操作都会最多触发一次该事件。</p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">修改</title>
    <id>https://freesql.net/guide/update.html</id>
    <link href="https://freesql.net/guide/update.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="修改" tabindex="-1"> 修改</h1>
<p><code>FreeSql</code> 提供丰富的数据库更新功能，支持单条或批量更新，在特定的数据库执行还可以返回更新后的记录。</p>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
    <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> connectionString<span>)</span>
    <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span> <span>//自动同步实体结构到数据库</span>
    <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span> <span>//请务必定义成 Singleton 单例模式</span>

<span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsIdentity <span>=</span> <span>true</span><span>,</span> IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>int</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>int</span></span> Clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="动态条件" tabindex="-1"> 动态条件</h2>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span><span>object</span></span> dywhere<span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p><code>dywhere</code> 支持：</p>
<ul>
<li>主键值</li>
<li><code>new[] { 主键值1, 主键值2 }</code></li>
<li>Topic 对象</li>
<li><code>new[] { Topic对象1, Topic对象2 }</code></li>
<li><code>new { id = 1 }</code></li>
</ul>
<h2 id="_1、更新指定列" tabindex="-1"> 1、更新指定列</h2>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>1</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>,</span> DateTime<span>.</span>Now<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `CreateTime` = '2018-12-08 00:04:59'</span>
<span>//WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>支持 <code>Set()</code> 多次，相当于拼接</p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>1</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Clicks <span>+</span> <span>1</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Time <span>==</span> DateTime<span>.</span>Now<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Clicks` = ifnull(`Clicks`,0) + 1, `Time` = now()</span>
<span>//WHERE (`Id` = 1)</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>1</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> <span>new</span> <span>Topic</span>
  <span>{</span>
    Clicks <span>=</span> a<span>.</span>Clicks <span>+</span> <span>1</span><span>,</span>
    Time <span>=</span> DateTime<span>.</span>Now
  <span>}</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Clicks` = ifnull(`Clicks`,0) + 1, `Time` = now()</span>
<span>//WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_2、更新条件" tabindex="-1"> 2、更新条件</h2>
<blockquote>
<p>除了上面介绍的 <code>dywhere</code> 构造参数外，还支持 <code>Where lambda/sql</code> 方法</p>
</blockquote>
<blockquote>
<p>出于安全考虑，没有条件不执行更新动作，避免误更新全表数据。更新全表数据：<code>fsql.Update&lt;T&gt;().Where(&quot;1=1&quot;).Set(a =&gt; a.Xxx == xxx).ExecuteAffrows()</code></p>
</blockquote>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>,</span> <span>"新标题"</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Time<span>,</span> DateTime<span>.</span>Now<span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Title` = @p_0, `Time` = @p_1</span>
<span>//WHERE (Id = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_3、更新实体" tabindex="-1"> 3、更新实体</h2>
<p>方法 1：(推荐)</p>
<blockquote>
<p>只更新变化的属性，依赖 <code>FreeSql.Repository</code></p>
</blockquote>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> item <span>=</span> repo<span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span><span>.</span><span>First</span><span>(</span><span>)</span><span>;</span>  <span>//此时快照 item</span>
item<span>.</span>Title <span>=</span> <span>"newtitle"</span><span>;</span>
repo<span>.</span><span>Update</span><span>(</span>item<span>)</span><span>;</span> <span>//对比快照时的变化</span>
<span>//UPDATE `Topic` SET `Title` = @p_0</span>
<span>//WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>是不是觉得先查询再更新，啰嗦？</p>
</blockquote>
<div><pre><code><span><span>var</span></span> repo <span>=</span> fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> item <span>=</span> <span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>1</span> <span>}</span><span>;</span>
repo<span>.</span><span>Attach</span><span>(</span>item<span>)</span><span>;</span> <span>//此时快照 item</span>
item<span>.</span>Title <span>=</span> <span>"newtitle"</span><span>;</span>
repo<span>.</span><span>Update</span><span>(</span>item<span>)</span><span>;</span> <span>//对比快照时的变化</span>
<span>//UPDATE `Topic` SET `Title` = @p_0</span>
<span>//WHERE (`Id` = 1)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>方法 2：(原始)</p>
<div><pre><code><span>//v1.5.0 忽略更新 null 值的属性</span>
fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSourceIgnore</span><span>(</span>item<span>,</span> col <span>=></span> col <span>==</span> <span>null</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><div><pre><code><span><span>var</span></span> item <span>=</span> <span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> <span>1</span><span>,</span> Title <span>=</span> <span>"newtitle"</span> <span>}</span><span>;</span>
fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>item<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Clicks` = @p_0, `Title` = @p_1, `CreateTime` = @p_2</span>
<span>//WHERE (`Id` = 1)</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>item<span>)</span>
  <span>.</span><span>UpdateColumns</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Title<span>,</span> a<span>.</span>CreateTime <span>}</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Title` = @p_0, `CreateTime` = @p_1</span>
<span>//WHERE (`Id` = 1)</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>item<span>)</span>
  <span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Clicks<span>,</span> a<span>.</span>CreateTime <span>}</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Title` = @p_0</span>
<span>//WHERE (`Id` = 1)</span>

<span><span>var</span></span> items <span>=</span> <span>new</span> <span>List<span>&lt;</span>Topic<span>></span></span><span>(</span><span>)</span><span>;</span>
<span>for</span> <span>(</span><span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span> a <span>&lt;</span> <span>10</span><span>;</span> a<span>++</span><span>)</span> items<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Topic</span> <span>{</span> Id <span>=</span> a <span>+</span> <span>1</span><span>,</span> Title <span>=</span> <span><span>$"newtitle</span><span><span>{</span><span>a</span><span>}</span></span><span>"</span></span><span>,</span> Clicks <span>=</span> a <span>*</span> <span>100</span> <span>}</span><span>)</span><span>;</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>items<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Clicks` = CASE `Id` WHEN 1 THEN @p_0 WHEN 2 THEN @p_1 WHEN 3 THEN @p_2 WHEN 4 THEN @p_3 WHEN 5 THEN @p_4 WHEN 6 THEN @p_5 WHEN 7 THEN @p_6 WHEN 8 THEN @p_7 WHEN 9 THEN @p_8 WHEN 10 THEN @p_9 END,</span>
<span>//`Title` = CASE `Id` WHEN 1 THEN @p_10 WHEN 2 THEN @p_11 WHEN 3 THEN @p_12 WHEN 4 THEN @p_13 WHEN 5 THEN @p_14 WHEN 6 THEN @p_15 WHEN 7 THEN @p_16 WHEN 8 THEN @p_17 WHEN 9 THEN @p_18 WHEN 10 THEN @p_19 END,</span>
<span>//`CreateTime` = CASE `Id` WHEN 1 THEN @p_20 WHEN 2 THEN @p_21 WHEN 3 THEN @p_22 WHEN 4 THEN @p_23 WHEN 5 THEN @p_24 WHEN 6 THEN @p_25 WHEN 7 THEN @p_26 WHEN 8 THEN @p_27 WHEN 9 THEN @p_28 WHEN 10 THEN @p_29 END</span>
<span>//WHERE (`Id` IN (1,2,3,4,5,6,7,8,9,10))</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>items<span>)</span>
  <span>.</span><span>IgnoreColumns</span><span>(</span>a <span>=></span> <span>new</span> <span>{</span> a<span>.</span>Clicks<span>,</span> a<span>.</span>CreateTime <span>}</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Title` = CASE `Id` WHEN 1 THEN @p_0 WHEN 2 THEN @p_1 WHEN 3 THEN @p_2 WHEN 4 THEN @p_3 WHEN 5 THEN @p_4 WHEN 6 THEN @p_5 WHEN 7 THEN @p_6 WHEN 8 THEN @p_7 WHEN 9 THEN @p_8 WHEN 10 THEN @p_9 END</span>
<span>//WHERE (`Id` IN (1,2,3,4,5,6,7,8,9,10))</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetSource</span><span>(</span>items<span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>CreateTime<span>,</span> DateTime<span>.</span>Now<span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `CreateTime` = @p_0</span>
<span>//WHERE (`Id` IN (1,2,3,4,5,6,7,8,9,10))</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><blockquote>
<p>指定 <code>Set</code> 列更新后，<code>SetSource</code> 将失效</p>
</blockquote>
<h2 id="_4、自定义-sql" tabindex="-1"> 4、自定义 SQL</h2>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>Topic<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetRaw</span><span>(</span><span>"Title = @title"</span><span>,</span> <span>new</span> <span>{</span> title <span>=</span> <span>"新标题"</span> <span>}</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span><span>"Id = @id"</span><span>,</span> <span>1</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET Title = @title WHERE (Id = @id)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_5、根据-dto-更新" tabindex="-1"> 5、根据 Dto 更新</h2>
<div><pre><code>fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetDto</span><span>(</span><span>new</span> <span>{</span> title <span>=</span> <span>"xxx"</span><span>,</span> clicks <span>=</span> <span>2</span> <span>}</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>//UPDATE `Topic` SET `Title` = @p_0, `Clicks` = @p_1 WHERE (Id = 1)</span>

fsql<span>.</span><span><span>Update</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>SetDto</span><span>(</span><span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span> <span>{</span> <span>[</span><span>"title"</span><span>]</span> <span>=</span> <span>"xxx"</span><span>,</span> <span>[</span><span>"clicks"</span><span>]</span> <span>=</span> <span>2</span> <span>}</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_6、set-setsource-setdto-区别" tabindex="-1"> 6、Set/SetSource/SetDto 区别</h2>
<p>他们三个是平级功能，分别对应：</p>
<ul>
<li>
<p><code>Set/SetRaw</code> 在知道实体的时候使用，对应 <code>update t set x = x</code></p>
</li>
<li>
<p><code>SetSource</code> 更新整个实体，可以配合 <code>UpdateColumns</code> 或 <code>IgnoreColumns</code> 指定或忽略字段</p>
</li>
<li>
<p><code>SetDto</code> 是 <code>Set</code> 的批量操作</p>
</li>
</ul>
<h2 id="_7、字典更新" tabindex="-1"> 7、字典更新</h2>
<div><pre><code><span><span>var</span></span> dic <span>=</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>object</span><span>></span></span><span>(</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"id"</span><span>,</span> <span>1</span><span>)</span><span>;</span>
dic<span>.</span><span>Add</span><span>(</span><span>"name"</span><span>,</span> <span>"xxxx"</span><span>)</span><span>;</span>

fsql<span>.</span><span>UpdateDict</span><span>(</span>dic<span>)</span><span>.</span><span>AsTable</span><span>(</span><span>"table1"</span><span>)</span><span>.</span><span>WherePrimary</span><span>(</span><span>"id"</span><span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="_8、乐观锁" tabindex="-1"> 8、乐观锁</h2>
<p>更新整个实体数据时，在并发情况下极容易造成旧数据将新的记录更新。</p>
<p>乐观锁的原理，是利用实体某字段，如：<code>long version</code>，更新前先查询数据，此时 <code>version</code> 为 <code>1</code>，更新时产生的 SQL 会附加 <code>where version = 1</code>，当修改失败时（即 <code>Affrows == 0</code>）抛出异常（DbUpdateVersionException）。</p>
<p>每个实体只支持一个乐观锁属性，在属性前标记特性：<code>[Column(IsVersion = true)]</code> 即可。</p>
<blockquote>
<p>适用 <code>SetSource</code> 更新，每次更新 <code>version</code> 的值都会增加 <code>1</code></p>
</blockquote>
<h2 id="_9、悲观锁" tabindex="-1"> 9、悲观锁</h2>
<div><pre><code><span><span>var</span></span> user <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>User<span>></span></span></span><span>(</span><span>)</span>
  <span>.</span><span>ForUpdate</span><span>(</span><span>true</span><span>)</span>
  <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ToOne</span><span>(</span><span>)</span><span>;</span>
<span>//SELECT ... FROM User a for update nowait</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p><code>ForUpdate</code> 在 Oracle/PostgreSQL/MySql 是通用的写法，我们对 SqlServer 做了特别适配，执行的 SQL 语句大致如下：</p>
<div><pre><code><span>SELECT</span> <span>.</span><span>.</span><span>.</span> <span>FROM</span> <span>[</span><span>User</span><span>]</span> a <span>With</span><span>(</span>UpdLock<span>,</span> RowLock<span>,</span> NoWait<span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><h2 id="_10、iselect-toupdate-高级更新" tabindex="-1"> 10、ISelect.ToUpdate 高级更新</h2>
<p><code>IUpdate</code> 默认不支持导航对象，多表关联等。<code>ISelect.ToUpdate</code> 可将查询转为 <code>IUpdate</code>，以便使用导航对象更新数据，如下：</p>
<div><pre><code>fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T1<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Options<span>.</span>xxx <span>==</span> <span>1</span><span>)</span>
  <span>.</span><span>ToUpdate</span><span>(</span><span>)</span>
  <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>Title<span>,</span> <span>"111"</span><span>)</span>
  <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>注意：此方法不是将数据查询到内存再更新，上面的代码产生如下 SQL 执行：</p>
<div><pre><code><span>UPDATE</span> <span><span>`</span>T1<span>`</span></span> <span>SET</span> Title <span>=</span> <span>'111'</span> <span>WHERE</span> id <span>in</span> <span>(</span><span>select</span> a<span>.</span>id <span>from</span> T1 a <span>left</span> <span>join</span> Options b <span>on</span> b<span>.</span>t1id <span>=</span> a<span>.</span>id <span>where</span> b<span>.</span>xxx <span>=</span> <span>1</span><span>)</span>
</code></pre><div aria-hidden="true"><div></div></div></div><p>复杂更新使用该方案的好处：</p>
<ul>
<li>更新前可预览测试数据，防止错误更新操作；</li>
<li>支持复杂的更新操作，例如：<code>ISelect</code> 上使用 <code>Limit(10)</code> 更新附合条件的前 10 条记录；</li>
</ul>
<h1 id="api" tabindex="-1"> API</h1>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SetSource</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>更新数据，设置更新的实体</td>
</tr>
<tr>
<td>IgnoreColumns</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>忽略的列</td>
</tr>
<tr>
<td>Set</td>
<td>&lt;this&gt;</td>
<td>Lambda, value</td>
<td>设置列的新值，<code>Set(a =&gt; a.Name, &quot;newvalue&quot;)</code></td>
</tr>
<tr>
<td>Set</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>设置列的的新值为基础上增加，<code>Set(a =&gt; a.Clicks + 1)</code>，相当于 clicks=clicks+1</td>
</tr>
<tr>
<td>SetDto</td>
<td>&lt;this&gt;</td>
<td>object</td>
<td>根据 DTO 更新的方法</td>
</tr>
<tr>
<td>SetRaw</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>设置值，自定义 SQL 语法，<code>SetRaw(&quot;title = @title&quot;, new { title = &quot;newtitle&quot; })</code></td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>表达式条件，仅支持实体基础成员（不包含导航对象）</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>原生 sql 语法条件，<code>Where(&quot;id = @id&quot;, new { id = 1 })</code></td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>传入实体或集合，将其主键作为条件</td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
</tr>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回影响的行数</td>
</tr>
<tr>
<td>ExecuteUpdated</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 语句，返回更新后的记录</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">API 文档</title>
    <id>https://freesql.net/reference/api.html</id>
    <link href="https://freesql.net/reference/api.html"/>
    <updated>2022-09-05T06:51:57.000Z</updated>
    <content type="html"><![CDATA[<h1 id="api-文档" tabindex="-1"> API 文档</h1>
<ul>
<li><a href="http://124.70.130.97:8082/api/FreeSql.html" target="_blank" rel="noopener noreferrer">http://124.70.130.97:8082/api/FreeSql.html</a></li>
</ul>
<h2 id="freesqlbuilder" tabindex="-1"> FreeSqlBuilder</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>UseConnectionString</td>
<td>this</td>
<td>设置连接串</td>
</tr>
<tr>
<td>UseSlave</td>
<td>this</td>
<td>设置从数据库，支持多个</td>
</tr>
<tr>
<td>UseSlaveWeight</td>
<td>this</td>
<td>设置从数据库权重</td>
</tr>
<tr>
<td>UseConnectionFactory</td>
<td>this</td>
<td>设置自定义数据库连接对象（放弃内置对象连接池技术）</td>
</tr>
<tr>
<td>UseAutoSyncStructure</td>
<td>this</td>
<td>【开发环境必备】自动同步实体结构到数据库，程序运行中检查实体创建或修改表结构</td>
</tr>
<tr>
<td>UseNoneCommandParameter</td>
<td>this</td>
<td>不使用命令参数化执行，针对 Insert/Update，也可临时使用 IInsert/IUpdate.NoneParameter()</td>
</tr>
<tr>
<td>UseGenerateCommandParameterWithLambda</td>
<td>this</td>
<td>生成命令参数化执行，针对 lambda 表达式解析</td>
</tr>
<tr>
<td>UseLazyLoading</td>
<td>this</td>
<td>开启延时加载功能</td>
</tr>
<tr>
<td>UseMonitorCommand</td>
<td>this</td>
<td>监视全局 SQL 执行前后</td>
</tr>
<tr>
<td>UseMappingPriority</td>
<td>this</td>
<td>指定映射优先级（默认 Aop &lt; FluentApi &lt; Attribute）</td>
</tr>
<tr>
<td><strong>UseNameConvert</strong></td>
<td>this</td>
<td>自动转换名称 Entity -&gt; Db</td>
</tr>
<tr>
<td>UseExitAutoDisposePool</td>
<td>this</td>
<td>监听 AppDomain.CurrentDomain.ProcessExit/Console.CancelKeyPress 事件自动释放连接池 (默认true)</td>
</tr>
<tr>
<td>Build&lt;T&gt;</td>
<td>IFreeSql&lt;T&gt;</td>
<td>创建一个 IFreeSql 对象，注意：单例设计，不要重复创建</td>
</tr>
</tbody>
</table>
<h2 id="ifreesql" tabindex="-1"> IFreeSql</h2>
<table>
<thead>
<tr>
<th>属性</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="/guide/ado.html">Ado</a></td>
<td>IAdo</td>
<td>数据库访问对象，封装了类似 SqlHelper 操作：ExecuteNonQuery/ExecuteScalar/ExecuteConnectTest 等</td>
</tr>
<tr>
<td><a href="/guide/aop.html">Aop</a></td>
<td>IAop</td>
<td>所有 AOP 拦截方法都在这里</td>
</tr>
<tr>
<td><a href="/guide/code-first.html">CodeFirst</a></td>
<td>ICodeFirst</td>
<td>封装 CodeFirst 模式开发相关方法</td>
</tr>
<tr>
<td><a href="/guide/db-first.html">DbFirst</a></td>
<td>IDbFirst</td>
<td>封装 DbFirst 模式开发相关方法</td>
</tr>
<tr>
<td><a href="/guide/filters.html">GlobalFilter</a></td>
<td>GlobalFilter</td>
<td>全局过滤设置，可默认附加为 Select/Update/Delete 条件</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Select&lt;TEntity&gt;</td>
<td>ISelect&lt;TEntity&gt;</td>
<td>无</td>
<td>准备查询数据</td>
</tr>
<tr>
<td>Insert&lt;TEntity&gt;</td>
<td>IInsert&lt;TEntity&gt;</td>
<td>无/TEntity/TEntity[]</td>
<td>准备插入</td>
</tr>
<tr>
<td>Update&lt;TEntity&gt;</td>
<td>IUpdate&lt;TEntity&gt;</td>
<td>无</td>
<td>准备更新数据</td>
</tr>
<tr>
<td>Delete&lt;TEntity&gt;</td>
<td>IDelete&lt;TEntity&gt;</td>
<td>无</td>
<td>准备删除</td>
</tr>
<tr>
<td>InsertOrUpdate&lt;TEntity&gt;</td>
<td>IInsertOrUpdate&lt;TEntity&gt;</td>
<td>无</td>
<td>插入或更新数据</td>
</tr>
<tr>
<td>Transaction</td>
<td>void</td>
<td>Action</td>
<td>开启事务（不支持异步），<a href="/guide/transaction.html">其他事务</a></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>扩展方法</th>
<th>返回值</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Select&lt;T1, T2, ... T10&gt;</td>
<td>ISelect</td>
<td>无</td>
<td>准备多表查询</td>
</tr>
<tr>
<td><a href="/guide/db-context.html">CreateDbContext</a></td>
<td>DbContext</td>
<td>无</td>
<td>创建普通数据上下文档对象，该对象功能类似于 EFCore</td>
</tr>
<tr>
<td>SetDbContextOptions</td>
<td>-</td>
<td>Action</td>
<td>设置此 IFreeSql 下 DbContext 选项设置</td>
</tr>
<tr>
<td><a href="/guide/repository.html">GetRepository</a>&lt;TEntity, TKey&gt;</td>
<td>BaseRepository</td>
<td>无</td>
<td>返回默认仓库功能实现</td>
</tr>
<tr>
<td><a href="/guide/unit-of-work.html">CreateUnitOfWork</a></td>
<td>IUnitOfWork</td>
<td>无</td>
<td>创建基于仓储功能的工作单元，务必使用 using 包含使用</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="baserepository-tentity-tkey" tabindex="-1"> BaseRepository&lt;TEntity, TKey&gt;</h2>
<table>
<thead>
<tr>
<th>属性</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>EntityType</td>
<td>Type</td>
<td>仓储正在操作的实体类型，注意它不一定是 TEntity</td>
</tr>
<tr>
<td>UnitOfWork</td>
<td>IUnitOfWork</td>
<td>正在使用的工作单元</td>
</tr>
<tr>
<td>Orm</td>
<td>IFreeSql</td>
<td>正在使用的 Orm</td>
</tr>
<tr>
<td>DbContextOptions</td>
<td>DbContextOptions</td>
<td>正在使用的 DbContext 设置，修改设置不影响其他</td>
</tr>
<tr>
<td>DataFilter</td>
<td>IDataFilter&lt;TEntity&gt;</td>
<td>仓储过滤器，本对象内生效</td>
</tr>
<tr>
<td>Select</td>
<td>ISelect&lt;TEntity&gt;</td>
<td>准备查询数据</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>AsType</td>
<td>void</td>
<td>Type</td>
<td>改变仓储正在操作的实体类型</td>
</tr>
<tr>
<td>Get</td>
<td>TEntity</td>
<td>TKey</td>
<td>根据主键，查询数据</td>
</tr>
<tr>
<td>Find</td>
<td>TEntity</td>
<td>TKey</td>
<td>根据主键，查询数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>TKey</td>
<td>根据主键删除数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>Lambda</td>
<td>根据 lambda 条件删除数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>TEntity</td>
<td>删除数据</td>
</tr>
<tr>
<td>Delete</td>
<td>int</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量删除数据</td>
</tr>
<tr>
<td>Insert</td>
<td>-</td>
<td>TEntity</td>
<td>插入数据，若实体有自增列，插入后的自增值会填充到实体中</td>
</tr>
<tr>
<td>Insert</td>
<td>-</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量插入数据</td>
</tr>
<tr>
<td>Update</td>
<td>-</td>
<td>TEntity</td>
<td>更新数据</td>
</tr>
<tr>
<td>Update</td>
<td>-</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量更新数据</td>
</tr>
<tr>
<td>InsertOrUpdate</td>
<td>-</td>
<td>TEntity</td>
<td>插入或更新数据</td>
</tr>
<tr>
<td>FlushState</td>
<td>-</td>
<td>无</td>
<td>清除状态管理数据</td>
</tr>
<tr>
<td>Attach</td>
<td>-</td>
<td>TEntity</td>
<td>附加实体到状态管理，可用于不查询就更新或删除</td>
</tr>
<tr>
<td>Attach</td>
<td>-</td>
<td>IEnumerable&lt;TEntity&gt;</td>
<td>批量附加实体到状态管理</td>
</tr>
<tr>
<td>AttachOnlyPrimary</td>
<td>-</td>
<td>TEntity</td>
<td>只附加实体的主键数据到状态管理</td>
</tr>
<tr>
<td>SaveMany</td>
<td>-</td>
<td>TEntity, string</td>
<td>保存实体的指定 ManyToMany/OneToMany 导航属性（完整对比）</td>
</tr>
<tr>
<td>BeginEdit</td>
<td>-</td>
<td>List&lt;TEntity&gt;</td>
<td>准备编辑一个 List 实体</td>
</tr>
<tr>
<td>EndEdit</td>
<td>int</td>
<td>无</td>
<td>完成编辑数据，进行保存动作</td>
</tr>
</tbody>
</table>
<blockquote>
<p>状态管理，可实现 Update 只更新变化的字段（不更新所有字段），灵活使用 Attach 和 Update 用起来非常舒服。</p>
</blockquote>
<p>DbContext 与 BaseRepository 功能大致类似。</p>
<p>DbContext 自身 = 完整事务，BaseRepository 不一定有事务（可通过设置其 UnitOfWork 属性）。</p>
<hr>
<h2 id="icodefirst" tabindex="-1"> ICodeFirst</h2>
<table>
<thead>
<tr>
<th>属性</th>
<th>返回值</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>IsAutoSyncStructure</td>
<td>bool</td>
<td>【开发环境必备】自动同步实体结构到数据库，程序运行中检查实体表是否存在，然后创建或修改</td>
</tr>
<tr>
<td>IsSyncStructureToLower</td>
<td>bool</td>
<td>是否转小写映射，适合 pgsql</td>
</tr>
<tr>
<td>IsSyncStructureToUpper</td>
<td>bool</td>
<td>是否转大写映射，适合 oracle、dameng</td>
</tr>
<tr>
<td>IsNoneCommandParameter</td>
<td>bool</td>
<td>是否不使用命令参数化执行，针对 Insert/Update</td>
</tr>
<tr>
<td>IsGenerateCommandParameterWithLambda</td>
<td>bool</td>
<td>是否生成命令参数化执行，针对 where lambda 表达式解析</td>
</tr>
<tr>
<td>IsLazyLoading</td>
<td>bool</td>
<td>是否开启延时加载导航属性对象，导航属性需要声明 virtual</td>
</tr>
<tr>
<td>IsConfigEntityFromDbFirst</td>
<td>bool</td>
<td>将数据库的主键、自增、索引设置导入，适合 DbFirst 模式，无须在实体类型上设置 [Column(IsPrimary)]。此功能目前可用于 mysql/sqlserver/postgresql/oracle，此功能会影响 IFreeSql 首次访问的速度。若使用 CodeFirst 创建索引后，又直接在数据库上建了索引，若无本功能下一次 CodeFirst 迁移时数据库上创建的索引将被删除</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GetComparisonDDLStatements&lt;TEntity&gt;</td>
<td>string</td>
<td>无</td>
<td>将实体类型与数据库对比，返回 DDL 语句</td>
</tr>
<tr>
<td>GetComparisonDDLStatements</td>
<td>string</td>
<td>Type[]</td>
<td>将多个实体类型与数据库对比，返回 DDL 语句</td>
</tr>
<tr>
<td>GetComparisonDDLStatements</td>
<td>string</td>
<td>Type, string</td>
<td>将实体类型与数据库对比，返回 DDL 语句(指定表名)</td>
</tr>
<tr>
<td>SyncStructure&lt;TEntity&gt;</td>
<td>bool</td>
<td>无</td>
<td>同步实体类型到数据库</td>
</tr>
<tr>
<td>SyncStructure</td>
<td>bool</td>
<td>Type[]</td>
<td>同步实体类型集合到数据库</td>
</tr>
<tr>
<td>SyncStructure</td>
<td>bool</td>
<td>Type, string</td>
<td>同步实体类型到数据库（指定表名）</td>
</tr>
<tr>
<td>ConfigEntity</td>
<td>ICodeFirst</td>
<td>Action&lt;TableFluent&lt;T&gt;&gt;</td>
<td>FluentAPI 配置实体的特性</td>
</tr>
<tr>
<td>GetTableByEntity</td>
<td>TableInfo</td>
<td>Type</td>
<td>获取类型在 ORM 内部的元数据</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="idbfirst" tabindex="-1"> IDbFirst</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GetDatabases</td>
<td>List&lt;string&gt;</td>
<td>无</td>
<td>获取所有数据库</td>
</tr>
<tr>
<td>GetTablesByDatabase</td>
<td>List&lt;DbTableInfo&gt;</td>
<td>string[]</td>
<td>获取指定数据库的表信息，包括表、列详情、主键、唯一键、索引、外键、备注</td>
</tr>
<tr>
<td>GetTableByName</td>
<td>DbTableInfo</td>
<td>string</td>
<td>获取指定单表信息，包括列详情、主键、唯一键、索引、备注</td>
</tr>
<tr>
<td>ExistsTable</td>
<td>bool</td>
<td>string</td>
<td>判断表名是否存在</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="iselect" tabindex="-1"> ISelect</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
<td></td>
</tr>
<tr>
<td>ToList</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 查询，返回 T1 实体所有字段的记录，若存在导航属性则一起查询返回，记录不存在时返回 Count 为 0 的列表</td>
<td></td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>Lambda</td>
<td>执行 SQL 查询，返回指定字段的记录，记录不存在时返回 Count 为 0 的列表</td>
<td></td>
</tr>
<tr>
<td>ToList&lt;T&gt;</td>
<td>List&lt;T&gt;</td>
<td>string field</td>
<td>执行 SQL 查询，返回 field 指定字段的记录，并以元组或基础类型(int,string,long)接收，记录不存在时返回 Count 为 0 的列表</td>
<td></td>
</tr>
<tr>
<td>ToOne</td>
<td>T1</td>
<td></td>
<td>执行 SQL 查询，返回 T1 实体所有字段的第一条记录，记录不存在时返回 null</td>
<td></td>
</tr>
<tr>
<td>Any</td>
<td>bool</td>
<td></td>
<td>执行 SQL 查询，是否有记录</td>
<td></td>
</tr>
<tr>
<td>Sum</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求和</td>
<td></td>
</tr>
<tr>
<td>Min</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最小值</td>
<td></td>
</tr>
<tr>
<td>Max</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求最大值</td>
<td></td>
</tr>
<tr>
<td>Avg</td>
<td>T</td>
<td>Lambda</td>
<td>指定一个列求平均值</td>
<td></td>
</tr>
<tr>
<td>【分页】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Count</td>
<td>long</td>
<td></td>
<td>查询的记录数量</td>
<td></td>
</tr>
<tr>
<td>Count</td>
<td>&lt;this&gt;</td>
<td>out long</td>
<td>查询的记录数量，以参数 out 形式返回</td>
<td></td>
</tr>
<tr>
<td>Skip</td>
<td>&lt;this&gt;</td>
<td>int offset</td>
<td>查询向后偏移行数</td>
<td></td>
</tr>
<tr>
<td>Offset</td>
<td>&lt;this&gt;</td>
<td>int offset</td>
<td>查询向后偏移行数</td>
<td></td>
</tr>
<tr>
<td>Limit</td>
<td>&lt;this&gt;</td>
<td>int limit</td>
<td>查询多少条数据</td>
<td></td>
</tr>
<tr>
<td>Take</td>
<td>&lt;this&gt;</td>
<td>int limit</td>
<td>查询多少条数据</td>
<td></td>
</tr>
<tr>
<td>Page</td>
<td>&lt;this&gt;</td>
<td>int pageIndex, int pageSize</td>
<td>分页</td>
<td></td>
</tr>
<tr>
<td>【条件】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>支持多表查询表达式，多次使用相当于 AND</td>
<td></td>
</tr>
<tr>
<td>WhereIf</td>
<td>&lt;this&gt;</td>
<td>bool, Lambda</td>
<td>支持多表查询表达式</td>
<td></td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>原生 sql 语法条件，Where(&quot;id = ?id&quot;, new { id = 1 })</td>
<td></td>
</tr>
<tr>
<td>WhereIf</td>
<td>&lt;this&gt;</td>
<td>bool, string, parms</td>
<td>原生 sql 语法条件，WhereIf(true, &quot;id = ?id&quot;, new { id = 1 })</td>
<td></td>
</tr>
<tr>
<td>WhereCascade</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>实现多表查询时，向每个表中附加条件</td>
<td></td>
</tr>
<tr>
<td>【分组】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GroupBy</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按选择的列分组，GroupBy(a =&gt; <a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>)、GroupBy(a =&gt; new{<a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>,a.Time})</td>
<td></td>
</tr>
<tr>
<td>GroupBy</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生 sql 语法分组，GroupBy(&quot;concat(name, ?cc)&quot;, new { cc = 1 })</td>
<td></td>
</tr>
<tr>
<td>Having</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生 sql 语法聚合条件过滤，Having(&quot;count(name) = ?cc&quot;, new { cc = 1 })</td>
<td></td>
</tr>
<tr>
<td>Distinct</td>
<td>&lt;this&gt;</td>
<td></td>
<td>.Distinct().ToList(x =&gt; x.GroupName) 是对指定字段</td>
<td></td>
</tr>
<tr>
<td>【排序】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OrderBy</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按列排序，OrderBy(a =&gt; a.Time)，可多次使用</td>
<td></td>
</tr>
<tr>
<td>OrderByDescending</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>按列倒向排序，OrderByDescending(a =&gt; a.Time)</td>
<td></td>
</tr>
<tr>
<td>OrderBy</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>按原生 sql 语法排序，OrderBy(&quot;count(name) + ?cc&quot;, new { cc = 1 })</td>
<td></td>
</tr>
<tr>
<td>OrderByPropertyName</td>
<td>string, bool</td>
<td>按属性名字符串排序（支持导航属性）</td>
<td></td>
<td></td>
</tr>
<tr>
<td>【联表】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LeftJoin</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>左联查询，可使用导航属性，或指定关联的实体类型</td>
<td></td>
</tr>
<tr>
<td>InnerJoin</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>联接查询，可使用导航属性，或指定关联的实体类型</td>
<td></td>
</tr>
<tr>
<td>RightJoin</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>右联查询，可使用导航属性，或指定关联的实体类型</td>
<td></td>
</tr>
<tr>
<td>LeftJoin</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>左联查询，使用原生 sql 语法，LeftJoin(&quot;type b on <a href="http://b.id" target="_blank" rel="noopener noreferrer">b.id</a> = <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a> and b.clicks &gt; ?clicks&quot;, new { clicks = 1 })</td>
<td></td>
</tr>
<tr>
<td>InnerJoin</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>联接查询，使用原生 sql 语法，InnerJoin(&quot;type b on <a href="http://b.id" target="_blank" rel="noopener noreferrer">b.id</a> = <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a> and b.clicks &gt; ?clicks&quot;, new { clicks = 1 })</td>
<td></td>
</tr>
<tr>
<td>RightJoin</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>右联查询，使用原生 sql 语法，RightJoin(&quot;type b on <a href="http://b.id" target="_blank" rel="noopener noreferrer">b.id</a> = <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a> and b.clicks &gt; ?clicks&quot;, new { clicks = 1 })</td>
<td></td>
</tr>
<tr>
<td>From</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>多表查询，3 个表以上使用非常方便，目前设计最大支持 10 个表</td>
<td></td>
</tr>
<tr>
<td>【其他】</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>As</td>
<td>&lt;this&gt;</td>
<td>string alias = &quot;a&quot;</td>
<td>指定别名</td>
<td></td>
</tr>
<tr>
<td>Master</td>
<td>&lt;this&gt;</td>
<td></td>
<td>指定从主库查询（默认查询从库）</td>
<td></td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
<td></td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
<td></td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
<td></td>
</tr>
<tr>
<td>WithLock</td>
<td>&lt;this&gt;</td>
<td>Enum</td>
<td>SqlServer NoLock 等特有的设置</td>
<td></td>
</tr>
<tr>
<td>ForUpdate</td>
<td>&lt;this&gt;</td>
<td>bool</td>
<td>排他更新锁，对不同的数据库已作适配，详细说明见注释</td>
<td></td>
</tr>
<tr>
<td>AsQueryable</td>
<td>IQueryable</td>
<td></td>
<td>将 ISelect 转换为 IQueryable，此方法主要用于扩展，比如：abp IRepository GetAll() 接口方法需要返回 IQueryable 对象。注意：IQueryable 方法污染较为严重，请尽量避免此转换</td>
<td></td>
</tr>
<tr>
<td>ToTreeList()</td>
<td>List&lt;TEntity&gt;</td>
<td>无</td>
<td>将父子关系的数据以 TreeList 的形式返回</td>
<td></td>
</tr>
<tr>
<td>AsTreeCte()</td>
<td>ISelect</td>
<td>(up, pathSelector, level)</td>
<td>递归查询父子关系表</td>
<td></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="iinsert" tabindex="-1"> IInsert</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>AppendData</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>追加准备插入的实体</td>
</tr>
<tr>
<td>InsertIdentity</td>
<td>&lt;this&gt;</td>
<td>无</td>
<td>指明插入自增列</td>
</tr>
<tr>
<td>InsertColumns</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>只插入的列</td>
</tr>
<tr>
<td>IgnoreColumns</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>忽略的列</td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
</tr>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>OnDuplicateKeyUpdate</td>
<td>OnDuplicateKeyUpdate&lt;T1&gt;</td>
<td>无</td>
<td>MySql 特有的功能，On Duplicate Key Update</td>
</tr>
<tr>
<td>OnConflictDoUpdate</td>
<td>OnConflictDoUpdate&lt;T1&gt;</td>
<td>无</td>
<td>PostgreSQL 特有的功能，On Conflict Do Update</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回影响的行数</td>
</tr>
<tr>
<td>ExecuteIdentity</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回自增值</td>
</tr>
<tr>
<td>ExecuteInserted</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 语句，返回插入后的记录</td>
</tr>
<tr>
<td>ExecuteSqlBulkCopy</td>
<td>void</td>
<td></td>
<td>SqlServer 特有的功能，执行 SqlBulkCopy 批量插入的封装</td>
</tr>
<tr>
<td>ExecutePgCopy</td>
<td>void</td>
<td></td>
<td>PostgreSQL 特有的功能，执行 Copy 批量导入数据</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="iupdate" tabindex="-1"> IUpdate</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SetSource</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>更新数据，设置更新的实体</td>
</tr>
<tr>
<td>IgnoreColumns</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>忽略的列</td>
</tr>
<tr>
<td>Set</td>
<td>&lt;this&gt;</td>
<td>Lambda, value</td>
<td>设置列的新值，Set(a =&gt; <a href="http://a.Name" target="_blank" rel="noopener noreferrer">a.Name</a>, &quot;newvalue&quot;)</td>
</tr>
<tr>
<td>Set</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>设置列的的新值为基础上增加，Set(a =&gt; a.Clicks + 1)，相当于 clicks=clicks+1</td>
</tr>
<tr>
<td>SetDto</td>
<td>&lt;this&gt;</td>
<td>object</td>
<td>根据 dto 更新的方法</td>
</tr>
<tr>
<td>SetRaw</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>设置值，自定义 SQL 语法，SetRaw(&quot;title = ?title&quot;, new { title = &quot;newtitle&quot; })</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>表达式条件，仅支持实体基础成员（不包含导航对象）</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>原生 sql 语法条件，Where(&quot;id = ?id&quot;, new { id = 1 })</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>传入实体或集合，将其主键作为条件</td>
</tr>
<tr>
<td>WhereExists</td>
<td>&lt;this&gt;</td>
<td>ISelect</td>
<td>子查询是否存在</td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
</tr>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回影响的行数</td>
</tr>
<tr>
<td>ExecuteUpdated</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 语句，返回更新后的记录</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="idelete" tabindex="-1"> IDelete</h2>
<table>
<thead>
<tr>
<th>方法</th>
<th>返回值</th>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>Lambda</td>
<td>表达式条件，仅支持实体基础成员（不包含导航对象）</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>string, parms</td>
<td>原生 sql 语法条件，Where(&quot;id = ?id&quot;, new { id = 1 })</td>
</tr>
<tr>
<td>Where</td>
<td>&lt;this&gt;</td>
<td>T1 | IEnumerable&lt;T1&gt;</td>
<td>传入实体或集合，将其主键作为条件</td>
</tr>
<tr>
<td>WhereExists</td>
<td>&lt;this&gt;</td>
<td>ISelect</td>
<td>子查询是否存在</td>
</tr>
<tr>
<td>CommandTimeout</td>
<td>&lt;this&gt;</td>
<td>int</td>
<td>命令超时设置(秒)</td>
</tr>
<tr>
<td>WithTransaction</td>
<td>&lt;this&gt;</td>
<td>DbTransaction</td>
<td>设置事务对象</td>
</tr>
<tr>
<td>WithConnection</td>
<td>&lt;this&gt;</td>
<td>DbConnection</td>
<td>设置连接对象</td>
</tr>
<tr>
<td>ToSql</td>
<td>string</td>
<td></td>
<td>返回即将执行的 SQL 语句</td>
</tr>
<tr>
<td>ExecuteAffrows</td>
<td>long</td>
<td></td>
<td>执行 SQL 语句，返回影响的行数</td>
</tr>
<tr>
<td>ExecuteDeleted</td>
<td>List&lt;T1&gt;</td>
<td></td>
<td>执行 SQL 语句，返回被删除的记录</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">更新日志</title>
    <id>https://freesql.net/reference/change-log.html</id>
    <link href="https://freesql.net/reference/change-log.html"/>
    <updated>2022-08-30T11:01:06.000Z</updated>
    <content type="html"><![CDATA[<h1 id="更新日志" tabindex="-1"> 更新日志</h1>
<p>大约每三个月一次版本号，暂时以修复 bug 为主</p>
<h2 id="v3-2-666" tabindex="-1"> v3.2.666</h2>
<ul>
<li><strong>增加 WithTempQuery + FromQuery 嵌套查询功能；</strong> #1192</li>
<li><strong>增加 FreeSql.Provider.OracleOledb 解决 US7ASCII 中文乱码问题；</strong></li>
<li><strong>增加 UnionALL 联合查询；</strong> #1106 #1104 #668 #478 #432 #213 #138</li>
<li>增加 WithMemory 基于内存查询，对标 WithSql；</li>
<li>增加 AuditValue ObjectAuditBreak 实现对象只触发一次审计事件；</li>
<li>增加 IncludeByPropertyName 重载 then 参数；#1214</li>
<li>增加 IInsertOrUpdate.SetSource(sql) 重载方法；</li>
<li>增加 DynamicFilterCustom 增加支持 Expression 返回值；</li>
<li>修复 UseGenerateCommandParameterWithLambda(true) 与 GroupBy 查询不生效 bug；</li>
<li>修复 ToList 子查询开启参数化重复参数的 bug；#1205</li>
<li><strong>修复 string[] JsonMap bug；</strong> #653</li>
<li>修复 ManyToMany 不会触发 AsTable 的 bug；</li>
<li>修复 Clickhouse Insert AsTable 表名处理 bug；</li>
<li>修复 ClickHouse 单条记录插入\t \n /失败的 bug；</li>
<li>修复 子查询使用基类 + AsType 可能产生的 bug；#1215</li>
<li>修复 SqlServer2005/2008 Skip 问题（未设置 Take 时）；</li>
<li>修复 MySql/SqlServer DbFirst 获取字段位置的问题；</li>
<li>修复 DbContext/Repository Primary decimal 状态管理 key 精度处理 bug；</li>
<li>修复 DbContext/Repository 无构造函数的实体对象不跟踪问题；</li>
<li>修复 ToSql AsProperty 大小别名问题；</li>
<li>优化 IncludeByPropertyName + AsType；</li>
<li>优化 字典crud TableInfo 合并规则；#1180</li>
<li>优化 IUpdate.Set 字符串累加本身为 NULL 的情况；#1209</li>
<li>优化 WhereDynamicFilter DateRange 情况；</li>
<li>优化 Oracle IN :ids 值传入 IList 时报错；</li>
<li>优化 Dameng 单独适配 netcore3.1；#1094</li>
<li><strong>优化 PrevReheatConnectionPool 预热；</strong></li>
<li>优化 全局过滤器禁用时子查询传播问题；#1208</li>
<li><strong>优化 子查询别名为 a 的情况；#1201</strong></li>
</ul>
<h2 id="v3-2-665" tabindex="-1"> v3.2.665</h2>
<ul>
<li>增加 IsVersion string 字符串乐观锁；<a href="https://github.com/dotnetcore/FreeSql/issues/1178" target="_blank" rel="noopener noreferrer">#1178</a></li>
<li>增加 IUpdate.SetSource ignoreVersion 参数可实现忽略乐观锁；<a href="https://github.com/dotnetcore/FreeSql/issues/1161" target="_blank" rel="noopener noreferrer">#1161</a></li>
<li>增加 IInsertOrUpdate.SetSource(items, tempPrimarys) 指定临时主键参数；<a href="https://github.com/dotnetcore/FreeSql/issues/1160" target="_blank" rel="noopener noreferrer">#1160</a></li>
<li>增加 DbContext/Repository 审计日志 ChangeInfo 增加属性 EntityType；</li>
<li>修复 SqlServer WithLock 子查询不生效的 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/1159" target="_blank" rel="noopener noreferrer">#1159</a></li>
<li>修复 AsTreeCte + AsTable 无效的 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/1176" target="_blank" rel="noopener noreferrer">#1176</a></li>
<li>修复 UseGenerateCommandParameterWithLambda(true) 问题；<a href="https://github.com/dotnetcore/FreeSql/issues/1173" target="_blank" rel="noopener noreferrer">#1173</a> <a href="https://github.com/dotnetcore/FreeSql/issues/900" target="_blank" rel="noopener noreferrer">#900</a></li>
<li>修复 SetSource 临时主键重载方法 + Column 设置 Name 后无效的 bug；</li>
<li>修复 Dto 映射查询 Negate 表达式解析 bug；</li>
<li>修复 pgsql OldName + XML 注释迁移代码顺序问题；</li>
<li>优化 string Contains 模糊查找 % 的情况；</li>
</ul>
<h2 id="v3-2-664" tabindex="-1"> v3.2.664</h2>
<ul>
<li><strong>修复 UseGenerateCommandParameterWithLambda 子查询并发 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/1155" target="_blank" rel="noopener noreferrer">#1155</a> （重要）</strong></li>
<li>修复 pgsql Dto 映射使用常量 false 转换失败；</li>
<li>修复 IIF 三元表达式树解析 bool HasValue 问题；</li>
<li>修复 MySqlConnector BulkCopy 映射顺序问题；</li>
<li>优化 XML 注释读取支持 interface；</li>
<li>support provider、Extensions Exceptions 多语言</li>
</ul>
<h2 id="v3-2-662" tabindex="-1"> v3.2.662</h2>
<ul>
<li><strong>调整 pgsql10 自增映射使用 GENERATED BY DEFAULT AS IDENTITY，低版本仍然使用 serial；</strong></li>
<li><strong>增加 PgArrayToMany 专属导航属性；<a href="https://github.com/dotnetcore/FreeSql/issues/1145" target="_blank" rel="noopener noreferrer">#1145</a></strong></li>
<li>增加 ObservableCollection 级联加载和保存；</li>
<li>优化 FluentApi 继承关系可直接 ConfigEntity&lt;BaseEntity&gt; 生效；#1144</li>
<li>修复 达梦 min pool size 预热数量匹配 bug；</li>
<li>修复 v3.2.620 - v3.2.661 子查询 sum/min/max/avg 默认加 isnull 防止为 NULL 情况，日期类型处理错误 #1140 1b84a0069679c92ccaff9aa8c33023e4d34262cd</li>
<li>修复 AsTable 子查询未传播的问题；#1103</li>
<li>修复 IncludeByPropertyName fromFirstTable 判断错误；#278</li>
<li>修复 GroupBy 特殊情况下 AsProperty 无效的 bug；#1141</li>
<li>修复 MySql CodeFirst OldName + Comment 迁移问题；#1147</li>
<li>修复 pgsql DbFirst 未正确获取 Position 值；#1154</li>
</ul>
<h2 id="v3-2-661" tabindex="-1"> v3.2.661</h2>
<ul>
<li>增加 UseMappingPriority 指定映射优先级；<a href="https://github.com/dotnetcore/FreeSql/issues/387" target="_blank" rel="noopener noreferrer">#387</a> <a href="https://github.com/dotnetcore/FreeSql/issues/69" target="_blank" rel="noopener noreferrer">#69</a> <a href="https://github.com/dotnetcore/FreeSql/issues/99" target="_blank" rel="noopener noreferrer">#99</a></li>
<li>增加 AuditValueEventArgs Object 参数；<a href="https://github.com/dotnetcore/FreeSql/issues/1128" target="_blank" rel="noopener noreferrer">#1128</a></li>
<li>修复 pgsql varchar(120) CodeFirst 迁移不修改长度；</li>
<li>修复 ISelect.InsertInto 未执行自动迁移；</li>
<li>修复 UseCommandParameterWithLambda IN 参数化判断 的逻辑 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/1137" target="_blank" rel="noopener noreferrer">#1137</a></li>
<li>优化 连接池不可用、定时检查；</li>
<li>优化 Limit + Sum/Avg/Max/Min 为嵌套查询；</li>
<li>优化 GroupBy Page 未排序的查询；<a href="https://github.com/dotnetcore/FreeSql/issues/1126" target="_blank" rel="noopener noreferrer">#1126</a></li>
</ul>
<h2 id="v3-2-651" tabindex="-1"> v3.2.651</h2>
<ul>
<li><strong>增加 DTO 映射非导航属性的子表查询 ToList，可直接返回集合；</strong></li>
<li>增加 Array.Any(x =&gt; <a href="http://x.id" target="_blank" rel="noopener noreferrer">x.id</a> == <a href="http://a.Id" target="_blank" rel="noopener noreferrer">a.Id</a> &amp;&amp; ..) 表达式树解析；<a href="https://github.com/dotnetcore/FreeSql/issues/243" target="_blank" rel="noopener noreferrer">#243</a></li>
<li>增加 pgsql numeric -&gt; BigInteger 映射；<a href="https://github.com/dotnetcore/FreeSql/issues/1100" target="_blank" rel="noopener noreferrer">#1100</a></li>
<li>增加 <a href="https://github.com/dotnetcore/FreeSql/issues/1108" target="_blank" rel="noopener noreferrer">#1108</a> Exception 国际化；</li>
<li>增加 DynamicFilterCustom 参数 object sender；<a href="https://github.com/dotnetcore/FreeSql/issues/1113" target="_blank" rel="noopener noreferrer">#1113</a></li>
<li>增加 Fluent API 以继承接口的形式配置实体；<a href="https://github.com/dotnetcore/FreeSql/issues/937" target="_blank" rel="noopener noreferrer">#937</a></li>
<li>修复 Oracle AsTable 分表嵌套 SQL 拼错错误；<a href="https://github.com/dotnetcore/FreeSql/issues/1098" target="_blank" rel="noopener noreferrer">#1098</a></li>
<li>修复 AsTable ManyToMany IncludeMany 无效的问题；<a href="https://github.com/dotnetcore/FreeSql/issues/1103" target="_blank" rel="noopener noreferrer">#1103</a></li>
<li>修复 AsTable 分表 ToAggregate 无法得到汇总；<a href="https://github.com/dotnetcore/FreeSql/issues/1115" target="_blank" rel="noopener noreferrer">#1115</a></li>
<li>修复 Repository.DataFilter 对 GlobalFilter 控制无效的 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/1028" target="_blank" rel="noopener noreferrer">#1028</a> <a href="https://github.com/dotnetcore/FreeSql/issues/846" target="_blank" rel="noopener noreferrer">#846</a></li>
<li>修复 IN 查询区分 varchar/nvarchar；</li>
<li>修复 Oracle clob 参数化类型设置问题；<a href="https://github.com/dotnetcore/FreeSql/issues/1116" target="_blank" rel="noopener noreferrer">#1116</a></li>
<li>修复 MySql 子查询 Enum MapType(int) 表达式判断解析 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/1118" target="_blank" rel="noopener noreferrer">#1118</a></li>
<li>优化 AsTable 自动分表 Where Equal 判断；<a href="https://github.com/dotnetcore/FreeSql/issues/1104" target="_blank" rel="noopener noreferrer">#1104</a></li>
<li>优化 子查询 sum/min/max/avg 默认加 isnull 防止为 NULL 情况；</li>
<li>优化 EnableCascadeSave 级联保存执行逻辑，提升性能；</li>
<li>优化 RawJoin 支持 FULL JOIN 等自定义联表映射；</li>
<li>优化 IncludeMany 三级导航对象自动 _included；<a href="https://github.com/dotnetcore/FreeSql/issues/1113" target="_blank" rel="noopener noreferrer">#1113</a></li>
</ul>
<h2 id="v3-2-100-v3-2-640" tabindex="-1"> v3.2.100 - v3.2.640</h2>
<ul>
<li><strong>增加 InsertDict/UpdateDict/DeleteDict/InsertOrUpdateDict 针对字典的 CUD 方法；#481</strong></li>
<li>增加 UseSlaveWeight 读权重设置；#1046</li>
<li><strong>增加 [Table(AsTable = xx)] 自动分表特性，待完善；#1066</strong></li>
<li>增加 <a href="https://freesql.net/guide/freesql-provider-sqlitecore.html" target="_blank" rel="noopener noreferrer">FreeSql.Provider.SqliteCore</a> 支持 Sqlite 加密；</li>
<li>增加 IList&lt;T&gt; IncludeByPropertyName 扩展方法，支持字符串参数；</li>
<li><strong>增加 DbSet/Repository DeleteCascadeByDatabase 级联删除(基于数据库)</strong>；</li>
<li>调整 DbSet/Repository EnableAddOrUpdateNavigateList 支持 OneToOne 级联保存、级联删除(基于对象)；</li>
<li>修复 Delete.Where in 查询为空时，异步操作仍然执行删除；#1068 <strong>【受影响版本 v3.2.302】</strong></li>
<li>修复 InsertOrUpdateDict 异常；#1067 <strong>【受影响版本 v3.2.301、v3.2.300、v3.2.200】</strong></li>
<li>修复 InsertDict 部分新功能遗留问题(特别是 Oracle)；<strong>【受影响版本 v3.2.301、v3.2.300、v3.2.200】</strong></li>
<li>修复 InsertDict/UpdateDict 等字典操作在 DbContext.Orm 下无法使用的 bug；#1064 <strong>【受影响版本 v3.2.300、v3.2.200】</strong></li>
<li>修复 MapType 复杂表达式树解析 bug；#1062</li>
<li>修复 UseGenerateCommandParameterWithLambda 对不可参数化的数据类型冲突的 bug；#1061 #900</li>
<li>修复 MySql Set 类型空格处理问题；#1059</li>
<li>修复 SaveManyAsync 多对多历史漏改的问题（同步无问题）；</li>
<li>修复 OR 表达式处理情况；#1047</li>
<li>修复 ClickHouse 设置 NoneParameter 会报错问题；</li>
<li>修复 Clickhouse 连接池使用问题；#646 #968 #969 #943</li>
<li>修复 pgsql IList -&gt; JArray 映射；#1092</li>
<li>修复 pgsql DbFirst IsPrimary bug；</li>
<li>修复 JsonMap 与导航属性的联表查询报错的 bug；#996</li>
<li>修复 子查询 WhereIf 可能失败的 bug；</li>
<li>修复 StringLength 设置后 IsNullable = false 无生效的问题；</li>
<li>修复 UseConnectionFactory 参数化问题；</li>
<li>修复 参数值为原始 DbParameter 时转换类型报错；</li>
<li>修复 UseGenerateCommandParameterWithLambda 子查询 IN bug；#900</li>
<li>修复 InsertValueSql 在仓储插入后不返回最新值；</li>
<li>完善 SqlServer BulkCopy 插入 DateTime 最小值问题；</li>
<li><strong>优化 导航集合属性访问，可省略 AsSelect；</strong></li>
<li>优化 DbContext/Repository Update 实体有 ServerTime 既使无状态变化也必然更新的逻辑；</li>
<li>优化 DbContext/Repository 插入非主键自增回填；</li>
<li>优化 ToList&lt;Dto&gt; jsonb 映射；</li>
<li>优化 dywhere IN 查询按 500 元素分割；#1091</li>
<li>优化 IIF 表达式解析；</li>
</ul>
<h2 id="v3-0-100" tabindex="-1"> v3.0.100</h2>
<ul>
<li><strong>增加 南大通用 Gbase 国产数据库支持；</strong></li>
<li><strong>增加 ClickHouse 数据库语法支持；</strong></li>
<li>增加 DbContext/Repository 比较变化方法 CompareState；</li>
<li><strong>增加 DynamicFilter Custom 自定义解析；</strong></li>
<li>增加 ToDataTableByPropertyName 动态查询功能；</li>
<li>优化 兼容排序 OrderBy(a =&gt; new {}) 语法；</li>
<li>优化 pgsql jsonb 映射，支持 List，mysql limit in 子查询；</li>
<li>优化 InsertOrUpdate&lt;&gt; 使用 InsertOrUpdate&lt;list&lt;&gt;&gt;时，提示友好异常。</li>
<li>修复 BulkCopy 与线程事务未传播的 bug；#962</li>
<li>修复 AsTreeCte + RereadSql 不能同时使用的 bug；#964</li>
<li>修复 FreeSql.Generator 工具生成 model 失败 <a href="https://github.com/dotnetcore/FreeSql/issues/882" target="_blank" rel="noopener noreferrer">#882</a></li>
</ul>
<h2 id="v2-6-100" tabindex="-1"> v2.6.100</h2>
<ul>
<li>修复 fix sqlite AddMinutes seconds-&gt;minutes <a href="https://github.com/dotnetcore/FreeSql/issues/774" target="_blank" rel="noopener noreferrer">#774</a></li>
<li>修复 Update 操作的时候 CanUpdate=false 未生效 <a href="https://github.com/dotnetcore/FreeSql/issues/803" target="_blank" rel="noopener noreferrer">#803</a></li>
<li>优化 将 Freesql 的 dynamicfilterinfo 标记为[serialable] <a href="https://github.com/dotnetcore/FreeSql/issues/802" target="_blank" rel="noopener noreferrer">#802</a></li>
<li>修复 Sqlite where.And(x =&gt; x.PublishTime.Year == 2021); 查询问题 <a href="https://github.com/dotnetcore/FreeSql/issues/802" target="_blank" rel="noopener noreferrer">#804</a></li>
<li>增加 支持符号调试 <a href="https://github.com/dotnetcore/FreeSql/issues/679" target="_blank" rel="noopener noreferrer">#679</a></li>
<li>增加 IUnitOfWork.States 自定义状态管理，便于扩展；</li>
</ul>
<h2 id="v2-5-300" tabindex="-1"> v2.5.300</h2>
<ul>
<li>修复 ISelect.AsTable 后 .ToUpdate/ToDelete 无效的 bug；#815</li>
<li>修复 MERGE INTO 别名与 SQL 关键字冲突的 bug；#816</li>
<li>修复 Oracle IncludeMany IN 元素超过 500 数目的问题；#843</li>
<li>fix IgnoreColumns CanUpdate false not work #803</li>
<li>fix sqlite where datetime year,month 查不出来数据,Ticks 精度到毫秒，处理 Millisecond 无值的情况 #804</li>
<li>Add Serializable #802</li>
<li>Add string.Concat 返回 string.Empty</li>
</ul>
<h2 id="v2-5-200" tabindex="-1"> v2.5.200</h2>
<ul>
<li>修复 Repository/DbContext 批量修改可能无效的 bug；#709</li>
<li>fix sqlite AddMinutes seconds -&gt; minutes #774</li>
<li>fix ExecuteMySqlBulkCopyAsync .net core 3.1 Method not found #783</li>
</ul>
<h2 id="v2-5-100" tabindex="-1"> v2.5.100</h2>
<ul>
<li>增加 ISelect.Page(BasePagingInfo pagingInfo) 方法重载；</li>
<li>修复 IncludeMany + AsTreeCte 不能组合使用的问题；#760</li>
<li>修复 Ado.CommandFluent 存储过程参数化问题；#739</li>
<li>修复 IUpdate.SetDto bug；#754</li>
<li>修复 pgsql 中 hstore 中 value 错误赋值为 key 的问题，并允许 value 值为 NULL；</li>
<li>修复 byte[]类型的乐观锁初始化问题；</li>
</ul>
<h2 id="v2-3-200" tabindex="-1"> v2.3.200</h2>
<ul>
<li>修复 Repository/DbContext 批量修改可能无效的 bug；#709</li>
<li>修复 Oracle/Dameng 分组查询后分页的 bug；#710</li>
<li>优化 fsql.Transaction 线程事务；</li>
</ul>
<h2 id="v2-3-106" tabindex="-1"> v2.3.106</h2>
<ul>
<li>修复 v2.3.100 GlobalFilter 在 Repository 失效的 bug；</li>
<li>优化 BaseDbProvider、AdoNetExtensions 内部定义；</li>
<li>增加 IUpdate.SetSource 批量更新时指定主键；#337</li>
</ul>
<h2 id="v2-3-100" tabindex="-1"> v2.3.100</h2>
<ul>
<li><strong>增加 FreeSql.Provider.Custom 自定义适配访问任何数据库；</strong></li>
<li>增加 Column 特性 RewriteSql/RereadSql；</li>
<li>增加 ISelect.OrderByRandom() 随机排序适配；</li>
<li>增加 SqlExt.DistinctCount 扩展方法；#674 #533</li>
<li>增加 Aop Before/After States 共享状态；</li>
<li>优化 ManyToMany 导航属性子查询支持 ToList；</li>
<li>优化 HzyTuple 子查询解析；</li>
<li>优化 指定 Dto 查询对 c# 字段的支持；</li>
<li>优化 GlobalFilter 子查询传播重复的问题；#642</li>
<li>优化 Console.Write 平台兼容问题；#643</li>
<li>优化 DbSet/Repository 级联保存时，忽略未配置的导航属性；</li>
<li>优化 FreeSql.Extensions.Linq Select 选定字段查询方法；#674 #533</li>
<li>优化 Repository.DataFilter 可禁用 GlobalFilter；</li>
<li>优化 WhereDynamicFilter；</li>
<li>修复 延时属性时级联保存失败的 bug；</li>
<li>修复 分组查询后，无法使用子查询的问题；</li>
<li>修复 UseGenerateCommandParameterWithLambda + Enum + MapType(string) bug；</li>
<li>修复 ToChunk + IncludeMany 二级集合属性的 bug；</li>
<li>修复 JsonMap 序列化判断 bug；</li>
<li>修复 Sqlite DbFirst 获取自增的 bug；</li>
<li>修复 Oracle DbFirst date 类型 bug；#627</li>
<li>修复 ISelect2`16 OrderByIf bug；</li>
<li>修复 神通 Linux not supported 问题；#656</li>
<li>修复 WhereDynamicFilter 普通多表查询时别名判断的 bug；</li>
<li>修复 AsTreeCte 事务传播 bug；</li>
<li>修复 表达式树解析 MapType 把小数位转换丢失的 bug；</li>
<li>修复 SqlServer 支持 Chinese_PRC_CS_AS 区分小大写；#684</li>
</ul>
<h2 id="v2-0-105" tabindex="-1"> v2.0.105</h2>
<ul>
<li>修复 <a href="http://Ado.Net" target="_blank" rel="noopener noreferrer">Ado.Net</a> 扩展方法的多表查询 bug；#592</li>
<li>优化 ToSql 别名大小写问题；#467</li>
<li><strong>优化 IUnitOfWork/DbContext/Repository .Orm.Ado 和 CRUD 都与自身事务保持一致；</strong></li>
<li>完善 IDelete WhereIf(bool, sql) 方法；</li>
</ul>
<h2 id="v2-0-102" tabindex="-1"> v2.0.102</h2>
<ul>
<li>优化 DbFirst 模式长内容未设置 StringLength = -1 写入问题；</li>
<li>优化 子查询(多表)别名；</li>
<li>优化 IUpdate.Set 支持位运算表达式树解析；</li>
<li>优化 单表查询 ExpressionTree 性能；</li>
<li>修复 ISelect.InsertInto 设置别名时无法使用的错误；#576</li>
</ul>
<h2 id="v2-0" tabindex="-1"> v2.0</h2>
<ul>
<li>增加 IncludeByPropertyName 按属性名进行 Include/IncludeMany 操作；#278</li>
<li>增加 ISelect&lt;...&gt; 多表查询 HzyTuple 新姿势；（感谢 HZY 贡献）</li>
<li>增加 ISelect Cancel 用于取消本次查询；</li>
<li>增加 IncludeIf/IncludeByPropertyNameIf 方法；</li>
<li>增加 表达式树函数解析 byte[] Length；#505</li>
<li>增加 FreeSql Async CancellationToken 参数；#537</li>
<li>增加 FreeSql.DbContext/Repository Async CancellationToken 参数；#537</li>
<li>增加 Oracle/达梦 BulkCopy 支持；</li>
<li>增加 IsVersion 对 byte[] 的支持；#548</li>
<li>增加 IN 参数扩展 where id in @ids；#560</li>
<li>增加 IAdo.QuerySingle 查询单条记录；#560</li>
<li>增加 pgsql 表达式树解析 hstore[&quot;&quot;]；</li>
<li>优化 varchar/nvarchar 的 NoneParameter 处理；#519</li>
<li>优化 表达式树 SqlExt.IsNull 对布尔类型的解析；#500</li>
<li>优化 MapRead 对 NULL 字段的处理；</li>
<li>优化 表达式树三元表达式解析，当 Test 为变量时不解析成 case when end；</li>
<li>优化 AsTreeCte 对 MySql 5.6 的兼容；#536</li>
<li>优化 分页 Page(..).Count() 顺序问题；</li>
<li>优化 自动 IsIgnore 处理；</li>
<li>移除 ISelect&lt;T&gt;/IUpdate&lt;T&gt;/IDelete&lt;T&gt; class 约束限制；</li>
<li>修复 线程事务嵌套事务的 bug；#502</li>
<li>修复 #454 优化遗留的 bug，影响 Aop.AuditValue 事件；#521</li>
<li>修复 实体类拥有构造参数时，ToList&lt;DTO&gt; 映射查询无效的 bug；</li>
<li>修复 FreeSql.Generator 处理 SqlServer 默认值的问题；</li>
<li>修复 SqlServer RowNumber 分页有可能产生顺序不对的 bug；</li>
<li>修复 .net5 单文本部署读取注释报错；</li>
</ul>
<h2 id="v1-10-1" tabindex="-1"> v1.10.1</h2>
<ul>
<li>增加 ISelect.InsertInto 将查询转换为 INSERT INTO t1 SELECT ... FROM t2 执行插入；#469</li>
<li>增加 GlobalFilter.ApplyOnly 继承的实体才生效；#495</li>
<li>增加 FreeSql.Generator 参数 -readkey 0 的设置；</li>
<li>优化 WhereDynamicFilter 支持 string 比较大小 &gt; &lt; &gt;= &lt;=；#479</li>
<li>优化 IncludeMany 筛选字段中未指定主键，并且 then.IncludeMany 继续向下，则自动附加查询主键；</li>
<li>优化 WhereDynamic 传入 DynamicFilterInfo 也能执行；</li>
<li>优化 WhereDynamic 支持按字段名、属性名匹配；</li>
<li>优化 实体类注释，基类在其他 Assembly 时也能读取；</li>
<li>优化 支持实体类使用 new 重写属性；</li>
<li>优化 ToAggregate 执行时忽略已设置的 OrderBy；</li>
<li>优化 dto 映射查询时忽略已指定的映射，避免重复查询字段；#494</li>
<li>优化 MySql CodeFirst 索引的建立 ；#498</li>
<li>补充 异步方法 ToListAsync(a =&gt; {}) 对 IncludeMany 的支持；</li>
<li>修复 AsTreeCte 开启自动迁移时，错误的创建了 as_tree_cte 表；#476</li>
<li>修复 内部 decimal 默认值在 core 3.1+ 报错的问题；</li>
<li>修复 decimal? 可空数字设置 Column Scale 无效的问题(decimal 正常)；</li>
<li>修复 DbContext/UnitOfWork EntityChangeReport 参数 BeforeObject 值无效的 bug；</li>
<li>修复 lambda 表达式解析变量转换时的 bug；#490</li>
<li>修复 Firebird Embedded 版本系统表 isidentity_type 兼容问题；</li>
<li>修复 Firebird Embedded 2.5 不支持 boolean 的 bug；</li>
</ul>
<h2 id="v1-9-0" tabindex="-1"> v1.9.0</h2>
<ul>
<li><strong>增加 FreeSql.Provider.Firebird 数据库实现 #443；</strong></li>
<li><strong>增加 IncludeMany(a =&gt; a.Childs).ToList(a =&gt; new { a.Childs }) 指定集合属性返回；</strong></li>
<li>增加 ISelect&lt;11..16&gt; 16 个联表查询；</li>
<li>增加 ISelect Aggregate(lambda, out var result) 方法；</li>
<li>增加 ISelect OrderByIf 方法 #446；</li>
<li>增加 ISelect OrderByPropertyName 方法 #446 #278 #361 #197；</li>
<li>增加 IUpdate/IDelete WhereIf 方法 #446；</li>
<li><strong>增加 ISelect/IInsert/IUpdate/IDelete CommandTimeout 方法设置命令超时；</strong></li>
<li><strong>增加 GlobalFilter.ApplyIf 创建动态过滤器；</strong></li>
<li>增加 SqlExt.IsNull 方法；</li>
<li>增加 Oracle DbFirst 视图的支持；</li>
<li>增加 IAdo.CommandFluent(sql) 方法执行 SQL 命令；</li>
<li>优化 string IsNullable = false 时插入 null 自动转为 &quot;&quot; #445；</li>
<li>优化 GetDbParamtersByObject 参数为字典时修剪 @?: 前辍 #456；</li>
<li>优化 SqlExt.Sum/Max/Min/Avg 同时支持开窗或普通聚合函数；</li>
<li>优化 ToSql FieldAliasOptions.AsProperty 别名问题；#467</li>
<li>优化 FreeSql.Generator -Match 支持生成一个表；</li>
<li>调整 FreeSql.Generator 移除 CanInsert = false 特性生成；</li>
<li>调整 AdoNet CRUD 扩展方法到 namespace FreeSql；</li>
<li>修正 SqlServer UseConnectionFactory 类型标识；</li>
<li><strong>修复 FreeSql.DbContext 对同一实体重复 Update，第二次无效的 Bug</strong>；</li>
<li>修复 ISelect Any(lambda) 条件被附加的问题，不便于再次使用 ISelect 对象；</li>
<li>修复 ISelect ToDelete/ToUpdate 事务对象未传播的 bug；</li>
<li>修复 ISelect Include 多表字段名相同（不区分大小时）时的 bug；</li>
<li><strong>修复 IAdo.Query 返回实体中带有延时导航属性，读取顺序不对的 bug</strong>；</li>
<li>修复 <a href="http://Ado.Net" target="_blank" rel="noopener noreferrer">Ado.Net</a> Crud 扩展方法事务的友好异常提示；</li>
<li>修复 使用查询参数化功能时 ToList 子查询未传播参数列表的 bug；#462</li>
<li><strong>修复 子查询 Count/Max/Min/Avg/Sum 使用了 Limit(1) 的 bug；#462</strong></li>
<li>修复 IAdo.Query&lt;匿名类&gt;(sql) 错误；</li>
<li>修复 SqlServer SqlBulkCopy IgnoreColumns 无效的 bug；</li>
<li>修复 达梦 DbFirst 获取字段 IsNullable 无效的问题；#454</li>
<li>补充 达梦 DbFirst int 类型识别；</li>
</ul>
<h2 id="v1-8-1" tabindex="-1"> v1.8.1</h2>
<ul>
<li><strong>增加 人大金仓 <a href="http://Ado.Net" target="_blank" rel="noopener noreferrer">Ado.Net</a> 实现 FreeSql.Provider.KingbaseES #325；</strong></li>
<li><strong>增加 DbContext/Repository BeginEdit/EndEdit 批量编辑数据的方法 #397；</strong></li>
<li>增加 FreeSql.Provider.SqlServerForSystem 使用 System.Data.SqlClient.dll 兼容更多运行平台 #401 #398 #395 #392 #391；</li>
<li><strong>增加 lambda 表达式树解析子查询 ToList + string.Join() 产生 类似 group_concat 的效果（适配了 sqlserver/pgsql/oracle/mysql/sqlite/达梦/金仓) #405；</strong></li>
<li>增加 IDbFirst.ExistsTable 方法判断表是否存在；</li>
<li>增加 IDbFirst.GetTableByName 方法获取单表信息，包括列详情、主键、唯一键、索引、备注；</li>
<li>增加 ICodeFirst.SyncStructure 强制同步参数 isForceSync #412；</li>
<li>增加 ISelect&lt;2..10&gt; 多表 WithSql 方法；</li>
<li><strong>增加 IDbConnection/IDbTransaction 对象的扩展方法 Select/Insert/Update/Delete 实现 CRUD</strong> #267；</li>
<li>增加 IAdo.GetDbParamtersByObject 方法获取 DbParameter[]；</li>
<li>增加 IAdo.ExecuteConnectTest 快速判断连接是否可用 #113；</li>
<li>增加 Aop.AuditDataReader 事件拦截 DataReader 读取值 #436；</li>
<li>修复 fsql.InsertOrUpdate 在同线程事务模式内使用的 bug #402；</li>
<li>修复 fsql.Ado.ExecuteDataTable 当记录不存在时，未返回 Columns 设置 #403；</li>
<li>修复 IInsert/IUpdate BatchProgress 异步执行不生效的 bug；</li>
<li>修复 1.7.1 IsNullable 遗留问题；</li>
<li>修复 Oracle nvarchar2 主键批量更新的问题；#411</li>
<li>修复 达梦 DbFirst 无法识别字段是否为主键的问题；</li>
<li>修复 SqlExt PartitionBy 无法传入多列的问题；</li>
<li>修复 WhereDynamicFilter System.Text.Json 反序化后的类型转换问题 #371；</li>
<li>修复 ISelect ToList&lt;T&gt;(&quot;id,title&quot;) 属性和字段顺序不同时的问题；</li>
<li>修复 Dto 映射查询属性名不区分大小写 bug #427；</li>
<li>修复 参数化 Column DbType 设置特殊值时的类型判断；</li>
<li>修正 UnitOfWorkManager Requierd 命名为 Required；</li>
<li>优化 pgsql DbFirst 序列的识别，以及 pgsql10 的自增识别；</li>
<li>优化 IsNullable = false 插入的数据值为 null 则以默认值插入（防止 DB 报错） #384；</li>
<li><strong>优化 GroupBy ToList lambda 中可以直接使用 a.Key；</strong></li>
<li>优化 NoneParameter Oracle 文本超长的问题；</li>
<li>优化 lambda 使用 a == null ? 1 : 0 支持类似这样直接判断实体的情况；</li>
<li>优化 IUpdate.SetSource 机制不更新主键字段；</li>
<li>优化 IUpdate.SetSource 无主键的错误提示；</li>
<li>优化 WhereDynamic 传入集合对象时，逻辑 OR 换为 IN；</li>
<li>优化 指定导航属性查询时，如果下级导航属性被 Include 过，则将他们也查询出来；</li>
<li><strong>完善 AsTreeCte + ToUpdate/ToDelete 实现树所有子节点删除或更新；</strong></li>
<li>完善 DbUpdateVersionException IsVersion 行版本异常；</li>
<li>完善 DbContext/UnitOfWork EntityChange 更新对象之前的值；</li>
<li>完善 ToChunk 分块加载查询，应用到 ISelect`1..10 中；</li>
<li>完善 ISelect&lt;T&gt;.WithSql 方法，支持传入参数化 #413；</li>
</ul>
<h2 id="v1-7-1-microsoft-data-sqliclient-兼容问题" tabindex="-1"> v1.7.1 (Microsoft.Data.SqliClient 兼容问题)</h2>
<ul>
<li>增加 ColumnAttribute Precision/Scale 设置；</li>
<li>增加 &quot;x1&quot;.First/FirstOrDefault 表达式函数解析；</li>
<li>调整 ColumnAttribute IsNullable 对 int/long 等值类型也可生效；#384</li>
<li>修复 $&quot;{a.Code}_{<a href="http://a.Id" target="_blank" rel="noopener noreferrer">a.Id</a>}&quot; lambda 解析当 {} 多于 3 个时的 bug（.net 内部机制很坑）；
<blockquote>
<ul>
<li>3 个 {} 时，Arguments[1..3] 解析出来是分开的</li>
<li>4 个 {} 时，Arguments[1] 只能解析这个出来，然后 [1] 里面是 NewArray []</li>
</ul>
</blockquote>
</li>
<li>补充 fsql.InsertOrUpdate UpdateColumns 数据存在时只更新指定的字段 #394 #330 #115 #17；</li>
</ul>
<h2 id="v1-7-0" tabindex="-1"> v1.7.0</h2>
<ul>
<li><strong>增加 实体属性 char 类型的映射 #381 #235</strong>；</li>
<li>增加 $&quot;{a.Code}_{<a href="http://a.Id" target="_blank" rel="noopener noreferrer">a.Id</a>}&quot; lambda 解析；</li>
<li>增加 IInsert/IUpdate BatchProgress 方法处理批量插入/更新时的进度；</li>
<li>增加 ISelect ToChunk 停止读取的逻辑控制 #360；</li>
<li>增加 FreeSql.Provider.PostgreSQL NetTopologySuite 类型映射，保留 LegacyPostgis 映射 #369；</li>
<li><strong>修复 DbSet/Repository 批量级联保存(ExecuteInserted)失败的问题 #362</strong>；</li>
<li>修复 多对多导航属性 AsSelect() 无法使用 .Count() 的问题 #362；</li>
<li>修复 WhereDynamicFilter 多级 Logic 未生效的 bug；</li>
<li>修复 WhereDynamicFilter 在 System.Text.Json 下的问题 #371；</li>
<li>修复 pgsql dbfirst 未处理数组类型生成的问题；</li>
<li>修复 dm7 dbfirst SQL 中存在特殊字符的问题；</li>
<li>修复 批量插入的时候报错 System.DivideByZeroException #365；</li>
<li>修复 CodeFirst + AsTable + 自动迁移，导致索引名重复的问题 #366；</li>
<li>修复 GroupBy(..).Count() 开启参数化无效的 bug #390； UseGenerateCommandParameterWithLambda</li>
<li><strong>补充 fsql.InsertOrUpdate IfExistsDoNothing 数据存在时不做任何事(不更新)</strong>；</li>
<li>补充 Ado.ExecuteDataTable Columns 包含 DataType 信息；</li>
<li>补充 EFCore StringLengthAttribute/DatabaseGeneratedAttribute 特性的支持；</li>
<li>补充 FreeSql.Extensions.Linq ThenBy/ThenByDescending 扩展方法 #380；</li>
<li>优化 FreeSql.Generator 生成实体类的时候处理数据库默认值；</li>
<li><strong>调整 FreeSql.Provider.SqlServer 引用 Microsoft.Data.SqlClient #391</strong>；</li>
</ul>
<h2 id="v1-6-0" tabindex="-1"> v1.6.0</h2>
<ul>
<li><strong>增加 人大金仓 OdbcKingbaseES 实现；#325</strong></li>
<li><strong>增加 神舟通用 ShenTong 实现；</strong></li>
<li><strong>增加 WhereDynamicFilter 操作符 Range/DateRange/Any/NotAny，实现范围/日期范围/In 查询；</strong></li>
<li><strong>增加 ISelect.AsTreeCte() 递归查询树表（向下或向上）；</strong></li>
<li>增加 IUnitOfWork Orm 属性直接访问 IFreeSql CRUD 事务与工作单元一致；</li>
<li><strong>增加 SqlExt 常用开窗函数的自定义表达式解析；</strong></li>
<li>增加 SqlExt.Case().When(..).End() 自定义表达式解析；</li>
<li>增加 SqlExt.GroupConcat MySql 函数解析；</li>
<li>增加 StringLength/MaxLength 对 byte[] 的支持；</li>
<li>修复 IFreeSql.InsertOrUpdate Merge into 未处理 CanUpdate 的问题；#330</li>
<li>修复 IUpdate Set(表达式) MapType 未生效的问题；</li>
<li>修复 表达式 Not 位运算符解析错误；#340</li>
<li>修复 Expression Or/And 扩展方法在多表中可能存在的错误；</li>
<li>修复 IncludeMany 只填充子属性中双向关系的 ManyToOne 对象值；</li>
<li>修复 Select`2-10 ToOne/First 没有处理 Limit(1) 的 bug；</li>
<li>修复 [JsonMap] 属性在 lambda 表达式中解析的 bug；</li>
<li>修复 sqlserver 解析 cast(.. as nvarchar) 截断长度 30 的问题；#335</li>
<li>优化 mysql StringLength/MaxLength -2 产生 LongText 映射；</li>
<li>优化 兼容 pgsql 9.4 CodeFirst/DbFirst；</li>
<li>优化 sqlserver 表中带点 codefirst；</li>
<li>测试 支持 mysql json 类型；</li>
</ul>
<h2 id="v1-5-0-好久不见" tabindex="-1"> v1.5.0 (好久不见)</h2>
<ul>
<li>修复 non public ctor #291；</li>
<li>修复 浮点类型 NoneParameter 不使用科学字符串表示；</li>
<li>修复 IgnoreColumns 相关方法解析表达式 a =&gt; new [] { &quot;Id&quot; .. } 无效的 bug；</li>
<li>修复 Column(ServerTime=xxx) MySql 下无法保留精度的问题；</li>
<li>修复 ISelect.ToDataTable(lambda) 未使用 AsProperty 返回数据；</li>
<li>修复 IUpdate.Set(a =&gt; a.xx = null) 表达式解析 bug；#311</li>
<li>修复 Enum 类型无元素时的错误；</li>
<li><strong>增加 IFreeSql.InsertOrUpdate 方法；</strong></li>
<li><strong>增加 ISelect.WhereDynamicFilter 方法实现动态过滤条件（与前端交互）；</strong></li>
<li><strong>增加 表达式解析 yyyyMMdd 常用 c# 日期格式化；</strong></li>
<li>增加 WhereCascade/GlobalFilter 表达式子查询的支持；</li>
<li>增加 [Description] 元数据注释，优先级低于 c# 代码注释；</li>
<li>增加 IUpdate.SetIf 方法；</li>
<li><strong>增加 IUpdate.SetSourceIgnore 方法，可实现忽略 null 属性的更新；</strong></li>
<li>增加 FreeSqlBuilder.UseExitAutoDisposePool 方法；</li>
<li>优化 Guid GetDefaultValue 可能导致的错误；</li>
<li><strong>优化 移除 fsql.Transaction 线程事务超时提交机制；#323</strong></li>
<li>调整 BaseEntity，移除 BaseTreeEntity、Tenant 租户，改变事务习惯；</li>
</ul>
<h2 id="v1-4-0" tabindex="-1"> v1.4.0</h2>
<ul>
<li><strong>增加 FreeSql.Provider.Dameng 基于 DmProvider <a href="http://Ado.net" target="_blank" rel="noopener noreferrer">Ado.net</a> 访问达梦数据库；</strong></li>
<li><strong>增加 FreeSql.DbContext OnModelCreating 虚方法，实现在 DbContext 使用 FluentApi；</strong></li>
<li>增加 FreeSql.DbContext 与 EFCore 相似的 FluentApi 对动态类型的处理；#281</li>
<li>移除 FreeSql.Extensions.EfCoreFluentApi，功能移至 FreeSql.DbContext；</li>
<li><strong>增加 FreeSqlBuilder 自动识别 EFCore 实体特性 Key/Required/NotMapped/Table/Column；</strong></li>
<li>增加 IInsert InsertColumns/IgnoreColumns 方法重载输入 string[]；#275</li>
<li>增加 DbFirst 获取字段的默认值信息；</li>
<li>增加 FreeSql.Generator -Match 参数只生成匹配的表；</li>
<li>增加 FreeSql.Extensions.JsonMap FluentApi 扩展方法；#279</li>
<li>增加 DbFirst DbColumnInfo Position 属性，字段默认位置；</li>
<li><strong>增加 UnitOfWorkManager 工作单元管理器，实现多种传播事务，移除 UnitOfWork.Current 静态属性；</strong><a href="https://github.com/dotnetcore/FreeSql/issues/289" target="_blank" rel="noopener noreferrer">#289</a></li>
<li>增加 DbContextOptions.EnableGlobalFilter 设置是否在 DbContext/Repository 中启用全局过滤器（默认 true）；</li>
<li>优化 主键 Guid 自动赋值的优先级，低于 Aop.AuditValue 事件（实现自定义 Guid 值）；</li>
<li>优化 WhereDynamic 传入 string 的时候自动转为主键的类型值；</li>
<li>修复 ISelect.From 内部 WhereIf 二次表达式解析 bug；
po</li>
<li><strong>增加 GroupBy ToDictionary 返回字段的查询方法，TKey 为 GroupBy 选择的对象；</strong></li>
<li>调整 GroupBy 所有方法不使用 DTO 映射规则；</li>
<li>调整 IUpdate.SetDto 也支持 IgnoreColumns 的逻辑；</li>
<li>调整 ISelect linq to sql 和 queryable 实现依赖移至 FreeSql.Extensions.Linq；</li>
</ul>
<h2 id="v1-3-5" tabindex="-1"> v1.3.5</h2>
<ul>
<li>修复 IncludeMany 第 3 层无法加载的问题，IncludeMany(a =&gt; a.Parent.Parent.Childs)；</li>
<li>修复 PostgreSQL CodeFirst/DbFirst 系统表的版本兼容问题；</li>
<li>增加 EfCoreFluentApi HasData 设定 CodeFirst 种子数据；</li>
<li>增加 DbContextOptions.NoneParameter 设置是否使用参数化执行 Insert/Update；</li>
</ul>
<h2 id="v1-3-4" tabindex="-1"> v1.3.4</h2>
<ul>
<li><strong>调整 Repository 接口定义，合并为一个 IBaseRepository；</strong></li>
<li>调整 移除对 System.ValueType 的依赖，减少版本冲突问题；（目前 FreeSql.dll 无任何依赖）</li>
<li><strong>调整 Oracle StringLength/MaxLength -1 时候映射为 nclob；</strong></li>
<li>调整 IInsert/IUpdate NoneParameter 方法，增加参数 isNotCommandParameter 可设置是否使用参数化；</li>
<li>调整 FreeSqlBuilder，准备移除 UseEntityPropertyNameConvert/UseSyncStructureToLower/UseSyncStructureToUpper 方法；<a href="https://github.com/dotnetcore/FreeSql/issues/260" target="_blank" rel="noopener noreferrer">#260</a>；</li>
<li>移除 In 多列表达式函数解析 <a href="https://github.com/dotnetcore/FreeSql/issues/243" target="_blank" rel="noopener noreferrer">#243</a>；</li>
<li>优化 IncludeMany 扩展方法对 T1 不自动迁移；</li>
<li>优化 BulkCopy 对可空类型的属性处理； <a href="https://github.com/dotnetcore/FreeSql/issues/227" target="_blank" rel="noopener noreferrer">#227</a></li>
<li>优化 IAdo.Query 方法，当传入带主键特性的实体时，防止主键列为 null 时导致整行记录也为 null；</li>
<li>优化 TableInfo 元数据对 interface 实现类 IsVirtual 重写的判断（增加 IsFinal == false）；</li>
<li>优化 Navigate 属性未设置 set 时的友好错误提示；</li>
<li>优化 延时属性重写类对 protected set 的支持；</li>
<li><strong>优化 ConnectionPool 提升被动连接断开的体验（会卡的可以升级）；</strong></li>
<li>优化 集合导航属性表达式中忘记使用 AsSelect() 的友好错误提示；</li>
<li><strong>增加 FreeSqlBuilder UseNameConvert 方法，类名、属性名都生效；</strong></li>
<li><strong>增加 CodeFirst 实体类注释 -&gt; 表备注，之前只能属性注释 -&gt; 字段备注；</strong></li>
<li>增加 FreeSql.Generator Sqlite 数据库生成实体类；</li>
<li><strong>增加 Sqlite DbFirst 实现；</strong></li>
<li>增加 Oracle clob/nclob 大文本类型读写支持；<a href="https://github.com/dotnetcore/FreeSql/issues/259" target="_blank" rel="noopener noreferrer">#259</a>；</li>
<li><strong>增加 ISelect.ToTreeList 扩展方法查询数据，加工为树型 List；(注意：实体需要配置父子导航属性)</strong></li>
<li>增加 ISelect`1 ToDictionary 方法查询返回字典；</li>
<li>增加 Pgsql JToken/JObject/JArray 索引访问的表达式解析；</li>
<li>增加 object.Equals 表达式解析；</li>
<li>增加 ISelect`1 AsQueryable 方法，实现将 ISelect 转换为 IQueryable 类型；</li>
<li>增加 ISelect.RawJoin 方法以便实现 Outer Apply 查询；<a href="https://github.com/dotnetcore/FreeSql/issues/200" target="_blank" rel="noopener noreferrer">#200</a>；</li>
<li>增加 IAdo.ConnectionString 属性返回 UseConnectionString 传入的值；</li>
<li>完善 表达式拼接方法，从 T1-T5；<a href="https://github.com/dotnetcore/FreeSql/issues/256" target="_blank" rel="noopener noreferrer">#256</a>；</li>
<li>修复 因兼容 <a href="https://github.com/dotnetcore/FreeSql/issues/184" target="_blank" rel="noopener noreferrer">#184</a> 导致 MySql Enum 表达式解析为 int 的 bug；</li>
<li>修复 FreeSql.Provider.MySqlConnector Enum 自定义元素值，导致值计算错误的 bug；</li>
<li>修复 SqlServer charindex 表达式函数参数位置的错误；</li>
<li>修复 MySql locate 表达式函数参数位置的错误；</li>
<li>修复 UseGenerateCommandParameterWithLambda(true) 时子语句的参数没整合到主语句；<a href="https://github.com/dotnetcore/FreeSql/issues/231" target="_blank" rel="noopener noreferrer">#231</a>；</li>
<li>修复 本地区域化后 ToSql 产生的错误，比如数字可能生成 SQL 为：100,000；</li>
<li>修复 StringLength/MaxLength 对 Oracle varchar2 类型无效的 bug；</li>
<li>修复 CodeFirst IsNullable 迁移脚本重复 NOT NULL 语法错误；</li>
<li><strong>修复 DbFirst Oracle/Dameng 序列值使用复杂的问题，结合 [Column(InsertValueSql = &quot;xxx.nextval&quot;)]；</strong></li>
</ul>
<h2 id="v1-2-1" tabindex="-1"> v1.2.1</h2>
<ul>
<li>调整 Aop 改为 event 事件；</li>
<li>调整 Ado.AopCommandExecuting/AopCommandExecuted 到 Aop.CommandBefore/After；</li>
<li>增加 Aop.TraceBefore/After 事件；</li>
<li>修复 ToList 父子导航可能匹配不正确的 bug；</li>
<li>修复 读写分离创建 IFreeSql 时如果从库不可用导致 iis 退出的 bug；</li>
<li>调整 DbContext/Repository EnableAddOrUpdateNavigateList 默认关闭；</li>
<li>修复 DbContext/Repository SaveMany 一对多保存时删除条件 bug；</li>
<li>增加 BaseEntity SaveMany 方法；</li>
<li>修复 LazyLoading 依赖项目 CSScript.Core 升级的 bug；</li>
</ul>
<h2 id="v1-2-0" tabindex="-1"> v1.2.0</h2>
<ul>
<li>修复 ToList(a =&gt; new Dto {}) 这种情况按字段名匹配问题，应该按属性名；<a href="https://github.com/dotnetcore/FreeSql/issues/208" target="_blank" rel="noopener noreferrer">#208</a></li>
<li>增加 nuget 包强签名发布；<a href="https://github.com/dotnetcore/FreeSql/issues/201" target="_blank" rel="noopener noreferrer">#201</a></li>
<li>完善 IUpdate.SetSource 组合主键的数据更新单元测试；</li>
<li>修复 Oracle 导航属性 表别名过长的问题；</li>
<li>修复 DbSet.Where 表达式解析报错的问题；<a href="https://github.com/dotnetcore/FreeSql/issues/216" target="_blank" rel="noopener noreferrer">#216</a></li>
<li>修复 DbContext/Repository Update 不更新 DbUpdateValue 的问题；<a href="https://github.com/dotnetcore/FreeSql/issues/219" target="_blank" rel="noopener noreferrer">#219</a></li>
<li>增加 IUpdate.SetDto 根据 dto 更新的方法；<a href="https://github.com/dotnetcore/FreeSql/issues/218" target="_blank" rel="noopener noreferrer">#218</a></li>
<li>修复 EfFluentApi 一个参数类型问题；</li>
</ul>
<h2 id="v1-1-0" tabindex="-1"> v1.1.0</h2>
<ul>
<li>修复 BaseRepository.UnitOfWork 延迟设置（即事务开启之后再设置）无效的 bug；</li>
<li>优化 参考 Chloe 表达式针对变量的解析，提升了一倍性能；</li>
<li>修复 FreeSql.Generator 外键导航属性大写小 bug；#177</li>
<li>优化 IsVersion 字段更新 version=ifnull(version,0)+1，防止字段为 null 一直报错；</li>
<li>完善 [Column(ServerTime = Utc)] 特性，对 Update 时也能生效；</li>
<li>完善 [Column(MapType = typeof(byte[]))] 对 Guid/string 的映射支持；#178</li>
<li>完善 MapType byte[] 对 Contains/Parse 表达式解析的处理；</li>
<li>修复 DbConnectionPool.Return 在 Sqlite 下的 bug；#179</li>
<li><strong>增加 FreeSql.Provider.MySqlConnector 扩展方法 ExecuteMySqlBulkCopy；</strong></li>
<li>修复 DbFirst mysql/pgsql/sqlserver 获取主键失败的 bug； 0.10.7 发布后的 bug #182</li>
<li><strong>解决 表名名称包含点，无法进行 CRUD 的问题，由于测试的复杂性，此类情况仅支持 MySql/Sqlite CodeFirst 自动迁移；</strong>
<blockquote>
<p>注意：尽量不要使用带点的表名，只有 MySql/Sqlite 对此类表名支持 CodeFirst。但是它不影响 CRUD 功能，使用 [Table(Name = &quot;`sys.config`&quot;)] 解决</p>
</blockquote>
</li>
<li>增加 FreeSql.All 全家桶包，懒人专用；</li>
<li>修复 GroupBy 类型转换错误；#186</li>
<li>修复 .ToList(a =&gt; new DTO(<a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a>)) 报 未将对象引用设置到对象的实例 问题； #187</li>
<li>修复 update 语句，二元运算解析出错； #184</li>
<li>修复 xamarin ios 真机无法使用 Sqlite 的问题； #183</li>
<li><strong>支持 Sqlite :memory: 模式； #191</strong></li>
<li>优化 IdleTimeout 默认值为 20 秒； #194</li>
<li>修复 父子关系导航属性 Dto 中直接使用 a.Parent 映射错误的 bug；</li>
</ul>
<h2 id="v1-0-1" tabindex="-1"> v1.0.1</h2>
<ul>
<li>修复 NoneParameter 无参对 byte[] 二进制拼接的 bug；#170</li>
<li>调整 最大连接池为 +5（属于内部设置）；</li>
<li>增加 EfCoreFluentApi 扩展包，接近 efcore fluentApi 的使用习惯；</li>
<li>增加 ColumnAttribute 属性 InsertValueSql，插入数据的时候指定用 sql 值；</li>
<li><strong>增加 ISelect`1.WithSql(&quot;select * from user ...&quot;) 功能；</strong></li>
<li>完善 PgSql OnConflictDoUpdate 功能增加 DO NOTHING 操作；#174</li>
<li>修复 IAdo.Query&lt;object&gt; 字段名重复的 bug；#162</li>
</ul>
<h2 id="v1-0-0" tabindex="-1"> v1.0.0</h2>
<ul>
<li>增加 ISelect.ToSql 字段别名设置，默认为 AsIndex，可改为 AsProperty；#158</li>
<li>优化 AsTable 分表查询 Any/Min/Max/Avg/Sum/Count 的处理；#158</li>
<li>优化 BaseEntity Select 查询数据时自动 Attach；</li>
<li>优化 没有主键的实体，约定 id 命名的属性上若设置了 IsPrimary = false，则其不属于约定主键；</li>
<li>优化 ISelect.Count() 之前使用了 OrderBy 会产生的 SQL 语法问题；</li>
<li>调整 Avg 方法返回值为 double，Sum 方法返回值为 decimal；</li>
<li>完善 Select`2-10 多表查询对象，增加 First(select)/ToOne(select)/First&lt;Dto&gt; 方法；</li>
<li>修复 LazyLoading 在 Net4 环境下的问题；</li>
<li>增加 FreeSql.Generator -Filter 设置选项，可阻止存储过程+视图的生成；</li>
<li>增加 FreeSql.Generator 在目标目录产生 __razor.cshtml.txt 文件，以便自定义修改模板生成；</li>
<li><strong>增加 IInsert/IUpdate BatchOptions 方法指定批量插入的设置；</strong></li>
<li>增加 IInsert.ToDataTable 方法，为 BulkCopy 操作提供数据，该方法处理了(表名、字段名、类型）映射和忽略列；</li>
<li><strong>增加 IInsert.ExecuteSqlBulkCopy 扩展方法执行 SqlBulkCopy 批量插入，在 FreeSql.Provider.SqlServer 可用；</strong></li>
<li><strong>增加 IInsert.ExecutePgCopy 扩展方法执行 PostgreSQL Copy 批量导入，在 FreeSql.Provider.PostgreSQL 可用；</strong></li>
<li>增加 ISelectGrouping 分组查询总量的方法 .Count()；</li>
<li>兼容 <a href="http://Vb.Net" target="_blank" rel="noopener noreferrer">Vb.Net</a> 无法使用 IncludeMany 的问题；</li>
<li>兼容 <a href="http://Vb.Net" target="_blank" rel="noopener noreferrer">Vb.Net</a> 无法使用 int? 类型 = 等号表达式解析；</li>
<li>优化 实体基类的属性位置，优先排在最前面；</li>
<li>整理 实体类 Ctor 有构造函数的映射处理；</li>
<li>优化 实体属性，支持 protected set 属性；</li>
<li>修复 Ado.Query 查询字段重复时报错；#162</li>
<li><strong>增加 FreeSql.Provider.MsAccess 支持 Access 数据库操作，已通过 2003/2007 版本测试；</strong></li>
</ul>
<h2 id="v0-12-21" tabindex="-1"> v0.12.21</h2>
<ul>
<li>增加 Where In 表达式解析；</li>
<li><strong>增加 FreeSqlBuilder.UseConnectionFactory 自定义数据库连接对象的创建方法；</strong></li>
<li>兼容 <a href="http://Vb.Net" target="_blank" rel="noopener noreferrer">Vb.Net</a> 表达式解析字符串 = 判断；</li>
<li>优化 GlobalFilter 过滤器表达式 bool 解析；</li>
<li>修复 ISelect.AsTable union all 查询对 count/max/min/avg/sum 的别名 bug；</li>
</ul>
<h2 id="v0-12-20" tabindex="-1"> v0.12.20</h2>
<ul>
<li><strong>增加 ISelect.ForUpdate 排他更新锁（根据数据库类型的规则，见代码注释）；</strong></li>
<li><strong>完善 SqlServer WithLock 功能，组合多种使用 | 枚举相联；</strong></li>
<li>补充 同线程时间 fsql.Transaction 事务等级参数的传入；</li>
<li>调整 fsql.Transaction(Action, Timeout) 参数顺序；</li>
<li>修复 FreeSql.Generator NameOptions 参数未设置时的错误；</li>
</ul>
<h2 id="v0-12-18" tabindex="-1"> v0.12.18</h2>
<ul>
<li>修复 Oracle Dbfirst 字段可空、和主键判断的 bug；</li>
</ul>
<h2 id="v0-12-16-达梦数据库" tabindex="-1"> v0.12.16(达梦数据库)</h2>
<ul>
<li><strong>增加 达梦数据库 ODBC 适配，和单元测试，支持 CodeFirst 模式开发；</strong></li>
<li>增加 BaseEntity 物理删除方法 Delete(true)；</li>
<li>修复 ToList((a,b) =&gt; new { a, b }) 当 b 为 null 的时候，应该整个 b 为 null；(导航属性没这个问题)</li>
<li>修复 Sqlite attachs 附加数据库别名 bug；</li>
<li>修复 Select&lt;T1, T2&gt; AsTable 析构函数处理可能产生 bug；</li>
<li>整理 读写分离的查询代码；</li>
</ul>
<h2 id="v0-12-12" tabindex="-1"> v0.12.12</h2>
<ul>
<li>修复 DbContext TrackList 对匿名对象处理的 bug；<a href="https://github.com/dotnetcore/FreeSql/issues/150" target="_blank" rel="noopener noreferrer">#150</a></li>
</ul>
<h2 id="v0-12-11" tabindex="-1"> v0.12.11</h2>
<ul>
<li>增加 RawValueAttribute 实现自定义表达式时，使用原始值传入参数；</li>
<li>增加 IEnumerable&lt;(T1, T2)&gt;.Contains(col1, col2) 扩展方法，实现自定义表达式解析多列无法 IN 的问题；</li>
<li>修复 多表查询 WhereCascade，如果 Join 没有 On 条件，可能导致生成的 SQL 多了一个 AND 出错；</li>
<li>修复 SaveMany 缓存保存列名找不到的错误提示；</li>
</ul>
<h2 id="v0-12-9" tabindex="-1"> v0.12.9</h2>
<ul>
<li>增加 DateTime 扩展方法 Between 和 BetweenEnd 自定义表达式；</li>
<li>修复 Dto 映射，在二级即 Dto 属性上又 new Dto 的时候，错误的又重复映射了全部字段；</li>
</ul>
<h2 id="v0-12-8" tabindex="-1"> v0.12.8</h2>
<ul>
<li>优化 IncludeMany 级联查询支持异步适配（之前是同步方式）；</li>
<li>优化 MaxLength 功能，并且增加 [Column(StringLength = 100)] 同等的特性功能；</li>
<li>优化 GlobalFilter Apply 自动重命名表达式参数名，避免内容重复问题；</li>
<li>修复 表达式解析 Guid.NewGuid() 的错误；</li>
<li>补充 GetTableByEntity 当属性名或特性名重复时的友好错误提示；</li>
</ul>
<h2 id="v0-12-7" tabindex="-1"> v0.12.7</h2>
<ul>
<li>移除 Lazy 延时加载动态代码中的 Newtonsoft.Json 依赖；</li>
</ul>
<h2 id="v0-12-6" tabindex="-1"> v0.12.6</h2>
<ul>
<li>优化 ReadAnonymous 映射类型不一致的容错；</li>
<li>修复 Oracle/Sqlite IInsert.ExecuteInserted 方法，返回了被 clear 过后的 _source，其实本来也没意义；</li>
<li>修复 DbContext SaveMany 对比删除的 bug；</li>
</ul>
<h2 id="v0-12-5" tabindex="-1"> v0.12.5</h2>
<ul>
<li><strong>增加 实体特性 [Column(ServerTime = DateTimeKind.Utc)] 使用数据库时间执行插入数据；</strong></li>
<li>修复 ToList(a =&gt; new Dto { .. }) 在使用 GroupBy 之后报错的 bug；</li>
<li>修复 注释迁移到数据库，在 <a href="http://asp.net" target="_blank" rel="noopener noreferrer">asp.net</a> 4.7 无效的问题；</li>
<li>修复 批量插入 Values 数量限制超出的判断；</li>
</ul>
<h2 id="v0-12-3" tabindex="-1"> v0.12.3</h2>
<ul>
<li>增加 ICodeFirst.IsGenerateCommandParameterWithLambda 选项，开启表达式解析的命令参数化；
<blockquote>
<p>FreeSqlBuilder 上使用 UseGenerateCommandParameterWithLambda(true) 开启</p>
</blockquote>
</li>
<li>优化 ExpressionCallContext 可设置、附加参数化对象；</li>
<li>修复 IncludeMany(a =&gt; a.x1.x2.Childs) 当 x1, x2 为 null 的报 null 错误；</li>
</ul>
<h2 id="v0-11-24" tabindex="-1"> v0.11.24</h2>
<ul>
<li><strong>增加 Repository/DbContext SaveMany 方法实现一对多，子数据的完整保存；</strong></li>
<li>调整 SaveManyToMany 方法名为 SaveMany；</li>
<li>增加 UnitOfWork 静态属性 DebugBeingUsed，用于生产环境监视正在使用中的事务；</li>
</ul>
<h2 id="v0-11-23" tabindex="-1"> v0.11.23</h2>
<ul>
<li><strong>增加 ExpressionCallAttribute 特性，实现表达式函数自定义解析；</strong></li>
<li>优化 Contains 表达式解析为 where in 自动拆分，防止大于 1000 的 SQL 错误，如下：</li>
</ul>
<div><pre><code><span><span>var</span></span> arr <span>=</span> Enumerable<span>.</span><span>Range</span><span>(</span><span>1</span><span>,</span> <span>1333</span><span>)</span><span>.</span><span>ToArray</span><span>(</span><span>)</span><span>;</span>
<span><span>var</span></span> sql <span>=</span> fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> arr<span>.</span><span>Contains</span><span>(</span>a<span>.</span>Int<span>)</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>//原来：where id in (1..1333)</span>
<span>//现在：where id in (1..500) or id in (501..1000) or id in (1001..1333)</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><ul>
<li>修复 IsNulable 特性不生效的 bug；</li>
</ul>
<h2 id="v0-11-22" tabindex="-1"> v0.11.22</h2>
<ul>
<li><strong>兼容 SqlServer nvarchar/varchar 表达式解析，分别解析为：N'' 和 ''，优化索引执行计划；</strong></li>
<li><strong>增加 MySql 特有功能 Insert Ignore Into；</strong></li>
</ul>
<h2 id="v0-11-21" tabindex="-1"> v0.11.21</h2>
<ul>
<li>修复 SqlServer DbFirst、CodeFirst 查询实体表的列信息错误，当设置了表/列多个扩展属性时发生；</li>
<li>修复 SqlServer2005 CodeFirst 迁移时，不支持 SET (LOCK_ESCALATION TABLE) 的错误（已做适配）；</li>
<li>修复 SqlServer2005 批量插入 SQL 语法错误，不支持 Values(),()（已做适配）；</li>
<li>完善 SqlServer2005 环境跑通了所有单元测试；</li>
<li>修复 ReadAnonymous 读取数据设置只读属性的错误；#132</li>
</ul>
<h2 id="v0-11-20" tabindex="-1"> v0.11.20</h2>
<ul>
<li>增加 IncludeMany 贪婪加载的时候可指定子表的字段，避免查询子表所有字段；</li>
<li>调整 ToList(a =&gt; new 实体类 { id = 1, title = a.xx.Title})，如果 dto 类型为实体类，则规则为只查询 id, title 字段；
<blockquote>
<p>这个规则与 v0.11.6 有差异，它是先映射 Dto 所有属性，再映射 id、title，区别：一个是 dto 类型，一个是查询的实体类型</p>
</blockquote>
</li>
<li>修复 Where(a =&gt; bool &amp;&amp; id &gt; 0) bool 未解析正确的 bug；
<blockquote>
<p>（之前大多数类似的表达都能解析，这次是一个特殊情况）</p>
</blockquote>
</li>
</ul>
<h2 id="v0-11-19" tabindex="-1"> v0.11.19</h2>
<ul>
<li>修复 MapType 属性的表达式解析 数组.Contains 得到是映射之前的值 bug；</li>
<li>修复 MapType 属性 与 IncludeMany 变异功能未映射处理的 bug；</li>
</ul>
<h2 id="v0-11-18" tabindex="-1"> v0.11.18</h2>
<ul>
<li>增加 DbContext、Repository SaveManyToMany 方法，实现手工保存 ManyToMany 关联数据；</li>
<li>修复 BaseRepository 析构时与工作单元的回滚逻辑 bug；#131</li>
<li>优化 ManyToMany 中间表不需要指明 [Column(IsPrimary = true)] 特性；</li>
</ul>
<h2 id="v0-11-12" tabindex="-1"> v0.11.12</h2>
<ul>
<li>增加 AsTable 和 Repository 分表时的自动迁移分表功能；</li>
<li>增加 ICodeFirst.SyncStructure(Type entityType, string tableName) 指定表名来迁移实体；</li>
</ul>
<div><pre><code>fsql<span>.</span>CodeFirst<span>.</span><span>SyncStructure</span><span>(</span><span>typeof</span><span>(</span><span>Log</span><span>)</span><span>,</span> <span>"Log_1"</span><span>)</span><span>;</span> <span>//迁移到 Log_1 表</span>
fsql<span>.</span>CodeFirst<span>.</span><span>SyncStructure</span><span>(</span><span>typeof</span><span>(</span><span>Log</span><span>)</span><span>,</span> <span>"Log_2"</span><span>)</span><span>;</span> <span>//迁移到 Log_2 表</span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><ul>
<li>增加 PostgreSQL 特有功能 On Conflict Do Update 功能；</li>
<li>完善 所有参数化 object parms 可使用 IDictionary 类型传入；</li>
</ul>
<h2 id="v0-11-11" tabindex="-1"> v0.11.11</h2>
<ul>
<li>增加 MySql 特有功能 On Duplicate Key Update 功能；</li>
<li>优化 实体类重写属性 new 如果类型与基类不一致，无法使用的问题；</li>
<li>修复 ISelect .From 方法之前使用 .Include 方法，导致生成的多表 JOIN 位置错误的 bug；</li>
</ul>
<h2 id="v0-11-9" tabindex="-1"> v0.11.9</h2>
<ul>
<li>增加 FreeSql.Provider.Sqlite 对 Xamarin 环境下的适配；</li>
<li>增加 SqlServer ISelect.WithLock 扩展方法，实现 with(nolock) 查询；</li>
<li>增加 SqlServer IFreeSql.SetGlobalSelectWithLock 扩展方法，实现全局设置 with(nolock) 查询；</li>
<li>修复 MySql CodeFirst DateTime 同步结构条件判断的 bug，导致每次都执行 alter；
<blockquote>
<p>高版本支持 datetime(3) 精度的、或者不指定 DbType=&quot;datetime&quot; 就没事</p>
</blockquote>
</li>
<li>移除 Aop.ToList；</li>
<li>移除 Aop.Where；</li>
</ul>
<h2 id="v0-11-6" tabindex="-1"> v0.11.6</h2>
<ul>
<li>调整 ToList(a =&gt; new Dto { id = 1, title = a.xx.Title})，之前只映射 id、title，现在是先映射 Dto 所有属性，再映射 id、title；
<blockquote>
<p>提醒：如果之前使用此方法映射 Dto 的指定属性，请改为匿名类映射，避免查询了不需要的字段影响性能。</p>
</blockquote>
</li>
</ul>
<h2 id="v0-11-5" tabindex="-1"> v0.11.5</h2>
<ul>
<li>修复 FreeSql.DbContext 析构方法的 bug，错误的回滚了外部 UnitOfWork；</li>
</ul>
<h2 id="v0-11-4" tabindex="-1"> v0.11.4</h2>
<ul>
<li>增加 ISelect ToDelete/ToUpdate 方法，实现更复杂的删除/更新操作；</li>
<li>移除 IUpdate/IDelete WhereExists 方法；</li>
</ul>
<h2 id="v0-11-3" tabindex="-1"> v0.11.3</h2>
<ul>
<li>增加 FreeSql.DbContext DbSet Remove 可根据 lambda 条件删除数据的方法；</li>
<li>优化 Aop.AuditValue 审计过的值，IUpdate.UpdateColumns 即使不指定该列也会更新；</li>
</ul>
<h2 id="v0-11-2" tabindex="-1"> v0.11.2</h2>
<ul>
<li>增加 IFreeSql.GlobalFilter 全局过滤器；</li>
<li>移除 TableAttribute.SelectFilter 功能；</li>
<li>修复 MySql/SqlServer CodeFirst 同步结构 bug；
<blockquote>
<p>当表已存在后增加自增列时，产生的脚本不应该包含默认认设置</p>
</blockquote>
</li>
</ul>
<h2 id="v0-11-1" tabindex="-1"> v0.11.1</h2>
<ul>
<li>优化 FreeSql.DbContext 构造方法，方便注入使用；</li>
</ul>
<h2 id="v0-10-15-net-framework-4-0" tabindex="-1"> v0.10.15 (.Net Framework 4.0)</h2>
<ul>
<li>增加 .Net Framework 4.0 的支持，出于环境考虑 .Net Framework 4.0 不支持异步方法；</li>
<li>增加 IFreeSql.Insert&lt;T&gt;(IEnumerable&lt;T1&gt; source) 方法；</li>
</ul>
<h2 id="v0-10-14" tabindex="-1"> v0.10.14</h2>
<ul>
<li>调整 DbContext.EntityChangeInfo 类名为 DbContext.EntityChangeReport.ChangeInfo；</li>
<li>调整 IUnitOfWork 接口，移除 OnEntityChange 属性，增加 EntityChangeReport 属性；</li>
<li>优化 FreeSqlBuilder 处理 MaxLength 特性的容器处理；</li>
</ul>
<h2 id="v0-10-13" tabindex="-1"> v0.10.13</h2>
<ul>
<li>修复 postgresql 12 移除 pg_attrdef.adsrc 列，导致 CodeFirst 方法失败的 bug；</li>
<li>增加 Aop.ConfigEntity 属性 ModifyIndexResult 实现 IndexAttribute 的设置；</li>
</ul>
<h2 id="v0-10-12" tabindex="-1"> v0.10.12</h2>
<ul>
<li>增加 FreeSql.DbContext 实体对象的变化事件；
<blockquote>
<p>可参阅 <a href="/db-context">DbConetxt</a></p>
</blockquote>
</li>
<li>补充 Aop.CurdBefore 事件参数 Table 实体类型的元数据；</li>
</ul>
<h2 id="v0-10-11" tabindex="-1"> v0.10.11</h2>
<ul>
<li>优化 枚举属性的默认值容错，枚举下标不存在 0 的时候，mysql 迁移结构默认值报错；</li>
<li>优化 ORACLE Command 绑定变量 BindByName = true；<a href="https://github.com/dotnetcore/FreeSql/issues/107" target="_blank" rel="noopener noreferrer">#107</a></li>
</ul>
<h2 id="v0-10-10" tabindex="-1"> v0.10.10</h2>
<ul>
<li>修复 PostgreSQL DbFirst 获取字段类型的时候，没有拼得字符串的长度(如 varchar(255))；</li>
</ul>
<h2 id="v0-10-9" tabindex="-1"> v0.10.9</h2>
<ul>
<li>修复 DbFirst 当表数量过大时(如 oracle 表数量大于 1000)，可能报错的 bug；</li>
</ul>
<h2 id="v0-10-8" tabindex="-1"> v0.10.8</h2>
<ul>
<li>
<p>增加 List&lt;T1&gt; 扩展方法 IncludeMany，实现从已知的内存 List 数据，进行和 ISelect.IncludeMany 相同功能的贪婪加载；</p>
<blockquote>
<p>示例：new List&lt;Song&gt;(new[] { song1, song2, song3 }).IncludeMany(fsql, a =&gt; a.Tags);</p>
</blockquote>
</li>
<li>
<p>修复 FreeSql.DbContext/FreeSql.Repository 当主键为 Guid? 可空类型时，发生参数错误；</p>
<blockquote>
<p>System.ArgumentException:“Expression of type 'System.Guid' cannot be used for assignment to type 'System.Nullable`1[System.Guid]'”</p>
</blockquote>
</li>
</ul>
<h2 id="v0-10-7" tabindex="-1"> v0.10.7</h2>
<ul>
<li>增加 IndexAttribute 特性，自动迁移索引，以及对应的 FluentApi 方法；</li>
<li>移除 ColumnAttribute.Unique 属性设置，改为 IndexAttribute 特性设置唯一键；</li>
<li>调整 IInsert&lt;T1&gt; Insert&lt;T1&gt;(IEnumerable&lt;T1&gt; source) 参数类型改成了 List；</li>
</ul>
<h2 id="v0-10-6" tabindex="-1"> v0.10.6</h2>
<ul>
<li>优化 DbContext/Repository ManyToMany 联级保存功能，当是新增数据时不查询中间表记录对比差异（直接插入）；</li>
</ul>
<h2 id="v0-10-5" tabindex="-1"> v0.10.5</h2>
<ul>
<li>增加 DbContext/Repository ManyToMany 联级保存功能（之前已支持 OneToMany）；</li>
</ul>
<h2 id="v0-10-4" tabindex="-1"> v0.10.4</h2>
<ul>
<li>增加 ColumnAttribute 可插入(CanInsert)、可更新(CanUpdate)；#99</li>
</ul>
<h2 id="v0-10-3" tabindex="-1"> v0.10.3</h2>
<ul>
<li>增加 NavigateAttribute 特性对应的 Fluent 功能；#96</li>
</ul>
<h2 id="v0-10-2" tabindex="-1"> v0.10.2</h2>
<ul>
<li>修复 Pgsql string[] 属性表达式 Contains 缺少类型转换的 SQL 语法错误；</li>
</ul>
<h2 id="v0-10-1" tabindex="-1"> v0.10.1</h2>
<ul>
<li>优化 IUpdate.IgnoreColumns/UpdateColumns 可对属性名，或字段名做设置；#95</li>
<li>优化 忽略 List&lt;T&gt; 作为 Curd 类型操作；</li>
</ul>
<h2 id="v0-9-18" tabindex="-1"> v0.9.18</h2>
<ul>
<li>增加 PostgreSQL 的 Odbc 访问提供，相比 FreeSql.Provider.PostgreSQL 支持的类型更少；</li>
<li>增加 通用的 Odbc 访问提供，不能迁移实体到数据库，不能 Skip 这样来分页，理论上能 crud 所有 odbc 数据库；</li>
</ul>
<h2 id="v0-9-17-odbc" tabindex="-1"> v0.9.17(ODBC)</h2>
<ul>
<li>增加 FreeSql.Provider.Odbc，实现 Oracle/SqlServer/MySql 的 Odbc 访问提供；</li>
<li>增加 FreeSqlBuilder.UseConnectionString 参数 providerType，可解决因包版本冲突时，可能无法反射获得 FreeSql.Provider 对应的类型，通常这个参数不需要设置；</li>
<li>优化 MaxLength 特性，当指定为 -1 时 DbType 会分别映射类型 text/nvarchar(max)/nvarchar2(4000)；</li>
</ul>
<h2 id="v0-9-16" tabindex="-1"> v0.9.16</h2>
<ul>
<li>增加 BaseRepository.AttachOnlyPrimary 方法，只附加实体的主键值；
<blockquote>
<p>在更新前使用可实现不查询数据库再更新、也可以实现更新时不更新值为 null 的字段</p>
</blockquote>
</li>
</ul>
<div><pre><code><span>class</span> <span>T</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> other <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span><span>var</span></span> item <span>=</span> <span>new</span> <span>T</span> <span>{</span> id <span>=</span> <span>1</span><span>,</span> name <span>=</span> <span>"xx"</span> <span>}</span><span>;</span>
fsql<span>.</span><span><span>GetRepository</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AttachOnlyPrimary</span><span>(</span>item<span>)</span><span>.</span><span>Update</span><span>(</span>item<span>)</span><span>;</span> <span>//只更新 name</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>修复 Lambda 表达式中 DateTime.Now.ToString(&quot;yyyyMMdd&quot;) 不能直接执行的 bug；</li>
</ul>
<h2 id="v0-9-15" tabindex="-1"> v0.9.15</h2>
<ul>
<li>增加 FreeSql.Extensions.JsonMap 扩展包，实现快速将对象映射为 json 字符串的方法；</li>
</ul>
<div><pre><code>fsql<span>.</span><span>UseJsonMap</span><span>(</span><span>)</span><span>;</span> <span>//开启功能</span>

<span>class</span> <span>TestConfig</span> <span>{</span>
    <span>public</span> <span><span>int</span></span> clicks <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
<span>[</span><span><span>Table</span><span><span>(</span>Name <span>=</span> <span>"sysconfig"</span><span>)</span></span></span><span>]</span>
<span>public</span> <span>class</span> <span>S_SysConfig<span>&lt;</span>T<span>></span></span> <span>{</span>
    <span>[</span><span><span>Column</span><span><span>(</span>IsPrimary <span>=</span> <span>true</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>

    <span>[</span><span><span>JsonMap</span></span><span>]</span>
    <span>public</span> <span>T</span> Config <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>优化 表达式解析未实现的错误提醒，如 $&quot;&quot;；</li>
</ul>
<h2 id="v0-9-12" tabindex="-1"> v0.9.12</h2>
<ul>
<li>增加 MaxLength 特性的解析，实体字符串长度设置；</li>
</ul>
<div><pre><code><span>class</span> <span>Topic</span> <span>{</span>
    <span>[</span><span><span>MaxLength</span><span><span>(</span><span>128</span><span>)</span></span></span><span>]</span>
    <span>public</span> <span><span>string</span></span> Title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><h2 id="v0-9-11" tabindex="-1"> v0.9.11</h2>
<ul>
<li>增加 ISelect.ToChunk 实现分块查询数据，减少数据过大时内存占用；</li>
</ul>
<h2 id="v0-9-10" tabindex="-1"> v0.9.10</h2>
<ul>
<li>移除 FreeSql.Repository 扩展方法 FromRepository；</li>
<li>调整 ISelect.AsTable 规则，每一次使用将增加 UNION ALL 查询；</li>
<li>优化 AsTable UseSyncStructureToLower/ToUpper 设置，兼容 AsTable((t,o) =&gt; &quot;(select * from tb)&quot;)；</li>
</ul>
<h2 id="v0-9-9" tabindex="-1"> v0.9.9</h2>
<ul>
<li>修复 AsTable 不受 UseSyncStructureToLower/ToUpper 设置的 bug；</li>
</ul>
<h2 id="v0-9-8" tabindex="-1"> v0.9.8</h2>
<ul>
<li>增加 AsTable 多次，可查询分表后的多个子表记录，以 UNION ALL 形式执行；</li>
<li>完善 ExpressionTree DateTime/DateTimeOffset 数据转换测试；</li>
<li>优化 ISelect`1.Include 之后 ToList 参数 includeNestedMembers 默认为 true；</li>
<li>修复 属性无 set 自动忽略的 bug；</li>
</ul>
<h2 id="v0-9-7" tabindex="-1"> v0.9.7</h2>
<ul>
<li>修复 批量更新 bug，当某行某字段值为 null，其他行的该字段也更新成了 null；【重大 bug】</li>
</ul>
<h2 id="v0-9-6" tabindex="-1"> v0.9.6</h2>
<ul>
<li>优化 表达式对整数除法的处理，解析为整除；</li>
<li>优化 MapType DateTime/DateTimeOffset 类型转换互通；</li>
</ul>
<h2 id="v0-9-5" tabindex="-1"> v0.9.5</h2>
<ul>
<li>增加 创建表时指定字段位置，如：[Column(Position = 1]，可为负数即反方向位置；</li>
</ul>
<h2 id="v0-9-4" tabindex="-1"> v0.9.4</h2>
<ul>
<li>修复 导航属性配置，循环关系的情况下可能导致的 bug；</li>
</ul>
<h2 id="v0-9-3" tabindex="-1"> v0.9.3</h2>
<ul>
<li>修复 导航属性配置和 Aop 冲突的 bug；</li>
</ul>
<h2 id="v0-9-2" tabindex="-1"> v0.9.2</h2>
<ul>
<li>修复 Aop.AuditValue 与 FreeSql.Repository 主键状态管理的冲突；</li>
</ul>
<h2 id="v0-9-1" tabindex="-1"> v0.9.1</h2>
<ul>
<li>增加 <code>ISelect.First&lt;Dto&gt;()</code> 方法；</li>
<li>修复 MapType 表达式解析时的层级 bug，可能出现 ExpressionTree 类型错误；</li>
</ul>
<h2 id="v0-8-11" tabindex="-1"> v0.8.11</h2>
<ul>
<li>增加 Aop.AuditValue 事件，在插入/更新数据时审计属性值；</li>
</ul>
<h2 id="v0-8-10" tabindex="-1"> v0.8.10</h2>
<ul>
<li>修复 Pgsql 批量更新使用 NoneParameter 后日期类型的语法 bug；</li>
<li>修复 Oracle DbFirst 大小写问题没正确获取列对应 CsType 值的 bug；</li>
</ul>
<h2 id="v0-8-8" tabindex="-1"> v0.8.8</h2>
<ul>
<li>优化 导航属性的关系，友好支持 int/int? 映射；</li>
<li>修复 IncludeMany 变异 Where 指定的属性类型不一致的 bug；(如 int 和 int?)</li>
</ul>
<h2 id="v0-8-7" tabindex="-1"> v0.8.7</h2>
<ul>
<li>修复 导航关系多属性时的错序 bug；</li>
<li>修复 延时属性的类，没有设置 Namespace 时的 bug；</li>
</ul>
<h2 id="v0-8-6" tabindex="-1"> v0.8.6</h2>
<ul>
<li>补充 使用 IsIgnore 忽略后，表达式再使用时的友好错误提示；</li>
<li>优化 DbContext/Repository 局部调整；</li>
<li>修复 DbContext.Save 只查询不更新的 bug；</li>
</ul>
<h2 id="v0-8-5" tabindex="-1"> v0.8.5</h2>
<ul>
<li>修复 ISelect.WhereCascade 当内部使用 (a as BaseEntity).TenantId 时报错的 bug；</li>
<li>修复 ISelect Sum/First 子查询时，若子查询实体类与主查询一样时，导致的 bug；</li>
</ul>
<h2 id="v0-8-4" tabindex="-1"> v0.8.4</h2>
<ul>
<li>修复 IUpdate.Set 表达式传入匿名类更新多个字段，后表达式未加[]或&quot;&quot;的 bug；</li>
<li>修复 Aop.ConfigEntityProperty 操作导航属性后，执行 insert 语句认为它也是字段的 bug；</li>
</ul>
<h2 id="v0-8-3" tabindex="-1"> v0.8.3</h2>
<ul>
<li>增加 FreeSql.Provider.Oracle 下的 OraclePrimaryKeyName 特性，手工设置主键名防止默认名过长问题；</li>
<li>修复 查询重复数据时使用 IncludeMany 出现字典重复添加的 bug；(如一对多使用 LeftJoin 查询，主实体查询出了重复的数据)</li>
<li>补充 ISelect`T1...T10 LeftJoin/InnerJoin/RightJoin 多参数方法；</li>
</ul>
<h2 id="v0-8-2" tabindex="-1"> v0.8.2</h2>
<ul>
<li>修复 Oracle 表达式 DateTime.Subtract(DateTime) 解析 bug；</li>
<li>增加 IFreeSql.Select`T1...T10 的多表查询扩展方法；</li>
<li>增加 表达式函数 string.IsNullOrWhiteSpace 解析；</li>
<li>优化 内部实体管理的默认值，防止导航属性使用抽象类/接口时出现错误；</li>
</ul>
<h2 id="v0-8-1" tabindex="-1"> v0.8.1</h2>
<ul>
<li>优化 表达式中不能使用 c# 函数的问题，
<blockquote>
<p>如：where(a =&gt; HttpContext.Session.GetString(&quot;UserID&quot;) == a.UserId)</p>
</blockquote>
</li>
<li>优化 IUpdate.Set 表达式传入匿名类更新多个字段；</li>
<li>优化 IInsert.InsertIdentity 可插入自增属性；</li>
<li>修复 Oracle CodeFirst 使用 OldName 迁移自增字段时，未删除旧的触发器和序列的 bug；</li>
</ul>
<h2 id="v0-7-16" tabindex="-1"> v0.7.16</h2>
<ul>
<li>增加 UnitOfWork.Current 静态属性，AsyncLocal 实现 [NETStandard 2.0]；</li>
<li>修复 CodeFirst 迁移代码注释到数据库，继承的基类未生效的 bug；</li>
</ul>
<h2 id="v0-7-15" tabindex="-1"> v0.7.15</h2>
<ul>
<li>优化 ExpressionTree 类型转换的友好错误提示；</li>
<li>修复 SqlServer IUpdate.ExecuteUpdated 拼接 SQL bug；</li>
</ul>
<h2 id="v0-7-13" tabindex="-1"> v0.7.13</h2>
<ul>
<li>增加 ISelect.WhereCascade 实现多表查询时，向每个表中附加条件；</li>
<li>增加 表达式对基类转换的解析，如：Where(a =&gt; (a as BaseEntity).IsDeleted == true)；</li>
<li>增加 Examples 项目 base_entity，利用 BaseEntity 实现简洁的数据库操作；</li>
</ul>
<h2 id="v0-7-12" tabindex="-1"> v0.7.12</h2>
<ul>
<li>修复 .From 多表查询别名的匹配 bug；</li>
<li>修复 SqlServer 未处理字符串前面加 N 的 bug；</li>
<li>增加 子查询判断，如果使用了相同 ISelect 会死循环；</li>
<li>增加 连接字符串错误时的友好提示；</li>
</ul>
<h2 id="v0-7-9" tabindex="-1"> v0.7.9</h2>
<ul>
<li>补充 Navigate(ManyToMany = typeof(中间表)) 多对多自定义配置；</li>
<li>修复 LambadaExpressionExtensions 扩展方法 And/Or 当存在二级 lambada 时替换错误的 bug；
<blockquote>
<p>如：where.Add(a =&gt; a.Tags.Any(b =&gt; ...))，b 替换错误</p>
</blockquote>
</li>
</ul>
<h2 id="v0-7-8" tabindex="-1"> v0.7.8</h2>
<ul>
<li>增加 子查询函数 First、Count、Min、Max、Sum、Avg 的支持；</li>
<li>补充 Oracle DbFirst raw 等类型映射处理，其他未处理的类型将映射为 string；</li>
</ul>
<h2 id="v0-7-6" tabindex="-1"> v0.7.6</h2>
<ul>
<li>优化 表达式 true &amp;&amp; ... 解析的处理；</li>
<li>优化 Navigate 指定联合键关系时，对属性顺序的要求，当类型不一样、名称一样时无须指明属性的顺序，如：[Navigate(&quot;MemberId, ShopId&quot;)]；</li>
</ul>
<h2 id="v0-7-5" tabindex="-1"> v0.7.5</h2>
<ul>
<li>修复 Insert/Update 大批量操作分批执行时，如果外部使用了 Ado.Transaction，没有使用线程事务对象，而是创建了新事务的 bug；</li>
</ul>
<h2 id="v0-7-4" tabindex="-1"> v0.7.4</h2>
<ul>
<li>修复 Insert ClearData 重复利用的 bug（使用 IgnoreColumns 进行大批量插入时会发生）；</li>
</ul>
<h2 id="v0-7-3" tabindex="-1"> v0.7.3</h2>
<ul>
<li>修复 ISelect.From&lt;T2, T2&gt; 当传入相同的两个实体类型，可能导致内部 Join 无法匹配的 bug；</li>
<li>增加 IGroupSelect ToSql(string) 重载方法；</li>
<li>修复 根据代码注释，迁移到数据库备注，当实体类属于 .exe 程序集时的 bug：System.Xml.XmlException:“根级别上的数据无效。 第 1 行，位置 1。”</li>
</ul>
<h2 id="v0-7-1" tabindex="-1"> v0.7.1</h2>
<ul>
<li>修复 <code>.From&lt;T2&gt;.GroupBy</code> Item2 以上元组参数未查找到的 bug #63；</li>
<li>合并 FreeSql.DbContext 项目至 FreeSql；</li>
</ul>
<h2 id="v0-6-13" tabindex="-1"> v0.6.13</h2>
<ul>
<li>增加 表达式 .HasValue 和 !.HasValue 的解析支持；</li>
<li>增加 表达式 DateTime - DateTime 和 DateTime - TimeSpan 的解析支持；</li>
<li>修复 0.6.12 IUpdate.Set 表达式解析的 bug；</li>
</ul>
<h2 id="v0-6-12" tabindex="-1"> v0.6.12</h2>
<ul>
<li>增加 LambdaExpression 扩展方法 And/Or/Not 快速拼接表达式；</li>
<li>优化 IUpdate.Set 支持 Set(a =&gt; new { Clicks = a.Clicks + 1, Time = DateTime.Now }) 指定多个字段更新的用法；</li>
</ul>
<h2 id="v0-6-11" tabindex="-1"> v0.6.11</h2>
<ul>
<li>增加 CodeFirst 根据代码注释，迁移到数据库备注（需要实体类所在项目开启 xml 生成功能）；</li>
</ul>
<h2 id="v0-6-10" tabindex="-1"> v0.6.10</h2>
<ul>
<li>增加 TableAttribute 特性属性 DisableSyncStructure，当实体对应的是视图时，可使用本功能禁用迁移；</li>
<li>增加 FreeSqlBuilder UseEntityPropertyNameConvert() 全局转换实体属性名方法 <a href="https://github.com/dotnetcore/FreeSql/pull/60" target="_blank" rel="noopener noreferrer">#60</a>；</li>
</ul>
<h2 id="v0-6-9" tabindex="-1"> v0.6.9</h2>
<ul>
<li>修复 批量插入/更新大量数据时，未使用 NoneParameter，会导致部分未执行的 bug；</li>
</ul>
<h2 id="v0-6-8" tabindex="-1"> v0.6.8</h2>
<ul>
<li>处理 非正常 Provider GC 可能为 null 的错误；</li>
<li>修复 Aop.ParseExpression 使用 FreeParse 方法死循环的 bug；</li>
<li>增加 ISelect.OrderBy 重载，与 WhereIf 相同行为；</li>
</ul>
<h2 id="v0-6-6" tabindex="-1"> v0.6.6</h2>
<ul>
<li>适配 FreeSql.Provider.MySqlConnector，和它对应的 266 个单元测试；</li>
</ul>
<h2 id="v0-6-5" tabindex="-1"> v0.6.5</h2>
<ul>
<li>增加 NavigateAttribute 配置导航关系；</li>
<li>修复 LinqToSql 方法，开启自动迁移时，迁移了无关类的 bug；</li>
<li>修复 Oracle DbFirst date(7) 类型未处理的 bug；</li>
<li>修复 AsSelect().Any() 未给其他条件时，产生 null bug；</li>
<li>修复 子查询使用非表达式方法时，参数无效的 bug；</li>
<li>增加 FreeSql.Extensions.LazyLoading 对 .net 4.5 的支持；</li>
<li>优化 MySql CodeFirst 增加 DateTime 迁移后，默认值为 0000-00-00 导致读取失败的 bug；</li>
<li>优化 LazyLoading 友好错误提示；</li>
</ul>
<h2 id="v0-6-3" tabindex="-1"> v0.6.3</h2>
<ul>
<li>补充 当初始化 ConnectionString 参数为空时，给出友好错误提示；</li>
<li>修复 IUpdate.IngoreColumns/UpdateColumns 若实体指定别名后，可能无效的 bug；</li>
</ul>
<h2 id="v0-6-2" tabindex="-1"> v0.6.2</h2>
<ul>
<li>增加 FreeSql.Provider.MySqlConnector 实现包；</li>
<li>修复 mysql CodeFirst enum/set 小写时，对 MySqlConnector 不友好的 bug；</li>
</ul>
<h2 id="v0-6-1-拆解-freesql" tabindex="-1"> v0.6.1（拆解 FreeSql）</h2>
<ul>
<li>各数据库单独包、延时加载包；</li>
<li>FreeSql.Extensions.LazyLoading</li>
<li>FreeSql.Provider.MySql</li>
<li>FreeSql.Provider.PostgreSQL</li>
<li>FreeSql.Provider.SqlServer</li>
<li>FreeSql.Provider.Sqlite</li>
<li>FreeSql.Provider.Oracle</li>
<li>移除 IFreeSql.Cache，以及 ISelect.Caching 方法；</li>
<li>移除 IFreeSql.Log，包括内部原有的日志输出，改为 Trace.WriteLine；</li>
<li>IAdo.Query&lt;dynamic&gt; 读取返回变为 List&lt;Dictionary&lt;string, object&gt;&gt;；</li>
<li>定义 IFreeSql 和以前一样，移除了 UseCache、UseLogger 方法；</li>
</ul>
<h2 id="v0-5-23" tabindex="-1"> v0.5.23</h2>
<ul>
<li>补充 IUpdate.Set(a =&gt; a.Click == 10)，简化 Set 更新单个字段表达式；</li>
<li>优化 延时导航属性的错误提醒，当无法匹配错误，转到重写类 get 时抛出（实现延时导航属性，与普通导航一起使用）；</li>
<li>优化 ICodeFirst.SyncStructure 错误提示，当使用不可迁移实体时；</li>
<li>优化 实体数据属性 DbDefaultValue 处理；</li>
<li>修复 Expression 表达式解析 Convert 的判断 bug；</li>
</ul>
<h2 id="v0-5-21" tabindex="-1"> v0.5.21</h2>
<ul>
<li>修复 IncludeMany ManyToMany，若中间表未使用 延时加载 属性功能时，出现的 bug；</li>
<li>增加 IncludeMany Take(5) 功能，实现每个子集合只取 5 条记录；</li>
</ul>
<h2 id="v0-5-19" tabindex="-1"> v0.5.19</h2>
<ul>
<li>增加 ISelect.Include 贪婪加载第一版，已通过集合的导航数据加载，包括 OneToMany/ManyToMany；</li>
<li>修改 IncludeMany ManyToMany ET 缓存的 bug；</li>
<li>完善 IncludeMany 联合键处理；</li>
<li>完善 Include/IncludeMany 单元测试；</li>
<li>修复 Include 延时加载 ManyToOne/OneToOne，当值为 null 时，仍然会查询一次数据；</li>
<li>修改 Query/ToList 混合使用时，可能导致的 ET 缓存 bug；</li>
<li>修改 Query 查询的实体设置了 IsIgnore 时，可能出现 ET 读取位置偏移 bug；</li>
<li>增加 变异的 IncludeMany，即使不是导航属性，也可以贪婪加载；</li>
</ul>
<h2 id="v0-5-12" tabindex="-1"> v0.5.12</h2>
<ul>
<li>优化 连接预热策略：min pool size 不设置或 &lt;= 0，则默认预热 5 个；也可以设置 1；</li>
<li>取消 MySql CodeFirst 对表字符集的设置；</li>
<li>增加<code>ToList&lt;Dto&gt;()</code> 方法，作用与 ToList(a =&gt; new Dto()) 相同；</li>
</ul>
<h2 id="v0-5-11" tabindex="-1"> v0.5.11</h2>
<ul>
<li>修复 复杂的表达式解析 OR 的括号 bug；</li>
<li>增加 linq to sql 的查询语法，以及单元测试，<a href="LinqToSql">wiki</a>；</li>
<li>补充 IFreeSql 增加与实现 IDisposable 接口（依然要保持单例的使用习惯）；</li>
<li>增加 CurdBefore、CurdAfter AOP 事件，可监控执行增删查改；</li>
<li>增加 SyncStructureBefore、SyncStructureAfter AOP 事件，可监控 CodeFirst 迁移；</li>
</ul>
<h2 id="v0-5-7" tabindex="-1"> v0.5.7</h2>
<ul>
<li>补充 nuget 包增加 xmlDoc 编译，原来使用者之前一直没有注释；</li>
<li>调整 Column.Unique 定义规则，解决同一属性不可配置多次的问题；</li>
<li>优化 兼容不同数据库 bool 的表达式解析，如：Where(a =&gt; a.Bool)、Where(a =&gt; !a.Bool)；</li>
</ul>
<h2 id="v0-5-5" tabindex="-1"> v0.5.5</h2>
<ul>
<li>增加 Column.MapType 类型映射，可将 enum 映射为 int/string 等；</li>
<li>增加 Column.Unique 唯一键，多个属性指定相同的标识，代表联合键，<a href="https://github.com/dotnetcore/FreeSql/issues/42" target="_blank" rel="noopener noreferrer">#42</a>；</li>
<li>增加 Expression string.Concat，<a href="https://github.com/dotnetcore/FreeSql/issues/39" target="_blank" rel="noopener noreferrer">#39</a>；</li>
<li>补充 Expression IEnumerable<code>&lt;T&gt;</code>.Contains 的支持，之前只能数组或 IList<code>&lt;T&gt;</code>；</li>
<li>补充 IDbFirst GetTablesByDatabase 返回 uk/fk/index 名称，以便迁移；</li>
<li>补充 MapType/Unique 单元测试；</li>
<li>优化 PostgreSQL jsonb 类型使用习惯；</li>
</ul>
<h2 id="v0-5-4-青年版" tabindex="-1"> v0.5.4(青年版)</h2>
<ul>
<li>修复 Expression OrElse 两侧括号丢失的 bug；</li>
<li>修复 Expression DateTime 类型 CompareTo 在 MySql/SqlServer 下的 bug；</li>
<li>修复 ISelect.ToList(true) 无效的 bug；</li>
<li>增加 IAop.ConfigEntity 配置实体特性，可实现使用其他 ORM 的实体特性，<a href="https://github.com/dotnetcore/FreeSql/issues/36" target="_blank" rel="noopener noreferrer">#36</a>；</li>
<li>优化 ISelect.GroupBy 查询，增加 .Value 实现聚合源字段查询，ToList(a =&gt; a.Sum(a.Value.Score))，<a href="https://github.com/dotnetcore/FreeSql/issues/38" target="_blank" rel="noopener noreferrer">#38</a>；</li>
</ul>
<h2 id="v0-5-3" tabindex="-1"> v0.5.3</h2>
<ul>
<li>增加 ISelect.ToList(true) 贪婪加载 LeftJoin/InnerJoin/RightJoin 导航数据；</li>
<li>增加 IAdo.Query&lt;T1, T2 ...&gt; 多结果集查询；</li>
<li>增加 IAdo.ExecuteDataSet 多结果集查询；</li>
<li>优化 未设置实体属性 set 的将被自动过滤 IsIgnore；</li>
</ul>
<h2 id="v0-5-2" tabindex="-1"> v0.5.2</h2>
<ul>
<li>修复 SqlServer 工作单元 bug，需要同时设置 SqlCommand.Connection + Transaction；</li>
<li>补充 测试与支持联合主键的自增；</li>
</ul>
<h2 id="v0-5-1-五一版" tabindex="-1"> v0.5.1(五一版)</h2>
<ul>
<li>
<p>增加 ISelect/IInsert/IUpdate/IDelete.AsType 实现弱类型 curd，如：Select&lt;object&gt;().AsType(实体类型)；</p>
</li>
<li>
<p>补充 ISelect.From&lt;T2&gt;；</p>
</li>
<li>
<p>补充 ExpressionTree 单元测试；</p>
</li>
<li>
<p>优化 ToList(a =&gt; new Dto())，会按优先级查询 Join 实体属性；</p>
</li>
<li>
<p>补充 IDelete/ISelect/IUpdate WhereDynamic 方法，实现 dywhere 条件；</p>
</li>
<li>
<p>修复 WhereObject 内部方法，当开启 Lazy 延时属性时，并且传递实体查询时条件无效；</p>
</li>
<li>
<p>补充 实现表达式转换类型的解析，如：Select&lt;object&gt;().Where(a =&gt; (a as 实体类型).Id == 0)；</p>
</li>
<li>
<p>完善 ExpressionTree 基础数据类型 TryParse 使用与单元测试；</p>
</li>
<li>
<p>优化 ManyToMany 中间实体未配置主键时，自动配置联合主键；</p>
</li>
<li>
<p>修复 Expression.And 的使用问题；</p>
</li>
<li>
<p>修复 IsIgnore 过滤字段后，查询的错误；</p>
</li>
<li>
<p>修复 ISelect2 以上 WhereIf 条件作用反了 bug；</p>
</li>
</ul>
<h2 id="v0-4-15" tabindex="-1"> v0.4.15</h2>
<ul>
<li>优化内部 QuoteSqlName 方法；当参数值是 (xxx)，则直接返回原形。如：xxx =&gt; [xxx]，(max(1)) =&gt; (max(1))；
<blockquote>
<p>可实现功能，如：orm.Select&lt;xxx&gt;().AsTable((a,b) =&gt; &quot;select * from xxx&quot;).Page(1, 20).ToSql()</p>
</blockquote>
</li>
<li>增加 Oracle IDbFirst 接口实现；</li>
<li>补充 开放 IUpdate UpdateColumns 方法功能，实现更新实体时，只更新指定的列（与 IgnoreColumns 对应）；</li>
</ul>
<h2 id="v0-4-13" tabindex="-1"> v0.4.13</h2>
<ul>
<li>优化 MySql 日期类型精确至毫秒；</li>
<li>增加 Distinct 查询前去重数据；</li>
</ul>
<h2 id="v0-4-12" tabindex="-1"> v0.4.12</h2>
<ul>
<li>增加 First/FirstAsync 指定字段查询的重载方法；</li>
<li>调整 FreeSql.Repository 直接引用 FreeSql.DbContext 内的仓储实现；</li>
<li>移动 FreeSql.Repository 至 FreeSql.DbContext；</li>
<li>补充 单独针对 MySql 枚举类型的单元测试；</li>
</ul>
<h2 id="v0-4-11" tabindex="-1"> v0.4.11</h2>
<ul>
<li>修复 .ToList(a =&gt; <a href="http://a.id" target="_blank" rel="noopener noreferrer">a.id</a>) 当 id 是 guid 类型时，会出现类型转换失败 bug；</li>
</ul>
<h2 id="v0-4-10" tabindex="-1"> v0.4.10</h2>
<ul>
<li>优化 连接池对象预热效率，开启每 10 个线程进行预热，预热时间超过 3 秒则放弃；</li>
<li>修复 MySql 枚举表达式 == 解析成数字的 bug；</li>
<li>补充 IAdo 相关方法，实现 FreeSql.Connection.Extensions 扩展包，像 Dapper 的使用习惯；</li>
</ul>
<h2 id="v0-4-9" tabindex="-1"> v0.4.9</h2>
<ul>
<li>修复 pgsql Enum 类型 formatSql bug；</li>
<li>补充 表达式解析 Equals 为 = <a href="https://github.com/dotnetcore/FreeSql/issues/28" target="_blank" rel="noopener noreferrer">#28</a> <a href="https://github.com/dotnetcore/FreeSql/issues/29" target="_blank" rel="noopener noreferrer">#29</a>；</li>
</ul>
<h2 id="v0-4-5-清明版本" tabindex="-1"> v0.4.5(清明版本)</h2>
<ul>
<li>优化 IFreeSql.Transaction 可嵌套连续使用，之前会死锁；</li>
<li>修复 导航属性的关系，误将 ManyToOne 设置成了 OneToMany；</li>
<li>补充 DbFirst GetTablesByDatabase 获取表备注；</li>
<li>补充 ISelect.ToList(a =&gt; new XxxDto { XxxId = <a href="http://a.Id" target="_blank" rel="noopener noreferrer">a.Id</a>, ... }) 支持，之前只能支持匿名类；</li>
<li>补充 扩展 IUpdate.Set(a =&gt; a.Title + &quot;111&quot;) 指定字段在原基础上增加值的范围，之前只支持数字类型的累加；</li>
</ul>
<h2 id="v0-4-1" tabindex="-1"> v0.4.1</h2>
<ul>
<li>抽离 FreeSql.DbContext 项目独立至 <a href="https://github.com/dotnetcore/FreeSql.DbContext%EF%BC%8C%E5%AE%9E%E7%8E%B0%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1ORM" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql.DbContext，实现面向对象ORM</a>；</li>
<li>补充 CodeFirst Fluent 之 IsVersion 乐观锁配置；</li>
</ul>
<h2 id="v0-3-27" tabindex="-1"> v0.3.27</h2>
<ul>
<li>增加 乐观锁功能，适用修改实体；</li>
<li>增加 FreeSql.Repository 默认依赖注入的方式，同时保留原有 Autofac；</li>
<li>优化 FreeSql.Repository Insert 逻辑，参考了 FreeSql.DbContext；</li>
<li>优化 FreeSql.IUpdate 参照 IInsert 对大批量更新，拆分执行；</li>
<li>修复 FreeSql.IInsert ClearData 重复利用的 bug（使用 IgnoreColumns 进行大批量插入时会发生）；</li>
</ul>
<h2 id="v0-3-26" tabindex="-1"> v0.3.26</h2>
<ul>
<li>修复 SqlServer CodeFirst 迁移联合主键的 bug <a href="https://github.com/dotnetcore/FreeSql/issues/23" target="_blank" rel="noopener noreferrer">#23</a>；</li>
</ul>
<h2 id="v0-3-25" tabindex="-1"> v0.3.25</h2>
<ul>
<li>修复 全局过滤器一个赋值低级错误；</li>
<li>增加 IFreeSql&lt;TMark&gt; 空接口，实现多个 IFreeSql 注入使用，使用泛型标识区分；</li>
</ul>
<h2 id="v0-3-24" tabindex="-1"> v0.3.24</h2>
<ul>
<li>增加 GroupBy 分页方法；</li>
<li>修复 Insert 参数化命名 bug，当存在 Id Id2 时发生；</li>
<li>优化 Insert/Delete/Update 对象执行完后清理数据，以备多次使用；</li>
</ul>
<h2 id="v0-3-23" tabindex="-1"> v0.3.23</h2>
<ul>
<li>修复 因功能增加，导致联表查询出现的表达式函数解析 bug；</li>
<li>修复 因功能增加，导致查询数据时，ExpressionTree bug；</li>
</ul>
<h2 id="v0-3-22" tabindex="-1"> v0.3.22</h2>
<ul>
<li>优化 导航属性 ManyToOne 名称查找规则；</li>
<li>增加 IFreeSql.Aop 属性，未来所有拦截方法都在这里，第一期支持如下：
<ul>
<li>监控 ToList 返回的的数据，用于拦截重新装饰；</li>
<li>监视 Where，包括 select/update/delete，返回值 true 时可使上层不被执行；</li>
<li>可自定义解析表达式；</li>
</ul>
</li>
<li>增加 ISelect.TractToList，用于单次跟踪或审核实体；</li>
<li>优化 FreeSql.DbContext SaveChanges；</li>
</ul>
<h2 id="v0-3-21" tabindex="-1"> v0.3.21</h2>
<ul>
<li>增加 IUpdate IgnoreColumns 重载方法，支持传入字符串数组忽略修改；</li>
<li>完善 FreeSql.DbContext，支持对象操作 + SaveChanges 最后保存操作；</li>
</ul>
<h2 id="v0-3-20" tabindex="-1"> v0.3.20</h2>
<ul>
<li>修复 ToList 选择指定对象时，应附加所有字段查询返回；</li>
<li>修复 Lazy 延时类与实体关系冲突 bug；</li>
<li>修复 附加对象读取时，记录为空应该返回 null，而不是返回非 null（字段默认值）对象；</li>
</ul>
<h2 id="v0-3-19" tabindex="-1"> v0.3.19</h2>
<ul>
<li>兼容 GetTableByEntity 有可能因为传入数组类型的错误；</li>
<li>修复 UnitOfWork 事务创建逻辑 bug；</li>
<li>增加 FreeSql.DbContext 扩展包；</li>
<li>调整 UnitOfWork、DbContext 不提交时默认会回滚；</li>
</ul>
<h2 id="v0-3-18" tabindex="-1"> v0.3.18</h2>
<ul>
<li>增加 IInsert 对数组传入的支持，之前是 <code>IEnumerable&lt;T&gt;</code>；</li>
<li>增加 ORM 性能测试项目 Examples/orm_vs；</li>
</ul>
<h2 id="v0-3-17" tabindex="-1"> v0.3.17</h2>
<ul>
<li>修复 SqlServer DbFirst 数据库名传入带小数点的 bug <a href="https://github.com/dotnetcore/FreeSql/issues/18" target="_blank" rel="noopener noreferrer">#18</a>；</li>
<li>修复 ILIst.Contains Expression <a href="https://github.com/dotnetcore/FreeSql/issues/16" target="_blank" rel="noopener noreferrer">#16</a>；</li>
<li>整理 延时加载/导航属性查询的对象关系，仍然不依赖外键；</li>
<li>完成 OneToOne/ManyToOne、ManyToMany/OneToMany 导航属性的查询 <a href="https://github.com/dotnetcore/FreeSql/issues/15" target="_blank" rel="noopener noreferrer">#15</a>；</li>
<li>增加 IEnumerable<code>&lt;TEntity&gt;</code> 扩展方法 AsSelect，转成 <code>ISelect&lt;T&gt;</code>，以便使用 FreeSql 的查询功能；</li>
<li>增加 int.Parse Guid.Parse 系列转换、Guid.NewGuid、new Random.NextDouble 等表达式函数解析；</li>
</ul>
<h2 id="v0-3-16" tabindex="-1"> v0.3.16</h2>
<ul>
<li>修复 IInsert/IUpdate.NoneParameter() 设成了反作用的 bug；</li>
<li>修复 IDbFirst.GetTablesByDatabase 默认数据库 bool 判断 bug；</li>
<li>增加 FreeSql.Repository 之 IUnitOfWork 实现；</li>
<li>增加 FreeSql.Repository 继承实现的仓储注入；</li>
</ul>
<div><pre><code>builder<span>.</span><span>RegisterFreeRepository</span><span>(</span>
    filter <span>=></span> filter<span>.</span><span><span>Apply</span><span><span>&lt;</span>Song<span>></span></span></span><span>(</span><span>"test"</span><span>,</span> a <span>=></span> a<span>.</span>Title <span>==</span> DateTime<span>.</span>Now<span>.</span><span>ToString</span><span>(</span><span>)</span> <span>+</span>
        Thread<span>.</span>CurrentThread<span>.</span>ManagedThreadId<span>)</span><span>,</span>
    <span>this</span><span>.</span><span>GetType</span><span>(</span><span>)</span><span>.</span>Assembly
<span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><h2 id="v0-3-15" tabindex="-1"> v0.3.15</h2>
<ul>
<li>增加 ISelect.ToDataTable 系列方法；</li>
<li>增加 无参数化命令执行，可配置全局 ICodeFirst.IsNoneCommandParameter、或临时 IInsert/IUpdate.NoneParameter() 便于调试；</li>
<li>关闭 自动同步结构功能，避免线上环境误操作；</li>
<li>优化 IInsert 批量插入容易导致 values 过多、或参数化过多的问题，5 个数据库均已优化；</li>
</ul>
<h2 id="v0-3-14" tabindex="-1"> v0.3.14</h2>
<ul>
<li>解决 SqlServer 批量添加容易导致的错误：传入的请求具有过多的参数。该服务器支持最多 2100 个参数。请减少参数的数目，然后重新发送该请求。原理为拆成多个包用事务执行；</li>
</ul>
<h2 id="v0-3-13" tabindex="-1"> v0.3.13</h2>
<ul>
<li>修改 FreeSql.Repository Autofac 注入方式，真正的实现全局过滤功能；</li>
<li>增加 FreeSql.Repository DataFilter 属性；</li>
</ul>
<div><pre><code>repos<span>.</span>DataFilter<span>.</span><span>Disable</span><span>(</span><span>"test"</span><span>)</span> 临时禁用，不影响全部；
repos<span>.</span>DataFilter<span>.</span><span>DisableAll</span><span>(</span><span>)</span>
repos<span>.</span>DataFilter<span>.</span><span>Enable</span><span>(</span><span>"test"</span><span>)</span>
repos<span>.</span>DataFilter<span>.</span><span>EnableAll</span><span>(</span><span>)</span>
repos<span>.</span>DataFilter<span>.</span><span>Apply</span><span>(</span><span>"name"</span><span>,</span> a <span>=></span> a<span>.</span>Id <span>></span> <span>1</span><span>)</span> 附加新的过滤器
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><ul>
<li>增加 using DataFilter.Disable、Enable 使用完成后恢复可用状态；</li>
</ul>
<h2 id="v0-3-12" tabindex="-1"> v0.3.12</h2>
<ul>
<li>增加 ICodeFirst.IsConfigEntityFromDbFirst，若无配置实体类主键、自增，可从数据库导入；</li>
</ul>
<h2 id="v0-3-11" tabindex="-1"> v0.3.11</h2>
<ul>
<li>增加 ISelect、IInsert、IUpdate、IDelete WithTransaction 方法，将事务对象暴露给外部；</li>
<li>增加 IAdo ExecuteXxx 系列方法重载，支持事务对象的传入；</li>
</ul>
<h2 id="v0-1-14" tabindex="-1"> v0.1.14</h2>
<ul>
<li>增加 延时属性编译的错误提示；</li>
<li>优化 FreeSql.Repository Autofac 泛型注入；</li>
</ul>
<h2 id="v0-1-13" tabindex="-1"> v0.1.13</h2>
<ul>
<li>修改 连接池内部 Ping Timeout 值暂定 5 秒；</li>
<li>优化 初始化时若数据库超时，则放弃预热；</li>
<li>FreeSql.Repository 下增加 ISelect.FromRepository 扩展方法，实现快速合并多个仓储查询；</li>
<li>增加 FreeSql.Repository Autofac 泛型注入，支持实现全局过滤；</li>
<li>补充 GuidRepository 插入数据时，根据 filter 参数设定进行数据验证；</li>
</ul>
<h2 id="v0-1-12" tabindex="-1"> v0.1.12</h2>
<ul>
<li>升级 nuget 依赖包；</li>
<li>增加 .netframework 4.6.1 示范项目；</li>
<li>PostgreSQL 连接池大小默认值改为 50；</li>
<li>ISelect 增加 Any/AnyAsync(Expression)，为的少写一个 Where；</li>
<li>关闭 CSScriptLib Debug 编译，防止权限错误；</li>
</ul>
<h2 id="v0-1-11" tabindex="-1"> v0.1.11</h2>
<ul>
<li>FreeSql ISelect/IUpdate/IInsert/IDelete 增加 AsTable 方法，实现分表；</li>
<li>FreeSql.Repository 之 GuidRepository 实现分表扩展，原因系 Guid 适合作分布式存储；</li>
</ul>
<h2 id="v0-1-10" tabindex="-1"> v0.1.10</h2>
<ul>
<li>修复 FreeSql.Repository GuidRepository/GetGuidRepository 缓存 bug；</li>
<li>修复 Lazy 延时加载在 linux 发布后产生 Bad IL Format bug；</li>
</ul>
<h2 id="v0-1-9" tabindex="-1"> v0.1.9</h2>
<ul>
<li>优化插入判断主键，且为 Guid/Guid? 类型，并且值为 null/Guid.Empty 时，将插入的值变为 FreeUtil.NewMongodbId();</li>
</ul>
<h2 id="v0-1-8" tabindex="-1"> v0.1.8</h2>
<ul>
<li>升级 nuget 依赖包；</li>
</ul>
<h2 id="v0-1-7" tabindex="-1"> v0.1.7</h2>
<ul>
<li>FreeSql.Repository 增加 filter 参数，实现数据过滤 + 验证；
如：var postRepos = fsql.GetGuidRepository<code>&lt;Post&gt;</code>(a =&gt; a.TopicId == 1); postRepos CURD 方法都会以 lambda 条件作为查询或验证，Update/Insert 验证错误时会抛出异常。</li>
<li>ISelect 增加 First/FirstAsync；</li>
</ul>
<h2 id="v0-1-6" tabindex="-1"> v0.1.6</h2>
<ul>
<li>修复 FluentApiConfigEntity 与 延时加载 冲突产生的 bug；</li>
</ul>
<h2 id="v0-1-5" tabindex="-1"> v0.1.5</h2>
<ul>
<li>删除 IsQuoteSqlName 参数配置；</li>
<li>增加 IsSyncStructureToUpper 参数配置，以便适应 Oracle 大小写使用习惯；</li>
<li>FreeSql.Repository 增加 GuidRepository 类，适用 Insert 方法无须返回插入的数据；</li>
<li>FreeSql.Repository 增加 IFreeSql 扩展方法 GetRepository、GetGuidRepository；</li>
</ul>
<h2 id="v0-1-4" tabindex="-1"> v0.1.4</h2>
<ul>
<li>修复 SqlServer CodeFirst 迁移结构时，因日期默认值的语法错误；</li>
<li>判断 SqlServer 服务器版本，选择分页模式 row_number 或 offset fetch next；</li>
</ul>
<h2 id="v0-1-3" tabindex="-1"> v0.1.3</h2>
<ul>
<li>FreeSql.Repository Insert 方法判断数据库类型，由于 MySql/Oracle/Sqlite 不支持 returning 或 output 类型的特性，因此不作实现定义为 virtual 交给外部（不包括 PostgreSQL/SqlServer）；</li>
</ul>
<h2 id="v0-1-2" tabindex="-1"> v0.1.2</h2>
<ul>
<li>增加 sqlserver2012 offset fetch next 的分页方式；</li>
<li>增加 ICodeFirst.GetConfigEntity 方法；</li>
</ul>
<h2 id="v0-1-1" tabindex="-1"> v0.1.1</h2>
<ul>
<li>增加选项 IsQuoteSqlName 控制是否使用 [] 或 &quot;&quot; 或 `` 包含数据库名称 <a href="https://github.com/dotnetcore/FreeSql/issues/6" target="_blank" rel="noopener noreferrer">#6</a>；</li>
</ul>
<h2 id="v0-1-0" tabindex="-1"> v0.1.0</h2>
<ul>
<li>增加 FreeSql.Repository 扩展库，实现实体类的默认仓储；</li>
<li>增加主键命名约定：在没有设置主键的情况下，Id 或 &lt;type name&gt;Id 或 &lt;type name&gt;_Id 或 自增列 会成为主键；</li>
<li>实体特性 Column 增加 IsIgnore 忽略达到不映射的目的；</li>
<li>增加 repository_01 示例项目，演示 FreeSql.Repository；</li>
<li>增加 website FreeSql 官方项目源码；</li>
</ul>
<h2 id="v0-0-14" tabindex="-1"> v0.0.14</h2>
<ul>
<li>ICodeFirst.ConfigEntity 可更新实体配置已缓存的数据；</li>
<li>防止同连接字符串被 IFreeSql 使用多次，发生连接池溢出 bug（<a href="http://ado.net" target="_blank" rel="noopener noreferrer">ado.net</a> 连接池原理，减少解释成本）；</li>
<li>增加 efcore_to_freesql 示例项目，实现与 EFCore 实体共存；</li>
</ul>
<h2 id="v0-0-13" tabindex="-1"> v0.0.13</h2>
<ul>
<li>修复和丰富 ICodeFirst.ConfigEntity 方法；</li>
<li>增加 FreeSql.Extensions.EFCoreModelBuilder 扩展库，实现与 EFCore 实体共存 <a href="https://github.com/dotnetcore/FreeSql/issues/4" target="_blank" rel="noopener noreferrer">#4</a>；</li>
<li>增加 restful 示例项目；</li>
</ul>
<h2 id="v0-0-12" tabindex="-1"> v0.0.12</h2>
<ul>
<li>lazy 延时属性父子关系的 1v 多类型判断修正，解决 int? != int 的 bug；</li>
<li>ThreadLocal 修改使用方式；</li>
<li>使用 virtual 后实体序列化问题 <a href="https://github.com/dotnetcore/FreeSql/issues/5" target="_blank" rel="noopener noreferrer">#5</a>，私有化属性；</li>
<li>由于 FreeSql 采用二次封装连接池，尽量避免使用问题，真实的 max pool size 值等于传入值+1；</li>
</ul>
<h2 id="v0-0-11" tabindex="-1"> v0.0.11</h2>
<ul>
<li>修复 IAdo.Query 直接查询 sql 的 bug；</li>
<li>重新检查通过所有单元测试；</li>
</ul>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">常见问题</title>
    <id>https://freesql.net/reference/faq.html</id>
    <link href="https://freesql.net/reference/faq.html"/>
    <updated>2022-08-19T12:08:01.000Z</updated>
    <content type="html"><![CDATA[<h1 id="常见问题" tabindex="-1"> 常见问题</h1>
<h3 id="_1、如何监视-sql" tabindex="-1"> 1、如何监视 SQL？</h3>
<p>方法一：UseMonitorCommand + UseNoneCommandParameter</p>
<div><pre><code><span>static</span> <span>IFreeSql</span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
  <span>.</span><span>UseConnectionString</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>MySql<span>,</span> <span>"..."</span><span>)</span>
  <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"线程：</span><span><span>{</span><span>cmd<span>.</span>CommandText</span><span>}</span></span><span>\r\n"</span></span><span>)</span><span>)</span>
  <span>.</span><span>UseNoneCommandParameter</span><span>(</span><span>true</span><span>)</span>
  <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>方法二：Aop.CurdBefore/CurdAfter</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>CurdAfter <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span>
<span>{</span>
  <span>if</span> <span>(</span>e<span>.</span>ElapsedMilliseconds <span>></span> <span>200</span><span>)</span>
    Console<span>.</span><span>WriteLine</span><span>(</span><span><span>$"线程：</span><span><span>{</span><span>e<span>.</span>Sql</span><span>}</span></span><span>\r\n"</span></span><span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h3 id="_2、mysql-enum-映射" tabindex="-1"> 2、MySql Enum 映射</h3>
<p>默认情况 c# 枚举会映射为 MySql Enum 类型，如果想映射为 int 在 FreeSqlBuilder Build 之后执行以下 Aop 统一处理：</p>
<div><pre><code>fsql<span>.</span>Aop<span>.</span>ConfigEntityProperty <span>+=</span> <span>(</span>s<span>,</span> e<span>)</span> <span>=></span> <span>{</span>
  <span>if</span> <span>(</span>e<span>.</span>Property<span>.</span>PropertyType<span>.</span>IsEnum<span>)</span>
    e<span>.</span>ModifyResult<span>.</span>MapType <span>=</span> <span>typeof</span><span>(</span><span><span>int</span></span><span>)</span><span>;</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><hr>
<h3 id="_3、多个-ifreesql-实例-如何注入使用" tabindex="-1"> 3、多个 IFreeSql 实例，如何注入使用？</h3>
<p><a href="https://github.com/dotnetcore/FreeSql/issues/44" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/issues/44</a></p>
<hr>
<h3 id="_4、怎么执行-sql-返回实体列表" tabindex="-1"> 4、怎么执行 SQL 返回实体列表？</h3>
<div><pre><code><span>//直接查询</span>
fsql<span>.</span>Ado<span>.</span><span><span>Query</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span>sql<span>)</span><span>;</span>

<span>//嵌套一层做二次查询</span>
fsql<span>.</span><span><span>Select</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>WithSql</span><span>(</span>sql<span>)</span><span>.</span><span>Page</span><span>(</span><span>1</span><span>,</span> <span>10</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><hr>
<h3 id="_5、错误-【主库】状态不可用-等待后台检查程序恢复方可使用。xxx" tabindex="-1"> 5、错误：【主库】状态不可用，等待后台检查程序恢复方可使用。xxx</h3>
<p>一般是数据库连接失败，才会出现，请检查程序与数据库之间的网络。具体按 xxx 给出的提示进行排查。</p>
<hr>
<h3 id="_6、错误-【主库】对象池已释放-无法访问。" tabindex="-1"> 6、错误：【主库】对象池已释放，无法访问。</h3>
<p>原因一：手工调用了 fsql.Dispose，之后仍然使用它</p>
<p>原因二：使用了 IdleBus 管理 IFreeSql，错误的方式如下：</p>
<ul>
<li>a) 不要构建了 IFreeSql 再丢去注册</li>
</ul>
<div><pre><code><span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSqlBulder</span><span>(</span><span>)</span><span>..</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
ib<span>.</span><span>Register</span><span>(</span><span>"key01"</span><span>,</span> <span>(</span><span>)</span> <span>=></span> fsql<span>)</span><span>;</span> <span>//错了，错了，错了</span>

ib<span>.</span><span>Register</span><span>(</span><span>"key01"</span><span>,</span> <span>(</span><span>)</span> <span>=></span> <span>new</span> <span>FreeSqlBulder</span><span>(</span><span>)</span><span>..</span><span>.</span><span>Build</span><span>(</span><span>)</span><span>)</span><span>;</span> <span>//正确</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><ul>
<li>b) 尽量每次都使用 ib.Get 获得 IFreeSql 对象(避免存对象引用)，IdleBus 内部超时释机制一时触发，再使用引用对象，就会报这个报错</li>
</ul>
<p>原因三：检查项目的系统事件，是否在异常之前触发</p>
<div><pre><code>AppDomain<span>.</span>CurrentDomain<span>.</span>ProcessExit <span>+=</span> <span>(</span>s1<span>,</span> e1<span>)</span> <span>=></span>
<span>{</span>
  <span>//记录日志</span>
<span>}</span><span>;</span>
Console<span>.</span>CancelKeyPress <span>+=</span> <span>(</span>s1<span>,</span> e1<span>)</span> <span>=></span>
<span>{</span>
  <span>//记录日志</span>
<span>}</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>如果确定问题，可以在 FreeSqlBuilder 构建对象的时候 UseExitAutoDisposePool(false) 关闭这个机制</p>
<hr>
<h3 id="_7、错误-objectpool-get-获取超时-10-秒-。" tabindex="-1"> 7、错误：ObjectPool.Get 获取超时（10 秒）。</h3>
<p>原因一：UnitOfWork 使用未释放，请保证程序内使用 UnitOfWork 的地方会执行 Dispose</p>
<p>原因二：Max Pool Size 设置过小，程序访问量过高</p>
<p>监视 fsql.Ado.MasterPool.Statistics，它的值：Pool: 5/100, Get wait: 0, GetAsync await: 0</p>
<div><pre><code>5 为可用连接数，值为0后开始排队
100 为当前最大连接数
Get await 为同步方法获取连接的排队数量（超过10秒就会报错）
GetAsync await 为异步方法获取连接的排队数量
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div></div></div><p>监视 FreeSql.UnitOfWork.DebugBeingUsed 这个静态字典，存储正在使用事务的工作单元</p>
<p>注意：尽量不要使用 fsql.Ado.MasterPool.Get() 或 GetAsync() 方法，否则请检查姿势。</p>
<hr>
<h3 id="_8、多平台代码参考-使用自定义-sqliteprovider-例如-sqlite-用-microsoft-data-sqlite-或者反射-mono-data-sqlite" tabindex="-1"> 8、多平台代码参考,使用自定义 SqliteProvider,例如 Sqlite 用 Microsoft.Data.Sqlite 或者反射 Mono.Data.Sqlite.</h3>
<p><a href="https://github.com/densen2014/FreeSqlDemos/tree/master/ARM_ConsoleApp" target="_blank" rel="noopener noreferrer">arm/树莓派</a></p>
<p><strong>有条件的同学直接试试 FreeSql.Provider.SqliteCore 包,使用的就是 Microsoft.Data.Sqlite 驱动.</strong></p>
<p>1.添加包</p>
<div><pre><code><span><span><span>&lt;</span>PackageReference</span> <span>Include</span><span><span>=</span><span>"</span>FreeSql.Provider.Sqlite<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>3.0.100<span>"</span></span> <span>/></span></span>
<span><span><span>&lt;</span>PackageReference</span> <span>Include</span> <span><span>=</span> <span>"</span>Microsoft.Data.Sqlite<span>"</span></span> <span>Version</span><span><span>=</span><span>"</span>6.0.3<span>"</span></span> <span>/></span></span>
</code></pre><div aria-hidden="true"><div></div><div></div></div></div><p>2.代码</p>
<div><pre><code><span>Microsoft<span>.</span>Data<span>.</span>Sqlite<span>.</span>SqliteConnection</span> _database <span>=</span> <span>new</span> <span>Microsoft<span>.</span>Data<span>.</span>Sqlite<span>.</span>SqliteConnection</span><span>(</span><span><span>$"Data Source=document.db"</span></span><span>)</span><span>;</span>

<span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
        <span>.</span><span>UseConnectionFactory</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>(</span><span>)</span> <span>=></span> _database<span>,</span> <span>typeof</span><span>(</span><span>FreeSql<span>.</span>Sqlite<span>.</span>SqliteProvider<span>&lt;</span><span>></span></span><span>)</span><span>)</span>
        <span>.</span><span>UseAutoSyncStructure</span><span>(</span><span>true</span><span>)</span>
        <span>.</span><span>UseNoneCommandParameter</span><span>(</span><span>true</span><span>)</span> <span>//必须开启,因为Microsoft.Data.Sqlite内插处理有bug</span>
        <span>.</span><span>UseMonitorCommand</span><span>(</span>cmd <span>=></span> Console<span>.</span><span>Write</span><span>(</span>cmd<span>.</span>CommandText<span>)</span><span>)</span>
        <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p><a href="https://github.com/densen2014/FreeSqlDemos/tree/master/UWP1" target="_blank" rel="noopener noreferrer">UWP</a></p>
<div><pre><code><span>using</span> <span>System<span>.</span>Data<span>.</span>SQLite</span><span>;</span>

<span><span>string</span></span> dbpath <span>=</span> Path<span>.</span><span>Combine</span><span>(</span>ApplicationData<span>.</span>Current<span>.</span>LocalFolder<span>.</span>Path<span>,</span> <span>"sqliteSample.db"</span><span>)</span><span>;</span>
<span>SQLiteConnection</span> _database <span>=</span> <span>new</span> <span>SQLiteConnection</span><span>(</span><span><span>$"Data Source=</span><span><span>{</span><span>dbpath</span><span>}</span></span><span>"</span></span><span>)</span><span>;</span>
<span><span>var</span></span> fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
           <span>.</span><span>UseConnectionFactory</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>(</span><span>)</span> <span>=></span> _database<span>,</span> <span>typeof</span><span>(</span><span>FreeSql<span>.</span>Sqlite<span>.</span>SqliteProvider<span>&lt;</span><span>></span></span><span>)</span><span>)</span>
           <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p><a href="https://github.com/densen2014/FreeSqlDemos/tree/master/xamarinFormApps" target="_blank" rel="noopener noreferrer">Xamarin Forms,代码较多</a>
主程序,接口获取 rovider,各个平台自己实现.</p>
<div><pre><code><span>if</span> <span>(</span>Device<span>.</span>RuntimePlatform <span>==</span> Device<span>.</span>iOS <span>||</span> Device<span>.</span>RuntimePlatform <span>==</span> Device<span>.</span>Android<span>)</span>
<span>{</span>
   fsql <span>=</span> <span>new</span> <span>FreeSql<span>.</span>FreeSqlBuilder</span><span>(</span><span>)</span>
          <span>.</span><span>UseConnectionFactory</span><span>(</span>FreeSql<span>.</span>DataType<span>.</span>Sqlite<span>,</span> <span>(</span><span>)</span> <span>=></span> DependencyService<span>.</span><span><span>Get</span><span><span>&lt;</span>ISQLite<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>GetConnectionSqlite</span><span>(</span><span>"document"</span><span>)</span><span>,</span> <span>typeof</span><span>(</span><span>FreeSql<span>.</span>Sqlite<span>.</span>SqliteProvider<span>&lt;</span><span>></span></span><span>)</span><span>)</span>
          <span>.</span><span>UseNoneCommandParameter</span><span>(</span><span>true</span><span>)</span>
          <span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p><a href="https://github.com/densen2014/FreeSqlDemos/blob/master/xamarinFormApps/xamarinFormApp.iOS/SQLite_iOS.cs" target="_blank" rel="noopener noreferrer">iOS 部分</a></p>
<p><a href="https://github.com/densen2014/FreeSqlDemos/blob/master/xamarinFormApps/xamarinFormApp.Android/SQLite_droid.cs" target="_blank" rel="noopener noreferrer">安卓部分</a></p>
<hr>
<h3 id="_9、-2-6-100-升级到-3-0-100-后无法连接-sqlserver-提示证书无效-提示证书链是由不受信任的颁发机构颁发的" tabindex="-1"> 9、 2.6.100 升级到 3.0.100 后无法连接 sqlserver 提示证书无效, 提示证书链是由不受信任的颁发机构颁发的.</h3>
<p>请尝试:</p>
<p>1.连接字符串里加入 &quot;Encrypt=True; TrustServerCertificate=True;&quot;</p>
<p>2.使用 FreeSql.Provider.SqlServerForSystem 替换 FreeSql.Provider.SqlServer</p>
<p>深入讨论请转到 <a href="https://github.com/dotnetcore/FreeSql/issues/992#issuecomment-1005305027" target="_blank" rel="noopener noreferrer">https://github.com/dotnetcore/FreeSql/issues/992#issuecomment-1005305027</a></p>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">与 Dapper 比较</title>
    <id>https://freesql.net/reference/vs-dapper.html</id>
    <link href="https://freesql.net/reference/vs-dapper.html"/>
    <updated>2022-08-04T03:23:43.000Z</updated>
    <content type="html"><![CDATA[<h1 id="与-dapper-比较" tabindex="-1"> 与 Dapper 比较</h1>
<p>众所周知 Dapper 是 .NET 下最轻最快的 ORM，它是喜欢写 SQL 码农的福音，相对于 SqlHelper 它更加方便，据统计 10 个 .NETer 有 9 个 用过 Dapper。</p>
<p>这篇文章为准备使用 FreeSql 的朋友解惑，对比 Dapper 有何优势，为什么要使用 FreeSql？希望本文内容对大家有所帮助。</p>
<h2 id="关于性能-输了" tabindex="-1"> 关于性能（输了）</h2>
<p>Dapper + SQL 是大家一般所用的方式，性能对比主要体现在两个阶段：</p>
<p>1、执行前，表达式树解析，拼接 SQL 的消耗：</p>
<ul>
<li>Dapper 几乎没有消耗；</li>
<li>FreeSql 会存在递归解析、对象拆箱等操作；</li>
</ul>
<p>从项目工程可维护性角度看，这一点性能损失是能被容忍的，请看下面的测试结果。</p>
<p>2、执行后，返回数据转换为 List：</p>
<ul>
<li>Dapper 采用 Emit 构造委托并缓存，性能接近原生代码；</li>
<li>FreeSql 采用 ExpressionTree 构造委托并缓存，为了映射类型更加易用使用了一点装箱操作，性能比 Dapper 略低；</li>
</ul>
<div><pre><code><span>BenchmarkDotNet</span><span>=</span>v0.12.1, <span>OS</span><span>=</span>Windows <span>10.0</span>.19044
Intel Core i7-8700K CPU <span>3</span>.70GHz <span>(</span>Coffee Lake<span>)</span>, <span>1</span> CPU, <span>12</span> logical and <span>6</span> physical cores
.NET Core <span>SDK</span><span>=</span><span>6.0</span>.100
  <span>[</span>Host<span>]</span>     <span>:</span> .NET Core <span>5.0</span>.11 <span>(</span>CoreCLR <span>5.0</span>.1121.47308, CoreFX <span>5.0</span>.1121.47308<span>)</span>, X64 RyuJIT DEBUG
  Job-LEQVAV <span>:</span> .NET Core <span>5.0</span>.11 <span>(</span>CoreCLR <span>5.0</span>.1121.47308, CoreFX <span>5.0</span>.1121.47308<span>)</span>, X64 RyuJIT DEBUG

<span>BuildConfiguration</span><span>=</span>Debug  <span>InvocationCount</span><span>=</span><span>1</span>  <span>UnrollFactor</span><span>=</span><span>1</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><table>
<thead>
<tr>
<th>Method</th>
<th>size</th>
<th style="text-align:right">Mean</th>
<th style="text-align:right">Error</th>
<th style="text-align:right">StdDev</th>
<th style="text-align:right">Median</th>
<th style="text-align:right">Rank</th>
</tr>
</thead>
<tbody>
<tr>
<td>FreeSqlSelect</td>
<td>1</td>
<td style="text-align:right">271.6 us</td>
<td style="text-align:right">14.03 us</td>
<td style="text-align:right">41.16 us</td>
<td style="text-align:right">272.6 us</td>
<td style="text-align:right">2</td>
</tr>
<tr>
<td>SqlSugarSelect</td>
<td>1</td>
<td style="text-align:right">323.5 us</td>
<td style="text-align:right">15.75 us</td>
<td style="text-align:right">45.18 us</td>
<td style="text-align:right">314.9 us</td>
<td style="text-align:right">3</td>
</tr>
<tr>
<td>EfCoreSelect</td>
<td>1</td>
<td style="text-align:right">392.8 us</td>
<td style="text-align:right">17.61 us</td>
<td style="text-align:right">49.39 us</td>
<td style="text-align:right">376.2 us</td>
<td style="text-align:right">4</td>
</tr>
<tr>
<td>DapperSelete</td>
<td>1</td>
<td style="text-align:right">215.9 us</td>
<td style="text-align:right">11.88 us</td>
<td style="text-align:right">33.52 us</td>
<td style="text-align:right">213.8 us</td>
<td style="text-align:right">1</td>
</tr>
<tr>
<td>FreeSqlSelect</td>
<td>500</td>
<td style="text-align:right">811.8 us</td>
<td style="text-align:right">18.86 us</td>
<td style="text-align:right">55.02 us</td>
<td style="text-align:right">798.5 us</td>
<td style="text-align:right">5</td>
</tr>
<tr>
<td>SqlSugarSelect</td>
<td>500</td>
<td style="text-align:right">1,148.6 us</td>
<td style="text-align:right">53.94 us</td>
<td style="text-align:right">157.34 us</td>
<td style="text-align:right">1,116.3 us</td>
<td style="text-align:right">7</td>
</tr>
<tr>
<td>EfCoreSelect</td>
<td>500</td>
<td style="text-align:right">1,310.2 us</td>
<td style="text-align:right">89.90 us</td>
<td style="text-align:right">262.25 us</td>
<td style="text-align:right">1,219.3 us</td>
<td style="text-align:right">8</td>
</tr>
<tr>
<td>DapperSelete</td>
<td>500</td>
<td style="text-align:right">942.1 us</td>
<td style="text-align:right">18.46 us</td>
<td style="text-align:right">42.05 us</td>
<td style="text-align:right">931.1 us</td>
<td style="text-align:right">6</td>
</tr>
</tbody>
</table>
<blockquote>
<p>如上测试 Top1、Top500 单表查询水平结果</p>
</blockquote>
<blockquote>
<p>测试注意 IFreeSql 是单例模式设计，请勿重复创建，测试前请预热</p>
</blockquote>
<p>测试结果是 us 级别的慢，能接受，因为数据库的上限并发瓶颈比较低（几万的水平），应用程序中的这一点消耗远不是问题。</p>
<p>最怕方法或设计错了导致的慢，那慢就是秒级以上的慢了，无力回天。</p>
<h2 id="关于功能-赢了" tabindex="-1"> 关于功能（赢了）</h2>
<p>Dapper 几乎只有执行 SQL 的功能，市面上有一些基于 Dapper 做的轻量级 ORM，可以对实体对象进行 CRUD 操作，支持的数据库有限。</p>
<p>Dapper 在功能方面几乎完败于 FreeSql，例如：</p>
<ul>
<li>CodeFirst：Dapper 不支持；</li>
<li>类型映射：Dapper 在不同数据库之间的类型映射容易报错。比如实体类属性是 string，但是数据库类型是 int，非常容易报错，这不是杠，真实项目中有很多非等映射类型存在；</li>
<li>表达式树：Dapper 不支持导航属性、自定义解析、以及特别的解析；</li>
<li>导航属性：Dapper 不支持；</li>
<li>批量插入：Dapper 需要自己写 SQL 或者引入第三方包，FreeSql 自带集成；</li>
<li>批量更新：Dapper 需要自己写 SQL，FreeSql 自带集成；</li>
<li>工作单元：Dapper 需要引入第三方包，FreeSql 自带集成；</li>
<li>读写分离：？？</li>
<li>全局过滤：？？</li>
</ul>
<p>等等。。。</p>
<p>FreeSql 赢在功能丰富，给使用者提供最大便利，你准备好入坑了吗？</p>
<h2 id="如何接入-老项目" tabindex="-1"> 如何接入（老项目）</h2>
<p>如果你的项目正在使用 Dapper，请看以下成本最低的接入方法。</p>
<p>FreeSql 支持调用 SQL/存储过程，同时也为 IDbConnection/IDbTransaction 提供扩展方法 Select/Delete/Insert/Update/InsertOrUpdate。</p>
<p>第一步：以数据库 SqlServer 访问为例，只需要安装已经划分好的小包：</p>
<div><pre><code>dotnet <span>add</span> package FreeSql.Provider.SqlServer
</code></pre><div aria-hidden="true"><div></div></div></div><p>or</p>
<div><pre><code>Install-Package FreeSql.Provider.SqlServer
</code></pre><div aria-hidden="true"><div></div></div></div><p>第二步：建立实体类</p>
<div><pre><code><span>class</span> <span>TestConnectionExt</span> <span>{</span>
    <span>public</span> <span>Guid</span> id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span><span>string</span></span> title <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>
    <span>public</span> <span>DateTime</span> createTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span> <span>=</span> DateTime<span>.</span>Now<span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>第三步：开始 CRUD</p>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span>connectString<span>)</span><span>)</span> <span>{</span>
    <span><span>var</span></span> list <span>=</span> conn<span>.</span><span><span>Select</span><span><span>&lt;</span>TestConnectionExt<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>id <span>==</span> item<span>.</span>id<span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>
<span>}</span>

<span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span>connectString<span>)</span><span>)</span> <span>{</span>
    <span><span>var</span></span> item <span>=</span> <span>new</span> <span>TestConnectionExt</span> <span>{</span> title <span>=</span> <span>"testinsert"</span> <span>}</span><span>;</span>
    <span><span>var</span></span> affrows <span>=</span> conn<span>.</span><span>Insert</span><span>(</span>item<span>)</span><span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span>

<span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span>connectString<span>)</span><span>)</span> <span>{</span>
    <span><span>var</span></span> affrows <span>=</span> conn<span>.</span><span><span>Update</span><span><span>&lt;</span>TestConnectionExt<span>></span></span></span><span>(</span><span>)</span>
        <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> xxx<span>)</span>
        <span>.</span><span>Set</span><span>(</span>a <span>=></span> a<span>.</span>title<span>,</span> <span>"testupdated"</span><span>)</span>
        <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span>

<span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span>connectString<span>)</span><span>)</span> <span>{</span>
    <span><span>var</span></span> affrows <span>=</span> conn<span>.</span><span><span>Delete</span><span><span>&lt;</span>TestConnectionExt<span>></span></span></span><span>(</span><span>)</span>
        <span>.</span><span>Where</span><span>(</span>a <span>=></span> a<span>.</span>Id <span>==</span> xxx<span>)</span>
        <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><p>添加或更新：</p>
<div><pre><code><span>using</span> <span>(</span><span><span>var</span></span> conn <span>=</span> <span>new</span> <span>SqlConnection</span><span>(</span>connectString<span>)</span><span>)</span> <span>{</span>
    <span><span>var</span></span> affrows <span>=</span> conn<span>.</span><span><span>InsertOrUpdate</span><span><span>&lt;</span>TestConnectionExt<span>></span></span></span><span>(</span><span>)</span>
        <span>.</span><span>SetSource</span><span>(</span>item<span>)</span>
        <span>.</span><span>ExecuteAffrows</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre><div aria-hidden="true"><div></div><div></div><div></div><div></div><div></div></div></div><p>如上添加、删除、修改、查询，已经支持实体类操作，并且支持批量插入、批量更新、批量删除、多表查询、导航属性查询。</p>
<p>可以享用 FreeSql 几乎所有功能。</p>
<p>思考：使用这种 API 貌似可以很轻松的接入到 abp vnext 中？</p>
<h2 id="学习指南" tabindex="-1"> 学习指南</h2>
<p>FreeSql 是一款功能强大的对象关系映射（O/RM）组件，支持 .NET Core 2.1+、.NET Framework 4.0+ 以及 Xamarin。</p>
<ul>
<li>🛠 支持 CodeFirst 模式，即便使用 Access 数据库也支持数据迁移；</li>
<li>💻 支持 DbFirst 模式，支持从数据库导入实体类，或使用实体类生成工具生成实体类；</li>
<li>⛳ 支持 深入的类型映射，比如 PgSql 的数组类型等；</li>
<li>✒ 支持 丰富的表达式函数，以及灵活的自定义解析；</li>
<li>🏁 支持 导航属性一对多、多对多贪婪加载，以及延时加载；</li>
<li>📃 支持 读写分离、分表分库、过滤器、乐观锁、悲观锁；</li>
<li>🌳 支持 MySql/SqlServer/PostgreSQL/Oracle/Sqlite/Firebird/达梦/人大金仓/神舟通用/南大通用/翰高/Access 等数据库；</li>
</ul>
<h4 id="基础" tabindex="-1"> 基础</h4>
<ul>
<li><a href="/guide/insert.html">《学习 FreeSql 之一：添加数据》</a></li>
<li><a href="/guide/delete.html">《学习 FreeSql 之二：删除数据》</a></li>
<li><a href="/guide/update.html">《学习 FreeSql 之三：修改数据》</a></li>
<li><a href="/guide/select.html">《学习 FreeSql 之四：查询数据》</a></li>
<li><a href="/guide/repository.html">《仓储层 Repository》</a></li>
</ul>
<h4 id="进阶" tabindex="-1"> 进阶</h4>
<ul>
<li><a href="/guide/code-first.html">《CodeFirst 模式开发介绍》</a>
<ul>
<li><a href="/guide/entity-attribute.html">《CodeFirst 模式之一：实体特性》</a></li>
<li><a href="/guide/fluent-api.html">《CodeFirst 模式之二：FluentApi》</a></li>
<li><a href="/guide/custom-attribute.html">《CodeFirst 模式之三：自定义特性》</a></li>
<li><a href="/guide/type-mapping.html">《CodeFirst 模式之四：类型映射》</a></li>
<li><a href="/guide/code-first.html#%E8%BF%81%E7%A7%BB%E7%BB%93%E6%9E%84">《CodeFirst 模式之五：迁移结构》</a></li>
</ul>
</li>
</ul>
<ul>
<li><a href="/guide/db-first.html">《DbFirst 模式开发介绍》</a></li>
</ul>
<h4 id="高级" tabindex="-1"> 高级</h4>
<ul>
<li><a href="/guide/transaction.html">《数据库事务》</a></li>
<li><a href="/guide/read-write-splitting.html">《使用读写分离》</a></li>
<li><a href="/guide/sharding.html">《分表分库》</a></li>
<li><a href="/guide/multi-tenancy.html">《多租户》</a></li>
<li><a href="/guide/select-return-data.html">《返回数据》</a></li>
<li><a href="/guide/select-lazy-loading.html">《优化之：延时加载》</a></li>
<li><a href="/guide/select-include.html">《优化之：贪婪加载》</a></li>
<li><a href="/guide/expression-function.html">《Expression 表达式函数》</a></li>
<li><a href="/guide/aop.html">《AOP》</a></li>
</ul>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
  <entry>
    <title type="html">与 EntityFramework 比较</title>
    <id>https://freesql.net/reference/vs-entity-framework.html</id>
    <link href="https://freesql.net/reference/vs-entity-framework.html"/>
    <updated>2022-05-16T12:50:28.000Z</updated>
    <content type="html"><![CDATA[<h1 id="与-entityframework-比较" tabindex="-1"> 与 EntityFramework 比较</h1>
<p>为什么要写这篇文章？</p>
<p>希望针对 SEO 优化搜索引擎，让更多中国人知道并且使用。目前百度搜索 .NET ORM 全是 sqlsugar，我个人是无语的，每每一个人进群第一件事就是拿来比较，每天要重复回答、重复解答、说服他们。想说服标签是名气大、使用者多的同类型 .NET ORM 非常困难，最多只能让他们勉强接受。</p>
<p>FreeSql 不愿做自己发光的金子，希望在 2020 年 写下这篇完整一点的 .NET ORM 比较，为准备使用 FreeSql 的朋友解惑，能排上百度搜索引擎当然再好不过了。</p>
<p>肯请动一动手指多多转发转发文章，并加上原文链接，谢谢！MarkDown：<a href="https://files.cnblogs.com/files/kellynic/ORM_VS.zip" target="_blank" rel="noopener noreferrer">https://files.cnblogs.com/files/kellynic/ORM_VS.zip</a></p>
<h2 id="基础信息比较" tabindex="-1"> 基础信息比较</h2>
<table>
<thead>
<tr>
<th>功能项</th>
<th>FreeSql</th>
<th>EFCore</th>
<th>SqlSugar</th>
</tr>
</thead>
<tbody>
<tr>
<td>出生时间</td>
<td>2018 年 12 月</td>
<td>2015 年(约)</td>
<td>2014 年(约)</td>
</tr>
<tr>
<td>开源协议</td>
<td>MIT</td>
<td>Apache-2.0</td>
<td>Apache-2.0</td>
</tr>
<tr>
<td>所属机构</td>
<td><a href="https://github.com/dotnetcore" target="_blank" rel="noopener noreferrer">dotnetcore(NCC)</a></td>
<td>dotnet</td>
<td>sunkaixuan(个人)</td>
</tr>
<tr>
<td>单元测试数量</td>
<td>5500+</td>
<td>很多</td>
<td>无</td>
</tr>
<tr>
<td>github star</td>
<td>2.1k+</td>
<td>9.5k+</td>
<td>3.1k+</td>
</tr>
<tr>
<td>github issues</td>
<td>活跃</td>
<td>活跃</td>
<td>不活跃</td>
</tr>
<tr>
<td>支持平台</td>
<td>.NET4.0+、.NETCore</td>
<td>.NETCore</td>
<td>.NET4.5+、.NETCore</td>
</tr>
<tr>
<td>支持数据库</td>
<td>很多，并且行为一致</td>
<td>很多</td>
<td>SqlServer/MySql/Sqlite/Oracle</td>
</tr>
<tr>
<td>生命周期</td>
<td>Singleton</td>
<td>Scoped</td>
<td>Scoped</td>
</tr>
<tr>
<td>使用方式</td>
<td>IFreeSql、Repository</td>
<td>DbContext</td>
<td>SugarClient</td>
</tr>
</tbody>
</table>
<p>FreeSql .NET ORM 支持 MySql/SqlServer/PostgreSQL/Oracle/Sqlite/Firebird/达梦/人大金仓/神舟通用/Access。</p>
<p>.NET ORM 各有自已看家本领，本文主要按 FreeSql 提供的功能进行列举比较，如有冒犯请见谅，也欢迎向 FreeSql 提出功能建议。</p>
<p>每个功能实现的深度层次不一样（比如 EFCore 支持 SqlServer 2012，FreeSql 支持 SqlServer 2005），很难彻底比较，提示：</p>
<ul>
<li>本文比较的功能 FreeSql 每种数据库基本都有提供，不像 EFCore 偏向 SqlServer</li>
<li>本文只比较官方提供的功能（不包含第三方扩展）</li>
</ul>
<p><img src="https://img2020.cnblogs.com/blog/31407/202009/31407-20200914063104631-2088330287.png" alt="" loading="lazy"></p>
<p><img src="https://img2020.cnblogs.com/blog/31407/202009/31407-20200914063148941-1489586974.png" alt="" loading="lazy"></p>
<p><img src="https://img2020.cnblogs.com/blog/31407/202009/31407-20200914063955435-856878176.png" alt="" loading="lazy"></p>
<h2 id="net-orm-整体功能比较" tabindex="-1"> .NET ORM 整体功能比较</h2>
<table>
<thead>
<tr>
<th>功能项</th>
<th>FreeSql</th>
<th>EFCore</th>
<th>SqlSugar</th>
</tr>
</thead>
<tbody>
<tr>
<td>.NET ORM CodeFirst 根据实体类型，创建表结构</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM CodeFirst 根据实体类型，对比表结构</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM CodeFirst 根据实体类型注释，迁移表结构备注</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM CodeFirst FluentApi</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM CodeFirst FluentApi 语法兼容 EFCore</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM CodeFirst 实体特性兼容 EFCore</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM CodeFirst 自定义实体特性(Aop)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM CodeFirst 类型转换映射(MapType)</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM DbFirst 根据数据库，生成实体类</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 导航属性(OneToOne)</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 导航属性(ManyToOne)</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 导航属性(OneToMany)</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 导航属性(ManyToMany)</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 导航属性(Parent) <a href="/reference/select-as-tree.html">父子关系的实体类</a></td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 导航属性延时加载、贪婪加载、级联保存</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 自定义表达式树解析</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 全局过滤器</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 事务</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 读写分离</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 分表分库</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 仓储 Repository</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 工作单元 UnitOfWork</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 工作单元管理器 UnitOfWorkManager</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM DbContext 状态管理</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="net-orm-crud-功能比较" tabindex="-1"> .NET ORM CRUD 功能比较</h2>
<table>
<thead>
<tr>
<th>功能项</th>
<th>FreeSql</th>
<th>EFCore</th>
<th>SqlSugar</th>
</tr>
</thead>
<tbody>
<tr>
<td>.NET ORM CRUD 时，映射动态表名</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM CRUD 时，使用参数化 SQL 执行</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM CRUD 时，不使用参数化 SQL 执行(NoneParameter)</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM CRUD 时，获取对应的 SQL(ToSql)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM CRUD 时，统一审计实体属性值(Aop.AuditValue)</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>.NET ORM 插入(单条)</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 插入时，忽略/指定列</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 插入时，返回影响的行数</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 插入时，返回插入后的自增值</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 插入时，返回插入后的记录</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 插入时，Insert Ignore Into</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 插入时，On Duplicate Key Update</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 插入时，On Conflict Do Update</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 批量插入 <a href="https://www.cnblogs.com/kellynic/p/10557882.html" target="_blank" rel="noopener noreferrer">性能测试结果参考文档</a></td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 批量插入时，自动分批 <a href="/reference/insert.html">参考文档</a></td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 批量插入时，使用 BulkCopy</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>.NET ORM 更新(单条)</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，动态条件(WhereDynamic)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，根据实体对象更新</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，根据状态管理只更新有变化的属性</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 更新时，忽略/指定列</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，原子性 set num=num+1</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，指定条件</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，自动附加全局过滤器条件</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 更新时，不需要先查询</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，使用乐观行锁</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 更新时，使用悲观锁</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 更新时，返回影响的行数</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 更新时，返回更新后的记录</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 批量更新</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>.NET ORM 删除(单条)</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 删除时，动态条件(WhereDynamic)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 删除时，指定条件</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 删除时，自动附加全局过滤器条件</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 删除时，不需要先查询</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 删除时，返回影响的行数</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 删除时，返回插入后的记录</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 级联保存</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 添加或更新</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 添加或更新，自动适配 merge into <a href="/reference/insert-or-update.html">参考文档</a></td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 批量编辑保存 <a href="/reference/insert-or-update.html">参考文档</a></td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>.NET ORM 查询(单条)</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，分页</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，分页支持 SqlServer2008</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，动态条件(WhereDynamic)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，动态过滤条件(WhereDynamicFilter) <a href="/reference/select.html">参考文档</a></td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，自动附加全局过滤器条件</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 查询时，多表条件传播(WhereCascade)</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 查询时，在 lambda 中使用导航属性</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 查询时，用 Dto 映射只需要查询的字段</td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 查询时，传 Sql 作二次查询(WithSql)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，子查询(Exists)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，子查询(In)</td>
<td>✔</td>
<td>-</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，子查询拼接结果(string.Join) <a href="/reference/select-multi-table.html">参考文档</a></td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 查询时，使用分组聚合(GroupBy/Having)</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>.NET ORM 查询时，使用 Linq To Sql 语法</td>
<td>✔</td>
<td>✔</td>
<td>-</td>
</tr>
<tr>
<td>.NET ORM 查询时，针对树形结构表 <a href="/reference/select-as-tree.html">父子关系的实体类</a></td>
<td>✔</td>
<td>-</td>
<td>-</td>
</tr>
</tbody>
</table>
]]></content>
    <published>2021-02-04T16:03:18.000Z</published>
  </entry>
</feed>